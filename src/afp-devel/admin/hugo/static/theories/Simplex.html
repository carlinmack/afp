<div id="Simplex_Auxiliary">
<div class="head">
<h1>Theory Simplex_Auxiliary</h1>
</div>
<pre class="source"><span class="comment1">(* Authors: F. Maric, M. Spasic *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Results›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Simplex_Auxiliary
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <span class="quoted">"<a href="../../HOL/HOL-Library/Permutation.html">HOL-Library.Permutation</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Mapping.html">HOL-Library.Mapping</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="comment1">(* MoreList *)</span>
<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="keyword1"><span class="command">lemma</span></span> map_reindex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">l</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="main">=</span> map <span class="free">g</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_parametrize_idx<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> last_tl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>tl <span class="free">l</span><span class="main">)</span> <span class="main">=</span> last <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> hd_tl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>tl <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> butlast_empty_conv_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>butlast <span class="free">l</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>length <span class="free">l</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> butlast_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"butlast <span class="free">l</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> last_take_conv_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>take <span class="free">n</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_conv_nth min_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tl_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">l</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> interval_3split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> upt_add_eq_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">list_min</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> foldl min <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> list_min_Min<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> list_min <span class="free">l</span> <span class="main">=</span> Min <span class="main">(</span>set <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">l'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="comment1">(* Minimal element of a list satisfying the given property *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">min_satisfying</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">min_satisfying</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span>
    <span class="keyword1">let</span> <span class="bound">xs</span> <span class="main">=</span> filter <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>list_min <span class="bound">xs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> min_satisfying_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"min_satisfying <span class="free">P</span> <span class="free">l</span> <span class="main">=</span> None <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">l</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> min_satisfying_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_empty_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> min_satisfying_Some<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"min_satisfying <span class="free">P</span> <span class="free">l</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟶</span> 
      <span class="free">x</span> <span class="main">∈</span> set <span class="free">l</span> <span class="main">∧</span> <span class="free">P</span> <span class="free">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x'</span> <span class="main">∈</span> set <span class="free">l</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="free">l</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"min_satisfying <span class="free">P</span> <span class="free">l</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?xs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> Min <span class="main">(</span>set <span class="var">?xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> min_satisfying_def Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_empty_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Min_in<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="var">?xs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∉</span> set <span class="var">?xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">≥</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> Min <span class="main">(</span>set <span class="var">?xs</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x'</span> <span class="main">&lt;</span> <span class="free">x</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x'</span> <span class="main">∈</span> set <span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">x'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="comment1">(* MoreNat *)</span>
<span class="comment1">(* -------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="command">lemma</span></span> min_element<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="main">(</span><span class="bound">m</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">mm</span><span class="main">.</span> <span class="free">P</span> <span class="bound">mm</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">m'</span><span class="main">.</span> <span class="bound">m'</span> <span class="main">&lt;</span> <span class="bound">mm</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">m'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m'</span></span><span class="main">&lt;</span><span class="skolem">m</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">m'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">m</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">m'a</span></span><span class="main">&lt;</span><span class="skolem">m'</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">m'a</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="comment1">(* MoreFun *)</span>
<span class="comment1">(* -------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_fun_args<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> finite <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">B</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="bound">f</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">f0</span> <span class="bound">a</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?F</span> <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f0</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?F</span> <span class="skolem">A'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> <span class="main">{</span><span class="bound">f'</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">a</span> <span class="main">=</span> <span class="bound">a'</span> <span class="keyword1">then</span> <span class="bound">f'</span> <span class="skolem">a</span> <span class="main">∈</span> <span class="free">B</span> <span class="skolem">a</span> <span class="keyword1">else</span> <span class="bound">f'</span> <span class="bound">a'</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">a'</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">f</span> <span class="main">∈</span> <span class="var">?F</span> <span class="skolem">A'</span><span class="main">.</span> finite <span class="main">(</span><span class="var">?f</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?F</span> <span class="skolem">A'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">b</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">:=</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">B</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?f</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>insert <span class="skolem">a</span> <span class="skolem">A'</span><span class="main">.</span> finite <span class="main">(</span><span class="free">B</span> <span class="bound">a</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="main">(</span><span class="var">?F</span> <span class="skolem">A'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="var">?F</span> <span class="skolem">A'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A'</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="main">(</span><span class="var">?F</span> <span class="skolem">A'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A'</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="main">(</span><span class="var">?F</span> <span class="skolem">A'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?F</span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?f</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">:=</span> <span class="free">f0</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">:=</span> <span class="free">f0</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?F</span> <span class="skolem">A'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> <span class="skolem">A'</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="main">(</span><span class="var">?F</span> <span class="skolem">A'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="main">(</span><span class="var">?F</span> <span class="skolem">A'</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?F</span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="main">(</span><span class="var">?F</span> <span class="skolem">A'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f0</span> <span class="main">∈</span> <span class="var">?F</span> <span class="skolem">A'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?f</span> <span class="skolem">f0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?F</span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> <span class="skolem">A'</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="comment1">(* MoreMapping *)</span>
<span class="comment1">(* -------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="command">lemma</span></span> foldl_mapping_update<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> set <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="free">f</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">m</span> <span class="bound">a</span><span class="main">.</span> Mapping.update <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">m</span><span class="main">)</span> <span class="free">i</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">g</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">h</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">h</span> <span class="main">=</span> <span class="free">f</span> <span class="free">X</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_update<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_update' False<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> snoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> False snoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Rel_Chain">
<div class="head">
<h1>Theory Rel_Chain</h1>
</div>
<pre class="source"><span class="comment1">(* Authors: F. Maric, M. Spasic *)</span>
<span class="keyword1"><span class="command">theory</span></span> Rel_Chain
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Simplex_Auxiliary.html">Simplex_Auxiliary</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">rel_chain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">rel_chain</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">!</span> <span class="bound">k</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">!</span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 
  rel_chain_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_chain <span class="main">[]</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  rel_chain_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_chain <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> True <span class="keyword1">else</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> hd <span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> rel_chain <span class="free">xs</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_chain_def hd_conv_nth nth_Cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm nat.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_chain_drop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_chain <span class="free">l</span> <span class="free">R</span> <span class="main">==&gt;</span> rel_chain <span class="main">(</span>drop <span class="free">n</span> <span class="free">l</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_chain_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_chain_take<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_chain <span class="free">l</span> <span class="free">R</span> <span class="main">==&gt;</span> rel_chain <span class="main">(</span>take <span class="free">n</span> <span class="free">l</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_chain_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_chain_butlast<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_chain <span class="free">l</span> <span class="free">R</span> <span class="main">==&gt;</span> rel_chain <span class="main">(</span>butlast <span class="free">l</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_chain_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> butlast_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_chain_tl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_chain <span class="free">l</span> <span class="free">R</span> <span class="main">==&gt;</span> rel_chain <span class="main">(</span>tl <span class="free">l</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_chain_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tl_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_chain_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_chain <span class="free">l</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"rel_chain <span class="free">l'</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>last <span class="free">l</span><span class="main">,</span> hd <span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_chain <span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="free">l'</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_chain_Cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_chain_appendD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_chain <span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="free">l'</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_chain <span class="free">l</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"rel_chain <span class="free">l'</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">l'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span>last <span class="free">l</span><span class="main">,</span> hd <span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_chain_Cons rel_chain_Nil <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rtrancl_rel_chain<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="bound">l</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> last <span class="bound">l</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> rel_chain <span class="bound">l</span> <span class="free">R</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtrancl_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_chain_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">l</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">l</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"rel_chain <span class="skolem">l</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_chain_Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trancl_rel_chain<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> length <span class="bound">l</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> hd <span class="bound">l</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> last <span class="bound">l</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> rel_chain <span class="bound">l</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">z</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> tranclD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">∧</span> last <span class="skolem">l</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> rel_chain <span class="skolem">l</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rtrancl_rel_chain<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_chain_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">l</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">l</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"rel_chain <span class="skolem">l</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">l'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> hd <span class="skolem">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"rel_chain <span class="skolem">l'</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_chain_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> hd <span class="skolem">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>hd <span class="skolem">l'</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹last <span class="skolem">l</span> <span class="main">=</span> <span class="free">y</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rtrancl_rel_chain<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_chain_elems_rtrancl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_chain <span class="free">l</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">,</span> <span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="free">i</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="var">?l</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="var">?l</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">=</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_conv_nth min_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_chain <span class="var">?l</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rel_chain <span class="free">l</span> <span class="free">R</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_chain_drop rel_chain_take<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> rtrancl_rel_chain<span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reorder_cyclic_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"hd <span class="free">l</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="free">l</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> 
    <span class="quoted"><span class="quoted">"rel_chain <span class="free">l</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">l'</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="free">l'</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="free">sl</span>"</span></span> <span class="quoted"><span class="quoted">"rel_chain <span class="free">l'</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l'</span> <span class="main">=</span> length <span class="free">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l'</span> <span class="main">⟶</span> 
     <span class="main">(</span><span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">∧</span> <span class="free">l'</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">l</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"length <span class="main">(</span>tl <span class="free">l</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">l</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_0_conv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="free">sl</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> 
                 tl <span class="free">l</span>
             <span class="keyword1">else</span>
                 drop <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span> <span class="main">@</span> tl <span class="main">(</span>take <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="var">?l'</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>tl <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹tl <span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth tl_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">sl</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">sl</span><span class="main">)</span> <span class="free">l</span> <span class="main">@</span> tl <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">sl</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="free">sl</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_append hd_drop_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="var">?l'</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="free">sl</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>tl <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="quoted"><span class="quoted">‹last <span class="free">l</span> <span class="main">=</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹hd <span class="free">l</span> <span class="main">=</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">l</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth last_tl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">sl</span><span class="main">)</span> <span class="free">l</span> <span class="main">@</span> tl <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">sl</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="free">sl</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="quoted"><span class="quoted">‹tl <span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_append drop_Suc tl_take last_take_conv_nth tl_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_chain <span class="var">?l'</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_chain <span class="main">(</span>tl <span class="free">l</span><span class="main">)</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rel_chain <span class="free">l</span> <span class="free">r</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_chain_tl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"rel_chain <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">sl</span><span class="main">)</span> <span class="free">l</span> <span class="main">@</span> tl <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">sl</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rel_chain_append<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_chain <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">sl</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="free">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rel_chain <span class="free">l</span> <span class="free">r</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_chain_drop<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_chain <span class="main">(</span>tl <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">sl</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rel_chain <span class="free">l</span> <span class="free">r</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_chain_tl rel_chain_take<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>drop <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹last <span class="free">l</span> <span class="main">=</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹hd <span class="free">l</span> <span class="main">=</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> tl <span class="main">(</span>take <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="quoted"><span class="quoted">‹tl <span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_Suc<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> hd <span class="main">(</span>tl <span class="main">(</span>take <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth take_Suc tl_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>last <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">sl</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">,</span> hd <span class="main">(</span>tl <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">sl</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rel_chain <span class="free">l</span> <span class="free">r</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">l</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sl</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> rel_chain_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?l'</span> <span class="main">=</span> length <span class="free">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">ultimately</span></span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">=</span> <span class="var">?l'</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">l'</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">l'</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="free">sl</span>"</span></span> <span class="quoted"><span class="quoted">"rel_chain <span class="skolem">l'</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l'</span> <span class="main">=</span> length <span class="free">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> l'_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l'</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="skolem">l'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">∧</span> <span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l'</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">∧</span> <span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l'</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">=</span> <span class="var">?l'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tl_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l'</span> <span class="main">=</span> length <span class="free">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">=</span> <span class="var">?l'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l'</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="main">(</span>drop <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sl</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">=</span> <span class="var">?l'</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&gt;</span> length <span class="main">(</span>drop <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&gt;</span> length <span class="free">l</span> <span class="main">-</span> <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> Suc <span class="free">sl</span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> Suc <span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">-</span> <span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> Suc <span class="free">sl</span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&gt;</span> length <span class="free">l</span> <span class="main">-</span> <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sl</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">=</span> <span class="var">?l'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> tl_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">-</span> <span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> Suc <span class="free">sl</span><span class="main">)</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> tl_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">-</span> <span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> Suc <span class="free">sl</span><span class="main">)</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> Suc <span class="free">sl</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">+</span> <span class="free">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">l</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
            <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">-</span> <span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> Suc <span class="free">sl</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="free">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="free">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&gt;</span> length <span class="free">l</span> <span class="main">-</span> <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="free">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> Suc <span class="free">sl</span><span class="main">)</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> Suc <span class="free">sl</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">+</span> <span class="free">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">l</span> <span class="main">+</span> <span class="main">1</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="free">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> Suc <span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">-</span> <span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> Suc <span class="free">sl</span><span class="main">)</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹Suc <span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">-</span> <span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> Suc <span class="free">sl</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="free">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">+</span> <span class="free">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> length <span class="free">l</span> <span class="main">-</span> <span class="free">sl</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="main">(</span>drop <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="free">sl</span> <span class="main">+</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> Suc <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> last <span class="free">l</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> last_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main">,</span> <span class="operator">THEN</span> sym<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> length <span class="free">l</span> <span class="main">-</span> <span class="free">sl</span> <span class="main">-</span> <span class="main">1</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">=</span> <span class="var">?l'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sl</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> tl_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="free">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hd <span class="free">l</span> <span class="main">=</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹last <span class="free">l</span> <span class="main">=</span> <span class="free">s</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append hd_conv_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">using</span></span> * l'_l
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Simplex_Algebra">
<div class="head">
<h1>Theory Simplex_Algebra</h1>
</div>
<pre class="source"><span class="comment1">(* Authors: F. Maric, M. Spasic *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Linearly Ordered Rational Vectors›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Simplex_Algebra
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="../../HOL/HOL/Rat.html">HOL.Rat</a> 
    <a href="../../HOL/HOL/Real_Vector_Spaces.html">HOL.Real_Vector_Spaces</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">class</span></span> scaleRat <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">scaleRat</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">*R</span></span></span>"</span> 75<span class="main">)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">divideRat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> rat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">'/R</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">/R</span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">==</span> scaleRat <span class="main">(</span>inverse <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">class</span></span> rational_vector <span class="main">=</span> scaleRat <span class="main">+</span> ab_group_add <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> scaleRat_right_distrib<span class="main">:</span> <span class="quoted"><span class="quoted">"scaleRat <span class="free">a</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> scaleRat <span class="free">a</span> <span class="free">x</span> <span class="main">+</span> scaleRat <span class="free">a</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> scaleRat_left_distrib<span class="main">:</span> <span class="quoted"><span class="quoted">"scaleRat <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> scaleRat <span class="free">a</span> <span class="free">x</span> <span class="main">+</span> scaleRat <span class="free">b</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> scaleRat_scaleRat<span class="main">:</span> <span class="quoted"><span class="quoted">"scaleRat <span class="free">a</span> <span class="main">(</span>scaleRat <span class="free">b</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> scaleRat <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> scaleRat_one<span class="main">:</span> <span class="quoted"><span class="quoted">"scaleRat <span class="main">1</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span> 

<span class="keyword1"><span class="command">interpretation</span></span> rational_vector<span class="main">:</span>
  vector_space <span class="quoted"><span class="quoted">"scaleRat <span class="main">::</span> rat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>rational_vector"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scaleRat_right_distrib  scaleRat_left_distrib scaleRat_scaleRat scaleRat_one<span class="main">)</span>

<span class="keyword1"><span class="command">class</span></span> ordered_rational_vector <span class="main">=</span> rational_vector <span class="main">+</span> order

<span class="keyword1"><span class="command">class</span></span> linordered_rational_vector <span class="main">=</span> ordered_rational_vector <span class="main">+</span> linorder <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> plus_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">+</span> <span class="free">c</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">+</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    scaleRat_less1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">;</span> <span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">*R</span> <span class="free">a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">*R</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    scaleRat_less2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">;</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">*R</span> <span class="free">a</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">*R</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> scaleRat_leq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span><span class="main">;</span> <span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">k</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">k</span> <span class="keyword1">*R</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> le_less
  <span class="keyword1"><span class="command">using</span></span> scaleRat_less1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> scaleRat_leq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span><span class="main">;</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">k</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">≥</span> <span class="free">k</span> <span class="keyword1">*R</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> le_less
  <span class="keyword1"><span class="command">using</span></span> scaleRat_less2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_scaleRat
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="main">=</span> <span class="free">zero</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> scaleRat_left_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> scaleRat_zero
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> scaleRat_right_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> scaleRat_uminus <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="keyword1">*R</span> <span class="free">x</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span>  <span class="main">=</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">*R</span> <span class="free">x</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> scaleRat_left_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scaleRat_one<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">-</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">x</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">*R</span> <span class="free">x</span> <span class="main">+</span> <span class="free">x</span> <span class="main">-</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span>  <span class="main">=</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">*R</span> <span class="free">x</span> <span class="main">+</span> <span class="free">x</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> minus_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> plus_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">b</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> plus_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> minus_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟷</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">-</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> plus_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">a</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> plus_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">-</span><span class="free">a</span>"</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> minus_leq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">≤</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> minus_gt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> scaleRat_less2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">-</span><span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less_iff_gr_or_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> plus_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_assoc <span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">≤</span> <span class="main">0</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>antisym_conv1<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> * **
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> minus_geq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟷</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">-</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">-</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> minus_gt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less_iff_gr_or_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">-</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">-</span> <span class="free">a</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">-</span> <span class="free">a</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> plus_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">-</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">-</span> <span class="free">a</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> eq_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">-</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> * **
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> divide_lt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">;</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span>rat<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">c</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> scaleRat_less1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="free">c</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scaleRat_one scaleRat_scaleRat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> divide_gt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">b</span><span class="main">;</span><span class="main">(</span><span class="free">c</span><span class="main">::</span>rat<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">c</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> scaleRat_less1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="free">c</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scaleRat_one scaleRat_scaleRat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> divide_leq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">≤</span>  <span class="free">b</span><span class="main">;</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span>rat<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">c</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> divide_lt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">≤</span>  <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scaleRat_one scaleRat_scaleRat<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> divide_geq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">≥</span> <span class="free">b</span><span class="main">;</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span>rat<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≥</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">c</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">&gt;</span> <span class="free">b</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> divide_gt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">≥</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">≥</span> <span class="free">b</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scaleRat_one scaleRat_scaleRat<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> divide_lt1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">;</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span>rat<span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">c</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> scaleRat_less2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="free">c</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scaleRat_scaleRat scaleRat_one<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> divide_gt1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">b</span><span class="main">;</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span>rat<span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟧</span> <span class="main">⟹</span>  <span class="free">a</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">c</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> scaleRat_less2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="free">c</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scaleRat_scaleRat scaleRat_one<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> divide_leq1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">≤</span>  <span class="free">b</span><span class="main">;</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span>rat<span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≥</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">c</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> divide_lt1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">≤</span>  <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scaleRat_one scaleRat_scaleRat<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> divide_geq1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">≥</span> <span class="free">b</span><span class="main">;</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span>rat<span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">c</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">&gt;</span> <span class="free">b</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> divide_gt1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">≥</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">≥</span> <span class="free">b</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scaleRat_one scaleRat_scaleRat<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">class</span></span> lrv <span class="main">=</span> linordered_rational_vector <span class="main">+</span> one <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> zero_neq_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> linordered_rational_vector<span class="main">)</span> ordered_ab_semigroup_add
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">+</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">c</span> <span class="main">+</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> plus_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_ac le_less<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> rat <span class="main">::</span> <span class="quoted">rational_vector</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">scaleRat_rat</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> rat <span class="main">⇒</span> rat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> rat <span class="main">::</span> <span class="quoted">ordered_rational_vector</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> rat <span class="main">::</span> <span class="quoted">linordered_rational_vector</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> rat <span class="main">::</span> <span class="quoted">lrv</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> uminus_less_lrv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> lrv"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="main">-</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="keyword1">*R</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">*R</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">b</span> <span class="main">&lt;</span> <span class="free">a</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> scaleRat_less2<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span><span class="main">]</span> scaleRat_less2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="keyword1">*R</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="keyword1">*R</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Abstract_Linear_Poly">
<div class="head">
<h1>Theory Abstract_Linear_Poly</h1>
</div>
<pre class="source"><span class="comment1">(* Authors: F. Maric, M. Spasic, R. Thiemann *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Linear Polynomials and Constraints›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Abstract_Linear_Poly  
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Simplex_Algebra.html">Simplex_Algebra</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> var <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹(Infinite) linear polynomials as functions from vars to coeffs›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_zero</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>zero"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fun_zero</span> <span class="main">==</span> <span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_plus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>plus"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fun_plus</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">==</span> <span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="bound">v</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_scale</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span>var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>ring<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fun_scale</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">==</span> <span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">*</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_coeff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> var <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fun_coeff</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">var</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">var</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>zero<span class="main">)</span> <span class="main">⇒</span> var set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fun_vars</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_vars_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>zero<span class="main">)</span> <span class="main">⇒</span> var list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fun_vars_list</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> sorted_list_of_set <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> <span class="main">(</span>var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>zero<span class="main">,</span>one<span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fun_var</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> valuation <span class="main">=</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_valuate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var <span class="main">⇒</span> rat<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> valuation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>rational_vector<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fun_valuate</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Invariant -- only finitely many variables›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">==</span> finite <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_fun_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"inv fun_zero"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_fun_plus <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>inv <span class="main">(</span><span class="free">f1</span> <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span><span class="main">;</span> inv <span class="free">f2</span><span class="main">⟧</span> <span class="main">⟹</span> inv <span class="main">(</span>fun_plus <span class="free">f1</span> <span class="free">f2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">+</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">f1</span>"</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">f2</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_fun_scale <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"inv <span class="main">(</span><span class="free">f</span> <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>ring<span class="main">)</span> <span class="main">⟹</span> inv <span class="main">(</span>fun_scale <span class="free">r</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="bound">v</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹linear-poly type -- rat coeffs›</span></span>
  <span class="comment1">(* TODO: change rat to arbitrary ring *)</span>

<span class="keyword1"><span class="command">typedef</span></span>  linear_poly <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">c</span> <span class="main">::</span> var <span class="main">⇒</span> rat<span class="main">.</span> inv <span class="bound">c</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Linear polynomials are of the form $a_1 \cdot x_1 + ... + a_n
\cdot x_n$. Their formalization follows the data-refinement approach
of Isabelle/HOL \cite{florian-refinement}. Abstract representation of
polynomials are functions mapping variables to their coefficients,
where only finitely many variables have non-zero
coefficients. Operations on polynomials are defined as operations on
functions. For example, the sum of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> is
defined by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="bound"><span class="bound">v</span></span> <span class="main"><span class="main">+</span></span> <span class="free"><span class="free">p<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="bound"><span class="bound">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and the value of a polynomial
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for a valuation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (denoted by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p⦃v⦄›</span></span></span></span>),
is defined by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∑</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">∈</span></span><span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">p</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">≠</span></span> <span class="main"><span class="main">0</span></span><span class="main"><span class="main">}</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">p</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">*</span></span> <span class="free"><span class="free">v</span></span> <span class="bound"><span class="bound">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Executable
representation of polynomials uses RBT mappings instead of functions.
›</span></span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_linear_poly 

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Vector space operations on polynomials›</span></span>
<span class="keyword1"><span class="command">instantiation</span></span> linear_poly <span class="main">::</span> <span class="quoted">rational_vector</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">zero_linear_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"linear_poly"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">fun_zero</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_fun_zero<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">plus_linear_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"linear_poly <span class="main">⇒</span> linear_poly <span class="main">⇒</span> linear_poly"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">fun_plus</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_fun_plus<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">scaleRat_linear_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> linear_poly <span class="main">⇒</span> linear_poly"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">fun_scale</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_fun_scale<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">uminus_linear_poly</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"linear_poly <span class="main">⇒</span> linear_poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">uminus_linear_poly</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">minus_linear_poly</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"linear_poly <span class="main">⇒</span> linear_poly <span class="main">⇒</span> linear_poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minus_linear_poly</span> <span class="free"><span class="bound"><span class="entity">lp1</span></span></span> <span class="free"><span class="bound"><span class="entity">lp2</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">lp1</span></span></span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="free"><span class="bound"><span class="entity">lp2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">linear_poly</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">a</span> <span class="main">+</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> uminus_linear_poly_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">-</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> minus_linear_poly_def <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">rat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">linear_poly</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">*R</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">a</span> <span class="keyword1">*R</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">::</span><span class="quoted">rat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">linear_poly</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">*R</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">b</span> <span class="keyword1">*R</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">*R</span> <span class="skolem">b</span> <span class="keyword1">*R</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">linear_poly</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="keyword1">*R</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Coefficient›</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> coeff <span class="main">::</span> <span class="quoted"><span class="quoted">"linear_poly <span class="main">⇒</span> var <span class="main">⇒</span> rat"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">fun_coeff</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_plus <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="free">lp1</span> <span class="main">+</span> <span class="free">lp2</span><span class="main">)</span> <span class="free">var</span> <span class="main">=</span> coeff <span class="free">lp1</span> <span class="free">var</span> <span class="main">+</span> coeff <span class="free">lp2</span> <span class="free">var</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_scaleRat <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="free">k</span> <span class="keyword1">*R</span> <span class="free">lp1</span><span class="main">)</span> <span class="free">var</span> <span class="main">=</span> <span class="free">k</span> <span class="main">*</span> coeff <span class="free">lp1</span> <span class="free">var</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_uminus <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="main">-</span><span class="free">lp</span><span class="main">)</span> <span class="free">var</span> <span class="main">=</span> <span class="main">-</span> coeff <span class="free">lp</span> <span class="free">var</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> uminus_linear_poly_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_minus <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="free">lp1</span> <span class="main">-</span> <span class="free">lp2</span><span class="main">)</span> <span class="free">var</span> <span class="main">=</span> coeff <span class="free">lp1</span> <span class="free">var</span> <span class="main">-</span> coeff <span class="free">lp2</span> <span class="free">var</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> minus_linear_poly_def uminus_linear_poly_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Set of variables›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> vars <span class="main">::</span> <span class="quoted"><span class="quoted">"linear_poly <span class="main">⇒</span> var set"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">fun_vars</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> vars <span class="free">p</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> finite_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>vars <span class="free">p</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹List of variables›</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> vars_list <span class="main">::</span> <span class="quoted"><span class="quoted">"linear_poly <span class="main">⇒</span> var list"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">fun_vars_list</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_vars_list<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>vars_list <span class="free">lp</span><span class="main">)</span> <span class="main">=</span> vars <span class="free">lp</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Construct single variable polynomial›</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> Var <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> linear_poly"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">fun_var</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Value of a polynomial in a given valuation›</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> valuate <span class="main">::</span> <span class="quoted"><span class="quoted">"linear_poly <span class="main">⇒</span> <span class="tfree">'a</span> valuation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>rational_vector<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">fun_valuate</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_valuate"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"linear_poly <span class="main">⇒</span> <span class="tfree">'a</span> valuation <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>    <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⦃</span> _ <span class="keyword1">⦄</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="free">p</span><span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span> "</span> <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> valuate <span class="free">p</span> <span class="free">v</span>"</span>

<span class="keyword1"><span class="command">lemma</span></span> valuate_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> 
  valuate_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">⦃</span><span class="free">v1</span><span class="main">⦄</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">p</span> <span class="main">⦃</span><span class="free">v2</span><span class="main">⦄</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">⦃</span> <span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">v1</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">v2</span> <span class="bound">x</span> <span class="main">⦄</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_subtractf<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rational_vector.scale_right_diff_distrib<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> valuate_opposite_val<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⦃</span> <span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">-</span> <span class="free">v</span> <span class="bound">x</span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="free">p</span> <span class="main">⦃</span> <span class="free">v</span> <span class="main">⦄</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valuate_diff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valuate_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valuate_nonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linordered_rational_vector valuation"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> vars <span class="free">p</span><span class="main">.</span> <span class="main">(</span>coeff <span class="free">p</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">v</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>coeff <span class="free">p</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">v</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⦃</span> <span class="free">v</span> <span class="main">⦄</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> fun_valuate_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">p</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="skolem">v</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum.insert<span class="main">[</span><span class="operator">OF</span> insert<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ add_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ insert<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="skolem">v</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> scaleRat_leq1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> scaleRat_leq2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span>"</span></span><span class="main">]</span> 1<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valuate_nonpos<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linordered_rational_vector valuation"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> vars <span class="free">p</span><span class="main">.</span> <span class="main">(</span>coeff <span class="free">p</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">v</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>coeff <span class="free">p</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">v</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⦃</span> <span class="free">v</span> <span class="main">⦄</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">using</span></span> valuate_opposite_val<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> valuate_nonneg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">-</span> <span class="free">v</span> <span class="bound">x</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> scaleRat_leq2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">::</span><span class="tfree">'a</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> scaleRat_leq2<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">::</span><span class="tfree">'a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> valuate_uminus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="free">p</span><span class="main">)</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="free">p</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> uminus_linear_poly_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_negf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valuate_add_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>rational_vector"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">+</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">f1</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">f2</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span>  <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="free">f2</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">+</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">+</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="free">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">+</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">f1</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">f2</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">+</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">+</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="free">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">f1</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">f2</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_left<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">f1</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">f2</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> 
                   <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="free">f2</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scaleRat_left_distrib sum.distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span>  <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="free">f2</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f1</span> <span class="skolem">f2</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> rat"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">f1</span> <span class="bound">v</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">f1</span> <span class="bound">v</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">f1</span> <span class="bound">v</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_left<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">using</span></span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f1</span></span> <span class="quoted"><span class="free">f2</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f2</span></span> <span class="quoted"><span class="free">f1</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">f2</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valuate_add<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p1</span> <span class="main">+</span> <span class="free">p2</span><span class="main">)</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">(</span><span class="free">p1</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">p2</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valuate_add_lemma<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valuate_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p1</span> <span class="main">-</span> <span class="free">p2</span><span class="main">)</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">(</span><span class="free">p1</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">p2</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> minus_linear_poly_def valuate_add 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valuate_uminus<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> valuate_scaleRat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="keyword1">*R</span> <span class="free">lp</span><span class="main">)</span> <span class="main">⦃</span> <span class="free">v</span> <span class="main">⦄</span> <span class="main">=</span> <span class="free">c</span> <span class="keyword1">*R</span> <span class="main">(</span> <span class="free">lp</span><span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span> <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valuate_def zero_linear_poly_def Abs_linear_poly_inverse<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v</span><span class="main">.</span> Rep_linear_poly <span class="main">(</span><span class="free">c</span> <span class="keyword1">*R</span> <span class="free">lp</span><span class="main">)</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> <span class="main">(</span>Rep_linear_poly <span class="free">lp</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> scaleRat_linear_poly_def
    <span class="keyword1"><span class="command">using</span></span> Abs_linear_poly_inverse<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> Rep_linear_poly <span class="free">lp</span> <span class="bound">v</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> Rep_linear_poly
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> valuate_def
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">subst</span> rational_vector.scale_sum_right<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valuate_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span> <span class="main">=</span> <span class="free">v</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> valuate_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⦃</span> <span class="free">v</span> <span class="main">⦄</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⦃</span> <span class="free">v</span> <span class="main">⦄</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valuate_zero valuate_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_vars_list<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vars_list <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">use</span> distinct_sorted_list_of_set <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> zero_coeff_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> coeff <span class="free">p</span> <span class="bound">v</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> all_val<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">v</span><span class="main">::</span>var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> vars <span class="free">p</span><span class="main">.</span> <span class="bound">v'</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">⦃</span><span class="bound">v'</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> zero_coeff_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars <span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> coeff_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> zero_neq_one
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">x'</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">::</span><span class="tfree">'a</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> vars <span class="free">p</span><span class="main">.</span> <span class="skolem">v'</span> <span class="bound">x</span> <span class="main">=</span> <span class="var">?v</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⦃</span><span class="skolem">v'</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?v</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x'</span> <span class="main">∈</span> vars <span class="free">p</span><span class="main">.</span> <span class="skolem">v'</span> <span class="bound">x'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">x'</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⦃</span><span class="skolem">v'</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Rep_linear_poly <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="var">?fp</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">v'</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> vars <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vars_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="skolem">x'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"Rep_linear_poly <span class="free">p</span> <span class="skolem">x'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x'</span> <span class="main">∈</span> vars <span class="free">p</span><span class="main">.</span> <span class="skolem">v'</span> <span class="bound">x'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">x'</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> vars_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"Rep_linear_poly <span class="free">p</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x'</span> <span class="main">∈</span> vars <span class="free">p</span><span class="main">.</span> <span class="skolem">v'</span> <span class="bound">x'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">x'</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≠</span> <span class="main">1</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> vars_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⦃</span><span class="skolem">v'</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="var">?fp</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="var">?fp</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="skolem">v'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> valuate_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="var">?fp</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">v'</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="var">?fp</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="skolem">v'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_left<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Rep_linear_poly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?fp</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="skolem">v'</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="var">?fp</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">v'</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?fp</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> vars <span class="free">p</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x'</span> <span class="main">∈</span> vars <span class="free">p</span><span class="main">.</span> <span class="skolem">v'</span> <span class="bound">x'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">x'</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⦃</span><span class="skolem">v'</span><span class="main">⦄</span> <span class="main">=</span> <span class="var">?fp</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">⦃</span><span class="skolem">v'</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> coeff_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> rational_vector.scale_eq_0_iff
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≠</span> <span class="main">1</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> lp_monom <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> var <span class="main">⇒</span> linear_poly"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">then</span> <span class="bound">c</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> valuate_lp_monom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>lp_monom <span class="free">c</span> <span class="free">x</span><span class="main">)</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> <span class="main">(</span><span class="free">v</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">c</span> <span class="skolem">x</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valuate_lp_monom_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>lp_monom <span class="main">1</span> <span class="free">x</span><span class="main">)</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span> 

<span class="keyword1"><span class="command">lemma</span></span> coeff_lp_monom <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>lp_monom <span class="free">c</span> <span class="free">v</span><span class="main">)</span> <span class="free">v'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v'</span> <span class="keyword1">then</span> <span class="free">c</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_uminus <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vars <span class="main">(</span><span class="main">-</span><span class="free">p</span><span class="main">)</span> <span class="main">=</span> vars <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> uminus_linear_poly_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_plus <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vars <span class="main">(</span><span class="free">p1</span> <span class="main">+</span> <span class="free">p2</span><span class="main">)</span> <span class="main">⊆</span> vars <span class="free">p1</span> <span class="main">∪</span> vars <span class="free">p2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_minus <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vars <span class="main">(</span><span class="free">p1</span> <span class="main">-</span> <span class="free">p2</span><span class="main">)</span> <span class="main">⊆</span> vars <span class="free">p1</span> <span class="main">∪</span> vars <span class="free">p2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> minus_linear_poly_def
  <span class="keyword1"><span class="command">using</span></span> vars_plus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">p2</span>"</span></span><span class="main">]</span> vars_uminus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_lp_monom<span class="main">:</span> <span class="quoted"><span class="quoted">"vars <span class="main">(</span>lp_monom <span class="free">r</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_scaleRat1<span class="main">:</span> <span class="quoted"><span class="quoted">"vars <span class="main">(</span><span class="free">c</span> <span class="keyword1">*R</span> <span class="free">p</span><span class="main">)</span> <span class="main">⊆</span> vars <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_scaleRat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> vars<span class="main">(</span><span class="free">c</span> <span class="keyword1">*R</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> vars <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_Var <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vars <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_Var1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_Var2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> coeff <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> valuate_depend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> vars <span class="free">p</span><span class="main">.</span> <span class="free">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">v'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">⦃</span><span class="free">v'</span><span class="main">⦄</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> valuate_update_x_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v1</span> <span class="free">v2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>rational_vector valuation"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟶</span> <span class="free">v1</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">v2</span> <span class="bound">y</span>"</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v1</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="free">f</span> <span class="free">x</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="free">v2</span> <span class="free">x</span> <span class="main">-</span> <span class="free">v1</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v2</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">v1</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">v2</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?Ax</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?Ax</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="var">?A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v1</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="keyword1">*R</span> <span class="free">v1</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="var">?Ax</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v1</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="var">?A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v2</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="keyword1">*R</span> <span class="free">v2</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="var">?Ax</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v2</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> <span class="var">?Ax</span><span class="main">.</span> <span class="free">v1</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">v2</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="keyword1">*R</span> <span class="free">v1</span> <span class="free">x</span> <span class="main">+</span> <span class="free">f</span> <span class="free">x</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="free">v2</span> <span class="free">x</span> <span class="main">-</span> <span class="free">v1</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="keyword1">*R</span> <span class="free">v2</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> rational_vector.scale_right_diff_distrib<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valuate_update_x<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v1</span> <span class="free">v2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>rational_vector valuation"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> vars <span class="free">lp</span><span class="main">.</span> <span class="bound">y</span><span class="main">≠</span><span class="free">x</span> <span class="main">⟶</span> <span class="free">v1</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">v2</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">lp</span> <span class="main">⦃</span><span class="free">v1</span><span class="main">⦄</span>  <span class="main">+</span> coeff <span class="free">lp</span> <span class="free">x</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="free">v2</span> <span class="free">x</span> <span class="main">-</span> <span class="free">v1</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">lp</span> <span class="main">⦃</span><span class="free">v2</span><span class="main">⦄</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">unfolding</span></span> valuate_def vars_def coeff_def
  <span class="keyword1"><span class="command">using</span></span> valuate_update_x_lemma<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Rep_linear_poly <span class="free">lp</span>"</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">v2</span></span><span class="main">]</span> Rep_linear_poly
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"vars <span class="main">0</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zero_coeff_zero coeff_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_empty_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"vars <span class="free">lp</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">lp</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zero_coeff_zero coeff_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_var</span><span class="main">::</span> <span class="quoted"><span class="quoted">"linear_poly <span class="main">⇒</span> var"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_var</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Max <span class="main">(</span>vars <span class="free"><span class="bound"><span class="entity">lp</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> max_var_max<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> vars <span class="free">lp</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"max_var <span class="free">lp</span> <span class="main">≥</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_vars max_var_def vars_zero<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> max_var_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"max_var <span class="free">lp</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">vl</span> <span class="main">=</span> vars_list <span class="free">lp</span> 
                <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">vl</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> foldl max <span class="main">(</span>hd <span class="bound">vl</span><span class="main">)</span> <span class="main">(</span>tl <span class="bound">vl</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">lp</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>linear_poly<span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> set_vars_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">lp</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_var_def vars_zero<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> set_vars_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">lp</span></span><span class="main">,</span> <span class="operator">THEN</span> sym<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> vars_empty_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">lp</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> max_var_def Let_def 
    <span class="keyword1"><span class="command">using</span></span> Max.set_eq_fold<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>vars_list <span class="free">lp</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>vars_list <span class="free">lp</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"vars_list <span class="free">lp</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> foldl_conv_fold <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fold_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">monom_var</span><span class="main">::</span> <span class="quoted"><span class="quoted">"linear_poly <span class="main">⇒</span> var"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">monom_var</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> max_var <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">monom_coeff</span><span class="main">::</span> <span class="quoted"><span class="quoted">"linear_poly <span class="main">⇒</span> rat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">monom_coeff</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>monom_var <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_monom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"linear_poly <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_monom</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">⟷</span> length <span class="main">(</span>vars_list <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_monom_vars_not_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_monom <span class="free">l</span> <span class="main">⟹</span> vars <span class="free">l</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_monom_def vars_list_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vars_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> monom_var_in_vars<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_monom <span class="free">l</span> <span class="main">⟹</span> monom_var <span class="free">l</span> <span class="main">∈</span> vars <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vars_zero
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monom_var_def max_var_def is_monom_vars_not_empty finite_vars is_monom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_is_no_monom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_monom <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_monom_vars_not_empty vars_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> is_monom_monom_coeff_not_zero<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_monom <span class="free">l</span> <span class="main">⟹</span> monom_coeff <span class="free">l</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_zero monom_var_in_vars monom_coeff_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_two_elements<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">y</span> <span class="main">∈</span> set <span class="free">l</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">l</span><span class="main">;</span> length <span class="free">l</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">;</span> <span class="free">y</span> <span class="main">≠</span> <span class="free">x</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_monom_vars_monom_var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_monom <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vars <span class="free">l</span> <span class="main">=</span> <span class="main">{</span>monom_var <span class="free">l</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span>is_monom <span class="free">l</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> vars <span class="free">l</span><span class="main">⟧</span> <span class="main">⟹</span> monom_var <span class="free">l</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_monom <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>vars_list <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_vars
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vars_list_def vars_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"monom_var <span class="free">l</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"monom_var <span class="free">l</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> monom_var <span class="free">l</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"monom_var <span class="free">l</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rep_linear_poly <span class="free">l</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> monom_var_in_vars <span class="quoted"><span class="quoted">‹is_monom <span class="free">l</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vars_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>vars_list <span class="free">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_vars
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vars_def vars_list_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>vars_list <span class="free">l</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹is_monom <span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_two_elements
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_monom_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vars <span class="free">l</span> <span class="main">=</span> <span class="main">{</span>monom_var <span class="free">l</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monom_var_in_vars<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> monom_valuate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_monom <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">(</span>monom_coeff <span class="free">m</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="main">(</span>monom_var <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">using</span></span> is_monom_vars_monom_var
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vars_def coeff_def monom_coeff_def valuate_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_zero_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"coeff <span class="main">0</span> <span class="free">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zero_coeff_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> poly_eq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">q</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> coeff <span class="free">p</span> <span class="bound">v</span> <span class="main">=</span> coeff <span class="free">q</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> poly_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> coeff <span class="free">p</span> <span class="bound">v</span> <span class="main">=</span> coeff <span class="free">q</span> <span class="bound">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms poly_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_sum_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">*R</span> lp_monom <span class="main">1</span> <span class="bound">x</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">v</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="free">v</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> linear_poly_sum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⦃</span> <span class="free">v</span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>vars <span class="free">p</span><span class="main">.</span> coeff <span class="free">p</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> all_valuate_zero<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>lrv valuation<span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="main">⦃</span><span class="bound">v</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> all_val assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> linear_poly_eqI<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>lrv valuation<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">p</span> <span class="main">⦃</span><span class="bound">v</span><span class="main">⦄</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span> <span class="main">⦃</span><span class="bound">v</span><span class="main">⦄</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="free">q</span><span class="main">)</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>lrv valuation"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> valuate_minus<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> <span class="free">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> all_valuate_zero<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> monom_poly_assemble<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_monom <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"monom_coeff <span class="free">p</span> <span class="keyword1">*R</span> lp_monom <span class="main">1</span> <span class="main">(</span>monom_var <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms linear_poly_eqI monom_valuate valuate_scaleRat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>sum <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> linear_poly<span class="main">)</span> <span class="free">is</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> coeff <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="free">is</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Linear_Poly_Maps">
<div class="head">
<h1>Theory Linear_Poly_Maps</h1>
</div>
<pre class="source"><span class="comment1">(* Authors: F. Maric, M. Spasic, R. Thiemann *)</span>
<span class="keyword1"><span class="command">theory</span></span> Linear_Poly_Maps
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Abstract_Linear_Poly.html">Abstract_Linear_Poly</a>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Finite_Map.html">HOL-Library.Finite_Map</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* ************************************************************************** *)</span>
<span class="comment1">(* Executable implementation                                                  *)</span>
<span class="comment1">(* ************************************************************************** *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_var_coeff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> fmap <span class="main">⇒</span> var <span class="main">⇒</span> rat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_var_coeff</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">==</span> <span class="keyword1">case</span> fmlookup <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Some <span class="bound">c</span> <span class="main">⇒</span> <span class="bound">c</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">set_var_coeff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> rat <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> fmap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_var_coeff</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="main">==</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> fmdrop <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="keyword1">else</span> fmupd <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> LinearPoly <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> fmap <span class="main">⇒</span> linear_poly"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">get_var_coeff</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">fmap</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inv <span class="main">(</span>get_var_coeff <span class="skolem">fmap</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inv_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ dom_fmlookup_finite<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">fmap</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdom'I <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> get_var_coeff_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ordered_keys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span>fmap <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ordered_keys</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>fset <span class="main">(</span>fmdom <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> fmap.lifting lifting_syntax
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">===&gt;</span> pcr_linear_poly <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(=)</span> pcr_linear_poly"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pcr_linear_poly_def cr_linear_poly_def rel_fun_def OO_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pcr_fmap <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">===&gt;</span> pcr_linear_poly<span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">f</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">)</span> LinearPoly"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>get_var_coeff_def fmap.pcr_cr_eq cr_fmap_def<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> linear_poly_map <span class="main">::</span> <span class="quoted"><span class="quoted">"linear_poly <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> fmap"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">lp</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">lp</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span><span class="bound">lp</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> certificate<span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstype</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"LinearPoly <span class="main">(</span>linear_poly_map <span class="free">lp</span><span class="main">)</span> <span class="main">=</span> <span class="free">lp</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Zero›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">zero</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span>fmap"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">zero</span> <span class="main">=</span> fmempty"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"linear_poly_map <span class="main">0</span> <span class="main">=</span> zero"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> zero_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Addition›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_monom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> var <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> fmap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_monom</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="main">==</span> set_var_coeff <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">+</span> get_var_coeff <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> fmap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add</span> <span class="free"><span class="bound"><span class="entity">lp1</span></span></span> <span class="free"><span class="bound"><span class="entity">lp2</span></span></span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span> <span class="bound">lp</span> <span class="bound">v</span><span class="main">.</span> add_monom <span class="main">(</span>get_var_coeff <span class="free"><span class="bound"><span class="entity">lp1</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="bound">v</span> <span class="bound">lp</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lp2</span></span></span> <span class="main">(</span>ordered_keys <span class="free"><span class="bound"><span class="entity">lp1</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_add_monom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"get_var_coeff <span class="free">lp</span> <span class="free">v</span> <span class="main">+</span> <span class="free">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
    fmlookup <span class="main">(</span>add_monom <span class="free">c</span> <span class="free">v</span> <span class="free">lp</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> Some <span class="main">(</span>get_var_coeff <span class="free">lp</span> <span class="free">v</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"get_var_coeff <span class="free">lp</span> <span class="free">v</span> <span class="main">+</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>
    fmlookup <span class="main">(</span>add_monom <span class="free">c</span> <span class="free">v</span> <span class="free">lp</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">⟹</span> fmlookup <span class="main">(</span>add_monom <span class="free">c</span> <span class="free">v</span> <span class="free">lp</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> fmlookup <span class="free">lp</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_monom_def get_var_coeff_def set_var_coeff_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fmlookup_fold_not_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">k1</span> <span class="main">⟹</span>
  fmlookup <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">lp</span> <span class="bound">v</span><span class="main">.</span> add_monom <span class="main">(</span>get_var_coeff <span class="free">P1</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">v</span> <span class="bound">lp</span><span class="main">)</span> <span class="free">P2</span> <span class="free">k1</span><span class="main">)</span> <span class="free">x</span>
    <span class="main">=</span> fmlookup <span class="free">P2</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_add_monom<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"linear_poly_map <span class="main">(</span><span class="free">p1</span> <span class="main">+</span> <span class="free">p2</span><span class="main">)</span> <span class="main">=</span> add <span class="main">(</span>linear_poly_map <span class="free">p1</span><span class="main">)</span> <span class="main">(</span>linear_poly_map <span class="free">p2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fmap_ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="comment1">(* index *)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fmlookup <span class="main">(</span>linear_poly_map <span class="free">p1</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fmlookup <span class="main">(</span>linear_poly_map <span class="free">p2</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P1</span> <span class="main">=</span> linear_poly_map <span class="free">p1</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P2</span> <span class="main">=</span> linear_poly_map <span class="free">p2</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k1</span> <span class="main">=</span> ordered_keys <span class="skolem">P1</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> k1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">k1</span> <span class="main">∧</span> fset <span class="main">(</span>fmdom <span class="skolem">P1</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">k1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> k1_def P1_def ordered_keys_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"fmlookup <span class="main">(</span>linear_poly_map <span class="main">(</span><span class="free">p1</span> <span class="main">+</span> <span class="free">p2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="var">?p1</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="var">?p2</span> <span class="main">|</span> Some <span class="bound">y1</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="var">?p2</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Some <span class="bound">y1</span> <span class="main">|</span> Some <span class="bound">y2</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">y1</span> <span class="main">+</span> <span class="bound">y2</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span><span class="bound">y1</span> <span class="main">+</span> <span class="bound">y2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="main">(</span>linear_poly_map <span class="main">(</span><span class="free">p1</span> <span class="main">+</span> <span class="free">p2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> fmlookup <span class="main">(</span>add <span class="main">(</span>linear_poly_map <span class="free">p1</span><span class="main">)</span> <span class="main">(</span>linear_poly_map <span class="free">p2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fmlookup <span class="skolem">P1</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">from</span></span> fmdom_notI<span class="main">[</span><span class="operator">OF</span> None<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fset <span class="main">(</span>fmdom <span class="skolem">P1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> notin_fset<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> k1 <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="skolem">k1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id P1_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> P2_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> None
      <span class="keyword1"><span class="command">unfolding</span></span> add_def k1_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> fmlookup_fold_not_mem<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">y1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> fmdomI<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> fset <span class="main">(</span>fmdom <span class="skolem">P1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> notin_fset<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> k1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">k1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> split_list<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bef</span></span> <span class="skolem"><span class="skolem">aft</span></span> <span class="keyword2"><span class="keyword">where</span></span> k1_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k1</span> <span class="main">=</span> <span class="skolem">bef</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">aft</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> k1 <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="skolem">bef</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="skolem">aft</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> xy1<span class="main">:</span> <span class="quoted"><span class="quoted">"get_var_coeff <span class="skolem">P1</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">unfolding</span></span> get_var_coeff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"foldl <span class="main">(</span><span class="main">λ</span><span class="bound">lp</span> <span class="bound">v</span><span class="main">.</span> add_monom <span class="main">(</span>get_var_coeff <span class="skolem">P1</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">v</span> <span class="bound">lp</span><span class="main">)</span> <span class="skolem">P2</span> <span class="skolem">bef</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id P1_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> P2_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> Some option.simps
      <span class="keyword1"><span class="command">unfolding</span></span> add_def k1_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> k1_id foldl_append foldl_Cons
      <span class="keyword1"><span class="command">unfolding</span></span> fmlookup_fold_not_mem<span class="main">[</span><span class="operator">OF</span> x<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> xy1
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> fmlookup <span class="skolem">P2</span> <span class="skolem">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Some <span class="skolem">y1</span> <span class="main">|</span> Some <span class="bound">y2</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">y1</span> <span class="main">+</span> <span class="bound">y2</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span><span class="skolem">y1</span> <span class="main">+</span> <span class="bound">y2</span><span class="main">)</span><span class="main">)</span>
        <span class="main">=</span> fmlookup <span class="main">(</span>add_monom <span class="skolem">y1</span> <span class="skolem">x</span> <span class="var">?P</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"get_var_coeff <span class="var">?P</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y1</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">from</span></span> Some<span class="main">[</span><span class="operator">unfolded</span> P1_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> y1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lookup_add_monom<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> True
          <span class="keyword1"><span class="command">unfolding</span></span> get_var_coeff_def<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> fmlookup_fold_not_mem<span class="main">[</span><span class="operator">OF</span> x<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lookup_add_monom<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> False
          <span class="keyword1"><span class="command">unfolding</span></span> get_var_coeff_def<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> fmlookup_fold_not_mem<span class="main">[</span><span class="operator">OF</span> x<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Scaling›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">scale</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> fmap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">scale</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> fmempty <span class="keyword1">else</span> <span class="main">(</span>fmmap <span class="main">(</span><span class="main">(*)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"linear_poly_map <span class="main">(</span><span class="free">r</span> <span class="keyword1">*R</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> scale <span class="free">r</span> <span class="main">(</span>linear_poly_map <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> scale_def * if_True <span class="keyword1"><span class="command">using</span></span> True
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> scale_def * if_False <span class="keyword1"><span class="command">using</span></span> False
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(* Coeff *)</span>
<span class="keyword1"><span class="command">lemma</span></span> coeff_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"coeff <span class="free">lp</span> <span class="main">=</span> get_var_coeff <span class="main">(</span>linear_poly_map <span class="free">lp</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> get_var_coeff_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* Var *)</span>
<span class="keyword1"><span class="command">lemma</span></span> Var_code<span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"linear_poly_map <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">=</span> set_var_coeff <span class="free">x</span> <span class="main">1</span> fmempty"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_var_coeff_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff map_upd_def<span class="main">)</span>

<span class="comment1">(* vars *)</span>
<span class="keyword1"><span class="command">lemma</span></span> vars_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vars <span class="free">lp</span> <span class="main">=</span> fset <span class="main">(</span>fmdom <span class="main">(</span>linear_poly_map <span class="free">lp</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Transfer.Rel_def rel_fun_def pcr_fset_def cr_fset_def<span class="main">)</span>

<span class="comment1">(* vars_list *)</span>
<span class="keyword1"><span class="command">lemma</span></span> vars_list_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vars_list <span class="free">lp</span> <span class="main">=</span> ordered_keys <span class="main">(</span>linear_poly_map <span class="free">lp</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ordered_keys_def vars_code<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* valuate *)</span>
<span class="keyword1"><span class="command">lemma</span></span> valuate_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"valuate <span class="free">lp</span> <span class="free">val</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">let</span> <span class="bound">lpm</span> <span class="main">=</span> linear_poly_map <span class="free">lp</span>
  <span class="keyword1">in</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="bound">lpm</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="free">val</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>vars_list <span class="free">lp</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Let_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> sum_list_distinct_conv_sum_set<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vars_list <span class="free">lp</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">lp</span> <span class="main">⦃</span> <span class="free">val</span> <span class="main">⦄</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>vars_list <span class="free">lp</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span>fmlookup <span class="main">(</span>linear_poly_map <span class="free">lp</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="free">val</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_vars_list
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lp_monom_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"linear_poly_map <span class="main">(</span>lp_monom <span class="free">c</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> fmempty <span class="keyword1">else</span> fmupd <span class="free">x</span> <span class="free">c</span> fmempty<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fmap_ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">include</span></span> fmap.lifting
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> linear_poly <span class="main">::</span> <span class="quoted">equal</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">equal_linear_poly</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>linear_poly_map <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> linear_poly_map <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> equal_linear_poly_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"linear_poly_map <span class="skolem">x</span> <span class="main">=</span> linear_poly_map <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">LinearPoly</span><span class="main">,</span> <span class="operator">unfolded</span> certificate<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="QDelta">
<div class="head">
<h1>Theory QDelta</h1>
</div>
<pre class="source"><span class="comment1">(* Authors: F. Maric, M. Spasic, R. Thiemann *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Rational Numbers Extended with Infinitesimal Element›</span></span>
<span class="keyword1"><span class="command">theory</span></span> QDelta
  <span class="keyword2"><span class="keyword">imports</span></span>  
    <a href="Abstract_Linear_Poly.html">Abstract_Linear_Poly</a>
    <a href="Simplex_Algebra.html">Simplex_Algebra</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> QDelta <span class="main">=</span> QDelta <span class="quoted">rat</span> <span class="quoted">rat</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">qdfst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta <span class="main">⇒</span> rat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">qdfst</span> <span class="main">(</span>QDelta <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">qdsnd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta <span class="main">⇒</span> rat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">qdsnd</span> <span class="main">(</span>QDelta <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"QDelta <span class="main">(</span>qdfst <span class="free">qd</span><span class="main">)</span> <span class="main">(</span>qdsnd <span class="free">qd</span><span class="main">)</span> <span class="main">=</span> <span class="free">qd</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">qd</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>QDelta.qdsnd <span class="free">x</span> <span class="main">=</span> QDelta.qdsnd <span class="free">y</span><span class="main">;</span> QDelta.qdfst <span class="free">y</span> <span class="main">=</span> QDelta.qdfst <span class="free">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instantiation</span></span> QDelta <span class="main">::</span> <span class="quoted">rational_vector</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">zero_QDelta</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> QDelta <span class="main">0</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">plus_QDelta</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta <span class="main">⇒</span> QDelta <span class="main">⇒</span> QDelta"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">qd1</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">qd2</span></span></span> <span class="main">=</span> QDelta <span class="main">(</span>qdfst <span class="free"><span class="bound"><span class="entity">qd1</span></span></span> <span class="main">+</span> qdfst <span class="free"><span class="bound"><span class="entity">qd2</span></span></span><span class="main">)</span> <span class="main">(</span>qdsnd <span class="free"><span class="bound"><span class="entity">qd1</span></span></span> <span class="main">+</span> qdsnd <span class="free"><span class="bound"><span class="entity">qd2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">minus_QDelta</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta <span class="main">⇒</span> QDelta <span class="main">⇒</span> QDelta"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">qd1</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">qd2</span></span></span> <span class="main">=</span> QDelta <span class="main">(</span>qdfst <span class="free"><span class="bound"><span class="entity">qd1</span></span></span> <span class="main">-</span> qdfst <span class="free"><span class="bound"><span class="entity">qd2</span></span></span><span class="main">)</span> <span class="main">(</span>qdsnd <span class="free"><span class="bound"><span class="entity">qd1</span></span></span> <span class="main">-</span> qdsnd <span class="free"><span class="bound"><span class="entity">qd2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">uminus_QDelta</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta <span class="main">⇒</span> QDelta"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free"><span class="bound"><span class="entity">qd</span></span></span> <span class="main">=</span> QDelta <span class="main">(</span><span class="main">-</span> <span class="main">(</span>qdfst <span class="free"><span class="bound"><span class="entity">qd</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span>qdsnd <span class="free"><span class="bound"><span class="entity">qd</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">scaleRat_QDelta</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> QDelta <span class="main">⇒</span> QDelta"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">qd</span></span></span> <span class="main">=</span> QDelta <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">*</span><span class="main">(</span>qdfst <span class="free"><span class="bound"><span class="entity">qd</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">*</span><span class="main">(</span>qdsnd <span class="free"><span class="bound"><span class="entity">qd</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> 
<span class="keyword1"><span class="command">proof</span></span> 
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_QDelta_def zero_QDelta_def uminus_QDelta_def minus_QDelta_def scaleRat_QDelta_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> QDelta <span class="main">::</span> <span class="quoted">linorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_QDelta</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta <span class="main">⇒</span> QDelta <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">qd1</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">qd2</span></span></span> <span class="main">⟷</span> <span class="main">(</span>qdfst <span class="free"><span class="bound"><span class="entity">qd1</span></span></span> <span class="main">&lt;</span> qdfst <span class="free"><span class="bound"><span class="entity">qd2</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>qdfst <span class="free"><span class="bound"><span class="entity">qd1</span></span></span> <span class="main">=</span> qdfst <span class="free"><span class="bound"><span class="entity">qd2</span></span></span> <span class="main">∧</span> qdsnd <span class="free"><span class="bound"><span class="entity">qd1</span></span></span> <span class="main">≤</span> qdsnd <span class="free"><span class="bound"><span class="entity">qd2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_QDelta</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta <span class="main">⇒</span> QDelta <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">qd1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">qd2</span></span></span> <span class="main">⟷</span> <span class="main">(</span>qdfst <span class="free"><span class="bound"><span class="entity">qd1</span></span></span> <span class="main">&lt;</span> qdfst <span class="free"><span class="bound"><span class="entity">qd2</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>qdfst <span class="free"><span class="bound"><span class="entity">qd1</span></span></span> <span class="main">=</span> qdfst <span class="free"><span class="bound"><span class="entity">qd2</span></span></span> <span class="main">∧</span> qdsnd <span class="free"><span class="bound"><span class="entity">qd1</span></span></span> <span class="main">&lt;</span> qdsnd <span class="free"><span class="bound"><span class="entity">qd2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_QDelta_def less_eq_QDelta_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> QDelta<span class="main">::</span> <span class="quoted">linordered_rational_vector</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_QDelta_def less_QDelta_def scaleRat_QDelta_def mult_strict_left_mono mult_strict_left_mono_neg<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> QDelta <span class="main">::</span> <span class="quoted">lrv</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">one_QDelta</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">one_QDelta</span> <span class="main">=</span> QDelta <span class="main">1</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_QDelta_def zero_QDelta_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">δ0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta <span class="main">⇒</span> QDelta <span class="main">⇒</span> rat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">δ0</span> <span class="free"><span class="bound"><span class="entity">qd1</span></span></span> <span class="free"><span class="bound"><span class="entity">qd2</span></span></span> <span class="main">==</span>
    <span class="keyword1">let</span> <span class="bound">c1</span> <span class="main">=</span> qdfst <span class="free"><span class="bound"><span class="entity">qd1</span></span></span><span class="main">;</span> <span class="bound">c2</span> <span class="main">=</span> qdfst <span class="free"><span class="bound"><span class="entity">qd2</span></span></span><span class="main">;</span> <span class="bound">k1</span> <span class="main">=</span> qdsnd <span class="free"><span class="bound"><span class="entity">qd1</span></span></span><span class="main">;</span> <span class="bound">k2</span> <span class="main">=</span> qdsnd <span class="free"><span class="bound"><span class="entity">qd2</span></span></span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="bound">c1</span> <span class="main">&lt;</span> <span class="bound">c2</span> <span class="main">∧</span> <span class="bound">k1</span> <span class="main">&gt;</span> <span class="bound">k2</span><span class="main">)</span> <span class="keyword1">then</span> 
              <span class="main">(</span><span class="bound">c2</span> <span class="main">-</span> <span class="bound">c1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">k1</span> <span class="main">-</span> <span class="bound">k2</span><span class="main">)</span> 
       <span class="keyword1">else</span>
               <span class="main">1</span>
       <span class="main">)</span>
    "</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta <span class="main">⇒</span> rat <span class="main">⇒</span> rat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">val</span> <span class="free"><span class="bound"><span class="entity">qd</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">=</span> <span class="main">(</span>qdfst <span class="free"><span class="bound"><span class="entity">qd</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">*</span> <span class="main">(</span>qdsnd <span class="free"><span class="bound"><span class="entity">qd</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> val_plus<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="free">qd1</span> <span class="main">+</span> <span class="free">qd2</span><span class="main">)</span> <span class="free">δ</span> <span class="main">=</span> val <span class="free">qd1</span> <span class="free">δ</span> <span class="main">+</span> val <span class="free">qd2</span> <span class="free">δ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> val_def plus_QDelta_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> val_scaleRat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="free">c</span> <span class="keyword1">*R</span> <span class="free">qd</span><span class="main">)</span> <span class="free">δ</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> val <span class="free">qd</span> <span class="free">δ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> val_def scaleRat_QDelta_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> qdfst_setsum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> qdfst <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> qdfst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_QDelta_def plus_QDelta_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> qdsnd_setsum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> qdsnd <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> qdsnd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_QDelta_def plus_QDelta_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valuate_valuate_rat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">lp</span> <span class="main">⦃</span><span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span>QDelta <span class="main">(</span><span class="free">vl</span> <span class="bound">v</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span> <span class="main">=</span> QDelta <span class="main">(</span><span class="free">lp</span><span class="main">⦃</span><span class="free">vl</span><span class="main">⦄</span><span class="main">)</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Rep_linear_poly
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valuate_def scaleRat_QDelta_def qdsnd_setsum qdfst_setsum<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valuate_rat_valuate<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">lp</span><span class="main">⦃</span><span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> val <span class="main">(</span><span class="free">vl</span> <span class="bound">v</span><span class="main">)</span> <span class="free">δ</span><span class="main">)</span><span class="main">⦄</span> <span class="main">=</span> val <span class="main">(</span><span class="free">lp</span><span class="main">⦃</span><span class="free">vl</span><span class="main">⦄</span><span class="main">)</span> <span class="free">δ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> valuate_def val_def
  <span class="keyword1"><span class="command">using</span></span> rational_vector.scale_sum_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Rep_linear_poly <span class="free">lp</span> <span class="bound">x</span> <span class="main">*</span> qdsnd <span class="main">(</span><span class="free">vl</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span> <span class="main">::</span> nat<span class="main">.</span> Rep_linear_poly <span class="free">lp</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> rat<span class="main">)</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> Rep_linear_poly
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> sum.distrib qdfst_setsum qdsnd_setsum<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scaleRat_QDelta_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> delta0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">qd1</span> <span class="main">≤</span> <span class="free">qd2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">ε</span><span class="main">.</span> <span class="bound">ε</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">ε</span> <span class="main">≤</span> <span class="main">(</span>δ0 <span class="free">qd1</span> <span class="free">qd2</span><span class="main">)</span> <span class="main">⟶</span> val <span class="free">qd1</span> <span class="bound">ε</span> <span class="main">≤</span> val <span class="free">qd2</span> <span class="bound">ε</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">e</span> <span class="bound">c1</span> <span class="bound">c2</span> <span class="bound">k1</span> <span class="bound">k2</span> <span class="main">::</span> rat<span class="main">.</span> <span class="main">⟦</span><span class="bound">e</span> <span class="main">≥</span> <span class="main">0</span><span class="main">;</span> <span class="bound">c1</span> <span class="main">&lt;</span> <span class="bound">c2</span><span class="main">;</span> <span class="bound">k1</span> <span class="main">≤</span> <span class="bound">k2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">c1</span> <span class="main">+</span> <span class="bound">e</span><span class="main">*</span><span class="bound">k1</span> <span class="main">≤</span> <span class="bound">c2</span> <span class="main">+</span> <span class="bound">e</span><span class="main">*</span><span class="bound">k2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">c1</span> <span class="skolem">c2</span> <span class="skolem">k1</span> <span class="skolem">k2</span> <span class="main">::</span> <span class="quoted">rat</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="skolem">e</span> <span class="main">≥</span> <span class="main">0</span><span class="main">;</span> <span class="skolem">c1</span> <span class="main">&lt;</span> <span class="skolem">c2</span><span class="main">;</span> <span class="skolem">k1</span> <span class="main">≤</span> <span class="skolem">k2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">c1</span> <span class="main">+</span> <span class="skolem">e</span><span class="main">*</span><span class="skolem">k1</span> <span class="main">≤</span> <span class="skolem">c2</span> <span class="main">+</span> <span class="skolem">e</span><span class="main">*</span><span class="skolem">k2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mult_left_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">k1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> add_less_le_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">*</span><span class="skolem">k1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">*</span><span class="skolem">k2</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> δ0_def val_def less_eq_QDelta_def Let_def <span class="dynamic"><span class="dynamic">field_simps</span></span> mult_left_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">δ_min</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>QDelta <span class="main">×</span> QDelta<span class="main">)</span> list <span class="main">⇒</span> rat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">δ_min</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">δ_min</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> min <span class="main">(</span><span class="free">δ_min</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>δ0 <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> delta_gt_zero<span class="main">:</span>
  <span class="quoted"><span class="quoted">"δ_min <span class="free">l</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="dynamic"><span class="dynamic">field_simps</span></span> δ0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> delta_le_one<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"δ_min <span class="free">l</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> delta_min_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"δ_min <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span> <span class="main">=</span> min <span class="main">(</span>δ_min <span class="free">as</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> delta_le_one<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">bs</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> delta_min_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">as</span> <span class="main">⊆</span> set <span class="free">bs</span> <span class="main">⟹</span> δ_min <span class="free">bs</span> <span class="main">≤</span> δ_min <span class="free">as</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> delta_le_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="free">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> split_list<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs1</span></span> <span class="skolem"><span class="skolem">bs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">=</span> <span class="skolem">bs1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"δ_min <span class="free">bs</span> <span class="main">=</span> δ_min <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bs delta_min_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bs <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> delta_min<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">qd1</span> <span class="bound">qd2</span><span class="main">.</span> <span class="main">(</span><span class="bound">qd1</span><span class="main">,</span> <span class="bound">qd2</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">qd</span> <span class="main">⟶</span> <span class="bound">qd1</span> <span class="main">≤</span> <span class="bound">qd2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">ε</span><span class="main">.</span> <span class="bound">ε</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">ε</span> <span class="main">≤</span> δ_min <span class="free">qd</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">qd1</span> <span class="bound">qd2</span><span class="main">.</span> <span class="main">(</span><span class="bound">qd1</span><span class="main">,</span> <span class="bound">qd2</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">qd</span> <span class="main">⟶</span> val <span class="bound">qd1</span> <span class="bound">ε</span> <span class="main">≤</span> val <span class="bound">qd2</span> <span class="bound">ε</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">using</span></span> delta0
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">qd</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> QDelta_0_0<span class="main">:</span> <span class="quoted"><span class="quoted">"QDelta <span class="main">0</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span>
<span class="keyword1"><span class="command">lemma</span></span> qdsnd_0<span class="main">:</span> <span class="quoted"><span class="quoted">"qdsnd <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span>
<span class="keyword1"><span class="command">lemma</span></span> qdfst_0<span class="main">:</span> <span class="quoted"><span class="quoted">"qdfst <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Simplex">
<div class="head">
<h1>Theory Simplex</h1>
</div>
<pre class="source"><span class="comment1">(* Authors: F. Maric, M. Spasic, R. Thiemann *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Simplex Algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Simplex
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Linear_Poly_Maps.html">Linear_Poly_Maps</a>
    <a href="QDelta.html">QDelta</a>
    <a href="Rel_Chain.html">Rel_Chain</a>
    <a href="Simplex_Algebra.html">Simplex_Algebra</a>
    <span class="quoted">"<a href="../../HOL/HOL-Library/RBT_Mapping.html">HOL-Library.RBT_Mapping</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Permutation.html">HOL-Library.Permutation</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Numeral.html">HOL-Library.Code_Target_Numeral</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Linear constraints are of the form <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p ⨝ c›</span></span></span></span> or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p<span class="hidden">⇩</span><sub>1</sub> ⨝ p<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span>, where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span>, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span>, are
linear polynomials, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span> is a rational constant and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⨝ ∈
{&lt;, &gt;, ≤, ≥, =}›</span></span></span></span>. Their abstract syntax is given by the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>constraint›</span></span></span></span> type, and semantics is given by the relation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊨<span class="hidden">⇩</span><sub>c</sub>›</span></span></span></span>, defined straightforwardly by primitive recursion over the
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>constraint›</span></span></span></span> type. A set of constraints is satisfied,
denoted by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub>›</span></span></span></span>, if all constraints are. There is also an indexed
version <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub>›</span></span></span></span> which takes an explicit set of indices and then only
demands that these constraints are satisfied.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> constraint <span class="main">=</span> LT <span class="quoted">linear_poly</span> <span class="quoted">rat</span>
  <span class="main">|</span> GT <span class="quoted">linear_poly</span> <span class="quoted">rat</span>
  <span class="main">|</span> LEQ <span class="quoted">linear_poly</span> <span class="quoted">rat</span>
  <span class="main">|</span> GEQ <span class="quoted">linear_poly</span> <span class="quoted">rat</span>
  <span class="main">|</span> EQ <span class="quoted">linear_poly</span> <span class="quoted">rat</span>
  <span class="main">|</span> LTPP <span class="quoted">linear_poly</span> <span class="quoted">linear_poly</span>
  <span class="main">|</span> GTPP <span class="quoted">linear_poly</span> <span class="quoted">linear_poly</span>
  <span class="main">|</span> LEQPP <span class="quoted">linear_poly</span> <span class="quoted">linear_poly</span>
  <span class="main">|</span> GEQPP <span class="quoted">linear_poly</span> <span class="quoted">linear_poly</span>
  <span class="main">|</span> EQPP <span class="quoted">linear_poly</span> <span class="quoted">linear_poly</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Indexed constraints are just pairs of indices and constraints. Indices will be used
  to identify constraints, e.g., to easily specify an unsatisfiable core by a list of indices.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'i</span> i_constraint <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">×</span> constraint"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">restrict_to</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">restrict_to</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> snd <span class="main">`</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∩</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The operation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> restrict_to<span class="antiquote"><span class="antiquote">}</span></span></span></span> is used to select constraints for a given index set.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">flat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flat</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> snd <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The operation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> flat<span class="antiquote"><span class="antiquote">}</span></span></span></span> is used to drop indices from a set of indexed constraints.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">flat_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flat_list</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> map snd <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">satisfies_constraint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> lrv valuation <span class="main">⇒</span> constraint <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="main">(</span>LT <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>c</sub></span></span> GT <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>c</sub></span></span> LEQ <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span><span class="main">)</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>c</sub></span></span> GEQ <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span><span class="main">)</span> <span class="main">≥</span>  <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>c</sub></span></span> EQ <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>c</sub></span></span> LTPP <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>c</sub></span></span> GTPP <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>c</sub></span></span> LEQPP <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>c</sub></span></span> GEQPP <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>c</sub></span></span> EQPP <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">satisfies_constraints</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat valuation <span class="main">⇒</span> constraint set <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">c</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unsat_mono<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">cs</span> <span class="main">⊆</span> <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">ds</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">i_satisfies_cs</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> restrict_to <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">distinct_indices</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">distinct_indices</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> <span class="main">(</span>distinct <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_indicesD<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_indices <span class="free">as</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">as</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">as</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> distinct_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_key_imp_eq_value<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the unsat-core predicate we only demand minimality in case that the indices are distinct.
  Otherwise, minimality does in general not hold. For instance, consider the input
  constraints $c_1: x &lt; 0$, $c_2: x &gt; 2$ and $c_2: x &lt; 1$ where the index $c_2$ occurs twice.
  If the simplex-method first encounters constraint $c_1$, then it will detect that there is a conflict
  between $c_1$ and the first $c_2$-constraint. Consequently, the index-set $\{c_1,c_2\}$ will be returned,
  but this set is not minimal since $\{c_2\}$ is already unsatisfiable.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">minimal_unsat_core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> set <span class="main">⇒</span> <span class="tfree">'i</span> i_constraint list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minimal_unsat_core</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">)</span>
     <span class="main">∧</span> <span class="main">(</span>distinct_indices <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">J</span><span class="main">.</span> <span class="bound">J</span> <span class="main">⊂</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">J</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Procedure Specification›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">Unsat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Unsat</span> <span class="main">≡</span> Inl"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">Sat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Sat</span> <span class="main">≡</span> Inr"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The specification for the satisfiability check procedure is given by:›</span></span>
<span class="keyword1"><span class="command">locale</span></span> Solve <span class="main">=</span>
  <span class="comment1">― ‹Decide if the given list of constraints is satisfiable. Return either
     an unsat core, or a satisfying valuation.›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">solve</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> i_constraint list <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> rat valuation"</span></span>
    <span class="comment1">― ‹If the status <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Sat<span class="antiquote">}</span></span> is returned, then returned valuation
      satisfies all constraints.›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  simplex_sat<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">solve</span> <span class="free">cs</span> <span class="main">=</span> Sat <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> flat <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span>"</span></span>
    <span class="comment1">― ‹If the status <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Unsat<span class="antiquote">}</span></span> is returned, then constraints are
     unsatisfiable, i.e., an unsatisfiable core is returned.›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  simplex_unsat<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">solve</span> <span class="free">cs</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span> minimal_unsat_core <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="free">cs</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">look</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">look</span> <span class="main">≡</span> Mapping.lookup"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">upd</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">upd</span> <span class="main">≡</span> Mapping.update"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> look_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>upd <span class="free">k</span> <span class="free">v</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>look <span class="free">m</span><span class="main">)</span><span class="main">(</span><span class="free">k</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> look_upd_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> look_upd Mapping.lookup_empty

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map2fun</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var<span class="main">,</span> <span class="tfree">'a</span> <span class="main">::</span> zero<span class="main">)</span> mapping <span class="main">⇒</span> var <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map2fun</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> look <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Some <span class="bound">y</span> <span class="main">⇒</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_map2fun"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> mapping <span class="main">⇒</span> var <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span>"</span> <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> map2fun <span class="free">v</span>"</span>

<span class="keyword1"><span class="command">lemma</span></span> map2fun_def'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="free">x</span> <span class="main">≡</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">v</span> <span class="free">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Some <span class="bound">y</span> <span class="main">⇒</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map2fun_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Note that the above specification requires returning a
valuation (defined as a HOL function), which is not efficiently
executable. In order to enable more efficient data structures for
representing valuations, a refinement of this specification is needed
and the function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>solve›</span></span></span></span> is replaced by the function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>solve_exec›</span></span></span></span> returning optional <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(var, rat) mapping›</span></span></span></span> instead
of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>var ⇒ rat›</span></span></span></span> function. This way, efficient data structures
for representing mappings can be easily plugged-in during code
generation \cite{florian-refinement}. A conversion from the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>mapping›</span></span></span></span> datatype to HOL function is denoted by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⟨_⟩›</span></span></span></span> and
given by: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> map2fun_def'<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> SolveExec <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">solve_exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> i_constraint list <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> mapping"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  simplex_sat0<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">solve_exec</span> <span class="free">cs</span> <span class="main">=</span> Sat <span class="free">v</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> flat <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  simplex_unsat0<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">solve_exec</span> <span class="free">cs</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span> minimal_unsat_core <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="free">cs</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">solve</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">solve</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free">solve_exec</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">of</span> Sat <span class="bound">v</span> <span class="main">⇒</span> Sat <span class="main">⟨</span><span class="bound">v</span><span class="main">⟩</span> <span class="main">|</span> Unsat <span class="bound">c</span> <span class="main">⇒</span> Unsat <span class="bound">c</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> SolveExec <span class="main">&lt;</span> Solve <span class="quoted">solve</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> simplex_sat0 simplex_unsat0<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> solve_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Handling Strict Inequalities›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The first step of the procedure is removing all equalities and
strict inequalities. Equalities can be easily rewritten to non-strict
inequalities. Removing strict inequalities can be done by replacing
the list of constraints by a new one, formulated over an extension
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℚ'›</span></span></span></span> of the space of rationals <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℚ›</span></span></span></span>. <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℚ'›</span></span></span></span> must
have a structure of a linearly ordered vector space over <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℚ›</span></span></span></span>
(represented by the type class <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>lrv›</span></span></span></span>) and must guarantee that
if some non-strict constraints are satisfied in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℚ'›</span></span></span></span>, then
there is a satisfying valuation for the original constraints in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℚ›</span></span></span></span>. Our final implementation uses the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℚ<span class="hidden">⇩</span><sub>δ</sub>›</span></span></span></span> space, defined in
\cite{simplex-rad} (basic idea is to replace <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p &lt; c›</span></span></span></span> by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p ≤ c - δ›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p &gt; c›</span></span></span></span> by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p ≥ c + δ›</span></span></span></span> for a symbolic
parameter <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>δ›</span></span></span></span>). So, all constraints are reduced to the form
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p ⨝ b›</span></span></span></span>, where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> is a linear polynomial (still over
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℚ›</span></span></span></span>), <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>b›</span></span></span></span> is constant from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℚ'›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⨝
∈ {≤, ≥}›</span></span></span></span>. The non-strict constraints are represented by the type
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a ns_constraint›</span></span></span></span>, and their semantics is denoted by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub>›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub>›</span></span></span></span>. The indexed variant is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub>›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> ns_constraint <span class="main">=</span> LEQ_ns <span class="quoted">linear_poly</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>    <span class="main">|</span>    GEQ_ns <span class="quoted">linear_poly</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_ns_constraint <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">×</span> <span class="tfree">'a</span> ns_constraint"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">satisfiable_ns_constraint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>lrv valuation <span class="main">⇒</span> <span class="tfree">'a</span> ns_constraint <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span></span> LEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span></span> GEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">satisfies_ns_constraints</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>lrv valuation <span class="main">⇒</span> <span class="tfree">'a</span> ns_constraint set <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> "</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">c</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">i_satisfies_ns_constraints</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> set <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span>lrv valuation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_ns_constraint set <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> "</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> restrict_to <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> i_satisfies_ns_constraints_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span> <span class="main">⟹</span> <span class="free">J</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">J</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ns_constraint <span class="main">⇒</span> linear_poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">poly</span> <span class="main">(</span>LEQ_ns <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">poly</span> <span class="main">(</span>GEQ_ns <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ns_constraint_const</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ns_constraint <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ns_constraint_const</span> <span class="main">(</span>LEQ_ns <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ns_constraint_const</span> <span class="main">(</span>GEQ_ns <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">distinct_indices_ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span> <span class="main">::</span> lrv<span class="main">)</span> i_ns_constraint set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">distinct_indices_ns</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">n1</span> <span class="bound">n2</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">n1</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">n2</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">⟶</span> 
     poly <span class="bound">n1</span> <span class="main">=</span> poly <span class="bound">n2</span> <span class="main">∧</span> ns_constraint_const <span class="bound">n1</span> <span class="main">=</span> ns_constraint_const <span class="bound">n2</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">minimal_unsat_core_ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span> <span class="main">::</span> lrv<span class="main">)</span> i_ns_constraint set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minimal_unsat_core_ns</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⊆</span> fst <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span>
     <span class="main">∧</span> <span class="main">(</span>distinct_indices_ns <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">J</span></span> <span class="main">⊂</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">J</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Specification of reduction of constraints to non-strict form is given by:›</span></span>
<span class="keyword1"><span class="command">locale</span></span> To_ns <span class="main">=</span>
  <span class="comment1">― ‹Convert a constraint to an equisatisfiable non-strict constraint list.
      The conversion must work for arbitrary subsets of constraints -- selected by some index set I --
      in order to carry over unsat-cores and in order to support incremental simplex solving.›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">to_ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> i_constraint list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> i_ns_constraint list"</span></span>
    <span class="comment1">― ‹Convert the valuation that satisfies all non-strict constraints to the valuation that
   satisfies all initial constraints.›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">from_ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> mapping <span class="main">⇒</span> <span class="tfree">'a</span> ns_constraint list <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> mapping"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  to_ns_unsat<span class="main">:</span>  <span class="quoted"><span class="quoted">"minimal_unsat_core_ns <span class="free">I</span> <span class="main">(</span>set <span class="main">(</span><span class="free">to_ns</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> minimal_unsat_core <span class="free">I</span> <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  i_to_ns_sat<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="main">⟨</span><span class="free">v'</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="main">(</span><span class="free">to_ns</span> <span class="free">cs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="main">⟨</span><span class="free">from_ns</span> <span class="free">v'</span> <span class="main">(</span>flat_list <span class="main">(</span><span class="free">to_ns</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> to_ns_indices<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="main">(</span><span class="free">to_ns</span> <span class="free">cs</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_cond<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_indices <span class="free">cs</span> <span class="main">⟹</span> distinct_indices_ns <span class="main">(</span>set <span class="main">(</span><span class="free">to_ns</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> to_ns_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">v'</span><span class="main">⟩</span>  <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> flat <span class="main">(</span>set <span class="main">(</span><span class="free">to_ns</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">from_ns</span> <span class="free">v'</span> <span class="main">(</span>flat_list <span class="main">(</span><span class="free">to_ns</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> flat <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> i_to_ns_sat<span class="main">[</span><span class="operator">of</span> <span class="quoted">UNIV</span> <span class="quoted"><span class="free">v'</span></span> <span class="quoted"><span class="free">cs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> Solve_exec_ns <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">solve_exec_ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> i_ns_constraint list <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="main">(</span>var<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> mapping"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> simplex_ns_sat<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">solve_exec_ns</span> <span class="free">cs</span> <span class="main">=</span> Sat <span class="free">v</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> flat <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> simplex_ns_unsat<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">solve_exec_ns</span> <span class="free">cs</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span> minimal_unsat_core_ns <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹After the transformation, the procedure is reduced to solving
only the non-strict constraints, implemented in the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>solve_exec_ns›</span></span></span></span> function having an analogous specification to the
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>solve›</span></span></span></span> function. If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>to_ns›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>from_ns›</span></span></span></span> and
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>solve_exec_ns›</span></span></span></span> are available, the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>solve_exec›</span></span></span></span>
function can be easily defined and it can be easily shown that this
definition satisfies its specification (also analogous to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>solve›</span></span></span></span>).
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> SolveExec' <span class="main">=</span> To_ns <span class="quoted"><span class="free">to_ns</span></span> <span class="quoted"><span class="free">from_ns</span></span> <span class="main">+</span> Solve_exec_ns <span class="quoted"><span class="free">solve_exec_ns</span></span> <span class="keyword2"><span class="keyword">for</span></span>
  <span class="free">to_ns</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> i_constraint list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> i_ns_constraint list"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">from_ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> mapping <span class="main">⇒</span> <span class="tfree">'a</span> ns_constraint list <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> mapping"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">solve_exec_ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_ns_constraint list <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="main">(</span>var<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> mapping"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">solve_exec</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">solve_exec</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">cs'</span> <span class="main">=</span> <span class="free">to_ns</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">in</span> <span class="keyword1">case</span> <span class="free">solve_exec_ns</span> <span class="bound">cs'</span>
            <span class="keyword1">of</span> Sat <span class="bound">v</span> <span class="main">⇒</span> Sat <span class="main">(</span><span class="free">from_ns</span> <span class="bound">v</span> <span class="main">(</span>flat_list <span class="bound">cs'</span><span class="main">)</span><span class="main">)</span>
             <span class="main">|</span> Unsat <span class="bound">is</span> <span class="main">⇒</span> Unsat <span class="bound">is</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">sublocale</span></span> SolveExec' <span class="main">&lt;</span> SolveExec <span class="quoted">solve_exec</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> simplex_ns_sat simplex_ns_unsat to_ns_sat to_ns_unsat<span class="main"><span class="keyword3">,</span></span>
      <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> solve_exec_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preprocessing›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The next step in the procedure rewrites a list of non-strict
constraints into an equisatisfiable form consisting of a list of
linear equations (called the \emph{tableau}) and of a list of
\emph{atoms} of the form <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x<span class="hidden">⇩</span><sub>i</sub> ⨝ b<span class="hidden">⇩</span><sub>i</sub>›</span></span></span></span> where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x<span class="hidden">⇩</span><sub>i</sub>›</span></span></span></span> is a
variable and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>b<span class="hidden">⇩</span><sub>i</sub>›</span></span></span></span> is a constant (from the extension field). The
transformation is straightforward and introduces auxiliary variables
for linear polynomials occurring in the initial formula. For example,
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[x<span class="hidden">⇩</span><sub>1</sub> + x<span class="hidden">⇩</span><sub>2</sub> ≤ b<span class="hidden">⇩</span><sub>1</sub>, x<span class="hidden">⇩</span><sub>1</sub> + x<span class="hidden">⇩</span><sub>2</sub> ≥ b<span class="hidden">⇩</span><sub>2</sub>, x<span class="hidden">⇩</span><sub>2</sub> ≥ b<span class="hidden">⇩</span><sub>3</sub>]›</span></span></span></span> can be transformed to
the tableau <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[x<span class="hidden">⇩</span><sub>3</sub> = x<span class="hidden">⇩</span><sub>1</sub> + x<span class="hidden">⇩</span><sub>2</sub>]›</span></span></span></span> and atoms <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[x<span class="hidden">⇩</span><sub>3</sub> ≤ b<span class="hidden">⇩</span><sub>1</sub>, x<span class="hidden">⇩</span><sub>3</sub> ≥
b<span class="hidden">⇩</span><sub>2</sub>, x<span class="hidden">⇩</span><sub>2</sub> ≥ b<span class="hidden">⇩</span><sub>3</sub>]›</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> eq <span class="main">=</span> <span class="quoted"><span class="quoted">"var <span class="main">×</span> linear_poly"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lhs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"eq <span class="main">⇒</span> var"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lhs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rhs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"eq <span class="main">⇒</span> linear_poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rhs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rvars_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"eq <span class="main">⇒</span> var set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rvars_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">≡</span> vars <span class="main">(</span>rhs <span class="free"><span class="bound"><span class="entity">eq</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">satisfies_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>rational_vector valuation <span class="main">⇒</span> eq <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>lhs <span class="free"><span class="bound"><span class="entity">eq</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>rhs <span class="free"><span class="bound"><span class="entity">eq</span></span></span><span class="main">)</span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_eq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">≡</span> <span class="free">v</span> <span class="free">x</span> <span class="main">=</span> <span class="free">p</span><span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_eq_def<span class="main">)</span>



<span class="keyword1"><span class="command">type_synonym</span></span> tableau <span class="main">=</span><span class="quoted"><span class="quoted">"eq list"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">satisfies_tableau</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>rational_vector valuation <span class="main">⇒</span> tableau <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">e</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lvars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> var set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lvars</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> set <span class="main">(</span>map lhs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rvars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> var set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rvars</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map rvars_eq <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tvars</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">tvars</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> lvars <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∪</span> rvars <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The condition that the rhss are non-zero is required to obtain minimal unsatisfiable cores.
To observe the problem with 0 as rhs, consider the tableau $x = 0$ in combination
with atom $(A: x \leq 0)$ where then $(B: x \geq 1)$ is asserted.
In this case, the unsat core would be computed as $\{A,B\}$, although already $\{B\}$ is unsatisfiable.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">normalized_tableau</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">△</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">normalized_tableau</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> distinct <span class="main">(</span>map lhs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∧</span> lvars <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∩</span> rvars <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">∉</span> rhs <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Equations are of the form <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x = p›</span></span></span></span>, where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> is
a variable and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> is a polynomial, and are represented by the
type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>eq = var × linear_poly›</span></span></span></span>. Semantics of equations is given
by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> satisfies_eq_iff<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Tableau is represented as a list
of equations, by the type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>tableau = eq list›</span></span></span></span>. Semantics for a
tableau is given by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> satisfies_tableau_def<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Functions
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>lvars›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rvars›</span></span></span></span> return sets of variables appearing on
the left hand side (lhs) and the right hand side (rhs) of a
tableau. Lhs variables are called \emph{basic} while rhs variables are
called \emph{non-basic} variables. A tableau <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span> is
\emph{normalized} (denoted by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">△</span></span> <span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) iff no variable occurs on
the lhs of two equations in a tableau and if sets of lhs and rhs
variables are distinct.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_tableau_unique_eq_for_lvar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> lvars <span class="free">t</span><span class="main">.</span> <span class="main">∃!</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lvars <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lvars_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">p1</span> <span class="skolem">p2</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p1</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p2</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">=</span> <span class="skolem">p2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="free">t</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_map inj_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> recalc_tableau_lvars<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars <span class="free">t</span><span class="main">.</span> <span class="bound">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">v'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> lvars <span class="free">t</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">t</span><span class="main">)</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span> <span class="keyword1">else</span> <span class="skolem">v</span> <span class="bound">x</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars <span class="free">t</span><span class="main">.</span> <span class="skolem">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">v'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?v'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>rvars <span class="free">t</span><span class="main">.</span> <span class="skolem">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="var">?v'</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="free">t</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> satisfies_tableau_def satisfies_eq_def
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> set <span class="free">t</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v'</span> <span class="main">(</span>lhs <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> rhs <span class="skolem">e</span> <span class="main">⦃</span> <span class="var">?v'</span> <span class="main">⦄</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lhs <span class="skolem">e</span><span class="main">,</span> rhs <span class="skolem">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">∈</span> set <span class="free">t</span>›</span></span> e <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>lhs <span class="skolem">e</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="free">t</span>›</span></span> normalized_tableau_unique_eq_for_lvar<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">∈</span> set <span class="free">t</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> lvars_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">THE</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span>lhs <span class="skolem">e</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lhs <span class="skolem">e</span><span class="main">,</span> <span class="var">?p</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> theI'<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>lhs <span class="skolem">e</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">t</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">=</span> rhs <span class="skolem">e</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>lhs <span class="skolem">e</span><span class="main">,</span> rhs <span class="skolem">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">t</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃!</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>lhs <span class="skolem">e</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">t</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v'</span> <span class="main">(</span>lhs <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="var">?p</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">∈</span> set <span class="free">t</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> lvars_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rhs <span class="skolem">e</span> <span class="main">⦃</span> <span class="var">?v'</span> <span class="main">⦄</span> <span class="main">=</span> rhs <span class="skolem">e</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> valuate_depend<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">∈</span> set <span class="free">t</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lvars_def rvars_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tableau_perm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lvars <span class="free">t1</span> <span class="main">=</span> lvars <span class="free">t2</span>"</span></span> <span class="quoted"><span class="quoted">"rvars <span class="free">t1</span> <span class="main">=</span> rvars <span class="free">t2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>lrv valuation<span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t1</span> <span class="main">⟷</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">&lt;~~&gt;</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t1</span> <span class="skolem">t2</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lvars <span class="skolem">t1</span> <span class="main">=</span> lvars <span class="skolem">t2</span>"</span></span> <span class="quoted"><span class="quoted">"rvars <span class="skolem">t1</span> <span class="main">=</span> rvars <span class="skolem">t2</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="skolem">t1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>lrv valuation<span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t1</span> <span class="main">⟷</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">t1</span> <span class="main">⊆</span> set <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t1</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> lvars <span class="skolem">t1</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lvars_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> lvars <span class="skolem">t2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹lvars <span class="skolem">t1</span> <span class="main">=</span> lvars <span class="skolem">t2</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t2</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lvars_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">.</span> <span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>vars <span class="main">(</span><span class="skolem">b</span> <span class="main">-</span> <span class="skolem">b'</span><span class="main">)</span><span class="main">.</span> <span class="bound">v'</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">-</span> <span class="skolem">b'</span><span class="main">)</span> <span class="main">⦃</span> <span class="bound">v'</span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> valuation"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars <span class="skolem">t1</span><span class="main">.</span> <span class="skolem">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="bound">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> recalc_tableau_lvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="skolem">t1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t1</span> <span class="main">⟷</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t2</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">⦃</span><span class="skolem">v'</span><span class="main">⦄</span> <span class="main">=</span> <span class="skolem">b'</span> <span class="main">⦃</span><span class="skolem">v'</span><span class="main">⦄</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t1</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t2</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> satisfies_tableau_def satisfies_eq_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span> <span class="main">-</span> <span class="skolem">b'</span><span class="main">)</span> <span class="main">⦃</span><span class="skolem">v'</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> valuate_minus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">b'</span></span> <span class="quoted"><span class="skolem">v'</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars <span class="skolem">b</span> <span class="main">⊆</span> rvars <span class="skolem">t1</span>"</span></span> <span class="quoted"><span class="quoted">"vars <span class="skolem">b'</span> <span class="main">⊆</span> rvars <span class="skolem">t1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t2</span>›</span></span> <span class="quoted"><span class="quoted">‹rvars <span class="skolem">t1</span> <span class="main">=</span> rvars <span class="skolem">t2</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> rvars_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars <span class="main">(</span><span class="skolem">b</span> <span class="main">-</span> <span class="skolem">b'</span><span class="main">)</span> <span class="main">⊆</span> rvars <span class="skolem">t1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> vars_minus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">b'</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>vars <span class="main">(</span><span class="skolem">b</span> <span class="main">-</span> <span class="skolem">b'</span><span class="main">)</span><span class="main">.</span> <span class="skolem">v'</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">v</span> <span class="bound">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars <span class="skolem">t1</span><span class="main">.</span> <span class="skolem">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="bound">x</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>vars <span class="main">(</span><span class="skolem">b</span> <span class="main">-</span> <span class="skolem">b'</span><span class="main">)</span><span class="main">.</span> <span class="bound">v'</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">-</span> <span class="skolem">b'</span><span class="main">)</span> <span class="main">⦃</span> <span class="bound">v'</span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">b'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> all_val<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">-</span> <span class="skolem">b'</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t2</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">t1</span> <span class="main">=</span> set <span class="free">t2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span><span class="main">]</span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t2</span></span> <span class="quoted"><span class="free">t1</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">t2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="free">t1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="free">t2</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_map<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_eq_iff_mset_eq_distinct mset_eq_perm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Elementary atoms are represented by the type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a atom›</span></span></span></span>
and semantics for atoms and sets of atoms is denoted by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊨<span class="hidden">⇩</span><sub>a</sub>›</span></span></span></span> and
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub>›</span></span></span></span> and given by:
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> atom  <span class="main">=</span> Leq <span class="quoted">var</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>    <span class="main">|</span>    Geq <span class="quoted">var</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">atom_var</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> atom <span class="main">⇒</span> var"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atom_var</span> <span class="main">(</span>Leq <span class="free"><span class="bound"><span class="entity">var</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">var</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atom_var</span> <span class="main">(</span>Geq <span class="free"><span class="bound"><span class="entity">var</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">var</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">atom_const</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> atom <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atom_const</span> <span class="main">(</span>Leq <span class="free"><span class="bound"><span class="entity">var</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atom_const</span> <span class="main">(</span>Geq <span class="free"><span class="bound"><span class="entity">var</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">satisfies_atom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder valuation <span class="main">⇒</span> <span class="tfree">'a</span> atom <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>a</sub></span></span> Leq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>    <span class="main">|</span>    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>a</sub></span></span> Geq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">satisfies_atom_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder valuation <span class="main">⇒</span> <span class="tfree">'a</span> atom set <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span> <span class="bound">a</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">satisfies_atom'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder valuation <span class="main">⇒</span> <span class="tfree">'a</span> atom <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>atom_var <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> atom_const <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_atom'_stronger<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> satisfies_atom'_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">satisfies_atom_set'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder valuation <span class="main">⇒</span> <span class="tfree">'a</span> atom set <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">a</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_atom_set'_stronger<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> satisfies_atom'_stronger <span class="keyword1"><span class="command">unfolding</span></span> satisfies_atom_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There is also the indexed variant of an atom›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">×</span> <span class="tfree">'a</span> atom"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">i_satisfies_atom_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> set <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span>linorder valuation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom set <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> restrict_to <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">i_satisfies_atom_set'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> set <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span>linorder valuation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom set <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub></span> restrict_to <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> i_satisfies_atom_set'_stronger<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Iv</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span> <span class="main">⟹</span> <span class="free">Iv</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> satisfies_atom_set'_stronger<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"snd <span class="free">Iv</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Iv</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisifies_atom_restrict_to_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> restrict_to <span class="free">I</span> <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">a</span><span class="main">)</span>
  <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> restrict_to <span class="free">I</span> <span class="main">(</span>set <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> satisfies_atom_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_tableau_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">(</span><span class="free">e</span> <span class="main">#</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> satisfies_tableau_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">distinct_indices_atoms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">distinct_indices_atoms</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">⟶</span> atom_var <span class="bound">a</span> <span class="main">=</span> atom_var <span class="bound">b</span> <span class="main">∧</span> atom_const <span class="bound">a</span> <span class="main">=</span> atom_const <span class="bound">b</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The specification of the preprocessing function is given by:›</span></span>
<span class="keyword1"><span class="command">locale</span></span> Preprocess <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">preprocess</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> i_ns_constraint list <span class="main">⇒</span> tableau<span class="main">×</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom list
  <span class="main">×</span> <span class="main">(</span><span class="main">(</span>var<span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> mapping <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> mapping<span class="main">)</span> <span class="main">×</span> <span class="tfree">'i</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="comment1">― ‹The returned tableau is always normalized.›</span>
    preprocess_tableau_normalized<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="free">cs</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">as</span><span class="main">,</span><span class="free">trans_v</span><span class="main">,</span><span class="free">U</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">△</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹Tableau and atoms are equisatisfiable with starting non-strict constraints.›</span>
i_preprocess_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v</span><span class="main">.</span> <span class="free">preprocess</span> <span class="free">cs</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">as</span><span class="main">,</span><span class="free">trans_v</span><span class="main">,</span><span class="free">U</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">∩</span> set <span class="free">U</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="main">⟨</span><span class="bound">v</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="bound">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="main">⟨</span><span class="free">trans_v</span> <span class="bound">v</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

preprocess_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="free">cs</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">as</span><span class="main">,</span><span class="free">trans_v</span><span class="main">,</span><span class="free">U</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹distinct indices on ns-constraints ensures distinct indices in atoms›</span>
preprocess_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="free">cs</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">as</span><span class="main">,</span><span class="free">trans_v</span><span class="main">,</span> <span class="free">U</span><span class="main">)</span> <span class="main">⟹</span> distinct_indices_ns <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="main">⟹</span> distinct_indices_atoms <span class="main">(</span>set <span class="free">as</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹unsat indices›</span>
preprocess_unsat_indices<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="free">cs</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">as</span><span class="main">,</span><span class="free">trans_v</span><span class="main">,</span> <span class="free">U</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> set <span class="free">U</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹preprocessing cannot introduce new indices›</span>
preprocess_index<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="free">cs</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">as</span><span class="main">,</span><span class="free">trans_v</span><span class="main">,</span> <span class="free">U</span><span class="main">)</span> <span class="main">⟹</span> fst <span class="main">`</span> set <span class="free">as</span> <span class="main">∪</span> set <span class="free">U</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="free">cs</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> preprocess_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="free">cs</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">as</span><span class="main">,</span><span class="free">trans_v</span><span class="main">,</span><span class="free">U</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">U</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> flat <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">trans_v</span> <span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> flat <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> i_preprocess_sat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">trans_v</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted">UNIV</span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">minimal_unsat_core_tabl_atoms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> set <span class="main">⇒</span> tableau <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> i_atom set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minimal_unsat_core_tabl_atoms</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⊆</span> fst <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span>distinct_indices_atoms <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">J</span></span> <span class="main">⊂</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">J</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> minimal_unsat_core_tabl_atomsD<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_tabl_atoms <span class="free">I</span> <span class="free">t</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> fst <span class="main">`</span> <span class="free">as</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"distinct_indices_atoms <span class="free">as</span> <span class="main">⟹</span> <span class="free">J</span> <span class="main">⊂</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="free">J</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> minimal_unsat_core_tabl_atoms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">locale</span></span> AssertAll <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">assert_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> i_atom list <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="main">(</span>var<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span>mapping"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assert_all_sat<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">assert_all</span> <span class="free">t</span> <span class="free">as</span> <span class="main">=</span> Sat <span class="free">v</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">∧</span> <span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> flat <span class="main">(</span>set <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assert_all_unsat<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">assert_all</span> <span class="free">t</span> <span class="free">as</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span> minimal_unsat_core_tabl_atoms <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="free">t</span> <span class="main">(</span>set <span class="free">as</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Once the preprocessing is done and tableau and atoms are
obtained, their satisfiability is checked by the
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_all›</span></span></span></span> function. Its precondition is that the starting
tableau is normalized, and its specification is analogue to the one for the
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>solve›</span></span></span></span> function. If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>preprocess›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_all›</span></span></span></span>
are available, the  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>solve_exec_ns›</span></span></span></span> can be defined, and it
can easily be shown that this definition satisfies the specification.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Solve_exec_ns' <span class="main">=</span> Preprocess <span class="quoted"><span class="free">preprocess</span></span> <span class="main">+</span> AssertAll <span class="quoted"><span class="free">assert_all</span></span> <span class="keyword2"><span class="keyword">for</span></span>
  <span class="free">preprocess</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> i_ns_constraint list <span class="main">⇒</span> tableau <span class="main">×</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom list <span class="main">×</span> <span class="main">(</span><span class="main">(</span>var<span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>mapping <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>mapping<span class="main">)</span> <span class="main">×</span> <span class="tfree">'i</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">assert_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> i_atom list <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="main">(</span>var<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> mapping"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">solve_exec_ns</span> <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted"><span class="quoted">"<span class="free">solve_exec_ns</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
    <span class="keyword1">case</span> <span class="free">preprocess</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">as</span><span class="main">,</span><span class="bound">trans_v</span><span class="main">,</span><span class="bound">ui</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="bound">ui</span> <span class="keyword1">of</span> <span class="bound">i</span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Inl <span class="main">[</span><span class="bound">i</span><span class="main">]</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free">assert_all</span> <span class="bound">t</span> <span class="bound">as</span> <span class="keyword1">of</span> Inl <span class="bound">I</span> <span class="main">⇒</span> Inl <span class="bound">I</span> <span class="main">|</span> Inr <span class="bound">v</span> <span class="main">⇒</span> Inr <span class="main">(</span><span class="bound">trans_v</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> Preprocess
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> preprocess_unsat_index<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> prep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="free">cs</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">as</span><span class="main">,</span><span class="free">trans_v</span><span class="main">,</span><span class="free">ui</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="free">ui</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_ns <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> preprocess_index<span class="main">[</span><span class="operator">OF</span> prep<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ui</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> i'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> preprocess_unsat_indices<span class="main">[</span><span class="operator">OF</span> prep i<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> minimal_unsat_core_ns_def <span class="keyword1"><span class="command">using</span></span> i' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> preprocess_minimal_unsat_core<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> prep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="free">cs</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">as</span><span class="main">,</span><span class="free">trans_v</span><span class="main">,</span><span class="free">ui</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_unsat_core_tabl_atoms <span class="free">I</span> <span class="free">t</span> <span class="main">(</span>set <span class="free">as</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> inter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∩</span> set <span class="free">ui</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_ns <span class="free">I</span> <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> preprocess_tableau_normalized<span class="main">[</span><span class="operator">OF</span> prep<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> preprocess_index<span class="main">[</span><span class="operator">OF</span> prep<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> index<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="free">as</span> <span class="main">∪</span> set <span class="free">ui</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> minimal_unsat_core_tabl_atomsD<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> unsat<span class="main">]</span> preprocess_unsat<span class="main">[</span><span class="operator">OF</span> prep<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_ns <span class="free">I</span> <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> minimal_unsat_core_ns_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI allI 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 index <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">J</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"distinct_indices_ns <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">⊂</span> <span class="free">I</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> preprocess_distinct<span class="main">[</span><span class="operator">OF</span> prep<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct_indices_atoms <span class="main">(</span>set <span class="free">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">⊂</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> minimal_unsat_core_tabl_atomsD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> unsat this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> model<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> i_satisfies_atom_set'_stronger<span class="main">[</span><span class="operator">OF</span> model<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> model'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> Mapping.Mapping <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> Some <span class="main">(</span><span class="skolem">v</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">w</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> w_def map2fun_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> model model' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">w</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">w</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> i_preprocess_sat<span class="main">[</span><span class="operator">OF</span> prep _ this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">J</span> <span class="main">⊂</span> <span class="free">I</span>›</span></span> inter
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="main">⟨</span><span class="free">trans_v</span> <span class="skolem">w</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Solve_exec_ns' <span class="main">&lt;</span> Solve_exec_ns <span class="quoted">solve_exec_ns</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cs</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">trans_v</span></span> <span class="skolem"><span class="skolem">ui</span></span> <span class="keyword2"><span class="keyword">where</span></span> prep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="skolem">cs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">as</span><span class="main">,</span><span class="skolem">trans_v</span><span class="main">,</span><span class="skolem">ui</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="skolem">cs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> preprocess_tableau_normalized<span class="main">[</span><span class="operator">OF</span> prep<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> preprocess_index<span class="main">[</span><span class="operator">OF</span> prep<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> index<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="skolem">as</span> <span class="main">∪</span> set <span class="skolem">ui</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="skolem">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> solve <span class="main">=</span> solve_exec_ns_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">cs</span></span><span class="main">,</span> <span class="operator">unfolded</span> prep split<span class="main">]</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"solve_exec_ns <span class="skolem">cs</span> <span class="main">=</span> Sat <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> solve<span class="main">]</span> t assert_all_sat<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span> preprocess_sat<span class="main">[</span><span class="operator">OF</span> prep<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">⟨</span><span class="skolem">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> flat <span class="main">(</span>set <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span>
    <span class="keyword3"><span class="command">assume</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"solve_exec_ns <span class="skolem">cs</span> <span class="main">=</span> Unsat <span class="skolem">I</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_ns <span class="main">(</span>set <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">cs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ui</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">i</span> <span class="skolem">uis</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> res<span class="main">[</span><span class="operator">unfolded</span> solve<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> preprocess_unsat_index<span class="main">[</span><span class="operator">OF</span> prep<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> I Cons index <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> solve Nil<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> assert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assert_all</span> <span class="skolem">t</span> <span class="skolem">as</span> <span class="main">=</span> Unsat <span class="skolem">I</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> assert_all_unsat<span class="main">[</span><span class="operator">OF</span> t assert<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_tabl_atoms <span class="main">(</span>set <span class="skolem">I</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">(</span>set <span class="skolem">as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> preprocess_minimal_unsat_core<span class="main">[</span><span class="operator">OF</span> prep this<span class="main">]</span> Nil
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_ns <span class="main">(</span>set <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Incrementally Asserting Atoms›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">assert_all</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be implemented by
iteratively asserting one by one atom from the given list of atoms.
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> bounds <span class="main">=</span> <span class="quoted"><span class="quoted">"var <span class="main">⇀</span> <span class="tfree">'a</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Asserted atoms will be stored in a form of \emph{bounds} for a
given variable. Bounds are of the form <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l<span class="hidden">⇩</span><sub>i</sub> ≤ x<span class="hidden">⇩</span><sub>i</sub> ≤ u<span class="hidden">⇩</span><sub>i</sub>›</span></span></span></span>, where
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l<span class="hidden">⇩</span><sub>i</sub>›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u<span class="hidden">⇩</span><sub>i</sub>›</span></span></span></span> and are either scalars or $\pm
\infty$. Each time a new atom is asserted, a bound for the
corresponding variable is updated (checking for conflict with the
previous bounds). Since bounds for a variable can be either finite or
$\pm \infty$, they are represented by (partial) maps from variables to
values (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a bounds = var ⇀ 'a›</span></span></span></span>). Upper and lower bounds are
represented separately. Infinite bounds map to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">None</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and this
is reflected in the semantics:

\begin{small}
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c ≥<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub> b ⟷ case b of None ⇒ False | Some b' ⇒ c ≥ b'›</span></span></span></span>

<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c ≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub> b ⟷ case b of None ⇒ True | Some b' ⇒ c ≤ b'›</span></span></span></span>
\end{small}

\noindent Strict comparisons, and comparisons with lower bounds are performed similarly.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">le</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">le</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">geub</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">b'</span> <span class="main">⇒</span> le <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="bound">b'</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gtub</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊳<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">⊳<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">b'</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="bound">b'</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">leub</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊴<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">⊴<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">b'</span> <span class="main">⇒</span> le <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">b'</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ltub</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊲<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">⊲<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">b'</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">b'</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lelb</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊴<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">⊴<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">b'</span> <span class="main">⇒</span> le <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">b'</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ltlb</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">b'</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">b'</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gelb</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">b'</span> <span class="main">⇒</span> le <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="bound">b'</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gtlb</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊳<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">⊳<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">b'</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">lt</span></span></span> <span class="bound">b'</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ge_ubound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≥<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free">≥<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&lt;)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gt_ubound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="keyword1">⊳<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&lt;)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">le_ubound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="keyword1">⊴<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&lt;)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lt_ubound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&lt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free">&lt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&lt;)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">le_lbound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≤<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free">≤<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="keyword1">⊴<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&lt;)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lt_lbound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&lt;)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ge_lbound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&lt;)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gt_lbound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="keyword1">⊳<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&lt;)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>


<span class="keyword1"><span class="command">lemmas</span></span> bound_compare'_defs <span class="main">=</span>
  geub_def gtub_def leub_def ltub_def
  gelb_def gtlb_def lelb_def ltlb_def

<span class="keyword1"><span class="command">lemmas</span></span> bound_compare''_defs <span class="main">=</span>
  ge_ubound_def gt_ubound_def le_ubound_def lt_ubound_def
  le_lbound_def lt_lbound_def ge_lbound_def gt_lbound_def

<span class="keyword1"><span class="command">lemmas</span></span> bound_compare_defs <span class="main">=</span> bound_compare'_defs bound_compare''_defs


<span class="keyword1"><span class="command">lemma</span></span> opposite_dir <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">⊴<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&gt;)</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&lt;)</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">⊴<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&gt;)</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&lt;)</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&gt;)</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="keyword1">⊴<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&lt;)</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&gt;)</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="keyword1">⊴<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&lt;)</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&gt;)</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="keyword1">⊳<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&lt;)</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">⊲<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&gt;)</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="keyword1">⊳<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&lt;)</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">⊳<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&gt;)</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&lt;)</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">⊳<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&gt;)</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&lt;)</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare'_defs<span class="main">)</span>


<span class="comment1">(* Auxiliary lemmas about bound comparison *)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">c</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> None "</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">c</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> neg_bounds_compare<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bounds_compare_contradictory <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">;</span> <span class="free">c</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">;</span> <span class="free">c</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">;</span> <span class="free">c</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">;</span> <span class="free">c</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">;</span> <span class="free">c</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">;</span> <span class="free">c</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">;</span> <span class="free">c</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">;</span> <span class="free">c</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compare_strict_nonstrict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span></span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">c</span><span class="main">;</span> <span class="free">c</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">c</span><span class="main">;</span> <span class="free">c</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">c</span><span class="main">;</span> <span class="free">c</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">≥</span> <span class="free">c</span><span class="main">;</span> <span class="free">c</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="free">c</span><span class="main">;</span> <span class="free">c</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">≥</span> <span class="free">c</span><span class="main">;</span> <span class="free">c</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span></span></span></span></span></span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bounds_lg <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">c</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">;</span> <span class="free">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">c</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">c</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">;</span> <span class="free">x</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">c</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">c</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">;</span> <span class="free">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">c</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">;</span> <span class="free">x</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="free">c</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">c</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">;</span> <span class="free">x</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="free">c</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">c</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">;</span> <span class="free">x</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≥</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span></span></span></span></span></span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bounds_compare_Some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> Some <span class="free">c</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> Some <span class="free">c</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≥</span> <span class="free">c</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> Some <span class="free">c</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> Some <span class="free">c</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="free">c</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> Some <span class="free">c</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≥</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> Some <span class="free">c</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> Some <span class="free">c</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> Some <span class="free">c</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">in_bounds</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">in_bounds</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lb</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ub</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free"><span class="bound"><span class="entity">lb</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free"><span class="bound"><span class="entity">ub</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">satisfies_bounds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder valuation <span class="main">⇒</span> <span class="tfree">'a</span> bounds <span class="main">×</span> <span class="tfree">'a</span> bounds <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> in_bounds <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> satisfies_bounds.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounds_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span><span class="free">lb</span><span class="main">,</span> <span class="free">ub</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">v</span> <span class="bound">x</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">lb</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">v</span> <span class="bound">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">ub</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_bounds.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_in_bounds<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>in_bounds <span class="free">x</span> <span class="free">v</span> <span class="main">(</span><span class="free">lb</span><span class="main">,</span> <span class="free">ub</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span> <span class="free">x</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">lb</span> <span class="free">x</span> <span class="main">∨</span> <span class="free">v</span> <span class="free">x</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">ub</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bounds_compare_contradictory<span class="main">(</span>7<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> bounds_compare_contradictory<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> neg_bounds_compare<span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">lb</span> <span class="free">x</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> neg_bounds_compare<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ub</span> <span class="free">x</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">atoms_equiv_bounds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder atom set <span class="main">⇒</span> <span class="tfree">'a</span> bounds <span class="main">×</span> <span class="tfree">'a</span> bounds <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≐</span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main"><span class="free">≐</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lb</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ub</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">⟷</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lb</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ub</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> atoms_equiv_bounds.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> atoms_equiv_bounds_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">≐</span> <span class="main">(</span><span class="free">lb</span><span class="main">,</span> <span class="free">ub</span><span class="main">)</span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span> <span class="main">⟷</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span><span class="free">lb</span><span class="main">,</span> <span class="free">ub</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atoms_equiv_bounds.simps<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A valuation satisfies bounds iff the value of each variable
respects both its lower and upper bound, i.e, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>
satisfies_bounds_iff<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Asserted atoms are precisely encoded
by the current bounds in a state (denoted by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>≐›</span></span></span></span>) if every
valuation satisfies them iff it satisfies the bounds, i.e.,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> atoms_equiv_bounds_simps<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">,</span></span> <span class="operator"><span class="operator">iff</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The procedure also keeps track of a valuation that is a
candidate solution. Whenever a new atom is asserted, it is checked
whether the valuation is still satisfying. If not, the procedure tries
to fix that by changing it and changing the tableau if necessary (but
so that it remains equivalent to the initial tableau).›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Therefore, the state of the procedure stores the tableau
(denoted by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝒯›</span></span></span></span>), lower and upper bounds (denoted by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℬ<span class="hidden">⇩</span><sub>l</sub>›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℬ<span class="hidden">⇩</span><sub>u</sub>›</span></span></span></span>, and ordered pair of lower and upper bounds
denoted by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℬ›</span></span></span></span>), candidate solution (denoted by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝒱›</span></span></span></span>)
and a flag (denoted by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝒰›</span></span></span></span>) indicating if unsatisfiability has
been detected so far:›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Since we also need to now about the indices of atoms, actually,
  the bounds are also indexed, and in addition to the flag for unsatisfiability,
  we also store an optional unsat core.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'i</span> bound_index <span class="main">=</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> <span class="tfree">'i</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> bounds_index <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var<span class="main">,</span> <span class="main">(</span><span class="tfree">'i</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">)</span>mapping"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">=</span> State
  <span class="main">(</span><span class="free"><span class="entity">𝒯</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"tableau"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub></span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> bounds_index"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub></span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> bounds_index"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">𝒱</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> mapping"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">𝒰</span></span><span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">𝒰<span class="hidden">⇩</span><sub>c</sub></span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> list option"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">indexl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'i</span> bound_index"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℐ<span class="hidden">⇩</span><sub>l</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> the<span class="main">)</span> <span class="keyword1">o</span> look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">boundsl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'a</span> bounds"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ<span class="hidden">⇩</span><sub>l</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> map_option snd <span class="keyword1">o</span> look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">indexu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'i</span> bound_index"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℐ<span class="hidden">⇩</span><sub>u</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> the<span class="main">)</span> <span class="keyword1">o</span> look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">boundsu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'a</span> bounds"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ<span class="hidden">⇩</span><sub>u</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> map_option snd <span class="keyword1">o</span> look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">BoundsIndicesMap</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Bounds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'a</span> bounds <span class="main">×</span> <span class="tfree">'a</span> bounds"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℬ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬ</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Indices</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'i</span> bound_index <span class="main">×</span> <span class="tfree">'i</span> bound_index"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℐ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℐ</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">BoundsIndices</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> bounds <span class="main">×</span> <span class="tfree">'a</span> bounds<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'i</span> bound_index <span class="main">×</span> <span class="tfree">'i</span> bound_index<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℬℐ</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℬℐ</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="keyword1">ℐ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">satisfies_bounds_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> set <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span>lrv valuation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> bounds <span class="main">×</span> <span class="tfree">'a</span> bounds<span class="main">)</span> <span class="main">×</span>
  <span class="main">(</span><span class="tfree">'i</span> bound_index <span class="main">×</span> <span class="tfree">'i</span> bound_index<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">BL</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">BU</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">IL</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">IU</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>
     <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">c</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">BL</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">c</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">IL</span></span></span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">x</span> <span class="main">≥</span> <span class="bound">c</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">c</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">BU</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">c</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">IU</span></span></span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> satisfies_bounds_index.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">satisfies_bounds_index'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> set <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span>lrv valuation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> bounds <span class="main">×</span> <span class="tfree">'a</span> bounds<span class="main">)</span> <span class="main">×</span>
  <span class="main">(</span><span class="tfree">'i</span> bound_index <span class="main">×</span> <span class="tfree">'i</span> bound_index<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>e</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>e</sub></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">BL</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">BU</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">IL</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">IU</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>
     <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">c</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">BL</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">c</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">IL</span></span></span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">c</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">c</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">BU</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">c</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">IU</span></span></span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> satisfies_bounds_index'.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">atoms_imply_bounds_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> i_atom set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> bounds <span class="main">×</span> <span class="tfree">'a</span> bounds<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'i</span> bound_index <span class="main">×</span> <span class="tfree">'i</span> bound_index<span class="main">)</span>
  <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="free"><span class="bound"><span class="entity">bi</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">I</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free"><span class="bound"><span class="entity">bi</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> atoms_imply_bounds_index.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> i_satisfies_atom_set_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">⊆</span> <span class="free">as'</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as'</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> satisfies_atom_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> atoms_imply_bounds_index_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">⊆</span> <span class="free">as'</span> <span class="main">⟹</span> <span class="free">as</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">bi</span> <span class="main">⟹</span> <span class="free">as'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">bi</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atoms_imply_bounds_index.simps <span class="keyword1"><span class="command">using</span></span> i_satisfies_atom_set_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">satisfies_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>lrv valuation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>s</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">curr_val_satisfies_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊨</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⟨</span>𝒱 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">satisfies_state_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> set <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span>lrv valuation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬℐ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> satisfies_state_index.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">satisfies_state_index'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> set <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span>lrv valuation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="keyword1">ℬℐ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> satisfies_state_index'.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">indices_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>state <span class="main">⇒</span> <span class="tfree">'i</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">indices_state</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x</span> <span class="bound">b</span><span class="main">.</span> look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∨</span> look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹distinctness requires that for each index $i$, there is at most one variable $x$ and bound
  $b$ such that $x \leq b$ or $x \geq b$ or both are enforced.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">distinct_indices_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">distinct_indices_state</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="bound">x</span> <span class="bound">b</span> <span class="bound">x'</span> <span class="bound">b'</span><span class="main">.</span> 
    <span class="main">(</span><span class="main">(</span>look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∨</span> look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span>look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">x'</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">b'</span><span class="main">)</span> <span class="main">∨</span> look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">x'</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="bound">x</span> <span class="main">=</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> distinct_indices_stateD<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct_indices_state <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free">s</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∨</span> look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free">s</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free">s</span><span class="main">)</span> <span class="free">x'</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">b'</span><span class="main">)</span> <span class="main">∨</span> look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free">s</span><span class="main">)</span> <span class="free">x'</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">b'</span><span class="main">)</span>
    <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b'</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> distinct_indices_state_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unsat_state_core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unsat_state_core</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>set <span class="main">(</span>the <span class="main">(</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> indices_state <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span>set <span class="main">(</span>the <span class="main">(</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subsets_sat_core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subsets_sat_core</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">⊂</span> set <span class="main">(</span>the <span class="main">(</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">minimal_unsat_state_core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minimal_unsat_state_core</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>unsat_state_core <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="main">(</span>distinct_indices_state <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟶</span> subsets_sat_core <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> minimal_unsat_core_tabl_atoms_mono<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">⊆</span> <span class="free">bs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_unsat_core_tabl_atoms <span class="free">I</span> <span class="free">t</span> <span class="free">as</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_tabl_atoms <span class="free">I</span> <span class="free">t</span> <span class="free">bs</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> minimal_unsat_core_tabl_atoms_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI allI<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> min <span class="main">=</span> unsat<span class="main">[</span><span class="operator">unfolded</span> minimal_unsat_core_tabl_atoms_def<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> min <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> fst <span class="main">`</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> sub <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> fst <span class="main">`</span> <span class="free">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> min <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∄</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> i_satisfies_atom_set_mono<span class="main">[</span><span class="operator">OF</span> sub<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∄</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">J</span>
  <span class="keyword3"><span class="command">assume</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">⊂</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dist_bs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_indices_atoms <span class="free">bs</span>"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_indices_atoms <span class="free">as</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sub <span class="keyword1"><span class="command">unfolding</span></span> distinct_indices_atoms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> min dist J <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">bs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> i_satisfies_atom_set'.simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="main">(</span><span class="free">bs</span> <span class="main">∩</span> <span class="skolem">J</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">bs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> J <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">with</span></span> I <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> ib<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> sub <span class="keyword1"><span class="command">have</span></span> ib'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> dist_bs<span class="main">[</span><span class="operator">unfolded</span> distinct_indices_atoms_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> ia ib'<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"atom_var <span class="skolem">a</span> <span class="main">=</span> atom_var <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"atom_const <span class="skolem">a</span> <span class="main">=</span> atom_const <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> v<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> i_satisfies_atom_set'.simps<span class="main">]</span> i ib 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> id <span class="keyword1"><span class="command">unfolding</span></span> satisfies_atom'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> v <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> state_satisfies_index<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> satisfies_state_index.simps satisfies_bounds_index.simps
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> satisfies_state_def satisfies_bounds.simps<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="skolem">x</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="skolem">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">c</span> <span class="main">⟹</span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="skolem">c</span> <span class="main">≤</span> <span class="free">v</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bnd<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">c</span> <span class="main">⟹</span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">v</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bnd<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unsat_state_core_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"unsat_state_core <span class="free">s</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> unsat_state_core_def <span class="keyword1"><span class="command">using</span></span> state_satisfies_index <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tableau_valuated</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">∇</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">∇</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> tvars <span class="main">(</span>𝒯 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">.</span> Mapping.lookup <span class="main">(</span>𝒱 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">index_valid</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">index_valid</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">b</span> <span class="bound">i</span><span class="main">.</span>
      <span class="main">(</span>look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> Geq <span class="bound">x</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span>look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> Leq <span class="bound">x</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> index_valid_indices_state<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="free">as</span> <span class="free">s</span> <span class="main">⟹</span> indices_state <span class="free">s</span> <span class="main">⊆</span> fst <span class="main">`</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> index_valid_def indices_state_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> index_valid_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">⊆</span> <span class="free">bs</span> <span class="main">⟹</span> index_valid <span class="free">as</span> <span class="free">s</span> <span class="main">⟹</span> index_valid <span class="free">bs</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> index_valid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> index_valid_distinct_indices<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"index_valid <span class="free">as</span> <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct_indices_atoms <span class="free">as</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct_indices_state <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> distinct_indices_state_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">b</span> <span class="skolem">y</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> valid <span class="main">=</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> index_valid_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>1<span class="main">)</span> valid<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> Geq <span class="skolem">x</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> Leq <span class="skolem">x</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"atom_var <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"atom_const <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>2<span class="main">)</span> valid<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> Geq <span class="skolem">y</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> Leq <span class="skolem">y</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">a'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"atom_var <span class="skolem">a'</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"atom_const <span class="skolem">a'</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> distinct_indices_atoms_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> a<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> a'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> a a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹To be a solution of the initial problem, a valuation should
satisfy the initial tableau and list of atoms. Since tableau is
changed only by equivalency preserving transformations and asserted
atoms are encoded in the bounds, a valuation is a solution if it
satisfies both the tableau and the bounds in the final state (when all
atoms have been asserted). So, a valuation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> satisfies a state
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span> (denoted by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊨<span class="hidden">⇩</span><sub>s</sub>›</span></span></span></span>) if it satisfies the tableau and
the bounds, i.e., <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> satisfies_state_def <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Since <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝒱›</span></span></span></span> should be a candidate solution, it should satisfy the state
(unless the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝒰›</span></span></span></span> flag is raised). This is denoted by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊨ s›</span></span></span></span>
and defined by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> curr_val_satisfies_state_def<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∇
s›</span></span></span></span> will denote that all variables of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝒯 s›</span></span></span></span> are explicitly
valuated in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝒱 s›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">updateℬℐ</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">updateℬℐ</span> <span class="free"><span class="bound"><span class="entity">field_update</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">field_update</span></span></span> <span class="main">(</span>upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update</span> <span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">BIL</span></span></span> <span class="free"><span class="bound"><span class="entity">BIU</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">UC</span></span></span><span class="main">)</span> <span class="main">=</span> State <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">BIL</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="free"><span class="bound"><span class="entity">BIU</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">UC</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update</span> <span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">BIL</span></span></span> <span class="free"><span class="bound"><span class="entity">BIU</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">UC</span></span></span><span class="main">)</span> <span class="main">=</span> State <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="free"><span class="bound"><span class="entity">BIL</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">BIU</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">UC</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">𝒱_update</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒱_update</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">BIL</span></span></span> <span class="free"><span class="bound"><span class="entity">BIU</span></span></span> <span class="free"><span class="bound"><span class="entity">V_old</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">UC</span></span></span><span class="main">)</span> <span class="main">=</span> State <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">BIL</span></span></span> <span class="free"><span class="bound"><span class="entity">BIU</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">UC</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">𝒯_update</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒯_update</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">T_old</span></span></span> <span class="free"><span class="bound"><span class="entity">BIL</span></span></span> <span class="free"><span class="bound"><span class="entity">BIU</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">UC</span></span></span><span class="main">)</span> <span class="main">=</span> State <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">BIL</span></span></span> <span class="free"><span class="bound"><span class="entity">BIU</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">UC</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> update_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update <span class="free">up</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">up</span> <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update <span class="free">up</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒯 <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update <span class="free">up</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒯 <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒱 <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update <span class="free">up</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒱 <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update <span class="free">up</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒰 <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update <span class="free">up</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update <span class="free">up</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">up</span> <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update <span class="free">up</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒯 <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update <span class="free">up</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒯 <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒱 <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update <span class="free">up</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒱 <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update <span class="free">up</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒰 <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update <span class="free">up</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒱 <span class="main">(</span>𝒱_update <span class="free">V</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">V</span>"</span></span>
  <span class="quoted"><span class="quoted">"ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="main">(</span>𝒱_update <span class="free">V</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="main">(</span>𝒱_update <span class="free">V</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒯 <span class="main">(</span>𝒱_update <span class="free">V</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒯 <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>𝒱_update <span class="free">V</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒰 <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>𝒱_update <span class="free">V</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒯 <span class="main">(</span>𝒯_update <span class="free">T</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="main">(</span>𝒯_update <span class="free">T</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="main">(</span>𝒯_update <span class="free">T</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒱 <span class="main">(</span>𝒯_update <span class="free">T</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒱 <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>𝒯_update <span class="free">T</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒰 <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>𝒯_update <span class="free">T</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span>
  ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">set_unsat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_unsat</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">BIL</span></span></span> <span class="free"><span class="bound"><span class="entity">BIU</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">UC</span></span></span><span class="main">)</span> <span class="main">=</span> State <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">BIL</span></span></span> <span class="free"><span class="bound"><span class="entity">BIU</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> True <span class="main">(</span>Some <span class="main">(</span>remdups <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_unsat_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="main">(</span>set_unsat <span class="free">I</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="main">(</span>set_unsat <span class="free">I</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒯 <span class="main">(</span>set_unsat <span class="free">I</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒯 <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒱 <span class="main">(</span>set_unsat <span class="free">I</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒱 <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>set_unsat <span class="free">I</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> True"</span></span>
  <span class="quoted"><span class="quoted">"𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>set_unsat <span class="free">I</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>remdups <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction <span class="main">=</span> Direction
  <span class="main">(</span><span class="free"><span class="entity">lt</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">LBI</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> bounds_index"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">UBI</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> bounds_index"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">LB</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'a</span> bounds"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">UB</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'a</span> bounds"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">LI</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'i</span> bound_index"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">UI</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'i</span> bound_index"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">UBI_upd</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> bounds_index <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> bounds_index<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">LE</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> atom"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">GE</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> atom"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">le_rat</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> rat <span class="main">⇒</span> bool"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Positive</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Positive</span> <span class="main">≡</span> Direction <span class="main">(&lt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update Leq Geq <span class="main">(≤)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Negative</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Negative</span> <span class="main">≡</span> Direction <span class="main">(&gt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update Geq Leq <span class="main">(≥)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Assuming that the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝒰›</span></span></span></span> flag and the current valuation
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝒱›</span></span></span></span> in the final state determine the solution of a problem, the
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_all›</span></span></span></span> function can be reduced to the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_all_state›</span></span></span></span>
function that operates on the states:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span>[display] <span class="raw_text"><span class="raw_text">"assert_all t as ≡ let s = assert_all_state t as in
   if (𝒰 s) then (False, None) else (True, Some (𝒱 s))"</span></span> <span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Specification for the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_all_state›</span></span></span></span> can be directly
obtained from the specification of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_all›</span></span></span></span>, and it describes
the connection between the valuation in the final state and the
initial tableau and atoms. However, we will make an additional
refinement step and give stronger assumptions about the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_all_state›</span></span></span></span> function that describes the connection between
the initial tableau and atoms with the tableau and bounds in the final
state.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> AssertAllState <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">assert_all_state</span><span class="main">::</span><span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> i_atom list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="comment1">― ‹The final and the initial tableau are equivalent.›</span>
    assert_all_state_tableau_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">assert_all_state</span> <span class="free">t</span> <span class="free">as</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹If <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">𝒰</span><span class="antiquote">}</span></span> is not raised, then the valuation in the
final state satisfies its tableau and its bounds (that are, in this
case, equivalent to the set of all asserted bounds).›</span>
assert_all_state_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">assert_all_state</span> <span class="free">t</span> <span class="free">as</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="main">¬</span> 𝒰 <span class="free">s'</span> <span class="main">⟹</span> <span class="main">⊨</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

assert_all_state_sat_atoms_equiv_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">assert_all_state</span> <span class="free">t</span> <span class="free">as</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="main">¬</span> 𝒰 <span class="free">s'</span> <span class="main">⟹</span> flat <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹If <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">𝒰</span><span class="antiquote">}</span></span> is raised, then there is no valuation
   satisfying the tableau and the bounds in the final state (that are,
   in this case, equivalent to a subset of asserted atoms).›</span>
assert_all_state_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">assert_all_state</span> <span class="free">t</span> <span class="free">as</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">⟹</span> 𝒰 <span class="free">s'</span> <span class="main">⟹</span> minimal_unsat_state_core <span class="free">s'</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span>

assert_all_state_unsat_atoms_equiv_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">assert_all_state</span> <span class="free">t</span> <span class="free">as</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">⟹</span> 𝒰 <span class="free">s'</span> <span class="main">⟹</span> set <span class="free">as</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹The set of indices is taken from the constraints›</span>
assert_all_state_indices<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">assert_all_state</span> <span class="free">t</span> <span class="free">as</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⟹</span> indices_state <span class="free">s</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="free">as</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

assert_all_index_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">assert_all_state</span> <span class="free">t</span> <span class="free">as</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⟹</span> index_valid <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">assert_all</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">assert_all</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">assert_all_state</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="keyword1">in</span>
     <span class="keyword1">if</span> <span class="main">(</span>𝒰 <span class="bound">s</span><span class="main">)</span> <span class="keyword1">then</span> Unsat <span class="main">(</span>the <span class="main">(</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> Sat <span class="main">(</span>𝒱 <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_all_state›</span></span></span></span> function can be implemented by first
applying the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>init›</span></span></span></span> function that creates an initial state based
on the starting tableau, and then by iteratively applying the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert›</span></span></span></span> function for each atom in the starting atoms list.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\begin{small}
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_loop as s ≡ foldl (λ s' a. if (𝒰 s') then s' else assert a s') s as›</span></span></span></span>

  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_all_state t as ≡ assert_loop ats (init t)›</span></span></span></span>
\end{small}
›</span></span>


<span class="keyword1"><span class="command">locale</span></span> Init' <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> init'_tableau_normalized<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> init'_tableau_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">=</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> init'_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">¬</span> 𝒰 <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> init'_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> 𝒰 <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟶</span> minimal_unsat_state_core <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> init'_atoms_equiv_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">{}</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> init'_atoms_imply_bounds_index<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">{}</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Specification for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>init›</span></span></span></span> can be obtained from the
specification of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>asser_all_state›</span></span></span></span> since all its assumptions
must also hold for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>init›</span></span></span></span> (when the list of atoms is
empty). Also, since <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>init›</span></span></span></span> is the first step in the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_all_state›</span></span></span></span> implementation, the precondition for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>init›</span></span></span></span>
the same as for the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_all_state›</span></span></span></span>. However,
unsatisfiability is never going to be detected during initialization
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">𝒰</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> flag is never going to be raised. Also, the tableau in
the initial state can just be initialized with the starting
tableau. The condition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">{}</span></span> <span class="main"><span class="main">≐</span></span> <span class="keyword1"><span class="keyword1">ℬ</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">init</span></span> <span class="free"><span class="free">t</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is equivalent to
asking that initial bounds are empty. Therefore, specification for
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>init›</span></span></span></span> can be refined to:›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Init <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span><span class="main">::</span><span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="comment1">― ‹Tableau in the initial state for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">t</span><span class="antiquote">}</span></span> is <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">t</span><span class="antiquote">}</span></span>:›</span> init_tableau_id<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒯 <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹Since unsatisfiability is not detected, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">𝒰</span><span class="antiquote">}</span></span>
     flag must not be set:›</span> init_unsat_flag<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹The current valuation must satisfy the tableau:›</span> init_satisfies_tableau<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹In an inital state no atoms are yet asserted so the bounds
     must be empty:›</span>
init_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Mapping.empty"</span></span>   <span class="quoted"><span class="quoted">"ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Mapping.empty"</span></span>  <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹All tableau vars are valuated:›</span> init_tableau_valuated<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">lemma</span></span> init_satisfies_bounds<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> init_bounds
  <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds.simps in_bounds.simps bound_compare_defs
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_satisfies<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊨</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> init_satisfies_tableau init_satisfies_bounds init_tableau_id
  <span class="keyword1"><span class="command">unfolding</span></span> curr_val_satisfies_state_def satisfies_state_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> init_atoms_equiv_bounds<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> init_bounds
  <span class="keyword1"><span class="command">unfolding</span></span> atoms_equiv_bounds.simps satisfies_bounds.simps in_bounds.simps satisfies_atom_set_def
  <span class="keyword1"><span class="command">unfolding</span></span> bound_compare_defs
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_atoms_imply_bounds_index<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> init_bounds
  <span class="keyword1"><span class="command">unfolding</span></span> atoms_imply_bounds_index.simps satisfies_bounds_index.simps in_bounds.simps
    i_satisfies_atom_set.simps satisfies_atom_set_def
  <span class="keyword1"><span class="command">unfolding</span></span> bound_compare_defs
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> init_tableau_normalized<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> init_tableau_id
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> init_index_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="free">as</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> init_bounds <span class="keyword1"><span class="command">unfolding</span></span> index_valid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> init_indices<span class="main">:</span> <span class="quoted"><span class="quoted">"indices_state <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> indices_state_def init_bounds <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">sublocale</span></span> Init <span class="main">&lt;</span> Init' <span class="quoted"><span class="free">init</span></span>
  <span class="keyword1"><span class="command">using</span></span> init_tableau_id init_satisfies init_unsat_flag init_atoms_equiv_bounds init_atoms_imply_bounds_index
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>



<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">vars_list</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vars_list</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> remdups <span class="main">(</span>map lhs <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">@</span> <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span>Abstract_Linear_Poly.vars_list <span class="main">∘</span> rhs<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"tvars <span class="free">t</span> <span class="main">=</span> set <span class="main">(</span>vars_list <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_vars_list lvars_def rvars_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\smallskip The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert›</span></span></span></span> function asserts a single
atom. Since the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>init›</span></span></span></span> function does not raise the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝒰›</span></span></span></span>
flag, from the definition of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_loop›</span></span></span></span>, it is clear that the
flag is not raised when the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert›</span></span></span></span> function is
called. Moreover, the assumptions about the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_all_state›</span></span></span></span>
imply that the loop invariant must be that if the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝒰›</span></span></span></span> flag is
not raised, then the current valuation must satisfy the state (i.e.,
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊨ s›</span></span></span></span>). The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert›</span></span></span></span> function will be more easily
implemented if it is always applied to a state with a normalized and
valuated tableau, so we make this another loop invariant. Therefore,
the precondition for the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert a s›</span></span></span></span> function call is that
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>¬ 𝒰 s›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊨ s›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>△ (𝒯 s)›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∇ s›</span></span></span></span>
hold. The specification for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert›</span></span></span></span> directly follows from the
specification of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_all_state›</span></span></span></span> (except that it is
additionally required that bounds reflect asserted atoms also when
unsatisfiability is detected, and that it is required that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert›</span></span></span></span> keeps the tableau normalized and valuated).›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Assert <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">assert</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> i_atom <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="comment1">― ‹Tableau remains equivalent to the previous one and normalized and valuated.›</span>
    assert_tableau<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">assert</span> <span class="free">a</span> <span class="free">s</span> <span class="keyword1">in</span>
     <span class="main">(</span><span class="main">(</span><span class="free">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">∇</span> <span class="bound">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹If the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">𝒰</span><span class="antiquote">}</span></span> flag is not raised, then the current
   valuation is updated so that it satisfies the current tableau and
   the current bounds.›</span>
assert_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">¬</span> 𝒰 <span class="main">(</span><span class="free">assert</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">assert</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹The set of asserted atoms remains equivalent to the bounds
    in the state.›</span>
assert_atoms_equiv_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> flat <span class="free">ats</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="free">s</span> <span class="main">⟹</span> flat <span class="main">(</span><span class="free">ats</span> <span class="main">∪</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="main">(</span><span class="free">assert</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹There is a subset of asserted atoms which remains index-equivalent to the bounds
    in the state.›</span>
assert_atoms_imply_bounds_index<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ats</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="free">s</span> <span class="main">⟹</span>
  insert <span class="free">a</span> <span class="free">ats</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="main">(</span><span class="free">assert</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹If the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">𝒰</span><span class="antiquote">}</span></span> flag is raised, then there is no valuation
   that satisfies both the current tableau and the current bounds.›</span>
assert_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> index_valid <span class="free">ats</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> 𝒰 <span class="main">(</span><span class="free">assert</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span>  minimal_unsat_state_core <span class="main">(</span><span class="free">assert</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

assert_index_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> index_valid <span class="free">ats</span> <span class="free">s</span> <span class="main">⟹</span> index_valid <span class="main">(</span>insert <span class="free">a</span> <span class="free">ats</span><span class="main">)</span> <span class="main">(</span><span class="free">assert</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> assert_tableau_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span><span class="free">assert</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assert_tableau
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> assert_tableau_normalized<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">assert</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assert_tableau
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> assert_tableau_valuated<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∇</span> <span class="main">(</span><span class="free">assert</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assert_tableau
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="command">locale</span></span> AssertAllState' <span class="main">=</span> Init <span class="quoted"><span class="free">init</span></span> <span class="main">+</span> Assert <span class="quoted"><span class="free">assert</span></span> <span class="keyword2"><span class="keyword">for</span></span>
  <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">assert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">assert_loop</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">assert_loop</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> foldl <span class="main">(</span><span class="main">λ</span> <span class="bound">s'</span> <span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span>𝒰 <span class="bound">s'</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">s'</span> <span class="keyword1">else</span> <span class="free">assert</span> <span class="bound">a</span> <span class="bound">s'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">assert_all_state</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">assert_all_state</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">≡</span> assert_loop <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="free">init</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> AssertAllState'_precond<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span>assert_all_state <span class="free">t</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∇</span> <span class="main">(</span>assert_all_state <span class="free">t</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> 𝒰 <span class="main">(</span>assert_all_state <span class="free">t</span> <span class="free">as</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">⊨</span> <span class="main">(</span>assert_all_state <span class="free">t</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> assert_all_state_def assert_loop_def
  <span class="keyword1"><span class="command">using</span></span> init_satisfies init_tableau_normalized init_index_valid
  <span class="keyword1"><span class="command">using</span></span> assert_sat assert_tableau_normalized init_tableau_valuated assert_tableau_valuated
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> AssertAllState'Induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">{}</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">as</span> <span class="bound">bs</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">as</span> <span class="main">⊆</span> <span class="bound">bs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">as</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">bs</span> <span class="bound">t</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="bound">as</span><span class="main">.</span> <span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="bound">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="bound">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="bound">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="bound">s</span><span class="main">;</span> <span class="free">P</span> <span class="bound">as</span> <span class="bound">s</span><span class="main">;</span> index_valid <span class="bound">as</span> <span class="bound">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>insert <span class="bound">a</span> <span class="bound">as</span><span class="main">)</span> <span class="main">(</span><span class="free">assert</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="main">(</span>assert_all_state <span class="free">t</span> <span class="free">as</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="main">(</span>assert_all_state <span class="free">t</span> <span class="free">as</span><span class="main">)</span> <span class="main">∧</span> index_valid <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="main">(</span>assert_all_state <span class="free">t</span> <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> assert_all_state_def assert_loop_def
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> init_index_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">as'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s'</span> <span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> 𝒰 <span class="bound">s'</span> <span class="keyword1">then</span> <span class="bound">s'</span> <span class="keyword1">else</span> <span class="free">assert</span> <span class="bound">a</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"foldl <span class="var">?f</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span> <span class="skolem">as'</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"𝒰 <span class="var">?s</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> snoc index_valid_mono<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>assert_all_state <span class="free">t</span> <span class="skolem">as'</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> index<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="main">(</span>set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>assert_all_state <span class="free">t</span> <span class="skolem">as'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> snoc assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="skolem">as'</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as'</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>assert_all_state <span class="free">t</span> <span class="skolem">as'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> True P index
        <span class="keyword1"><span class="command">unfolding</span></span> assert_all_state_def assert_loop_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> AssertAllState'_precond assert_index_valid
        <span class="keyword1"><span class="command">unfolding</span></span> assert_all_state_def assert_loop_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> AssertAllState_index_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> index_valid <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="main">(</span>assert_all_state <span class="free">t</span> <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> AssertAllState'Induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assert_index_valid init_index_valid index_valid_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> AssertAllState'_sat_atoms_equiv_bounds<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">¬</span> 𝒰 <span class="main">(</span>assert_all_state <span class="free">t</span> <span class="free">as</span><span class="main">)</span> <span class="main">⟹</span> flat <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="main">(</span>assert_all_state <span class="free">t</span> <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> AssertAllState'_precond
  <span class="keyword1"><span class="command">using</span></span> init_atoms_equiv_bounds assert_atoms_equiv_bounds
  <span class="keyword1"><span class="command">unfolding</span></span> assert_all_state_def assert_loop_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> AssertAllState'_unsat_atoms_implies_bounds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">as</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="main">(</span>assert_all_state <span class="free">t</span> <span class="free">as</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms init_atoms_imply_bounds_index
    <span class="keyword1"><span class="command">unfolding</span></span> assert_all_state_def assert_loop_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">as'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"assert_all_state <span class="free">t</span> <span class="skolem">as'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"𝒰 <span class="var">?s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc atoms_imply_bounds_index_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="skolem">as'</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> assert_all_state_def assert_loop_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"assert_all_state <span class="free">t</span> <span class="main">(</span><span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">assert</span> <span class="skolem">a</span> <span class="var">?s</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> assert_all_state_def assert_loop_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> as'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">as'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> AssertAllState'_precond<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="skolem">as'</span></span><span class="main">]</span> assms False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊨</span> <span class="var">?s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> assert_atoms_imply_bounds_index<span class="main">[</span><span class="operator">OF</span> False this as'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Under these assumptions, it can easily be shown (mainly by
induction) that the previously shown implementation of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_all_state›</span></span></span></span> satisfies its specification.›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> AssertAllState' <span class="main">&lt;</span> AssertAllState <span class="quoted">assert_all_state</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> valuation"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span> <span class="skolem">as</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"assert_all_state <span class="skolem">t</span> <span class="skolem">as</span> <span class="main">=</span> <span class="skolem">s'</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> idsym <span class="main">=</span> id<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> idsym
    <span class="keyword1"><span class="command">using</span></span>  init_tableau_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> assert_tableau_equiv<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> AssertAllState'Induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * <span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s'</span> <span class="main">⟹</span> <span class="main">⊨</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> idsym
    <span class="keyword1"><span class="command">using</span></span> AssertAllState'_precond <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * <span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s'</span> <span class="main">⟹</span> flat <span class="main">(</span>set <span class="skolem">as</span><span class="main">)</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> idsym
    <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> AssertAllState'_sat_atoms_equiv_bounds<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝒰 <span class="skolem">s'</span> <span class="main">⟹</span> set <span class="skolem">as</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> idsym
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> AssertAllState'_unsat_atoms_implies_bounds<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝒰 <span class="skolem">s'</span> <span class="main">⟹</span> minimal_unsat_state_core <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> init_unsat_flag assert_unsat assert_index_valid <span class="keyword1"><span class="command">unfolding</span></span> idsym
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> AssertAllState'Induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * <span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"indices_state <span class="skolem">s'</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> idsym <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> index_valid_indices_state<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> AssertAllState'Induct<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> init_index_valid index_valid_mono assert_index_valid<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"index_valid <span class="main">(</span>set <span class="skolem">as</span><span class="main">)</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> AssertAllState_index_valid idsym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Asserting Single Atoms›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">assert</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> function is split in two phases. First,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">assert_bound</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> updates the bounds and checks only for conflicts
cheap to detect. Next, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check›</span></span></span></span> performs the full simplex
algorithm. The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert›</span></span></span></span> function can be implemented as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert a s = check (assert_bound a s)›</span></span></span></span>. Note that it is also
possible to do the first phase for several asserted atoms, and only
then to let the expensive second phase work.

\medskip Asserting an atom <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x ⨝ b›</span></span></span></span> begins with the function
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span>.  If the atom is subsumed by the current bounds,
then no changes are performed. Otherwise, bounds for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> are
changed to incorporate the atom. If the atom is inconsistent with the
previous bounds for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>, the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">𝒰</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> flag is raised. If
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> is not a lhs variable in the current tableau and if the
value for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> in the current valuation violates the new bound
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>b›</span></span></span></span>, the value for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> can be updated and set to
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>b›</span></span></span></span>, meanwhile updating the values for lhs variables of
the tableau so that it remains satisfied. Otherwise, no changes to the
current valuation are performed.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">satisfies_bounds_set</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder valuation <span class="main">⇒</span> <span class="tfree">'a</span> bounds <span class="main">×</span> <span class="tfree">'a</span> bounds <span class="main">⇒</span> var set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">satisfies_bounds_set</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lb</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ub</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> in_bounds <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lb</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ub</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> satisfies_bounds_set.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_satisfies_bounds_set"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> bounds <span class="main">×</span> <span class="tfree">'a</span> bounds <span class="main">⇒</span> var set <span class="main">⇒</span> bool"</span></span>    <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> _ <span class="keyword1">∥</span><span class="keyword3">/ </span>_"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">b</span> <span class="main">∥</span> <span class="free">S</span>"</span> <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> satisfies_bounds_set <span class="free">v</span> <span class="free">b</span> <span class="free">S</span>"</span>
<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounds_set_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span><span class="free">lb</span><span class="main">,</span> <span class="free">ub</span><span class="main">)</span> <span class="main">∥</span> <span class="free">S</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">v</span> <span class="bound">x</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">lb</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">v</span> <span class="bound">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">ub</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_bounds_set.simps<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">curr_val_satisfies_no_lhs</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⟨</span>𝒱 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">(</span>𝒯 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∥</span> <span class="main">(</span><span class="main">-</span> lvars <span class="main">(</span>𝒯 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> satisfies_satisfies_no_lhs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> curr_val_satisfies_state_def satisfies_state_def curr_val_satisfies_no_lhs_def satisfies_bounds.simps satisfies_bounds_set.simps<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bounds_consistent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">◇</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">◇</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
   <span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">x</span> <span class="main">=</span> None <span class="main">∨</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">x</span> <span class="main">=</span> None <span class="keyword1">then</span> True <span class="keyword1">else</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹So, the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span> function must ensure that the
given atom is included in the bounds, that the tableau remains
satisfied by the valuation and that all variables except the lhs variables
in the tableau are within their
bounds. To formalize this, we introduce the notation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v
⊨<span class="hidden">⇩</span><sub>b</sub> (lb, ub) ∥ S›</span></span></span></span>, and define <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>
satisfies_bounds_set_iff<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>
curr_val_satisfies_no_lhs_def<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span>
function raises the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝒰›</span></span></span></span> flag if and only if lower and upper
bounds overlap. This is formalized as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>
bounds_consistent_def<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounds_consistent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>linorder valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="free">s</span> <span class="main">⟶</span> <span class="main">◇</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds.simps in_bounds.simps bounds_consistent_def bound_compare_defs
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_consistent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊨</span> <span class="free">s</span> <span class="main">⟶</span> <span class="main">◇</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> curr_val_satisfies_state_def satisfies_state_def satisfies_bounds_consistent<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bounds_consistent_geq_lb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">◇</span> <span class="free">s</span><span class="main">;</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Some <span class="free">c</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bounds_consistent_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bounds_consistent_leq_ub<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">◇</span> <span class="free">s</span><span class="main">;</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Some <span class="free">c</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">c</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bounds_consistent_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bounds_consistent_gt_ub<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">◇</span> <span class="free">s</span><span class="main">;</span> <span class="free">c</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">c</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bounds_consistent_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span></span> <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">x</span></span>"</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bounds_consistent_lt_lb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">◇</span> <span class="free">s</span><span class="main">;</span> <span class="free">c</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">c</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bounds_consistent_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span></span> <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">x</span></span>"</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Since the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span> is the first step in the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert›</span></span></span></span> function implementation, the preconditions for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span> are the same as preconditions for the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert›</span></span></span></span>
function. The specifiction for the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span> is:›</span></span>

<span class="keyword1"><span class="command">locale</span></span> AssertBound <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">assert_bound</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> i_atom <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="comment1">― ‹The tableau remains unchanged and valuated.›</span>

assert_bound_tableau<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">⟹</span> 𝒯 <span class="free">s'</span> <span class="main">=</span> 𝒯 <span class="free">s</span> <span class="main">∧</span> <span class="main">∇</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹If the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">𝒰</span><span class="antiquote">}</span></span> flag is not set, all but the
   lhs variables in the tableau remain within their bounds,
   the new valuation satisfies the tableau, and bounds do not overlap.›</span>
assert_bound_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="main">¬</span> 𝒰 <span class="free">s'</span> <span class="main">⟹</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s'</span> <span class="main">∧</span> <span class="main">◇</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹The set of asserted atoms remains equivalent to the bounds in the state.›</span>

assert_bound_atoms_equiv_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
  flat <span class="free">ats</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="free">s</span> <span class="main">⟹</span> flat <span class="main">(</span><span class="free">ats</span> <span class="main">∪</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

assert_bound_atoms_imply_bounds_index<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">ats</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="free">s</span> <span class="main">⟹</span> insert <span class="free">a</span> <span class="free">ats</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">𝒰</span><span class="antiquote">}</span></span> flag is raised, only if the bounds became inconsistent:›</span>

assert_bound_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> index_valid <span class="free">as</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">⟹</span> 𝒰 <span class="free">s'</span> <span class="main">⟹</span> minimal_unsat_state_core <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

assert_bound_index_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> index_valid <span class="free">as</span> <span class="free">s</span> <span class="main">⟹</span> index_valid <span class="main">(</span>insert <span class="free">a</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> assert_bound_tableau_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> 𝒯 <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒯 <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assert_bound_tableau <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> assert_bound_tableau_valuated<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∇</span> <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assert_bound_tableau <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> AssertBoundNoLhs <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">assert_bound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> i_atom <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assert_bound_nolhs_tableau_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="main">◇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> 𝒯 <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒯 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assert_bound_nolhs_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="main">◇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">¬</span> 𝒰 <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">◇</span> <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assert_bound_nolhs_atoms_equiv_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="main">◇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
    flat <span class="free">ats</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="free">s</span> <span class="main">⟹</span> flat <span class="main">(</span><span class="free">ats</span> <span class="main">∪</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assert_bound_nolhs_atoms_imply_bounds_index<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="main">◇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">ats</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="free">s</span> <span class="main">⟹</span> insert <span class="free">a</span> <span class="free">ats</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assert_bound_nolhs_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="main">◇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
    index_valid <span class="free">as</span> <span class="free">s</span> <span class="main">⟹</span> 𝒰 <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> minimal_unsat_state_core <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assert_bound_nolhs_tableau_valuated<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="main">◇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
   <span class="main">∇</span> <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assert_bound_nolhs_index_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="main">◇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
    index_valid <span class="free">as</span> <span class="free">s</span> <span class="main">⟹</span> index_valid <span class="main">(</span>insert <span class="free">a</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> AssertBoundNoLhs <span class="main">&lt;</span> AssertBound 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    <span class="main">(</span><span class="main">(</span><span class="operator">metis</span> satisfies_satisfies_no_lhs satisfies_consistent
        assert_bound_nolhs_tableau_id assert_bound_nolhs_sat assert_bound_nolhs_atoms_equiv_bounds
        assert_bound_nolhs_index_valid assert_bound_nolhs_atoms_imply_bounds_index
        assert_bound_nolhs_unsat assert_bound_nolhs_tableau_valuated<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> 


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The second phase of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert›</span></span></span></span>, the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check›</span></span></span></span> function,
is the heart of the Simplex algorithm. It is always called after
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span>, but in two different situations. In the first
case <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span> raised the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝒰›</span></span></span></span> flag and then
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check›</span></span></span></span> should retain the flag and should not perform any changes.
In the second case <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span> did not raise the
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝒰›</span></span></span></span> flag, so <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub> s›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>◇ s›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>△ (𝒯
s)›</span></span></span></span>, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∇ s›</span></span></span></span> hold.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Check <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">check</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="comment1">― ‹If <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">check</span><span class="antiquote">}</span></span> is called from an inconsistent state, the state is unchanged.›</span>

check_unsat_id<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒰 <span class="free">s</span> <span class="main">⟹</span> <span class="free">check</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹The tableau remains equivalent to the previous one, normalized and valuated.›</span>

check_tableau<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span><span class="main">;</span> <span class="main">◇</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
   <span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">check</span> <span class="free">s</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="free">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">∇</span> <span class="bound">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹The bounds remain unchanged.›</span>

check_bounds_id<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span><span class="main">;</span> <span class="main">◇</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">check</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹If <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">𝒰</span><span class="antiquote">}</span></span> flag is not raised, the current valuation
   <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"𝒱"</span><span class="antiquote">}</span></span> satisfies both the tableau and the bounds and if it is
   raised, there is no valuation that satisfies them.›</span>

check_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span><span class="main">;</span> <span class="main">◇</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">¬</span> 𝒰 <span class="main">(</span><span class="free">check</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">check</span> <span class="free">s</span><span class="main">)</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span>


check_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span><span class="main">;</span> <span class="main">◇</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> 𝒰 <span class="main">(</span><span class="free">check</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> minimal_unsat_state_core <span class="main">(</span><span class="free">check</span> <span class="free">s</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> check_tableau_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span><span class="main">;</span> <span class="main">◇</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
                      <span class="main">(</span><span class="free">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span><span class="free">check</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> check_tableau
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> check_tableau_index_valid<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">" <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"index_valid <span class="free">as</span> <span class="main">(</span><span class="free">check</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> index_valid <span class="free">as</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> index_valid_def <span class="keyword1"><span class="command">using</span></span> check_bounds_id<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> check_tableau_normalized<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span><span class="main">;</span> <span class="main">◇</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">check</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> check_tableau
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> check_tableau_valuated<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span><span class="main">;</span> <span class="main">◇</span> <span class="free">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∇</span> <span class="main">(</span><span class="free">check</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> check_tableau
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> check_indices_state<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="free">s</span> <span class="main">⟹</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="free">s</span> <span class="main">⟹</span> <span class="main">◇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="free">s</span> <span class="main">⟹</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="free">s</span> <span class="main">⟹</span> <span class="main">∇</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"indices_state <span class="main">(</span><span class="free">check</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> indices_state <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> check_bounds_id<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span> check_unsat_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> indices_state_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"𝒰 <span class="free">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> check_distinct_indices_state<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="free">s</span> <span class="main">⟹</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="free">s</span> <span class="main">⟹</span> <span class="main">◇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="free">s</span> <span class="main">⟹</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="free">s</span> <span class="main">⟹</span> <span class="main">∇</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct_indices_state <span class="main">(</span><span class="free">check</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> distinct_indices_state <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> check_bounds_id<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span> check_unsat_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> distinct_indices_state_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"𝒰 <span class="free">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> Assert' <span class="main">=</span> AssertBound <span class="quoted"><span class="free">assert_bound</span></span> <span class="main">+</span> Check <span class="quoted"><span class="free">check</span></span> <span class="keyword2"><span class="keyword">for</span></span>
  <span class="free">assert_bound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> i_atom <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">check</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">assert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">assert</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free">check</span> <span class="main">(</span><span class="free">assert_bound</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Assert'Precond<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span>  <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">◇</span> <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="main">(</span><span class="free">assert_bound</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">using</span></span> assert_bound_tableau_id assert_bound_sat assert_bound_tableau_valuated
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_bounds_consistent Let_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">sublocale</span></span> Assert' <span class="main">&lt;</span> Assert <span class="quoted">assert</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">v</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> valuation"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="skolem">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊨</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span>assert <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> check_tableau_normalized<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span><span class="main">]</span> check_unsat_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span><span class="main">]</span> *
    <span class="keyword1"><span class="command">using</span></span> assert_bound_sat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> Assert'Precond<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assert_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span>assert <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> check_tableau_equiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> *
    <span class="keyword1"><span class="command">using</span></span> check_unsat_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assert_def Assert'Precond assert_bound_sat assert_bound_tableau_id<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="main">(</span>assert <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assert_bound_tableau_valuated<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> *
    <span class="keyword1"><span class="command">using</span></span> check_tableau_valuated<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> check_unsat_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span><span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Assert'Precond assert_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> assert <span class="skolem">a</span> <span class="skolem">s</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">∇</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊨</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="main">(</span>assert <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">⊨</span> <span class="main">(</span>assert <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assert_def
    <span class="keyword1"><span class="command">using</span></span> check_unsat_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> check_sat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Assert'Precond<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ats</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom set"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊨</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flat <span class="skolem">ats</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="skolem">s</span> <span class="main">⟹</span> flat <span class="main">(</span><span class="skolem">ats</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="main">(</span>assert <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assert_bound_atoms_equiv_bounds
    <span class="keyword1"><span class="command">using</span></span> check_unsat_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span><span class="main">]</span> check_bounds_id
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span><span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Assert'Precond assert_def
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ats</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊨</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>assert <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"index_valid <span class="skolem">ats</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_state_core <span class="main">(</span>assert <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span><span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> assert_def
      <span class="keyword1"><span class="command">using</span></span> * assert_bound_unsat check_tableau_equiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span><span class="main">]</span> check_bounds_id
      <span class="keyword1"><span class="command">using</span></span> check_unsat_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Assert'Precond satisfies_state_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> assert_def
      <span class="keyword1"><span class="command">using</span></span> * assert_bound_sat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> check_unsat Assert'Precond
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assert_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ats</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="skolem">ats</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊨</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">ats</span><span class="main">)</span> <span class="main">(</span><span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assert_bound_index_valid<span class="main">[</span><span class="operator">OF</span> ** *<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"index_valid <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">ats</span><span class="main">)</span> <span class="main">(</span>assert <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span><span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> assert_def check_unsat_id<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> assert_def <span class="keyword1"><span class="command">using</span></span> Assert'Precond<span class="main">[</span><span class="operator">OF</span> **<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span></span></span><span class="main">]</span> False *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> check_tableau_index_valid<span class="main"><span class="main">[</span></span><span class="operator">OF</span> False<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">ats</span> <span class="skolem">a</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊨</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ats</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assert_bound_atoms_imply_bounds_index<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="skolem">a</span> <span class="skolem">ats</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="main">(</span><span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">a</span> <span class="skolem">ats</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="main">(</span>assert <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"𝒰 <span class="var">?s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> check_unsat_id<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> as <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> assert_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> assert_bound_tableau_id<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span> *
    <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> assert_bound_tableau_valuated<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> assert_bound_sat<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span> refl False<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> check_bounds_id<span class="main">[</span><span class="operator">OF</span> False this t v<span class="main">]</span>  as
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> assert_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Under these assumptions for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check›</span></span></span></span>, it can be easily shown that the implementation of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert›</span></span></span></span> (previously given) satisfies its specification.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> AssertAllState'' <span class="main">=</span> Init <span class="quoted"><span class="free">init</span></span> <span class="main">+</span> AssertBoundNoLhs <span class="quoted"><span class="free">assert_bound</span></span> <span class="main">+</span> Check <span class="quoted"><span class="free">check</span></span> <span class="keyword2"><span class="keyword">for</span></span>
  <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">assert_bound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> i_atom <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">check</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">assert_bound_loop</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">assert_bound_loop</span> <span class="free"><span class="bound"><span class="entity">ats</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> foldl <span class="main">(</span><span class="main">λ</span> <span class="bound">s'</span> <span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span>𝒰 <span class="bound">s'</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">s'</span> <span class="keyword1">else</span> <span class="free">assert_bound</span> <span class="bound">a</span> <span class="bound">s'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ats</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">assert_all_state</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">assert_all_state</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">ats</span></span></span> <span class="main">≡</span> <span class="free">check</span> <span class="main">(</span>assert_bound_loop <span class="free"><span class="bound"><span class="entity">ats</span></span></span> <span class="main">(</span><span class="free">init</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹However, for efficiency reasons, we want to allow
implementations that delay the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check›</span></span></span></span> function call and call it
after several <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span> calls. For example:

\smallskip
\begin{small}
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> assert_bound_loop_def<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> assert_all_state_def<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{small}
\smallskip

Then, the loop consists only of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span> calls, so <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span> postcondition must imply its precondition. This is not
the case, since variables on the lhs may be out of their
bounds. Therefore, we make a refinement and specify weaker
preconditions (replace <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊨ s›</span></span></span></span>, by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub> s›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>◇ s›</span></span></span></span>) for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span>, and show that these
preconditions are still good enough to prove the correctnes of this
alternative <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_all_state›</span></span></span></span> definition.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> AssertAllState''_precond'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="free">s</span> <span class="main">⟶</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span> <span class="main">∧</span> <span class="main">◇</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> assert_bound_loop <span class="free">ats</span> <span class="free">s</span> <span class="keyword1">in</span>
         <span class="main">△</span> <span class="main">(</span>𝒯 <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">∇</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> 𝒰 <span class="bound">s'</span> <span class="main">⟶</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">◇</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">using</span></span> assert_bound_nolhs_tableau_id assert_bound_nolhs_sat assert_bound_nolhs_tableau_valuated
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ats</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assert_bound_loop_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> AssertAllState''_precond<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> assert_bound_loop <span class="free">ats</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">in</span>
         <span class="main">△</span> <span class="main">(</span>𝒯 <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">∇</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> 𝒰 <span class="bound">s'</span> <span class="main">⟶</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">◇</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">using</span></span> AssertAllState''_precond'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="free">ats</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def init_tableau_id init_unsat_flag init_satisfies satisfies_consistent
      satisfies_satisfies_no_lhs init_tableau_valuated<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> AssertAllState''Induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">{}</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">as</span> <span class="bound">bs</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">as</span> <span class="main">⊆</span> <span class="bound">bs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">as</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">bs</span> <span class="bound">t</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">a</span> <span class="bound">ats</span><span class="main">.</span> <span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="bound">s</span><span class="main">;</span>  <span class="main">⟨</span>𝒱 <span class="bound">s</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="bound">s</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="bound">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="bound">s</span><span class="main">;</span> <span class="main">◇</span> <span class="bound">s</span><span class="main">;</span> <span class="free">P</span> <span class="main">(</span>set <span class="bound">ats</span><span class="main">)</span> <span class="bound">s</span><span class="main">;</span> index_valid <span class="main">(</span>set <span class="bound">ats</span><span class="main">)</span> <span class="bound">s</span><span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>insert <span class="bound">a</span> <span class="main">(</span>set <span class="bound">ats</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">assert_bound</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>set <span class="free">ats</span><span class="main">)</span> <span class="main">(</span>assert_bound_loop <span class="free">ats</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>set <span class="free">ats</span><span class="main">)</span> <span class="main">(</span>assert_bound_loop <span class="free">ats</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> index_valid <span class="main">(</span>set <span class="free">ats</span><span class="main">)</span> <span class="main">(</span>assert_bound_loop <span class="free">ats</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ats</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> assert_bound_loop_def
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> init_index_valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">as'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"assert_bound_loop <span class="skolem">as'</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> snoc index_valid_mono<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"assert_bound_loop <span class="skolem">as'</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> index<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="main">(</span>set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>assert_bound_loop <span class="skolem">as'</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> snoc assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="skolem">as'</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as'</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>assert_bound_loop <span class="skolem">as'</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"𝒰 <span class="var">?s</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> P index
        <span class="keyword1"><span class="command">unfolding</span></span> assert_bound_loop_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> id'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">a</span> <span class="main">(</span>set <span class="skolem">as'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"assert_bound_loop <span class="main">(</span><span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span>
        <span class="free">assert_bound</span> <span class="skolem">a</span> <span class="main">(</span>assert_bound_loop <span class="skolem">as'</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">unfolding</span></span> assert_bound_loop_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> index<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="main">(</span>set <span class="skolem">as'</span><span class="main">)</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">unfolding</span></span> id' <span class="keyword1"><span class="command">using</span></span> False snoc AssertAllState''_precond<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI assert_bound_nolhs_index_valid index assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def curr_val_satisfies_no_lhs_def<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> AssertAllState''_tableau_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> 𝒯 <span class="main">(</span>assert_bound_loop <span class="free">ats</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 𝒯 <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> AssertAllState''Induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_tableau_id assert_bound_nolhs_tableau_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> AssertAllState''_sat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span>
    <span class="main">¬</span> 𝒰 <span class="main">(</span>assert_bound_loop <span class="free">ats</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>assert_bound_loop <span class="free">ats</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">◇</span> <span class="main">(</span>assert_bound_loop <span class="free">ats</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> AssertAllState''Induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_unsat_flag init_satisfies satisfies_consistent satisfies_satisfies_no_lhs assert_bound_nolhs_sat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> AssertAllState''_unsat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> 𝒰 <span class="main">(</span>assert_bound_loop <span class="free">ats</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> minimal_unsat_state_core <span class="main">(</span>assert_bound_loop <span class="free">ats</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> AssertAllState''Induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_tableau_id assert_bound_nolhs_unsat init_unsat_flag<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> AssertAllState''_sat_atoms_equiv_bounds<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">¬</span> 𝒰 <span class="main">(</span>assert_bound_loop <span class="free">ats</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> flat <span class="main">(</span>set <span class="free">ats</span><span class="main">)</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="main">(</span>assert_bound_loop <span class="free">ats</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> AssertAllState''_precond
  <span class="keyword1"><span class="command">using</span></span> assert_bound_nolhs_atoms_equiv_bounds init_atoms_equiv_bounds
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ats</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def assert_bound_loop_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> AssertAllState''_atoms_imply_bounds_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ats</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="main">(</span>assert_bound_loop <span class="free">ats</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ats</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assert_bound_loop_def
    <span class="keyword1"><span class="command">using</span></span> init_atoms_imply_bounds_index assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">ats'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"assert_bound_loop <span class="skolem">ats'</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"𝒰 <span class="var">?s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc atoms_imply_bounds_index_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="skolem">ats'</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">ats'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> assert_bound_loop_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"assert_bound_loop <span class="main">(</span><span class="skolem">ats'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">assert_bound</span> <span class="skolem">a</span> <span class="var">?s</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> assert_bound_loop_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> ats<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">ats'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> AssertAllState''_precond<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="skolem">ats'</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">unfolded</span> Let_def<span class="main">]</span> False
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="var">?s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">using</span></span> assert_bound_nolhs_atoms_imply_bounds_index<span class="main">[</span><span class="operator">OF</span> False * ats<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> AssertAllState''_index_valid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span> <span class="main">⟹</span> index_valid <span class="main">(</span>set <span class="free">ats</span><span class="main">)</span> <span class="main">(</span>assert_bound_loop <span class="free">ats</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> AssertAllState''Induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> init_index_valid index_valid_mono assert_bound_nolhs_index_valid<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> AssertAllState'' <span class="main">&lt;</span> AssertAllState <span class="quoted">assert_all_state</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> valuation"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span> <span class="skolem">ats</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"assert_all_state <span class="skolem">t</span> <span class="skolem">ats</span> <span class="main">=</span> <span class="skolem">s'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> assert_all_state <span class="skolem">t</span> <span class="skolem">ats</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"assert_bound_loop <span class="skolem">ats</span> <span class="main">(</span><span class="free">init</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assert_all_state_def s'
    <span class="keyword1"><span class="command">using</span></span> * check_tableau_equiv<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> AssertAllState''_tableau_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">ats</span></span><span class="main">]</span> init_tableau_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> AssertAllState''_sat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">ats</span></span><span class="main">]</span> check_unsat_id<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> AssertAllState''_precond<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">ats</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s'</span> <span class="main">⟹</span> <span class="main">⊨</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assert_all_state_def s'
    <span class="keyword1"><span class="command">using</span></span> * AssertAllState''_precond<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">ats</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> check_sat check_unsat_id
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝒰 <span class="skolem">s'</span> <span class="main">⟹</span> minimal_unsat_state_core <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * check_unsat check_unsat_id<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span><span class="main">]</span> check_bounds_id
    <span class="keyword1"><span class="command">using</span></span> AssertAllState''_unsat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">ats</span></span><span class="main">]</span> AssertAllState''_precond<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">ats</span></span><span class="main">]</span> s'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def satisfies_state_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s'</span> <span class="main">⟹</span> flat <span class="main">(</span>set <span class="skolem">ats</span><span class="main">)</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assert_all_state_def s'
    <span class="keyword1"><span class="command">using</span></span> * AssertAllState''_precond<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">ats</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> check_bounds_id<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span><span class="main">]</span> check_unsat_id<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> AssertAllState''_sat_atoms_equiv_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">ats</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝒰 <span class="skolem">s'</span> <span class="main">⟹</span> set <span class="skolem">ats</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assert_all_state_def s'
    <span class="keyword1"><span class="command">using</span></span> * AssertAllState''_precond<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">ats</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Let_def
    <span class="keyword1"><span class="command">using</span></span> check_bounds_id<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> AssertAllState''_atoms_imply_bounds_index<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">ats</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> check_unsat_id<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"𝒰 <span class="var">?s'</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"index_valid <span class="main">(</span>set <span class="skolem">ats</span><span class="main">)</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assert_all_state_def s'
    <span class="keyword1"><span class="command">using</span></span> * AssertAllState''_precond<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">ats</span></span><span class="main">]</span> AssertAllState''_index_valid<span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">ats</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Let_def
    <span class="keyword1"><span class="command">using</span></span> check_tableau_index_valid<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> check_unsat_id<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"𝒰 <span class="var">?s'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"indices_state <span class="skolem">s'</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="skolem">ats</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> index_valid_indices_state<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Update and Pivot›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Both <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check›</span></span></span></span> need to update
the valuation so that the tableau remains satisfied. If the value for
a variable not on the lhs of the tableau is changed, this
can be done rather easily (once the value of that variable is changed,
one should recalculate and change the values for all lhs
variables of the tableau). The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>update›</span></span></span></span> function does this, and
it is specified by:›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Update <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">update</span><span class="main">::</span><span class="quoted"><span class="quoted">"var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>lrv <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="comment1">― ‹Tableau, bounds, and the unsatisfiability flag are preserved.›</span>

update_id<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
     <span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">update</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span> <span class="keyword1">in</span> 𝒯 <span class="bound">s'</span> <span class="main">=</span> 𝒯 <span class="free">s</span> <span class="main">∧</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">s'</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span> <span class="main">∧</span> 𝒰 <span class="bound">s'</span> <span class="main">=</span> 𝒰 <span class="free">s</span> <span class="main">∧</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="bound">s'</span> <span class="main">=</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹Tableau remains valuated.›</span>

update_tableau_valuated<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∇</span> <span class="main">(</span><span class="free">update</span> <span class="free">x</span> <span class="free">v</span> <span class="free">s</span><span class="main">)</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹The given variable <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"x"</span><span class="antiquote">}</span></span> in the updated valuation is
   set to the given value <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"v"</span><span class="antiquote">}</span></span> while all other variables
   (except those on the lhs of the tableau) are
   unchanged.›</span>

update_valuation_nonlhs<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x'</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span>
       look <span class="main">(</span>𝒱 <span class="main">(</span><span class="free">update</span> <span class="free">x</span> <span class="free">v</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">x'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span> <span class="keyword1">then</span> Some <span class="free">v</span> <span class="keyword1">else</span> look <span class="main">(</span>𝒱 <span class="free">s</span><span class="main">)</span> <span class="free">x'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹Updated valuation continues to satisfy the tableau.›</span>

update_satisfies_tableau<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>  <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span> <span class="main">⟶</span> <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">update</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> update_bounds_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">update</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">ℬℐ</span> <span class="main">(</span><span class="free">update</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬℐ</span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="main">(</span><span class="free">update</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="main">(</span><span class="free">update</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> update_id assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_indices_state_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"indices_state <span class="main">(</span><span class="free">update</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> indices_state <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> update_bounds_id<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> indices_state_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> update_tableau_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> 𝒯 <span class="main">(</span><span class="free">update</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒯 <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> update_id
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_unsat_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> 𝒰 <span class="main">(</span><span class="free">update</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒰 <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> update_id
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_unsat_core_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span><span class="free">update</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> update_id
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">assert_bound'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assert_bound'</span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
       <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free"><span class="bound"><span class="entity">dir</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>UB <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
          <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> updateℬℐ <span class="main">(</span>UBI_upd <span class="free"><span class="bound"><span class="entity">dir</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">in</span>
             <span class="keyword1">if</span> <span class="main">(</span><span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free"><span class="bound"><span class="entity">dir</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="main">(</span>LB <span class="free"><span class="bound"><span class="entity">dir</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
                  set_unsat <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>LI <span class="free"><span class="bound"><span class="entity">dir</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">]</span> <span class="bound">s'</span>
             <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>lt <span class="free"><span class="bound"><span class="entity">dir</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⟩</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
                  <span class="free">update</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">s'</span>
             <span class="keyword1">else</span>
                  <span class="bound">s'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">assert_bound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> i_atom <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">assert_bound</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span>Leq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> assert_bound' Positive <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">assert_bound</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span>Geq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> assert_bound' Negative <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> assert_bound'_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>UB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>UB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>LB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
     <span class="free">P</span> <span class="main">(</span>set_unsat <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>LI <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="free">dir</span><span class="main">)</span> <span class="free">i</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">x</span><span class="main">)</span><span class="main">;</span> <span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>UB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>LB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
     <span class="free">P</span> <span class="main">(</span><span class="free">update</span> <span class="free">x</span> <span class="free">c</span> <span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="free">dir</span><span class="main">)</span> <span class="free">i</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>UB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>LB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
     <span class="free">P</span> <span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="free">dir</span><span class="main">)</span> <span class="free">i</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>UB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>LB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="main">¬</span> <span class="main">(</span><span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
     <span class="free">P</span> <span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="free">dir</span><span class="main">)</span> <span class="free">i</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="free">dir</span> <span class="main">=</span> Negative"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>assert_bound' <span class="free">dir</span> <span class="free">i</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>UB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>LB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>UB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"updateℬℐ <span class="main">(</span>UBI_upd <span class="free">dir</span><span class="main">)</span> <span class="free">i</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="var">?s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>UB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>LB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="var">?s</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">(</span><span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="var">?s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>UB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>LB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>UB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">(</span>LB <span class="free">dir</span><span class="main">)</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> assert_bound_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span> <span class="bound">x</span> <span class="bound">dir</span><span class="main">.</span>
     <span class="main">⟦</span> <span class="bound">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="bound">dir</span> <span class="main">=</span> Negative<span class="main">;</span>
       <span class="free">a</span> <span class="main">=</span> LE <span class="bound">dir</span> <span class="bound">x</span> <span class="bound">c</span><span class="main">;</span>
       <span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="bound">c</span> <span class="main">(</span><span class="main">(</span>UB <span class="bound">dir</span><span class="main">)</span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span>
     <span class="main">⟧</span> <span class="main">⟹</span>
       <span class="free">P'</span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LE <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>GE <span class="bound">dir</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span> <span class="bound">x</span> <span class="bound">dir</span><span class="main">.</span>
     <span class="main">⟦</span><span class="bound">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="bound">dir</span> <span class="main">=</span> Negative<span class="main">;</span>
      <span class="free">a</span> <span class="main">=</span> LE <span class="bound">dir</span> <span class="bound">x</span> <span class="bound">c</span><span class="main">;</span>
      <span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="bound">c</span> <span class="main">(</span><span class="main">(</span>UB <span class="bound">dir</span><span class="main">)</span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="bound">c</span> <span class="main">(</span><span class="main">(</span>LB <span class="bound">dir</span><span class="main">)</span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span>
     <span class="main">⟧</span> <span class="main">⟹</span>
        <span class="free">P'</span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LE <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>GE <span class="bound">dir</span><span class="main">)</span>
          <span class="main">(</span>set_unsat <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>LI <span class="bound">dir</span><span class="main">)</span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="free">i</span> <span class="bound">x</span> <span class="bound">c</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span> <span class="bound">x</span> <span class="bound">dir</span><span class="main">.</span>
     <span class="main">⟦</span> <span class="bound">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="bound">dir</span> <span class="main">=</span> Negative<span class="main">;</span>
       <span class="free">a</span> <span class="main">=</span> LE <span class="bound">dir</span> <span class="bound">x</span> <span class="bound">c</span><span class="main">;</span>
       <span class="bound">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="bound">c</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span>
      <span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="bound">c</span> <span class="main">(</span><span class="main">(</span>UB <span class="bound">dir</span><span class="main">)</span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="bound">c</span> <span class="main">(</span><span class="main">(</span>LB <span class="bound">dir</span><span class="main">)</span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⟧</span> <span class="main">⟹</span>
        <span class="free">P'</span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LE <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>GE <span class="bound">dir</span><span class="main">)</span>
       <span class="main">(</span><span class="free">update</span> <span class="bound">x</span> <span class="bound">c</span> <span class="main">(</span><span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="free">i</span> <span class="bound">x</span> <span class="bound">c</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span> <span class="bound">x</span> <span class="bound">dir</span><span class="main">.</span>
     <span class="main">⟦</span> <span class="bound">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="bound">dir</span> <span class="main">=</span> Negative<span class="main">;</span>
       <span class="free">a</span> <span class="main">=</span> LE <span class="bound">dir</span> <span class="bound">x</span> <span class="bound">c</span><span class="main">;</span>
       <span class="bound">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="bound">c</span> <span class="main">(</span><span class="main">(</span>UB <span class="bound">dir</span><span class="main">)</span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
       <span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="bound">c</span> <span class="main">(</span><span class="main">(</span>LB <span class="bound">dir</span><span class="main">)</span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⟧</span> <span class="main">⟹</span>
        <span class="free">P'</span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LE <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>GE <span class="bound">dir</span><span class="main">)</span>
          <span class="main">(</span><span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="free">i</span> <span class="bound">x</span> <span class="bound">c</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span> <span class="bound">x</span> <span class="bound">dir</span><span class="main">.</span>
     <span class="main">⟦</span> <span class="bound">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="bound">dir</span> <span class="main">=</span> Negative<span class="main">;</span>
       <span class="free">a</span> <span class="main">=</span> LE <span class="bound">dir</span> <span class="bound">x</span> <span class="bound">c</span><span class="main">;</span>
       <span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="bound">c</span> <span class="main">(</span><span class="main">(</span>UB <span class="bound">dir</span><span class="main">)</span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="bound">c</span> <span class="main">(</span><span class="main">(</span>LB <span class="bound">dir</span><span class="main">)</span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
       <span class="main">¬</span> <span class="main">(</span><span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="bound">c</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⟧</span> <span class="main">⟹</span>
        <span class="free">P'</span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LE <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>GE <span class="bound">dir</span><span class="main">)</span>
           <span class="main">(</span><span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="free">i</span> <span class="bound">x</span> <span class="bound">c</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">P'</span> <span class="main">(&gt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> Geq Leq <span class="bound">s</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">P'</span> <span class="main">(&lt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> Leq Geq <span class="bound">s</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>assert_bound <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Leq <span class="skolem">x</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> assert_bound'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assert_bound'_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted">Positive</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted">Positive</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted">Positive</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted">Positive</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted">Positive</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>7<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Geq <span class="skolem">x</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> assert_bound'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assert_bound'_cases<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted">Negative</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted">Negative</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted">Negative</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted">Negative</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted">Negative</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_unsat_bounds_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ</span> <span class="main">(</span>set_unsat <span class="free">I</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> boundsl_def boundsu_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> decrease_ub_satisfied_inverse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊲<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span>  <span class="main">(</span>UB <span class="free">dir</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dir<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="free">dir</span> <span class="main">=</span> Negative"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="free">dir</span><span class="main">)</span> <span class="free">i</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds.simps
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"in_bounds <span class="skolem">x'</span> <span class="free">v</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> v dir
      <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> v dir
      <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds.simps
      <span class="keyword1"><span class="command">using</span></span> lt
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lt_ubound_def<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> gt_lbound_def<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> compare_strict_nonstrict
          boundsl_def boundsu_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atoms_equiv_bounds_extend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">c</span> <span class="free">dir</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="free">dir</span> <span class="main">=</span> Negative"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span>UB <span class="free">dir</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">ats</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ats</span> <span class="main">∪</span> <span class="main">{</span>LE <span class="free">dir</span> <span class="free">x</span> <span class="free">c</span><span class="main">}</span><span class="main">)</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="free">dir</span><span class="main">)</span> <span class="free">i</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atoms_equiv_bounds.simps
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"updateℬℐ <span class="main">(</span>UBI_upd <span class="free">dir</span><span class="main">)</span> <span class="free">i</span> <span class="free">x</span> <span class="free">c</span> <span class="free">s</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">ats</span> <span class="main">∪</span> <span class="main">{</span>LE <span class="free">dir</span> <span class="free">x</span> <span class="free">c</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="var">?s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">ats</span> <span class="main">∪</span> <span class="main">{</span>LE <span class="free">dir</span> <span class="free">x</span> <span class="free">c</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">ats</span>"</span></span> <span class="quoted"><span class="quoted">"le <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="skolem">v</span> <span class="free">x</span><span class="main">)</span> <span class="free">c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="free">dir</span> <span class="main">=</span> Negative›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> satisfies_atom_set_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="var">?s</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds.simps
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"in_bounds <span class="skolem">x'</span> <span class="skolem">v</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="var">?s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">ats</span>›</span></span> <span class="quoted"><span class="quoted">‹le <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="skolem">v</span> <span class="free">x</span><span class="main">)</span> <span class="free">c</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ats</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="free">s</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="free">dir</span> <span class="main">=</span> Negative›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> atoms_equiv_bounds.simps satisfies_bounds.simps
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="var">?s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span>UB <span class="free">dir</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="free">dir</span> <span class="main">=</span> Negative›</span></span>
      <span class="keyword1"><span class="command">using</span></span> decrease_ub_satisfied_inverse<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">dir</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> neg_bounds_compare<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="free">x</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> neg_bounds_compare<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="free">x</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  lt_ubound_def<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> ge_ubound_def<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> le_lbound_def<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> gt_lbound_def<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">ats</span> <span class="main">∪</span> <span class="main">{</span>LE <span class="free">dir</span> <span class="free">x</span> <span class="free">c</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> satisfies_atom_set_def
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">ats</span> <span class="main">∪</span> <span class="main">{</span>LE <span class="free">dir</span> <span class="free">x</span> <span class="free">c</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{</span>LE <span class="free">dir</span> <span class="free">x</span> <span class="free">c</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="var">?s</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="free">dir</span> <span class="main">=</span> Negative›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds.simps
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">ats</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ats</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="free">s</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="free">s</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> atoms_equiv_bounds.simps satisfies_atom_set_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bounds_updates<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update <span class="free">u</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update <span class="free">u</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update <span class="main">(</span>upd <span class="free">x</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update <span class="main">(</span>upd <span class="free">x</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def<span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> EqForLVar <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">eq_idx_for_lvar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> var <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq_idx_for_lvar<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">∈</span> lvars <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">eq_idx_for_lvar</span> <span class="free">t</span> <span class="free">x</span> <span class="main">&lt;</span> length <span class="free">t</span> <span class="main">∧</span> lhs <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">eq_idx_for_lvar</span> <span class="free">t</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eq_for_lvar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> var <span class="main">⇒</span> eq"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eq_for_lvar</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">!</span> <span class="main">(</span><span class="free">eq_idx_for_lvar</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> eq_for_lvar<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">∈</span> lvars <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> eq_for_lvar <span class="free">t</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">t</span> <span class="main">∧</span> lhs <span class="main">(</span>eq_for_lvar <span class="free">t</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> eq_for_lvar_def
  <span class="keyword1"><span class="command">using</span></span> eq_idx_for_lvar
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rvars_of_lvar</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rvars_of_lvar</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> rvars_eq <span class="main">(</span>eq_for_lvar <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rvars_of_lvar_rvars<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> lvars <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rvars_of_lvar <span class="free">t</span> <span class="free">x</span> <span class="main">⊆</span> rvars <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms eq_for_lvar<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> rvars_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Updating changes the value of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> and then updates
values of all lhs variables so that the tableau remains
satisfied. This can be based on a function that recalculates rhs
polynomial values in the changed valuation:›</span></span>

<span class="keyword1"><span class="command">locale</span></span> RhsEqVal <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rhs_eq_val</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>var<span class="main">,</span> <span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> mapping <span class="main">⇒</span> var <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> eq <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">rhs_eq_val</span><span class="antiquote">}</span></span> computes the value of the rhs of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">e</span><span class="antiquote">}</span></span> in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"⟨v⟩(x := c)"</span><span class="antiquote">}</span></span>.›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rhs_eq_val<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">rhs_eq_val</span> <span class="free">v</span> <span class="free">x</span> <span class="free">c</span> <span class="free">e</span> <span class="main">=</span> rhs <span class="free">e</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">c</span><span class="main">)</span> <span class="main">⦄</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\noindent Then, the next implementation of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>update›</span></span></span></span>
satisfies its specification:›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">update_eq</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_eq</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> upd <span class="main">(</span>lhs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">rhs_eq_val</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> 𝒱_update <span class="main">(</span>upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>foldl <span class="main">(</span>update_eq <span class="main">(</span>𝒱 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>𝒱 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>𝒯 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> update_no_set_none<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>𝒱 <span class="free">s</span><span class="main">)</span> <span class="free">y</span> <span class="main">≠</span> None <span class="main">⟹</span>
         look <span class="main">(</span>foldl <span class="main">(</span>update_eq <span class="main">(</span>𝒱 <span class="free">s</span><span class="main">)</span> <span class="free">x</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>𝒱 <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="free">y</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_update'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_no_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> lvars <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>𝒱 <span class="free">s</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> look <span class="main">(</span>foldl <span class="main">(</span>update_eq <span class="main">(</span>𝒱 <span class="free">s</span><span class="main">)</span> <span class="free">x</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>𝒱 <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lvars_def lookup_update'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> lvars <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">eq</span> <span class="main">∈</span> set <span class="free">t</span><span class="main">.</span> lhs <span class="bound">eq</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span>
     look <span class="main">(</span>foldl <span class="main">(</span>update_eq <span class="main">(</span>𝒱 <span class="free">s</span><span class="main">)</span> <span class="free">x</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>𝒱 <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">rhs_eq_val</span> <span class="main">(</span>𝒱 <span class="free">s</span><span class="main">)</span> <span class="free">x</span> <span class="free">v</span> <span class="bound">eq</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lvars_def lookup_update'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_valuate_rhs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> set <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rhs <span class="free">e</span> <span class="main">⦃</span> <span class="main">⟨</span>𝒱 <span class="main">(</span>update <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span><span class="main">⟩</span> <span class="main">⦄</span> <span class="main">=</span> rhs <span class="free">e</span> <span class="main">⦃</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">c</span><span class="main">)</span> <span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> valuate_depend<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> rvars_eq <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">∈</span> set <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_tableau_def rvars_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="main">(</span>update <span class="free">x</span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span><span class="main">⟩</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> update_no_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"𝒯 <span class="free">s</span>"</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> update_def map2fun_def lookup_update'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">sublocale</span></span> RhsEqVal <span class="main">&lt;</span> Update <span class="quoted">update</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="skolem">c</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> update <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span> <span class="keyword1">in</span> 𝒯 <span class="bound">s'</span> <span class="main">=</span> 𝒯 <span class="skolem">s</span> <span class="main">∧</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">s'</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s</span> <span class="main">∧</span> 𝒰 <span class="bound">s'</span> <span class="main">=</span> 𝒰 <span class="skolem">s</span> <span class="main">∧</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="bound">s'</span> <span class="main">=</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def update_def <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def indexl_def indexu_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="skolem">c</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="main">(</span>update <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> update_no_set_none<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def update_def tableau_valuated_def lookup_update'<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="skolem">x</span> <span class="skolem">x'</span> <span class="skolem">c</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="main">⟶</span>
          look <span class="main">(</span>𝒱 <span class="main">(</span>update <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x'</span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x'</span> <span class="keyword1">then</span> Some <span class="skolem">c</span> <span class="keyword1">else</span> look <span class="main">(</span>𝒱 <span class="skolem">s</span><span class="main">)</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> update_no_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x'</span></span> <span class="quoted"><span class="quoted">"𝒯 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> update_def lvars_def Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_update'<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="skolem">c</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="main">⟨</span>𝒱 <span class="main">(</span>update <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">e</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> set <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_tableau_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> lhs <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">∈</span> set <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lvars_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="main">(</span>update <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span><span class="main">⟩</span> <span class="main">(</span>lhs <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="free">rhs_eq_val</span> <span class="main">(</span>𝒱 <span class="skolem">s</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> update_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"lhs <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"𝒯 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">∈</span> set <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lvars_def lookup_update' update_def Let_def map2fun_def normalized_tableau_def distinct_map inj_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="main">(</span>update <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">e</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">∈</span> set <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> rhs_eq_val
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_eq_def update_valuate_rhs<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s</span> <span class="main">⟶</span> <span class="main">⟨</span>𝒱 <span class="main">(</span>update <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_tableau_def update_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹To update the valuation for a variable that is on the lhs of
the tableau it should first be swapped with some rhs variable of its
equation, in an operation called \emph{pivoting}. Pivoting has the
precondition that the tableau is normalized and that it is always
called for a lhs variable of the tableau, and a rhs variable in the
equation with that lhs variable. The set of rhs variables for the
given lhs variable is found using the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rvars_of_lvar›</span></span></span></span> function
(specified in a very simple locale <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>EqForLVar›</span></span></span></span>, that we do not
print).›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Pivot <span class="main">=</span> EqForLVar <span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">pivot</span><span class="main">::</span><span class="quoted"><span class="quoted">"var <span class="main">⇒</span> var <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="comment1">― ‹Valuation, bounds, and the unsatisfiability flag are not changed.›</span>

pivot_id<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span>
      <span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span> <span class="keyword1">in</span> 𝒱 <span class="bound">s'</span> <span class="main">=</span> 𝒱 <span class="free">s</span> <span class="main">∧</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">s'</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span> <span class="main">∧</span> 𝒰 <span class="bound">s'</span> <span class="main">=</span> 𝒰 <span class="free">s</span> <span class="main">∧</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="bound">s'</span> <span class="main">=</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹The tableau remains equivalent to the previous one and normalized.›</span>

pivot_tableau<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span>
      <span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span> <span class="keyword1">in</span>  <span class="main">(</span><span class="main">(</span><span class="free">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="bound">s'</span><span class="main">)</span> "</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"x<span class="hidden">⇩</span><sub>i</sub>"</span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"x<span class="hidden">⇩</span><sub>j</sub>"</span><span class="antiquote">}</span></span> are swapped, while the other variables do not change sides.›</span>

pivot_vars'<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span> <span class="keyword1">in</span>
   rvars<span class="main">(</span>𝒯 <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> rvars<span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">-</span><span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">∪</span><span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span>  <span class="main">∧</span>  lvars<span class="main">(</span>𝒯 <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> lvars<span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">-</span><span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span><span class="main">∪</span><span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> pivot_bounds_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span>
      <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pivot_id
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pivot_bounds_id'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬℐ</span> <span class="main">(</span><span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬℐ</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ</span> <span class="main">(</span><span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ</span> <span class="main">(</span><span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℐ</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pivot_bounds_id<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pivot_valuation_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span> 𝒱 <span class="main">(</span><span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒱 <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pivot_id
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pivot_unsat_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span> 𝒰 <span class="main">(</span><span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒰 <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pivot_id
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pivot_unsat_core_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span><span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pivot_id
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pivot_tableau_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="free">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span> <span class="main">=</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span><span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pivot_tableau
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pivot_tableau_normalized<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pivot_tableau
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pivot_rvars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pivot_vars'
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pivot_lvars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pivot_vars'
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pivot_vars<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span> tvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">using</span></span> pivot_lvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span> pivot_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> rvars_of_lvar_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="quoted">"𝒯 <span class="free">s</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span>
  pivot_tableau_valuated<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∇</span> <span class="main">(</span><span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pivot_valuation_id pivot_vars
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tableau_valuated_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Functions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>pivot›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>update›</span></span></span></span> can be used to
implement the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check›</span></span></span></span> function. In its context, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>pivot›</span></span></span></span>
and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>update›</span></span></span></span> functions are always called together, so the
following definition can be used: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">pivot_and_update</span></span> <span class="free"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="free"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="free"><span class="free">c</span></span> <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span>
<span class="free"><span class="free">update</span></span> <span class="free"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="free"><span class="free">c</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">pivot</span></span> <span class="free"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="free"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. It is possible to make a more efficient
implementation of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>pivot_and_update›</span></span></span></span> that does not use separate
implementations of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>pivot›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>update›</span></span></span></span>. To allow this, a
separate specification for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>pivot_and_update›</span></span></span></span> can be given. It can be
easily shown that the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>pivot_and_update›</span></span></span></span> definition above
satisfies this specification.›</span></span>


<span class="keyword1"><span class="command">locale</span></span> PivotAndUpdate <span class="main">=</span> EqForLVar <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">pivot_and_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>lrv <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  pivotandupdate_unsat_id<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span>
      𝒰 <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒰 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pivotandupdate_unsat_core_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span>
      𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  pivotandupdate_bounds_id<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span>
      <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  pivotandupdate_tableau_normalized<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  pivotandupdate_tableau_equiv<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="free">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pivotandupdate_satisfies_tableau<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span> <span class="main">⟶</span> <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  pivotandupdate_rvars<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span>
      rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  pivotandupdate_lvars<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span>
      lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pivotandupdate_valuation_nonlhs<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span>
      <span class="free">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span> <span class="main">⟶</span> look <span class="main">(</span>𝒱 <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">then</span> Some <span class="free">c</span> <span class="keyword1">else</span> look <span class="main">(</span>𝒱 <span class="free">s</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pivotandupdate_tableau_valuated<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span>
 <span class="main">∇</span> <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pivotandupdate_bounds_id'<span class="main">:</span>  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬℐ</span> <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬℐ</span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ</span> <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ</span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ</span> <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℐ</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pivotandupdate_bounds_id<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  pivotandupdate_valuation_xi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span> <span class="main">⟹</span> look <span class="main">(</span>𝒱 <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Some <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pivotandupdate_valuation_nonlhs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> rvars_of_lvar_rvars
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  normalized_tableau_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  pivotandupdate_valuation_other_nolhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">;</span> <span class="free">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">⟧</span> <span class="main">⟹</span> look <span class="main">(</span>𝒱 <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> look <span class="main">(</span>𝒱 <span class="free">s</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pivotandupdate_valuation_nonlhs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pivotandupdate_nolhs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="free">s</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">;</span>
     <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span><span class="main">;</span> <span class="main">◇</span> <span class="free">s</span><span class="main">;</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Some <span class="free">c</span> <span class="main">∨</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Some <span class="free">c</span><span class="main">⟧</span> <span class="main">⟹</span>
     <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pivotandupdate_satisfies_tableau<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> pivotandupdate_tableau_equiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="main">_</span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> pivotandupdate_valuation_xi<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> pivotandupdate_valuation_other_nolhs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="main">_</span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> pivotandupdate_lvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> curr_val_satisfies_no_lhs_def satisfies_bounds.simps satisfies_bounds_set.simps
      bounds_consistent_geq_lb bounds_consistent_leq_ub map2fun_def pivotandupdate_bounds_id'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pivotandupdate_bounds_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">◇</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms pivotandupdate_bounds_id'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bounds_consistent_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> PivotUpdate <span class="main">=</span> Pivot <span class="quoted"><span class="free">eq_idx_for_lvar</span></span> <span class="quoted"><span class="free">pivot</span></span> <span class="main">+</span> Update <span class="quoted"><span class="free">update</span></span> <span class="keyword2"><span class="keyword">for</span></span>
  <span class="free">eq_idx_for_lvar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> var <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">pivot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> var <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span>  <span class="entity">pivot_and_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> var <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">pivot_and_update</span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>j</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free">update</span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free">pivot</span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>j</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pivot_update_precond<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">≠</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rvars_of_lvar_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="quoted">"𝒯 <span class="free">s</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_tableau_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">pivot</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">using</span></span> pivot_tableau_normalized<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> pivot_lvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">sublocale</span></span> PivotUpdate <span class="main">&lt;</span> PivotAndUpdate <span class="quoted"><span class="free">eq_idx_for_lvar</span></span> <span class="quoted">pivot_and_update</span>
  <span class="keyword1"><span class="command">using</span></span> pivot_update_precond
  <span class="keyword1"><span class="command">using</span></span> update_unsat_id pivot_unsat_id pivot_unsat_core_id update_bounds_id pivot_bounds_id
    update_tableau_id pivot_tableau_normalized pivot_tableau_equiv update_satisfies_tableau
    pivot_valuation_id pivot_lvars pivot_rvars  update_valuation_nonlhs update_valuation_nonlhs
    pivot_tableau_valuated update_tableau_valuated update_unsat_core_id
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Given the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">update</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> function, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span> can be
implemented as follows.
\vspace{-2mm}
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span>[display]
  <span class="raw_text"><span class="raw_text">"assert_bound (Leq x c) s ≡
          if c ≥<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub> ℬ<span class="hidden">⇩</span><sub>u</sub> s x then s
          else let s' = s ⦇ ℬ<span class="hidden">⇩</span><sub>u</sub> := (ℬ<span class="hidden">⇩</span><sub>u</sub> s) (x := Some c) ⦈
               in if c &lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub> ℬ<span class="hidden">⇩</span><sub>l</sub> s x then s' ⦇ 𝒰 := True ⦈
               else if x ∉ lvars (𝒯 s') ∧ c &lt; ⟨𝒱 s⟩ x then update x c s' else s'"</span></span>
<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\vspace{-2mm}
\noindent The case of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Geq x c›</span></span></span></span> atoms is analogous (a systematic way to
avoid symmetries is discussed in Section \ref{sec:symmetries}). This
implementation satisfies both its specifications.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> indices_state_set_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"indices_state <span class="main">(</span>set_unsat <span class="free">I</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> indices_state <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indices_state_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ℬℐ_set_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬℐ</span> <span class="main">(</span>set_unsat <span class="free">I</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬℐ</span> <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def indexl_def indexu_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_tableau_cong<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> tvars <span class="free">t</span> <span class="main">⟹</span> <span class="free">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">w</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> satisfies_tableau_def satisfies_eq_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ball_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(=)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> valuate_depend<span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lvars_def rvars_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfying_state_valuation_to_atom_tabl<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">J</span> <span class="main">⊆</span> indices_state <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> model<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">J</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> ivalid<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="free">as</span> <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_indices_atoms <span class="free">as</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">J</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> i_satisfies_atom_set'.simps
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ballI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> model<span class="main">[</span><span class="operator">unfolded</span> satisfies_state_index'.simps<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> model<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">J</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="keyword1">ℬℐ</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> restrict_to <span class="free">J</span> <span class="free">as</span>"</span></span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> iJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> J <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> indices_state <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> indices_state_def<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    look<span class="main">:</span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free">s</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∨</span> look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free">s</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> ivalid<span class="main">[</span><span class="operator">unfolded</span> index_valid_def<span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"atom_var <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"atom_const <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> dist<span class="main">[</span><span class="operator">unfolded</span> distinct_indices_atoms_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mem<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"atom_var <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"atom_const <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> model<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> satisfies_bounds_index'.simps<span class="main">]</span> look iJ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsu_def boundsl_def indexu_def indexl_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies_atom'_def a <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that in order to ensure minimality of the unsat cores, pivoting is required.›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> AssertAllState <span class="main">&lt;</span> AssertAll <span class="quoted">assert_all</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">as</span> <span class="skolem">v</span> <span class="skolem">I</span>
  <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="skolem">t</span>"</span></span>  
  <span class="keyword1"><span class="command">from</span></span> D <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"assert_all <span class="skolem">t</span> <span class="skolem">as</span> <span class="main">=</span> Sat <span class="skolem">v</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="skolem">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span> <span class="main">∧</span> <span class="main">⟨</span><span class="skolem">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> flat <span class="main">(</span>set <span class="skolem">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Let_def assert_all_def
    <span class="keyword1"><span class="command">using</span></span> assert_all_state_tableau_equiv<span class="main">[</span><span class="operator">OF</span> D refl<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assert_all_state_sat<span class="main">[</span><span class="operator">OF</span> D refl<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assert_all_state_sat_atoms_equiv_bounds<span class="main">[</span><span class="operator">OF</span> D refl<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> atoms_equiv_bounds.simps curr_val_satisfies_state_def satisfies_state_def satisfies_atom_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">assert_all_state</span> <span class="skolem">t</span> <span class="skolem">as</span>"</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"assert_all <span class="skolem">t</span> <span class="skolem">as</span> <span class="main">=</span> Unsat <span class="skolem">I</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> the <span class="main">(</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒰 <span class="var">?s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assert_all_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assert_all_index_valid<span class="main">[</span><span class="operator">OF</span> D refl<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ivalid<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="main">(</span>set <span class="skolem">as</span><span class="main">)</span> <span class="var">?s</span>"</span></span>  <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">note</span></span> unsat <span class="main">=</span> assert_all_state_unsat<span class="main">[</span><span class="operator">OF</span> D refl U<span class="main">,</span> <span class="operator">unfolded</span> minimal_unsat_state_core_def unsat_state_core_def i<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> unsat <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">I</span> <span class="main">⊆</span> indices_state <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assert_all_state_indices<span class="main">[</span><span class="operator">OF</span> D refl<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> indices<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">I</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_tabl_atoms <span class="main">(</span>set <span class="skolem">I</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">(</span>set <span class="skolem">as</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> minimal_unsat_core_tabl_atoms_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI allI indices<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> model<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">I</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="skolem">as</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> unsat <span class="keyword1"><span class="command">have</span></span> no_model<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">(</span>set <span class="skolem">I</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> assert_all_state_unsat_atoms_equiv_bounds<span class="main">[</span><span class="operator">OF</span> D refl U<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">as</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> assert_all_state_tableau_equiv<span class="main">[</span><span class="operator">OF</span> D refl<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> model
    <span class="keyword1"><span class="command">have</span></span> model_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> model_as'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">I</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="skolem">as</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> model<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> satisfies_atom_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> equiv model_t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">I</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?s</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> satisfies_state_index.simps atoms_imply_bounds_index.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> no_model <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">J</span>
    <span class="keyword3"><span class="command">assume</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_indices_atoms <span class="main">(</span>set <span class="skolem">as</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">⊂</span> set <span class="skolem">I</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> J unsat<span class="main">[</span><span class="operator">unfolded</span> subsets_sat_core_def<span class="main">,</span> <span class="operator">folded</span> i<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> J'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">⊆</span> indices_state <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> index_valid_distinct_indices<span class="main">[</span><span class="operator">OF</span> ivalid dist<span class="main">]</span> J unsat<span class="main">[</span><span class="operator">unfolded</span> subsets_sat_core_def<span class="main">,</span> <span class="operator">folded</span> i<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> model<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="skolem">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> satisfying_state_valuation_to_atom_tabl<span class="main">[</span><span class="operator">OF</span> J' model ivalid dist<span class="main">]</span>
       assert_all_state_tableau_equiv<span class="main">[</span><span class="operator">OF</span> D refl<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Update<span class="main">)</span> update_to_assert_bound_no_lhs<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> pivot<span class="main">:</span> <span class="quoted"><span class="quoted">"Pivot <span class="free">eqlvar</span> <span class="main">(</span><span class="free">pivot</span> <span class="main">::</span> var <span class="main">⇒</span> var <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"AssertBoundNoLhs assert_bound"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝒯 <span class="main">(</span>assert_bound <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> 𝒯 <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">a</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def update_tableau_id tableau_valuated_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ia</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">as</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> index<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="skolem">as</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="skolem">s</span>"</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?modelU</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">lt</span> <span class="bound">UB</span> <span class="bound">UI</span> <span class="bound">s</span> <span class="bound">v</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">UB</span> <span class="bound">s</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">c</span> <span class="main">⟶</span> <span class="bound">UI</span> <span class="bound">s</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>the <span class="main">(</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">lt</span> <span class="main">(</span><span class="bound">v</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">c</span> <span class="main">∨</span> <span class="bound">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?modelL</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">lt</span> <span class="bound">LB</span> <span class="bound">LI</span> <span class="bound">s</span> <span class="bound">v</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">LB</span> <span class="bound">s</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">c</span> <span class="main">⟶</span> <span class="bound">LI</span> <span class="bound">s</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span>the <span class="main">(</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">lt</span> <span class="bound">c</span> <span class="main">(</span><span class="bound">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">v</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?modelIU</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">I</span> <span class="bound">lt</span> <span class="bound">UB</span> <span class="bound">UI</span> <span class="bound">s</span> <span class="bound">v</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">UB</span> <span class="bound">s</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">c</span> <span class="main">⟶</span> <span class="bound">UI</span> <span class="bound">s</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">I</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?modelIL</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">I</span> <span class="bound">lt</span> <span class="bound">LB</span> <span class="bound">LI</span> <span class="bound">s</span> <span class="bound">v</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">LB</span> <span class="bound">s</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">c</span> <span class="main">⟶</span> <span class="bound">LI</span> <span class="bound">s</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">I</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">lt</span> <span class="bound">UBI</span> <span class="bound">LBI</span> <span class="bound">UB</span> <span class="bound">LB</span> <span class="bound">UBI_upd</span> <span class="bound">UI</span> <span class="bound">LI</span> <span class="bound">LE</span> <span class="bound">GE</span> <span class="bound">s</span><span class="main">.</span>
    𝒰 <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span>set <span class="main">(</span>the <span class="main">(</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> indices_state <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="bound">s</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?modelU</span> <span class="bound">lt</span> <span class="bound">UB</span> <span class="bound">UI</span> <span class="bound">s</span> <span class="bound">v</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?modelL</span> <span class="bound">lt</span> <span class="bound">LB</span> <span class="bound">LI</span> <span class="bound">s</span> <span class="bound">v</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span>distinct_indices_state <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">⊂</span> set <span class="main">(</span>the <span class="main">(</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="bound">s</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?modelIU</span> <span class="bound">I</span> <span class="bound">lt</span> <span class="bound">UB</span> <span class="bound">UI</span> <span class="bound">s</span> <span class="bound">v</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?modelIL</span> <span class="bound">I</span> <span class="bound">lt</span> <span class="bound">LB</span> <span class="bound">LI</span> <span class="bound">s</span> <span class="bound">v</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>unsat_state_core <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span>distinct_indices_state <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⟶</span> subsets_sat_core <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ia
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> assert_bound_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P'</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">&gt;</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">≥</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> id'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P'</span> <span class="main">(&gt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> undefined <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> Geq Leq <span class="skolem">s'</span> <span class="main">=</span> <span class="var">?P'</span> <span class="main">(&lt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> undefined <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> Leq Geq <span class="skolem">s'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">⟶</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">∧</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">intro</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(∧)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">⟶</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">∀</span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">x</span></span></span></span></span></span> <span class="main"><span class="main"><span class="main">⊂</span></span></span> set <span class="main"><span class="main"><span class="main">(</span></span></span>the <span class="main"><span class="main"><span class="main">(</span></span></span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="skolem"><span class="skolem"><span class="skolem">s'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> ext arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">Not</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">unfold</span> id<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">s'</span> <span class="main">=</span> <span class="var">?P'</span> <span class="main">(&gt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> undefined <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> Geq Leq <span class="skolem">s'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> satisfies_state_def satisfies_bounds_index.simps satisfies_bounds.simps
        in_bounds.simps unsat_state_core_def satisfies_state_index.simps subsets_sat_core_def
        satisfies_state_index'.simps satisfies_bounds_index'.simps
      <span class="keyword1"><span class="command">unfolding</span></span> bound_compare''_defs id 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">intro</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">⟶</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">∧</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">intro</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(∧)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> refl arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">⟶</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">Not</span></span></span><span class="main"><span class="main">]</span></span>
        arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">∀</span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">x</span></span></span></span></span></span> <span class="main"><span class="main"><span class="main">⊂</span></span></span> set <span class="main"><span class="main"><span class="main">(</span></span></span>the <span class="main"><span class="main"><span class="main">(</span></span></span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="skolem"><span class="skolem"><span class="skolem">s'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> ext<span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">Ex</span></span></span><span class="main"><span class="main">]</span></span> ext<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">s'</span> <span class="main">=</span> <span class="var">?P'</span> <span class="main">(&lt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> undefined <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> Leq Geq <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id' <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">(</span>LB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dir<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> some<span class="main">:</span> <span class="quoted"><span class="quoted">"LB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"lt <span class="skolem">dir</span> <span class="skolem">c</span> <span class="skolem">d</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare'_defs <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> index<span class="main">[</span><span class="operator">unfolded</span> index_valid_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">d</span></span><span class="main">]</span>
      some dir <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"LI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>LBI <span class="skolem">dir</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span><span class="main">,</span> GE <span class="skolem">dir</span> <span class="skolem">x</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">as</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set_unsat <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>LI <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span>"</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P'</span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UBI <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LBI <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UB <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UI <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LI <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LE <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>GE <span class="skolem">dir</span><span class="main">)</span> <span class="var">?s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> dir ind ge lt some <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indices_state_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
        <span class="keyword3"><span class="command">assume</span></span> vU<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?modelU</span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UB <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UI <span class="skolem">dir</span><span class="main">)</span> <span class="var">?s</span> <span class="skolem">v</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> vL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?modelL</span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LI <span class="skolem">dir</span><span class="main">)</span> <span class="var">?s</span> <span class="skolem">v</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span>"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> dir <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"UB <span class="skolem">dir</span> <span class="var">?s</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"UI <span class="skolem">dir</span> <span class="var">?s</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def indexl_def indexu_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> vU<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> vx_le_c<span class="main">:</span> <span class="quoted"><span class="quoted">"lt <span class="skolem">dir</span> <span class="main">(</span><span class="skolem">v</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">∨</span> <span class="skolem">v</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> dir ind some <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"LB <span class="skolem">dir</span> <span class="var">?s</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"LI <span class="skolem">dir</span> <span class="var">?s</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def indexl_def indexu_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> d_le_vx<span class="main">:</span> <span class="quoted"><span class="quoted">"lt <span class="skolem">dir</span> <span class="skolem">d</span> <span class="main">(</span><span class="skolem">v</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">v</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> vL<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> some ind<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> dir d_le_vx vx_le_c lt
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">I</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_indices_state <span class="var">?ss</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> distinct_indices_state_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> id1<span class="main">:</span> <span class="quoted"><span class="quoted">"UB <span class="skolem">dir</span> <span class="var">?s</span> <span class="skolem">y</span> <span class="main">=</span> UB <span class="skolem">dir</span> <span class="var">?ss</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"LB <span class="skolem">dir</span> <span class="var">?s</span> <span class="skolem">y</span> <span class="main">=</span> LB <span class="skolem">dir</span> <span class="var">?ss</span> <span class="skolem">y</span>"</span></span>
               <span class="quoted"><span class="quoted">"UI <span class="skolem">dir</span> <span class="var">?s</span> <span class="skolem">y</span> <span class="main">=</span> UI <span class="skolem">dir</span> <span class="var">?ss</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"LI <span class="skolem">dir</span> <span class="var">?s</span> <span class="skolem">y</span> <span class="main">=</span> LI <span class="skolem">dir</span> <span class="var">?ss</span> <span class="skolem">y</span>"</span></span> 
               <span class="quoted"><span class="quoted">"𝒯 <span class="var">?s</span> <span class="main">=</span> 𝒯 <span class="skolem">s</span>"</span></span> 
               <span class="quoted"><span class="quoted">"set <span class="main">(</span>the <span class="main">(</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="var">?s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">i</span><span class="main">,</span>LI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>        
        <span class="keyword1"><span class="command">using</span></span> dir <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsu_def boundsl_def indexu_def indexl_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">from</span></span> I <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">P1</span> <span class="bound">k</span> <span class="main">⟶</span> <span class="skolem">P2</span> <span class="bound">k</span> <span class="main">⟶</span> <span class="bound">k</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">⟶</span> <span class="skolem">Q</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">I</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">P1</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="skolem">P2</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="skolem">Q</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P1</span> <span class="skolem">P2</span> <span class="skolem">Q</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> id2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">xa</span> <span class="main">=</span> Some <span class="skolem">ca</span> <span class="main">⟶</span> UI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">xa</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>look <span class="main">(</span>UBI <span class="skolem">dir</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">xa</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">ca</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span>LB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">xa</span> <span class="main">=</span> Some <span class="skolem">ca</span> <span class="main">⟶</span> LI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">xa</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>look <span class="main">(</span>LBI <span class="skolem">dir</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">xa</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">ca</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xa</span> <span class="skolem">ca</span> <span class="skolem">P</span> <span class="skolem">s</span>
        <span class="keyword1"><span class="command">using</span></span> dir <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsu_def indexu_def boundsl_def indexl_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s</span> <span class="main">∧</span>
             <span class="main">(</span><span class="main">∀</span><span class="bound">xa</span> <span class="bound">ca</span> <span class="bound">ia</span><span class="main">.</span>
                 UB <span class="skolem">dir</span> <span class="var">?ss</span> <span class="bound">xa</span> <span class="main">=</span> Some <span class="bound">ca</span> <span class="main">⟶</span> UI <span class="skolem">dir</span> <span class="var">?ss</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">ia</span> <span class="main">⟶</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">ca</span><span class="main">)</span> <span class="main">∧</span>
             <span class="main">(</span><span class="main">∀</span><span class="bound">xa</span> <span class="bound">ca</span> <span class="bound">ia</span><span class="main">.</span>
                 LB <span class="skolem">dir</span> <span class="var">?ss</span> <span class="bound">xa</span> <span class="main">=</span> Some <span class="bound">ca</span> <span class="main">⟶</span> LI <span class="skolem">dir</span> <span class="var">?ss</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">ia</span> <span class="main">⟶</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="bound">xa</span> <span class="main">=</span> <span class="bound">ca</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">xa</span> <span class="bound">ca</span><span class="main">.</span> look <span class="main">(</span>UBI <span class="skolem">dir</span> <span class="var">?ss</span><span class="main">)</span> <span class="bound">xa</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="bound">ca</span><span class="main">)</span> <span class="main">∨</span> look <span class="main">(</span>LBI <span class="skolem">dir</span> <span class="var">?ss</span><span class="main">)</span> <span class="bound">xa</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="bound">ca</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id id2 <span class="keyword1"><span class="command">using</span></span> consistent <span class="keyword1"><span class="command">unfolding</span></span> curr_val_satisfies_no_lhs_def 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">⟨</span></span></span>𝒱 <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span><span class="main"><span class="main"><span class="main">⟩</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">from</span></span> consistent <span class="keyword1"><span class="command">have</span></span> val<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> curr_val_satisfies_no_lhs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="var">?ss</span>"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>UBI <span class="skolem">dir</span> <span class="var">?ss</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∨</span> look <span class="main">(</span>LBI <span class="skolem">dir</span> <span class="var">?ss</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> id3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>look <span class="main">(</span>LBI <span class="skolem">dir</span> <span class="skolem">ss</span><span class="main">)</span> <span class="skolem">yy</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">bb</span><span class="main">)</span> <span class="main">∨</span> look <span class="main">(</span>UBI <span class="skolem">dir</span> <span class="skolem">ss</span><span class="main">)</span> <span class="skolem">yy</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">bb</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">yy</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">bb</span> <span class="main">=</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">yy</span> <span class="skolem">bb</span> 
          <span class="keyword1"><span class="command">using</span></span> distinct_indices_stateD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> dist<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">yy</span></span> <span class="quoted"><span class="skolem">bb</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> dir
          <span class="keyword1"><span class="command">unfolding</span></span> ss<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsu_def boundsl_def indexu_def indexl_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s</span> <span class="main">∧</span> <span class="bound">v</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">update</span> <span class="skolem">y</span> <span class="skolem">b</span> <span class="skolem">s</span><span class="main">)</span><span class="main">⟩</span>"</span></span> 
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?v</span></span></span></span></span><span class="main"><span class="main">]</span></span> conjI<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> update_satisfies_tableau<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> False<span class="main">]</span> val 
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">from</span></span> update_valuation_nonlhs<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> False<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> False
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map2fun_def'<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> True            
          <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> normalized_tableau_def<span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> rhs <span class="main">`</span> set <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">interpret</span></span> Pivot <span class="quoted"><span class="free">eqlvar</span></span> <span class="quoted"><span class="free">pivot</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
          <span class="keyword1"><span class="command">interpret</span></span> PivotUpdate <span class="quoted"><span class="free">eqlvar</span></span> <span class="quoted"><span class="free">pivot</span></span> <span class="quoted"><span class="free">update</span></span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?eq</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="skolem">y</span>"</span></span> 
          <span class="keyword1"><span class="command">from</span></span> eq_for_lvar<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eq</span> <span class="main">∈</span> set <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"lhs <span class="var">?eq</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> zero <span class="keyword1"><span class="command">have</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"rhs <span class="var">?eq</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rvars_eq <span class="var">?eq</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vars_empty_zero<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"𝒱 <span class="main">(</span>pivot_and_update <span class="skolem">y</span> <span class="skolem">z</span> <span class="skolem">b</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?vv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?v</span><span class="main">⟩</span>"</span></span> 
          <span class="keyword1"><span class="command">from</span></span> pivotandupdate_valuation_xi<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> True z<span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"look <span class="var">?v</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">hence</span></span> vv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?vv</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> map2fun_def' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?vv</span></span></span></span></span><span class="main"><span class="main">]</span></span> conjI vv<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?vv</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pivotandupdate_satisfies_tableau<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> True z<span class="main">]</span> val <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id id2 ss<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> id3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id1 <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span>
    <span class="keyword3"><span class="command">assume</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> LE <span class="skolem">dir</span> <span class="skolem">x</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"lt <span class="skolem">dir</span> <span class="skolem">c</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">(</span>UB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">(</span>LB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P'</span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UBI <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LBI <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UB <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UI <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LI <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LE <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>GE <span class="skolem">dir</span><span class="main">)</span>
      <span class="main">(</span><span class="free">update</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="var">?s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * **
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> update_unsat_id tableau_valuated_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * update_unsat_id tableau_valuated_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ** <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_state_core <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_unsat_state_core_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ia</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">lt</span> <span class="bound">UBI</span> <span class="bound">LBI</span> <span class="bound">UB</span> <span class="bound">LB</span> <span class="bound">UBI_upd</span> <span class="bound">UI</span> <span class="bound">LI</span> <span class="bound">LE</span> <span class="bound">GE</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟨</span>𝒱 <span class="bound">s</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="bound">s</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ia
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> assert_bound_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">x</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">update</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="var">?s'</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span><span class="free">update</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="var">?s'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> *
        <span class="keyword1"><span class="command">using</span></span> update_satisfies_tableau<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> update_tableau_id
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> curr_val_satisfies_no_lhs_def tableau_valuated_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> curr_val_satisfies_no_lhs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">⟨</span>𝒱 <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∥</span> <span class="main">-</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">lt</span> <span class="bound">UBI</span> <span class="bound">LBI</span> <span class="bound">UB</span> <span class="bound">LB</span> <span class="bound">UB_upd</span> <span class="bound">UI</span> <span class="bound">LI</span> <span class="bound">LE</span> <span class="bound">GE</span> <span class="bound">s</span><span class="main">.</span>
      <span class="main">¬</span> 𝒰 <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">-</span> lvars <span class="main">(</span>𝒯 <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">lt</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="bound">s</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">LB</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="keyword1">⊴<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">lt</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="bound">s</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">UB</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">dir</span><span class="main">.</span> <span class="var">?P'</span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LE <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>GE <span class="bound">dir</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s'</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">s'</span> <span class="main">=</span> <span class="var">?P'</span> <span class="main">(&lt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> Leq Geq <span class="bound">s'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> xx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s'</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">s'</span> <span class="main">=</span> <span class="var">?P'</span> <span class="main">(&gt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> Geq Leq <span class="bound">s'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds_set.simps in_bounds.simps bound_compare_defs
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ia
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> assert_bound_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P'</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P''</span> <span class="skolem">dir</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span>  x<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> xx<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> curr_val_satisfies_no_lhs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="var">?s'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_bounds_set.simps curr_val_satisfies_no_lhs_def
            boundsl_def boundsu_def indexl_def indexu_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P''</span> <span class="skolem">dir</span> <span class="var">?s'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> x<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span><span class="main">]</span> xx<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">x</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lt <span class="skolem">dir</span> <span class="skolem">c</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P''</span> <span class="skolem">dir</span> <span class="var">?s'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_bounds_set.simps curr_val_satisfies_no_lhs_def
            <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def indexl_def indexu_def<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">x</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">update</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">(</span>LB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P''</span> <span class="skolem">dir</span> <span class="var">?s'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="var">?s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">-</span> lvars <span class="main">(</span>𝒯 <span class="var">?s'</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="var">?s'</span><span class="main">⟩</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir</span> <span class="var">?s'</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∧</span> <span class="keyword1">⊴<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="var">?s'</span><span class="main">⟩</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span>UB <span class="skolem">dir</span> <span class="var">?s'</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="main">-</span> lvars <span class="main">(</span>𝒯 <span class="var">?s'</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">(</span>LB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative›</span></span>
            <span class="keyword1"><span class="command">using</span></span> neg_bounds_compare<span class="main">(</span>7<span class="main">)</span> neg_bounds_compare<span class="main">(</span>3<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> *
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> update_valuation_nonlhs update_tableau_id update_bounds_id bound_compare''_defs map2fun_def tableau_valuated_def bounds_updates<span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare'_defs<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="main">-</span> lvars <span class="main">(</span>𝒯 <span class="var">?s'</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative›</span></span> *
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> update_valuation_nonlhs update_tableau_id update_bounds_id  bound_compare''_defs satisfies_bounds_set.simps curr_val_satisfies_no_lhs_def map2fun_def
                tableau_valuated_def bounds_updates<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x xx<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">◇</span> <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">lt</span> <span class="bound">UBI</span> <span class="bound">LBI</span> <span class="bound">UB</span> <span class="bound">LB</span> <span class="bound">UBI_upd</span> <span class="bound">UI</span> <span class="bound">LI</span> <span class="bound">LE</span> <span class="bound">GE</span> <span class="bound">s</span><span class="main">.</span>
      <span class="main">¬</span> 𝒰 <span class="bound">s</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">LB</span> <span class="bound">s</span> <span class="bound">x</span> <span class="main">=</span> None <span class="main">∨</span> <span class="bound">UB</span> <span class="bound">s</span> <span class="bound">x</span> <span class="main">=</span> None <span class="keyword1">then</span> True
           <span class="keyword1">else</span> <span class="bound">lt</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">LB</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">UB</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">LB</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="bound">UB</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">dir</span><span class="main">.</span> <span class="var">?P'</span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LE <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>GE <span class="bound">dir</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s'</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">s'</span> <span class="main">=</span> <span class="var">?P'</span> <span class="main">(&lt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> Leq Geq <span class="bound">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      xx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s'</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">s'</span> <span class="main">=</span> <span class="var">?P'</span> <span class="main">(&gt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> Geq Leq <span class="bound">s'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> bounds_consistent_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ia
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> assert_bound_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P'</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P''</span> <span class="skolem">dir</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">◇</span> <span class="skolem">s</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bounds_consistent_def<span class="main">)</span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">update</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">(</span>UB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">(</span>LB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P''</span> <span class="skolem">dir</span> <span class="var">?s'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">◇</span> <span class="skolem">s</span>›</span></span> *
        <span class="keyword1"><span class="command">unfolding</span></span> bounds_consistent_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> update_bounds_id tableau_valuated_def bounds_updates <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare'_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">xa</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">(</span>UB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">(</span>LB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P''</span> <span class="skolem">dir</span> <span class="var">?s'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">◇</span> <span class="skolem">s</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> bounds_consistent_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bounds_updates<span class="main">)</span>
          <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare'_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">xa</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P''</span> <span class="skolem">dir</span> <span class="var">?s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P''</span> <span class="skolem">dir</span> <span class="var">?s'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x xx<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">◇</span> <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> curr_val_satisfies_no_lhs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ats</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ats</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">lt</span> <span class="bound">UBI</span> <span class="bound">LBI</span> <span class="bound">UB</span> <span class="bound">LB</span> <span class="bound">UB_upd</span> <span class="bound">UI</span> <span class="bound">LI</span> <span class="bound">LE</span> <span class="bound">GE</span> <span class="bound">s'</span><span class="main">.</span> <span class="skolem">ats</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">ats</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">dir</span><span class="main">.</span> <span class="var">?P'</span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LE <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>GE <span class="bound">dir</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ats</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">ats</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ia
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> assert_bound_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P'</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> LE <span class="skolem">dir</span> <span class="skolem">x</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">(</span>UB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> atoms_equiv_bounds.simps satisfies_atom_set_def satisfies_bounds.simps
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set_unsat <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>LI <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>

      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> LE <span class="skolem">dir</span> <span class="skolem">x</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">(</span>UB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="var">?s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_unsat_bounds_id
        <span class="keyword1"><span class="command">using</span></span> atoms_equiv_bounds_extend<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">dir</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">ats</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> LE <span class="skolem">dir</span> <span class="skolem">x</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">(</span>UB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="var">?s'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> atoms_equiv_bounds_extend<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">dir</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">ats</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="var">?s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="var">?s'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">update</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="var">?s</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> LE <span class="skolem">dir</span> <span class="skolem">x</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">(</span>UB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="var">?s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="var">?s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="skolem">s</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tableau_valuated_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> update_bounds_id<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c</span></span></span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="var">?s'</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ</span> <span class="var">?s'</span> <span class="main">=</span> <span class="keyword1">ℬ</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> boundsl_def boundsu_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="var">?s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> LE <span class="skolem">dir</span> <span class="skolem">x</span> <span class="skolem">c</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> impI atoms_equiv_bounds_extend<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> *<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flat <span class="skolem">ats</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="skolem">s</span> <span class="main">⟹</span> flat <span class="main">(</span><span class="skolem">ats</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ia</span><span class="main">}</span><span class="main">)</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ia <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ats</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">dir</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="bound">dir</span> <span class="main">=</span> Negative <span class="main">⟹</span>
     <span class="main">∇</span> <span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">∇</span> <span class="bound">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">y</span> <span class="bound">I</span> <span class="main">.</span> <span class="main">∇</span> <span class="main">(</span>set_unsat <span class="bound">I</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">∇</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tableau_valuated_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">lt</span> <span class="bound">UBI</span> <span class="bound">LBI</span> <span class="bound">UB</span> <span class="bound">LB</span> <span class="bound">UB_upd</span> <span class="bound">UI</span> <span class="bound">LI</span> <span class="bound">LE</span> <span class="bound">GE</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">∇</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">dir</span><span class="main">.</span> <span class="var">?P'</span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LE <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>GE <span class="bound">dir</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ia
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> assert_bound_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P'</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="var">?s'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">dir</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="skolem">s</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="main">(</span>set_unsat <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>LI <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">]</span> <span class="var">?s'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">update</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="var">?s</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="var">?s'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="skolem">s</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> update_tableau_valuated<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tableau_valuated_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="skolem">s</span>›</span></span> *<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">as</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="skolem">as</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">dir</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="bound">dir</span> <span class="main">=</span> Negative <span class="main">⟹</span>
     <span class="main">∇</span> <span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">∇</span> <span class="bound">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">y</span> <span class="bound">I</span><span class="main">.</span> <span class="main">∇</span> <span class="main">(</span>set_unsat <span class="bound">I</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">∇</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tableau_valuated_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">as</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="var">?I</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> index_valid_mono<span class="main">[</span><span class="operator">OF</span> _ valid<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="skolem">I</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> index_valid <span class="skolem">I</span> <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">lt</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span>
    <span class="main">(</span><span class="bound">UBI</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> bounds_index<span class="main">)</span> <span class="main">(</span><span class="bound">LBI</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> bounds_index<span class="main">)</span>
    <span class="main">(</span><span class="bound">UB</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'a</span> bounds<span class="main">)</span> <span class="main">(</span><span class="bound">LB</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'a</span> bounds<span class="main">)</span>
    <span class="main">(</span><span class="bound">UBI_upd</span> <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> bounds_index <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> bounds_index<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state<span class="main">)</span>
    <span class="main">(</span><span class="bound">UI</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'i</span> bound_index<span class="main">)</span> <span class="main">(</span><span class="bound">LI</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'i</span> bound_index<span class="main">)</span>
    <span class="bound">LE</span> <span class="bound">GE</span> <span class="bound">s'</span><span class="main">.</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">.</span> look <span class="main">(</span><span class="bound">UBI</span> <span class="bound">s'</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">LE</span> <span class="main">(</span><span class="bound">x</span> <span class="main">::</span> var<span class="main">)</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">.</span> look <span class="main">(</span><span class="bound">LBI</span> <span class="bound">s'</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">GE</span> <span class="main">(</span><span class="bound">x</span> <span class="main">::</span> nat<span class="main">)</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">I</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="var">?P'</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">dir</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction<span class="main">)</span><span class="main">.</span>
    <span class="skolem">P</span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LE <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>GE <span class="bound">dir</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s'</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">s'</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">(&lt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> Leq Geq <span class="bound">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s'</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">s'</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">(&gt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> Geq Leq <span class="bound">s'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds_set.simps in_bounds.simps bound_compare_defs index_valid_def P_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> valid <span class="keyword1"><span class="command">have</span></span> P''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative <span class="main">⟹</span> <span class="var">?P''</span> <span class="skolem">dir</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">dir</span>
    <span class="keyword1"><span class="command">using</span></span> x<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> xx<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> UTrue<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative <span class="main">⟹</span> <span class="var">?P''</span> <span class="skolem">dir</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="var">?P''</span> <span class="skolem">dir</span> <span class="main">(</span>set_unsat <span class="skolem">I</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">I</span>
    <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def indexl_def indexu_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> updateIB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> LE <span class="skolem">dir</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="main">⟹</span> <span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative <span class="main">⟹</span> <span class="var">?P''</span> <span class="skolem">dir</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="var">?P''</span> <span class="skolem">dir</span>
    <span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">dir</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def indexl_def indexu_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"index_valid <span class="main">(</span>insert <span class="skolem">ia</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ia I_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> assert_bound_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">intro</span> UTrue x xx updateIB P''<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> LE <span class="skolem">dir</span> <span class="skolem">x</span> <span class="skolem">c</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> <span class="var">?s</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> id<span class="main">(</span>1<span class="main">)</span> ** * <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> id<span class="main">(</span>1<span class="main">)</span> ** * <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P''</span> <span class="skolem">dir</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> updateIB P''<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> update_id<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">,</span> <span class="operator">OF</span> 1 2 3<span class="main">,</span> <span class="operator">unfolded</span> Let_def<span class="main">]</span>  **<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UBI <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LBI <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UB <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UI <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LI <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LE <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>GE <span class="skolem">dir</span><span class="main">)</span>
        <span class="main">(</span><span class="free">update</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> P_def s'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ats</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom set"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ats<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ats</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">dir</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="bound">dir</span> <span class="main">=</span> Negative <span class="main">⟹</span>
     <span class="main">∇</span> <span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">∇</span> <span class="bound">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">I</span><span class="main">.</span> <span class="main">∇</span> <span class="main">(</span>set_unsat <span class="bound">I</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">∇</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tableau_valuated_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> idlt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">≤</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">c</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">≥</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">c</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> insert <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">ats</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">s</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state<span class="main">)</span><span class="main">.</span> <span class="skolem">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">bs</span> <span class="main">(</span><span class="bound">lt</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span>
    <span class="main">(</span><span class="bound">UBI</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> bounds_index<span class="main">)</span> <span class="main">(</span><span class="bound">LBI</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> bounds_index<span class="main">)</span>
    <span class="main">(</span><span class="bound">UB</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'a</span> bounds<span class="main">)</span> <span class="main">(</span><span class="bound">LB</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'a</span> bounds<span class="main">)</span>
    <span class="main">(</span><span class="bound">UBI_upd</span> <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> bounds_index <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> bounds_index<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state<span class="main">)</span>
    <span class="bound">UI</span> <span class="bound">LI</span>
    <span class="main">(</span><span class="bound">LE</span> <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> atom<span class="main">)</span> <span class="main">(</span><span class="bound">GE</span> <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> atom<span class="main">)</span> <span class="bound">s'</span><span class="main">.</span>
       <span class="main">(</span><span class="main">∀</span> <span class="bound">I</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">I</span> <span class="main">::</span> <span class="tfree">'i</span> set<span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">bs</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">LB</span> <span class="bound">s'</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">c</span> <span class="main">⟶</span> <span class="bound">LI</span> <span class="bound">s'</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">I</span> <span class="main">⟶</span> <span class="bound">lt</span> <span class="bound">c</span> <span class="main">(</span><span class="bound">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">v</span> <span class="bound">x</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">UB</span> <span class="bound">s'</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">c</span> <span class="main">⟶</span> <span class="bound">UI</span> <span class="bound">s'</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">I</span> <span class="main">⟶</span> <span class="bound">lt</span> <span class="main">(</span><span class="bound">v</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">c</span> <span class="main">∨</span> <span class="bound">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">=</span> <span class="var">?Q</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="skolem">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> equiv<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="skolem">s'</span> <span class="main">⟷</span> <span class="skolem">Q</span> <span class="skolem">bs</span> <span class="main">(&lt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> Leq Geq <span class="skolem">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="skolem">s'</span> <span class="main">⟷</span> <span class="skolem">Q</span> <span class="skolem">bs</span> <span class="main">(&gt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> Geq Leq <span class="skolem">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">bs</span> <span class="skolem">s'</span>
    <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds_set.simps in_bounds.simps bound_compare_defs index_valid_def Q_def
      atoms_imply_bounds_index.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">intro</span> conjI iff_exI allI arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(∧)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> refl iff_allI
          arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(=)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">unfold</span> satisfies_bounds_index.simps idlt<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s'</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">s'</span> <span class="main">=</span> <span class="var">?P'</span> <span class="main">(&lt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> Leq Geq <span class="bound">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s'</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">s'</span> <span class="main">=</span> <span class="var">?P'</span> <span class="main">(&gt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> Geq Leq <span class="bound">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> ats equiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ats</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> Q_ats<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="skolem">ats</span> <span class="main">(&lt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> Leq Geq <span class="skolem">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="skolem">ats</span> <span class="main">(&gt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> Geq Leq <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P''</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">dir</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction<span class="main">)</span><span class="main">.</span> <span class="var">?P'</span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LBI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LB <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UBI_upd <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>UI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LI <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>LE <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>GE <span class="bound">dir</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> P_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative <span class="main">⟹</span> <span class="var">?P''</span> <span class="skolem">dir</span> <span class="main">(</span>set_unsat <span class="skolem">I</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="var">?P''</span> <span class="skolem">dir</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">I</span> <span class="skolem">dir</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Q_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iff_exI arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(∧)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> refl iff_allI arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(=)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span>
        arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(⟶)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def indexl_def indexu_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> P_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative <span class="main">⟹</span> <span class="var">?P''</span> <span class="skolem">dir</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="var">?P''</span> <span class="skolem">dir</span> <span class="main">(</span>set_unsat <span class="skolem">I</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">I</span> <span class="skolem">dir</span>
    <span class="keyword1"><span class="command">using</span></span> P_upd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">dir</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> ats_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ats</span> <span class="main">⊆</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> dir<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> LE <span class="skolem">dir</span> <span class="skolem">x</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Q_ats dir
    <span class="keyword1"><span class="command">have</span></span> Q_ats<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="skolem">ats</span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UBI <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LBI <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UB <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>UI <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LI <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>LE <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>GE <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P''</span> <span class="skolem">dir</span> <span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Q_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="skolem">v</span> <span class="skolem">y</span> <span class="skolem">d</span>
      <span class="keyword3"><span class="command">assume</span></span> IvA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> i_satisfies_atom_set_mono<span class="main">[</span><span class="operator">OF</span> ats_sub this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">ats</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> Q_ats<span class="main">[</span><span class="operator">unfolded</span> Q_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> s_bnds<span class="main">:</span>
        <span class="quoted"><span class="quoted">"LB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">c</span> <span class="main">⟹</span> LI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">⟹</span> lt <span class="skolem">dir</span> <span class="skolem">c</span> <span class="main">(</span><span class="skolem">v</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">v</span> <span class="skolem">x</span>"</span></span>
        <span class="quoted"><span class="quoted">"UB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">c</span> <span class="main">⟹</span> UI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">⟹</span> lt <span class="skolem">dir</span> <span class="main">(</span><span class="skolem">v</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">∨</span> <span class="skolem">v</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> IvA<span class="main">[</span><span class="operator">unfolded</span> A_def<span class="main">,</span> <span class="operator">unfolded</span> i_satisfies_atom_set.simps satisfies_atom_set_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> va<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">⟹</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> a dir <span class="keyword1"><span class="command">have</span></span> vc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">⟹</span> lt <span class="skolem">dir</span> <span class="main">(</span><span class="skolem">v</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">∨</span> <span class="skolem">v</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LB <span class="skolem">dir</span> <span class="var">?s</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="skolem">d</span> <span class="main">⟹</span> LI <span class="skolem">dir</span> <span class="var">?s</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">⟹</span> lt <span class="skolem">dir</span> <span class="skolem">d</span> <span class="main">(</span><span class="skolem">v</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">v</span> <span class="skolem">y</span>"</span></span>
        <span class="quoted"><span class="quoted">"UB <span class="skolem">dir</span> <span class="var">?s</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="skolem">d</span> <span class="main">⟹</span> UI <span class="skolem">dir</span> <span class="var">?s</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">⟹</span> lt <span class="skolem">dir</span> <span class="main">(</span><span class="skolem">v</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">d</span> <span class="main">∨</span> <span class="skolem">v</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>main<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"UI <span class="skolem">dir</span> <span class="var">?s</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="main">|</span>
          <span class="main">(</span>easy1<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>easy2<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"UI <span class="skolem">dir</span> <span class="var">?s</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> easy1
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> s_bnds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">d</span></span></span></span><span class="main">]</span> dir <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def indexl_def indexu_def<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> easy2
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> s_bnds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">d</span></span></span></span><span class="main">]</span> dir <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def indexl_def indexu_def<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> main
          <span class="keyword1"><span class="command">note</span></span> s_bnds <span class="main">=</span> s_bnds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span><span class="main">]</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> main <span class="keyword1"><span class="command">using</span></span> s_bnds dir vc
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def indexl_def indexu_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> Ps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative <span class="main">⟹</span> <span class="var">?P''</span> <span class="skolem">dir</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">dir</span>
    <span class="keyword1"><span class="command">using</span></span> Q_ats <span class="keyword1"><span class="command">unfolding</span></span> Q_def <span class="keyword1"><span class="command">using</span></span> i_satisfies_atom_set_mono<span class="main">[</span><span class="operator">OF</span> ats_sub<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>assert_bound <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> assert_bound_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P'</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">intro</span> x xx P_upd main Ps<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">x</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> LE <span class="skolem">dir</span> <span class="skolem">x</span> <span class="skolem">c</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"updateℬℐ <span class="main">(</span>UBI_upd <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> <span class="var">?s</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> main<span class="main">[</span><span class="operator">OF</span> **<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P''</span> <span class="skolem">dir</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s'_def <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> id<span class="main">(</span>1<span class="main">)</span> ** * <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> id<span class="main">(</span>1<span class="main">)</span> ** * <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">unfolding</span></span> s'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> update_bounds_id<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c</span></span></span></span></span></span></span></span><span class="main">]</span> **<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P''</span> <span class="skolem">dir</span> <span class="main">(</span><span class="free">update</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">=</span> <span class="var">?P''</span> <span class="skolem">dir</span> <span class="skolem">s'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Q_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iff_allI arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(⟶)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(∧)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> P
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P''</span> <span class="skolem">dir</span> <span class="main">(</span><span class="free">update</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">ia</span> <span class="skolem">ats</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="main">(</span>assert_bound <span class="skolem">ia</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ia A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pivoting the tableau can be reduced to pivoting single equations,
  and substituting variable by polynomials. These operations are specified
  by:›</span></span>

<span class="keyword1"><span class="command">locale</span></span> PivotEq <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">pivot_eq</span><span class="main">::</span><span class="quoted"><span class="quoted">"eq <span class="main">⇒</span> var <span class="main">⇒</span> eq"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="comment1">― ‹Lhs var of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">eq</span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">x<span class="hidden">⇩</span><sub>j</sub></span><span class="antiquote">}</span></span> are swapped,
     while the other variables do not change sides.›</span>
    vars_pivot_eq<span class="main">:</span><span class="quoted"><span class="quoted">"
<span class="main">⟦</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="free">eq</span><span class="main">;</span> lhs <span class="free">eq</span> <span class="main">∉</span> rvars_eq <span class="free">eq</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1">let</span> <span class="bound">eq'</span> <span class="main">=</span> <span class="free">pivot_eq</span> <span class="free">eq</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">in</span>
    lhs <span class="bound">eq'</span> <span class="main">=</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∧</span> rvars_eq <span class="bound">eq'</span> <span class="main">=</span> <span class="main">{</span>lhs <span class="free">eq</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>rvars_eq <span class="free">eq</span> <span class="main">-</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹Pivoting keeps the equation equisatisfiable.›</span>

equiv_pivot_eq<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="free">eq</span><span class="main">;</span> lhs <span class="free">eq</span> <span class="main">∉</span> rvars_eq <span class="free">eq</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">v</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>lrv valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">pivot_eq</span> <span class="free">eq</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">eq</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lhs_pivot_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="free">eq</span><span class="main">;</span> lhs <span class="free">eq</span> <span class="main">∉</span> rvars_eq <span class="free">eq</span> <span class="main">⟧</span> <span class="main">⟹</span> lhs <span class="main">(</span><span class="free">pivot_eq</span> <span class="free">eq</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vars_pivot_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rvars_pivot_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="free">eq</span><span class="main">;</span> lhs <span class="free">eq</span> <span class="main">∉</span> rvars_eq <span class="free">eq</span> <span class="main">⟧</span> <span class="main">⟹</span> rvars_eq <span class="main">(</span><span class="free">pivot_eq</span> <span class="free">eq</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>lhs <span class="free">eq</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>rvars_eq <span class="free">eq</span> <span class="main">-</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vars_pivot_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">doublesub</span> <span class="main">(</span><span class="quoted">" _ <span class="keyword1">⊆s</span> _ <span class="keyword1">⊆s</span> _"</span> <span class="main">[</span>50<span class="main">,</span>51<span class="main">,</span>51<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">doublesub</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>


<span class="keyword1"><span class="command">locale</span></span> SubstVar <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subst_var</span><span class="main">::</span><span class="quoted"><span class="quoted">"var <span class="main">⇒</span> linear_poly <span class="main">⇒</span> linear_poly <span class="main">⇒</span> linear_poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="comment1">― ‹Effect of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"subst_var x<span class="hidden">⇩</span><sub>j</sub> lp' lp"</span><span class="antiquote">}</span></span> on <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">lp</span><span class="antiquote">}</span></span> variables.›</span>

vars_subst_var'<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span>vars <span class="free">lp</span> <span class="main">-</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> vars <span class="free">lp'</span> <span class="keyword1">⊆s</span> vars <span class="main">(</span><span class="free">subst_var</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">lp'</span> <span class="free">lp</span><span class="main">)</span> <span class="keyword1">⊆s</span> <span class="main">(</span>vars <span class="free">lp</span> <span class="main">-</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> vars <span class="free">lp'</span>"</span></span><span class="keyword2"><span class="keyword">and</span></span>

subst_no_effect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∉</span> vars <span class="free">lp</span> <span class="main">⟹</span> <span class="free">subst_var</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">lp'</span> <span class="free">lp</span> <span class="main">=</span> <span class="free">lp</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

subst_with_effect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> vars <span class="free">lp</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> vars <span class="free">lp'</span> <span class="main">-</span> vars <span class="free">lp</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> vars <span class="main">(</span><span class="free">subst_var</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">lp'</span> <span class="free">lp</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

<span class="comment1">― ‹Effect of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"subst_var x<span class="hidden">⇩</span><sub>j</sub> lp' lp"</span><span class="antiquote">}</span></span> on <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">lp</span><span class="antiquote">}</span></span> value.›</span>

equiv_subst_var<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">::</span> lrv valuation<span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">=</span> <span class="free">lp'</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span> <span class="main">⟶</span> <span class="free">lp</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">(</span><span class="free">subst_var</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">lp'</span> <span class="free">lp</span><span class="main">)</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vars_subst_var<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars <span class="main">(</span><span class="free">subst_var</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">lp'</span> <span class="free">lp</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>vars <span class="free">lp</span> <span class="main">-</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> vars <span class="free">lp'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vars_subst_var'
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_subst_var_supset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars <span class="main">(</span><span class="free">subst_var</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">lp'</span> <span class="free">lp</span><span class="main">)</span> <span class="main">⊇</span> <span class="main">(</span>vars <span class="free">lp</span> <span class="main">-</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> vars <span class="free">lp'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vars_subst_var'
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_var_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> linear_poly <span class="main">⇒</span> eq <span class="main">⇒</span> eq"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_var_eq</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">lp'</span></span></span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">≡</span> <span class="main">(</span>lhs <span class="free"><span class="bound"><span class="entity">eq</span></span></span><span class="main">,</span> <span class="free">subst_var</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">lp'</span></span></span> <span class="main">(</span>rhs <span class="free"><span class="bound"><span class="entity">eq</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rvars_eq_subst_var_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rvars_eq <span class="main">(</span>subst_var_eq <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">lp</span> <span class="free">eq</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>rvars_eq <span class="free">eq</span> <span class="main">-</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> vars <span class="free">lp</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_var_eq_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vars_subst_var<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rvars_eq_subst_var_eq_supset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rvars_eq <span class="main">(</span>subst_var_eq <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">lp</span> <span class="free">eq</span><span class="main">)</span> <span class="main">⊇</span> <span class="main">(</span>rvars_eq <span class="free">eq</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span> <span class="main">-</span> <span class="main">(</span>vars <span class="free">lp</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_var_eq_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vars_subst_var_supset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> equiv_subst_var_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">,</span> <span class="free">lp'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">eq</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> subst_var_eq <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">lp'</span> <span class="free">eq</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> subst_var_eq_def
  <span class="keyword1"><span class="command">unfolding</span></span> satisfies_eq_def
  <span class="keyword1"><span class="command">using</span></span> equiv_subst_var<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="free">lp'</span></span> <span class="quoted"><span class="quoted">"rhs <span class="free">eq</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> Pivot' <span class="main">=</span> EqForLVar <span class="main">+</span> PivotEq <span class="main">+</span> SubstVar
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pivot_tableau'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> var <span class="main">⇒</span> tableau <span class="main">⇒</span> tableau"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pivot_tableau'</span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>j</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span>
    <span class="keyword1">let</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub>_idx</span> <span class="main">=</span> <span class="free">eq_idx_for_lvar</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span><span class="main">;</span> <span class="bound">eq</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">!</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub>_idx</span><span class="main">;</span> <span class="bound">eq'</span> <span class="main">=</span> <span class="free">pivot_eq</span> <span class="bound">eq</span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>j</sub></span></span></span> <span class="keyword1">in</span>
    map <span class="main">(</span><span class="main">λ</span> <span class="bound">idx</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">idx</span> <span class="main">=</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub>_idx</span> <span class="keyword1">then</span>
                    <span class="bound">eq'</span>
                <span class="keyword1">else</span>
                    subst_var_eq <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>j</sub></span></span></span> <span class="main">(</span>rhs <span class="bound">eq'</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">!</span> <span class="bound">idx</span><span class="main">)</span>
        <span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pivot'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> var <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pivot'</span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>j</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> 𝒯_update <span class="main">(</span>pivot_tableau' <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>j</sub></span></span></span> <span class="main">(</span>𝒯 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\noindent Then, the next implementation of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>pivot›</span></span></span></span> satisfies its specification:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pivot_tableau</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> var <span class="main">⇒</span> tableau <span class="main">⇒</span> tableau"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pivot_tableau</span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>j</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">eq</span> <span class="main">=</span> eq_for_lvar <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span><span class="main">;</span> <span class="bound">eq'</span> <span class="main">=</span> <span class="free">pivot_eq</span> <span class="bound">eq</span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>j</sub></span></span></span> <span class="keyword1">in</span>
    map <span class="main">(</span><span class="main">λ</span> <span class="bound">e</span><span class="main">.</span> <span class="keyword1">if</span> lhs <span class="bound">e</span> <span class="main">=</span> lhs <span class="bound">eq</span> <span class="keyword1">then</span> <span class="bound">eq'</span> <span class="keyword1">else</span> subst_var_eq <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>j</sub></span></span></span> <span class="main">(</span>rhs <span class="bound">eq'</span><span class="main">)</span> <span class="bound">e</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pivot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> var <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pivot</span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>j</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> 𝒯_update <span class="main">(</span>pivot_tableau <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>j</sub></span></span></span> <span class="main">(</span>𝒯 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pivot_tableau'pivot_tableau<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pivot_tableau' <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">t</span> <span class="main">=</span> pivot_tableau <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">idx</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">idx</span> <span class="main">=</span> <span class="free">eq_idx_for_lvar</span> <span class="free">t</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">then</span> <span class="free">pivot_eq</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">eq_idx_for_lvar</span> <span class="free">t</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span>
          <span class="keyword1">else</span> subst_var_eq <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">(</span>rhs <span class="main">(</span><span class="free">pivot_eq</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">eq_idx_for_lvar</span> <span class="free">t</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">idx</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="keyword1">if</span> lhs <span class="bound">e</span> <span class="main">=</span> lhs <span class="main">(</span>eq_for_lvar <span class="free">t</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">pivot_eq</span> <span class="main">(</span>eq_for_lvar <span class="free">t</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">else</span> subst_var_eq <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">(</span>rhs <span class="main">(</span><span class="free">pivot_eq</span> <span class="main">(</span>eq_for_lvar <span class="free">t</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span><span class="main">)</span> <span class="bound">e</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">t</span><span class="main">.</span> <span class="var">?f'</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> set <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="free">eq_idx_for_lvar</span> <span class="free">t</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> set <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">eq_idx_for_lvar</span> <span class="free">t</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq_for_lvar<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="free">t</span>›</span></span> eq_idx_for_lvar<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_for_lvar_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lhs <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> lhs <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">eq_idx_for_lvar</span> <span class="free">t</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="free">eq_idx_for_lvar</span> <span class="free">t</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="free">t</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_map inj_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lhs <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> lhs <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">eq_idx_for_lvar</span> <span class="free">t</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">eq_idx_for_lvar</span> <span class="free">t</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">eq_idx_for_lvar</span> <span class="free">t</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">&lt;</span> length <span class="free">t</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f'</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_for_lvar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pivot_tableau' <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">t</span> <span class="main">=</span> pivot_tableau <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pivot_tableau'_def pivot_tableau_def
    <span class="keyword1"><span class="command">unfolding</span></span> Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_reindex<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pivot'pivot<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span>state"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pivot' <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span> <span class="main">=</span> pivot <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pivot_tableau'pivot_tableau<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> pivot_def pivot'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">sublocale</span></span> Pivot' <span class="main">&lt;</span> Pivot <span class="quoted"><span class="free">eq_idx_for_lvar</span></span> <span class="quoted">pivot</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">v</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> valuation"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> pivot <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span> <span class="keyword1">in</span> 𝒱 <span class="bound">s'</span> <span class="main">=</span> 𝒱 <span class="skolem">s</span> <span class="main">∧</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">s'</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s</span> <span class="main">∧</span> 𝒰 <span class="bound">s'</span> <span class="main">=</span> 𝒰 <span class="skolem">s</span> <span class="main">∧</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="bound">s'</span> <span class="main">=</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pivot_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def indexl_def indexu_def<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"𝒯 <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?idx</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">eq_idx_for_lvar</span> <span class="var">?t</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?eq</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">!</span> <span class="var">?idx</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?eq'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">pivot_eq</span> <span class="var">?eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?idx</span> <span class="main">&lt;</span> length <span class="var">?t</span>"</span></span> <span class="quoted"><span class="quoted">"lhs <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="var">?idx</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="var">?t</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq_idx_for_lvar
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map lhs <span class="var">?t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="var">?t</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eq_for_lvar_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars <span class="var">?t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?idx</span> <span class="main">&lt;</span> length <span class="var">?t</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_set_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?eq</span></span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rvars_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∉</span> lvars <span class="var">?t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="var">?t</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∉</span> rvars <span class="var">?t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="var">?t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="var">?t</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def rvars_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∉</span> rvars_eq <span class="var">?eq</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rvars_def
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?idx</span> <span class="main">&lt;</span> length <span class="var">?t</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_set_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?eq</span></span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">≠</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∉</span> rvars_eq <span class="var">?eq</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eq'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">,</span> rhs <span class="var">?eq'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lhs_pivot_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="var"><span class="quoted"><span class="var">?eq</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹lhs <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="var">?idx</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∉</span> rvars_eq <span class="var">?eq</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_for_lvar_def<span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?eq'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="var">?idx</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?idx</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span>length <span class="var">?t</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="var">?t</span><span class="main">]</span> <span class="main">=</span> <span class="var">?I1</span> <span class="main">@</span> <span class="main">[</span><span class="var">?idx</span><span class="main">]</span> <span class="main">@</span> <span class="var">?I2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?idx</span> <span class="main">&lt;</span> length <span class="var">?t</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> interval_3split<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> map_lhs_pivot<span class="main">:</span>
    <span class="quoted"><span class="quoted">"map lhs <span class="main">(</span>𝒯 <span class="main">(</span>pivot' <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     map <span class="main">(</span><span class="main">λ</span><span class="bound">idx</span><span class="main">.</span> lhs <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="bound">idx</span><span class="main">)</span><span class="main">)</span> <span class="var">?I1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">]</span> <span class="main">@</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">idx</span><span class="main">.</span> lhs <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="bound">idx</span><span class="main">)</span><span class="main">)</span> <span class="var">?I2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹lhs <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="var">?idx</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∉</span> rvars_eq <span class="var">?eq</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def subst_var_eq_def eq_for_lvar_def lhs_pivot_eq pivot'_def pivot_tableau'_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> lvars_pivot<span class="main">:</span> <span class="quoted"><span class="quoted">"lvars <span class="main">(</span>𝒯 <span class="main">(</span>pivot' <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lvars <span class="main">(</span>𝒯 <span class="main">(</span>pivot' <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">λ</span><span class="bound">idx</span><span class="main">.</span> lhs <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="bound">idx</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length<span class="var">?t</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?idx</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?idx</span> <span class="main">&lt;</span> length <span class="var">?t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?eq'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">,</span> rhs <span class="var">?eq'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?eq'</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def pivot'_def pivot_tableau'_def lvars_def subst_var_eq_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">idx</span><span class="main">.</span> lhs <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="bound">idx</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length<span class="var">?t</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>lhs <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="var">?idx</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?idx</span> <span class="main">&lt;</span> length <span class="var">?t</span>›</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span>map lhs <span class="var">?t</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>set <span class="main">(</span>map lhs <span class="var">?t</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹lhs <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="var">?idx</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth rev_image_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lvars <span class="main">(</span>𝒯 <span class="main">(</span>pivot' <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lvars_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> rvars_pivot<span class="main">:</span> <span class="quoted"><span class="quoted">"rvars <span class="main">(</span>𝒯 <span class="main">(</span>pivot' <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        rvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rvars_eq <span class="var">?eq'</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>rvars_eq <span class="var">?eq</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rvars_pivot_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="var"><span class="quoted"><span class="var">?eq</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹lhs <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="var">?idx</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∉</span> rvars_eq <span class="var">?eq</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rvars_eq <span class="var">?eq'</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="bound">idx</span><span class="main">∈</span><span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="var">?t</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?idx</span><span class="main">}</span><span class="main">)</span><span class="main">.</span>
                  rvars_eq <span class="main">(</span>subst_var_eq <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">(</span>rhs <span class="var">?eq'</span><span class="main">)</span> <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="bound">idx</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rvars <span class="main">(</span>𝒯 <span class="main">(</span>pivot' <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?S1</span> <span class="main">∪</span> <span class="var">?S2</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pivot'_def pivot_tableau'_def rvars_def
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?idx</span> <span class="main">&lt;</span> length <span class="var">?t</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>rvars <span class="var">?t</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S1</span> <span class="main">∪</span> <span class="var">?S2</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S1</span> <span class="main">∪</span> <span class="var">?S2</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S1</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?idx</span> <span class="main">&lt;</span> length <span class="var">?t</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> rvars_def
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rvars_eq <span class="var">?eq'</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>rvars_eq <span class="var">?eq</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S2</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S2</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">idx</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="var">?t</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>rvars_eq <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="bound">idx</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> rvars_eq <span class="var">?eq'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> UN_mono<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> rvars_eq_subst_var_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> rvars_eq <span class="var">?eq'</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">idx</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="var">?t</span><span class="main">}</span><span class="main">.</span> rvars_eq <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="bound">idx</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> rvars_eq <span class="var">?eq'</span> <span class="main">∪</span> <span class="main">(</span>rvars <span class="var">?t</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> rvars_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rvars_eq <span class="var">?eq'</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>rvars_eq <span class="var">?eq</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> rvars_def
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?idx</span> <span class="main">&lt;</span> length <span class="var">?t</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⊆</span> <span class="var">?S1</span> <span class="main">∪</span> <span class="var">?S2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S1</span> <span class="main">∪</span> <span class="var">?S2</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq'</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S2'</span></span></span>  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="bound">idx</span><span class="main">∈</span><span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="var">?t</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?idx</span><span class="main">}</span><span class="main">)</span><span class="main">.</span>
                        <span class="main">(</span>rvars_eq <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="bound">idx</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> rvars_eq <span class="var">?eq'</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S2'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?rhs</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rvars_eq <span class="var">?eq'</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>rvars_eq <span class="var">?eq</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> rvars_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S2</span> <span class="main">⊇</span> <span class="var">?S2'</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> UN_mono<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> rvars_eq_subst_var_eq_supset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="quoted">"rhs <span class="var">?eq'</span>"</span></span> <span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> pivot <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span> <span class="keyword1">in</span> rvars <span class="main">(</span>𝒯 <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> rvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span> <span class="main">∧</span> lvars <span class="main">(</span>𝒯 <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pivot'pivot<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'i</span> <span class="main"><span class="main">=</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'i</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span>pivot' <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lvars <span class="main">(</span>𝒯 <span class="main">(</span>pivot' <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span>pivot' <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def
      <span class="keyword1"><span class="command">using</span></span> lvars_pivot rvars_pivot
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">≠</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> rhs <span class="main">`</span> set <span class="main">(</span>𝒯 <span class="main">(</span>pivot' <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?eq</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> eq_for_lvar<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eq</span> <span class="main">∈</span> set <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> var<span class="main">:</span> <span class="quoted"><span class="quoted">"lhs <span class="var">?eq</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lhs <span class="var">?eq</span> <span class="main">∉</span> rvars_eq <span class="var">?eq</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?eq</span> <span class="main">∈</span> set <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∉</span> rvars_eq <span class="main">(</span>𝒯 <span class="skolem">s</span> <span class="main">!</span> <span class="free">eq_idx_for_lvar</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>›</span></span> eq_for_lvar_def var <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> vars_pivot_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>›</span></span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> vars_pivot<span class="main">:</span> <span class="quoted"><span class="quoted">"lhs <span class="main">(</span><span class="free">pivot_eq</span> <span class="var">?eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span> <span class="quoted"><span class="quoted">"rvars_eq <span class="main">(</span><span class="free">pivot_eq</span> <span class="var">?eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>lhs <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>rvars_eq <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> vars_pivot<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> rhs_pivot0<span class="main">:</span> <span class="quoted"><span class="quoted">"rhs <span class="main">(</span><span class="free">pivot_eq</span> <span class="var">?eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> vars_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> rhs <span class="main">`</span> set <span class="main">(</span>𝒯 <span class="main">(</span>pivot' <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> pivot'pivot<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span> pivot_def<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> rhs <span class="main">`</span> set <span class="main">(</span>pivot_tableau <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> pivot_tableau_def Let_def var<span class="main">,</span> <span class="operator">unfolded</span> var<span class="main">]</span> rhs_pivot0
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> set <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"lhs <span class="skolem">e</span> <span class="main">≠</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rvars_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"rvars_eq <span class="main">(</span>subst_var_eq <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">(</span>rhs <span class="main">(</span><span class="free">pivot_eq</span> <span class="var">?eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_zero<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> rvars_eq<span class="main">[</span><span class="operator">unfolded</span> subst_var_eq_def<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"vars <span class="main">(</span><span class="free">subst_var</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">(</span>rhs <span class="main">(</span><span class="free">pivot_eq</span> <span class="var">?eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rhs <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> vars <span class="main">(</span>rhs <span class="skolem">e</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">from</span></span> empty<span class="main">[</span><span class="operator">unfolded</span> subst_no_effect<span class="main"><span class="main">[</span></span><span class="operator">OF</span> False<span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rvars_eq <span class="skolem">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rhs <span class="skolem">e</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zero_coeff_zero coeff_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">∈</span> set <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">∈</span> set <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rvars_eq <span class="skolem">e</span> <span class="main">⊆</span> rvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rvars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> vars <span class="main">(</span>rhs <span class="main">(</span><span class="free">pivot_eq</span> <span class="var">?eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> rvars_eq <span class="skolem">e</span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> vars_pivot<span class="main">(</span>2<span class="main">)</span> var 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> normalized_tableau_def<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> subst_with_effect<span class="main">[</span><span class="operator">OF</span> True this<span class="main">]</span> rvars_eq
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_var_eq_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span> <span class="main">∧</span> <span class="var">?g2</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map lhs <span class="main">(</span>𝒯 <span class="main">(</span>pivot' <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> map_parametrize_idx<span class="main">[</span><span class="operator">of</span> <span class="quoted">lhs</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> map_lhs_pivot
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span>map lhs <span class="var">?t</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> interval_3split<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?idx</span></span></span> <span class="quoted"><span class="quoted">"length <span class="var">?t</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="var">?idx</span> <span class="main">&lt;</span> length <span class="var">?t</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∉</span> lvars <span class="var">?t</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lvars_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?t</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span>pivot' <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> satisfies_tableau_def
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span>set <span class="main">(</span><span class="var">?t</span><span class="main">)</span><span class="main">.</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">e</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span>set <span class="main">(</span>𝒯 <span class="main">(</span>pivot' <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">e</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="var">?eq'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∉</span> rvars_eq <span class="var">?eq</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?idx</span> <span class="main">&lt;</span> length <span class="var">?t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span>set <span class="main">(</span><span class="var">?t</span><span class="main">)</span><span class="main">.</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">e</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="var">?t</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_pivot_eq eq_idx_for_lvar<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">idx</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> length <span class="var">?t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">≠</span> <span class="var">?idx</span>"</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> subst_var_eq <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">(</span>rhs <span class="var">?eq'</span><span class="main">)</span> <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="skolem">idx</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?eq'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">,</span> rhs <span class="var">?eq'</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="var">?eq'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">idx</span> <span class="main">&lt;</span> length <span class="var">?t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span>set <span class="main">(</span><span class="var">?t</span><span class="main">)</span><span class="main">.</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">e</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> equiv_subst_var_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="quoted">"rhs <span class="var">?eq'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">!</span> <span class="skolem">idx</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pivot'_def pivot_tableau'_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span>set <span class="main">(</span>𝒯 <span class="main">(</span>pivot' <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">e</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="var">?eq'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">idx</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">idx</span> <span class="main">&lt;</span> length <span class="var">?t</span><span class="main">;</span> <span class="bound">idx</span> <span class="main">≠</span> <span class="var">?idx</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> subst_var_eq <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">(</span>rhs <span class="var">?eq'</span><span class="main">)</span> <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="bound">idx</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?idx</span> <span class="main">&lt;</span> length <span class="var">?t</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pivot'_def pivot_tableau'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span>set <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">e</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">idx</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> length <span class="var">?t</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="skolem">idx</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">=</span> <span class="var">?idx</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="var">?eq'</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="var">?t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∉</span> rvars_eq <span class="var">?eq</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_idx_for_lvar equiv_pivot_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">idx</span> <span class="main">&lt;</span> length <span class="var">?t</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟦</span><span class="skolem">idx</span> <span class="main">&lt;</span> length <span class="var">?t</span><span class="main">;</span> <span class="skolem">idx</span> <span class="main">≠</span> <span class="var">?idx</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> subst_var_eq <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">(</span>rhs <span class="var">?eq'</span><span class="main">)</span> <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="skolem">idx</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="var">?eq'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?eq'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">,</span> rhs <span class="var">?eq'</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> equiv_subst_var_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="quoted">"rhs <span class="var">?eq'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">!</span> <span class="skolem">idx</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> pivot <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">s</span> <span class="keyword1">in</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="bound">s'</span> <span class="main">∧</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="bound">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pivot'pivot<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'i</span> <span class="main"><span class="main">=</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'i</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Check implementation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check›</span></span></span></span> function is called when all rhs variables are
in bounds, and it checks if there is a lhs variable that is not. If
there is no such variable, then satisfiability is detected and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check›</span></span></span></span> succeeds. If there is a lhs variable <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x<span class="hidden">⇩</span><sub>i</sub>›</span></span></span></span> out of its
bounds, a rhs variable <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x<span class="hidden">⇩</span><sub>j</sub>›</span></span></span></span> is sought which allows pivoting
with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x<span class="hidden">⇩</span><sub>i</sub>›</span></span></span></span> and updating <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x<span class="hidden">⇩</span><sub>i</sub>›</span></span></span></span> to its violated bound. If
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x<span class="hidden">⇩</span><sub>i</sub>›</span></span></span></span> is under its lower bound it must be increased, and if
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x<span class="hidden">⇩</span><sub>j</sub>›</span></span></span></span> has a positive coefficient it must be increased so it
must be under its upper bound and if it has a negative coefficient it
must be decreased so it must be above its lower bound. The case when
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x<span class="hidden">⇩</span><sub>i</sub>›</span></span></span></span> is above its upper bound is symmetric (avoiding
symmetries is discussed in Section \ref{sec:symmetries}). If there is
no such <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x<span class="hidden">⇩</span><sub>j</sub>›</span></span></span></span>, unsatisfiability is detected and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check›</span></span></span></span>
fails. The procedure is recursively repeated, until it either succeeds
or fails. To ensure termination, variables <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x<span class="hidden">⇩</span><sub>i</sub>›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x<span class="hidden">⇩</span><sub>j</sub>›</span></span></span></span> must be chosen with respect to a fixed variable ordering. For
choosing these variables auxiliary functions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>min_lvar_not_in_bounds›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>min_rvar_inc›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>min_rvar_dec›</span></span></span></span> are specified (each in its own locale). For, example:
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> MinLVarNotInBounds <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">min_lvar_not_in_bounds</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> var option"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>

min_lvar_not_in_bounds_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> None <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">.</span> in_bounds <span class="bound">x</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

min_lvar_not_in_bounds_Some'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟶</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">∈</span>lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span>in_bounds <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="free">s</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟶</span> in_bounds <span class="bound">x</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> min_lvar_not_in_bounds_None'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> None <span class="main">⟶</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="free">s</span> <span class="main">∥</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds_set.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> min_lvar_not_in_bounds_None<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> min_lvar_not_in_bounds_lvars<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟶</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> min_lvar_not_in_bounds_Some'
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> min_lvar_not_in_bounds_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟶</span> <span class="main">¬</span> in_bounds <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> min_lvar_not_in_bounds_Some'
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">lemma</span></span> min_lvar_not_in_bounds_Some_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟶</span>  <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟶</span> in_bounds <span class="bound">x</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> min_lvar_not_in_bounds_Some'
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">reasable_var</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reasable_var</span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
   <span class="main">(</span>coeff <span class="main">(</span>rhs <span class="free"><span class="bound"><span class="entity">eq</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free"><span class="bound"><span class="entity">dir</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⟩</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>UB <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
   <span class="main">(</span>coeff <span class="main">(</span>rhs <span class="free"><span class="bound"><span class="entity">eq</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">⊳<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free"><span class="bound"><span class="entity">dir</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⟩</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>LB <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> MinRVarsEq <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">min_rvar_incdec_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> eq <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> var"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> min_rvar_incdec_eq_None<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">min_rvar_incdec_eq</span> <span class="free">dir</span> <span class="free">s</span> <span class="free">eq</span> <span class="main">=</span> Inl <span class="free">is</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="free">eq</span><span class="main">.</span> <span class="main">¬</span> reasable_var <span class="free">dir</span> <span class="bound">x</span> <span class="free">eq</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span>set <span class="free">is</span> <span class="main">=</span> <span class="main">{</span>LI <span class="free">dir</span> <span class="free">s</span> <span class="main">(</span>lhs <span class="free">eq</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>LI <span class="free">dir</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="free">eq</span> <span class="main">∧</span> coeff <span class="main">(</span>rhs <span class="free">eq</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span>
          <span class="main">∪</span> <span class="main">{</span>UI <span class="free">dir</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="free">eq</span> <span class="main">∧</span> coeff <span class="main">(</span>rhs <span class="free">eq</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">(</span><span class="free">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="free">dir</span> <span class="main">=</span> Negative<span class="main">)</span> <span class="main">⟶</span> LI <span class="free">dir</span> <span class="free">s</span> <span class="main">(</span>lhs <span class="free">eq</span><span class="main">)</span> <span class="main">∈</span> indices_state <span class="free">s</span> <span class="main">⟶</span> set <span class="free">is</span> <span class="main">⊆</span> indices_state <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">min_rvar_incdec_eq</span> <span class="free">dir</span> <span class="free">s</span> <span class="free">eq</span> <span class="main">=</span> Inr <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">⟹</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="free">eq</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> min_rvar_incdec_eq_Some_incdec<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">min_rvar_incdec_eq</span> <span class="free">dir</span> <span class="free">s</span> <span class="free">eq</span> <span class="main">=</span> Inr <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">⟹</span> reasable_var <span class="free">dir</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">eq</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> min_rvar_incdec_eq_Some_min<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">min_rvar_incdec_eq</span> <span class="free">dir</span> <span class="free">s</span> <span class="free">eq</span> <span class="main">=</span> Inr <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="free">eq</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">⟶</span> <span class="main">¬</span> reasable_var <span class="free">dir</span> <span class="bound">x</span> <span class="free">eq</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> min_rvar_incdec_eq_None'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="free">dir</span> <span class="main">=</span> Negative"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">min_rvar_incdec_eq</span> <span class="free">dir</span> <span class="free">s</span> <span class="free">eq</span> <span class="main">=</span> Inl <span class="free">is</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">=</span> set <span class="free">is</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Iv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬℐ</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"le <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>rhs <span class="free">eq</span><span class="main">)</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>rhs <span class="free">eq</span><span class="main">)</span> <span class="main">⦃</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="free">eq</span><span class="main">.</span> <span class="main">¬</span> reasable_var <span class="free">dir</span> <span class="bound">x</span> <span class="free">eq</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_None
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="free">eq</span><span class="main">.</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> coeff <span class="main">(</span>rhs <span class="free">eq</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span> le <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>coeff <span class="main">(</span>rhs <span class="free">eq</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟶</span> le <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="free">eq</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> coeff <span class="main">(</span>rhs <span class="free">eq</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">v</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊲<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>UB <span class="free">dir</span> <span class="free">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="free">eq</span><span class="main">.</span> <span class="main">¬</span> reasable_var <span class="free">dir</span> <span class="bound">x</span> <span class="free">eq</span> <span class="free">s</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>UB <span class="free">dir</span> <span class="free">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"UB <span class="free">dir</span> <span class="free">s</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> min_rvar_incdec_eq_None<span class="main">[</span><span class="operator">OF</span> min<span class="main">]</span> x sub <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"UI <span class="free">dir</span> <span class="free">s</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Iv * this
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊴<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>UB <span class="free">dir</span> <span class="free">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds_index.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"UB <span class="free">dir</span> <span class="free">s</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def bound_compare'_defs<span class="main">)</span>
        <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"UB <span class="free">dir</span> <span class="free">s</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lt <span class="free">dir</span> <span class="main">0</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">v</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≠</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">v</span> <span class="skolem">x</span>›</span></span> *
      <span class="keyword1"><span class="command">using</span></span> minus_gt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span><span class="main">]</span> minus_lt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="skolem">x</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="free">eq</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&gt;</span> coeff <span class="main">(</span>rhs <span class="free">eq</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">v</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊳<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="free">eq</span><span class="main">.</span> <span class="main">¬</span> reasable_var <span class="free">dir</span> <span class="bound">x</span> <span class="free">eq</span> <span class="free">s</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊴<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"LB <span class="free">dir</span> <span class="free">s</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> min_rvar_incdec_eq_None<span class="main">[</span><span class="operator">OF</span> min<span class="main">]</span> x sub <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LI <span class="free">dir</span> <span class="free">s</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Iv * this
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds_index.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"LB <span class="free">dir</span> <span class="free">s</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def bound_compare'_defs<span class="main">)</span>
        <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"LB <span class="free">dir</span> <span class="free">s</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lt <span class="free">dir</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">v</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">v</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> *
      <span class="keyword1"><span class="command">using</span></span> minus_lt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="skolem">x</span>"</span></span><span class="main">]</span> minus_gt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>rhs <span class="free">eq</span> <span class="main">⦃</span> <span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">v</span> <span class="bound">x</span><span class="main">⦄</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> valuate_nonneg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rhs <span class="free">eq</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">v</span> <span class="bound">x</span>"</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">using</span></span> valuate_nonpos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rhs <span class="free">eq</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">v</span> <span class="bound">x</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> rhs <span class="free">eq</span> <span class="main">⦃</span> <span class="free">v</span> <span class="main">⦄</span> rhs <span class="free">eq</span> <span class="main">⦃</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="main">⦄</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="free">dir</span> <span class="main">=</span> Negative›</span></span>
    <span class="keyword1"><span class="command">using</span></span> minus_gt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rhs <span class="free">eq</span> <span class="main">⦃</span> <span class="free">v</span> <span class="main">⦄</span>"</span></span> <span class="quoted"><span class="quoted">"rhs <span class="free">eq</span> <span class="main">⦃</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="main">⦄</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valuate_diff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> MinRVars <span class="main">=</span> EqForLVar <span class="main">+</span> MinRVarsEq <span class="quoted"><span class="free">min_rvar_incdec_eq</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">min_rvar_incdec_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'a</span> <span class="main">::</span> lrv<span class="main">)</span> Direction <span class="main">⇒</span> <span class="main">_</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">min_rvar_incdec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> var <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> var"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">min_rvar_incdec</span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="main">≡</span> <span class="free">min_rvar_incdec_eq</span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> MinVars <span class="main">=</span> MinLVarNotInBounds <span class="quoted"><span class="free">min_lvar_not_in_bounds</span></span> <span class="main">+</span> MinRVars <span class="quoted"><span class="free">eq_idx_for_lvar</span></span> <span class="quoted"><span class="free">min_rvar_incdec_eq</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">min_lvar_not_in_bounds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">eq_idx_for_lvar</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">min_rvar_incdec_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'a</span> <span class="main">::</span> lrv<span class="main">)</span> Direction <span class="main">⇒</span> <span class="main">_</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> PivotUpdateMinVars <span class="main">=</span>
  PivotAndUpdate <span class="quoted"><span class="free">eq_idx_for_lvar</span></span> <span class="quoted"><span class="free">pivot_and_update</span></span> <span class="main">+</span>
  MinVars <span class="quoted"><span class="free">min_lvar_not_in_bounds</span></span> <span class="quoted"><span class="free">eq_idx_for_lvar</span></span> <span class="quoted"><span class="free">min_rvar_incdec_eq</span></span> <span class="keyword2"><span class="keyword">for</span></span>
  <span class="free">eq_idx_for_lvar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> var <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">min_lvar_not_in_bounds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> var option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">min_rvar_incdec_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> eq <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> var"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">pivot_and_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> var <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check'</span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
     <span class="keyword1">let</span> <span class="bound">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> the <span class="main">(</span>LB <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span><span class="main">)</span><span class="main">;</span>
         <span class="bound">x<span class="hidden">⇩</span><sub>j</sub>'</span> <span class="main">=</span> min_rvar_incdec <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span>
     <span class="keyword1">in</span> <span class="keyword1">case</span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub>'</span> <span class="keyword1">of</span>
           Inl <span class="bound">I</span> <span class="main">⇒</span> set_unsat <span class="bound">I</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
         <span class="main">|</span> Inr <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">⇒</span> <span class="free">pivot_and_update</span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="bound">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> check'_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">I</span><span class="main">.</span> <span class="main">⟦</span>min_rvar_incdec <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inl <span class="bound">I</span><span class="main">;</span> check' <span class="free">dir</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span> <span class="main">=</span> set_unsat <span class="bound">I</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>set_unsat <span class="bound">I</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="bound">l<span class="hidden">⇩</span><sub>i</sub></span><span class="main">.</span> <span class="main">⟦</span>min_rvar_incdec <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">;</span>
           <span class="bound">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> the <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">;</span>
           check' <span class="free">dir</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="bound">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
        <span class="free">P</span> <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="bound">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>check' <span class="free">dir</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> check'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"min_rvar_incdec <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>tailrec<span class="main">)</span> <span class="entity">check</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> 𝒰 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
     <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="main">=</span> <span class="free">min_lvar_not_in_bounds</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
          <span class="keyword1">in</span> <span class="keyword1">case</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="keyword1">of</span>
               None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
             <span class="main">|</span> Some <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">dir</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="main">⟨</span>𝒱 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⟩</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">then</span> Positive
                                    <span class="keyword1">else</span> Negative
                          <span class="keyword1">in</span> <span class="free">check</span> <span class="main">(</span>check' <span class="bound">dir</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> check.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">check_dom</span> <span class="keyword2"><span class="keyword">where</span></span>
  step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">.</span> <span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> Some <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="free">min_lvar_not_in_bounds</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> <span class="main">⟨</span>𝒱 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⟩</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span>
     <span class="main">⟹</span> <span class="free">check_dom</span> <span class="main">(</span>check' Positive <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">;</span>
  <span class="main">⋀</span><span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">.</span> <span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> Some <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="free">min_lvar_not_in_bounds</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> <span class="main">¬</span> <span class="main">⟨</span>𝒱 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⟩</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">⟧</span>
     <span class="main">⟹</span> <span class="free">check_dom</span> <span class="main">(</span>check' Negative <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">⟧</span>
<span class="main">⟹</span> <span class="free">check_dom</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>



<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The definition of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check›</span></span></span></span> can be given by:

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span>[display]
<span class="raw_text"><span class="raw_text">"check s ≡ if 𝒰 s then s
            else let x<span class="hidden">⇩</span><sub>i</sub>' = min_lvar_not_in_bounds s in
                 case x<span class="hidden">⇩</span><sub>i</sub>' of  None ⇒ s
                           | Some x<span class="hidden">⇩</span><sub>i</sub> ⇒ if ⟨𝒱 s⟩ x<span class="hidden">⇩</span><sub>i</sub> &lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub> ℬ<span class="hidden">⇩</span><sub>l</sub> s x<span class="hidden">⇩</span><sub>i</sub> then check (check_inc x<span class="hidden">⇩</span><sub>i</sub> s)
                                           else check (check_dec x<span class="hidden">⇩</span><sub>i</sub> s)"</span></span>
<span class="antiquote"><span class="antiquote">}</span></span></span></span>

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span>[display]
<span class="raw_text"><span class="raw_text">"check_inc x<span class="hidden">⇩</span><sub>i</sub> s ≡ let l<span class="hidden">⇩</span><sub>i</sub> = the (ℬ<span class="hidden">⇩</span><sub>l</sub> s x<span class="hidden">⇩</span><sub>i</sub>); x<span class="hidden">⇩</span><sub>j</sub>' = min_rvar_inc s x<span class="hidden">⇩</span><sub>i</sub> in
   case x<span class="hidden">⇩</span><sub>j</sub>' of None ⇒ s ⦇ 𝒰 := True ⦈ | Some x<span class="hidden">⇩</span><sub>j</sub> ⇒ pivot_and_update x<span class="hidden">⇩</span><sub>i</sub> x<span class="hidden">⇩</span><sub>j</sub> l<span class="hidden">⇩</span><sub>i</sub> s"</span></span>
<span class="antiquote"><span class="antiquote">}</span></span></span></span>

The definition of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check_dec›</span></span></span></span> is analogous. It is shown (mainly
by induction) that this definition satisfies the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check›</span></span></span></span>
specification. Note that this definition uses general recursion, so
its termination is non-trivial. It has been shown that it terminates
for all states satisfying the check preconditions. The proof is based
on the proof outline given in \cite{simplex-rad}. It is very
technically involved, but conceptually uninteresting so we do not
discuss it in more details.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pivotandupdate_check_precond<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">dir</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">then</span> Positive <span class="keyword1">else</span> Negative<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"min_rvar_incdec <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> the <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">" <span class="main">◇</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">◇</span> <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">∇</span> <span class="main">(</span><span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="free">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Some <span class="free">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∨</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Some <span class="free">l<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> the <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">dir</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">then</span> Positive <span class="keyword1">else</span> Negative<span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span> min_lvar_not_in_bounds_Some<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">◇</span> <span class="free">s</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span></span> <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span>"</span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bounds_consistent_def bound_compare_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_tableau_normalized<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="free">l<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_nolhs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="free">l<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_bounds_consistent<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="free">l<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_tableau_valuated<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="free">l<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_lvar_not_in_bounds_lvars  min_rvar_incdec_eq_Some_rvars<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Termination *)</span>
<span class="comment1">(* -------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gt_state'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gt_state'</span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>j</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">l<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="main">≡</span>
  <span class="free">min_lvar_not_in_bounds</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="main">∧</span>
  <span class="free"><span class="bound"><span class="entity">l<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="main">=</span> the <span class="main">(</span>LB <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span><span class="main">)</span> <span class="main">∧</span>
  min_rvar_incdec <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="main">=</span> Inr <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>j</sub></span></span></span> <span class="main">∧</span>
  <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>j</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">l<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gt_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≻<span class="hidden">⇩</span><sub>x</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1"><span class="free">≻<span class="hidden">⇩</span><sub>x</sub></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span>
   <span class="main">∃</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="bound">l<span class="hidden">⇩</span><sub>i</sub></span><span class="main">.</span>
     <span class="keyword1">let</span> <span class="bound">dir</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="main">⟨</span>𝒱 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⟩</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">then</span> Positive <span class="keyword1">else</span> Negative <span class="keyword1">in</span>
     gt_state' <span class="bound">dir</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="bound">l<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≻</span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">≻</span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">◇</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="main">∇</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">≻<span class="hidden">⇩</span><sub>x</sub></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">∧</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">succ_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succ_rel</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≻</span> <span class="bound">s'</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">succ_rel_trancl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≻<span class="hidden">⇧</span><sup>+</sup></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">≻<span class="hidden">⇧</span><sup>+</sup></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">∈</span> succ_rel<span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">succ_rel_rtrancl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≻<span class="hidden">⇧</span><sup>*</sup></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">≻<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">∈</span> succ_rel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_vars<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"lvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"rvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="skolem"><span class="skolem">c</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"min_rvar_incdec Positive <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∨</span> min_rvar_incdec Negative <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">c</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gt_state_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"lvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span> <span class="main">=</span>  lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"rvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_lvar_not_in_bounds_lvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Positive</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Negative</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_lvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq_for_lvar<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="quoted">"𝒯 <span class="free">s</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rvars_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"lvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"rvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_vars_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">∪</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">=</span>
         lvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span> <span class="main">∪</span> rvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> succ_vars<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> succ_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="skolem"><span class="skolem">c</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"min_rvar_incdec Positive <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∨</span> min_rvar_incdec Negative <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">c</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gt_state_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_lvar_not_in_bounds_lvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Positive</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Negative</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_tableau_normalized<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_bounds_consistent<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_bounds_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_tableau_equiv
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_tableau_valuated
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_rvar_valuation_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="free">s'</span><span class="main">⟩</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="skolem"><span class="skolem">c</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"min_rvar_incdec Positive <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∨</span> min_rvar_incdec Negative <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">c</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gt_state_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> min_lvar_not_in_bounds_lvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Positive</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Negative</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_valuation_xi<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_valuation_other_nolhs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_tableau_def map2fun_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_min_lvar_not_in_bounds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻</span> <span class="free">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">xr</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xr</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> in_bounds <span class="free">xr</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">xr</span> <span class="main">⟶</span> in_bounds <span class="bound">x</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="skolem"><span class="skolem">c</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"min_rvar_incdec Positive <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∨</span> min_rvar_incdec Negative <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">c</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gt_state_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="free">xr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_lvar_not_in_bounds_lvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Positive</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Negative</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xr</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xr</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_rvars
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_tableau_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> in_bounds <span class="free">xr</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">xr</span> <span class="main">⟶</span> in_bounds <span class="bound">x</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_lvar_not_in_bounds_Some min_lvar_not_in_bounds_Some_min
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_min_rvar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻</span> <span class="free">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">xr</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xr</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">eq</span> <span class="main">=</span> eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    dir<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="free">dir</span> <span class="main">=</span> Negative"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟶</span>
             reasable_var <span class="free">dir</span> <span class="free">xr</span> <span class="free">eq</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="free">eq</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">xr</span> <span class="main">⟶</span> <span class="main">¬</span> reasable_var <span class="free">dir</span> <span class="bound">x</span> <span class="free">eq</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="skolem"><span class="skolem">c</span></span>
    <span class="keyword2"><span class="keyword">where</span></span><span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">∇</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">◇</span> <span class="free">s</span> <span class="main">∧</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span>
      <span class="quoted"><span class="quoted">"gt_state' <span class="main">(</span><span class="keyword1">if</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">then</span> Positive <span class="keyword1">else</span> Negative<span class="main">)</span> <span class="free">s</span> <span class="free">s'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_state_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">c</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∧</span> min_rvar_incdec Positive <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span> <span class="main">∨</span>
        <span class="main">(</span><span class="main">¬</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∧</span> min_rvar_incdec Negative <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xr</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_lvar_not_in_bounds_lvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Positive</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Negative</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xr</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xr</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_lvars pivotandupdate_rvars
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_tableau_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
            reasable_var <span class="free">dir</span> <span class="free">xr</span> <span class="free">eq</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="free">eq</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">xr</span> <span class="main">⟶</span> <span class="main">¬</span> reasable_var <span class="free">dir</span> <span class="bound">x</span> <span class="free">eq</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dir
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"LB <span class="free">dir</span> <span class="free">s</span> <span class="free">xs</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊳<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>UB <span class="free">dir</span> <span class="free">s</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">◇</span> <span class="free">s</span>›</span></span> dir
      <span class="keyword1"><span class="command">using</span></span> bounds_consistent_gt_ub bounds_consistent_lt_lb
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  bound_compare''_defs<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min_rvar_incdec <span class="free">dir</span> <span class="free">s</span> <span class="free">xs</span> <span class="main">=</span> Inr <span class="free">xr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="quoted"><span class="quoted">‹<span class="free">xr</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span> dir
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare''_defs<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"reasable_var <span class="free">dir</span> <span class="free">xr</span> <span class="free">eq</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="free">eq</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">xr</span> <span class="main">⟶</span> <span class="main">¬</span> reasable_var <span class="free">dir</span> <span class="bound">x</span> <span class="free">eq</span> <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">eq</span> <span class="main">=</span> eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">xs</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_min<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">dir</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">eq</span></span> <span class="quoted"><span class="free">xr</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_incdec<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">dir</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">eq</span></span> <span class="quoted"><span class="free">xr</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_set_on_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    dir<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="free">dir</span> <span class="main">=</span> Negative"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">⟶</span> <span class="main">⟨</span>𝒱 <span class="free">s'</span><span class="main">⟩</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> the <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="free">s'</span><span class="main">⟩</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">∨</span> <span class="main">⟨</span>𝒱 <span class="free">s'</span><span class="main">⟩</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="skolem"><span class="skolem">c</span></span>
    <span class="keyword2"><span class="keyword">where</span></span><span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">∇</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">◇</span> <span class="free">s</span> <span class="main">∧</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span>
      <span class="quoted"><span class="quoted">"gt_state' <span class="main">(</span><span class="keyword1">if</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="keyword1">then</span> Positive <span class="keyword1">else</span> Negative<span class="main">)</span> <span class="free">s</span> <span class="free">s'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_state_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">c</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="main">∧</span> <span class="skolem">c</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">)</span> <span class="main">∧</span> min_rvar_incdec Positive <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span> <span class="main">∨</span>
        <span class="main">(</span><span class="main">¬</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="main">∧</span> <span class="skolem">c</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">)</span> <span class="main">∧</span> min_rvar_incdec Negative <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_lvar_not_in_bounds_lvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Positive</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Negative</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_rvars
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_tableau_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">⟶</span> <span class="main">⟨</span>𝒱 <span class="free">s'</span><span class="main">⟩</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> the <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dir
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"LB <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊳<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">(</span>UB <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">◇</span> <span class="free">s</span>›</span></span> dir
      <span class="keyword1"><span class="command">using</span></span> bounds_consistent_gt_ub bounds_consistent_lt_lb
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare''_defs<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="free">s'</span><span class="main">⟩</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> the <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="quoted"><span class="quoted">‹<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">c</span> <span class="free">s</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> pivotandupdate_valuation_xi<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> dir
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span></span> <span class="free"><span class="free">s</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span></span>"</span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs map2fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span>  <span class="main">⟶</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_lvar_not_in_bounds_Some<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> not_in_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="free">s'</span><span class="main">⟩</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">∨</span> <span class="main">⟨</span>𝒱 <span class="free">s'</span><span class="main">⟩</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">c</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_valuation_xi<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span></span> <span class="free"><span class="free">s</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub>'</span></span>"</span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map2fun_def bound_compare_defs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_rvar_valuation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="free">s'</span><span class="main">⟩</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">x</span> <span class="main">∨</span> <span class="main">⟨</span>𝒱 <span class="free">s'</span><span class="main">⟩</span> <span class="free">x</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">∨</span> <span class="main">⟨</span>𝒱 <span class="free">s'</span><span class="main">⟩</span> <span class="free">x</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"min_rvar_incdec Positive <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∨</span> min_rvar_incdec Negative <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">b</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">b</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gt_state_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∉</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">≠</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_lvar_not_in_bounds_lvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Positive</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Negative</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> rvars_of_lvar_rvars <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_tableau_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"rvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">b</span> <span class="free">s</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_tableau_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_valuation_xi<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_valuation_other_nolhs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">b</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">b</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map2fun_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_no_vars_valuation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> tvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>𝒱 <span class="free">s'</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> look <span class="main">(</span>𝒱 <span class="free">s</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"min_rvar_incdec Positive <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∨</span> min_rvar_incdec Negative <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">b</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">b</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gt_state_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∉</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">≠</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_lvar_not_in_bounds_lvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Positive</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Negative</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> rvars_of_lvar_rvars <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_tableau_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_valuation_other_nolhs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">b</span> <span class="free">s</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> tvars <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_lvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map2fun_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_valuation_satisfies<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="free">s'</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≻</span> <span class="free">s'</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"min_rvar_incdec Positive <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∨</span> min_rvar_incdec Negative <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">b</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">b</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gt_state_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_lvar_not_in_bounds_lvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Positive</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted">Negative</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_tableau_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_satisfies_tableau<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> pivotandupdate_tableau_equiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">b</span> <span class="free">s</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_tableau_valuated<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> succ_inv<span class="main">(</span>2<span class="main">)</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">succ_chain</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succ_chain</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> rel_chain <span class="free"><span class="bound"><span class="entity">l</span></span></span> succ_rel"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_chain_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"succ_chain <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≻</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">;</span> <span class="free">P</span> <span class="bound">j</span> <span class="bound">k</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span><span class="main">;</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> *
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> base<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> Suc<span class="main">(</span>2<span class="main">)</span> Suc<span class="main">(</span>3<span class="main">)</span> Suc<span class="main">(</span>4<span class="main">)</span> Suc<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> step<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≻</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> Suc<span class="main">(</span>3<span class="main">)</span> Suc<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> rel_chain_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> Suc<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_chain_bounds_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"succ_chain <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> succ_chain_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≻</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> succ_inv<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> succ_chain_vars_id'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"succ_chain <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> succ_chain_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≻</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> tvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> succ_vars_id<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> succ_chain_vars_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"succ_chain <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms succ_chain_vars_id'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms succ_chain_vars_id'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_chain_tableau_equiv'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"succ_chain <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> succ_chain_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≻</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> succ_inv<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> succ_chain_tableau_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"succ_chain <span class="free">l</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms succ_chain_tableau_equiv'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms succ_chain_tableau_equiv'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_chain_no_vars_valuation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"succ_chain <span class="free">l</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> tvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> look <span class="main">(</span>𝒱 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> look <span class="main">(</span>𝒱 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">i</span> <span class="free">j</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> Suc<span class="main">(</span>2<span class="main">)</span> Suc<span class="main">(</span>3<span class="main">)</span> Suc<span class="main">(</span>4<span class="main">)</span> Suc<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> succ_no_vars_valuation<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≻</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> Suc<span class="main">(</span>3<span class="main">)</span> Suc<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> rel_chain_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> tvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> succ_vars_id<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≻</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> Suc<span class="main">(</span>3<span class="main">)</span> Suc<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> rel_chain_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_chain_rvar_valuation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"succ_chain <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
  <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">∨</span>
  <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">i</span> <span class="free">j</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"succ_chain <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> Suc<span class="main">(</span>3<span class="main">)</span> Suc<span class="main">(</span>4<span class="main">)</span> Suc<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≻</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_chain_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> succ_rvar_valuation
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span>
    vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≻</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> succ_vars<span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bounds<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹succ_chain <span class="free">l</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> succ_chain_bounds_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">,</span> <span class="operator">THEN</span> sym<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> succ_chain_bounds_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">,</span> <span class="operator">THEN</span> sym<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> vars
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">∨</span>
          <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∨</span>
          <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> jj <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>›</span></span> ji
        <span class="keyword1"><span class="command">using</span></span> bounds
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> succ_set_on_bound<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≻</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> vars bounds
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_chain_valuation_satisfies<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"succ_chain <span class="free">l</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> succ_chain_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≻</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> succ_valuation_satisfies
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> succ_chain_tableau_valuated<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"succ_chain <span class="free">l</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">∇</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> succ_chain_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≻</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">∇</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> succ_tableau_valuated
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">swap_lr</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">swap_lr</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">!</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">swap_rl</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">swap_rl</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">!</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">always_r</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">always_r</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_chain_always_r_valuation_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"succ_chain <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"always_r <span class="free">l</span> <span class="free">i</span> <span class="free">j</span> <span class="free">x</span> <span class="main">⟶</span> <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">⟩</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">⟩</span> <span class="free">x</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">i</span> <span class="free">j</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> succ_chain_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≻</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> succ_rvar_valuation_id
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> succ_chain_swap_rl_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"succ_chain <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> swap_rl <span class="free">l</span> <span class="bound">k</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≻</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> Suc<span class="main">(</span>4<span class="main">)</span> Suc<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_chain_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> succ_inv<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≠</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>7<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_tableau_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> Suc <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"swap_rl <span class="free">l</span> <span class="skolem">k</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≠</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> Suc<span class="main">(</span>2<span class="main">)</span> Suc<span class="main">(</span>3<span class="main">)</span> Suc<span class="main">(</span>4<span class="main">)</span> Suc<span class="main">(</span>5<span class="main">)</span> Suc<span class="main">(</span>6<span class="main">)</span> Suc<span class="main">(</span>7<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>6<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≻</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> succ_vars_id
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>4<span class="main">)</span> Suc<span class="main">(</span>5<span class="main">)</span> Suc<span class="main">(</span>6<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succ_chain_swap_lr_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"succ_chain <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> swap_lr <span class="free">l</span> <span class="bound">k</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≻</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> Suc<span class="main">(</span>4<span class="main">)</span> Suc<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_chain_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> succ_inv<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≠</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>7<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_tableau_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> Suc <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"swap_lr <span class="free">l</span> <span class="skolem">k</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≠</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> Suc<span class="main">(</span>2<span class="main">)</span> Suc<span class="main">(</span>3<span class="main">)</span> Suc<span class="main">(</span>4<span class="main">)</span> Suc<span class="main">(</span>5<span class="main">)</span> Suc<span class="main">(</span>6<span class="main">)</span> Suc<span class="main">(</span>7<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>6<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≻</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> succ_vars_id
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>4<span class="main">)</span> Suc<span class="main">(</span>5<span class="main">)</span> Suc<span class="main">(</span>6<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* -------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_tableaus_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">t</span><span class="main">.</span> lvars <span class="bound">t</span> <span class="main">=</span> <span class="free">L</span> <span class="main">∧</span> rvars <span class="bound">t</span> <span class="main">=</span> <span class="free">V</span> <span class="main">-</span> <span class="free">L</span> <span class="main">∧</span> <span class="main">△</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">t</span> <span class="main">=</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t0</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?Al</span> <span class="free">L</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?Al</span> <span class="free">L</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> True<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="var">?Al</span> <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="var">?Al</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">∈</span> <span class="var">?Al</span> <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="var">?Al</span> <span class="free">L</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Al</span> <span class="free">L</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&lt;~~&gt;</span> <span class="var">?t</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Al</span> <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;~~&gt;</span> <span class="var">?t</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tableau_perm<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?t</span> <span class="main">∈</span> <span class="var">?Al</span> <span class="free">L</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Al</span> <span class="free">L</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&lt;~~&gt;</span> <span class="var">?t</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&lt;~~&gt;</span> <span class="var">?t</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> perm_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_tableaus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">t</span><span class="main">.</span> tvars <span class="bound">t</span> <span class="main">=</span> <span class="free">V</span> <span class="main">∧</span> <span class="main">△</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">t</span> <span class="main">=</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t0</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Al</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">L</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> lvars <span class="bound">t</span> <span class="main">=</span> <span class="bound">L</span> <span class="main">∧</span> rvars <span class="bound">t</span> <span class="main">=</span> <span class="free">V</span> <span class="main">-</span> <span class="bound">L</span> <span class="main">∧</span> <span class="main">△</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">t</span> <span class="main">=</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t0</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="var">?Al</span> <span class="main">`</span> <span class="main">{</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="main">⊆</span> <span class="free">V</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_tableau_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">V</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_tableaus_aux
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_accessible_tableaus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>𝒯 <span class="main">`</span> <span class="main">{</span><span class="bound">s'</span><span class="main">.</span> <span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">s'</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s'</span><span class="main">.</span> <span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">s'</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s'</span><span class="main">.</span> <span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">s'</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rtrancl_eq_or_trancl<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>𝒯 <span class="main">`</span> <span class="main">{</span><span class="bound">s'</span><span class="main">.</span> <span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">s'</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">t</span><span class="main">.</span> tvars <span class="bound">t</span> <span class="main">=</span> tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">△</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">t</span> <span class="main">=</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span><span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊆</span> <span class="var">?T</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> 𝒯 <span class="skolem">s'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">l</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"succ_chain <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> trancl_rel_chain<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted">succ_rel</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="var">?T</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span> <span class="main">=</span> tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> succ_chain_vars_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> * hd_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> last_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s'</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> succ_inv<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> tranclD2<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s'</span> <span class="main">=</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> succ_chain_tableau_equiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> * hd_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> last_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> 𝒯 <span class="skolem">s'</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lvars_def rvars_def finite_vars<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_tableaus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"𝒯 <span class="free">s</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">check_valuation</span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_valuation</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">bl0</span></span></span> <span class="free"><span class="bound"><span class="entity">bu0</span></span></span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">≡</span>
     <span class="main">∃</span> <span class="bound">t</span><span class="main">.</span> tvars <span class="bound">t</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">∧</span> <span class="main">△</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">t</span> <span class="main">=</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">t</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars <span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="bound">x</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">bl0</span></span></span> <span class="bound">x</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">bu0</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_valuations<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">.</span> check_valuation <span class="bound">v</span> <span class="free">v0</span> <span class="free">bl0</span> <span class="free">bu0</span> <span class="free">t0</span> <span class="free">V</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Al</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">L</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> lvars <span class="bound">t</span> <span class="main">=</span> <span class="bound">L</span> <span class="main">∧</span> rvars <span class="bound">t</span> <span class="main">=</span> <span class="free">V</span> <span class="main">-</span> <span class="bound">L</span> <span class="main">∧</span> <span class="main">△</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">t</span> <span class="main">=</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t0</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Vt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">t</span><span class="main">.</span> <span class="main">{</span><span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars <span class="bound">t</span><span class="main">.</span> <span class="bound">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">v0</span> <span class="bound">x</span> <span class="main">∨</span> <span class="bound">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">bl0</span> <span class="bound">x</span> <span class="main">∨</span> <span class="bound">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">bu0</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">V</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">v0</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="main">⊆</span> <span class="free">V</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">V</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">⟶</span> finite <span class="main">(</span><span class="var">?Al</span> <span class="bound">L</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_tableaus_aux
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">L</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">L</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">∈</span> <span class="var">?Al</span> <span class="bound">L</span> <span class="main">⟶</span> finite <span class="main">(</span><span class="var">?Vt</span>  <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">L</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lvars <span class="skolem">t</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"rvars <span class="skolem">t</span> <span class="main">=</span> <span class="free">V</span> <span class="main">-</span> lvars <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span> <span class="main">=</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rvars <span class="skolem">t</span> <span class="main">∪</span> lvars <span class="skolem">t</span> <span class="main">=</span> <span class="free">V</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">v</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> rvars <span class="skolem">t</span> <span class="keyword1">then</span> <span class="bound">v</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?f</span> <span class="main">(</span><span class="var">?Vt</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ext<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> rvars <span class="skolem">t</span> <span class="keyword1">then</span> <span class="skolem">v1</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> rvars <span class="skolem">t</span> <span class="keyword1">then</span> <span class="skolem">v2</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f1</span> <span class="main">=</span> <span class="var">?f2</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>rvars <span class="skolem">t</span><span class="main">.</span> <span class="skolem">v1</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">v2</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v2</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f1</span> <span class="main">=</span> <span class="var">?f2</span>›</span></span> fun_cong<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?f1</span></span></span> <span class="var"><span class="quoted"><span class="var">?f2</span></span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">V</span> <span class="main">⟶</span> <span class="skolem">v1</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">v0</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">V</span> <span class="main">⟶</span> <span class="skolem">v2</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">v0</span> <span class="bound">x</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v2</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lvars <span class="skolem">t</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> * <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>rvars <span class="skolem">t</span><span class="main">.</span> <span class="skolem">v1</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">v2</span> <span class="bound">x</span>›</span></span> <span class="quoted"><span class="quoted">‹rvars <span class="skolem">t</span> <span class="main">∪</span> lvars <span class="skolem">t</span> <span class="main">=</span> <span class="free">V</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?eq</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="skolem">t</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eq</span> <span class="main">∈</span> set <span class="skolem">t</span> <span class="main">∧</span> lhs <span class="var">?eq</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> eq_for_lvar <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> lvars <span class="skolem">t</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="skolem">x</span> <span class="main">=</span> rhs <span class="var">?eq</span> <span class="main">⦃</span> <span class="skolem">v1</span> <span class="main">⦄</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="skolem">x</span> <span class="main">=</span> rhs <span class="var">?eq</span> <span class="main">⦃</span> <span class="skolem">v2</span> <span class="main">⦄</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v1</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v2</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> satisfies_tableau_def satisfies_eq_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rhs <span class="var">?eq</span> <span class="main">⦃</span> <span class="skolem">v1</span> <span class="main">⦄</span> <span class="main">=</span> rhs <span class="var">?eq</span> <span class="main">⦃</span> <span class="skolem">v2</span> <span class="main">⦄</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> valuate_depend<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>rvars <span class="skolem">t</span><span class="main">.</span> <span class="skolem">v1</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">v2</span> <span class="bound">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?eq</span> <span class="main">∈</span> set <span class="skolem">t</span> <span class="main">∧</span> lhs <span class="var">?eq</span> <span class="main">=</span> <span class="skolem">x</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> rvars_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> rvars <span class="skolem">t</span> <span class="keyword1">then</span> <span class="bound">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">v0</span> <span class="bound">x</span> <span class="main">∨</span> <span class="bound">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">bl0</span> <span class="bound">x</span> <span class="main">∨</span> <span class="bound">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">bu0</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="bound">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="main">(</span><span class="var">?Vt</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>rvars <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">V</span>›</span></span> <span class="quoted"><span class="quoted">‹rvars <span class="skolem">t</span> <span class="main">∪</span> lvars <span class="skolem">t</span> <span class="main">=</span> <span class="free">V</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span>  finite_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rvars <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="free">V</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> rvars <span class="skolem">t</span> <span class="keyword1">then</span> <span class="bound">v</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">v0</span> <span class="bound">x</span><span class="main">,</span> <span class="free">bl0</span> <span class="bound">x</span><span class="main">,</span> <span class="free">bu0</span> <span class="bound">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="bound">v</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> <span class="var">?R'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_fun_args<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rvars <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="free">v0</span> <span class="bound">x</span><span class="main">,</span>  <span class="free">bl0</span> <span class="bound">x</span><span class="main">,</span> <span class="free">bu0</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">0</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="main">(</span><span class="var">?Vt</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?Vt</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹inj_on <span class="var">?f</span> <span class="main">(</span><span class="var">?Vt</span> <span class="skolem">t</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_imageD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="main">(</span><span class="main">(`)</span> <span class="var">?Vt</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="var">?Al</span> <span class="main">`</span> <span class="main">{</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="main">⊆</span> <span class="free">V</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?A'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_tableau_def <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> image_cong_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?A'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_Union<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="main">(</span><span class="main">(`)</span> <span class="var">?Vt</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="var">?Al</span> <span class="main">`</span> <span class="main">{</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="main">⊆</span> <span class="free">V</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">{</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="main">⊆</span> <span class="free">V</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">⟶</span> finite <span class="main">(</span><span class="var">?Al</span> <span class="bound">L</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span><span class="main">(</span><span class="main">(`)</span> <span class="var">?Vt</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="var">?Al</span> <span class="main">`</span> <span class="main">{</span><span class="bound">L</span><span class="main">.</span> <span class="bound">L</span> <span class="main">⊆</span> <span class="free">V</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="var">?Al</span> <span class="skolem">L</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="var">?Vt</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">L</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">L</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">∈</span> <span class="var">?Al</span> <span class="bound">L</span> <span class="main">⟶</span> finite <span class="main">(</span><span class="var">?Vt</span>  <span class="bound">t</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> finite_accessible_valuations<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>𝒱 <span class="main">`</span> <span class="main">{</span><span class="bound">s'</span><span class="main">.</span> <span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">s'</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s'</span><span class="main">.</span> <span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">s'</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s'</span><span class="main">.</span> <span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">s'</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rtrancl_eq_or_trancl<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>𝒱 <span class="main">`</span> <span class="main">{</span><span class="bound">s'</span><span class="main">.</span> <span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">s'</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> check_valuation <span class="bound">v</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">(</span>tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">v</span><span class="main">::</span><span class="main">(</span>var<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> mapping<span class="main">.</span>
         <span class="main">∃</span> <span class="bound">t</span><span class="main">.</span> tvars <span class="bound">t</span> <span class="main">=</span> tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">△</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">t</span> <span class="main">=</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">⟨</span><span class="bound">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">t</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars <span class="bound">t</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">v</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">∨</span>
                       <span class="main">⟨</span><span class="bound">v</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∨</span>
                       <span class="main">⟨</span><span class="bound">v</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span> look <span class="bound">v</span> <span class="bound">x</span> <span class="main">=</span> look <span class="main">(</span>𝒱 <span class="free">s</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span> look <span class="bound">v</span> <span class="bound">x</span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lvars_def rvars_def finite_vars<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_valuations<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"𝒯 <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map2fun <span class="main">`</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="var">?P'</span> <span class="bound">v</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map2fun_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>map2fun <span class="main">`</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="var">?P'</span> <span class="bound">v</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on map2fun <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="var">?P'</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">x</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">y</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> Simplex.tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span> look <span class="skolem">y</span> <span class="bound">x</span> <span class="main">=</span> look <span class="main">(</span>𝒱 <span class="free">s</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xa</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">∉</span> Simplex.tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span> look <span class="skolem">x</span> <span class="bound">xa</span> <span class="main">=</span> look <span class="main">(</span>𝒱 <span class="free">s</span><span class="main">)</span> <span class="bound">xa</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> Simplex.tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span> look <span class="skolem">y</span> <span class="bound">x</span> <span class="main">≠</span> None"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xa</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">∈</span> Simplex.tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span> look <span class="skolem">x</span> <span class="bound">xa</span> <span class="main">≠</span> None"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mapping_eqI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">x</span><span class="main">⟩</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">y</span><span class="main">⟩</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">x</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">y</span><span class="main">⟩</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"look <span class="skolem">x</span> <span class="skolem">k</span> <span class="main">=</span> look <span class="skolem">y</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> *
          <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map2fun_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="var">?P'</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_imageD<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="var">?P'</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">l</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"succ_chain <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> trancl_rel_chain<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted">succ_rel</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P'</span> <span class="main">(</span>𝒱 <span class="skolem">s'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s'</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> tranclD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted">succ_rel</span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> curr_val_satisfies_no_lhs_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span> <span class="main">=</span> tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> succ_chain_vars_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> * hd_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> last_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span><span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s'</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> succ_inv<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> tranclD2<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">::</span><span class="tfree">'a</span> valuation<span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s'</span> <span class="main">=</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> succ_chain_tableau_equiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> * hd_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> last_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> succ_chain_valuation_satisfies<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> * hd_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> last_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>rvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">∨</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∨</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> succ_chain_rvar_valuation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> * hd_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> last_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span> look <span class="main">(</span>𝒱 <span class="skolem">s'</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> look <span class="main">(</span>𝒱 <span class="free">s</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> succ_chain_no_vars_valuation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> * hd_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> last_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> Simplex.tvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span> <span class="main">⟶</span> look <span class="main">(</span>𝒱 <span class="skolem">s'</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span> None"</span></span>
          <span class="keyword1"><span class="command">using</span></span> succ_chain_tableau_valuated<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> * hd_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> last_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹tvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span> <span class="main">=</span> tvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="free">s</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tableau_valuated_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"𝒯 <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> accessible_bounds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">`</span> <span class="main">{</span><span class="bound">s'</span><span class="main">.</span> <span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">s'</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">s'</span> <span class="main">⟹</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s'</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> accessible_unsat_core<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="main">`</span> <span class="main">{</span><span class="bound">s'</span><span class="main">.</span> <span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">s'</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free">s</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">s'</span> <span class="main">⟹</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">s'</span> <span class="main">=</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> state_eqI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free">s</span> <span class="main">=</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free">s'</span> <span class="main">⟹</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free">s</span> <span class="main">=</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free">s'</span> <span class="main">⟹</span>
   𝒯 <span class="free">s</span> <span class="main">=</span> 𝒯 <span class="free">s'</span> <span class="main">⟹</span> 𝒱 <span class="free">s</span> <span class="main">=</span> 𝒱 <span class="free">s'</span> <span class="main">⟹</span>
   𝒰 <span class="free">s</span> <span class="main">=</span> 𝒰 <span class="free">s'</span> <span class="main">⟹</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free">s</span> <span class="main">=</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free">s'</span> <span class="main">⟹</span>
   <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">s'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_accessible_states<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">s'</span><span class="main">.</span> <span class="free">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">s'</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?V</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"𝒱 <span class="main">`</span> <span class="var">?A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"𝒯 <span class="main">`</span> <span class="var">?A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="main">×</span> <span class="var">?T</span> <span class="main">×</span> <span class="main">{</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_accessible_valuations finite_accessible_tableaus
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span>𝒱 <span class="bound">s</span><span class="main">,</span> 𝒯 <span class="bound">s</span><span class="main">,</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">s</span><span class="main">,</span> 𝒰 <span class="bound">s</span><span class="main">,</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="var">?A</span> <span class="main">⊆</span> <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> accessible_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> accessible_unsat_core<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?f</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> state_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_imageD <span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> finite_subset
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="keyword1"><span class="command">lemma</span></span> acyclic_suc_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"acyclic succ_rel"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> acyclicI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∉</span> succ_rel<span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≻<span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"succ_chain <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> trancl_rel_chain<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted">succ_rel</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≻</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹succ_chain <span class="skolem">l</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rel_chain_def
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">l</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?enter_rvars</span></span></span> <span class="main">=</span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">sl</span><span class="main">.</span> swap_lr <span class="skolem">l</span> <span class="bound">sl</span> <span class="bound">x</span><span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?enter_rvars</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?all_vars</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">t</span><span class="main">.</span> lvars <span class="bound">t</span> <span class="main">∪</span> rvars <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>map 𝒯 <span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?all_vars</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lvars_def rvars_def finite_vars<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?enter_rvars</span> <span class="main">⊆</span> <span class="var">?all_vars</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max <span class="var">?enter_rvars</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xr</span> <span class="main">∈</span> <span class="var">?enter_rvars</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Max_in<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?enter_rvars</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≻</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span>›</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="main">::</span> <span class="quoted">var</span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> succ_vars<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> <span class="var">?enter_rvars</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">l</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?enter_rvars</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="var">?enter_rvars</span>›</span></span>
        <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xr</span></span> <span class="skolem"><span class="skolem">sl</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">xr</span> <span class="main">=</span> <span class="var">?xr</span>"</span></span> <span class="quoted"><span class="quoted">"swap_lr <span class="skolem">l</span> <span class="skolem">sl</span> <span class="skolem">xr</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sl</span><span class="main">)</span> <span class="main">≻</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹succ_chain <span class="skolem">l</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rel_chain_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">l</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">!</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_conv_nth nth_Cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xr</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xr</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">l</span> <span class="main">=</span> <span class="numeral">2</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹swap_lr <span class="skolem">l</span> <span class="skolem">sl</span> <span class="skolem">xr</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹last <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"hd <span class="skolem">l'</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">l'</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sl</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l'</span> <span class="main">=</span> length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span>  <span class="quoted"><span class="quoted">"succ_chain <span class="skolem">l'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      l'_l<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l'</span> <span class="main">⟶</span>
     <span class="main">(</span><span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l</span> <span class="main">∧</span> <span class="skolem">l'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">∧</span> <span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">l</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹last <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹succ_chain <span class="skolem">l</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> reorder_cyclic_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">sl</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xr</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span>hd <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">xr</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span>last <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l'</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹swap_lr <span class="skolem">l</span> <span class="skolem">sl</span> <span class="skolem">xr</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">l</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">sp</span><span class="main">.</span> swap_rl <span class="skolem">l'</span> <span class="bound">sp</span> <span class="skolem">xr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹succ_chain <span class="skolem">l'</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> succ_chain_swap_rl_exists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l'</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l'</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">xr</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth last_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">sp</span><span class="main">.</span> swap_rl <span class="skolem">l'</span> <span class="bound">sp</span> <span class="skolem">xr</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">sp'</span><span class="main">.</span> <span class="bound">sp'</span> <span class="main">&lt;</span> <span class="bound">sp</span> <span class="main">⟶</span> <span class="main">¬</span> swap_rl <span class="skolem">l'</span> <span class="bound">sp'</span> <span class="skolem">xr</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> min_element<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sp</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"swap_rl <span class="skolem">l'</span> <span class="skolem">sp</span> <span class="skolem">xr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">sp'</span><span class="main">.</span> <span class="bound">sp'</span> <span class="main">&lt;</span> <span class="skolem">sp</span> <span class="main">⟶</span> <span class="main">¬</span> swap_rl <span class="skolem">l'</span> <span class="bound">sp'</span> <span class="skolem">xr</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">⟩</span> <span class="skolem">xr</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span><span class="main">)</span><span class="main">⟩</span> <span class="skolem">xr</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"always_r <span class="skolem">l'</span> <span class="main">0</span> <span class="skolem">sp</span> <span class="skolem">xr</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xr</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span>hd <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l'</span>›</span></span>
          <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">sp'</span><span class="main">.</span> <span class="bound">sp'</span> <span class="main">&lt;</span> <span class="skolem">sp</span> <span class="main">⟶</span> <span class="main">¬</span> swap_rl <span class="skolem">l'</span> <span class="bound">sp'</span> <span class="skolem">xr</span>›</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">sp</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 0<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">sp'</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> Suc <span class="skolem">sp'</span>"</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xr</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">sp'</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> Suc <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> Suc <span class="skolem">sp'</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xr</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Suc
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xr</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> True Suc<span class="main">(</span>3<span class="main">)</span> Suc<span class="main">(</span>4<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≻</span> <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹succ_chain <span class="skolem">l'</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> True
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_chain_def<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> succ_vars_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l'</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹succ_chain <span class="skolem">l'</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> succ_chain_always_r_valuation_id
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span><span class="main">)</span> <span class="main">≻</span> <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sp</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l'</span>›</span></span> <span class="quoted"><span class="quoted">‹succ_chain <span class="skolem">l'</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rel_chain_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">xr'</span></span> <span class="main">::</span> <span class="quoted">var</span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">xr</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"swap_lr <span class="skolem">l'</span> <span class="skolem">sp</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> succ_vars<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹swap_rl <span class="skolem">l'</span> <span class="skolem">sp</span> <span class="skolem">xr</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l'</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="skolem">xr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span><span class="main">)</span> <span class="main">≻</span> <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sp</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_tableau_def<span class="main">)</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sp'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sp'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sp'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">sp'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l'</span>›</span></span> l'_l
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="var">?enter_rvars</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹swap_lr <span class="skolem">l'</span> <span class="skolem">sp</span> <span class="skolem">xs</span>›</span></span> l'_l
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">&lt;</span> <span class="skolem">xr</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≤</span> <span class="var">?xr</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="var">?enter_rvars</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> <span class="var">?enter_rvars</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Max_ge<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xr</span> <span class="main">=</span> <span class="var">?xr</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">≠</span> <span class="skolem">xr</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sl</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?eq</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="var">?sp</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"𝒱 <span class="var">?sl</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"𝒱 <span class="var">?sp</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?sl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?sp</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sl</span> <span class="main">≻</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span> <span class="main">≻</span> <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sp</span><span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="var">?sp</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="var">?sl</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">l'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l'</span>›</span></span> <span class="quoted"><span class="quoted">‹succ_chain <span class="skolem">l'</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> succ_chain_bounds_id
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span>last <span class="skolem">l'</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹last <span class="skolem">l'</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sl</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> diff_satified<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">xs</span> <span class="main">-</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="main">⦄</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="main">⦄</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="var">?eq</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?sp</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> eq_for_lvar<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="quoted">"𝒯 <span class="var">?sp</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span><span class="main">)</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> curr_val_satisfies_no_lhs_def satisfies_tableau_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="var">?eq</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sl</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sp'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sp'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sl</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹succ_chain <span class="skolem">l</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> succ_chain_tableau_equiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">sl</span></span> <span class="quoted"><span class="skolem">sp'</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?sl</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> curr_val_satisfies_no_lhs_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> satisfies_tableau_def
          <span class="keyword1"><span class="command">using</span></span> eq_for_lvar
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span><span class="main">)</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lhs <span class="var">?eq</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span><span class="main">)</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> eq_for_lvar
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> satisfies_eq_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> in_bounds <span class="skolem">xr</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="var">?sl</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sl</span> <span class="main">≻</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span>  <span class="quoted"><span class="quoted">‹swap_lr <span class="skolem">l</span> <span class="skolem">sl</span> <span class="skolem">xr</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> succ_min_lvar_not_in_bounds<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?sl</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">xr</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">xr</span> <span class="main">⟶</span> in_bounds <span class="bound">x</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="var">?sl</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">xr</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"in_bounds <span class="skolem">x</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="var">?sl</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="var">?sl</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> succ_min_lvar_not_in_bounds<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?sl</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">xr</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sl</span> <span class="main">≻</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span>  <span class="quoted"><span class="quoted">‹swap_lr <span class="skolem">l</span> <span class="skolem">sl</span> <span class="skolem">xr</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">xr</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?sl</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> curr_val_satisfies_no_lhs_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_bounds_set.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"in_bounds <span class="skolem">xs</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="var">?sl</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">&lt;</span> <span class="skolem">xr</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> in_bounds <span class="skolem">xs</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="var">?sp</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span> <span class="main">≻</span> <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span>  <span class="quoted"><span class="quoted">‹swap_lr <span class="skolem">l'</span> <span class="skolem">sp</span> <span class="skolem">xs</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> succ_min_lvar_not_in_bounds<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?sp</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="skolem">xr</span> <span class="main">⟶</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="skolem">xr</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"always_r <span class="skolem">l'</span> <span class="main">0</span> <span class="main">(</span>length <span class="skolem">l'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="skolem">xr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> length <span class="skolem">l'</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">!</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> length <span class="skolem">l</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l'_l <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> length <span class="skolem">l'</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">l'</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mp<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?eq'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sp'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="skolem">xr</span> <span class="main">⟶</span> always_r <span class="skolem">l</span> <span class="main">0</span> <span class="main">(</span>length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">k</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xr</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sp'</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> eq_for_lvar<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="quoted">"𝒯 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sp'</span><span class="main">)</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹swap_lr <span class="skolem">l'</span> <span class="skolem">sp</span> <span class="skolem">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sp'</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rvars_def<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">sp'</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">sp'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sp'</span><span class="main">)</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sp'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹succ_chain <span class="skolem">l</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> succ_chain_vars_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">sp'</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"swap_lr <span class="skolem">l</span> <span class="skolem">i'</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sp'</span><span class="main">)</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">sp'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sp'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹succ_chain <span class="skolem">l</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> succ_chain_swap_lr_exists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">sp'</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?enter_rvars</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="var">?xr</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="var">?enter_rvars</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> Max_ge<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?enter_rvars</span></span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&gt;</span> <span class="skolem">xr</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xr</span> <span class="main">=</span> <span class="var">?xr</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span>last <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹last <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sp'</span><span class="main">)</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth<span class="main">)</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span>last <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_conv_nth<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="skolem">l</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">l</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sp'</span><span class="main">)</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sp'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="skolem">l</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> succ_chain_vars_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">sp'</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹succ_chain <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"swap_lr <span class="skolem">l</span> <span class="skolem">i'</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹succ_chain <span class="skolem">l</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span>last <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> succ_chain_swap_lr_exists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_conv_nth<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?enter_rvars</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="var">?xr</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="var">?enter_rvars</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> Max_ge<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?enter_rvars</span></span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&gt;</span> <span class="skolem">xr</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xr</span> <span class="main">=</span> <span class="var">?xr</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">k'</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&gt;</span> <span class="skolem">xr</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">&lt;</span> length <span class="skolem">l</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sp'</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">!</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">k</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">l'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹succ_chain <span class="skolem">l'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">l'</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> succ_chain_always_r_valuation_id<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="main">(</span>last <span class="skolem">l'</span><span class="main">)</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹last <span class="skolem">l'</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sl</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">xr</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="skolem">xr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span>𝒱 <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">⟩</span> <span class="skolem">xr</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span><span class="main">)</span><span class="main">⟩</span> <span class="skolem">xr</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">l'</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth<span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">dir1</span> <span class="skolem">dir2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> dir1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">xr</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="var">?sl</span> <span class="skolem">xr</span> <span class="keyword1">then</span> Positive <span class="keyword1">else</span> Negative<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir1</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">xr</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir1</span> <span class="var">?sl</span> <span class="skolem">xr</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> in_bounds <span class="skolem">xr</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="var">?sl</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> neg_bounds_compare<span class="main">(</span>7<span class="main">)</span> neg_bounds_compare<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare''_defs<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir1</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">xr</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir1</span> <span class="var">?sl</span> <span class="skolem">xr</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bounds_compare_contradictory<span class="main">(</span>7<span class="main">)</span> bounds_compare_contradictory<span class="main">(</span>3<span class="main">)</span> neg_bounds_compare<span class="main">(</span>6<span class="main">)</span> dir1
        <span class="keyword1"><span class="command">unfolding</span></span> bound_compare''_defs
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LB <span class="skolem">dir1</span> <span class="var">?sl</span> <span class="skolem">xr</span> <span class="main">≠</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir1</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">xr</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir1</span> <span class="var">?sl</span> <span class="skolem">xr</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"LB <span class="skolem">dir1</span> <span class="var">?sl</span> <span class="skolem">xr</span>"</span></span><span class="main">)</span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>

      <span class="keyword3"><span class="command">assume</span></span> dir2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir2</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">xs</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="var">?sp</span> <span class="skolem">xs</span> <span class="keyword1">then</span> Positive <span class="keyword1">else</span> Negative<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir2</span> <span class="var">?sp</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> in_bounds <span class="skolem">xs</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="var">?sp</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> neg_bounds_compare<span class="main">(</span>2<span class="main">)</span> neg_bounds_compare<span class="main">(</span>6<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare''_defs<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir2</span> <span class="var">?sp</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bounds_compare_contradictory<span class="main">(</span>3<span class="main">)</span> bounds_compare_contradictory<span class="main">(</span>7<span class="main">)</span> neg_bounds_compare<span class="main">(</span>6<span class="main">)</span> dir2
        <span class="keyword1"><span class="command">unfolding</span></span> bound_compare''_defs
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">xr</span> <span class="main">⟶</span> <span class="main">¬</span> reasable_var <span class="skolem">dir2</span> <span class="bound">x</span> <span class="var">?eq</span> <span class="var">?sp</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> succ_min_rvar<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?sp</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">xr</span></span> <span class="var"><span class="quoted"><span class="var">?eq</span></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span> <span class="main">≻</span> <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹swap_lr <span class="skolem">l'</span> <span class="skolem">sp</span> <span class="skolem">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹swap_rl <span class="skolem">l'</span> <span class="skolem">sp</span> <span class="skolem">xr</span>›</span></span> dir2
        <span class="keyword1"><span class="command">unfolding</span></span> bound_compare''_defs
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LB <span class="skolem">dir2</span> <span class="var">?sp</span> <span class="skolem">xs</span> <span class="main">≠</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir2</span> <span class="var">?sp</span> <span class="skolem">xs</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"LB <span class="skolem">dir2</span> <span class="var">?sp</span> <span class="skolem">xs</span>"</span></span><span class="main">)</span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">xr</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">(</span>coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>UB <span class="skolem">dir2</span> <span class="var">?sp</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
         <span class="main">(</span>coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="keyword1">⊴<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir2</span> <span class="var">?sp</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">xr</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>UB <span class="skolem">dir2</span> <span class="var">?sp</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">xr</span> <span class="main">⟶</span> <span class="main">¬</span> reasable_var <span class="skolem">dir2</span> <span class="bound">x</span> <span class="var">?eq</span> <span class="var">?sp</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>UB <span class="skolem">dir2</span> <span class="var">?sp</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> dir2 neg_bounds_compare<span class="main">(</span>4<span class="main">)</span> neg_bounds_compare<span class="main">(</span>8<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> bound_compare''_defs
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">xr</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊳<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir2</span> <span class="var">?sp</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">xr</span> <span class="main">⟶</span> <span class="main">¬</span> reasable_var <span class="skolem">dir2</span> <span class="bound">x</span> <span class="var">?eq</span> <span class="var">?sp</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊴<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir2</span> <span class="var">?sp</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> dir2 neg_bounds_compare<span class="main">(</span>4<span class="main">)</span> neg_bounds_compare<span class="main">(</span>8<span class="main">)</span> dir2
          <span class="keyword1"><span class="command">unfolding</span></span> bound_compare''_defs
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir2</span> <span class="var">?sp</span> <span class="skolem">xs</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="var">?sp</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="var">?sl</span>›</span></span> dir2
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹in_bounds <span class="skolem">xs</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="var">?sl</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare''_defs
            <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">xs</span> <span class="main">-</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dir2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_gt<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> minus_lt<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="main">⦄</span> <span class="main">-</span> <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="main">⦄</span><span class="main">)</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span><span class="main">.</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span> le <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
                    <span class="main">(</span>coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟶</span> le <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>"</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">⟶</span> le <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
                <span class="main">(</span>coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟶</span> le <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">xr</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"in_bounds <span class="skolem">x</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="var">?sl</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">xr</span> <span class="main">⟶</span> in_bounds <span class="bound">x</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="var">?sl</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊵<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span><span class="main">)</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>UB <span class="skolem">dir2</span> <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> * <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">xr</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹in_bounds <span class="skolem">x</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="var">?sl</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="var">?sp</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="var">?sl</span>›</span></span> dir2
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare''_defs<span class="main">)</span>
                <span class="keyword1"><span class="command">using</span></span> bounds_lg<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sl</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">using</span></span> bounds_lg<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sl</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">unfolding</span></span> bound_compare''_defs
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lt <span class="skolem">dir2</span> <span class="main">0</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≠</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> minus_gt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span><span class="main">]</span> minus_lt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span><span class="main">]</span> dir2
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊴<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span><span class="main">)</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir2</span> <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> * <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">xr</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹in_bounds <span class="skolem">x</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="var">?sl</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="var">?sp</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="var">?sl</span>›</span></span> dir2
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare''_defs<span class="main">)</span>
                <span class="keyword1"><span class="command">using</span></span> bounds_lg<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sl</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">using</span></span> bounds_lg<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sl</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">unfolding</span></span> bound_compare''_defs
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lt <span class="skolem">dir2</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> minus_gt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span><span class="main">]</span> minus_lt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span><span class="main">]</span> dir2
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">xr</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="skolem">xr</span> <span class="main">=</span> the <span class="main">(</span>LB <span class="skolem">dir1</span> <span class="var">?sl</span> <span class="skolem">xr</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sl</span> <span class="main">≻</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹swap_lr <span class="skolem">l</span> <span class="skolem">sl</span> <span class="skolem">xr</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> succ_set_on_bound<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">!</span> <span class="skolem">sl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">xr</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir1</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">xr</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir1</span> <span class="var">?sl</span> <span class="skolem">xr</span><span class="main">)</span>›</span></span> dir1
                <span class="keyword1"><span class="command">unfolding</span></span> bound_compare''_defs
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">xr</span> <span class="main">=</span> the <span class="main">(</span>LB <span class="skolem">dir1</span> <span class="var">?sl</span> <span class="skolem">xr</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">xr</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sl</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="skolem">xr</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lt <span class="skolem">dir1</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">xr</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">xr</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹LB <span class="skolem">dir1</span> <span class="var">?sl</span> <span class="skolem">xr</span> <span class="main">≠</span> None›</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir1</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">xr</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir1</span> <span class="var">?sl</span> <span class="skolem">xr</span><span class="main">)</span>›</span></span> dir1
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>

              <span class="keyword1"><span class="command">moreover</span></span>

              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reasable_var <span class="skolem">dir2</span> <span class="skolem">xr</span> <span class="var">?eq</span> <span class="var">?sp</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir2</span> <span class="var">?sp</span> <span class="skolem">xs</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span> <span class="main">≻</span> <span class="main">(</span><span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹swap_lr <span class="skolem">l'</span> <span class="skolem">sp</span> <span class="skolem">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹swap_rl <span class="skolem">l'</span> <span class="skolem">sp</span> <span class="skolem">xr</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> succ_min_rvar<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">!</span> <span class="skolem">sp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">sp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">xr</span></span> <span class="var"><span class="quoted"><span class="var">?eq</span></span></span><span class="main">]</span> dir2
                <span class="keyword1"><span class="command">unfolding</span></span> bound_compare''_defs
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="skolem">dir1</span> <span class="main">=</span> <span class="skolem">dir2</span> <span class="keyword1">then</span> coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">xr</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">else</span> coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">xr</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">xr</span> <span class="main">=</span> the <span class="main">(</span>LB <span class="skolem">dir1</span> <span class="var">?sl</span> <span class="skolem">xr</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="var">?sp</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="var">?sl</span>›</span></span><span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> dir1
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹LB <span class="skolem">dir1</span> <span class="var">?sl</span> <span class="skolem">xr</span> <span class="main">≠</span> None›</span></span> dir1 dir2
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs
                    indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir1</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir1</span> <span class="main">=</span> Negative"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir2</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir2</span> <span class="main">=</span> Negative"</span></span>
                <span class="keyword1"><span class="command">using</span></span> dir1 dir2
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">xr</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> minus_lt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">xr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">xr</span>"</span></span><span class="main">]</span> minus_gt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">xr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">xr</span>"</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="skolem">xr</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">xr</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="skolem">xr</span> <span class="main">⟶</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="bound">x</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>rhs <span class="var">?eq</span> <span class="main">⦃</span> <span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">⦄</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> dir2
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">using</span></span> valuate_nonneg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rhs <span class="var">?eq</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="bound">x</span>"</span></span><span class="main">]</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">using</span></span> valuate_nonpos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rhs <span class="var">?eq</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="bound">x</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="main">⦄</span> <span class="main">-</span> <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="main">⦄</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> valuate_diff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le <span class="main">(</span>lt <span class="skolem">dir2</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="main">⦄</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="main">⦄</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> minus_lt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="main">⦄</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="main">⦄</span>"</span></span><span class="main">]</span> dir2
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> dir2
          <span class="keyword1"><span class="command">using</span></span> minus_lt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="main">⦄</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="main">⦄</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> minus_gt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="var">?bp</span><span class="main">⟩</span> <span class="main">⦄</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="var">?bl</span><span class="main">⟩</span> <span class="main">⦄</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> diff_satified dir2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* -------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="command">lemma</span></span> check_unsat_terminates<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"𝒰 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"check_dom <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> check_dom.intros<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> check_sat_terminates'_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    dir<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dir</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">then</span> Positive <span class="keyword1">else</span> Negative<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">s</span> <span class="main">≻</span> <span class="bound">s'</span><span class="main">;</span> <span class="main">∇</span> <span class="bound">s'</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="bound">s'</span><span class="main">)</span><span class="main">;</span> <span class="main">◇</span> <span class="bound">s'</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> check_dom <span class="bound">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"check_dom
            <span class="main">(</span><span class="keyword1">case</span> min_rvar_incdec <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">of</span> Inl <span class="bound">I</span> <span class="main">⇒</span> set_unsat <span class="bound">I</span> <span class="free">s</span>
             <span class="main">|</span> Inr <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">⇒</span> <span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">(</span>the <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"min_rvar_incdec <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Inl
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> check_unsat_terminates <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> xj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_of_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_rvar_incdec_eq_Some_rvars<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> dir
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">pivot_and_update</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">(</span>the <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"check_dom <span class="var">?s'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> * <span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="var">?s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="var">?s'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="var">?s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?s'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span>  Inr
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">◇</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>›</span></span>  dir
      <span class="keyword1"><span class="command">using</span></span> pivotandupdate_check_precond
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> xi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>8<span class="main">)</span> min_lvar_not_in_bounds_lvars <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≻</span> <span class="var">?s'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gt_state_def
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">◇</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="free">s</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="free">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">(</span>LB <span class="free">dir</span> <span class="free">s</span> <span class="free">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>›</span></span>
        Inr dir
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI pivotandupdate_bounds_id pivotandupdate_unsat_core_id<span class="main"><span class="keyword3">,</span></span>
          <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> xj xi<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Inr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> check_sat_terminates'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≻<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"check_dom <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">y</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="main"><span class="main">≻<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">≻</span></span> <span class="bound"><span class="bound">y</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≻<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≻</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_acyclic_wf<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≻<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≻</span> <span class="bound">s'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≻<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">s</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊆</span> <span class="var">?B</span> <span class="main">×</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">p</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">p</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rtrancl_into_trancl1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">p</span>"</span></span> <span class="quoted">succ_rel</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">p</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="var">?B</span> <span class="main">×</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mem_Sigma_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">p</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_accessible_states<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> finite_subset<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">×</span> <span class="var">?B</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"acyclic <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊆</span> succ_rel<span class="main">¯</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> acyclic_converse acyclic_subset
        <span class="keyword1"><span class="command">using</span></span> acyclic_suc_rel
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≻<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≻</span> <span class="bound">y</span><span class="main">}</span> <span class="main">⟶</span> <span class="main">∇</span> <span class="bound">s'</span> <span class="main">⟶</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="bound">s'</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">◇</span> <span class="bound">s'</span> <span class="main">⟶</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">s'</span> <span class="main">⟶</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≻<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">s'</span> <span class="main">⟶</span> check_dom <span class="bound">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">" <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≻<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span><span class="skolem">s</span> <span class="main">≻</span> <span class="bound">s'</span><span class="main">;</span> <span class="main">∇</span> <span class="bound">s'</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="bound">s'</span><span class="main">)</span><span class="main">;</span> <span class="main">◇</span> <span class="bound">s'</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> check_dom <span class="bound">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rtrancl_into_trancl1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted">succ_rel</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> trancl_into_rtrancl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="main">_</span> <span class="quoted">succ_rel</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"check_dom <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> check_dom.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check'_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> Positive_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> Negative_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="free">min_lvar_not_in_bounds</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> LB Positive <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"check_dom
            <span class="main">(</span><span class="keyword1">case</span> min_rvar_incdec Positive <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">of</span>
               Inl <span class="bound">I</span> <span class="main">⇒</span> set_unsat <span class="bound">I</span> <span class="skolem">s</span>
             <span class="main">|</span> Inr <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">⇒</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">(</span>the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> LB Positive <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> check_sat_terminates'_aux<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">Positive</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">◇</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>›</span></span> *
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> 𝒰 <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="free">min_lvar_not_in_bounds</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare''_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="free">min_lvar_not_in_bounds</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> min_lvar_not_in_bounds_Some<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> neg_bounds_compare<span class="main">(</span>7<span class="main">)</span> neg_bounds_compare<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> LB Negative <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"check_dom
            <span class="main">(</span><span class="keyword1">case</span> min_rvar_incdec Negative <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">of</span>
               Inl <span class="bound">I</span> <span class="main">⇒</span> set_unsat <span class="bound">I</span> <span class="skolem">s</span>
             <span class="main">|</span> Inr <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">⇒</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">(</span>the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> LB Negative <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> check_sat_terminates'_aux<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">◇</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>›</span></span> *
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> 𝒰 <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="free">min_lvar_not_in_bounds</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare''_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> check_sat_terminates<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"check_dom <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">using</span></span> check_sat_terminates'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">lemma</span></span> check_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"𝒰 <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> None<span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">dir</span> <span class="bound">I</span><span class="main">.</span>
    <span class="main">⟦</span><span class="bound">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="bound">dir</span> <span class="main">=</span> Negative<span class="main">;</span>
     <span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">;</span>
     <span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">(</span>LB <span class="bound">dir</span> <span class="free">s</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">;</span>
     min_rvar_incdec <span class="bound">dir</span> <span class="free">s</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inl <span class="bound">I</span><span class="main">⟧</span> <span class="main">⟹</span>
        <span class="free">P</span> <span class="main">(</span>set_unsat <span class="bound">I</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="bound">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">dir</span><span class="main">.</span>
    <span class="main">⟦</span><span class="bound">dir</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">then</span> Positive <span class="keyword1">else</span> Negative<span class="main">)</span><span class="main">;</span>
     <span class="main">¬</span> 𝒰 <span class="free">s</span><span class="main">;</span> <span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">;</span>
     <span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">(</span>LB <span class="bound">dir</span> <span class="free">s</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">;</span>
     min_rvar_incdec <span class="bound">dir</span> <span class="free">s</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">;</span>
     <span class="bound">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> the <span class="main">(</span>LB <span class="bound">dir</span> <span class="free">s</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">;</span>
     check' <span class="bound">dir</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="bound">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
        <span class="free">P</span> <span class="main">(</span>check <span class="main">(</span><span class="free">pivot_and_update</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="bound">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>check <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"𝒰 <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> check.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> 𝒰 <span class="free">s</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">◇</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> check.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dir</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>Positive <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>Direction<span class="main">)</span> <span class="keyword1">else</span> Negative"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"check' <span class="var">?dir</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="var">?dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>  <span class="main">(</span>LB <span class="var">?dir</span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> min_lvar_not_in_bounds_Some<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> not_in_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare''_defs<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>check <span class="var">?s'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> check'_cases<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> 𝒰 <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="var">?dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>  <span class="main">(</span>LB <span class="var">?dir</span> <span class="free">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?dir</span></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?dir</span></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> check.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set_unsat <span class="main">(</span><span class="main">_</span> <span class="main">::</span> <span class="tfree">'i</span> list<span class="main">)</span> <span class="free">s</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">◇</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  bounds_consistent_def  curr_val_satisfies_no_lhs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> 𝒰 <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">min_lvar_not_in_bounds</span> <span class="free">s</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> check.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">◇</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> check_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> **<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> 𝒰 <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span><span class="main">¬</span> 𝒰 <span class="bound">s</span><span class="main">;</span> <span class="free">min_lvar_not_in_bounds</span> <span class="bound">s</span> <span class="main">=</span> None<span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">dir</span> <span class="bound">I</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="bound">dir</span> <span class="main">=</span> Negative<span class="main">;</span> <span class="main">¬</span> 𝒰 <span class="bound">s</span><span class="main">;</span> <span class="free">min_lvar_not_in_bounds</span> <span class="bound">s</span> <span class="main">=</span> Some <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">;</span>
      <span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="bound">s</span><span class="main">⟩</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">(</span>LB <span class="bound">dir</span> <span class="bound">s</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">;</span> min_rvar_incdec <span class="bound">dir</span> <span class="bound">s</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inl <span class="bound">I</span><span class="main">⟧</span>
     <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">(</span>set_unsat <span class="bound">I</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="bound">l<span class="hidden">⇩</span><sub>i</sub></span><span class="main">.</span> <span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="bound">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="bound">s</span><span class="main">;</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="bound">s</span><span class="main">)</span><span class="main">;</span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="bound">s</span><span class="main">)</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">(</span><span class="free">pivot_and_update</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="bound">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">si</span> <span class="bound">sj</span> <span class="bound">sk</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span> <span class="bound">si</span> <span class="bound">sj</span><span class="main">;</span> <span class="free">P</span> <span class="bound">sj</span> <span class="bound">sk</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">si</span> <span class="bound">sk</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span> <span class="main">(</span>check <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"check_dom <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_sat_terminates<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> *
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> check_dom.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> check_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">dir</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dir</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">then</span> Positive <span class="keyword1">else</span> Negative"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"check' <span class="skolem">dir</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="skolem">s'</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="quoted">"min_rvar_incdec <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> the <span class="main">(</span>LB <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="var">?s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> <span class="var">?dir</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="var">?s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="var">?s'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="var">?s'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">◇</span> <span class="skolem">s'</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s'</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> pivotandupdate_check_precond<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">dir</span></span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>check' <span class="skolem">dir</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">(</span>check <span class="main">(</span>check' <span class="skolem">dir</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span> step<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="skolem">s'</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s'</span> <span class="main">(</span>check <span class="main">(</span><span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="skolem">s'</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">min_lvar_not_in_bounds</span> <span class="skolem">s'</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹min_rvar_incdec <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> step'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> trans'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="quoted"><span class="quoted">"check <span class="var">?s'</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_lvar_not_in_bounds_lvars  min_rvar_incdec_eq_Some_rvars<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">◇</span> <span class="skolem">s'</span>›</span></span> **<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> check_induct'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">dir</span> <span class="bound">I</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="bound">dir</span> <span class="main">=</span> Negative<span class="main">;</span> <span class="main">¬</span> 𝒰 <span class="bound">s</span><span class="main">;</span> <span class="free">min_lvar_not_in_bounds</span> <span class="bound">s</span> <span class="main">=</span> Some <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">;</span>
  <span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="bound">s</span><span class="main">⟩</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">(</span>LB <span class="bound">dir</span> <span class="bound">s</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">;</span> min_rvar_incdec <span class="bound">dir</span> <span class="bound">s</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inl <span class="bound">I</span><span class="main">;</span> <span class="free">P</span> <span class="bound">s</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>set_unsat <span class="bound">I</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="bound">l<span class="hidden">⇩</span><sub>i</sub></span><span class="main">.</span> <span class="main">⟦</span><span class="main">△</span> <span class="main">(</span>𝒯 <span class="bound">s</span><span class="main">)</span><span class="main">;</span> <span class="main">∇</span> <span class="bound">s</span><span class="main">;</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="bound">s</span><span class="main">)</span><span class="main">;</span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="bound">s</span><span class="main">)</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">;</span> <span class="free">P</span> <span class="bound">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="free">pivot_and_update</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="bound">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>check <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span>check <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> check_induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">s</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> check_induct''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> **<span class="main">:</span>
    <span class="quoted"><span class="quoted">"𝒰 <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span><span class="main">∇</span> <span class="bound">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="bound">s</span><span class="main">)</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">s</span><span class="main">;</span> <span class="main">◇</span> <span class="bound">s</span><span class="main">;</span> <span class="main">¬</span> 𝒰 <span class="bound">s</span><span class="main">;</span> <span class="free">min_lvar_not_in_bounds</span> <span class="bound">s</span> <span class="main">=</span> None<span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">dir</span> <span class="bound">I</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="bound">dir</span> <span class="main">=</span> Negative<span class="main">;</span> <span class="main">∇</span> <span class="bound">s</span><span class="main">;</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="bound">s</span><span class="main">)</span><span class="main">;</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">s</span><span class="main">;</span> <span class="main">◇</span> <span class="bound">s</span><span class="main">;</span>  <span class="main">¬</span> 𝒰 <span class="bound">s</span><span class="main">;</span>
    <span class="free">min_lvar_not_in_bounds</span> <span class="bound">s</span> <span class="main">=</span> Some <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">;</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="bound">s</span><span class="main">⟩</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">(</span>LB <span class="bound">dir</span> <span class="bound">s</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">;</span>
    min_rvar_incdec <span class="bound">dir</span> <span class="bound">s</span> <span class="bound">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inl <span class="bound">I</span><span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>set_unsat <span class="bound">I</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>check <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"𝒰 <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹𝒰 <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">s</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"check_dom <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_sat_terminates<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> * False
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> check_dom.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> check_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">dir</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dir</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">then</span> Positive <span class="keyword1">else</span> Negative"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"check' <span class="skolem">dir</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="skolem">s'</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="quoted">"min_rvar_incdec <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> the <span class="main">(</span>LB <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="var">?s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> <span class="var">?dir</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="var">?s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="var">?s'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="var">?s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="var">?s'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">◇</span> <span class="skolem">s'</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s'</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> pivotandupdate_check_precond<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">dir</span></span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> pivotandupdate_unsat_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_lvar_not_in_bounds_lvars  min_rvar_incdec_eq_Some_rvars<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>check <span class="main">(</span>check' <span class="skolem">dir</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span> step<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="skolem">s'</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>check <span class="main">(</span><span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?s'</span> <span class="main">=</span> <span class="free">pivot_and_update</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s'</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∇</span> <span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">◇</span> <span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> 𝒰 <span class="skolem">s'</span>›</span></span> ** <span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">lemma</span></span> poly_eval_update<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">⦃</span> <span class="free">v</span> <span class="main">(</span> <span class="free">x</span> <span class="main">:=</span> <span class="free">c</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> lrv<span class="main">)</span> <span class="main">⦄</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">⦃</span> <span class="free">v</span> <span class="main">⦄</span><span class="main">)</span> <span class="main">+</span> coeff <span class="free">p</span> <span class="free">x</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="free">v</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">p</span> <span class="skolem">v</span> <span class="skolem">x</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">y</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span> <span class="keyword1">then</span> <span class="skolem">c</span> <span class="keyword1">else</span> <span class="skolem">v</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">y</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span> <span class="keyword1">then</span> <span class="skolem">c</span> <span class="keyword1">else</span> <span class="skolem">v</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>
    <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">y</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span> <span class="keyword1">then</span> <span class="skolem">c</span> <span class="keyword1">else</span> <span class="skolem">v</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?a</span> <span class="main">+</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong fin<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">y</span> <span class="keyword1">*R</span> <span class="skolem">v</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?c</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="skolem">c</span> <span class="main">+</span> <span class="var">?c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">y</span> <span class="keyword1">*R</span> <span class="skolem">v</span> <span class="bound">y</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">-</span> <span class="skolem">v</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">y</span> <span class="keyword1">*R</span> <span class="skolem">v</span> <span class="bound">y</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">-</span> <span class="skolem">v</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">y</span> <span class="keyword1">*R</span> <span class="skolem">v</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">y</span> <span class="keyword1">*R</span> <span class="skolem">v</span> <span class="bound">y</span><span class="main">)</span> <span class="main">+</span> <span class="var">?c</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?d</span> <span class="main">+</span> <span class="main">_</span>"</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong fin<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="skolem">v</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="skolem">v</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">-</span> <span class="skolem">v</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="skolem">v</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="var">?c</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">-</span> <span class="skolem">v</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="skolem">v</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> scaleRat_right_distrib<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="skolem">c</span> <span class="main">+</span> <span class="var">?c</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> l r r_def <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> PivotUpdateMinVars
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rhs_eq_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var<span class="main">,</span> <span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> mapping <span class="main">⇒</span> var <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> eq <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RhsEqVal <span class="free">rhs_eq_val</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> check_minimal_unsat_state_core<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>check <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span> minimal_unsat_state_core <span class="main">(</span>check <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>check <span class="free">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> check_induct''<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">dir</span> <span class="skolem">I</span>
  <span class="keyword3"><span class="command">assume</span></span> nolhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> min_rvar<span class="main">:</span> <span class="quoted"><span class="quoted">"min_rvar_incdec <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Inl <span class="skolem">I</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> min_lvar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="skolem">s'</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dir<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> valuated<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s'</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?eq</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"eq_for_lvar <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> unsat_core<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>the <span class="main">(</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>set_unsat <span class="skolem">I</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> LB_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"LB <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Some <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"lt <span class="skolem">dir</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"LB <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> LB_Some dir <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> LBI<span class="main">:</span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>LBI <span class="skolem">dir</span> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> LI<span class="main">:</span> <span class="quoted"><span class="quoted">"LI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> min_rvar_incdec_eq_None<span class="main">[</span><span class="operator">OF</span> min_rvar<span class="main">]</span> dir
  <span class="keyword1"><span class="command">have</span></span> Is'<span class="main">:</span> <span class="quoted"><span class="quoted">"LI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="main">(</span>lhs <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> indices_state <span class="skolem">s'</span> <span class="main">⟹</span> set <span class="skolem">I</span> <span class="main">⊆</span> indices_state <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    reasable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span> <span class="main">⟹</span> <span class="main">¬</span> reasable_var <span class="skolem">dir</span> <span class="bound">x</span> <span class="var">?eq</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    setI<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">I</span> <span class="main">=</span>
        <span class="main">{</span>LI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="main">(</span>lhs <span class="var">?eq</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
        <span class="main">{</span>LI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span> <span class="main">∧</span> coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span>
        <span class="main">{</span>UI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?L</span> <span class="main">∪</span> <span class="var">?R1</span> <span class="main">∪</span> <span class="var">?R2</span>"</span></span><span class="main">)</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> setI <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"lhs <span class="var">?eq</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EqForLVar.eq_for_lvar EqForLVar_axioms min_lvar min_lvar_not_in_bounds_lvars<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> iI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> LI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> setI <span class="main">=</span> setI<span class="main">[</span><span class="operator">unfolded</span> id<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> indices_state <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LBI LI
    <span class="keyword1"><span class="command">unfolding</span></span> indices_state_def <span class="keyword1"><span class="command">using</span></span> dir <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> Is'<span class="main">[</span><span class="operator">unfolded</span> id<span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> Is'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">I</span> <span class="main">⊆</span> indices_state <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_lvar
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_lvar_not_in_bounds_lvars<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?eq</span> <span class="main">∈</span> set <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"lhs <span class="var">?eq</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_for_lvar<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> Is'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">I</span> <span class="main">⊆</span> indices_state <span class="main">(</span>set_unsat <span class="skolem">I</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Is' * <span class="keyword1"><span class="command">unfolding</span></span> indices_state_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="skolem">s'</span> <span class="main">∥</span> <span class="main">-</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> nolhs<span class="main">[</span><span class="operator">unfolded</span> curr_val_satisfies_no_lhs_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> norm<span class="main">[</span><span class="operator">unfolded</span> normalized_tableau_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> lvars_rvars<span class="main">:</span> <span class="quoted"><span class="quoted">"lvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span> <span class="main">∩</span> rvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> in_bnds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span> <span class="main">⟹</span> in_bounds <span class="skolem">x</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> b<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> satisfies_bounds_set.simps<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>      
    <span class="keyword3"><span class="command">assume</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_indices_state <span class="main">(</span>set_unsat <span class="skolem">I</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distinct_indices_state <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> distinct_indices_state_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> dist <span class="main">=</span> this<span class="main">[</span><span class="operator">unfolded</span> distinct_indices_state_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">i</span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∨</span> look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        coeff<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">=</span> LI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">∨</span> coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">=</span> UI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">y</span>"</span></span> 
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> coeff<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> LI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">y</span>"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> reasable<span class="main">[</span><span class="operator">OF</span> y<span class="main">]</span> coeff <span class="keyword1"><span class="command">have</span></span> not_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊳<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> LB<span class="main">:</span> <span class="quoted"><span class="quoted">"LB <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dir <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"LB <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">y</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> not_gt <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"le <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dir <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> LB <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>LBI <span class="skolem">dir</span> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> i <span class="keyword1"><span class="command">using</span></span> dir
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def indexl_def indexu_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> c dist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">d</span></span><span class="main">]</span> dir
        <span class="keyword1"><span class="command">have</span></span> yx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> y<span class="main">[</span><span class="operator">unfolded</span> yx<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> **<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> rvars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">from</span></span> in_bnds<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> le LB not_gt i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> yx <span class="keyword1"><span class="command">using</span></span> dir <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> yx<span class="main">(</span>1<span class="main">)</span> this
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> coeff<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> UI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">y</span>"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> reasable<span class="main">[</span><span class="operator">OF</span> y<span class="main">]</span> coeff <span class="keyword1"><span class="command">have</span></span> not_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊲<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span>UB <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> UB<span class="main">:</span> <span class="quoted"><span class="quoted">"UB <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dir <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"UB <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">y</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> not_gt <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"le <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">d</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dir <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> UB <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>UBI <span class="skolem">dir</span> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> i <span class="keyword1"><span class="command">using</span></span> dir
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def indexl_def indexu_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> c dist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">d</span></span><span class="main">]</span> dir
        <span class="keyword1"><span class="command">have</span></span> yx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> y<span class="main">[</span><span class="operator">unfolded</span> yx<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> **<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> rvars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">from</span></span> in_bnds<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> le UB not_gt i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> yx <span class="keyword1"><span class="command">using</span></span> dir <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> yx<span class="main">(</span>1<span class="main">)</span> this
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> coeff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> x_vars_main <span class="main">=</span> this
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∨</span> look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="var">?R1</span> <span class="main">∪</span> <span class="var">?R2</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> i <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        coeff<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">=</span> LI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">∨</span> coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">=</span> UI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">y</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> x_vars_main<span class="main">[</span><span class="operator">OF</span> c y coeff<span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> coeff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> **<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> rvars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>       
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> x_rvars <span class="main">=</span> this

    <span class="keyword1"><span class="command">have</span></span> R1R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?R1</span> <span class="main">∪</span> <span class="var">?R2</span><span class="main">,</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">s'</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> satisfies_state_index'.simps
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?R1</span> <span class="main">∪</span> <span class="var">?R2</span><span class="main">,</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="keyword1">ℬℐ</span> <span class="skolem">s'</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds_index'.simps 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI allI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span>
        <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R1</span> <span class="main">∪</span> <span class="var">?R2</span>"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> c <span class="keyword1"><span class="command">have</span></span> ci<span class="main">:</span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> boundsl_def indexl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> x_rvars<span class="main">[</span><span class="operator">OF</span> _ i<span class="main">]</span> ci <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x</span>  <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span>
        <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R1</span> <span class="main">∪</span> <span class="var">?R2</span>"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> c <span class="keyword1"><span class="command">have</span></span> ci<span class="main">:</span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> boundsu_def indexu_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> x_rvars<span class="main">[</span><span class="operator">OF</span> _ i<span class="main">]</span> ci <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> id1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>the <span class="main">(</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>set_unsat <span class="skolem">I</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">I</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> set_unsat <span class="skolem">I</span> <span class="skolem">s'</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">s'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> satisfies_state_index'.simps boundsl_def boundsu_def indexl_def indexu_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subsets_sat_core <span class="main">(</span>set_unsat <span class="skolem">I</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> subsets_sat_core_def id1
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">J</span>
      <span class="keyword3"><span class="command">assume</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">⊂</span> set <span class="skolem">I</span>"</span></span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">s'</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">⊆</span> <span class="var">?R1</span> <span class="main">∪</span> <span class="var">?R2</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> R1R2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">s'</span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> satisfies_state_index'.simps satisfies_bounds_index'.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> sub <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="var">?R1</span> <span class="main">∪</span> <span class="var">?R2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∉</span> <span class="skolem">J</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> set <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> setI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> k<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> coeff<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">=</span> LI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">∨</span> coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">=</span> UI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> cy0<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>        
        <span class="keyword1"><span class="command">from</span></span> y **<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ry<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rvars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>      
        <span class="keyword1"><span class="command">hence</span></span> yl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lvars_rvars <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">interpret</span></span> rev<span class="main">:</span> RhsEqVal <span class="quoted"><span class="free">rhs_eq_val</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">note</span></span> update <span class="main">=</span> rev.update_valuation_nonlhs<span class="main">[</span><span class="operator">THEN</span> mp<span class="main">,</span> <span class="operator">OF</span> norm valuated yl<span class="main">]</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">diff</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">diff</span> <span class="main">=</span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">&lt;</span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">&lt;</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟹</span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">-</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> minus_gt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> minus_lt<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> lt dir <span class="keyword1"><span class="command">have</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"lt <span class="skolem">dir</span> <span class="main">0</span> <span class="skolem">diff</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_def<span class="main">)</span> 
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">up</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">up</span> <span class="main">=</span> inverse <span class="main">(</span>coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="skolem">diff</span>"</span></span> 
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="main">(</span>rev.update <span class="skolem">y</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">up</span><span class="main">)</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">⟩</span>"</span></span> 
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies_state_index'.simps
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">v</span></span></span></span><span class="main"><span class="main">]</span></span> conjI<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> v_def 
            <span class="keyword1"><span class="command">using</span></span> rev.update_satisfies_tableau<span class="main">[</span><span class="operator">OF</span> norm valuated yl<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> **<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="var">?eq</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies_tableau_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> satisfies_eq_def id<span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> v_xi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="main">(</span>rhs <span class="var">?eq</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>  
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s'</span>›</span></span> **<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="var">?eq</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies_tableau_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> V_xi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="main">(</span>rhs <span class="var">?eq</span> <span class="main">⦃</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="main">⦄</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies_eq_def id <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">+</span> coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">y</span> <span class="keyword1">*R</span> <span class="skolem">up</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> v_xi <span class="keyword1"><span class="command">unfolding</span></span> v_def rev.update_valuate_rhs<span class="main">[</span><span class="operator">OF</span> **<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> norm<span class="main">]</span> poly_eval_update V_xi <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> up_def diff_def scaleRat_scaleRat <span class="keyword1"><span class="command">using</span></span> cy0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> v_xi_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> both<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="var">?R1</span> <span class="main">∪</span> <span class="var">?R2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">≠</span> None"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="var">?R1</span> <span class="main">∪</span> <span class="var">?R2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">≠</span> None"</span></span> 
              <span class="keyword2"><span class="keyword">and</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> both<span class="main">(</span>1<span class="main">)</span> dir <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xu</span></span> <span class="skolem"><span class="skolem">cu</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
              looku<span class="main">:</span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">xu</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">cu</span><span class="main">)</span> <span class="main">∨</span> look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">xu</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span><span class="main">,</span><span class="skolem">cu</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Is' indices_state_def le_sup_iff mem_Collect_eq setI set_unsat_simps subsetCE<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> both<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xu'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xu'</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">xu'</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">=</span> LI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">xu'</span> <span class="main">∨</span>
                   coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">xu'</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">=</span> UI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">xu'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">with</span></span> x_vars_main<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> looku this<span class="main">]</span> 
            <span class="keyword1"><span class="command">have</span></span> xu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xu</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">xu</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">=</span> LI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">xu</span> <span class="main">∨</span>
                   coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">xu</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">=</span> UI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">xu</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xu</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> 
              <span class="keyword1"><span class="command">with</span></span> dist<span class="main">[</span><span class="operator">OF</span> looku<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> None"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">y</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsu_def indexu_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> both<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> boundsu_def<span class="main">)</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">hence</span></span> xu_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xu</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">from</span></span> both<span class="main">(</span>3<span class="main">)</span> dir <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xl</span></span> <span class="skolem"><span class="skolem">cl</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
              lookl<span class="main">:</span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">xl</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">cl</span><span class="main">)</span> <span class="main">∨</span> look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">xl</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span><span class="main">,</span><span class="skolem">cl</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Is' indices_state_def le_sup_iff mem_Collect_eq setI set_unsat_simps subsetCE<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> both<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xl'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xl'</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">xl'</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">=</span> LI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">xl'</span> <span class="main">∨</span>
                   coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">xl'</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">=</span> UI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">xl'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">with</span></span> x_vars_main<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> lookl this<span class="main">]</span> 
            <span class="keyword1"><span class="command">have</span></span> xl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xl</span> <span class="main">∈</span> rvars_eq <span class="var">?eq</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">xl</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">=</span> LI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">xl</span> <span class="main">∨</span>
                   coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">xl</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">=</span> UI <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">xl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xl</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> 
              <span class="keyword1"><span class="command">with</span></span> dist<span class="main">[</span><span class="operator">OF</span> lookl<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> None"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">y</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def indexl_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> both<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> boundsl_def<span class="main">)</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">hence</span></span> xl_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xl</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">from</span></span> xu<span class="main">(</span>2<span class="main">)</span> xl<span class="main">(</span>2<span class="main">)</span> diff <span class="keyword1"><span class="command">have</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xu</span> <span class="main">≠</span> <span class="skolem">xl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> xu_y xl_y <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> both_y_False <span class="main">=</span> this
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="keyword1">ℬℐ</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds_index'.simps
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI allI impI<span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span>
            <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span> 
            <span class="keyword1"><span class="command">with</span></span> k <span class="keyword1"><span class="command">have</span></span> not_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> ci<span class="main">:</span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> boundsl_def indexl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> 
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword1"><span class="command">hence</span></span> iR12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R1</span> <span class="main">∪</span> <span class="var">?R2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sub x <span class="keyword1"><span class="command">unfolding</span></span> setI LI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">from</span></span> x_rvars<span class="main">(</span>2-3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ iR12<span class="main">]</span> ci <span class="keyword1"><span class="command">have</span></span> xr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">with</span></span> lvars_rvars <span class="keyword1"><span class="command">have</span></span> xl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> False
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> val <span class="keyword1"><span class="command">unfolding</span></span> v_def map2fun_def' update<span class="main">[</span><span class="operator">OF</span> xl<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> val <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> True
                <span class="keyword1"><span class="command">note</span></span> coeff <span class="main">=</span> coeff<span class="main">[</span><span class="operator">folded</span> True<span class="main">]</span>
                <span class="keyword1"><span class="command">from</span></span> coeff not_k dir ci <span class="keyword1"><span class="command">have</span></span> Iu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">with</span></span> ci Iu x<span class="main">(</span>2<span class="main">)</span> k sub False True
                <span class="keyword1"><span class="command">have</span></span> both<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="var">?R1</span> <span class="main">∪</span> <span class="var">?R2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="var">?R1</span> <span class="main">∪</span> <span class="var">?R2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span>"</span></span> 
                  <span class="keyword1"><span class="command">unfolding</span></span> setI LI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> x True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">from</span></span> both_y_False<span class="main">[</span><span class="operator">OF</span> both<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ both<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this diff<span class="main">]</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
                <span class="keyword1"><span class="command">with</span></span> reasable<span class="main">[</span><span class="operator">OF</span> y<span class="main">]</span> dir coeff True 
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Negative <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">⟹</span> <span class="main">0</span> <span class="main">&gt;</span> coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
                <span class="keyword1"><span class="command">with</span></span> dir coeff<span class="main">[</span><span class="operator">unfolded</span> True<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">with</span></span> diff Iu False True
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">from</span></span> LBI ci<span class="main">[</span><span class="operator">unfolded</span> True<span class="main">]</span> dir 
                dist<span class="main">[</span><span class="operator">unfolded</span> distinct_indices_state_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">have</span></span> xxi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> vxi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> xxi v_xi_l <span class="keyword1"><span class="command">..</span></span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">c</span>
            <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span> 
            <span class="keyword1"><span class="command">with</span></span> k <span class="keyword1"><span class="command">have</span></span> not_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> ci<span class="main">:</span> <span class="quoted"><span class="quoted">"look <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> boundsu_def indexu_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> 
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword1"><span class="command">hence</span></span> iR12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R1</span> <span class="main">∪</span> <span class="var">?R2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sub x <span class="keyword1"><span class="command">unfolding</span></span> setI LI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">from</span></span> x_rvars<span class="main">(</span>2-3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ iR12<span class="main">]</span> ci <span class="keyword1"><span class="command">have</span></span> xr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">with</span></span> lvars_rvars <span class="keyword1"><span class="command">have</span></span> xl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> False
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> val <span class="keyword1"><span class="command">unfolding</span></span> v_def map2fun_def' update<span class="main">[</span><span class="operator">OF</span> xl<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> val <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> True
                <span class="keyword1"><span class="command">note</span></span> coeff <span class="main">=</span> coeff<span class="main">[</span><span class="operator">folded</span> True<span class="main">]</span>
                <span class="keyword1"><span class="command">from</span></span> coeff not_k dir ci <span class="keyword1"><span class="command">have</span></span> Iu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">with</span></span> ci Iu x<span class="main">(</span>2<span class="main">)</span> k sub False True
                <span class="keyword1"><span class="command">have</span></span> both<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="var">?R1</span> <span class="main">∪</span> <span class="var">?R2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="var">?R1</span> <span class="main">∪</span> <span class="var">?R2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span>"</span></span> 
                  <span class="keyword1"><span class="command">unfolding</span></span> setI LI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> x True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">from</span></span> both_y_False<span class="main">[</span><span class="operator">OF</span> both<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this both<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ diff<span class="main">]</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
                <span class="keyword1"><span class="command">with</span></span> reasable<span class="main">[</span><span class="operator">OF</span> y<span class="main">]</span> dir coeff True 
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Negative <span class="main">⟹</span> <span class="main">0</span> <span class="main">&gt;</span> coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
                <span class="keyword1"><span class="command">with</span></span> dir coeff<span class="main">[</span><span class="operator">unfolded</span> True<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">with</span></span> diff Iu False True
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">from</span></span> LBI ci<span class="main">[</span><span class="operator">unfolded</span> True<span class="main">]</span> dir 
                dist<span class="main">[</span><span class="operator">unfolded</span> distinct_indices_state_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">have</span></span> xxi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> vxi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> xxi v_xi_l <span class="keyword1"><span class="command">..</span></span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> minimal_core <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> unsat_core<span class="main">:</span> <span class="quoted"><span class="quoted">"unsat_state_core <span class="main">(</span>set_unsat <span class="skolem">I</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> unsat_state_core_def unsat_core
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> impI conjI Is'<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">I</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub></span> set_unsat <span class="skolem">I</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Iv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">I</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> satisfies_state_index.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Iv <span class="keyword1"><span class="command">have</span></span> vt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Iv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="skolem">I</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬℐ</span> <span class="skolem">s'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> satisfies_state_index.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> lt_le_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Iv dir
    <span class="keyword1"><span class="command">have</span></span> lb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">i</span> <span class="bound">c</span> <span class="bound">l</span><span class="main">.</span> look <span class="main">(</span>LBI <span class="skolem">dir</span> <span class="skolem">s'</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">l</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="skolem">I</span> <span class="main">⟹</span> le <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span><span class="skolem">v</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds_index.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lt_le_eq indexl_def indexu_def boundsl_def boundsu_def<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> lb<span class="main">[</span><span class="operator">OF</span> LBI iI<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> li_x<span class="main">:</span> <span class="quoted"><span class="quoted">"le <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">l<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="skolem">v</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="var">?eq</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nolhs <span class="quoted"><span class="quoted">‹<span class="var">?eq</span> <span class="main">∈</span> set <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> curr_val_satisfies_no_lhs_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_tableau_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="main">⦄</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹lhs <span class="var">?eq</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_eq_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="var">?eq</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> vt <span class="quoted"><span class="quoted">‹<span class="var">?eq</span> <span class="main">∈</span> set <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_state_def satisfies_tableau_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹lhs <span class="var">?eq</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_eq_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊵<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span><span class="skolem">v</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir</span> <span class="skolem">s'</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> li_x dir <span class="keyword1"><span class="command">unfolding</span></span> LB_Some <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare'_defs<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">from</span></span> min_rvar_incdec_eq_None'<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> dir min_rvar refl Iv<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>rhs <span class="main">(</span><span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span><span class="skolem">v</span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>rhs <span class="main">(</span><span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="main">⦄</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> dir lt LB_Some
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>set_unsat <span class="skolem">I</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">⟶</span> minimal_unsat_state_core <span class="main">(</span>set_unsat <span class="skolem">I</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> minimal_core
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_unsat_state_core_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Check_check<span class="main">:</span> <span class="quoted"><span class="quoted">"Check check"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"𝒰 <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"check <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> valuation"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="main">(</span>check <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> check_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pivotandupdate_tableau_equiv<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="main">(</span>check <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> check_induct'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * pivotandupdate_tableau_normalized<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="main">(</span>check <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> check_induct'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * pivotandupdate_tableau_valuated<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">I</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="main">∇</span> <span class="main">(</span>set_unsat <span class="skolem">I</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tableau_valuated_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> check <span class="skolem">s</span> <span class="keyword1">in</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="bound">s'</span> <span class="main">∧</span> <span class="main">△</span> <span class="main">(</span>𝒯 <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">∇</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span>check <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> check_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pivotandupdate_bounds_id<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="main">(</span>check <span class="skolem">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">⊨</span> <span class="main">(</span>check <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> check_induct''<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="skolem">s</span> <span class="main">=</span> None"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">⊨</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> min_lvar_not_in_bounds_None<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> curr_val_satisfies_state_def satisfies_state_def
      <span class="keyword1"><span class="command">unfolding</span></span> curr_val_satisfies_no_lhs_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_bounds_set.simps satisfies_bounds.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="main">(</span>check <span class="skolem">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">⊨</span> <span class="main">(</span>check <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>check <span class="skolem">s</span><span class="main">)</span> <span class="main">⟶</span> minimal_unsat_state_core <span class="main">(</span>check <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> check_minimal_unsat_state_core<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>check <span class="skolem">s</span><span class="main">)</span> <span class="main">⟹</span> minimal_unsat_state_core <span class="main">(</span>check <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Symmetries›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\label{sec:symmetries} Simplex algorithm exhibits many
symmetric cases. For example, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span> treats atoms
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Leq x c›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Geq x c›</span></span></span></span> in a symmetric manner, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check_inc›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check_dec›</span></span></span></span> are symmetric, etc. These
symmetric cases differ only in several aspects: order relations
between numbers (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>&lt;›</span></span></span></span> vs <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>&gt;›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>≤›</span></span></span></span> vs <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>≥›</span></span></span></span>), the role of lower and upper bounds (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℬ<span class="hidden">⇩</span><sub>l</sub>›</span></span></span></span> vs
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℬ<span class="hidden">⇩</span><sub>u</sub>›</span></span></span></span>) and their updating functions, comparisons with bounds
(e.g., <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>≥<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub>›</span></span></span></span> vs <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>≤<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub>›</span></span></span></span> or
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>&lt;<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub>›</span></span></span></span> vs <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>&gt;<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub>›</span></span></span></span>), and atom constructors (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Leq›</span></span></span></span>
and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Geq›</span></span></span></span>). These can be attributed to two different
orientations (positive and negative) of rational axis. To avoid
duplicating definitions and proofs, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>assert_bound›</span></span></span></span> definition
cases for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Leq›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Geq›</span></span></span></span> are replaced by a call to a
newly introduced function parametrized by a <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Direction›</span></span></span></span> --- a
record containing minimal set of aspects listed above that differ in
two definition cases such that other aspects can be derived from them
(e.g., only <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>&lt;›</span></span></span></span> need to be stored while <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>≤›</span></span></span></span> can be
derived from it). Two constants of the type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Direction›</span></span></span></span> are
defined: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Positive›</span></span></span></span> (with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>&lt;›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>≤›</span></span></span></span> orders,
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℬ<span class="hidden">⇩</span><sub>l</sub>›</span></span></span></span> for lower and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℬ<span class="hidden">⇩</span><sub>u</sub>›</span></span></span></span> for upper bounds and their
corresponding updating functions, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Leq›</span></span></span></span> constructor) and
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Negative›</span></span></span></span> (completely opposite from the previous
one). Similarly, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check_inc›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check_dec›</span></span></span></span> are
replaced by a new function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check_incdec›</span></span></span></span> parametrized by a
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Direction›</span></span></span></span>. All lemmas, previously repeated for each
symmetric instance, were replaced by a more abstract one, again
parametrized by a <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Direction›</span></span></span></span> parameter.
\vspace{-3mm}
›</span></span>

<span class="comment1">(*-------------------------------------------------------------------------- *)</span>
<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Concrete implementation›</span></span>
  <span class="comment1">(*-------------------------------------------------------------------------- *)</span>

<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Init init_state *)</span>
<span class="comment1">(* -------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹It is easy to give a concrete implementation of the initial
state constructor, which satisfies the specification of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">Init</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale.  For example:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">init_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span> <span class="main">::</span> zero<span class="main">)</span>state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init_state</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> State <span class="free"><span class="bound"><span class="entity">t</span></span></span> Mapping.empty Mapping.empty <span class="main">(</span>Mapping.tabulate <span class="main">(</span>vars_list <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> False None"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Init <span class="quoted"><span class="quoted">"init_state <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span> <span class="main">::</span> lrv<span class="main">)</span>state"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?init</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"init_state <span class="skolem">t</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>state"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="var">?init</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> satisfies_tableau_def satisfies_eq_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">r</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> set <span class="main">(</span>vars_list <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"vars <span class="skolem">r</span> <span class="main">⊆</span> set <span class="main">(</span>vars_list <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_vars_list<span class="main">)</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"vars <span class="skolem">r</span> <span class="main">⊆</span> lhs <span class="main">`</span> set <span class="skolem">t</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">t</span><span class="main">.</span> rvars_eq <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_vars_list<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="var">?init</span><span class="main">⟩</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> set <span class="main">(</span>vars_list <span class="skolem">t</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> init_state_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map2fun_def lookup_tabulate<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">⦃</span> <span class="main">⟨</span>𝒱 <span class="var">?init</span><span class="main">⟩</span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">r</span><span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="skolem">x</span> <span class="keyword1">*R</span> <span class="main">⟨</span>𝒱 <span class="var">?init</span><span class="main">⟩</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1
          <span class="keyword1"><span class="command">unfolding</span></span> init_state_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map2fun_def lookup_tabulate comp_def restrict_map_def set_vars_list Abstract_Linear_Poly.vars_def<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="var">?init</span><span class="main">⟩</span> <span class="main">(</span>lhs <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rhs <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">⦃</span> <span class="main">⟨</span>𝒱 <span class="var">?init</span><span class="main">⟩</span> <span class="main">⦄</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="main">(</span>init_state <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> init_state_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tabulate tableau_valuated_def comp_def restrict_map_def set_vars_list lvars_def rvars_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_state_def <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def indexl_def indexu_def<span class="main">)</span>


<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="comment1">(* MinVars min_lvar_not_in_bounds min_rvar_incdec_eq *)</span>
<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">min_lvar_not_in_bounds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">,</span>zero<span class="main">}</span><span class="main">)</span> state <span class="main">⇒</span> var option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">min_lvar_not_in_bounds</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
      min_satisfying  <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> in_bounds <span class="bound">x</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map lhs <span class="main">(</span>𝒯 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> MinLVarNotInBounds <span class="quoted"><span class="quoted">"min_lvar_not_in_bounds <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> <span class="main">_</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"min_lvar_not_in_bounds <span class="skolem">s</span> <span class="main">=</span> None <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> in_bounds <span class="bound">x</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> min_lvar_not_in_bounds_def lvars_def
    <span class="keyword1"><span class="command">using</span></span> min_satisfying_None
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"min_lvar_not_in_bounds <span class="skolem">s</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟶</span> 
            <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="main">∧</span>
            <span class="main">¬</span> in_bounds <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟶</span> in_bounds <span class="bound">x</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> min_lvar_not_in_bounds_def lvars_def
    <span class="keyword1"><span class="command">using</span></span> min_satisfying_Some
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹all variables in vs have either a positive or a negative coefficient, so no equal-zero test required.›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unsat_indices</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> Direction <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> var list <span class="main">⇒</span> eq <span class="main">⇒</span> <span class="tfree">'i</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unsat_indices</span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">r</span> <span class="main">=</span> rhs <span class="free"><span class="bound"><span class="entity">eq</span></span></span><span class="main">;</span> <span class="bound">li</span> <span class="main">=</span> LI <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> <span class="bound">ui</span> <span class="main">=</span> UI <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">in</span>
       remdups <span class="main">(</span><span class="bound">li</span> <span class="main">(</span>lhs <span class="free"><span class="bound"><span class="entity">eq</span></span></span><span class="main">)</span> <span class="main">#</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> coeff <span class="bound">r</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="bound">li</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="bound">ui</span> <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">min_rvar_incdec_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> eq <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> var"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">min_rvar_incdec_eq</span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">rvars</span> <span class="main">=</span> Abstract_Linear_Poly.vars_list <span class="main">(</span>rhs <span class="free"><span class="bound"><span class="entity">eq</span></span></span><span class="main">)</span>
      <span class="keyword1">in</span> <span class="keyword1">case</span> min_satisfying <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> reasable_var <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">rvars</span> <span class="keyword1">of</span>
         None <span class="main">⇒</span> Inl <span class="main">(</span>unsat_indices <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">rvars</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span><span class="main">)</span>
      <span class="main">|</span> Some <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">⇒</span> Inr <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> MinRVarsEq <span class="quoted"><span class="quoted">"min_rvar_incdec_eq <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span> <span class="main">::</span> lrv<span class="main">)</span> Direction <span class="main">⇒</span> <span class="main">_</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">eq</span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">dir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?min</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"min_satisfying <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> reasable_var <span class="skolem">dir</span> <span class="bound">x</span> <span class="skolem">eq</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Abstract_Linear_Poly.vars_list <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?vars</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Abstract_Linear_Poly.vars_list <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"min_rvar_incdec_eq <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">eq</span> <span class="main">=</span> Inl <span class="skolem">is</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> min_rvar_incdec_eq_def Let_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?min</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">is</span> <span class="main">=</span> set <span class="main">(</span>unsat_indices <span class="skolem">dir</span> <span class="skolem">s</span> <span class="var">?vars</span> <span class="skolem">eq</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?min</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> this min_satisfying_None set_vars_list
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span> <span class="main">⟹</span> <span class="main">¬</span> reasable_var <span class="skolem">dir</span> <span class="bound">x</span> <span class="skolem">eq</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="skolem">is</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dir<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lhs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"LI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="main">(</span>lhs <span class="skolem">eq</span><span class="main">)</span> <span class="main">∈</span> indices_state <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> I unsat_indices_def Let_def<span class="main">]</span>
      <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>lhs<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> LI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="main">(</span>lhs <span class="skolem">eq</span><span class="main">)</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>LI_rhs<span class="main">)</span> <span class="skolem">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> LI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>UI_rhs<span class="main">)</span> <span class="skolem">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> UI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_vars_list<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> indices_state <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> lhs
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lhs <span class="keyword1"><span class="command">using</span></span> lhs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> LI_rhs
        <span class="keyword1"><span class="command">from</span></span> 1<span class="main">[</span><span class="operator">OF</span> LI_rhs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> LI_rhs<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊳<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>LB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> LI_rhs<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> indices_state_def <span class="keyword1"><span class="command">using</span></span> dir
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare'_defs boundsl_def boundsu_def indexl_def indexu_def
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> UI_rhs
        <span class="keyword1"><span class="command">from</span></span> UI_rhs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_zero<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> UI_rhs<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> 1<span class="main">[</span><span class="operator">OF</span> UI_rhs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="keyword1">⊲<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>lt <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>UB <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> UI_rhs<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> indices_state_def <span class="keyword1"><span class="command">using</span></span> dir
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare'_defs boundsl_def boundsu_def indexl_def indexu_def
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative <span class="main">⟹</span> LI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="main">(</span>lhs <span class="skolem">eq</span><span class="main">)</span> <span class="main">∈</span> indices_state <span class="skolem">s</span> <span class="main">⟹</span>
      set <span class="skolem">is</span> <span class="main">⊆</span> indices_state <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span><span class="main">.</span> <span class="main">¬</span> reasable_var <span class="skolem">dir</span> <span class="bound">x</span> <span class="skolem">eq</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∧</span> set <span class="skolem">is</span> <span class="main">=</span>
       <span class="main">{</span>LI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="main">(</span>lhs <span class="skolem">eq</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>LI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span> <span class="main">∧</span> 
         coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>UI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span>
       <span class="main">(</span><span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative <span class="main">⟶</span> LI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="main">(</span>lhs <span class="skolem">eq</span><span class="main">)</span> <span class="main">∈</span> indices_state <span class="skolem">s</span> <span class="main">⟶</span> set <span class="skolem">is</span> <span class="main">⊆</span> indices_state <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI 2<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">is</span> <span class="main">=</span> <span class="main">{</span>LI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="main">(</span>lhs <span class="skolem">eq</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> LI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="main">`</span> <span class="main">(</span>rvars_eq <span class="skolem">eq</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> UI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="main">`</span> <span class="main">(</span>rvars_eq <span class="skolem">eq</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> I unsat_indices_def Let_def 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_vars_list<span class="main">)</span> 
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span>LI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="main">(</span>lhs <span class="skolem">eq</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> LI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span> <span class="main">∧</span> coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span> 
       <span class="main">∪</span> UI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="main">`</span> <span class="main">{</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(∪)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">`</span></span> <span class="bound"><span class="bound">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_zero<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> or<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> 
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> or <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">dest</span><span class="main">]</span> <span class="main">=</span> this
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">is</span> <span class="main">=</span> <span class="main">{</span>LI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="main">(</span>lhs <span class="skolem">eq</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>LI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span> <span class="main">∧</span> coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span> 
       <span class="main">∪</span> <span class="main">{</span>UI <span class="skolem">dir</span> <span class="skolem">s</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> 1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"min_rvar_incdec_eq <span class="skolem">dir</span> <span class="skolem">s</span> <span class="skolem">eq</span> <span class="main">=</span> Inr <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> min_rvar_incdec_eq_def Let_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?min</span> <span class="main">=</span> Some <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?min</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span>"</span></span> <span class="quoted"><span class="quoted">"reasable_var <span class="skolem">dir</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">eq</span> <span class="skolem">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">x'</span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">&lt;</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">⟶</span> <span class="main">¬</span> reasable_var <span class="skolem">dir</span> <span class="bound">x'</span> <span class="skolem">eq</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_satisfying_Some set_vars_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="comment1">(* EqForLVar eq_idx_for_lvar *)</span>
<span class="comment1">(* -------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">eq_idx_for_lvar_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> var <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eq_idx_for_lvar_aux</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_idx_for_lvar_aux</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> lhs <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> <span class="free">eq_idx_for_lvar_aux</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eq_idx_for_lvar</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eq_idx_for_lvar</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> eq_idx_for_lvar_aux <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_idx_for_lvar_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> lvars <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">idx</span> <span class="main">=</span> eq_idx_for_lvar_aux <span class="free">t</span> <span class="free">x</span> <span class="free">i</span> <span class="keyword1">in</span>
            <span class="free">i</span> <span class="main">≤</span> <span class="bound">idx</span> <span class="main">∧</span> <span class="bound">idx</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">+</span> length <span class="free">t</span> <span class="main">∧</span> lhs <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="bound">idx</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lvars_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">eq</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">]</span> Cons<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> lhs <span class="skolem">eq</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def lvars_def nth_Cons'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> EqForLVarDefault<span class="main">:</span> EqForLVar <span class="quoted">eq_idx_for_lvar</span>
  <span class="keyword2"><span class="keyword">defines</span></span> eq_for_lvar_code <span class="main">=</span> <span class="quoted">EqForLVarDefault.eq_for_lvar</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lvars <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eq_idx_for_lvar <span class="skolem">t</span> <span class="skolem">x</span> <span class="main">&lt;</span> length <span class="skolem">t</span> <span class="main">∧</span>
          lhs <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> eq_idx_for_lvar <span class="skolem">t</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq_idx_for_lvar_aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def  eq_idx_for_lvar_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="comment1">(* PivotEq pivot_eq *)</span>
<span class="comment1">(* -------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pivot_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"eq <span class="main">⇒</span> var <span class="main">⇒</span> eq"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pivot_eq</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">cy</span> <span class="main">=</span> coeff <span class="main">(</span>rhs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">in</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="bound">cy</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="main">(</span>rhs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="bound">cy</span> <span class="keyword1">*R</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="bound">cy</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="main">(</span>Var <span class="main">(</span>lhs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pivot_eq_satisfies_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> rvars_eq <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">e</span> <span class="main">=</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> pivot_eq <span class="free">e</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">using</span></span> scaleRat_right_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> Rep_linear_poly <span class="main">(</span>rhs <span class="free">e</span><span class="main">)</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">(</span>rhs <span class="free">e</span> <span class="main">⦃</span> <span class="free">v</span> <span class="main">⦄</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">(</span>lhs <span class="free">e</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> Groups.group_add_class.minus_unique<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">(</span><span class="main">(</span>rhs <span class="free">e</span><span class="main">)</span> <span class="main">⦃</span> <span class="free">v</span> <span class="main">⦄</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">(</span>lhs <span class="free">e</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> coeff_def vars_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_def vars_def Let_def pivot_eq_def satisfies_eq_def<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rational_vector.scale_right_diff_distrib valuate_add valuate_minus valuate_uminus valuate_scaleRat valuate_Var<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pivot_eq_rvars<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> vars <span class="main">(</span>rhs <span class="main">(</span>pivot_eq <span class="free">e</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> lhs <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="free">e</span><span class="main">)</span> <span class="free">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> lhs <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> vars <span class="main">(</span>rhs <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> vars <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> coeff <span class="main">(</span>rhs <span class="free">e</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="main">(</span>rhs <span class="free">e</span> <span class="main">-</span> coeff <span class="main">(</span>rhs <span class="free">e</span><span class="main">)</span> <span class="free">v</span> <span class="keyword1">*R</span> Var <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coeff_zero
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> vars_plus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">/</span> coeff <span class="main">(</span>rhs <span class="free">e</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="main">(</span>rhs <span class="free">e</span> <span class="main">-</span> coeff <span class="main">(</span>rhs <span class="free">e</span><span class="main">)</span> <span class="free">v</span> <span class="keyword1">*R</span> Var <span class="free">v</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">/</span> coeff <span class="main">(</span>rhs <span class="free">e</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">*R</span> Var <span class="main">(</span>lhs <span class="free">e</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def vars_scaleRat pivot_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">using</span></span> vars_plus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">/</span> coeff <span class="main">(</span>rhs <span class="free">e</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="main">(</span>rhs <span class="free">e</span> <span class="main">-</span> coeff <span class="main">(</span>rhs <span class="free">e</span><span class="main">)</span> <span class="free">v</span> <span class="keyword1">*R</span> Var <span class="free">v</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">/</span> coeff <span class="main">(</span>rhs <span class="free">e</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">*R</span> Var <span class="main">(</span>lhs <span class="free">e</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> vars_minus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rhs <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="free">e</span><span class="main">)</span> <span class="free">v</span> <span class="keyword1">*R</span> Var <span class="free">v</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vars_scaleRat Let_def pivot_eq_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> PivotEq <span class="quoted">pivot_eq</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span>"</span></span> <span class="quoted"><span class="quoted">"lhs <span class="skolem">eq</span> <span class="main">∉</span> rvars_eq <span class="skolem">eq</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lhs <span class="main">(</span>pivot_eq <span class="skolem">eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pivot_eq_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rvars_eq <span class="main">(</span>pivot_eq <span class="skolem">eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span> <span class="main">=</span>
          <span class="main">{</span>lhs <span class="skolem">eq</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>rvars_eq <span class="skolem">eq</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rvars_eq <span class="main">(</span>pivot_eq <span class="skolem">eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>lhs <span class="skolem">eq</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>rvars_eq <span class="skolem">eq</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="main">(</span>pivot_eq <span class="skolem">eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="main">(</span>pivot_eq <span class="skolem">eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span>›</span></span> <span class="quoted"><span class="quoted">‹lhs <span class="skolem">eq</span> <span class="main">∉</span> rvars_eq <span class="skolem">eq</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> coeff_Var2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"lhs <span class="skolem">eq</span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def pivot_eq_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> coeff_zero
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">eq</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>lhs <span class="skolem">eq</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>rvars_eq <span class="skolem">eq</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pivot_eq_rvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">eq</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="main">(</span>pivot_eq <span class="skolem">eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span>›</span></span> <span class="quoted"><span class="quoted">‹lhs <span class="skolem">eq</span> <span class="main">∉</span> rvars_eq <span class="skolem">eq</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> coeff_zero *
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>lhs <span class="skolem">eq</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>rvars_eq <span class="skolem">eq</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> rvars_eq <span class="main">(</span>pivot_eq <span class="skolem">eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>lhs <span class="skolem">eq</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>rvars_eq <span class="skolem">eq</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="main">(</span>lhs <span class="skolem">eq</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> coeff_zero
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹lhs <span class="skolem">eq</span> <span class="main">∉</span> rvars_eq <span class="skolem">eq</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_zero<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span> <span class="main">⟹</span> coeff <span class="main">(</span>Var <span class="main">(</span>lhs <span class="skolem">eq</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹lhs <span class="skolem">eq</span> <span class="main">∉</span> rvars_eq <span class="skolem">eq</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> coeff_Var2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"lhs <span class="skolem">eq</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>Var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span> <span class="main">(</span>lhs <span class="skolem">eq</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span>›</span></span> <span class="quoted"><span class="quoted">‹lhs <span class="skolem">eq</span> <span class="main">∉</span> rvars_eq <span class="skolem">eq</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> coeff_Var2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="quoted">"lhs <span class="skolem">eq</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>rhs <span class="main">(</span>pivot_eq <span class="skolem">eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>lhs <span class="skolem">eq</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>rvars_eq <span class="skolem">eq</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span>›</span></span> * ** ***
        <span class="keyword1"><span class="command">using</span></span> coeff_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rhs <span class="skolem">eq</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def coeff_Var2 pivot_eq_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars_eq <span class="main">(</span>pivot_eq <span class="skolem">eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_zero<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">eq'</span> <span class="main">=</span> pivot_eq <span class="skolem">eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">in</span> lhs <span class="bound">eq'</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∧</span> rvars_eq <span class="bound">eq'</span> <span class="main">=</span> <span class="main">{</span>lhs <span class="skolem">eq</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>rvars_eq <span class="skolem">eq</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> rvars_eq <span class="skolem">eq</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> pivot_eq <span class="skolem">eq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">eq</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pivot_eq_satisfies_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="comment1">(* SubstVar subst_var  *)</span>
<span class="comment1">(* -------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_var</span><span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> linear_poly <span class="main">⇒</span> linear_poly <span class="main">⇒</span> linear_poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_var</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">lp'</span></span></span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="main">+</span> <span class="main">(</span>coeff <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">lp'</span></span></span> <span class="main">-</span> <span class="main">(</span>coeff <span class="free"><span class="bound"><span class="entity">lp</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="keyword1">*R</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst_var_eq_code</span> <span class="main">=</span> SubstVar.subst_var_eq subst_var"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> SubstVar <span class="quoted">subst_var</span> <span class="keyword2"><span class="keyword">rewrites</span></span>
  <span class="quoted"><span class="quoted">"SubstVar.subst_var_eq subst_var <span class="main">=</span> subst_var_eq_code"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">lp'</span> <span class="skolem">lp</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> vars <span class="main">(</span><span class="skolem">lp</span> <span class="main">+</span> coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> <span class="skolem">lp'</span> <span class="main">-</span> coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> Var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∉</span> vars <span class="skolem">lp'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> vars <span class="skolem">lp</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars <span class="main">(</span><span class="skolem">lp</span> <span class="main">+</span> coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> <span class="skolem">lp'</span> <span class="main">-</span> coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> Var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="skolem">lp</span> <span class="main">+</span> coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> <span class="skolem">lp'</span> <span class="main">-</span> coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> Var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> coeff_zero
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> vars <span class="skolem">lp'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">lp'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> coeff_zero
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars <span class="skolem">lp</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> vars <span class="skolem">lp</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">lp</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> coeff_zero
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹coeff <span class="main">(</span><span class="skolem">lp</span> <span class="main">+</span> coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> <span class="skolem">lp'</span> <span class="main">-</span> coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> Var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹coeff <span class="skolem">lp'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_Var2<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars <span class="main">(</span>subst_var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">lp'</span> <span class="skolem">lp</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>vars <span class="skolem">lp</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> vars <span class="skolem">lp'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subst_var_def
    <span class="keyword1"><span class="command">using</span></span> coeff_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">lp</span> <span class="main">+</span> coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> <span class="skolem">lp'</span> <span class="main">-</span> coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> Var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> coeff_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">lp'</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∉</span> vars <span class="main">(</span><span class="skolem">lp</span> <span class="main">+</span> coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> <span class="skolem">lp'</span> <span class="main">-</span> coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> Var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> vars <span class="skolem">lp</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∉</span> vars <span class="skolem">lp'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars <span class="skolem">lp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> vars <span class="skolem">lp'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">lp</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">lp'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> coeff_zero
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> vars <span class="main">(</span><span class="skolem">lp</span> <span class="main">+</span> coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> <span class="skolem">lp'</span> <span class="main">-</span> coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> Var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="skolem">lp</span> <span class="main">+</span> coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> <span class="skolem">lp'</span> <span class="main">-</span> coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> Var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> coeff_zero
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹coeff <span class="skolem">lp</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹coeff <span class="skolem">lp'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_Var2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars <span class="skolem">lp</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span> <span class="main">-</span> vars <span class="skolem">lp'</span> <span class="main">⊆</span> vars <span class="main">(</span>subst_var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">lp'</span> <span class="skolem">lp</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_var_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vars <span class="skolem">lp</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span> <span class="main">-</span> vars <span class="skolem">lp'</span> <span class="keyword1">⊆s</span> vars <span class="main">(</span>subst_var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">lp'</span> <span class="skolem">lp</span><span class="main">)</span>
       <span class="keyword1">⊆s</span> vars <span class="skolem">lp</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">}</span> <span class="main">∪</span> vars <span class="skolem">lp'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">lp'</span> <span class="skolem">lp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">=</span> <span class="skolem">lp'</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span> <span class="main">⟶</span> <span class="skolem">lp</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">(</span>subst_var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">lp'</span> <span class="skolem">lp</span><span class="main">)</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subst_var_def
    <span class="keyword1"><span class="command">using</span></span> valuate_minus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">lp</span> <span class="main">+</span> coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> <span class="skolem">lp'</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> Var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> valuate_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">lp</span></span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> <span class="skolem">lp'</span>"</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> valuate_scaleRat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span> <span class="quoted"><span class="skolem">lp'</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> valuate_scaleRat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span> <span class="quoted"><span class="quoted">"Var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> valuate_Var<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">lp</span> <span class="skolem">lp'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∉</span> vars <span class="skolem">lp</span>"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> coeff_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst_var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">lp'</span> <span class="skolem">lp</span> <span class="main">=</span> <span class="skolem">lp</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> subst_var_def 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">lp</span> <span class="skolem">x</span> <span class="skolem">lp'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">∈</span> vars <span class="skolem">lp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars <span class="skolem">lp'</span> <span class="main">-</span> vars <span class="skolem">lp</span>"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">lp</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> no0<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">lp</span> <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">lp'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> coeff_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> 00<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>Var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> coeff_Var2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars <span class="main">(</span>subst_var <span class="skolem">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="skolem">lp'</span> <span class="skolem">lp</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> subst_var_def coeff_zero<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 0 00 no0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_var_eq_code_def<span class="main">)</span>

<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Update update  *)</span>
<span class="comment1">(* -------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rhs_eq_val</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rhs_eq_val</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">=</span> lhs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">;</span> <span class="bound">a<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>j</sub></span> <span class="main">=</span> coeff <span class="main">(</span>rhs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="keyword1">in</span>
      <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⟩</span> <span class="bound">x<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">+</span> <span class="bound">a<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>j</sub></span> <span class="keyword1">*R</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">-</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⟩</span> <span class="free"><span class="bound"><span class="entity">x<span class="hidden">⇩</span><sub>i</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">update_code</span> <span class="main">=</span> RhsEqVal.update rhs_eq_val"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">assert_bound'_code</span> <span class="main">=</span> Update.assert_bound' update_code"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">assert_bound_code</span> <span class="main">=</span> Update.assert_bound update_code"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> RhsEqValDefault'<span class="main">:</span> RhsEqVal <span class="quoted">rhs_eq_val</span>
  <span class="keyword2"><span class="keyword">rewrites</span></span>
    <span class="quoted"><span class="quoted">"RhsEqVal.update rhs_eq_val <span class="main">=</span> update_code"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Update.assert_bound update_code <span class="main">=</span> assert_bound_code"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Update.assert_bound' update_code <span class="main">=</span> assert_bound'_code"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">e</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rhs_eq_val <span class="skolem">v</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">e</span> <span class="main">=</span> rhs <span class="skolem">e</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="skolem">v</span><span class="main">⟩</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">⦄</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rhs_eq_val_def Let_def
    <span class="keyword1"><span class="command">using</span></span> valuate_update_x<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rhs <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">v</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">v</span><span class="main">⟩</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">c</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_eq_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> update_code_def assert_bound'_code_def assert_bound_code_def<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> PivotUpdateMinVars <span class="main">&lt;</span> Check <span class="quoted">check</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Check_check<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RhsEqVal rhs_eq_val"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pivot_code</span> <span class="main">=</span> Pivot'.pivot eq_idx_for_lvar pivot_eq subst_var"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pivot_tableau_code</span> <span class="main">=</span> Pivot'.pivot_tableau eq_idx_for_lvar pivot_eq subst_var"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Pivot'Default<span class="main">:</span> Pivot' <span class="quoted">eq_idx_for_lvar</span> <span class="quoted">pivot_eq</span> <span class="quoted">subst_var</span>
  <span class="keyword2"><span class="keyword">rewrites</span></span>
    <span class="quoted"><span class="quoted">"Pivot'.pivot eq_idx_for_lvar pivot_eq subst_var <span class="main">=</span> pivot_code"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Pivot'.pivot_tableau eq_idx_for_lvar pivot_eq subst_var <span class="main">=</span> pivot_tableau_code"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"SubstVar.subst_var_eq subst_var <span class="main">=</span> subst_var_eq_code"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pivot_tableau_code_def pivot_code_def subst_var_eq_code_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pivot_and_update_code</span> <span class="main">=</span> PivotUpdate.pivot_and_update pivot_code update_code"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> PivotUpdateDefault<span class="main">:</span> PivotUpdate <span class="quoted">eq_idx_for_lvar</span> <span class="quoted">pivot_code</span> <span class="quoted">update_code</span>
  <span class="keyword2"><span class="keyword">rewrites</span></span>
    <span class="quoted"><span class="quoted">"PivotUpdate.pivot_and_update pivot_code update_code <span class="main">=</span> pivot_and_update_code"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pivot_and_update_code_def<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> Update <span class="main">&lt;</span> AssertBoundNoLhs <span class="quoted">assert_bound</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> update_to_assert_bound_no_lhs<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Pivot eq_idx_for_lvar pivot_code"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">check_code</span> <span class="main">=</span> PivotUpdateMinVars.check eq_idx_for_lvar min_lvar_not_in_bounds min_rvar_incdec_eq pivot_and_update_code"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">check'_code</span> <span class="main">=</span> PivotUpdateMinVars.check' eq_idx_for_lvar min_rvar_incdec_eq pivot_and_update_code"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> PivotUpdateMinVarsDefault<span class="main">:</span> PivotUpdateMinVars <span class="quoted">eq_idx_for_lvar</span> <span class="quoted">min_lvar_not_in_bounds</span> <span class="quoted">min_rvar_incdec_eq</span> <span class="quoted">pivot_and_update_code</span>
  <span class="keyword2"><span class="keyword">rewrites</span></span>
    <span class="quoted"><span class="quoted">"PivotUpdateMinVars.check eq_idx_for_lvar min_lvar_not_in_bounds min_rvar_incdec_eq pivot_and_update_code <span class="main">=</span> check_code"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"PivotUpdateMinVars.check' eq_idx_for_lvar min_rvar_incdec_eq pivot_and_update_code <span class="main">=</span> check'_code"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_code_def check'_code_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">assert_code</span> <span class="main">=</span> Assert'.assert assert_bound_code check_code"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Assert'Default<span class="main">:</span> Assert' <span class="quoted">assert_bound_code</span> <span class="quoted">check_code</span>
  <span class="keyword2"><span class="keyword">rewrites</span></span>
    <span class="quoted"><span class="quoted">"Assert'.assert assert_bound_code check_code <span class="main">=</span> assert_code"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assert_code_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">assert_bound_loop_code</span> <span class="main">=</span> AssertAllState''.assert_bound_loop assert_bound_code"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">assert_all_state_code</span> <span class="main">=</span> AssertAllState''.assert_all_state init_state assert_bound_code check_code"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">assert_all_code</span> <span class="main">=</span> AssertAllState.assert_all assert_all_state_code"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> AssertAllStateDefault<span class="main">:</span> AssertAllState'' <span class="quoted">init_state</span> <span class="quoted">assert_bound_code</span> <span class="quoted">check_code</span>
  <span class="keyword2"><span class="keyword">rewrites</span></span>
    <span class="quoted"><span class="quoted">"AssertAllState''.assert_bound_loop assert_bound_code <span class="main">=</span> assert_bound_loop_code"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"AssertAllState''.assert_all_state init_state assert_bound_code check_code <span class="main">=</span> assert_all_state_code"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"AssertAllState.assert_all assert_all_state_code <span class="main">=</span> assert_all_code"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assert_bound_loop_code_def assert_all_state_code_def assert_all_code_def<span class="main">)</span>

<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Preprocess preprocess  *)</span>
<span class="comment1">(* -------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">monom_to_atom</span><span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta ns_constraint <span class="main">⇒</span> QDelta atom"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">monom_to_atom</span> <span class="main">(</span>LEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>monom_coeff <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span>
                                                <span class="main">(</span>Geq <span class="main">(</span>monom_var <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">/R</span> monom_coeff <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>
                                            <span class="keyword1">else</span>
                                                <span class="main">(</span>Leq <span class="main">(</span>monom_var <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">/R</span> monom_coeff <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">monom_to_atom</span> <span class="main">(</span>GEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>monom_coeff <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span>
                                                <span class="main">(</span>Leq <span class="main">(</span>monom_var <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">/R</span> monom_coeff <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>
                                            <span class="keyword1">else</span>
                                                <span class="main">(</span>Geq <span class="main">(</span>monom_var <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">/R</span> monom_coeff <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">qdelta_constraint_to_atom</span><span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta ns_constraint <span class="main">⇒</span> var <span class="main">⇒</span> QDelta atom"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">qdelta_constraint_to_atom</span> <span class="main">(</span>LEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>is_monom <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>monom_to_atom <span class="main">(</span>LEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>Leq <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">qdelta_constraint_to_atom</span> <span class="main">(</span>GEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>is_monom <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>monom_to_atom <span class="main">(</span>GEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>Geq <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">qdelta_constraint_to_atom'</span><span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta ns_constraint <span class="main">⇒</span> var <span class="main">⇒</span> QDelta atom"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">qdelta_constraint_to_atom'</span> <span class="main">(</span>LEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span>Leq <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">qdelta_constraint_to_atom'</span> <span class="main">(</span>GEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span>Geq <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">linear_poly_to_eq</span><span class="main">::</span> <span class="quoted"><span class="quoted">"linear_poly <span class="main">⇒</span> var <span class="main">⇒</span> eq"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">linear_poly_to_eq</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'i</span> istate <span class="main">=</span> IState
  <span class="main">(</span><span class="free"><span class="entity">FirstFreshVariable</span></span><span class="main">:</span> <span class="quoted">var</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">Tableau</span></span><span class="main">:</span> <span class="quoted">tableau</span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">Atoms</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span>QDelta<span class="main">)</span> i_atom list"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">Poly_Mapping</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"linear_poly <span class="main">⇀</span> var"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="free"><span class="entity">UnsatIndices</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> list"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">zero_satisfies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> lrv ns_constraint <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zero_satisfies</span> <span class="main">(</span>LEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">0</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">zero_satisfies</span> <span class="main">(</span>GEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">0</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

 
<span class="keyword1"><span class="command">lemma</span></span> zero_satisfies<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="free">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> zero_satisfies <span class="free">c</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">c</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valuate_zero<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_zero_satisfies<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="free">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">¬</span> zero_satisfies <span class="free">c</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">c</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valuate_zero<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">preprocess'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span>QDelta<span class="main">)</span> i_ns_constraint list <span class="main">⇒</span> var <span class="main">⇒</span> <span class="tfree">'i</span> istate"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">preprocess'</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> IState <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> None<span class="main">)</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess'</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">preprocess'</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">;</span> <span class="bound">p</span> <span class="main">=</span> poly <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">;</span> <span class="bound">is_monom_h</span> <span class="main">=</span> is_monom <span class="bound">p</span><span class="main">;</span>
                         <span class="bound">v'</span> <span class="main">=</span> FirstFreshVariable <span class="bound">s'</span><span class="main">;</span>
                         <span class="bound">t'</span> <span class="main">=</span> Tableau <span class="bound">s'</span><span class="main">;</span>
                         <span class="bound">a'</span> <span class="main">=</span> Atoms <span class="bound">s'</span><span class="main">;</span>
                         <span class="bound">m'</span> <span class="main">=</span> Poly_Mapping <span class="bound">s'</span><span class="main">;</span>
                         <span class="bound">u'</span> <span class="main">=</span> UnsatIndices <span class="bound">s'</span> <span class="keyword1">in</span>
                         <span class="keyword1">if</span> <span class="bound">is_monom_h</span> <span class="keyword1">then</span> IState <span class="bound">v'</span> <span class="bound">t'</span>
                           <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span>qdelta_constraint_to_atom <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">v'</span><span class="main">)</span> <span class="main">#</span> <span class="bound">a'</span><span class="main">)</span> <span class="bound">m'</span> <span class="bound">u'</span>
                         <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span>
                           <span class="keyword1">if</span> zero_satisfies <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="keyword1">then</span> <span class="bound">s'</span> <span class="keyword1">else</span> 
                              IState <span class="bound">v'</span> <span class="bound">t'</span> <span class="bound">a'</span> <span class="bound">m'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="bound">u'</span><span class="main">)</span>
                         <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">m'</span> <span class="bound">p</span> <span class="keyword1">of</span> Some <span class="bound">v</span> <span class="main">⇒</span>
                            IState <span class="bound">v'</span> <span class="bound">t'</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span>qdelta_constraint_to_atom <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="main">#</span> <span class="bound">a'</span><span class="main">)</span> <span class="bound">m'</span> <span class="bound">u'</span>
                          <span class="main">|</span> None <span class="main">⇒</span> IState <span class="main">(</span><span class="bound">v'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>linear_poly_to_eq <span class="bound">p</span> <span class="bound">v'</span> <span class="main">#</span> <span class="bound">t'</span><span class="main">)</span>
                           <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span>qdelta_constraint_to_atom <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">v'</span><span class="main">)</span> <span class="main">#</span> <span class="bound">a'</span><span class="main">)</span> <span class="main">(</span><span class="bound">m'</span> <span class="main">(</span><span class="bound">p</span> <span class="main">↦</span> <span class="bound">v'</span><span class="main">)</span><span class="main">)</span> <span class="bound">u'</span><span class="main">)</span>
<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> preprocess'_simps<span class="main">:</span> <span class="quoted"><span class="quoted">"preprocess' <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">h</span><span class="main">)</span> <span class="main">#</span> <span class="free">t</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> preprocess' <span class="free">t</span> <span class="free">v</span><span class="main">;</span> <span class="bound">p</span> <span class="main">=</span> poly <span class="free">h</span><span class="main">;</span> <span class="bound">is_monom_h</span> <span class="main">=</span> is_monom <span class="bound">p</span><span class="main">;</span>
                         <span class="bound">v'</span> <span class="main">=</span> FirstFreshVariable <span class="bound">s'</span><span class="main">;</span>
                         <span class="bound">t'</span> <span class="main">=</span> Tableau <span class="bound">s'</span><span class="main">;</span>
                         <span class="bound">a'</span> <span class="main">=</span> Atoms <span class="bound">s'</span><span class="main">;</span>
                         <span class="bound">m'</span> <span class="main">=</span> Poly_Mapping <span class="bound">s'</span><span class="main">;</span>
                         <span class="bound">u'</span> <span class="main">=</span> UnsatIndices <span class="bound">s'</span> <span class="keyword1">in</span>
                         <span class="keyword1">if</span> <span class="bound">is_monom_h</span> <span class="keyword1">then</span> IState <span class="bound">v'</span> <span class="bound">t'</span>
                           <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span>monom_to_atom <span class="free">h</span><span class="main">)</span> <span class="main">#</span> <span class="bound">a'</span><span class="main">)</span> <span class="bound">m'</span> <span class="bound">u'</span>
                         <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span>
                           <span class="keyword1">if</span> zero_satisfies <span class="free">h</span> <span class="keyword1">then</span> <span class="bound">s'</span> <span class="keyword1">else</span> 
                              IState <span class="bound">v'</span> <span class="bound">t'</span> <span class="bound">a'</span> <span class="bound">m'</span> <span class="main">(</span><span class="free">i</span> <span class="main">#</span> <span class="bound">u'</span><span class="main">)</span>
                         <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">m'</span> <span class="bound">p</span> <span class="keyword1">of</span> Some <span class="bound">v</span> <span class="main">⇒</span>
                            IState <span class="bound">v'</span> <span class="bound">t'</span> <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span>qdelta_constraint_to_atom' <span class="free">h</span> <span class="bound">v</span><span class="main">)</span> <span class="main">#</span> <span class="bound">a'</span><span class="main">)</span> <span class="bound">m'</span> <span class="bound">u'</span>
                          <span class="main">|</span> None <span class="main">⇒</span> IState <span class="main">(</span><span class="bound">v'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>linear_poly_to_eq <span class="bound">p</span> <span class="bound">v'</span> <span class="main">#</span> <span class="bound">t'</span><span class="main">)</span>
                           <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span>qdelta_constraint_to_atom' <span class="free">h</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">#</span> <span class="bound">a'</span><span class="main">)</span> <span class="main">(</span><span class="bound">m'</span> <span class="main">(</span><span class="bound">p</span> <span class="main">↦</span> <span class="bound">v'</span><span class="main">)</span><span class="main">)</span> <span class="bound">u'</span><span class="main">)</span>
    <span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> preprocess'_code <span class="main">=</span> preprocess'.simps<span class="main">(</span>1<span class="main">)</span> preprocess'_simps
<span class="keyword1"><span class="command">declare</span></span> preprocess'_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Normalization of constraints helps to identify same polynomials, e.g., 
  the constraints $x + y \leq 5$ and $-2x-2y \leq -12$ will be normalized
  to $x + y \leq 5$ and $x + y \geq 6$, so that only one slack-variable will
  be introduced for the polynomial $x+y$, and not another one for $-2x-2y$.
  Normalization will take care that the max-var of the polynomial in the constraint
  will have coefficient 1 (if the polynomial is non-zero)›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">normalize_ns_constraint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> lrv ns_constraint <span class="main">⇒</span> <span class="tfree">'a</span> ns_constraint"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">normalize_ns_constraint</span> <span class="main">(</span>LEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">v</span> <span class="main">=</span> max_var <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span> <span class="bound">c</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">v</span> <span class="keyword1">in</span> 
     <span class="keyword1">if</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> LEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> 
     <span class="keyword1">let</span> <span class="bound">ic</span> <span class="main">=</span> inverse <span class="bound">c</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">c</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> GEQ_ns <span class="main">(</span><span class="bound">ic</span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>scaleRat <span class="bound">ic</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">else</span> LEQ_ns <span class="main">(</span><span class="bound">ic</span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>scaleRat <span class="bound">ic</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">normalize_ns_constraint</span> <span class="main">(</span>GEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">v</span> <span class="main">=</span> max_var <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span> <span class="bound">c</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">v</span> <span class="keyword1">in</span> 
     <span class="keyword1">if</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> GEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> 
     <span class="keyword1">let</span> <span class="bound">ic</span> <span class="main">=</span> inverse <span class="bound">c</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">c</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> LEQ_ns <span class="main">(</span><span class="bound">ic</span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>scaleRat <span class="bound">ic</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">else</span> GEQ_ns <span class="main">(</span><span class="bound">ic</span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>scaleRat <span class="bound">ic</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> normalize_ns_constraint<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>normalize_ns_constraint <span class="free">c</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">c</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> lrv ns_constraint<span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>poly <span class="free">c</span><span class="main">)</span> <span class="main">(</span>max_var <span class="main">(</span>poly <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>0<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="main">(</span>pos<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="main">(</span>neg<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> pos
    <span class="keyword1"><span class="command">from</span></span> pos <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">/R</span> <span class="var">?c</span> <span class="main">≤</span> <span class="skolem">b</span> <span class="keyword1">/R</span> <span class="var">?c</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> 
      <span class="keyword1"><span class="command">using</span></span> scaleRat_leq1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pos id <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def valuate_scaleRat id<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> neg
    <span class="keyword1"><span class="command">from</span></span> neg <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">/R</span> <span class="var">?c</span> <span class="main">≤</span> <span class="skolem">b</span> <span class="keyword1">/R</span> <span class="var">?c</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> 
      <span class="keyword1"><span class="command">using</span></span> scaleRat_leq2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> neg id <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def valuate_scaleRat id<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">declare</span></span> normalize_ns_constraint.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> i_satisfies_normalize_ns_constraint<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Iv</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>map_prod id normalize_ns_constraint <span class="main">`</span> <span class="free">cs</span><span class="main">)</span>
  <span class="main">⟷</span> <span class="free">Iv</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Iv</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">max_var</span><span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta ns_constraint <span class="main">⇒</span> var"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_var</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≡</span> Abstract_Linear_Poly.max_var <span class="main">(</span>poly <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">start_fresh_variable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span>QDelta<span class="main">)</span> i_ns_constraint list <span class="main">⇒</span> var"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">start_fresh_variable</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">start_fresh_variable</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>max_var <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">start_fresh_variable</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">preprocess_part_1</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span>QDelta<span class="main">)</span> i_ns_constraint list <span class="main">⇒</span> tableau <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'i</span><span class="main">,</span>QDelta<span class="main">)</span> i_atom list<span class="main">)</span> <span class="main">×</span> <span class="tfree">'i</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">preprocess_part_1</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">start</span> <span class="main">=</span> start_fresh_variable <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span> <span class="bound">is</span> <span class="main">=</span> preprocess' <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">start</span> <span class="keyword1">in</span> <span class="main">(</span>Tableau <span class="bound">is</span><span class="main">,</span> Atoms <span class="bound">is</span><span class="main">,</span> UnsatIndices <span class="bound">is</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lhs_linear_poly_to_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lhs <span class="main">(</span>linear_poly_to_eq <span class="free">h</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rvars_eq_linear_poly_to_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rvars_eq <span class="main">(</span>linear_poly_to_eq <span class="free">h</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> vars <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_var_monoinc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"FirstFreshVariable <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="free">start</span><span class="main">)</span> <span class="main">≥</span> <span class="free">start</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">vars_constraints</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vars_constraints</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map vars <span class="main">(</span>map poly <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> start_fresh_variable_fresh<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">var</span> <span class="main">∈</span> vars_constraints <span class="main">(</span>flat_list <span class="free">cs</span><span class="main">)</span><span class="main">.</span> <span class="bound">var</span> <span class="main">&lt;</span> start_fresh_variable <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> max_var_max
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vars_tableau_vars_constraints<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rvars <span class="main">(</span>Tableau <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> vars_constraints <span class="main">(</span>flat_list <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">start</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> preprocess'.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rvars_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lvars_tableau_ge_start<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">var</span> <span class="main">∈</span> lvars <span class="main">(</span>Tableau <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">var</span> <span class="main">≥</span> <span class="free">start</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">start</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> preprocess'.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def lvars_def fresh_var_monoinc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rhs_no_zero_tableau_start<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> rhs <span class="main">`</span> set <span class="main">(</span>Tableau <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">start</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> preprocess'.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def rvars_def fresh_var_monoinc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> first_fresh_variable_not_in_lvars<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">var</span> <span class="main">∈</span> lvars <span class="main">(</span>Tableau <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> FirstFreshVariable <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="free">start</span><span class="main">)</span> <span class="main">&gt;</span> <span class="bound">var</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">start</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> preprocess'.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def lvars_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_atom_sat_eq_sat_constraint_non_monom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span> qdelta_constraint_to_atom <span class="free">h</span> <span class="free">var</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> linear_poly_to_eq <span class="main">(</span>poly <span class="free">h</span><span class="main">)</span> <span class="free">var</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_monom <span class="main">(</span>poly <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_eq_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> qdelta_constraint_to_atom_monom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_monom <span class="main">(</span>poly <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span> qdelta_constraint_to_atom <span class="free">h</span> <span class="free">var</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LEQ_ns <span class="skolem">l</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">using</span></span> monom_valuate<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> scaleRat_leq2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">/R</span> monom_coeff <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">(</span>monom_var <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"monom_coeff <span class="skolem">l</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> divide_leq1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"monom_coeff <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">(</span>monom_var <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_rat_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> scaleRat_leq1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">(</span>monom_var <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">/R</span> monom_coeff <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"monom_coeff <span class="skolem">l</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> is_monom_monom_coeff_not_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> divide_leq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"monom_coeff <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">(</span>monom_var <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> is_monom_monom_coeff_not_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_rat_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>GEQ_ns <span class="skolem">l</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">using</span></span> monom_valuate<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> scaleRat_leq2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">(</span>monom_var <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">/R</span> monom_coeff <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"monom_coeff <span class="skolem">l</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> divide_geq1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="quoted">"monom_coeff <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">(</span>monom_var <span class="skolem">l</span><span class="main">)</span>"</span></span><span class="main">]</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_rat_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> scaleRat_leq1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">/R</span> monom_coeff <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">(</span>monom_var <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"monom_coeff <span class="skolem">l</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> is_monom_monom_coeff_not_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> divide_geq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="quoted">"monom_coeff <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">(</span>monom_var <span class="skolem">l</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> is_monom_monom_coeff_not_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_rat_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> preprocess'_Tableau_Poly_Mapping_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Poly_Mapping <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> None
  <span class="main">⟹</span> linear_poly_to_eq <span class="free">p</span> <span class="free">v</span> <span class="main">∉</span> set <span class="main">(</span>Tableau <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">start</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> preprocess'.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> preprocess'_Tableau_Poly_Mapping_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Poly_Mapping <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">v</span>
  <span class="main">⟹</span> linear_poly_to_eq <span class="free">p</span> <span class="free">v</span> <span class="main">∈</span> set <span class="main">(</span>Tableau <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">start</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> preprocess'.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> preprocess'_Tableau_Poly_Mapping_Some'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Poly_Mapping <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">v</span>
  <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">h</span><span class="main">.</span> poly <span class="bound">h</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="main">¬</span> is_monom <span class="main">(</span>poly <span class="bound">h</span><span class="main">)</span> <span class="main">∧</span> qdelta_constraint_to_atom <span class="bound">h</span> <span class="free">v</span> <span class="main">∈</span> flat <span class="main">(</span>set <span class="main">(</span>Atoms <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">start</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> preprocess'.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_one_le_zero_qdelta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">1</span> <span class="main">≤</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> QDelta<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span>

<span class="keyword1"><span class="command">lemma</span></span> one_zero_contra<span class="main">[</span><span class="operator">dest</span><span class="main">,</span><span class="operator">consumes</span> 2<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">::</span> QDelta<span class="main">)</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span> False"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> order.trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> not_one_le_zero_qdelta <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> i_preprocess'_sat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="main">(</span>Atoms <span class="main">(</span>preprocess' <span class="free">s</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> Tableau <span class="main">(</span>preprocess' <span class="free">s</span> <span class="free">start</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∩</span> set <span class="main">(</span>UnsatIndices <span class="main">(</span>preprocess' <span class="free">s</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">start</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> preprocess'.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def satisfies_atom_set_def satisfies_tableau_def qdelta_constraint_to_atom_monom
      sat_atom_sat_eq_sat_constraint_non_monom 
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> preprocess'_Tableau_Poly_Mapping_Some zero_satisfies<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> preprocess'_sat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> flat <span class="main">(</span>set <span class="main">(</span>Atoms <span class="main">(</span>preprocess' <span class="free">s</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> Tableau <span class="main">(</span>preprocess' <span class="free">s</span> <span class="free">start</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>UnsatIndices <span class="main">(</span>preprocess' <span class="free">s</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> flat <span class="main">(</span>set <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> i_preprocess'_sat<span class="main">[</span><span class="operator">of</span> <span class="quoted">UNIV</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">start</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_constraint_valuation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">var</span> <span class="main">∈</span> vars <span class="main">(</span>poly <span class="free">c</span><span class="main">)</span><span class="main">.</span> <span class="free">v1</span> <span class="bound">var</span> <span class="main">=</span> <span class="free">v2</span> <span class="bound">var</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">c</span> <span class="main">⟷</span> <span class="free">v2</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">using</span></span> valuate_depend
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atom_var_first<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> flat <span class="main">(</span>set <span class="main">(</span>Atoms <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">var</span> <span class="main">∈</span> vars_constraints <span class="main">(</span>flat_list <span class="free">cs</span><span class="main">)</span><span class="main">.</span> <span class="bound">var</span> <span class="main">&lt;</span> <span class="free">start</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atom_var <span class="free">a</span> <span class="main">&lt;</span> FirstFreshVariable <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="free">start</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">hh</span> <span class="skolem">t</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> hh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">hh</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"preprocess' <span class="skolem">t</span> <span class="free">start</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> flat <span class="main">(</span>set <span class="main">(</span>Atoms <span class="var">?s</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> Cons<span class="main">(</span>3<span class="main">)</span> hh
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>monom<span class="main">)</span> <span class="quoted"><span class="quoted">"is_monom <span class="main">(</span>poly <span class="skolem">h</span><span class="main">)</span>"</span></span> <span class="main">|</span> <span class="main">(</span>normal<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_monom <span class="main">(</span>poly <span class="skolem">h</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">h</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Poly_Mapping <span class="var">?s</span><span class="main">)</span> <span class="main">(</span>poly <span class="skolem">h</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
      <span class="main">|</span> <span class="main">(</span>old<span class="main">)</span> <span class="skolem">var</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_monom <span class="main">(</span>poly <span class="skolem">h</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">h</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Poly_Mapping <span class="var">?s</span><span class="main">)</span> <span class="main">(</span>poly <span class="skolem">h</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">var</span>"</span></span>
      <span class="main">|</span> <span class="main">(</span>zero<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_monom <span class="main">(</span>poly <span class="skolem">h</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> monom
      <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>3<span class="main">)</span> monom_var_in_vars hh monom
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"monom_var <span class="main">(</span>poly <span class="skolem">h</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">start</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> qdelta_constraint_to_atom <span class="skolem">h</span> <span class="main">(</span>FirstFreshVariable <span class="main">(</span>preprocess' <span class="skolem">t</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> hh monom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> fresh_var_monoinc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">start</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> hh monom
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> normal
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> qdelta_constraint_to_atom <span class="skolem">h</span> <span class="main">(</span>FirstFreshVariable <span class="main">(</span>preprocess' <span class="skolem">t</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False normal Cons<span class="main">(</span>2<span class="main">)</span> hh <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hh normal
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>old <span class="skolem">var</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> preprocess'_Tableau_Poly_Mapping_Some'<span class="main">[</span><span class="operator">OF</span> old<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">h'</span> <span class="main">=</span> poly <span class="skolem">h</span>"</span></span> <span class="quoted"><span class="quoted">"qdelta_constraint_to_atom <span class="skolem">h'</span> <span class="skolem">var</span> <span class="main">∈</span> flat <span class="main">(</span>set <span class="main">(</span>Atoms <span class="var">?s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> Cons<span class="main">(</span>3<span class="main">)</span> this<span class="main">(</span>1<span class="main">)</span> old<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">var</span> <span class="main">&lt;</span> FirstFreshVariable <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> qdelta_constraint_to_atom <span class="skolem">h</span> <span class="skolem">var</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False old Cons<span class="main">(</span>2<span class="main">)</span> hh <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"atom_var <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">var</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> old <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> a hh <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> old Let_def var<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> zero
      <span class="keyword1"><span class="command">from</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> hh zero <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_tableau_satisfies_tableau<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">var</span> <span class="main">∈</span> tvars <span class="free">t</span><span class="main">.</span> <span class="free">v1</span> <span class="bound">var</span> <span class="main">=</span> <span class="free">v2</span> <span class="bound">var</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v2</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">using</span></span> valuate_depend<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">v2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lvars_def rvars_def satisfies_eq_def satisfies_tableau_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> preprocess'_unsat_indices<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>UnsatIndices <span class="main">(</span>preprocess' <span class="free">s</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">start</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> preprocess'.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">j</span> <span class="skolem">h</span> <span class="skolem">t</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def not_zero_satisfies <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> preprocess'_unsat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"vars_constraints <span class="main">(</span>flat_list <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">var</span> <span class="main">∈</span> <span class="free">V</span><span class="main">.</span> <span class="bound">var</span> <span class="main">&lt;</span> <span class="free">start</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">var</span> <span class="main">∈</span> <span class="free">V</span><span class="main">.</span> <span class="free">v</span> <span class="bound">var</span> <span class="main">=</span> <span class="bound">v'</span> <span class="bound">var</span><span class="main">)</span>
    <span class="main">∧</span> <span class="bound">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> restrict_to <span class="free">I</span> <span class="main">(</span>set <span class="main">(</span>Atoms <span class="main">(</span>preprocess' <span class="free">s</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="bound">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> Tableau <span class="main">(</span>preprocess' <span class="free">s</span> <span class="free">start</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_atom_set_def satisfies_tableau_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">hh</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> hh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">hh</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> Cons hh <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">var</span><span class="main">∈</span><span class="free">V</span><span class="main">.</span> <span class="free">v</span> <span class="bound">var</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="bound">var</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> v'_as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> restrict_to <span class="free">I</span> <span class="main">(</span>set <span class="main">(</span>Atoms <span class="main">(</span>preprocess' <span class="skolem">t</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> v'_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> Tableau <span class="main">(</span>preprocess' <span class="skolem">t</span> <span class="free">start</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> vars_h<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_constraints <span class="main">[</span><span class="skolem">h</span><span class="main">]</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> hh<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">var</span> <span class="main">∈</span> vars <span class="main">(</span>poly <span class="skolem">h</span><span class="main">)</span><span class="main">.</span> <span class="free">v</span> <span class="bound">var</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="bound">var</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">∀</span><span class="bound">var</span><span class="main">∈</span><span class="free">V</span><span class="main">.</span> <span class="free">v</span> <span class="bound">var</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="bound">var</span><span class="main">)</span>›</span></span> Cons<span class="main">(</span>3<span class="main">)</span> hh
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> vh_v'h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">h</span> <span class="main">⟷</span> <span class="skolem">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sat_constraint_valuation<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_monom <span class="main">(</span>poly <span class="skolem">h</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"is_monom <span class="main">(</span>poly <span class="skolem">h</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> hh preprocess'.simps Let_def id if_True istate.simps istate.sel
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">v'</span></span></span></span><span class="main"><span class="main">]</span></span> conjI v'_t var satisifies_atom_restrict_to_Cons<span class="main"><span class="main">[</span></span><span class="operator">OF</span> v'_as<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> i<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> var vh_v'h
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span> qdelta_constraint_to_atom <span class="skolem">h</span> <span class="main">(</span>FirstFreshVariable <span class="main">(</span>preprocess' <span class="skolem">t</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> qdelta_constraint_to_atom_monom<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"is_monom <span class="main">(</span>poly <span class="skolem">h</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"preprocess' <span class="skolem">t</span> <span class="free">start</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"FirstFreshVariable <span class="var">?s</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> zero<span class="main">:</span> False
      <span class="keyword1"><span class="command">hence</span></span> id'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="skolem">h</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?look</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Poly_Mapping <span class="var">?s</span><span class="main">)</span> <span class="main">(</span>poly <span class="skolem">h</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?look</span></span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> None
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">h</span> <span class="main">⦃</span> <span class="skolem">v'</span><span class="main">⦄</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span><span class="main">(</span><span class="var">?x</span><span class="main">:=</span><span class="var">?y</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> preprocess'.simps hh Let_def id id' if_False istate.simps istate.sel None option.simps
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?v'</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI satisifies_atom_restrict_to_Cons satisfies_tableau_Cons<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> vars'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">var</span><span class="main">∈</span><span class="free">V</span><span class="main">.</span> <span class="free">v</span> <span class="bound">var</span> <span class="main">=</span> <span class="var">?v'</span> <span class="bound">var</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">∀</span><span class="bound">var</span><span class="main">∈</span><span class="free">V</span><span class="main">.</span> <span class="free">v</span> <span class="bound">var</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="bound">var</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> fresh_var_monoinc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">start</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>4<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> vh_v'h i<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> False
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span> qdelta_constraint_to_atom <span class="skolem">h</span> <span class="main">(</span>FirstFreshVariable <span class="main">(</span>preprocess' <span class="skolem">t</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?atoms</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"restrict_to <span class="free">I</span> <span class="main">(</span>set <span class="main">(</span>Atoms <span class="main">(</span>preprocess' <span class="skolem">t</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?atoms</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> satisfies_atom_set_def
          <span class="keyword1"><span class="command">proof</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?atoms</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span> <span class="skolem">a</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?atoms</span>›</span></span> hh <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_atom_set_def<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span> <span class="skolem">a</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?atoms</span>›</span></span> atom_var_first<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="free">start</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> Cons<span class="main">(</span>4<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> linear_poly_to_eq <span class="main">(</span>poly <span class="skolem">h</span><span class="main">)</span> <span class="main">(</span>FirstFreshVariable <span class="main">(</span>preprocess' <span class="skolem">t</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> Cons<span class="main">(</span>4<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> valuate_depend<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">h</span>"</span></span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span><span class="main">(</span>FirstFreshVariable <span class="main">(</span>preprocess' <span class="skolem">t</span> <span class="free">start</span><span class="main">)</span> <span class="main">:=</span> <span class="main">(</span>poly <span class="skolem">h</span><span class="main">)</span> <span class="main">⦃</span> <span class="skolem">v'</span> <span class="main">⦄</span><span class="main">)</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> fresh_var_monoinc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">start</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> hh
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_eq_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FirstFreshVariable <span class="main">(</span>preprocess' <span class="skolem">t</span> <span class="free">start</span><span class="main">)</span> <span class="main">∉</span> tvars <span class="main">(</span>Tableau <span class="main">(</span>preprocess' <span class="skolem">t</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> first_fresh_variable_not_in_lvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="free">start</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> Cons<span class="main">(</span>4<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> vars_tableau_vars_constraints<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="free">start</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> fresh_var_monoinc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">start</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> Tableau <span class="main">(</span>preprocess' <span class="skolem">t</span> <span class="free">start</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> Tableau <span class="main">(</span>preprocess' <span class="skolem">t</span> <span class="free">start</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> satisfies_tableau_satisfies_tableau<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="quoted">"Tableau <span class="main">(</span>preprocess' <span class="skolem">t</span> <span class="free">start</span><span class="main">)</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?v'</span></span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">var</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> preprocess'_Tableau_Poly_Mapping_Some<span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linear_poly_to_eq <span class="main">(</span>poly <span class="skolem">h</span><span class="main">)</span> <span class="skolem">var</span> <span class="main">∈</span> set <span class="main">(</span>Tableau <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> v'_t<span class="main">[</span><span class="operator">unfolded</span> satisfies_tableau_def<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> v'_h_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> linear_poly_to_eq <span class="main">(</span>poly <span class="skolem">h</span><span class="main">)</span> <span class="skolem">var</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> preprocess'.simps hh Let_def id id' if_False istate.simps istate.sel Some option.simps
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">v'</span></span></span></span><span class="main"><span class="main">]</span></span> conjI var v'_t satisifies_atom_restrict_to_Cons satisfies_tableau_Cons v'_as<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> vh_v'h i<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> False v'_h_var
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span> qdelta_constraint_to_atom <span class="skolem">h</span> <span class="skolem">var</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> satisfies_eq_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> zero<span class="main">:</span> True
      <span class="keyword1"><span class="command">hence</span></span> id'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="skolem">h</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zero_satisfies <span class="skolem">h</span>"</span></span><span class="main">)</span> 
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> id''<span class="main">:</span> <span class="quoted"><span class="quoted">"zero_satisfies <span class="skolem">h</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> hh preprocess'.simps Let_def id id' id'' if_True if_False istate.simps istate.sel
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">v'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> conjI v'_t var v'_as<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> id''<span class="main">:</span> <span class="quoted"><span class="quoted">"zero_satisfies <span class="skolem">h</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">{</span></span> 
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> i<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> not_zero_satisfies<span class="main">[</span><span class="operator">OF</span> zero False<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> no_I <span class="main">=</span> this
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> hh preprocess'.simps Let_def id id' id'' if_True if_False istate.simps istate.sel
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ Cons<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span>  set <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vars_constraints <span class="main">(</span>map snd <span class="skolem">t</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lvars_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map lhs <span class="main">(</span>Tableau <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> first_fresh_variable_not_in_lvars<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span> <span class="main"><span class="main">=</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def lvars_def<span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_tableau_preprocess'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>Tableau <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="main">(</span>start_fresh_variable <span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"start_fresh_variable <span class="free">cs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> lvars_distinct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cs</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> lvars_tableau_ge_start<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cs</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> vars_tableau_vars_constraints<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cs</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> start_fresh_variable_fresh<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cs</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> disjoint_iff_not_equal inf.absorb_iff2 inf.strict_order_iff rhs_no_zero_tableau_start subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Improved preprocessing: Deletion. An equation x = p can be deleted from the tableau,
  if x does not occur in the atoms.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> delete_lhs_var<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">t1</span> <span class="main">@</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">p</span><span class="main">)</span> <span class="main">#</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">=</span> <span class="free">t1</span> <span class="main">@</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> tv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tv</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> upd <span class="free">x</span> <span class="main">(</span><span class="free">p</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="bound">v</span><span class="main">⟩</span> <span class="main">⦄</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> x_as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> atom_var <span class="main">`</span> snd <span class="main">`</span> set <span class="free">as</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t'</span>"</span></span> <span class="comment1">― ‹new tableau is normalized›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">w</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t'</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">tv</span> <span class="free">w</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span> <span class="comment1">― ‹solution of new tableau is translated to solution of old tableau›</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="main">⟨</span><span class="free">w</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="main">⟨</span><span class="free">tv</span> <span class="free">w</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span>"</span></span> <span class="comment1">― ‹solution translation also works for bounds›</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t'</span>"</span></span> <span class="comment1">― ‹solution of old tableau is also solution for new tableau›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> tv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">tv</span> <span class="free">w</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">w</span><span class="main">⟩</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">p</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="free">w</span><span class="main">⟩</span> <span class="main">⦄</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> tv map2fun_def' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> norm
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t t' normalized_tableau_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lvars_def rvars_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t t' satisfies_tableau_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> norm <span class="keyword1"><span class="command">have</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map lhs <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"lvars <span class="free">t</span> <span class="main">∩</span> rvars <span class="free">t</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x_as <span class="keyword1"><span class="command">have</span></span> x_as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> atom_var <span class="main">`</span> snd <span class="main">`</span> <span class="main">(</span>set <span class="free">as</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="main">⟨</span><span class="free">tv</span> <span class="free">w</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="main">⟨</span><span class="free">w</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> i_satisfies_atom_set.simps
      satisfies_atom_set_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ball_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="main">(</span>set <span class="free">as</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> x_as <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> atom_var <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">tv</span> <span class="free">w</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">w</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> tv
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="main">⟨</span><span class="free">w</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="main">⟨</span><span class="free">tv</span> <span class="free">w</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">assume</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">w</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> dist<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> t<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> xp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> vars <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lvars_def rvars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">eq</span>
    <span class="keyword3"><span class="command">assume</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">eq</span> <span class="main">∈</span> set <span class="free">t1</span> <span class="main">∪</span> set <span class="free">t2</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">eq</span> <span class="main">∈</span> set <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> w <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">w</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">eq</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies_tableau_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">eq</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> mem<span class="main">[</span><span class="operator">unfolded</span> eq<span class="main">]</span> dist<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> t<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> mem<span class="main">[</span><span class="operator">unfolded</span> eq<span class="main">]</span> dist<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> t<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> xq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> vars <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lvars_def rvars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> w <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">tv</span> <span class="free">w</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">eq</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> tv eq satisfies_eq_iff <span class="keyword1"><span class="command">using</span></span> xy xq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> valuate_depend<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">tv</span> <span class="free">w</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies_eq_iff tv <span class="keyword1"><span class="command">using</span></span> xp
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> valuate_depend<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">tv</span> <span class="free">w</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t satisfies_tableau_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pivot_tableau_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> eq <span class="main">⇒</span> tableau <span class="main">⇒</span> var <span class="main">⇒</span> tableau <span class="main">×</span> eq <span class="main">×</span> tableau"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pivot_tableau_eq</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">eq'</span> <span class="main">=</span> pivot_eq <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span> <span class="bound">m</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">e</span><span class="main">.</span> subst_var_eq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>rhs <span class="bound">eq'</span><span class="main">)</span> <span class="bound">e</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> <span class="bound">eq'</span><span class="main">,</span> <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pivot_tableau_eq<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">t1</span> <span class="main">@</span> <span class="free">eq</span> <span class="main">#</span> <span class="free">t2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">=</span> <span class="free">t1'</span> <span class="main">@</span> <span class="free">eq'</span> <span class="main">#</span> <span class="free">t2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> rvars_eq <span class="free">eq</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pte<span class="main">:</span> <span class="quoted"><span class="quoted">"pivot_tableau_eq <span class="free">t1</span> <span class="free">eq</span> <span class="free">t2</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">t1'</span><span class="main">,</span><span class="free">eq'</span><span class="main">,</span><span class="free">t2'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"lhs <span class="free">eq'</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> lrv valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t'</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">t</span><span class="main">.</span> State <span class="bound">t</span> undefined undefined undefined undefined undefined"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lhs <span class="free">eq</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> yl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> lvars <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t lvars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> norm <span class="keyword1"><span class="command">have</span></span> eq_t12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∉</span> lhs <span class="main">`</span> <span class="main">(</span>set <span class="free">t1</span> <span class="main">∪</span> set <span class="free">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def t lvars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_for_lvar_code <span class="free">t</span> <span class="var">?y</span> <span class="main">=</span> <span class="free">eq</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> EqForLVarDefault.eq_for_lvar Un_insert_right eq_t12
        image_iff insert_iff list.set<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> set_append t<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> yl<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?y</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t1</span> <span class="main">⟹</span> <span class="var">?y</span> <span class="main">∈</span> lhs <span class="main">`</span> <span class="main">(</span>set <span class="skolem">t1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span> <span class="skolem">t1</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_eqI lhs.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> pivot<span class="main">:</span> <span class="quoted"><span class="quoted">"pivot_tableau_code <span class="var">?y</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Pivot'Default.pivot_tableau_def Let_def eq <span class="keyword1"><span class="command">using</span></span> pte<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> t pivot_tableau_eq_def Let_def <span class="keyword1"><span class="command">using</span></span> eq_t12 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> thms <span class="main">=</span> Pivot'Default.pivot_vars' Pivot'Default.pivot_tableau
  <span class="keyword1"><span class="command">note</span></span> thms <span class="main">=</span> thms<span class="main">[</span><span class="operator">unfolded</span> Pivot'Default.pivot_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?s</span></span> <span class="free"><span class="free">t</span></span>"</span></span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span>
      <span class="operator">OF</span> norm yl<span class="main">,</span> <span class="operator">unfolded</span> eq<span class="main">,</span> <span class="operator">OF</span> x<span class="main">,</span> <span class="operator">unfolded</span> pivot<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> thms<span class="main">(</span>1<span class="main">)</span> thms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t'</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lhs <span class="free">eq'</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pte<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> t pivot_tableau_eq_def Let_def pivot_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">preprocess_opt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set <span class="main">⇒</span> tableau <span class="main">⇒</span> tableau <span class="main">⇒</span> tableau <span class="main">×</span> <span class="main">(</span><span class="main">(</span>var<span class="main">,</span><span class="tfree">'a</span> <span class="main">::</span> lrv<span class="main">)</span>mapping <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>mapping<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">preprocess_opt</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span>id<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess_opt</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">then</span>
    <span class="keyword1">case</span> <span class="free">preprocess_opt</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">tv</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⦃</span> <span class="main">⟨</span><span class="bound">v</span><span class="main">⟩</span> <span class="main">⦄</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">o</span> <span class="bound">tv</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">case</span> find <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">(</span>Abstract_Linear_Poly.vars_list <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> <span class="free">preprocess_opt</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>
   <span class="main">|</span> Some <span class="bound">y</span> <span class="main">⇒</span> <span class="keyword1">case</span> pivot_tableau_eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="bound">y</span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">tt1</span><span class="main">,</span><span class="main">(</span><span class="bound">z</span><span class="main">,</span><span class="bound">q</span><span class="main">)</span><span class="main">,</span><span class="bound">tt2</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">case</span> <span class="free">preprocess_opt</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">tt1</span> <span class="bound">tt2</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">tv</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> upd <span class="bound">z</span> <span class="main">(</span><span class="bound">q</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="bound">v</span><span class="main">⟩</span> <span class="main">⦄</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">o</span> <span class="bound">tv</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">X</span><span class="main">,</span><span class="bound">t1</span><span class="main">,</span><span class="bound">t2</span><span class="main">)</span><span class="main">.</span> length <span class="bound">t2</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pivot_tableau_eq_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> preprocess_opt<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> atom_var <span class="main">`</span> snd <span class="main">`</span> set <span class="free">as</span>"</span></span>
  <span class="quoted"><span class="quoted">"preprocess_opt <span class="free">X</span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">=</span> <span class="main">(</span><span class="free">t'</span><span class="main">,</span><span class="free">tv</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> rev <span class="free">t1</span> <span class="main">@</span> <span class="free">t2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">w</span><span class="main">⟩</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> lrv valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t'</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">tv</span> <span class="free">w</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="main">⟨</span><span class="free">w</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="main">⟨</span><span class="free">tv</span> <span class="free">w</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">v</span> <span class="main">::</span> <span class="tfree">'a</span> valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">tv</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> preprocess_opt.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">X</span> <span class="skolem">t1</span> <span class="skolem">t</span> <span class="skolem">tv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> normalized_tableau_def lvars_def rvars_def satisfies_tableau_def
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> rev_map<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">X</span> <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">p</span> <span class="skolem">t2</span> <span class="skolem">t</span> <span class="skolem">tv</span> <span class="skolem">w</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 2<span class="main">(</span>1-3<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> X <span class="main">=</span> 2<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> 2<span class="main">(</span>5<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> rev <span class="skolem">t1</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> res <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tv'</span></span> <span class="keyword2"><span class="keyword">where</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"preprocess_opt <span class="skolem">X</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="main">=</span> <span class="main">(</span><span class="free">t'</span><span class="main">,</span> <span class="skolem">tv'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      tv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tv</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Mapping.update <span class="skolem">x</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="bound">v</span><span class="main">⟩</span> <span class="main">⦄</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">o</span> <span class="skolem">tv'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> delete <span class="main">=</span> delete_lhs_var<span class="main">[</span><span class="operator">OF</span> norm t refl refl False<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">unfolded</span></span></span></span> X<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> False X res delete<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> refl<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> delete<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">tv'</span> <span class="skolem">w</span>"</span></span><span class="main">]</span> delete<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tv'</span> <span class="skolem">w</span>"</span></span><span class="main">]</span> delete<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> tv o_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">(</span>2-3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"find <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span>Abstract_Linear_Poly.vars_list <span class="skolem">p</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">with</span></span> res True <span class="keyword1"><span class="command">have</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"preprocess_opt <span class="skolem">X</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">t1</span><span class="main">)</span> <span class="skolem">t2</span> <span class="main">=</span> <span class="main">(</span><span class="free">t'</span><span class="main">,</span> <span class="skolem">tv</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> t <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> rev <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> None X pre norm t<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">z</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Some<span class="main">[</span><span class="operator">unfolded</span> find_Some_iff<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> zX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∉</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> set <span class="main">(</span>Abstract_Linear_Poly.vars_list <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> rvars_eq <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_vars_list<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tt1</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">tt2</span></span> <span class="keyword2"><span class="keyword">where</span></span> pte<span class="main">:</span> <span class="quoted"><span class="quoted">"pivot_tableau_eq <span class="skolem">t1</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">t2</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">tt1</span><span class="main">,</span><span class="main">(</span><span class="skolem">z'</span><span class="main">,</span><span class="skolem">q</span><span class="main">)</span><span class="main">,</span><span class="skolem">tt2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pivot_tableau_eq <span class="skolem">t1</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">t2</span> <span class="skolem">z</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pte_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"pivot_tableau_eq <span class="main">(</span>rev <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">t2</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span>rev <span class="skolem">tt1</span><span class="main">,</span><span class="main">(</span><span class="skolem">z'</span><span class="main">,</span><span class="skolem">q</span><span class="main">)</span><span class="main">,</span><span class="skolem">tt2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pivot_tableau_eq_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_map<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> eq <span class="main">=</span> pivot_tableau_eq<span class="main">[</span><span class="operator">OF</span> t refl z norm pte_rev<span class="main">]</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> z'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> eq <span class="main">=</span> eq<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> z'<span class="main">]</span>
      <span class="keyword1"><span class="command">note</span></span> pte <span class="main">=</span> pte<span class="main">[</span><span class="operator">unfolded</span> z'<span class="main">]</span>
      <span class="keyword1"><span class="command">note</span></span> pte_rev <span class="main">=</span> pte_rev<span class="main">[</span><span class="operator">unfolded</span> z'<span class="main">]</span>
      <span class="keyword1"><span class="command">note</span></span> delete <span class="main">=</span> delete_lhs_var<span class="main">[</span><span class="operator">OF</span> eq<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span> refl refl refl zX<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">unfolded</span></span></span></span> X<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> preprocess_opt.simps Some option.simps pte<span class="main">]</span> True
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tv'</span></span> <span class="keyword2"><span class="keyword">where</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"preprocess_opt <span class="skolem">X</span> <span class="skolem">tt1</span> <span class="skolem">tt2</span> <span class="main">=</span> <span class="main">(</span><span class="free">t'</span><span class="main">,</span> <span class="skolem">tv'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        tv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tv</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Mapping.update <span class="skolem">z</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">⦃</span> <span class="main">⟨</span><span class="bound">v</span><span class="main">⟩</span> <span class="main">⦄</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">o</span> <span class="skolem">tv'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Some<span class="main">,</span> <span class="operator">unfolded</span> pte<span class="main">,</span> <span class="operator">OF</span> refl refl refl X res delete<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> refl<span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span> delete<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">tv'</span> <span class="skolem">w</span>"</span></span><span class="main">]</span> delete<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tv'</span> <span class="skolem">w</span>"</span></span><span class="main">]</span> delete<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> tv o_def eq<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">preprocess_part_2</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> preprocess_opt <span class="main">(</span>atom_var <span class="main">`</span> snd <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> preprocess_part_2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"preprocess_part_2 <span class="free">as</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">t'</span><span class="main">,</span><span class="free">tv</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">w</span><span class="main">⟩</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> lrv valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t'</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">tv</span> <span class="free">w</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="main">⟨</span><span class="free">w</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="main">⟨</span><span class="free">tv</span> <span class="free">w</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">v</span> <span class="main">::</span> <span class="tfree">'a</span> valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> preprocess_opt<span class="main">[</span><span class="operator">OF</span> refl assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">unfolded</span></span></span></span> preprocess_part_2_def<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">preprocess</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span>QDelta<span class="main">)</span> i_ns_constraint list <span class="main">⇒</span> <span class="main">_</span> <span class="main">×</span> <span class="main">_</span> <span class="main">×</span> <span class="main">(</span><span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span>QDelta<span class="main">)</span>mapping<span class="main">)</span> <span class="main">×</span> <span class="tfree">'i</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> preprocess_part_1 <span class="main">(</span>map <span class="main">(</span>map_prod id normalize_ns_constraint<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">of</span> 
     <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">as</span><span class="main">,</span><span class="bound">ui</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">case</span> preprocess_part_2 <span class="bound">as</span> <span class="bound">t</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">tv</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">as</span><span class="main">,</span><span class="bound">tv</span><span class="main">,</span><span class="bound">ui</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> preprocess<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"preprocess <span class="free">cs</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">as</span><span class="main">,</span> <span class="free">trans_v</span><span class="main">,</span> <span class="free">ui</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span> 
  <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="free">as</span> <span class="main">∪</span> set <span class="free">ui</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="free">cs</span>"</span></span> 
  <span class="quoted"><span class="quoted">"distinct_indices_ns <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span> <span class="main">⟹</span> distinct_indices_atoms <span class="main">(</span>set <span class="free">as</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∩</span> set <span class="free">ui</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span> <span class="main">⟹</span>
       <span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="main">⟨</span><span class="free">trans_v</span> <span class="free">v</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span>  set <span class="free">cs</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="free">ui</span> <span class="main">⟹</span> <span class="main">∄</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span>  set <span class="free">cs</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ncs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ncs</span> <span class="main">=</span> map <span class="main">(</span>map_prod id normalize_ns_constraint<span class="main">)</span> <span class="free">cs</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> ncs<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="skolem">ncs</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Iv</span><span class="main">.</span> <span class="bound">Iv</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="skolem">ncs</span> <span class="main">⟷</span> <span class="bound">Iv</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ncs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> id <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="keyword2"><span class="keyword">where</span></span> part1<span class="main">:</span> <span class="quoted"><span class="quoted">"preprocess_part_1 <span class="skolem">ncs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="free">as</span><span class="main">,</span><span class="free">ui</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> preprocess_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ncs_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> id<span class="main">[</span><span class="operator">unfolded</span> preprocess_def part1 split ncs_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> part_2<span class="main">:</span> <span class="quoted"><span class="quoted">"preprocess_part_2 <span class="free">as</span> <span class="skolem">t1</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">trans_v</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> normalized_tableau_preprocess' part1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> preprocess_part_1_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> part_2 <span class="main">=</span> preprocess_part_2<span class="main">[</span><span class="operator">OF</span> part_2 norm<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="main">⟨</span><span class="skolem">v</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="skolem">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t1</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">∩</span> set <span class="free">ui</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="main">⟨</span><span class="skolem">v</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="skolem">ncs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> 
    <span class="keyword1"><span class="command">using</span></span> part1<span class="main">[</span><span class="operator">unfolded</span> preprocess_part_1_def Let_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> i_preprocess'_sat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> part_2<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∩</span> set <span class="free">ui</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="main">⟨</span><span class="free">trans_v</span> <span class="free">v</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ncs<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> part1<span class="main">[</span><span class="operator">unfolded</span> preprocess_part_1_def Let_def<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">var</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> Atoms <span class="main">(</span>preprocess' <span class="skolem">ncs</span> <span class="skolem">var</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ui<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ui</span> <span class="main">=</span> UnsatIndices <span class="main">(</span>preprocess' <span class="skolem">ncs</span> <span class="skolem">var</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> min_defs <span class="main">=</span> distinct_indices_atoms_def distinct_indices_ns_def
  <span class="keyword1"><span class="command">have</span></span> min1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>distinct_indices_ns <span class="main">(</span>set <span class="skolem">ncs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">k</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">as</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">a</span> <span class="main">=</span> qdelta_constraint_to_atom <span class="bound">p</span> <span class="bound">v</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ncs</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> is_monom <span class="main">(</span>poly <span class="bound">p</span><span class="main">)</span> <span class="main">⟶</span> Poly_Mapping <span class="main">(</span>preprocess' <span class="skolem">ncs</span> <span class="skolem">var</span><span class="main">)</span> <span class="main">(</span>poly <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span>  <span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">∧</span> fst <span class="main">`</span> set <span class="free">as</span> <span class="main">∪</span> set <span class="free">ui</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="skolem">ncs</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> as ui
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ncs</span></span> <span class="quoted"><span class="skolem">var</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> preprocess'.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">i</span> <span class="skolem">h</span> <span class="skolem">t</span> <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="main">(</span>Atoms <span class="main">(</span>preprocess' <span class="skolem">t</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>UnsatIndices <span class="main">(</span>preprocess' <span class="skolem">t</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="main">(</span>Atoms <span class="main">(</span>preprocess' <span class="main">(</span><span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>UnsatIndices <span class="main">(</span>preprocess' <span class="main">(</span><span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">h</span><span class="main">)</span> <span class="main">#</span><span class="skolem">t</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="main">(</span><span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> sub <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">k</span> <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> min'<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_indices_ns <span class="main">(</span>set <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> min_defs list.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 2<span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> min'<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Atoms <span class="main">(</span>preprocess' <span class="skolem">t</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_split<span class="main">)</span> 
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> new<span class="main">:</span> False
        <span class="keyword1"><span class="command">with</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ki<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_monom <span class="main">(</span>poly <span class="skolem">h</span><span class="main">)</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> new 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def True <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>    
          <span class="keyword3"><span class="command">case</span></span> no_monom<span class="main">:</span> False
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> new 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def no_monom <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="free">as</span> <span class="main">∪</span> set <span class="free">ui</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ncs<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> mini<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_indices_ns <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> mini<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_indices_ns <span class="main">(</span>set <span class="skolem">ncs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> distinct_indices_ns_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> impI allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n1</span> <span class="skolem">n2</span> <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="keyword2"><span class="keyword">where</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c1</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">=</span> normalize_ns_constraint <span class="skolem">c1</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> ncs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c2</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">=</span> normalize_ns_constraint <span class="skolem">c2</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> ncs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> mini<span class="main">[</span><span class="operator">unfolded</span> distinct_indices_ns_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> c1 c2<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> n1 n2 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">c2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> normalize_ns_constraint.simps Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">note</span></span> min <span class="main">=</span> min1<span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct_indices_atoms <span class="main">(</span>set <span class="free">as</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> distinct_indices_atoms_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">a</span> <span class="skolem">b</span> 
      <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">as</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">as</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> min<span class="main">[</span><span class="operator">OF</span> a<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> qdelta_constraint_to_atom <span class="skolem">p</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ncs</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_monom <span class="main">(</span>poly <span class="skolem">p</span><span class="main">)</span> <span class="main">⟹</span> Poly_Mapping <span class="main">(</span>preprocess' <span class="skolem">ncs</span> <span class="skolem">var</span><span class="main">)</span> <span class="main">(</span>poly <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> min<span class="main">[</span><span class="operator">OF</span> b<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> bb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> qdelta_constraint_to_atom <span class="skolem">q</span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ncs</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_monom <span class="main">(</span>poly <span class="skolem">q</span><span class="main">)</span> <span class="main">⟹</span> Poly_Mapping <span class="main">(</span>preprocess' <span class="skolem">ncs</span> <span class="skolem">var</span><span class="main">)</span> <span class="main">(</span>poly <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> mini<span class="main">[</span><span class="operator">unfolded</span> distinct_indices_ns_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> aa<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bb<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">p</span> <span class="main">=</span> poly <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"ns_constraint_const <span class="skolem">p</span> <span class="main">=</span> ns_constraint_const <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"atom_var <span class="skolem">a</span> <span class="main">=</span> atom_var <span class="skolem">b</span> <span class="main">∧</span> atom_const <span class="skolem">a</span> <span class="main">=</span> atom_const <span class="skolem">b</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_monom <span class="main">(</span>poly <span class="skolem">q</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> aa<span class="main">(</span>1<span class="main">)</span> bb<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> aa<span class="main">(</span>1<span class="main">)</span> bb<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> * aa<span class="main">(</span>3<span class="main">)</span> bb<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="free">ui</span> <span class="main">⟹</span> <span class="main">∄</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span>  set <span class="free">cs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> preprocess'_unsat_indices<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">ncs</span></span><span class="main">]</span> part1 <span class="keyword1"><span class="command">unfolding</span></span> preprocess_part_1_def Let_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ncs<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="bound">w</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span>"</span></span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="skolem">w</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="skolem">w</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="skolem">ncs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ncs <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> preprocess'_unsat<span class="main">[</span><span class="operator">OF</span> this _  start_fresh_variable_fresh<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">ncs</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> part1
    <span class="keyword1"><span class="command">unfolding</span></span> preprocess_part_1_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">as</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> part_2<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> PreprocessDefault<span class="main">:</span> Preprocess <span class="quoted">preprocess</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> preprocess<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Solve_exec_ns'Default<span class="main">:</span> Solve_exec_ns' <span class="quoted">preprocess</span> <span class="quoted">assert_all_code</span>
  <span class="keyword2"><span class="keyword">defines</span></span> solve_exec_ns_code <span class="main">=</span> <span class="quoted">Solve_exec_ns'Default.solve_exec_ns</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="comment1">(* To_ns to_ns from_ns  *)</span>
<span class="comment1">(* -------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">constraint_to_qdelta_constraint</span><span class="main">::</span> <span class="quoted"><span class="quoted">"constraint <span class="main">⇒</span> QDelta ns_constraint list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">constraint_to_qdelta_constraint</span> <span class="main">(</span>LT <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>LEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>QDelta.QDelta <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">constraint_to_qdelta_constraint</span> <span class="main">(</span>GT <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>GEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>QDelta.QDelta <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">constraint_to_qdelta_constraint</span> <span class="main">(</span>LEQ <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>LEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>QDelta.QDelta <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">constraint_to_qdelta_constraint</span> <span class="main">(</span>GEQ <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>GEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>QDelta.QDelta <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">constraint_to_qdelta_constraint</span> <span class="main">(</span>EQ <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>LEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>QDelta.QDelta <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> GEQ_ns <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>QDelta.QDelta <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">constraint_to_qdelta_constraint</span> <span class="main">(</span>LTPP <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>LEQ_ns <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">constraint_to_qdelta_constraint</span> <span class="main">(</span>GTPP <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>GEQ_ns <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">constraint_to_qdelta_constraint</span> <span class="main">(</span>LEQPP <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>LEQ_ns <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">0</span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">constraint_to_qdelta_constraint</span> <span class="main">(</span>GEQPP <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>GEQ_ns <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">0</span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">constraint_to_qdelta_constraint</span> <span class="main">(</span>EQPP <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>LEQ_ns <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">0</span><span class="main">,</span> GEQ_ns <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">i_constraint_to_qdelta_constraint</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> i_constraint <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span>QDelta<span class="main">)</span> i_ns_constraint list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i_constraint_to_qdelta_constraint</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>constraint_to_qdelta_constraint <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">to_ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> i_constraint list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span>QDelta<span class="main">)</span> i_ns_constraint list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">to_ns</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> concat <span class="main">(</span>map i_constraint_to_qdelta_constraint <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">δ0_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta ns_constraint <span class="main">⇒</span> QDelta valuation <span class="main">⇒</span> rat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">δ0_val</span> <span class="main">(</span>LEQ_ns <span class="free"><span class="bound"><span class="entity">lll</span></span></span> <span class="free"><span class="bound"><span class="entity">rrr</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vl</span></span></span> <span class="main">=</span> δ0 <span class="free"><span class="bound"><span class="entity">lll</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">vl</span></span></span><span class="main">⦄</span> <span class="free"><span class="bound"><span class="entity">rrr</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">δ0_val</span> <span class="main">(</span>GEQ_ns <span class="free"><span class="bound"><span class="entity">lll</span></span></span> <span class="free"><span class="bound"><span class="entity">rrr</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vl</span></span></span> <span class="main">=</span> δ0 <span class="free"><span class="bound"><span class="entity">rrr</span></span></span> <span class="free"><span class="bound"><span class="entity">lll</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">vl</span></span></span><span class="main">⦄</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">δ0_val_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta ns_constraint list <span class="main">⇒</span> QDelta valuation <span class="main">⇒</span> rat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">δ0_val_min</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">vl</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">δ0_val_min</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vl</span></span></span> <span class="main">=</span> min <span class="main">(</span><span class="free">δ0_val_min</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">vl</span></span></span><span class="main">)</span> <span class="main">(</span>δ0_val <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">vl</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">vars_list_constraints</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vars_list_constraints</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≡</span> remdups <span class="main">(</span>concat <span class="main">(</span>map Abstract_Linear_Poly.vars_list <span class="main">(</span>map poly <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">from_ns</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>var<span class="main">,</span> QDelta<span class="main">)</span> mapping <span class="main">⇒</span> QDelta ns_constraint list <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> mapping"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">from_ns</span> <span class="free"><span class="bound"><span class="entity">vl</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">δ</span> <span class="main">=</span> δ0_val_min <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">vl</span></span></span><span class="main">⟩</span> <span class="keyword1">in</span>
      Mapping.tabulate <span class="main">(</span>vars_list_constraints <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">var</span><span class="main">.</span> val <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">vl</span></span></span><span class="main">⟩</span> <span class="bound">var</span><span class="main">)</span> <span class="bound">δ</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> SolveExec'Default<span class="main">:</span> SolveExec' <span class="quoted">to_ns</span> <span class="quoted">from_ns</span> <span class="quoted">solve_exec_ns_code</span>
  <span class="keyword2"><span class="keyword">defines</span></span> solve_exec_code <span class="main">=</span> <span class="quoted">SolveExec'Default.solve_exec</span>
    <span class="keyword2"><span class="keyword">and</span></span> solve_code <span class="main">=</span> <span class="quoted">SolveExec'Default.solve</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ics</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> i_constraint list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">v'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">I</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?to_ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"to_ns <span class="skolem">ics</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?flat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="var">?to_ns</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">I</span><span class="main">,</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?flat</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> map snd <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="bound">ic</span><span class="main">.</span> fst <span class="bound">ic</span> <span class="main">∈</span> <span class="skolem">I</span><span class="main">)</span> <span class="skolem">ics</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">to_ns'</span></span> <span class="keyword2"><span class="keyword">where</span></span> to_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">to_ns'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">l</span><span class="main">.</span> concat <span class="main">(</span>map constraint_to_qdelta_constraint <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">I</span><span class="main">,</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="main">(</span>flat_list <span class="var">?to_ns</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="skolem">ics</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> i_satisfies_cs.simps
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?listf</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">C</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">C</span> <span class="keyword1">of</span> <span class="main">(</span>LEQ_ns <span class="bound">l</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">l</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>
                                    <span class="main">|</span> <span class="main">(</span>GEQ_ns <span class="bound">l</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">l</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span>
                       <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?to_ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">ics</span><span class="main">.</span> <span class="skolem">to_ns'</span> <span class="main">(</span>map snd <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">ic</span><span class="main">.</span> fst <span class="bound">ic</span> <span class="main">∈</span> <span class="skolem">I</span><span class="main">)</span> <span class="bound">ics</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?list</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?listf</span> <span class="main">(</span><span class="skolem">to_ns'</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>              <span class="comment1">(* index-filtered list *)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f_list</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"flat_list <span class="main">(</span>to_ns <span class="skolem">ics</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?flist</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?listf</span> <span class="var">?f_list</span>"</span></span> <span class="comment1">(* full list *)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i_list</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?list</span> <span class="main">=</span> <span class="skolem">i_list</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f_list</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?flist</span> <span class="main">=</span> <span class="skolem">f_list</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> if_list<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">i_list</span> <span class="main">⊆</span> set <span class="skolem">f_list</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span>
          i_list<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> f_list<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> to_ns_def to_ns set_map set_concat cs_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> image_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">qd1</span> <span class="bound">qd2</span><span class="main">.</span> <span class="main">(</span><span class="bound">qd1</span><span class="main">,</span> <span class="bound">qd2</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?list</span> <span class="main">⟹</span> <span class="bound">qd1</span> <span class="main">≤</span> <span class="bound">qd2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">qd1</span> <span class="skolem">qd2</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">qd1</span><span class="main">,</span> <span class="skolem">qd2</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?list</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qd1</span> <span class="main">≤</span> <span class="skolem">qd2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sat <span class="keyword1"><span class="command">unfolding</span></span> cs_def
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> Nil
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_ns<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">h</span> <span class="skolem">t</span><span class="main">)</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>ic<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">qd1</span><span class="main">,</span><span class="skolem">qd2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="var">?listf</span> <span class="main">(</span><span class="var">?to_ns</span> <span class="main">[</span><span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="main">|</span> <span class="main">(</span>t<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">qd1</span><span class="main">,</span><span class="skolem">qd2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="var">?listf</span> <span class="main">(</span><span class="var">?to_ns</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> to_ns h set_map set_concat <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
            <span class="keyword3"><span class="command">case</span></span> t
            <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> to_ns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> ic
            <span class="keyword1"><span class="command">note</span></span> ic <span class="main">=</span> ic<span class="main">[</span><span class="operator">unfolded</span> to_ns<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
            <span class="keyword1"><span class="command">from</span></span> ic <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">note</span></span> ic <span class="main">=</span> ic<span class="main">[</span><span class="operator">unfolded</span> i if_True<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
            <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> h<span class="main">]</span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="main">(</span><span class="skolem">to_ns'</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> i_satisfies_ns_constraints.simps <span class="keyword1"><span class="command">unfolding</span></span> to_ns to_ns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">with</span></span> ic <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_ns<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="skolem">ε</span> <span class="main">≤</span> <span class="main">(</span>δ_min <span class="var">?list</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">qd1</span> <span class="bound">qd2</span><span class="main">.</span> <span class="main">(</span><span class="bound">qd1</span><span class="main">,</span> <span class="bound">qd2</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?list</span> <span class="main">⟶</span> val <span class="bound">qd1</span> <span class="skolem">ε</span> <span class="main">≤</span> val <span class="bound">qd2</span> <span class="skolem">ε</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ε</span>
        <span class="keyword1"><span class="command">unfolding</span></span> i_list
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delta_gt_zero delta_min<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">i_list</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"δ_min <span class="var">?flist</span> <span class="main">≤</span> δ_min <span class="var">?list</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_list i_list
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> delta_min_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> if_list<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> l1<span class="main">[</span><span class="operator">OF</span> delta_gt_zero this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> l1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">qd1</span> <span class="bound">qd2</span><span class="main">.</span> <span class="main">(</span><span class="bound">qd1</span><span class="main">,</span> <span class="bound">qd2</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?list</span> <span class="main">⟶</span> val <span class="bound">qd1</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">≤</span> val <span class="bound">qd2</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> f_list <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"δ0_val_min <span class="main">(</span>flat_list <span class="main">(</span>to_ns <span class="skolem">ics</span><span class="main">)</span><span class="main">)</span> <span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="main">=</span> δ_min <span class="skolem">f_list</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_list<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ics</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_ns_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">h</span> <span class="skolem">t</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">h</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_ns_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l2<span class="main">:</span> <span class="quoted"><span class="quoted">"from_ns <span class="skolem">v'</span> <span class="var">?f_list</span> <span class="main">=</span> Mapping.tabulate <span class="main">(</span>vars_list_constraints <span class="var">?f_list</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">var</span><span class="main">.</span> val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="bound">var</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> from_ns_def<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> restrict_to <span class="skolem">I</span> <span class="main">(</span>set <span class="skolem">ics</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ics</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> mem <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LT <span class="skolem">lll</span> <span class="skolem">rrr</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">,</span> <span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?list</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> cs_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_ns<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">≤</span> val <span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l1
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lll</span><span class="main">⦃</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span> <span class="main">=</span>
              <span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> valuate_depend<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars <span class="skolem">lll</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> l2
            <span class="keyword1"><span class="command">using</span></span> LT
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def lookup_tabulate restrict_map_def set_vars_list to_ns_def map2fun_def'<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span> <span class="main">≤</span> <span class="main">(</span>val <span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valuate_rat_valuate<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> delta_gt_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f_list</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> val_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>GT <span class="skolem">lll</span> <span class="skolem">rrr</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?list</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> cs_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_ns<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">≥</span> val <span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l1
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lll</span><span class="main">⦃</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span> <span class="main">=</span>
              <span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> valuate_depend<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars <span class="skolem">lll</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> l2
            <span class="keyword1"><span class="command">using</span></span> GT
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tabulate comp_def restrict_map_def set_vars_list to_ns_def map2fun_def'<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span> <span class="main">≥</span> val <span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l2
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valuate_rat_valuate<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> delta_gt_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f_list</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> val_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LEQ <span class="skolem">lll</span> <span class="skolem">rrr</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">,</span> <span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">0</span><span class="main">)</span> <span class="main">)</span> <span class="main">∈</span> set <span class="var">?list</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> cs_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_ns<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">≤</span> val <span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l1
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lll</span><span class="main">⦃</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span> <span class="main">=</span>
              <span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> valuate_depend<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars <span class="skolem">lll</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> l2
            <span class="keyword1"><span class="command">using</span></span> LEQ
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tabulate comp_def restrict_map_def set_vars_list to_ns_def map2fun_def'<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span> <span class="main">≤</span> val <span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l2
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valuate_rat_valuate<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> val_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>GEQ <span class="skolem">lll</span> <span class="skolem">rrr</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?list</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> cs_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_ns<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">≥</span> val <span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l1
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lll</span><span class="main">⦃</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span> <span class="main">=</span>
              <span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> valuate_depend<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars <span class="skolem">lll</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> l2
            <span class="keyword1"><span class="command">using</span></span> GEQ
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tabulate comp_def restrict_map_def set_vars_list to_ns_def map2fun_def'<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span> <span class="main">≥</span> val <span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l2
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valuate_rat_valuate<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> val_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EQ <span class="skolem">lll</span> <span class="skolem">rrr</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?list</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">,</span> <span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">0</span><span class="main">)</span> <span class="main">)</span> <span class="main">∈</span> set <span class="var">?list</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> cs_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_ns<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">≥</span> val <span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">≤</span> val <span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l1
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lll</span><span class="main">⦃</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span> <span class="main">=</span>
              <span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> valuate_depend<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars <span class="skolem">lll</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> l2
            <span class="keyword1"><span class="command">using</span></span> EQ
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tabulate comp_def restrict_map_def set_vars_list to_ns_def map2fun_def'<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span> <span class="main">≥</span> val <span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">lll</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span> <span class="main">≤</span> val <span class="main">(</span>QDelta.QDelta <span class="skolem">rrr</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l1
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valuate_rat_valuate<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> val_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTPP <span class="skolem">ll1</span> <span class="skolem">ll2</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">,</span> <span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span> <span class="main">∈</span> set <span class="var">?list</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> cs_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_ns<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">≤</span> val <span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l1
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span> <span class="main">=</span>
              <span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> valuate_depend<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars <span class="main">(</span><span class="skolem">ll1</span> <span class="main">-</span> <span class="skolem">ll2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> l2
            <span class="keyword1"><span class="command">using</span></span> LTPP
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tabulate comp_def restrict_map_def set_vars_list to_ns_def map2fun_def'<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span> <span class="main">≤</span> val <span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l1
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valuate_rat_valuate<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> delta_gt_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f_list</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> val_def valuate_minus<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>GTPP <span class="skolem">ll1</span> <span class="skolem">ll2</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?list</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> cs_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_ns<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">≥</span> val <span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l1
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span> <span class="main">=</span>
              <span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> valuate_depend<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars <span class="main">(</span><span class="skolem">ll1</span> <span class="main">-</span> <span class="skolem">ll2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> l2
            <span class="keyword1"><span class="command">using</span></span> GTPP
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tabulate comp_def restrict_map_def set_vars_list to_ns_def map2fun_def'<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span> <span class="main">≥</span> val <span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l1
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valuate_rat_valuate<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> delta_gt_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f_list</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> val_def valuate_minus<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LEQPP <span class="skolem">ll1</span> <span class="skolem">ll2</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">,</span> <span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">)</span> <span class="main">∈</span> set <span class="var">?list</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> cs_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_ns zero_QDelta_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">≤</span> val <span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l1
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span> <span class="main">=</span>
              <span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> valuate_depend<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars <span class="main">(</span><span class="skolem">ll1</span> <span class="main">-</span> <span class="skolem">ll2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> l2
            <span class="keyword1"><span class="command">using</span></span> LEQPP
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tabulate comp_def restrict_map_def set_vars_list to_ns_def map2fun_def'<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span> <span class="main">≤</span> val <span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l1
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valuate_rat_valuate<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> delta_gt_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f_list</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> val_def valuate_minus<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>GEQPP <span class="skolem">ll1</span> <span class="skolem">ll2</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?list</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> cs_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_ns zero_QDelta_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">≥</span> val <span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l1
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span> <span class="main">=</span>
              <span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> valuate_depend<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars <span class="main">(</span><span class="skolem">ll1</span> <span class="main">-</span> <span class="skolem">ll2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> l2
            <span class="keyword1"><span class="command">using</span></span> GEQPP
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tabulate comp_def restrict_map_def set_vars_list to_ns_def map2fun_def'<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span> <span class="main">≥</span> val <span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l1
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valuate_rat_valuate<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> delta_gt_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f_list</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> val_def valuate_minus<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EQPP <span class="skolem">ll1</span> <span class="skolem">ll2</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">,</span> <span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">)</span> <span class="main">∈</span> set <span class="var">?list</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?list</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> cs_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_ns zero_QDelta_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">≥</span> val <span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">≤</span> val <span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l1
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span> <span class="main">=</span>
              <span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> valuate_depend<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars <span class="main">(</span><span class="skolem">ll1</span> <span class="main">-</span> <span class="skolem">ll2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="main">⟨</span><span class="skolem">v'</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> l2
            <span class="keyword1"><span class="command">using</span></span> EQPP
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tabulate comp_def restrict_map_def set_vars_list to_ns_def map2fun_def'<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span> <span class="main">≥</span> val <span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ll1</span><span class="main">-</span><span class="skolem">ll2</span><span class="main">)</span><span class="main">⦃</span><span class="main">⟨</span>from_ns <span class="skolem">v'</span> <span class="var">?f_list</span><span class="main">⟩</span><span class="main">⦄</span> <span class="main">≤</span> val <span class="main">(</span>QDelta.QDelta <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>δ_min <span class="skolem">f_list</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l1
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valuate_rat_valuate<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> val_def valuate_minus<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> sat <span class="main">=</span> this
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span> <span class="main">×</span> constraint<span class="main">)</span> list"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> set_to_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>to_ns <span class="skolem">cs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">n</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="main">(</span>constraint_to_qdelta_constraint <span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> to_ns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> indices<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="main">(</span>to_ns <span class="skolem">cs</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="skolem">cs</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="main">(</span>to_ns <span class="skolem">cs</span><span class="main">)</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="skolem">cs</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> set_to_ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="skolem">cs</span>"</span></span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>to_ns <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_to_ns <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="skolem">cs</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="main">(</span>to_ns <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_indices <span class="skolem">cs</span>"</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct_indices_ns <span class="main">(</span>set <span class="main">(</span>to_ns <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> distinct_indices_ns_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI conjI notI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n1</span> <span class="skolem">n2</span> <span class="skolem">i</span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">n1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>to_ns <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">n2</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>to_ns <span class="skolem">cs</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c1</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">∈</span> set <span class="main">(</span>constraint_to_qdelta_constraint <span class="skolem">c1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">∈</span> set <span class="main">(</span>constraint_to_qdelta_constraint <span class="skolem">c2</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> set_to_ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> dist 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> distinct_indices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> c12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">=</span> <span class="skolem">c2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_key_imp_eq_value<span class="main">)</span> 
      <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> n<span class="main">[</span><span class="operator">unfolded</span> c12<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">n1</span> <span class="main">=</span> poly <span class="skolem">n2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ns_constraint_const <span class="skolem">n1</span> <span class="main">=</span> ns_constraint_const <span class="skolem">n2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> mini <span class="main">=</span> this
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="skolem">mode</span>
  <span class="keyword3"><span class="command">assume</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_unsat_core_ns <span class="skolem">I</span> <span class="main">(</span>set <span class="main">(</span>to_ns <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> unsat <span class="main">=</span> unsat<span class="main">[</span><span class="operator">unfolded</span> minimal_unsat_core_ns_def indices<span class="main">]</span>
  <span class="keyword1"><span class="command">hence</span></span> indices<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="skolem">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core <span class="skolem">I</span> <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> minimal_unsat_core_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI indices impI allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">I</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">var</span><span class="main">.</span> QDelta.QDelta <span class="main">(</span><span class="skolem">v</span> <span class="bound">var</span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">I</span><span class="main">,</span><span class="var">?v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>set <span class="main">(</span>to_ns <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">cs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">ic</span> <span class="skolem">cs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> ic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ic</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2-<span class="main">)</span> ic
      <span class="keyword1"><span class="command">have</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">I</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="skolem">cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">⟹</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">jn</span>
        <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">jn</span> <span class="main">∈</span> set <span class="main">(</span>to_ns <span class="main">[</span><span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">jn</span> <span class="main">∈</span> set <span class="main">(</span>i_constraint_to_qdelta_constraint <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> to_ns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> set <span class="main">(</span>constraint_to_qdelta_constraint <span class="skolem">c</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">jn</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">from</span></span> c<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">from</span></span> c n jn <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> snd <span class="skolem">jn</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_QDelta_def to_ns_def valuate_valuate_rat valuate_minus zero_QDelta_def<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> this
      <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> rec<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">I</span><span class="main">,</span><span class="var">?v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="main">(</span>to_ns <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> i_satisfies_ns_constraints.simps
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ballI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>to_ns <span class="main">(</span><span class="skolem">ic</span> <span class="main">#</span> <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="skolem">I</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>to_ns <span class="skolem">cs</span><span class="main">)</span> <span class="main">∩</span> <span class="skolem">I</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>
          <span class="main">|</span> <span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>to_ns <span class="main">[</span><span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∩</span> <span class="skolem">I</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> ic to_ns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> 1
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 2
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">jn</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">jn</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">jn</span> <span class="main">∈</span> set <span class="main">(</span>to_ns <span class="main">[</span><span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∩</span> <span class="skolem">I</span> <span class="main">×</span> UNIV"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> main<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">jn</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> to_ns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_ns_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> unsat <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> minimal_unsat_core_ns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">J</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_indices <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">⊂</span> <span class="skolem">I</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distinct_indices_ns <span class="main">(</span>set <span class="main">(</span>to_ns <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> mini <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> * unsat <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> model<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span>  set <span class="main">(</span>to_ns <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> Mapping.Mapping <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> Some <span class="main">(</span><span class="skolem">v</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">w</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> w_def map2fun_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> model <span class="keyword1"><span class="command">have</span></span> model<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">w</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span>  set <span class="main">(</span>to_ns <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> sat<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="skolem">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* cleanup *)</span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> le lt LE GE LB UB LI UI LBI UBI UBI_upd le_rat
  inv zero Var add flat flat_list restrict_to look upd



<span class="comment1">(* -------------------------------------------------------------------------- *)</span>
<span class="comment1">(* Main soundness lemma and executability *)</span>
<span class="comment1">(* -------------------------------------------------------------------------- *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simplex version with indexed constraints as input›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">simplex_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> i_constraint list <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> mapping"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">simplex_index</span> <span class="main">=</span> solve_exec_code"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> simplex_index<span class="main">:</span>
  <span class="quoted"><span class="quoted">"simplex_index <span class="free">cs</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span> set <span class="free">I</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="free">cs</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span>set <span class="free">I</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span><span class="main">)</span> <span class="main">∧</span> 
     <span class="main">(</span>distinct_indices <span class="free">cs</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">J</span></span> <span class="main">⊂</span> set <span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">J</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹minimal unsat core›</span>
  <span class="quoted"><span class="quoted">"simplex_index <span class="free">cs</span> <span class="main">=</span> Sat <span class="free">v</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>snd <span class="main">`</span> set <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹satisfying assingment›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> simplex_index_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"solve_exec_code <span class="free">cs</span> <span class="main">=</span> Unsat <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> SolveExec'Default.simplex_unsat0<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> core<span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_unsat_core <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">I</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="free">cs</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span>set <span class="free">I</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>distinct_indices <span class="free">cs</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">J</span></span><span class="main">⊂</span>set <span class="free">I</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">J</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> minimal_unsat_core_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"solve_exec_code <span class="free">cs</span> <span class="main">=</span> Sat <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> SolveExec'Default.simplex_sat0<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>snd <span class="main">`</span> set <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simplex version where indices will be created›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">simplex</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">simplex</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> simplex_index <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> simplex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"simplex <span class="free">cs</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹unsat of original constraints›</span>
  <span class="quoted"><span class="quoted">"simplex <span class="free">cs</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span> set <span class="free">I</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">cs</span><span class="main">}</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">{</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="free">I</span><span class="main">}</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">J</span></span><span class="main">⊂</span>set <span class="free">I</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">{</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">J</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹minimal unsat core›</span>
  <span class="quoted"><span class="quoted">"simplex <span class="free">cs</span> <span class="main">=</span> Sat <span class="free">v</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span>"</span></span>  <span class="comment1">― ‹satisfying assignment›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> simplex_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">cs</span><span class="main">]</span> <span class="free">cs</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"simplex_index <span class="var">?cs</span> <span class="main">=</span> Unsat <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> simplex_index<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> index<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">I</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free">cs</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    core<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>snd <span class="main">`</span> <span class="main">(</span>set <span class="var">?cs</span> <span class="main">∩</span> set <span class="free">I</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>distinct_indices <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">cs</span><span class="main">]</span> <span class="free">cs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">J</span></span> <span class="main">⊂</span> set <span class="free">I</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>snd <span class="main">`</span> <span class="main">(</span>set <span class="var">?cs</span> <span class="main">∩</span> <span class="bound">J</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> set_map<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> core<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct_indices <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">cs</span><span class="main">]</span> <span class="free">cs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> distinct_indices_def set_zip <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">J</span></span> <span class="main">⊂</span> set <span class="free">I</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>snd <span class="main">`</span> <span class="main">(</span>set <span class="var">?cs</span> <span class="main">∩</span> <span class="bound">J</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">J</span></span> <span class="main">⊂</span> set <span class="free">I</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">{</span> <span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span>  <span class="bound">i</span> <span class="main">∈</span> <span class="bound">J</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> all_cong1 imp_cong ex_cong1 arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_zip<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> core'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">J</span></span><span class="main">⊂</span>set <span class="free">I</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">{</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">J</span><span class="main">}</span><span class="main">)</span> "</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">note</span></span> unsat <span class="main">=</span> unsat_mono<span class="main">[</span><span class="operator">OF</span> core<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> unsat<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_zip<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">I</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">cs</span><span class="main">}</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">{</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="free">I</span><span class="main">}</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">J</span></span><span class="main">⊂</span>set <span class="free">I</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">{</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">J</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI index core'<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> unsat<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_zip<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"simplex_index <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">cs</span><span class="main">]</span> <span class="free">cs</span><span class="main">)</span> <span class="main">=</span> Sat <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> simplex_index<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> set_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹check executability›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> simplex <span class="main">[</span>LTPP <span class="main">(</span>lp_monom <span class="numeral">2</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>lp_monom <span class="numeral">3</span> <span class="numeral">2</span> <span class="main">-</span> lp_monom <span class="numeral">3</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> GT <span class="main">(</span>lp_monom <span class="main">1</span> <span class="main">1</span><span class="main">)</span> <span class="numeral">5</span><span class="main">]</span>
   <span class="keyword1">of</span> Sat <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True <span class="main">|</span> Unsat <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹check unsat core›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> simplex_index <span class="main">[</span>
    <span class="main">(</span><span class="main">1</span> <span class="main">::</span> int<span class="main">,</span> LT <span class="main">(</span>lp_monom <span class="main">1</span> <span class="main">1</span><span class="main">)</span> <span class="numeral">4</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> GTPP <span class="main">(</span>lp_monom <span class="numeral">2</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>lp_monom <span class="main">1</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="numeral">3</span><span class="main">,</span> EQPP <span class="main">(</span>lp_monom <span class="main">1</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>lp_monom <span class="numeral">2</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="numeral">4</span><span class="main">,</span> GT <span class="main">(</span>lp_monom <span class="numeral">2</span> <span class="numeral">2</span><span class="main">)</span> <span class="numeral">5</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="numeral">5</span><span class="main">,</span> GT <span class="main">(</span>lp_monom <span class="numeral">3</span> <span class="main">0</span><span class="main">)</span> <span class="numeral">7</span><span class="main">)</span><span class="main">]</span>
    <span class="keyword1">of</span> Sat <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False <span class="main">|</span> Unsat <span class="bound">I</span> <span class="main">⇒</span> set <span class="bound">I</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">}</span>"</span></span> <span class="comment1">― ‹Constraints 1,3,4 are unsat core›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Simplex_Incremental">
<div class="head">
<h1>Theory Simplex_Incremental</h1>
</div>
<pre class="source"><span class="comment1">(* Author: R. Thiemann *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Incremental Simplex Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this theory we specify operations which permit to incrementally
  add constraints. To this end, first an indexed list of potential constraints is used
  to construct the initial state, and then one can activate indices, extract solutions or unsat cores,
  do backtracking, etc.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Simplex_Incremental
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Simplex.html">Simplex</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lowest Layer: Fixed Tableau and Incremental Atoms›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Interface›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Incremental_Atom_Ops <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">init_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">assert_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span> <span class="main">::</span> lrv<span class="main">)</span> i_atom <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">check_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">solution_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> mapping"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">checkpoint_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">backtrack_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">precond_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">invariant_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom set <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">checked_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom set <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> 
  assert_s_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_s</span> <span class="free">t</span> <span class="free">as</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">assert_s</span> <span class="free">a</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="free">s'</span> <span class="main">⟹</span> 
    <span class="free">invariant_s</span> <span class="free">t</span> <span class="main">(</span>insert <span class="free">a</span> <span class="free">as</span><span class="main">)</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  assert_s_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_s</span> <span class="free">t</span> <span class="free">as</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">assert_s</span> <span class="free">a</span> <span class="free">s</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span>
    minimal_unsat_core_tabl_atoms <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="free">t</span> <span class="main">(</span>insert <span class="free">a</span> <span class="free">as</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  check_s_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_s</span> <span class="free">t</span> <span class="free">as</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">check_s</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="free">s'</span> <span class="main">⟹</span> 
    <span class="free">checked_s</span> <span class="free">t</span> <span class="free">as</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  check_s_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_s</span> <span class="free">t</span> <span class="free">as</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">check_s</span> <span class="free">s</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span>
    minimal_unsat_core_tabl_atoms <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="free">t</span> <span class="free">as</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  init_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">precond_s</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">checked_s</span> <span class="free">t</span> <span class="main">{}</span> <span class="main">(</span><span class="free">init_s</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  solution_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">checked_s</span> <span class="free">t</span> <span class="free">as</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">solution_s</span> <span class="free">s</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">∧</span> <span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> Simplex.flat <span class="free">as</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  backtrack_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">checked_s</span> <span class="free">t</span> <span class="free">as</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">checkpoint_s</span> <span class="free">s</span> <span class="main">=</span> <span class="free">c</span> 
    <span class="main">⟹</span> <span class="free">invariant_s</span> <span class="free">t</span> <span class="free">bs</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">backtrack_s</span> <span class="free">c</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">s''</span> <span class="main">⟹</span> <span class="free">as</span> <span class="main">⊆</span> <span class="free">bs</span> <span class="main">⟹</span> <span class="free">invariant_s</span> <span class="free">t</span> <span class="free">as</span> <span class="free">s''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  checked_invariant_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">checked_s</span> <span class="free">t</span> <span class="free">as</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">invariant_s</span> <span class="free">t</span> <span class="free">as</span> <span class="free">s</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">assert_all_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom list <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">assert_all_s</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Inr <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">assert_all_s</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">assert_s</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> Unsat <span class="bound">I</span> <span class="main">⇒</span> Unsat <span class="bound">I</span> 
     <span class="main">|</span> Inr <span class="bound">s'</span> <span class="main">⇒</span> <span class="free">assert_all_s</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="bound">s'</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> assert_all_s_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_s</span> <span class="free">t</span> <span class="free">as</span> <span class="free">s</span> <span class="main">⟹</span> assert_all_s <span class="free">bs</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="free">s'</span> <span class="main">⟹</span> 
    <span class="free">invariant_s</span> <span class="free">t</span> <span class="main">(</span>set <span class="free">bs</span> <span class="main">∪</span> <span class="free">as</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs</span> <span class="skolem">s</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="keyword2"><span class="keyword">where</span></span> ass<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assert_s</span> <span class="skolem">b</span> <span class="skolem">s</span> <span class="main">=</span> Inr <span class="skolem">s''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"assert_all_s <span class="skolem">bs</span> <span class="skolem">s''</span> <span class="main">=</span> Inr <span class="free">s'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assert_s_ok<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ass<span class="main"><span class="main">]</span></span> rec<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> assert_all_s_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_s</span> <span class="free">t</span> <span class="free">as</span> <span class="free">s</span> <span class="main">⟹</span> assert_all_s <span class="free">bs</span> <span class="free">s</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span> 
   minimal_unsat_core_tabl_atoms <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="free">t</span> <span class="main">(</span><span class="free">as</span> <span class="main">∪</span> set <span class="free">bs</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs</span> <span class="skolem">s</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">assert_s</span> <span class="skolem">b</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> unsat<span class="main">:</span> <span class="main">(</span>Inl <span class="skolem">J</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">=</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> assert_s_unsat<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> unsat<span class="main">]</span> J
    <span class="keyword1"><span class="command">have</span></span> min<span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_unsat_core_tabl_atoms <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="free">t</span> <span class="main">(</span>insert <span class="skolem">b</span> <span class="skolem">as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> minimal_unsat_core_tabl_atoms_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ min<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assert_s_ok<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Inr<span class="main"><span class="main">]</span></span><span class="main">]</span> Cons<span class="main">(</span>3<span class="main">)</span> Inr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Implementation of the interface via the Simplex operations init, check, and assert-bound.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Incremental_State_Ops_Simplex <span class="main">=</span> AssertBoundNoLhs <span class="quoted"><span class="free">assert_bound</span></span> <span class="main">+</span> Init <span class="quoted"><span class="free">init</span></span> <span class="main">+</span> Check <span class="quoted"><span class="free">check</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">assert_bound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> i_atom <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">check</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">invariant_s</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">invariant_s</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>i_atom set<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">¬</span> 𝒰 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> 
     <span class="main">△</span> <span class="main">(</span>𝒯 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∧</span> 
     <span class="main">∇</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> 
     <span class="main">◇</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> 
     <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">::</span> <span class="main">(</span>var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟷</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∧</span>
     index_valid <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span>
     Simplex.flat <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> 
     <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">checked_s</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">checked_s</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>invariant_s <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="main">⊨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>  

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">assert_s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">assert_s</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">assert_bound</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">in</span>
  <span class="keyword1">if</span> 𝒰 <span class="bound">s'</span> <span class="keyword1">then</span> Inl <span class="main">(</span>the <span class="main">(</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> Inr <span class="bound">s'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">check_s</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">check</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">in</span> 
  <span class="keyword1">if</span> 𝒰 <span class="bound">s'</span> <span class="keyword1">then</span> Inl <span class="main">(</span>the <span class="main">(</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> Inr <span class="bound">s'</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">checkpoint_s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">checkpoint_s</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">backtrack_s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">backtrack_s</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bl</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bu</span></span></span><span class="main">)</span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">bl_old</span></span></span> <span class="free"><span class="bound"><span class="entity">bu_old</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">uc</span></span></span><span class="main">)</span> <span class="main">=</span> State <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="free"><span class="bound"><span class="entity">bu</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">uc</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> invariant_sD<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invariant_s <span class="free">t</span> <span class="free">as</span> <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s</span>"</span></span>  
    <span class="quoted"><span class="quoted">"Simplex.flat <span class="free">as</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"index_valid <span class="free">as</span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">::</span> <span class="main">(</span>var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span> <span class="main">⟷</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> invariant_s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> minimal_unsat_state_core_translation<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 
  unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_unsat_state_core <span class="main">(</span><span class="free">s</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span>state<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  tabl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">v</span> <span class="main">::</span> <span class="tfree">'a</span> valuation<span class="main">)</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span> <span class="main">=</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  index<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="free">as</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  imp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">=</span> the <span class="main">(</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="free">s</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_tabl_atoms <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="free">t</span> <span class="free">as</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> minimal_unsat_core_tabl_atoms_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI notI allI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> unsat<span class="main">[</span><span class="operator">unfolded</span> minimal_unsat_state_core_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"unsat_state_core <span class="free">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> minimal<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_indices_state <span class="free">s</span> <span class="main">⟹</span> subsets_sat_core <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> unsat<span class="main">[</span><span class="operator">unfolded</span> unsat_state_core_def I<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> Is<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">I</span> <span class="main">⊆</span> indices_state <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∄</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span>set <span class="free">I</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Is index <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">I</span> <span class="main">⊆</span> fst <span class="main">`</span> <span class="free">as</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> index_valid_indices_state <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="free">I</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> t tabl <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="free">I</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> as imp 
      <span class="keyword1"><span class="command">using</span></span> atoms_imply_bounds_index.simps satisfies_state_index.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> unsat <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">J</span>
    <span class="keyword3"><span class="command">assume</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_indices_atoms <span class="free">as</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">⊂</span> set <span class="free">I</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> J Is <span class="keyword1"><span class="command">have</span></span> J'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">⊆</span> indices_state <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> dist index <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct_indices_state <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> index_valid_distinct_indices<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> minimal <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subsets_sat_core <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> subsets_sat_core_def I<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> J<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> satisfying_state_valuation_to_atom_tabl<span class="main">[</span><span class="operator">OF</span> J' this index dist<span class="main">]</span> tabl
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> incremental_atom_ops<span class="main">:</span> <span class="quoted"><span class="quoted">"Incremental_Atom_Ops 
  <span class="free">init</span> assert_s check_s 𝒱 checkpoint_s backtrack_s <span class="main">△</span> invariant_s checked_s"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t</span> <span class="skolem">as</span> <span class="skolem">s</span> <span class="skolem">a</span> <span class="skolem">s'</span><span class="main">)</span> <span class="comment1">(* assert ok *)</span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> assert_s_def Let_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="main">(</span><span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> <span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> invariant_sD<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> assert_bound_nolhs_tableau_id<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒯 <span class="skolem">s'</span> <span class="main">=</span> 𝒯 <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>3<span class="main">,</span>9<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">::</span> var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s'</span> <span class="main">=</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assert_bound_nolhs_sat<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span> U<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assert_bound_nolhs_atoms_equiv_bounds<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1-6<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Simplex.flat <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assert_bound_nolhs_atoms_imply_bounds_index<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">,</span></span>7<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">a</span> <span class="skolem">as</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assert_bound_nolhs_tableau_valuated<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assert_bound_nolhs_index_valid<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">,</span></span>8<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"index_valid <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> U s' 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> invariant_s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">t</span> <span class="skolem">as</span> <span class="skolem">s</span> <span class="skolem">a</span> <span class="skolem">I</span><span class="main">)</span> <span class="comment1">(* assert unsat *)</span>
  <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> assert_s_def Let_def<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> <span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span><span class="free">assert_bound</span> <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> the <span class="main">(</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> invariant_sD<span class="main">[</span><span class="operator">OF</span> 2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> assert_bound_nolhs_tableau_id<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒯 <span class="skolem">s'</span> <span class="main">=</span> 𝒯 <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>3<span class="main">,</span>9<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tabl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">::</span> var <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s'</span> <span class="main">=</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> assert_bound_nolhs_unsat<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">,</span></span>8<span class="main"><span class="main">)</span></span> U<span class="main">]</span> s'
  <span class="keyword1"><span class="command">have</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_unsat_state_core <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assert_bound_nolhs_index_valid<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">,</span></span>8<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> index<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assert_bound_nolhs_atoms_imply_bounds_index<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">,</span></span>7<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> imp<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="skolem">a</span> <span class="skolem">as</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> minimal_unsat_state_core_translation<span class="main">[</span><span class="operator">OF</span> unsat tabl index imp I<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">t</span> <span class="skolem">as</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span> <span class="comment1">(* check ok *)</span>
  <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> check_s_def Let_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="main">(</span><span class="free">check</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> <span class="free">check</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> invariant_sD<span class="main">[</span><span class="operator">OF</span> 3<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> ** <span class="main">=</span> *<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> check_tableau_equiv<span class="main">[</span><span class="operator">OF</span> **<span class="main">]</span> *<span class="main">(</span>9<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s'</span> <span class="main">=</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> check_tableau_index_valid<span class="main">[</span><span class="operator">OF</span> **<span class="main">]</span> *<span class="main">(</span>8<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"index_valid <span class="skolem">as</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> check_tableau_normalized<span class="main">[</span><span class="operator">OF</span> **<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> check_tableau_valuated<span class="main">[</span><span class="operator">OF</span> **<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> check_sat<span class="main">[</span><span class="operator">OF</span> ** U<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊨</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s'<span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> satisfies_satisfies_no_lhs<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> satisfies_consistent<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> check_bounds_id<span class="main">[</span><span class="operator">OF</span> **<span class="main">]</span> *<span class="main">(</span>6<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Simplex.flat <span class="skolem">as</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsu_def boundsl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> check_bounds_id<span class="main">[</span><span class="operator">OF</span> **<span class="main">]</span> *<span class="main">(</span>7<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsu_def boundsl_def indexu_def indexl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> U 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> invariant_s_def checked_s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">t</span> <span class="skolem">as</span> <span class="skolem">s</span> <span class="skolem">I</span><span class="main">)</span> <span class="comment1">(* check Unsat *)</span>
  <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> check_s_def Let_def<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> <span class="free">check</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span><span class="free">check</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> the <span class="main">(</span>𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> invariant_sD<span class="main">[</span><span class="operator">OF</span> 4<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> ** <span class="main">=</span> *<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> check_unsat<span class="main">[</span><span class="operator">OF</span> ** U<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_unsat_state_core <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> check_tableau_equiv<span class="main">[</span><span class="operator">OF</span> **<span class="main">]</span> *<span class="main">(</span>9<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tabl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s'</span> <span class="main">=</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> check_tableau_index_valid<span class="main">[</span><span class="operator">OF</span> **<span class="main">]</span> *<span class="main">(</span>8<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> index<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="skolem">as</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> check_bounds_id<span class="main">[</span><span class="operator">OF</span> **<span class="main">]</span> *<span class="main">(</span>7<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> imp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsu_def boundsl_def indexu_def indexl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> minimal_unsat_state_core_translation<span class="main">[</span><span class="operator">OF</span> unsat tabl index imp I<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> *<span class="main">:</span> <span class="main">(</span>5 <span class="skolem">t</span><span class="main">)</span> <span class="comment1">(* init *)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> checked_s_def invariant_s_def
    <span class="keyword1"><span class="command">using</span></span> 
      init_tableau_normalized<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> 
      init_index_valid<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
      init_atoms_imply_bounds_index<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
      init_satisfies<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
      init_atoms_equiv_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
      init_tableau_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
      init_unsat_flag<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
      init_tableau_valuated<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
      satisfies_consistent<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="skolem">t</span>"</span></span><span class="main">]</span> satisfies_satisfies_no_lhs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="skolem">t</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">t</span> <span class="skolem">as</span> <span class="skolem">s</span> <span class="skolem">v</span><span class="main">)</span> <span class="comment1">(* solution *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> checked_s_def invariant_s_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> atoms_equiv_bounds.simps curr_val_satisfies_state_def satisfies_state_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">t</span> <span class="skolem">as</span> <span class="skolem">s</span> <span class="skolem">c</span> <span class="skolem">bs</span> <span class="skolem">s'</span> <span class="skolem">s''</span><span class="main">)</span> <span class="comment1">(* checkpoint and backtrack *)</span>
  <span class="keyword1"><span class="command">from</span></span> 7<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> checked_s_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> inv_s<span class="main">:</span> <span class="quoted"><span class="quoted">"invariant_s <span class="skolem">t</span> <span class="skolem">as</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊨</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 7<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> checkpoint_s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> s''<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒯 <span class="skolem">s''</span> <span class="main">=</span> 𝒯 <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"𝒱 <span class="skolem">s''</span> <span class="main">=</span> 𝒱 <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s''</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"𝒰 <span class="skolem">s''</span> <span class="main">=</span> 𝒰 <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">s''</span> <span class="main">=</span> 𝒰<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 7<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> c
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> BI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ</span> <span class="skolem">s''</span> <span class="main">=</span> <span class="keyword1">ℬ</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℐ</span> <span class="skolem">s''</span> <span class="main">=</span> <span class="keyword1">ℐ</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsu_def boundsl_def indexu_def indexl_def<span class="main">)</span>  
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> invariant_sD<span class="main">[</span><span class="operator">OF</span> inv_s<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> ** <span class="main">=</span> invariant_sD<span class="main">[</span><span class="operator">OF</span> 7<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>3<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> **<span class="main">(</span>1<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="skolem">s''</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s'' <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> **<span class="main">(</span>3<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="skolem">s''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s'' <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> **<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s''</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> tableau_valuated_def s'' <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> **<span class="main">(</span>9<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s''</span> <span class="main">=</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s'' <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>6<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Simplex.flat <span class="skolem">as</span> <span class="main">≐</span> <span class="keyword1">ℬ</span> <span class="skolem">s''</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> BI <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>7<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">ℬℐ</span> <span class="skolem">s''</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> BI <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>8<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"index_valid <span class="skolem">as</span> <span class="skolem">s''</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> index_valid_def <span class="keyword1"><span class="command">using</span></span> s'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> **<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="skolem">s''</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> tableau_valuated_def s'' <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> satisfies_consistent<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> s
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="skolem">s''</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bounds_consistent_def <span class="keyword1"><span class="command">using</span></span> BI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> 7<span class="main">(</span>5<span class="main">)</span> *<span class="main">(</span>6<span class="main">)</span> **<span class="main">(</span>6<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="skolem">s'</span> <span class="main">⟹</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="skolem">s''</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> atoms_equiv_bounds.simps satisfies_atom_set_def BI
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> **<span class="main">(</span>2<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="skolem">s'</span> <span class="main">∥</span> <span class="main">-</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> curr_val_satisfies_no_lhs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span> <span class="keyword1">then</span> <span class="keyword1">case</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> the <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span> Some <span class="bound">b</span> <span class="main">⇒</span> <span class="bound">b</span> <span class="keyword1">else</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="bound">x</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds.simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">var</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"in_bounds <span class="skolem">x</span> <span class="var">?v</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> **<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> bounds_consistent_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s'</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> b 
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds_set.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> vB<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="skolem">s''</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword1">ℬ</span> <span class="skolem">s''</span> <span class="main">∥</span> <span class="main">-</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies_bounds_set.simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> v<span class="main">[</span><span class="operator">unfolded</span> satisfies_bounds.simps<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"in_bounds <span class="skolem">x</span> <span class="main">⟨</span>𝒱 <span class="skolem">s'</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ</span> <span class="skolem">s''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">s''</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> curr_val_satisfies_no_lhs_def s''
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> invariant_s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> checked_s_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Intermediate Layer: Incremental Non-Strict Constraints›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Interface›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Incremental_NS_Constraint_Ops <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">init_nsc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span> <span class="main">::</span> lrv<span class="main">)</span> i_ns_constraint list <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">assert_nsc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">check_nsc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">solution_nsc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> mapping"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">checkpoint_nsc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">backtrack_nsc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">invariant_nsc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_ns_constraint list <span class="main">⇒</span> <span class="tfree">'i</span> set <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">checked_nsc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_ns_constraint list <span class="main">⇒</span> <span class="tfree">'i</span> set <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> 
  assert_nsc_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_nsc</span> <span class="free">nsc</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">assert_nsc</span> <span class="free">j</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="free">s'</span> <span class="main">⟹</span> 
    <span class="free">invariant_nsc</span> <span class="free">nsc</span> <span class="main">(</span>insert <span class="free">j</span> <span class="free">J</span><span class="main">)</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  assert_nsc_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_nsc</span> <span class="free">nsc</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">assert_nsc</span> <span class="free">j</span> <span class="free">s</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span>
    set <span class="free">I</span> <span class="main">⊆</span> insert <span class="free">j</span> <span class="free">J</span> <span class="main">∧</span> minimal_unsat_core_ns <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="main">(</span>set <span class="free">nsc</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  check_nsc_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_nsc</span> <span class="free">nsc</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">check_nsc</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="free">s'</span> <span class="main">⟹</span> 
    <span class="free">checked_nsc</span> <span class="free">nsc</span> <span class="free">J</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  check_nsc_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_nsc</span> <span class="free">nsc</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">check_nsc</span> <span class="free">s</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span> 
    set <span class="free">I</span> <span class="main">⊆</span> <span class="free">J</span> <span class="main">∧</span> minimal_unsat_core_ns <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="main">(</span>set <span class="free">nsc</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  init_nsc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">checked_nsc</span> <span class="free">nsc</span> <span class="main">{}</span> <span class="main">(</span><span class="free">init_nsc</span> <span class="free">nsc</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  solution_nsc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">checked_nsc</span> <span class="free">nsc</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">solution_nsc</span> <span class="free">s</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">J</span><span class="main">,</span> <span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">nsc</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  backtrack_nsc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">checked_nsc</span> <span class="free">nsc</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">checkpoint_nsc</span> <span class="free">s</span> <span class="main">=</span> <span class="free">c</span> 
    <span class="main">⟹</span> <span class="free">invariant_nsc</span> <span class="free">nsc</span> <span class="free">K</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">backtrack_nsc</span> <span class="free">c</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">s''</span> <span class="main">⟹</span> <span class="free">J</span> <span class="main">⊆</span> <span class="free">K</span> <span class="main">⟹</span> <span class="free">invariant_nsc</span> <span class="free">nsc</span> <span class="free">J</span> <span class="free">s''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  checked_invariant_nsc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">checked_nsc</span> <span class="free">nsc</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">invariant_nsc</span> <span class="free">nsc</span> <span class="free">J</span> <span class="free">s</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Implementation via the Simplex operation preprocess and the incremental operations for atoms.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">create_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span>list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'i</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list<span class="main">)</span>mapping"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">create_map</span> <span class="main">[]</span> <span class="main">=</span> Mapping.empty"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">create_map</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">create_map</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span>
     <span class="keyword1">case</span> Mapping.lookup <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span> 
       None <span class="main">⇒</span> Mapping.update <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">]</span> <span class="bound">m</span> 
     <span class="main">|</span> Some <span class="bound">ias</span> <span class="main">⇒</span> Mapping.update <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="bound">ias</span><span class="main">)</span> <span class="bound">m</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_map_to_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'i</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list<span class="main">)</span>mapping <span class="main">⇒</span> <span class="tfree">'i</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_map_to_fun</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="bound">ias</span> <span class="main">⇒</span> <span class="bound">ias</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> list_map_to_fun_create_map<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>list_map_to_fun <span class="main">(</span>create_map <span class="free">ias</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> set <span class="free">ias</span> <span class="main">∩</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">×</span> UNIV"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ias</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> list_map_to_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">ja</span> <span class="skolem">ias</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> ja<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ja</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"list_map_to_fun <span class="main">(</span>create_map <span class="main">(</span><span class="skolem">ja</span> <span class="main">#</span> <span class="skolem">ias</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> list_map_to_fun <span class="main">(</span>create_map <span class="skolem">ias</span><span class="main">)</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> ja list_map_to_fun_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id Cons <span class="keyword1"><span class="command">unfolding</span></span> ja <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> ja <span class="keyword1"><span class="command">have</span></span> ja<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ja</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"list_map_to_fun <span class="main">(</span>create_map <span class="main">(</span><span class="skolem">ja</span> <span class="main">#</span> <span class="skolem">ias</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">ja</span> <span class="main">#</span> list_map_to_fun <span class="main">(</span>create_map <span class="skolem">ias</span><span class="main">)</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> ja list_map_to_fun_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">unfolding</span></span> ja <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sum_wrap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="tfree">'s</span><span class="main">)</span>
  <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sum_wrap</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">asi</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">asi</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> Unsat <span class="bound">I</span> <span class="main">⇒</span> Unsat <span class="bound">I</span> <span class="main">|</span> Inr <span class="bound">s'</span> <span class="main">⇒</span> Inr <span class="main">(</span><span class="free"><span class="bound"><span class="entity">asi</span></span></span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_nsc</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">check_nsc</span> <span class="free"><span class="bound"><span class="entity">check_s</span></span></span> <span class="main">=</span> sum_wrap <span class="main">(</span><span class="main">λ</span> <span class="bound">asitv</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">check_s</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">assert_nsc</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">assert_nsc</span> <span class="free"><span class="bound"><span class="entity">assert_all_s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">asi</span><span class="main">,</span><span class="bound">tv</span><span class="main">,</span><span class="bound">ui</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> 
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∈</span> set <span class="bound">ui</span> <span class="keyword1">then</span> Unsat <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="keyword1">else</span> 
  <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">assert_all_s</span></span></span> <span class="main">(</span>list_map_to_fun <span class="bound">asi</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="bound">s</span> <span class="keyword1">of</span> Unsat <span class="bound">I</span> <span class="main">⇒</span> Unsat <span class="bound">I</span> <span class="main">|</span> Inr <span class="bound">s'</span> <span class="main">⇒</span> Inr <span class="main">(</span><span class="main">(</span><span class="bound">asi</span><span class="main">,</span><span class="bound">tv</span><span class="main">,</span><span class="bound">ui</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">checkpoint_nsc</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">checkpoint_nsc</span> <span class="free"><span class="bound"><span class="entity">checkpoint_s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">asi_tv_ui</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">checkpoint_s</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> 
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">backtrack_nsc</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">backtrack_nsc</span> <span class="free"><span class="bound"><span class="entity">backtrack_s</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">asi_tv_ui</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">asi_tv_ui</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">backtrack_s</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">solution_nsc</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">solution_nsc</span> <span class="free"><span class="bound"><span class="entity">solution_s</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">asi</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">tv</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ui</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tv</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">solution_s</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> 


<span class="keyword1"><span class="command">locale</span></span> Incremental_Atom_Ops_For_NS_Constraint_Ops <span class="main">=</span>
  Incremental_Atom_Ops <span class="quoted"><span class="free">init_s</span></span> <span class="quoted"><span class="free">assert_s</span></span> <span class="quoted"><span class="free">check_s</span></span> <span class="quoted"><span class="free">solution_s</span></span> <span class="quoted"><span class="free">checkpoint_s</span></span> <span class="quoted"><span class="free">backtrack_s</span></span> <span class="quoted"><span class="main">△</span></span>
  <span class="quoted"><span class="free">invariant_s</span></span> <span class="quoted"><span class="free">checked_s</span></span>
  <span class="main">+</span> Preprocess <span class="quoted"><span class="free">preprocess</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> 
    <span class="free">init_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">assert_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span> <span class="main">::</span> linorder<span class="main">,</span><span class="tfree">'a</span> <span class="main">::</span> lrv<span class="main">)</span> i_atom <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">check_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">solution_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> mapping"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">checkpoint_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">backtrack_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">invariant_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom set <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">checked_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom set <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">preprocess</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_ns_constraint list <span class="main">⇒</span> tableau <span class="main">×</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_atom list <span class="main">×</span> <span class="main">(</span><span class="main">(</span>var<span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>mapping <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>mapping<span class="main">)</span> <span class="main">×</span> <span class="tfree">'i</span> list"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">init_nsc</span> <span class="free"><span class="bound"><span class="entity">nsc</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">preprocess</span> <span class="free"><span class="bound"><span class="entity">nsc</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">as</span><span class="main">,</span><span class="bound">trans_v</span><span class="main">,</span><span class="bound">ui</span><span class="main">)</span> <span class="main">⇒</span> 
   <span class="main">(</span><span class="main">(</span>create_map <span class="bound">as</span><span class="main">,</span> <span class="bound">trans_v</span><span class="main">,</span> remdups <span class="bound">ui</span><span class="main">)</span><span class="main">,</span> <span class="free">init_s</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">invariant_as_asi</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">invariant_as_asi</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">asi</span></span></span> <span class="free"><span class="bound"><span class="entity">tc</span></span></span> <span class="free"><span class="bound"><span class="entity">tc'</span></span></span> <span class="free"><span class="bound"><span class="entity">ui</span></span></span> <span class="free"><span class="bound"><span class="entity">ui'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tc</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tc'</span></span></span> <span class="main">∧</span> set <span class="free"><span class="bound"><span class="entity">ui</span></span></span> <span class="main">=</span> set <span class="free"><span class="bound"><span class="entity">ui'</span></span></span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> set <span class="main">(</span>list_map_to_fun <span class="free"><span class="bound"><span class="entity">asi</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">∩</span> <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">invariant_nsc</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">invariant_nsc</span> <span class="free"><span class="bound"><span class="entity">nsc</span></span></span> <span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">asi</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">tv</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ui</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">preprocess</span> <span class="free"><span class="bound"><span class="entity">nsc</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">as</span><span class="main">,</span><span class="bound">tv'</span><span class="main">,</span><span class="bound">ui'</span><span class="main">)</span> <span class="main">⇒</span> invariant_as_asi <span class="main">(</span>set <span class="bound">as</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">asi</span></span></span> <span class="free"><span class="bound"><span class="entity">tv</span></span></span> <span class="bound">tv'</span> <span class="free"><span class="bound"><span class="entity">ui</span></span></span> <span class="bound">ui'</span> <span class="main">∧</span> 
     <span class="free">invariant_s</span> <span class="bound">t</span> <span class="main">(</span>set <span class="bound">as</span> <span class="main">∩</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="main">∩</span> set <span class="free"><span class="bound"><span class="entity">ui</span></span></span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">checked_nsc</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">checked_nsc</span> <span class="free"><span class="bound"><span class="entity">nsc</span></span></span> <span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">asi</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">tv</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ui</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">preprocess</span> <span class="free"><span class="bound"><span class="entity">nsc</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">as</span><span class="main">,</span><span class="bound">tv'</span><span class="main">,</span><span class="bound">ui'</span><span class="main">)</span> <span class="main">⇒</span> invariant_as_asi <span class="main">(</span>set <span class="bound">as</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">asi</span></span></span> <span class="free"><span class="bound"><span class="entity">tv</span></span></span> <span class="bound">tv'</span> <span class="free"><span class="bound"><span class="entity">ui</span></span></span> <span class="bound">ui'</span> <span class="main">∧</span> 
     <span class="free">checked_s</span> <span class="bound">t</span> <span class="main">(</span>set <span class="bound">as</span> <span class="main">∩</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="main">∩</span> set <span class="free"><span class="bound"><span class="entity">ui</span></span></span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> i_satisfies_atom_set_inter_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">ats</span> <span class="main">∩</span> <span class="main">(</span><span class="free">J</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="free">I</span> <span class="main">∩</span> <span class="free">J</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">ats</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> i_satisfies_atom_set.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">v</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> ns_constraints_ops<span class="main">:</span> <span class="quoted"><span class="quoted">"Incremental_NS_Constraint_Ops init_nsc <span class="main">(</span>assert_nsc assert_all_s<span class="main">)</span>
  <span class="main">(</span>check_nsc <span class="free">check_s</span><span class="main">)</span> <span class="main">(</span>solution_nsc <span class="free">solution_s</span><span class="main">)</span> <span class="main">(</span>checkpoint_nsc <span class="free">checkpoint_s</span><span class="main">)</span> <span class="main">(</span>backtrack_nsc <span class="free">backtrack_s</span><span class="main">)</span>
  invariant_nsc checked_nsc"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">nsc</span> <span class="skolem">J</span> <span class="skolem">S</span> <span class="skolem">j</span> <span class="skolem">S'</span><span class="main">)</span> <span class="comment1">(* assert ok *)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">asi</span></span> <span class="skolem"><span class="skolem">tv</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">ui</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">asi</span><span class="main">,</span><span class="skolem">tv</span><span class="main">,</span><span class="skolem">ui</span><span class="main">)</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">tv'</span></span> <span class="skolem"><span class="skolem">ui'</span></span> <span class="keyword2"><span class="keyword">where</span></span> prep<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="skolem">nsc</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">tv'</span><span class="main">,</span> <span class="skolem">ui'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="skolem">nsc</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> pre <span class="main">=</span> 1<span class="main">[</span><span class="operator">unfolded</span> S assert_nsc_def<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> pre<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    ok<span class="main">:</span> <span class="quoted"><span class="quoted">"assert_all_s <span class="main">(</span>list_map_to_fun <span class="skolem">asi</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> Inr <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> S'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">asi</span><span class="main">,</span><span class="skolem">tv</span><span class="main">,</span><span class="skolem">ui</span><span class="main">)</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∉</span> set <span class="skolem">ui</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> pre<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_s</span> <span class="skolem">t</span> <span class="main">(</span>set <span class="skolem">as</span> <span class="main">∩</span> <span class="skolem">J</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="skolem">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> asi<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>list_map_to_fun <span class="skolem">asi</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">as</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">j</span><span class="main">}</span> <span class="main">×</span> UNIV"</span></span> <span class="quoted"><span class="quoted">"invariant_as_asi <span class="main">(</span>set <span class="skolem">as</span><span class="main">)</span> <span class="skolem">asi</span> <span class="skolem">tv</span> <span class="skolem">tv'</span> <span class="skolem">ui</span> <span class="skolem">ui'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">∩</span> set <span class="skolem">ui</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assert_all_s_ok<span class="main">[</span><span class="operator">OF</span> inv ok<span class="main">,</span> <span class="operator">unfolded</span> asi<span class="main">]</span> asi<span class="main">(</span>2-<span class="main">)</span> j
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> invariant_nsc.simps S' prep split
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_insert_left Sigma_Un_distrib1 inf_sup_distrib1 insert_is_Un<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">nsc</span> <span class="skolem">J</span> <span class="skolem">S</span> <span class="skolem">j</span> <span class="skolem">I</span><span class="main">)</span> <span class="comment1">(* assert unsat *)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">asi</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">tv</span></span> <span class="skolem"><span class="skolem">ui</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">asi</span><span class="main">,</span><span class="skolem">tv</span><span class="main">,</span><span class="skolem">ui</span><span class="main">)</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">tv'</span></span> <span class="skolem"><span class="skolem">ui'</span></span> <span class="keyword2"><span class="keyword">where</span></span> prep<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="skolem">nsc</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">tv'</span><span class="main">,</span> <span class="skolem">ui'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="skolem">nsc</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> pre <span class="main">=</span> 2<span class="main">[</span><span class="operator">unfolded</span> S assert_nsc_def split<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> set <span class="skolem">ui</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> pre<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"assert_all_s <span class="main">(</span>list_map_to_fun <span class="skolem">asi</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> Unsat <span class="skolem">I</span>"</span></span>  
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> pre<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_s</span> <span class="skolem">t</span> <span class="main">(</span>set <span class="skolem">as</span> <span class="main">∩</span> <span class="skolem">J</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="skolem">s</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> asi<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>list_map_to_fun <span class="skolem">asi</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">as</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">j</span><span class="main">}</span> <span class="main">×</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> assert_all_s_unsat<span class="main">[</span><span class="operator">OF</span> inv unsat<span class="main">,</span> <span class="operator">unfolded</span> asi<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_tabl_atoms <span class="main">(</span>set <span class="skolem">I</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">(</span>set <span class="skolem">as</span> <span class="main">∩</span> <span class="skolem">J</span> <span class="main">×</span> UNIV <span class="main">∪</span> set <span class="skolem">as</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">j</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">as</span> <span class="main">∩</span> <span class="skolem">J</span> <span class="main">×</span> UNIV <span class="main">∪</span> set <span class="skolem">as</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">j</span><span class="main">}</span> <span class="main">×</span> UNIV <span class="main">=</span> set <span class="skolem">as</span> <span class="main">∩</span> insert <span class="skolem">j</span> <span class="skolem">J</span> <span class="main">×</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_unsat_core_tabl_atoms <span class="main">(</span>set <span class="skolem">I</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">(</span>set <span class="skolem">as</span> <span class="main">∩</span> insert <span class="skolem">j</span> <span class="skolem">J</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">I</span> <span class="main">⊆</span> insert <span class="skolem">j</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> minimal_unsat_core_tabl_atoms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> False pre <span class="keyword1"><span class="command">have</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">I</span> <span class="main">∩</span> set <span class="skolem">ui'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_tabl_atoms <span class="main">(</span>set <span class="skolem">I</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">(</span>set <span class="skolem">as</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> minimal_unsat_core_tabl_atoms_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ unsat<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> preprocess_minimal_unsat_core<span class="main">[</span><span class="operator">OF</span> prep this empty<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_ns <span class="main">(</span>set <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">nsc</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> pre<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">j</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> pre<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> invariant_nsc.simps prep split invariant_as_asi.simps<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ui</span> <span class="main">=</span> set <span class="skolem">ui'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> set <span class="skolem">ui'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> preprocess_unsat_index<span class="main">[</span><span class="operator">OF</span> prep j<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">nsc</span> <span class="skolem">J</span> <span class="skolem">S</span> <span class="skolem">S'</span><span class="main">)</span> <span class="comment1">(* check ok *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> check_s_ok <span class="keyword1"><span class="command">unfolding</span></span> check_nsc_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">nsc</span> <span class="skolem">J</span> <span class="skolem">S</span> <span class="skolem">I</span><span class="main">)</span> <span class="comment1">(* check unsat *)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">asi</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">tv</span></span> <span class="skolem"><span class="skolem">ui</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">asi</span><span class="main">,</span><span class="skolem">tv</span><span class="main">,</span><span class="skolem">ui</span><span class="main">)</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">tv'</span></span> <span class="skolem"><span class="skolem">ui'</span></span> <span class="keyword2"><span class="keyword">where</span></span> prep<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="skolem">nsc</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">tv'</span><span class="main">,</span> <span class="skolem">ui'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="skolem">nsc</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> pre <span class="main">=</span> 4<span class="main">[</span><span class="operator">unfolded</span> S check_nsc_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> pre <span class="keyword1"><span class="command">have</span></span> 
    unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">check_s</span> <span class="skolem">s</span> <span class="main">=</span> Unsat <span class="skolem">I</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span>
    inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_s</span> <span class="skolem">t</span> <span class="main">(</span>set <span class="skolem">as</span> <span class="main">∩</span> <span class="skolem">J</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="skolem">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> check_s_unsat<span class="main">[</span><span class="operator">OF</span> inv unsat<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_unsat_core_tabl_atoms <span class="main">(</span>set <span class="skolem">I</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">(</span>set <span class="skolem">as</span> <span class="main">∩</span> <span class="skolem">J</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">I</span> <span class="main">⊆</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> minimal_unsat_core_tabl_atoms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> pre <span class="keyword1"><span class="command">have</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">I</span> <span class="main">∩</span> set <span class="skolem">ui'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_tabl_atoms <span class="main">(</span>set <span class="skolem">I</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">(</span>set <span class="skolem">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> minimal_unsat_core_tabl_atoms_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ unsat<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> preprocess_minimal_unsat_core<span class="main">[</span><span class="operator">OF</span> prep this empty<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_ns <span class="main">(</span>set <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">nsc</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">nsc</span><span class="main">)</span> <span class="comment1">(* init *)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">tv'</span></span> <span class="skolem"><span class="skolem">ui'</span></span> <span class="keyword2"><span class="keyword">where</span></span> prep<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="skolem">nsc</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">tv'</span><span class="main">,</span> <span class="skolem">ui'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="skolem">nsc</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> init_nsc_def  
    <span class="keyword1"><span class="command">using</span></span> init_s preprocess_tableau_normalized<span class="main">[</span><span class="operator">OF</span> prep<span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_map_to_fun_create_map<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">nsc</span> <span class="skolem">J</span> <span class="skolem">S</span> <span class="skolem">v</span><span class="main">)</span> <span class="comment1">(* solution *)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">asi</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">tv</span></span> <span class="skolem"><span class="skolem">ui</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">asi</span><span class="main">,</span><span class="skolem">tv</span><span class="main">,</span><span class="skolem">ui</span><span class="main">)</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">tv'</span></span> <span class="skolem"><span class="skolem">ui'</span></span> <span class="keyword2"><span class="keyword">where</span></span> prep<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="skolem">nsc</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">tv'</span><span class="main">,</span> <span class="skolem">ui'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="skolem">nsc</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">J</span><span class="main">,</span><span class="main">⟨</span><span class="free">solution_s</span> <span class="skolem">s</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="skolem">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">solution_s</span> <span class="skolem">s</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> 6 S solution_s<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> i_preprocess_sat<span class="main">[</span><span class="operator">OF</span> prep _ this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 6 S <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">nsc</span> <span class="skolem">J</span> <span class="skolem">S</span> <span class="skolem">c</span> <span class="skolem">K</span> <span class="skolem">S'</span> <span class="skolem">S''</span><span class="main">)</span> <span class="comment1">(* backtrack *)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">tvp</span></span> <span class="skolem"><span class="skolem">uip</span></span> <span class="keyword2"><span class="keyword">where</span></span> prep<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="skolem">nsc</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">tvp</span><span class="main">,</span> <span class="skolem">uip</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">preprocess</span> <span class="skolem">nsc</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">asi</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">tv</span></span> <span class="skolem"><span class="skolem">ui</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">asi</span><span class="main">,</span><span class="skolem">tv</span><span class="main">,</span><span class="skolem">ui</span><span class="main">)</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">asi'</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">tv'</span></span> <span class="skolem"><span class="skolem">ui'</span></span> <span class="keyword2"><span class="keyword">where</span></span> S'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">asi'</span><span class="main">,</span><span class="skolem">tv'</span><span class="main">,</span><span class="skolem">ui'</span><span class="main">)</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">asi''</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="skolem"><span class="skolem">tv''</span></span> <span class="skolem"><span class="skolem">ui''</span></span> <span class="keyword2"><span class="keyword">where</span></span> S''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S''</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">asi''</span><span class="main">,</span><span class="skolem">tv''</span><span class="main">,</span><span class="skolem">ui''</span><span class="main">)</span><span class="main">,</span><span class="skolem">s''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S''</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> backtrack_s<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="skolem">s''</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 7 S S' S'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">nsc</span> <span class="skolem">J</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> checked_invariant_s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Highest Layer: Incremental Constraints›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Interface›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Incremental_Simplex_Ops <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="free">init_cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> i_constraint list <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">assert_cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">check_cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">solution_cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> rat valuation"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">checkpoint_cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">backtrack_cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">invariant_cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> i_constraint list <span class="main">⇒</span> <span class="tfree">'i</span> set <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">checked_cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> i_constraint list <span class="main">⇒</span> <span class="tfree">'i</span> set <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> 
  assert_cs_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_cs</span> <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">assert_cs</span> <span class="free">j</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="free">s'</span> <span class="main">⟹</span> 
    <span class="free">invariant_cs</span> <span class="free">cs</span> <span class="main">(</span>insert <span class="free">j</span> <span class="free">J</span><span class="main">)</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  assert_cs_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_cs</span> <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">assert_cs</span> <span class="free">j</span> <span class="free">s</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span>
    set <span class="free">I</span> <span class="main">⊆</span> insert <span class="free">j</span> <span class="free">J</span> <span class="main">∧</span> minimal_unsat_core <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  check_cs_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_cs</span> <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">check_cs</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="free">s'</span> <span class="main">⟹</span> 
    <span class="free">checked_cs</span> <span class="free">cs</span> <span class="free">J</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  check_cs_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_cs</span> <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">check_cs</span> <span class="free">s</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span>
    set <span class="free">I</span> <span class="main">⊆</span> <span class="free">J</span> <span class="main">∧</span> minimal_unsat_core <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  init_cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">checked_cs</span> <span class="free">cs</span> <span class="main">{}</span> <span class="main">(</span><span class="free">init_cs</span> <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  solution_cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">checked_cs</span> <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">solution_cs</span> <span class="free">s</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">J</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  backtrack_cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">checked_cs</span> <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">checkpoint_cs</span> <span class="free">s</span> <span class="main">=</span> <span class="free">c</span> 
    <span class="main">⟹</span> <span class="free">invariant_cs</span> <span class="free">cs</span> <span class="free">K</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">backtrack_cs</span> <span class="free">c</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">s''</span> <span class="main">⟹</span> <span class="free">J</span> <span class="main">⊆</span> <span class="free">K</span> <span class="main">⟹</span> <span class="free">invariant_cs</span> <span class="free">cs</span> <span class="free">J</span> <span class="free">s''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  checked_invariant_cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">checked_cs</span> <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">invariant_cs</span> <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Implementation via the Simplex-operation To-Ns and the Incremental Operations for Non-Strict Constraints›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">assert_cs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">assert_cs</span> <span class="free"><span class="bound"><span class="entity">ass</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ass</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> 
    Unsat <span class="bound">I</span> <span class="main">⇒</span> Unsat <span class="bound">I</span> 
  <span class="main">|</span> Inr <span class="bound">s'</span> <span class="main">⇒</span> Inr <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">init_cs</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">tons</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">tons_cs</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tons</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>map snd <span class="main">(</span><span class="bound">tons_cs</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="bound">tons_cs</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">check_cs</span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> sum_wrap <span class="main">(</span><span class="main">λ</span> <span class="bound">cs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">check</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> 
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">checkpoint_cs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">checkpoint_cs</span> <span class="free"><span class="bound"><span class="entity">checkp</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">checkp</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">backtrack_cs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">backtrack_cs</span> <span class="free"><span class="bound"><span class="entity">backt</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">backt</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">solution_cs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">solution_cs</span> <span class="free"><span class="bound"><span class="entity">sol</span></span></span> <span class="free"><span class="bound"><span class="entity">from</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">from</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sol</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">⟩</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">locale</span></span> Incremental_NS_Constraint_Ops_To_Ns_For_Incremental_Simplex <span class="main">=</span>
  Incremental_NS_Constraint_Ops <span class="quoted"><span class="free">init_nsc</span></span> <span class="quoted"><span class="free">assert_nsc</span></span> <span class="quoted"><span class="free">check_nsc</span></span> <span class="quoted"><span class="free">solution_nsc</span></span> <span class="quoted"><span class="free">checkpoint_nsc</span></span> <span class="quoted"><span class="free">backtrack_nsc</span></span> 
  <span class="quoted"><span class="free">invariant_nsc</span></span> <span class="quoted"><span class="free">checked_nsc</span></span> <span class="main">+</span> To_ns <span class="quoted"><span class="free">to_ns</span></span> <span class="quoted"><span class="free">from_ns</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> 
    <span class="free">init_nsc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span> <span class="main">::</span> lrv<span class="main">)</span> i_ns_constraint list <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">assert_nsc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">check_nsc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">solution_nsc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> mapping"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">checkpoint_nsc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">backtrack_nsc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">invariant_nsc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_ns_constraint list <span class="main">⇒</span> <span class="tfree">'i</span> set <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">checked_nsc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_ns_constraint list <span class="main">⇒</span> <span class="tfree">'i</span> set <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">to_ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> i_constraint list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> i_ns_constraint list"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">from_ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> mapping <span class="main">⇒</span> <span class="tfree">'a</span> ns_constraint list <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span> rat<span class="main">)</span> mapping"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">invariant_cs</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">invariant_cs</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main">=</span> map snd <span class="main">(</span><span class="free">to_ns</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free">invariant_nsc</span> <span class="main">(</span><span class="free">to_ns</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">checked_cs</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">checked_cs</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main">=</span> map snd <span class="main">(</span><span class="free">to_ns</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free">checked_nsc</span> <span class="main">(</span><span class="free">to_ns</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">sublocale</span></span> Incremental_Simplex_Ops <span class="quoted"><span class="quoted">"init_cs <span class="free">init_nsc</span> <span class="free">to_ns</span>"</span></span> <span class="quoted"><span class="quoted">"assert_cs <span class="free">assert_nsc</span>"</span></span>
  <span class="quoted"><span class="quoted">"check_cs <span class="free">check_nsc</span>"</span></span> <span class="quoted"><span class="quoted">"solution_cs <span class="free">solution_nsc</span> <span class="free">from_ns</span>"</span></span> <span class="quoted"><span class="quoted">"checkpoint_cs <span class="free">checkpoint_nsc</span>"</span></span> <span class="quoted"><span class="quoted">"backtrack_cs <span class="free">backtrack_nsc</span>"</span></span> 
  <span class="quoted">invariant_cs</span> <span class="quoted">checked_cs</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">cs</span> <span class="skolem">J</span> <span class="skolem">S</span> <span class="skolem">j</span> <span class="skolem">S'</span><span class="main">)</span> <span class="comment1">(* assert ok *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span>map snd <span class="main">(</span><span class="free">to_ns</span> <span class="skolem">cs</span><span class="main">)</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> pre <span class="main">=</span> 1<span class="main">[</span><span class="operator">unfolded</span> S assert_cs.simps<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> pre<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assert_nsc</span> <span class="skolem">j</span> <span class="skolem">s</span> <span class="main">=</span> Inr <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> S'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> <span class="main">(</span>map snd <span class="main">(</span><span class="free">to_ns</span> <span class="skolem">cs</span><span class="main">)</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> pre<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_nsc</span> <span class="main">(</span><span class="free">to_ns</span> <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">J</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assert_nsc_ok<span class="main">[</span><span class="operator">OF</span> inv ok<span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> invariant_cs.simps S' split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">cs</span> <span class="skolem">J</span> <span class="skolem">S</span> <span class="skolem">j</span> <span class="skolem">I</span><span class="main">)</span> <span class="comment1">(* assert unsat *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span>map snd <span class="main">(</span><span class="free">to_ns</span> <span class="skolem">cs</span><span class="main">)</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> pre <span class="main">=</span> 2<span class="main">[</span><span class="operator">unfolded</span> S assert_cs.simps<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> pre<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">assert_nsc</span> <span class="skolem">j</span> <span class="skolem">s</span> <span class="main">=</span> Unsat <span class="skolem">I</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> pre<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_nsc</span> <span class="main">(</span><span class="free">to_ns</span> <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">J</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assert_nsc_unsat<span class="main">[</span><span class="operator">OF</span> inv unsat<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">I</span> <span class="main">⊆</span> insert <span class="skolem">j</span> <span class="skolem">J</span>"</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_ns <span class="main">(</span>set <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="free">to_ns</span> <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> to_ns_unsat<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> this<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">cs</span> <span class="skolem">J</span> <span class="skolem">S</span> <span class="skolem">S'</span><span class="main">)</span> <span class="comment1">(* check ok *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> check_nsc_ok <span class="keyword1"><span class="command">unfolding</span></span> check_cs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">cs</span> <span class="skolem">J</span> <span class="skolem">S</span> <span class="skolem">I</span><span class="main">)</span> <span class="comment1">(* check unsat *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span>map snd <span class="main">(</span><span class="free">to_ns</span> <span class="skolem">cs</span><span class="main">)</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> pre <span class="main">=</span> 4<span class="main">[</span><span class="operator">unfolded</span> S check_cs_def<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> pre<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">check_nsc</span> <span class="skolem">s</span> <span class="main">=</span> Unsat <span class="skolem">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> pre<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant_nsc</span> <span class="main">(</span><span class="free">to_ns</span> <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">J</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> check_nsc_unsat<span class="main">[</span><span class="operator">OF</span> inv unsat<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">I</span> <span class="main">⊆</span> <span class="skolem">J</span>"</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_ns <span class="main">(</span>set <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="free">to_ns</span> <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> minimal_unsat_core_ns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> to_ns_unsat<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> this<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">cs</span><span class="main">)</span> <span class="comment1">(* init *)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> init_cs_def Let_def <span class="keyword1"><span class="command">using</span></span> init_nsc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">cs</span> <span class="skolem">J</span> <span class="skolem">S</span> <span class="skolem">v</span><span class="main">)</span> <span class="comment1">(* solution *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span>map snd <span class="main">(</span><span class="free">to_ns</span> <span class="skolem">cs</span><span class="main">)</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">solution_nsc</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> pre <span class="main">=</span> 6<span class="main">[</span><span class="operator">unfolded</span> S solution_cs.simps w Let_def<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> pre <span class="keyword1"><span class="command">have</span></span>
    inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">checked_nsc</span> <span class="main">(</span><span class="free">to_ns</span> <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">J</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">from_ns</span> <span class="skolem">w</span> <span class="main">(</span>map snd <span class="main">(</span><span class="free">to_ns</span> <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> solution_nsc<span class="main">[</span><span class="operator">OF</span> inv w<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">J</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">w</span><span class="main">⟩</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span>  set <span class="main">(</span><span class="free">to_ns</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> i_to_ns_sat<span class="main">[</span><span class="operator">OF</span> w<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> v <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">cs</span> <span class="skolem">J</span> <span class="skolem">S</span> <span class="skolem">c</span> <span class="skolem">K</span> <span class="skolem">S'</span> <span class="skolem">S''</span><span class="main">)</span> <span class="comment1">(* backtrack *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> backtrack_nsc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">to_ns</span> <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="skolem">J</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">S'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">S''</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">cs</span> <span class="skolem">J</span> <span class="skolem">S</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> checked_invariant_nsc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Concrete Implementation›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Connecting all the locales›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">assert_s</span> <span class="main">=</span> Incremental_State_Ops_Simplex.assert_s assert_bound_code"</span></span>  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">check_s</span> <span class="main">=</span> Incremental_State_Ops_Simplex.check_s check_code"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">checkpoint_s</span> <span class="main">=</span> Incremental_State_Ops_Simplex.checkpoint_s"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">backtrack_s</span> <span class="main">=</span> Incremental_State_Ops_Simplex.backtrack_s"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">invariant_s</span> <span class="main">=</span> Incremental_State_Ops_Simplex.invariant_s"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">checked_s</span> <span class="main">=</span> Incremental_State_Ops_Simplex.checked_s"</span></span>  

<span class="keyword1"><span class="command">global_interpretation</span></span> Incremental_State_Ops_Simplex_Default<span class="main">:</span>
  Incremental_State_Ops_Simplex <span class="quoted">assert_bound_code</span> <span class="quoted">init_state</span> <span class="quoted">check_code</span> 
  <span class="keyword2"><span class="keyword">rewrites</span></span>
    <span class="quoted"><span class="quoted">"Incremental_State_Ops_Simplex.assert_s assert_bound_code <span class="main">=</span> assert_s"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Incremental_State_Ops_Simplex.check_s check_code <span class="main">=</span> check_s"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Incremental_State_Ops_Simplex.backtrack_s <span class="main">=</span> backtrack_s"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Incremental_State_Ops_Simplex.checkpoint_s <span class="main">=</span> checkpoint_s"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="quoted"><span class="quoted">"Incremental_State_Ops_Simplex.invariant_s <span class="main">=</span> invariant_s"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Incremental_State_Ops_Simplex.checked_s <span class="main">=</span> checked_s"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 
      assert_s_def 
      check_s_def 
      checkpoint_s_def
      backtrack_s_def
      checked_s_def
      invariant_s_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">assert_all_s</span> <span class="main">=</span> Incremental_Atom_Ops.assert_all_s assert_s"</span></span> 

<span class="keyword1"><span class="command">global_interpretation</span></span> Incremental_Atom_Ops_Default<span class="main">:</span>  
  Incremental_Atom_Ops <span class="quoted">init_state</span> <span class="quoted">assert_s</span> <span class="quoted">check_s</span> <span class="quoted">𝒱</span> <span class="quoted">checkpoint_s</span> <span class="quoted">backtrack_s</span> <span class="quoted"><span class="main">△</span></span> <span class="quoted">invariant_s</span> <span class="quoted">checked_s</span>
  <span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"Incremental_Atom_Ops.assert_all_s assert_s <span class="main">=</span> assert_all_s"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Incremental_State_Ops_Simplex_Default.incremental_atom_ops
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assert_all_s_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">init_nsc_code</span> <span class="main">=</span> <span class="main">(</span>Incremental_Atom_Ops_For_NS_Constraint_Ops.init_nsc init_state preprocess <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> QDelta atom<span class="main">)</span> list<span class="main">)</span> mapping <span class="main">×</span> <span class="main">_</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> QDelta<span class="main">)</span> state<span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">assert_nsc_code</span> <span class="main">=</span> assert_nsc assert_all_s"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">check_nsc_code</span> <span class="main">=</span> check_nsc check_s"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">checkpoint_nsc_code</span> <span class="main">=</span> checkpoint_nsc checkpoint_s"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">solution_nsc_code</span> <span class="main">=</span> solution_nsc 𝒱"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">backtrack_nsc_code</span> <span class="main">=</span> backtrack_nsc backtrack_s"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">invariant_nsc</span> <span class="main">=</span> Incremental_Atom_Ops_For_NS_Constraint_Ops.invariant_nsc invariant_s preprocess"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">checked_nsc</span> <span class="main">=</span> Incremental_Atom_Ops_For_NS_Constraint_Ops.checked_nsc checked_s preprocess"</span></span> 

<span class="keyword1"><span class="command">global_interpretation</span></span> Incremental_Atom_Ops_For_NS_Constraint_Ops_Default<span class="main">:</span> 
  Incremental_Atom_Ops_For_NS_Constraint_Ops <span class="quoted">init_state</span> <span class="quoted">assert_s</span> <span class="quoted">check_s</span> <span class="quoted">𝒱</span> 
  <span class="quoted">checkpoint_s</span> <span class="quoted">backtrack_s</span> <span class="quoted">invariant_s</span> <span class="quoted">checked_s</span> <span class="quoted">preprocess</span>
  <span class="keyword2"><span class="keyword">rewrites</span></span> 
    <span class="quoted"><span class="quoted">"Incremental_Atom_Ops_For_NS_Constraint_Ops.init_nsc init_state preprocess <span class="main">=</span> init_nsc_code"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"check_nsc check_s <span class="main">=</span> check_nsc_code"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"checkpoint_nsc checkpoint_s <span class="main">=</span> checkpoint_nsc_code"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"solution_nsc 𝒱 <span class="main">=</span> solution_nsc_code"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"backtrack_nsc backtrack_s <span class="main">=</span> backtrack_nsc_code"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="quoted"><span class="quoted">"assert_nsc assert_all_s <span class="main">=</span> assert_nsc_code"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="quoted"><span class="quoted">"Incremental_Atom_Ops_For_NS_Constraint_Ops.invariant_nsc invariant_s preprocess <span class="main">=</span> invariant_nsc"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Incremental_Atom_Ops_For_NS_Constraint_Ops.checked_nsc checked_s preprocess <span class="main">=</span> checked_nsc"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Incremental_Atom_Ops.assert_all_s assert_s <span class="main">=</span> assert_all_s"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 
      init_nsc_code_def
      assert_nsc_code_def
      check_nsc_code_def
      checkpoint_nsc_code_def
      solution_nsc_code_def
      backtrack_nsc_code_def
      invariant_nsc_def
      checked_nsc_def
      assert_all_s_def
      <span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'i</span> simplex_state' <span class="main">=</span> <span class="quoted"><span class="quoted">"QDelta ns_constraint list 
  <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'i</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'i</span> <span class="main">×</span> QDelta atom<span class="main">)</span> list<span class="main">)</span> mapping <span class="main">×</span> <span class="main">(</span><span class="main">(</span>var<span class="main">,</span>QDelta<span class="main">)</span>mapping <span class="main">⇒</span> <span class="main">(</span>var<span class="main">,</span>QDelta<span class="main">)</span>mapping<span class="main">)</span> <span class="main">×</span> <span class="tfree">'i</span> list<span class="main">)</span> 
  <span class="main">×</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span> QDelta<span class="main">)</span> state"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">init_simplex'</span> <span class="main">=</span> <span class="main">(</span>init_cs init_nsc_code to_ns <span class="main">::</span> <span class="tfree">'i</span> <span class="main">::</span> linorder i_constraint list <span class="main">⇒</span> <span class="tfree">'i</span> simplex_state'<span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">assert_simplex'</span> <span class="main">=</span> <span class="main">(</span>assert_cs assert_nsc_code <span class="main">::</span> <span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'i</span> simplex_state' <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="tfree">'i</span> simplex_state'<span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">check_simplex'</span> <span class="main">=</span> <span class="main">(</span>check_cs check_nsc_code <span class="main">::</span> <span class="tfree">'i</span> simplex_state' <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="tfree">'i</span> simplex_state'<span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">solution_simplex'</span> <span class="main">=</span> <span class="main">(</span>solution_cs solution_nsc_code from_ns <span class="main">::</span> <span class="tfree">'i</span> simplex_state' <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">backtrack_simplex'</span> <span class="main">=</span> <span class="main">(</span>backtrack_cs backtrack_nsc_code <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'i</span> simplex_state' <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">checkpoint_simplex'</span> <span class="main">=</span> <span class="main">(</span>checkpoint_cs checkpoint_nsc_code <span class="main">::</span> <span class="tfree">'i</span> simplex_state' <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">invariant_simplex'</span> <span class="main">=</span> Incremental_NS_Constraint_Ops_To_Ns_For_Incremental_Simplex.invariant_cs invariant_nsc to_ns"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">checked_simplex'</span> <span class="main">=</span> Incremental_NS_Constraint_Ops_To_Ns_For_Incremental_Simplex.checked_cs checked_nsc to_ns"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> case_sum_case_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> Inl <span class="bound">y</span> <span class="main">⇒</span> Inl <span class="main">(</span><span class="free">f1</span> <span class="bound">y</span><span class="main">)</span> <span class="main">|</span> Inr <span class="bound">z</span> <span class="main">⇒</span> Inr <span class="main">(</span><span class="free">f2</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> 
  <span class="keyword1">of</span> Inl <span class="bound">y</span> <span class="main">⇒</span> Inl <span class="main">(</span><span class="free">g1</span> <span class="bound">y</span><span class="main">)</span> <span class="main">|</span> Inr <span class="bound">z</span> <span class="main">⇒</span> Inr <span class="main">(</span><span class="free">g2</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> Inl <span class="bound">y</span> <span class="main">⇒</span> Inl <span class="main">(</span><span class="free">g1</span> <span class="main">(</span><span class="free">f1</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> Inr <span class="bound">z</span> <span class="main">⇒</span> Inr <span class="main">(</span><span class="free">g2</span> <span class="main">(</span><span class="free">f2</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following code-lemmas unfold some layers in the code of the simplex-operations, 
  so that the implementation immediately points to
  the operations working on simplex type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'i</span></span><span class="main"><span class="main">,</span></span>QDelta<span class="main"><span class="main">)</span></span> state"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> code_lemmas <span class="main">=</span>
  fun_cong<span class="main">[</span><span class="operator">OF</span> init_simplex'_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">cs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">cs</span><span class="main">,</span> <span class="operator">unfolded</span> init_cs_def 
    Incremental_Atom_Ops_For_NS_Constraint_Ops_Default.init_nsc_def<span class="main">]</span>
  fun_cong<span class="main">[</span><span class="operator">OF</span> fun_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assert_simplex'_def<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cs</span><span class="main">,</span><span class="main">(</span><span class="main">(</span><span class="free">asi</span><span class="main">,</span><span class="free">tv</span><span class="main">,</span><span class="free">ui</span><span class="main">)</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">i</span> <span class="free">cs</span> <span class="free">asi</span> <span class="free">tv</span> <span class="free">ui</span> <span class="free">s</span><span class="main">,</span> 
    <span class="operator">unfolded</span> assert_cs.simps assert_nsc_code_def assert_nsc_def case_sum_case_sum split<span class="main">]</span>
  fun_cong<span class="main">[</span><span class="operator">OF</span> check_simplex'_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cs</span><span class="main">,</span><span class="main">(</span><span class="free">asi_tv</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">cs</span> <span class="free">asi_tv</span> <span class="free">s</span><span class="main">,</span> 
    <span class="operator">unfolded</span> check_cs_def check_nsc_code_def check_nsc_def sum_wrap.simps case_sum_case_sum<span class="main">]</span> 
  fun_cong<span class="main">[</span><span class="operator">OF</span> solution_simplex'_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cs</span><span class="main">,</span><span class="main">(</span><span class="main">(</span><span class="free">asi</span><span class="main">,</span><span class="free">tv</span><span class="main">)</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">cs</span> <span class="free">asi</span> <span class="free">tv</span> <span class="free">s</span><span class="main">,</span> 
    <span class="operator">unfolded</span> solution_cs.simps solution_nsc_code_def solution_nsc.simps<span class="main">]</span>
  fun_cong<span class="main">[</span><span class="operator">OF</span> checkpoint_simplex'_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cs</span><span class="main">,</span><span class="main">(</span><span class="free">asi_tv</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">cs</span> <span class="free">asi_tv</span> <span class="free">s</span><span class="main">,</span>
    <span class="operator">unfolded</span> checkpoint_nsc_code_def checkpoint_cs.simps checkpoint_nsc.simps<span class="main">]</span>
  fun_cong<span class="main">[</span><span class="operator">OF</span> fun_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> backtrack_simplex'_def<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cs</span><span class="main">,</span><span class="main">(</span><span class="free">asi_tv</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">c</span> <span class="free">cs</span> <span class="free">asi_tv</span> <span class="free">s</span><span class="main">,</span>
    <span class="operator">unfolded</span> backtrack_nsc_code_def backtrack_nsc.simps backtrack_cs.simps<span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> code_lemmas<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Incremental_Simplex<span class="main">:</span>
  Incremental_NS_Constraint_Ops_To_Ns_For_Incremental_Simplex 
  <span class="quoted">init_nsc_code</span> <span class="quoted">assert_nsc_code</span> <span class="quoted">check_nsc_code</span> <span class="quoted">solution_nsc_code</span> <span class="quoted">checkpoint_nsc_code</span> <span class="quoted">backtrack_nsc_code</span> 
  <span class="quoted">invariant_nsc</span> <span class="quoted">checked_nsc</span> <span class="quoted">to_ns</span> <span class="quoted">from_ns</span>
  <span class="keyword2"><span class="keyword">rewrites</span></span> 
    <span class="quoted"><span class="quoted">"init_cs init_nsc_code to_ns <span class="main">=</span> init_simplex'"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"backtrack_cs backtrack_nsc_code <span class="main">=</span> backtrack_simplex'"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"checkpoint_cs checkpoint_nsc_code <span class="main">=</span> checkpoint_simplex'"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"check_cs check_nsc_code <span class="main">=</span> check_simplex'"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"assert_cs assert_nsc_code <span class="main">=</span> assert_simplex'"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"solution_cs solution_nsc_code from_ns <span class="main">=</span> solution_simplex'"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Incremental_NS_Constraint_Ops_To_Ns_For_Incremental_Simplex.invariant_cs invariant_nsc to_ns <span class="main">=</span> invariant_simplex'"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Incremental_NS_Constraint_Ops_To_Ns_For_Incremental_Simplex.checked_cs checked_nsc to_ns <span class="main">=</span> checked_simplex'"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> Incremental_NS_Constraint_Ops <span class="quoted">init_nsc_code</span> <span class="quoted">assert_nsc_code</span> <span class="quoted">check_nsc_code</span> <span class="quoted">solution_nsc_code</span> <span class="quoted">checkpoint_nsc_code</span>
    <span class="quoted">backtrack_nsc_code</span> <span class="quoted">invariant_nsc</span> <span class="quoted">checked_nsc</span>
    <span class="keyword1"><span class="command">using</span></span> Incremental_Atom_Ops_For_NS_Constraint_Ops_Default.ns_constraints_ops <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Incremental_NS_Constraint_Ops_To_Ns_For_Incremental_Simplex init_nsc_code assert_nsc_code check_nsc_code
     solution_nsc_code checkpoint_nsc_code backtrack_nsc_code invariant_nsc checked_nsc to_ns from_ns"</span></span> 
    <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 
    init_simplex'_def
    check_simplex'_def
    solution_simplex'_def
    backtrack_simplex'_def
    checkpoint_simplex'_def
    assert_simplex'_def
    invariant_simplex'_def
    checked_simplex'_def
    <span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹An implementation which encapsulates the state›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In principle, we now already have a complete implementation of the incremental simplex algorithm with
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> init_simplex'<span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> assert_simplex'<span class="antiquote"><span class="antiquote">}</span></span></span></span>, etc. However, this implementation results in code where
  the interal type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'i</span></span> simplex_state'"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> becomes visible. Therefore, we now define all operations
  on a new type which encapsulates the internal construction.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'i</span> simplex_state <span class="main">=</span> Simplex_State <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> simplex_state'"</span></span> 
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'i</span> simplex_checkpoint <span class="main">=</span> Simplex_Checkpoint <span class="quoted"><span class="quoted">"<span class="main">(</span>nat<span class="main">,</span> <span class="tfree">'i</span> <span class="main">×</span> QDelta<span class="main">)</span> mapping <span class="main">×</span> <span class="main">(</span>nat<span class="main">,</span> <span class="tfree">'i</span> <span class="main">×</span> QDelta<span class="main">)</span> mapping"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">init_simplex</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">init_simplex</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">tons_cs</span> <span class="main">=</span> to_ns <span class="free"><span class="bound"><span class="entity">cs</span></span></span>
   <span class="keyword1">in</span> Simplex_State <span class="main">(</span>map snd <span class="bound">tons_cs</span><span class="main">,</span>
       <span class="keyword1">case</span> preprocess <span class="bound">tons_cs</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">as</span><span class="main">,</span> <span class="bound">trans_v</span><span class="main">,</span> <span class="bound">ui</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>create_map <span class="bound">as</span><span class="main">,</span> <span class="bound">trans_v</span><span class="main">,</span> remdups <span class="bound">ui</span><span class="main">)</span><span class="main">,</span> init_state <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">assert_simplex</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">assert_simplex</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Simplex_State <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">asi</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tv</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ui</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ui</span></span></span> <span class="keyword1">then</span> Inl <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="keyword1">else</span> <span class="keyword1">case</span> assert_all_s <span class="main">(</span>list_map_to_fun <span class="free"><span class="bound"><span class="entity">asi</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">y</span> <span class="main">⇒</span> Inl <span class="bound">y</span> <span class="main">|</span> Inr <span class="bound">s'</span> <span class="main">⇒</span> Inr <span class="main">(</span>Simplex_State <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">asi</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tv</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ui</span></span></span><span class="main">)</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">check_simplex</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">check_simplex</span> <span class="main">(</span>Simplex_State <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">asi_tv</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> check_s <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">y</span> <span class="main">⇒</span> Inl <span class="bound">y</span> <span class="main">|</span> Inr <span class="bound">s'</span> <span class="main">⇒</span> Inr <span class="main">(</span>Simplex_State <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">asi_tv</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">solution_simplex</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">solution_simplex</span> <span class="main">(</span>Simplex_State <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">asi</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tv</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ui</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>from_ns <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tv</span></span></span> <span class="main">(</span>𝒱 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">⟩</span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">checkpoint_simplex</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">checkpoint_simplex</span> <span class="main">(</span>Simplex_State <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">asi_tv</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Simplex_Checkpoint <span class="main">(</span>checkpoint_s <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">backtrack_simplex</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">backtrack_simplex</span> <span class="main">(</span>Simplex_Checkpoint <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>Simplex_State <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">asi_tv</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Simplex_State <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">asi_tv</span></span></span><span class="main">,</span> backtrack_s <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness of the incremental simplex implementation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First link the unprimed constants against their primed counterparts.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_simplex'<span class="main">:</span> <span class="quoted"><span class="quoted">"init_simplex <span class="free">cs</span> <span class="main">=</span> Simplex_State <span class="main">(</span>init_simplex' <span class="free">cs</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> code_lemmas Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> assert_simplex'<span class="main">:</span> <span class="quoted"><span class="quoted">"assert_simplex <span class="free">i</span> <span class="main">(</span>Simplex_State <span class="free">s</span><span class="main">)</span> <span class="main">=</span> map_sum id Simplex_State <span class="main">(</span>assert_simplex' <span class="free">i</span> <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> code_lemmas <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> check_simplex'<span class="main">:</span> <span class="quoted"><span class="quoted">"check_simplex <span class="main">(</span>Simplex_State <span class="free">s</span><span class="main">)</span> <span class="main">=</span> map_sum id Simplex_State <span class="main">(</span>check_simplex' <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> code_lemmas <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> solution_simplex'<span class="main">:</span> <span class="quoted"><span class="quoted">"solution_simplex <span class="main">(</span>Simplex_State <span class="free">s</span><span class="main">)</span> <span class="main">=</span> solution_simplex' <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> code_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> checkpoint_simplex'<span class="main">:</span> <span class="quoted"><span class="quoted">"checkpoint_simplex <span class="main">(</span>Simplex_State <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Simplex_Checkpoint <span class="main">(</span>checkpoint_simplex' <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> code_lemmas <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> backtrack_simplex'<span class="main">:</span> <span class="quoted"><span class="quoted">"backtrack_simplex <span class="main">(</span>Simplex_Checkpoint <span class="free">c</span><span class="main">)</span> <span class="main">(</span>Simplex_State <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Simplex_State <span class="main">(</span>backtrack_simplex' <span class="free">c</span> <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> code_lemmas <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">invariant_simplex</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">invariant_simplex</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="main">(</span>Simplex_State <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> invariant_simplex' <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">checked_simplex</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">checked_simplex</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="main">(</span>Simplex_State <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> checked_simplex' <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Hide implementation›</span></span>

<span class="keyword1"><span class="command">declare</span></span> init_simplex.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> assert_simplex.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> check_simplex.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> solution_simplex.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> checkpoint_simplex.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> backtrack_simplex.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Soundness lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_simplex<span class="main">:</span> <span class="quoted"><span class="quoted">"checked_simplex <span class="free">cs</span> <span class="main">{}</span> <span class="main">(</span>init_simplex <span class="free">cs</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Incremental_Simplex.init_cs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_simplex'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> assert_simplex_ok<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invariant_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> assert_simplex <span class="free">j</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="free">s'</span> <span class="main">⟹</span> invariant_simplex <span class="free">cs</span> <span class="main">(</span>insert <span class="free">j</span> <span class="free">J</span><span class="main">)</span> <span class="free">s'</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> s<span class="main">:</span> <span class="main">(</span>Simplex_State <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"invariant_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> assert_simplex <span class="free">j</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="free">s'</span> <span class="main">⟹</span> invariant_simplex <span class="free">cs</span> <span class="main">(</span>insert <span class="free">j</span> <span class="free">J</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> s invariant_simplex.simps assert_simplex' <span class="keyword1"><span class="command">using</span></span> Incremental_Simplex.assert_cs_ok<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">J</span></span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"assert_simplex' <span class="free">j</span> <span class="skolem">ss</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> assert_simplex_unsat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invariant_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> assert_simplex <span class="free">j</span> <span class="free">s</span> <span class="main">=</span> Inl <span class="free">I</span> <span class="main">⟹</span> 
     set <span class="free">I</span> <span class="main">⊆</span> insert <span class="free">j</span> <span class="free">J</span> <span class="main">∧</span> minimal_unsat_core <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="free">cs</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> s<span class="main">:</span> <span class="main">(</span>Simplex_State <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"invariant_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> assert_simplex <span class="free">j</span> <span class="free">s</span> <span class="main">=</span> Inl <span class="free">I</span> <span class="main">⟹</span> 
    set <span class="free">I</span> <span class="main">⊆</span> insert <span class="free">j</span> <span class="free">J</span> <span class="main">∧</span> minimal_unsat_core <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="free">cs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> s invariant_simplex.simps assert_simplex' 
    <span class="keyword1"><span class="command">using</span></span> Incremental_Simplex.assert_cs_unsat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">J</span></span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"assert_simplex' <span class="free">j</span> <span class="skolem">ss</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> check_simplex_ok<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invariant_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> check_simplex <span class="free">s</span> <span class="main">=</span> Inr <span class="free">s'</span> <span class="main">⟹</span> checked_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s'</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> s<span class="main">:</span> <span class="main">(</span>Simplex_State <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"invariant_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> check_simplex <span class="free">s</span> <span class="main">=</span> Inr <span class="free">s'</span> <span class="main">⟹</span> checked_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> s invariant_simplex.simps check_simplex.simps check_simplex' <span class="keyword1"><span class="command">using</span></span> Incremental_Simplex.check_cs_ok<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">J</span></span> <span class="quoted"><span class="skolem">ss</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"check_simplex' <span class="skolem">ss</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> check_simplex_unsat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invariant_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> check_simplex <span class="free">s</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span> 
     set <span class="free">I</span> <span class="main">⊆</span> <span class="free">J</span> <span class="main">∧</span> minimal_unsat_core <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="free">cs</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> s<span class="main">:</span> <span class="main">(</span>Simplex_State <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"invariant_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> check_simplex <span class="free">s</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span> 
    set <span class="free">I</span> <span class="main">⊆</span> <span class="free">J</span> <span class="main">∧</span> minimal_unsat_core <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="free">cs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> s invariant_simplex.simps check_simplex.simps check_simplex' 
    <span class="keyword1"><span class="command">using</span></span> Incremental_Simplex.check_cs_unsat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">J</span></span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"check_simplex' <span class="skolem">ss</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> solution_simplex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"checked_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> solution_simplex <span class="free">s</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">J</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Incremental_Simplex.solution_cs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">J</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> solution_simplex'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> backtrack_simplex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"checked_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span>
   checkpoint_simplex <span class="free">s</span> <span class="main">=</span> <span class="free">c</span> <span class="main">⟹</span>
   invariant_simplex <span class="free">cs</span> <span class="free">K</span> <span class="free">s'</span> <span class="main">⟹</span> 
   backtrack_simplex <span class="free">c</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">s''</span> <span class="main">⟹</span> 
   <span class="free">J</span> <span class="main">⊆</span> <span class="free">K</span> <span class="main">⟹</span> 
   invariant_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s''</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> Simplex_State <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ss'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> Simplex_State <span class="skolem">ss'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss''</span></span> <span class="keyword2"><span class="keyword">where</span></span> ss''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s''</span> <span class="main">=</span> Simplex_State <span class="skolem">ss''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s''</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cc</span></span> <span class="keyword2"><span class="keyword">where</span></span> cc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> Simplex_Checkpoint <span class="skolem">cc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"checked_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span>
   checkpoint_simplex <span class="free">s</span> <span class="main">=</span> <span class="free">c</span> <span class="main">⟹</span>
   invariant_simplex <span class="free">cs</span> <span class="free">K</span> <span class="free">s'</span> <span class="main">⟹</span> 
   backtrack_simplex <span class="free">c</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">s''</span> <span class="main">⟹</span> 
   <span class="free">J</span> <span class="main">⊆</span> <span class="free">K</span> <span class="main">⟹</span> 
   invariant_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s''</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> ss ss' ss'' cc checked_simplex.simps invariant_simplex.simps checkpoint_simplex' backtrack_simplex'
    <span class="keyword1"><span class="command">using</span></span> Incremental_Simplex.backtrack_cs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">J</span></span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quoted"><span class="skolem">cc</span></span> <span class="quoted"><span class="free">K</span></span> <span class="quoted"><span class="skolem">ss'</span></span> <span class="quoted"><span class="skolem">ss''</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> checked_invariant_simplex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"checked_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> invariant_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Incremental_Simplex.checked_invariant_cs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">J</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> checked_simplex.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> invariant_simplex.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹From this point onwards, one should not look into the types <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'i</span></span> simplex_state"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'i</span></span> simplex_checkpoint"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For convenience: an assert-all function which takes multiple indices.›</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">assert_all_simplex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> list <span class="main">⇒</span> <span class="tfree">'i</span> simplex_state <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> <span class="tfree">'i</span> simplex_state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">assert_all_simplex</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Inr <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">assert_all_simplex</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">J</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> assert_simplex <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> Unsat <span class="bound">I</span> <span class="main">⇒</span> Unsat <span class="bound">I</span> 
     <span class="main">|</span> Inr <span class="bound">s'</span> <span class="main">⇒</span> <span class="free">assert_all_simplex</span> <span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="bound">s'</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> assert_all_simplex_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"invariant_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> assert_all_simplex <span class="free">K</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="free">s'</span> <span class="main">⟹</span> 
    invariant_simplex <span class="free">cs</span> <span class="main">(</span><span class="free">J</span> <span class="main">∪</span> set <span class="free">K</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">K</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">J</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">k</span> <span class="skolem">K</span> <span class="skolem">s</span> <span class="skolem">J</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="keyword2"><span class="keyword">where</span></span> ass<span class="main">:</span> <span class="quoted"><span class="quoted">"assert_simplex <span class="skolem">k</span> <span class="skolem">s</span> <span class="main">=</span> Inr <span class="skolem">s''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"assert_all_simplex <span class="skolem">K</span> <span class="skolem">s''</span> <span class="main">=</span> Inr <span class="free">s'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assert_simplex_ok<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ass<span class="main"><span class="main">]</span></span> rec<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> assert_all_simplex_unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"invariant_simplex <span class="free">cs</span> <span class="free">J</span> <span class="free">s</span> <span class="main">⟹</span> assert_all_simplex <span class="free">K</span> <span class="free">s</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span> 
    set <span class="free">I</span> <span class="main">⊆</span> set <span class="free">K</span> <span class="main">∪</span> <span class="free">J</span> <span class="main">∧</span> minimal_unsat_core <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="free">cs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">K</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">J</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">k</span> <span class="skolem">K</span> <span class="skolem">s</span> <span class="skolem">J</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"assert_simplex <span class="skolem">k</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> unsat<span class="main">:</span> <span class="main">(</span>Inl <span class="skolem">J'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> J'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J'</span> <span class="main">=</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> assert_simplex_unsat<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> unsat<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">J'</span> <span class="main">⊆</span> insert <span class="skolem">k</span> <span class="skolem">J</span>"</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core <span class="main">(</span>set <span class="skolem">J'</span><span class="main">)</span> <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> J' i_satisfies_cs.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assert_simplex_ok<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Inr<span class="main"><span class="main">]</span></span><span class="main">]</span> Cons<span class="main">(</span>3<span class="main">)</span> Inr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The collection of soundness lemmas for the incremental simplex algorithm.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> incremental_simplex <span class="main">=</span> 
  init_simplex
  assert_simplex_ok
  assert_simplex_unsat
  assert_all_simplex_ok
  assert_all_simplex_unsat
  check_simplex_ok
  check_simplex_unsat
  solution_simplex
  backtrack_simplex
  checked_invariant_simplex

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Test Executability and Example for Incremental Interface›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="main">(</span>code<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">cs</span> <span class="main">=</span> <span class="main">[</span>
    <span class="main">(</span><span class="main">1</span> <span class="main">::</span> int<span class="main">,</span> LT <span class="main">(</span>lp_monom <span class="main">1</span> <span class="main">1</span><span class="main">)</span> <span class="numeral">4</span><span class="main">)</span><span class="main">,</span> <span class="comment1">― ‹$x_1 &lt; 4$›</span>
    <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> GTPP <span class="main">(</span>lp_monom <span class="numeral">2</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>lp_monom <span class="main">1</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="comment1">― ‹$2x_1 &gt; x_2$›</span>
    <span class="main">(</span><span class="numeral">3</span><span class="main">,</span> EQPP <span class="main">(</span>lp_monom <span class="main">1</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>lp_monom <span class="numeral">2</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="comment1">― ‹$x_1 = 2x_2$›</span>
    <span class="main">(</span><span class="numeral">4</span><span class="main">,</span> GT <span class="main">(</span>lp_monom <span class="numeral">2</span> <span class="numeral">2</span><span class="main">)</span> <span class="numeral">5</span><span class="main">)</span><span class="main">,</span> <span class="comment1">― ‹$2x_2 &gt; 5$›</span>
    <span class="main">(</span><span class="numeral">5</span><span class="main">,</span> GT <span class="main">(</span>lp_monom <span class="numeral">3</span> <span class="main">0</span><span class="main">)</span> <span class="numeral">7</span><span class="main">)</span><span class="main">,</span> <span class="comment1">― ‹$3x_0 &gt; 7$›</span>
    <span class="main">(</span><span class="numeral">6</span><span class="main">,</span> GT <span class="main">(</span>lp_monom <span class="numeral">3</span> <span class="numeral">3</span> <span class="main">+</span> lp_monom <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span> <span class="numeral">2</span><span class="main">)</span> <span class="numeral">2</span><span class="main">)</span><span class="main">]</span><span class="main">;</span> <span class="comment1">― ‹$3x_3 + 1/3x_2 &gt; 2$›</span>
    <span class="bound">s1</span> <span class="main">=</span> init_simplex <span class="bound">cs</span><span class="main">;</span> <span class="comment1">― ‹initialize›</span>
    <span class="bound">s2</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> assert_all_simplex <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span> <span class="bound">s1</span> <span class="keyword1">of</span> Inr <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">s</span> <span class="main">|</span> Unsat <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span><span class="main">;</span> <span class="comment1">― ‹assert 1,2,3›</span>
    <span class="bound">s3</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> check_simplex <span class="bound">s2</span> <span class="keyword1">of</span> Inr <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">s</span> <span class="main">|</span> Unsat <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span><span class="main">;</span> <span class="comment1">― ‹check that 1,2,3 are sat.›</span>
    <span class="bound">c123</span> <span class="main">=</span> checkpoint_simplex <span class="bound">s3</span><span class="main">;</span> <span class="comment1">― ‹after check, store checkpoint for backtracking›</span>
    <span class="bound">s4</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> assert_simplex <span class="numeral">4</span> <span class="bound">s2</span> <span class="keyword1">of</span> Inr <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">s</span> <span class="main">|</span> Unsat <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span><span class="main">;</span> <span class="comment1">― ‹assert 4›</span>
    <span class="bound">I</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> check_simplex <span class="bound">s4</span> <span class="keyword1">of</span> Unsat <span class="bound">I</span> <span class="main">⇒</span> <span class="bound">I</span> <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span><span class="main">;</span> <span class="comment1">― ‹checking detects unsat-core 1,3,4›</span>
    <span class="bound">s5</span> <span class="main">=</span> backtrack_simplex <span class="bound">c123</span> <span class="bound">s4</span><span class="main">;</span> <span class="comment1">― ‹backtrack to constraints 1,2,3›</span>
    <span class="bound">s6</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> assert_all_simplex <span class="main">[</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">6</span><span class="main">]</span> <span class="bound">s5</span> <span class="keyword1">of</span> Inr <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">s</span> <span class="main">|</span> Unsat <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span><span class="main">;</span> <span class="comment1">― ‹assert 5,6›</span>
    <span class="bound">s7</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> check_simplex <span class="bound">s6</span> <span class="keyword1">of</span> Inr <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">s</span> <span class="main">|</span> Unsat <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span><span class="main">;</span> <span class="comment1">― ‹check that 1,2,3,5,6 are sat.›</span>
    <span class="bound">sol</span> <span class="main">=</span> solution_simplex <span class="bound">s7</span> <span class="comment1">― ‹solution for 1,2,3,5,6›</span>
  <span class="keyword1">in</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="inner_quoted">''x_''</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="inner_quoted">''=''</span><span class="main">,</span> <span class="bound">sol</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">)</span> <span class="comment1">― ‹output unsat core and solution›</span>"</span></span> 
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>