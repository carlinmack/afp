<div id="AVL">
<div class="head">
<h1>Theory AVL</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      AVL Trees
    Author:     Tobias Nipkow and Cornelia Pusch,
                converted to Isar by Gerwin Klein
                contributions by Achim Brucker, Burkhart Wolff and Jan Smaus
                delete formalization and a transformation to Isar by Ondrej Kuncar
    Maintainer: Gerwin Klein &lt;gerwin.klein at nicta.com.au&gt;

    see the file Changelog for a list of changes
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"AVL Trees"</span></span>

<span class="keyword1"><span class="command">theory</span></span> AVL
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This is a monolithic formalization of AVL trees.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹AVL tree type definition›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>set_of<span class="main">:</span> <span class="tfree">'a</span><span class="main">)</span> tree <span class="main">=</span> ET <span class="main">|</span>  MKT <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants and auxiliary functions›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">height</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">height</span> ET <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">height</span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="free">height</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">height</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">avl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">avl</span> ET <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">avl</span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span>
 <span class="main">(</span><span class="main">(</span>height <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> height <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> height <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> height <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">∨</span> height <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> height <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> 
  <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> max <span class="main">(</span>height <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>height <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">avl</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">avl</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">is_ord</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>order<span class="main">)</span> tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_ord</span> ET <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_ord</span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span>
 <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">n'</span> <span class="main">∈</span> set_of <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> <span class="bound">n'</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n'</span> <span class="main">∈</span> set_of <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">is_ord</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">is_ord</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹AVL interface and implementation›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">is_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>order<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">is_in</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> ET <span class="main">=</span> False"</span></span> <span class="main">|</span>
 <span class="quoted"><span class="quoted">"<span class="free">is_in</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> True <span class="keyword1">else</span>
                           <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">is_in</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>
                           <span class="keyword1">else</span> <span class="main">(</span><span class="free">is_in</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ht</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ht</span> ET <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ht</span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="entity">mkt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mkt</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> MKT <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>max <span class="main">(</span>ht <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>ht <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mkt_bal_l</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mkt_bal_l</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> ht <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> ht <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">+</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> 
    MKT <span class="bound">ln</span> <span class="bound">ll</span> <span class="bound">lr</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> ht <span class="bound">ll</span> <span class="main">&lt;</span> ht <span class="bound">lr</span>
    <span class="keyword1">then</span> <span class="keyword1">case</span> <span class="bound">lr</span> <span class="keyword1">of</span>
      MKT <span class="bound">lrn</span> <span class="bound">lrl</span> <span class="bound">lrr</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mkt <span class="bound">lrn</span> <span class="main">(</span>mkt <span class="bound">ln</span> <span class="bound">ll</span> <span class="bound">lrl</span><span class="main">)</span> <span class="main">(</span>mkt <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">lrr</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> mkt <span class="bound">ln</span> <span class="bound">ll</span> <span class="main">(</span>mkt <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">lr</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span> mkt <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mkt_bal_r</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mkt_bal_r</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> ht <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> ht <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span>
    MKT <span class="bound">rn</span> <span class="bound">rl</span> <span class="bound">rr</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> ht <span class="bound">rl</span> <span class="main">&gt;</span> ht <span class="bound">rr</span>
    <span class="keyword1">then</span> <span class="keyword1">case</span> <span class="bound">rl</span> <span class="keyword1">of</span>
      MKT <span class="bound">rln</span> <span class="bound">rll</span> <span class="bound">rlr</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mkt <span class="bound">rln</span> <span class="main">(</span>mkt <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">rll</span><span class="main">)</span> <span class="main">(</span>mkt <span class="bound">rn</span> <span class="bound">rlr</span> <span class="bound">rr</span><span class="main">)</span>
    <span class="keyword1">else</span> mkt <span class="bound">rn</span> <span class="main">(</span>mkt <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">rl</span><span class="main">)</span> <span class="bound">rr</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span> mkt <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> ET <span class="main">=</span> MKT <span class="free"><span class="bound"><span class="entity">x</span></span></span> ET ET <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> 
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">n</span></span></span>
    <span class="keyword1">then</span> MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span>
      <span class="keyword1">then</span> mkt_bal_l <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
      <span class="keyword1">else</span> mkt_bal_r <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delete_max</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">delete_max</span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> ET <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">delete_max</span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">let</span> <span class="main">(</span><span class="bound">n'</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span> <span class="main">=</span> <span class="free">delete_max</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">in</span>
  <span class="main">(</span><span class="bound">n'</span><span class="main">,</span>mkt_bal_l <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> delete_max_induct <span class="main">=</span> delete_max.induct<span class="main">[</span><span class="operator">case_names</span> ET MKT<span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delete_root</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">delete_root</span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> ET <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">delete_root</span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> ET <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">delete_root</span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span>  
  <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">new_n</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">=</span> delete_max <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">in</span>
      mkt_bal_r <span class="bound">new_n</span> <span class="bound">l'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> delete_root_cases <span class="main">=</span> delete_root.cases<span class="main">[</span><span class="operator">case_names</span> ET_t MKT_ET MKT_MKT<span class="main">]</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> ET <span class="main">=</span> ET"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> delete_root <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> 
        <span class="keyword1">let</span> <span class="bound">l'</span> <span class="main">=</span> <span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">in</span>
        mkt_bal_r <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">l'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> 
        <span class="keyword1">let</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">in</span>
        mkt_bal_l <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">r'</span>
   <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness proof›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Insertion maintains AVL balance›</span></span>

<span class="keyword1"><span class="command">declare</span></span> Let_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"avl <span class="free">t</span> <span class="main">⟹</span> ht <span class="free">t</span> <span class="main">=</span> height <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> height_mkt_bal_l<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> height <span class="free">l</span> <span class="main">=</span> height <span class="free">r</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">;</span> avl <span class="free">l</span><span class="main">;</span> avl <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span>
   height <span class="main">(</span>mkt_bal_l <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> height <span class="free">r</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">∨</span>
   height <span class="main">(</span>mkt_bal_l <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> height <span class="free">r</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>mkt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>tree.split<span class="main">)</span>
       
<span class="keyword1"><span class="command">lemma</span></span> height_mkt_bal_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> height <span class="free">r</span> <span class="main">=</span> height <span class="free">l</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">;</span> avl <span class="free">l</span><span class="main">;</span> avl <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span>
   height <span class="main">(</span>mkt_bal_r <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> height <span class="free">l</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">∨</span>
   height <span class="main">(</span>mkt_bal_r <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> height <span class="free">l</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mkt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>tree.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"height<span class="main">(</span>mkt <span class="free">x</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>height <span class="free">l</span><span class="main">)</span> <span class="main">(</span>height <span class="free">r</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mkt_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> avl_mkt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> avl <span class="free">l</span><span class="main">;</span> avl <span class="free">r</span><span class="main">;</span>
     height <span class="free">l</span> <span class="main">=</span> height <span class="free">r</span> <span class="main">∨</span> height <span class="free">l</span> <span class="main">=</span> height <span class="free">r</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∨</span> height <span class="free">r</span> <span class="main">=</span> height <span class="free">l</span> <span class="main">+</span> <span class="main">1</span>
   <span class="main">⟧</span> <span class="main">⟹</span> avl<span class="main">(</span>mkt <span class="free">x</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>max_def mkt_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> height_mkt_bal_l2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> avl <span class="free">l</span><span class="main">;</span> avl <span class="free">r</span><span class="main">;</span> height <span class="free">l</span> <span class="main">≠</span> height <span class="free">r</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⟧</span> <span class="main">⟹</span>
   height <span class="main">(</span>mkt_bal_l <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> max <span class="main">(</span>height <span class="free">l</span><span class="main">)</span> <span class="main">(</span>height <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> height_mkt_bal_r2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> avl <span class="free">l</span><span class="main">;</span>  avl <span class="free">r</span><span class="main">;</span>  height <span class="free">r</span> <span class="main">≠</span> height <span class="free">l</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⟧</span> <span class="main">⟹</span>
   height <span class="main">(</span>mkt_bal_r <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> max <span class="main">(</span>height <span class="free">l</span><span class="main">)</span> <span class="main">(</span>height <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> avl_mkt_bal_l<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"avl <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"avl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"height <span class="free">l</span> <span class="main">=</span> height <span class="free">r</span> <span class="main">∨</span> height <span class="free">l</span> <span class="main">=</span> height <span class="free">r</span> <span class="main">+</span> <span class="main">1</span>
    <span class="main">∨</span> height <span class="free">r</span> <span class="main">=</span> height <span class="free">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∨</span> height <span class="free">l</span> <span class="main">=</span> height <span class="free">r</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"avl<span class="main">(</span>mkt_bal_l <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> ET
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mkt_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MKT <span class="skolem">ln</span> <span class="skolem">ll</span> <span class="skolem">lr</span> <span class="skolem">lh</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"height <span class="free">l</span> <span class="main">=</span> height <span class="free">r</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> True MKT assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> avl_mkt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span> <span class="operator">arith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> avl_mkt<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> avl_mkt_bal_r<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"avl <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"avl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"height <span class="free">l</span> <span class="main">=</span> height <span class="free">r</span> <span class="main">∨</span> height <span class="free">l</span> <span class="main">=</span> height <span class="free">r</span> <span class="main">+</span> <span class="main">1</span>
    <span class="main">∨</span> height <span class="free">r</span> <span class="main">=</span> height <span class="free">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∨</span> height <span class="free">r</span> <span class="main">=</span> height <span class="free">l</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"avl<span class="main">(</span>mkt_bal_r <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> ET
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mkt_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MKT <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"height <span class="free">r</span> <span class="main">=</span> height <span class="free">l</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> True MKT assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> avl_mkt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span> <span class="operator">arith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> avl_mkt<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* It apppears that these two properties need to be proved simultaneously: *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Insertion maintains the AVL property:›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> avl_insert_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"avl <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"avl<span class="main">(</span>insert <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span>height <span class="main">(</span>insert <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> height <span class="free">t</span> <span class="main">∨</span> height <span class="main">(</span>insert <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> height <span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MKT <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">with</span></span> MKT <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> MKT 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> MKT 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&lt;</span><span class="skolem">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> MKT 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>avl_mkt_bal_l <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>mkt_bal_l.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> MKT 1 <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">≠</span><span class="skolem">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>avl_mkt_bal_r <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>mkt_bal_r.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">from</span></span> 2 MKT <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> MKT 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> MKT 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
     <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&lt;</span><span class="skolem">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> MKT 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>AVL.insert <span class="free">x</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">r</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> MKT 2 <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mkt_bal_l.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> height_mkt_bal_l2<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>mkt_bal_l <span class="skolem">n</span> <span class="main">(</span>AVL.insert <span class="free">x</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">r</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
          <span class="main">|</span> <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>mkt_bal_l <span class="skolem">n</span> <span class="main">(</span>AVL.insert <span class="free">x</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">r</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> MKT 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> height_mkt_bal_l<span class="main">)</span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> a
          <span class="keyword1"><span class="command">with</span></span> 2 <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mkt_bal_l.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> b
          <span class="keyword1"><span class="command">with</span></span> True 1 MKT<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mkt_bal_l.simps<span class="main">)</span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> MKT 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>AVL.insert <span class="free">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> MKT 2 <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mkt_bal_r.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> height_mkt_bal_r2<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>mkt_bal_r <span class="skolem">n</span> <span class="skolem">l</span> <span class="main">(</span>AVL.insert <span class="free">x</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
          <span class="main">|</span> <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>mkt_bal_r <span class="skolem">n</span> <span class="skolem">l</span> <span class="main">(</span>AVL.insert <span class="free">x</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> MKT 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> height_mkt_bal_r<span class="main">)</span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> a
          <span class="keyword1"><span class="command">with</span></span> 2 <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mkt_bal_r.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> b
          <span class="keyword1"><span class="command">with</span></span> True 1 MKT<span class="main">(</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mkt_bal_r.simps<span class="main">)</span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemmas</span></span> avl_insert <span class="main">=</span> avl_insert_aux<span class="main">(</span>1<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Deletion maintains AVL balance›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> avl_delete_max<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"avl <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> ET"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"avl <span class="main">(</span>snd <span class="main">(</span>delete_max <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"height <span class="free">x</span> <span class="main">=</span> height<span class="main">(</span>snd <span class="main">(</span>delete_max <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
         height <span class="free">x</span> <span class="main">=</span> height<span class="main">(</span>snd <span class="main">(</span>delete_max <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> delete_max_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MKT <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span> <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">with</span></span> MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"avl <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"avl <span class="main">(</span>snd <span class="main">(</span>delete_max <span class="main">(</span>MKT <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 1 MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"avl <span class="main">(</span>mkt_bal_l <span class="skolem">n</span> <span class="skolem">l</span> <span class="main">(</span>snd <span class="main">(</span>delete_max <span class="main">(</span>MKT <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> avl_mkt_bal_l<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> height_mkt_bal_l height_mkt_bal_l2
      linorder_class.max.absorb1 linorder_class.max.absorb2
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>prod.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>mkt_bal_l.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MKT <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span> <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"MKT <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>delete_max <span class="var">?r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹avl <span class="free">x</span>›</span></span> MKT 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"avl <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"avl <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> MKT 2 height_mkt_bal_l<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="var"><span class="quoted"><span class="var">?r'</span></span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> height_mkt_bal_l2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="var"><span class="quoted"><span class="var">?r'</span></span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>avl.simps mkt_bal_l.simps<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> avl_delete_root<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"avl <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> ET"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"avl<span class="main">(</span>delete_root <span class="free">t</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>delete_root_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MKT_MKT <span class="skolem">n</span> <span class="skolem">ln</span> <span class="skolem">ll</span> <span class="skolem">lr</span> <span class="skolem">lh</span> <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span> <span class="skolem">h</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"MKT <span class="skolem">ln</span> <span class="skolem">ll</span> <span class="skolem">lr</span> <span class="skolem">lh</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"MKT <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>delete_max <span class="var">?l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹avl <span class="free">t</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> MKT_MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"avl <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹avl <span class="free">t</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> MKT_MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"avl <span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"avl<span class="main">(</span><span class="var">?l'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"height <span class="var">?l</span> <span class="main">=</span> height<span class="main">(</span><span class="var">?l'</span><span class="main">)</span> <span class="main">∨</span>
         height <span class="var">?l</span> <span class="main">=</span> height<span class="main">(</span><span class="var">?l'</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> avl_delete_max<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹avl <span class="free">t</span>›</span></span> MKT_MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="var">?l'</span> <span class="main">=</span> height <span class="var">?r</span> <span class="main">∨</span> height <span class="var">?l'</span> <span class="main">=</span> height <span class="var">?r</span> <span class="main">+</span> <span class="main">1</span>
            <span class="main">∨</span> height <span class="var">?r</span> <span class="main">=</span> height <span class="var">?l'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∨</span> height <span class="var">?r</span> <span class="main">=</span> height <span class="var">?l'</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹avl <span class="var">?l'</span>›</span></span> <span class="quoted"><span class="quoted">‹avl <span class="var">?r</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"avl<span class="main">(</span>mkt_bal_r <span class="main">(</span>fst<span class="main">(</span>delete_max <span class="var">?l</span><span class="main">)</span><span class="main">)</span> <span class="var">?l'</span> <span class="var">?r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> avl_mkt_bal_r<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> MKT_MKT <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>mkt_bal_r.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> height_delete_root<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"avl <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> ET"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"height <span class="free">t</span> <span class="main">=</span> height<span class="main">(</span>delete_root <span class="free">t</span><span class="main">)</span> <span class="main">∨</span> height <span class="free">t</span> <span class="main">=</span> height<span class="main">(</span>delete_root <span class="free">t</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> delete_root_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MKT_MKT <span class="skolem">n</span> <span class="skolem">ln</span> <span class="skolem">ll</span> <span class="skolem">lr</span> <span class="skolem">lh</span> <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span> <span class="skolem">h</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"MKT <span class="skolem">ln</span> <span class="skolem">ll</span> <span class="skolem">lr</span> <span class="skolem">lh</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"MKT <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>delete_max <span class="var">?l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mkt_bal_r <span class="main">(</span>fst<span class="main">(</span>delete_max <span class="var">?l</span><span class="main">)</span><span class="main">)</span> <span class="var">?l'</span> <span class="var">?r</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹avl <span class="free">t</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> MKT_MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"avl <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹avl <span class="free">t</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> MKT_MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"avl <span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"avl<span class="main">(</span><span class="var">?l'</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> avl_delete_max<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> l'_height<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="var">?l</span> <span class="main">=</span> height <span class="var">?l'</span> <span class="main">∨</span> height <span class="var">?l</span> <span class="main">=</span> height <span class="var">?l'</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹avl <span class="var">?l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> avl_delete_max<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> t_height<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="free">t</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> max <span class="main">(</span>height <span class="var">?l</span><span class="main">)</span> <span class="main">(</span>height <span class="var">?r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹avl <span class="free">t</span>›</span></span> MKT_MKT <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="free">t</span> <span class="main">=</span> height <span class="var">?t'</span> <span class="main">∨</span> height <span class="free">t</span> <span class="main">=</span> height <span class="var">?t'</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹avl <span class="free">t</span>›</span></span> MKT_MKT
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"height <span class="var">?r</span> <span class="main">=</span> height <span class="var">?l'</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> l'_height t_height False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span>  height_mkt_bal_r2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹avl <span class="var">?l'</span>›</span></span> <span class="quoted"><span class="quoted">‹avl <span class="var">?r</span>›</span></span> False<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> height_mkt_bal_r<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> True <span class="quoted"><span class="quoted">‹avl <span class="var">?l'</span>›</span></span> <span class="quoted"><span class="quoted">‹avl <span class="var">?r</span>›</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="main"><span class="main">(</span></span>delete_max <span class="var"><span class="var">?l</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> l'_height t_height True <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> l'_height t_height True <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> MKT_MKT <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>mkt_bal_r.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Deletion maintains the AVL property:›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> avl_delete_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"avl <span class="free">t</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"avl<span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"height <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>height <span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> height <span class="free">t</span> <span class="main">=</span> height <span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MKT <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">with</span></span> MKT <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> MKT 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>avl_delete_root<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> MKT 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&lt;</span><span class="skolem">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> MKT 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>avl_mkt_bal_r <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>mkt_bal_r.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> MKT 1 <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">≠</span><span class="skolem">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>avl_mkt_bal_l <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>mkt_bal_l.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">with</span></span> MKT <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>MKT <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">=</span> height<span class="main">(</span>delete_root <span class="main">(</span>MKT <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">h</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∨</span> height <span class="main">(</span>MKT <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">=</span> height<span class="main">(</span>delete_root <span class="main">(</span>MKT <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">h</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> height_delete_root<span class="main"><span class="keyword3">,</span></span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> MKT 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
     <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&lt;</span><span class="skolem">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"height <span class="skolem">r</span> <span class="main">=</span> height <span class="main">(</span>delete <span class="free">x</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> MKT 1 <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>mkt_bal_r <span class="skolem">n</span> <span class="main">(</span>delete <span class="free">x</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>delete <span class="free">x</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
          <span class="main">|</span> <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>mkt_bal_r <span class="skolem">n</span> <span class="main">(</span>delete <span class="free">x</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>delete <span class="free">x</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> MKT 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> height_mkt_bal_r<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> a
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> MKT 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> b
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> MKT 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"height <span class="skolem">l</span> <span class="main">=</span> height <span class="main">(</span>delete <span class="free">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> MKT 1 <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="skolem">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>mkt_bal_l <span class="skolem">n</span> <span class="skolem">l</span> <span class="main">(</span>delete <span class="free">x</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>delete <span class="free">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
          <span class="main">|</span> <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>mkt_bal_l <span class="skolem">n</span> <span class="skolem">l</span> <span class="main">(</span>delete <span class="free">x</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> height <span class="main">(</span>delete <span class="free">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> MKT 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> height_mkt_bal_l<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> a
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="skolem">n</span>›</span></span> MKT 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> b
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="skolem">n</span>›</span></span> MKT 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemmas</span></span> avl_delete <span class="main">=</span> avl_delete_aux<span class="main">(</span>1<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of insertion›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_of_mkt_bal_l<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> avl <span class="free">l</span><span class="main">;</span> avl <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span>
  set_of <span class="main">(</span>mkt_bal_l <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Set.insert <span class="free">n</span> <span class="main">(</span>set_of <span class="free">l</span> <span class="main">∪</span> set_of <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>tree.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_of_mkt_bal_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> avl <span class="free">l</span><span class="main">;</span> avl <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span>
  set_of <span class="main">(</span>mkt_bal_r <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Set.insert <span class="free">n</span> <span class="main">(</span>set_of <span class="free">l</span> <span class="main">∪</span> set_of <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>tree.splits<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Correctness of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> insert<span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> set_of_insert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"avl <span class="free">t</span> <span class="main">⟹</span> set_of<span class="main">(</span>insert <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Set.insert <span class="free">x</span> <span class="main">(</span>set_of <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> 
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> avl_insert set_of_mkt_bal_l set_of_mkt_bal_r <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>mkt_bal_l.simps mkt_bal_r.simps<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of deletion›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rightmost_item</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rightmost_item</span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> ET <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">rightmost_item</span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">rightmost_item</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> avl_dist<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> avl<span class="main">(</span>MKT <span class="free">n</span> <span class="free">l</span> <span class="free">r</span> <span class="free">h</span><span class="main">)</span><span class="main">;</span> is_ord<span class="main">(</span>MKT <span class="free">n</span> <span class="free">l</span> <span class="free">r</span> <span class="free">h</span><span class="main">)</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> set_of <span class="free">l</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">x</span> <span class="main">∉</span> set_of <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> avl_dist2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> avl<span class="main">(</span>MKT <span class="free">n</span> <span class="free">l</span> <span class="free">r</span> <span class="free">h</span><span class="main">)</span><span class="main">;</span> is_ord<span class="main">(</span>MKT <span class="free">n</span> <span class="free">l</span> <span class="free">r</span> <span class="free">h</span><span class="main">)</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> set_of <span class="free">l</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> set_of <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">x</span> <span class="main">≠</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ritem_in_rset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> ET <span class="main">⟹</span> rightmost_item <span class="free">r</span> <span class="main">∈</span> set_of <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rightmost_item.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ritem_greatest_in_rset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">r</span> <span class="main">≠</span> ET<span class="main">;</span> is_ord <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">x</span><span class="main">.</span>  <span class="bound">x</span> <span class="main">∈</span> set_of <span class="free">r</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">≠</span> rightmost_item <span class="free">r</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&lt;</span> rightmost_item <span class="free">r</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rightmost_item.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span> <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">x</span>"</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ord <span class="main">(</span>MKT <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> rightmost_item <span class="main">(</span>MKT <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_ord.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ritem_in_rset tree.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_of <span class="skolem">l</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">&lt;</span> rightmost_item <span class="main">(</span>MKT <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_ord.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> xt1<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ritem_not_in_ltree<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> avl<span class="main">(</span>MKT <span class="free">n</span> <span class="free">l</span> <span class="free">r</span> <span class="free">h</span><span class="main">)</span><span class="main">;</span> is_ord<span class="main">(</span>MKT <span class="free">n</span> <span class="free">l</span> <span class="free">r</span> <span class="free">h</span><span class="main">)</span><span class="main">;</span> <span class="free">r</span> <span class="main">≠</span> ET <span class="main">⟧</span> <span class="main">⟹</span>
  rightmost_item <span class="free">r</span> <span class="main">∉</span> set_of <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> avl_dist ritem_in_rset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_of_delete_max<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> avl <span class="free">t</span><span class="main">;</span> is_ord <span class="free">t</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span>ET <span class="main">⟧</span> <span class="main">⟹</span>
   set_of <span class="main">(</span>snd<span class="main">(</span>delete_max <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>set_of <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>rightmost_item <span class="free">t</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> delete_max_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MKT <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span> <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"MKT <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"avl <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"avl <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mkt_bal_l <span class="skolem">n</span> <span class="skolem">l</span> <span class="main">(</span>snd <span class="main">(</span>delete_max <span class="var">?r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"avl <span class="main">(</span>snd<span class="main">(</span>delete_max <span class="var">?r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> avl_delete_max<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> MKT ritem_not_in_ltree<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">l</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="quoted"><span class="skolem">h</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_of <span class="var">?t'</span> <span class="main">=</span> <span class="main">(</span>set_of <span class="skolem">l</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>set_of <span class="var">?r</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>rightmost_item <span class="var">?r</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>set_of_mkt_bal_l <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mkt_bal_l.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∉</span> <span class="main">{</span>rightmost_item <span class="var">?r</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> MKT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> MKT<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> avl_dist2 ritem_in_rset singletonE tree.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>insert_Diff_if <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mkt_bal_l.simps<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fst_delete_max_eq_ritem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">≠</span>ET <span class="main">⟹</span> fst<span class="main">(</span>delete_max <span class="free">t</span><span class="main">)</span> <span class="main">=</span> rightmost_item <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rightmost_item.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_of_delete_root<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> MKT <span class="free">n</span> <span class="free">l</span> <span class="free">r</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"avl <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_ord <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_of <span class="main">(</span>delete_root <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>set_of <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>delete_root_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>MKT_MKT <span class="skolem">n</span> <span class="skolem">ln</span> <span class="skolem">ll</span> <span class="skolem">lr</span> <span class="skolem">lh</span> <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span> <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mkt_bal_r <span class="main">(</span>fst <span class="main">(</span>delete_max <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>delete_max <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms MKT_MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"avl <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"avl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_ord <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≠</span>ET"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> MKT_MKT assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"avl <span class="main">(</span>snd<span class="main">(</span>delete_max <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> avl_delete_max<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_of <span class="var">?t'</span> <span class="main">=</span> <span class="main">(</span>set_of <span class="free">l</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>set_of <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Set.insert_Diff ritem_in_rset fst_delete_max_eq_ritem  
       set_of_delete_max set_of_mkt_bal_r  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mkt_bal_r.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> MKT_MKT assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_of <span class="main">(</span>delete_root <span class="free">t</span><span class="main">)</span> <span class="main">=</span> set_of <span class="var">?t'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>prod.split <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>mkt_bal_r.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> MKT_MKT assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set_of <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> set_of <span class="free">l</span> <span class="main">∪</span> set_of <span class="free">r</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_insert_absorb UnE avl_dist2 tree.set<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tree.inject<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> MKT_MKT assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> delete_root.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Correctness of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> delete<span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> set_of_delete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> avl <span class="free">t</span><span class="main">;</span> is_ord <span class="free">t</span> <span class="main">⟧</span> <span class="main">⟹</span> set_of <span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>set_of <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MKT <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> MKT set_of_delete_root<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"MKT <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">h</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> MKT <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&lt;</span><span class="skolem">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> True MKT  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> avl_delete set_of_mkt_bal_r<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>delete <span class="free">x</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>mkt_bal_r.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> False MKT <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">≠</span><span class="skolem">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> avl_delete set_of_mkt_bal_l<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>delete <span class="free">x</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>mkt_bal_l.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of lookup›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> is_in_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ord <span class="free">t</span> <span class="main">⟹</span> is_in <span class="free">k</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">k</span> <span class="main">:</span> set_of <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Insertion maintains order›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_ord_mkt_bal_l<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_ord<span class="main">(</span>MKT <span class="free">n</span> <span class="free">l</span> <span class="free">r</span> <span class="free">h</span><span class="main">)</span> <span class="main">⟹</span> is_ord <span class="main">(</span>mkt_bal_l <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>tree.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_less_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ord_mkt_bal_r<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ord<span class="main">(</span>MKT <span class="free">n</span> <span class="free">l</span> <span class="free">r</span> <span class="free">h</span><span class="main">)</span> <span class="main">⟹</span> is_ord <span class="main">(</span>mkt_bal_r <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>tree.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_less_trans<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If the order is linear, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> insert<span class="antiquote"><span class="antiquote">}</span></span></span></span> maintains the order:›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> is_ord_insert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> avl <span class="free">t</span><span class="main">;</span> is_ord <span class="free">t</span> <span class="main">⟧</span> <span class="main">⟹</span> is_ord<span class="main">(</span>insert <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_ord_mkt_bal_l is_ord_mkt_bal_r avl_insert set_of_insert
                linorder_not_less order_neq_le_trans <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>mkt_bal_l.simps mkt_bal_r.simps<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Deletion maintains order›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_ord_delete_max<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> avl <span class="free">t</span><span class="main">;</span> is_ord <span class="free">t</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span>ET <span class="main">⟧</span> <span class="main">⟹</span> is_ord<span class="main">(</span>snd<span class="main">(</span>delete_max <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>delete_max_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>MKT <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span> <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"MKT <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd<span class="main">(</span>delete_max <span class="var">?r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span><span class="main">.</span> is_ord<span class="main">(</span>MKT <span class="skolem">n</span> <span class="skolem">l</span> <span class="var">?r'</span> <span class="bound">h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_of_delete_max<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"avl<span class="main">(</span><span class="var">?r'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> avl_delete_max<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> MKT is_ord_mkt_bal_l<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">l</span></span> <span class="var"><span class="quoted"><span class="var">?r'</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>is_ord.simps mkt_bal_l.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ord_delete_root<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"avl <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_ord <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> ET"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_ord <span class="main">(</span>delete_root <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>delete_root_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>MKT_MKT <span class="skolem">n</span> <span class="skolem">ln</span> <span class="skolem">ll</span> <span class="skolem">lr</span> <span class="skolem">lh</span> <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span> <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"MKT <span class="skolem">ln</span> <span class="skolem">ll</span> <span class="skolem">lr</span> <span class="skolem">lh</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"MKT <span class="skolem">rn</span> <span class="skolem">rl</span> <span class="skolem">rr</span> <span class="skolem">rh</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>delete_max <span class="var">?l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>delete_max <span class="var">?l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms MKT_MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span><span class="main">.</span> is_ord<span class="main">(</span>MKT <span class="var">?n'</span> <span class="var">?l'</span> <span class="var">?r</span> <span class="bound">h</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms MKT_MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ord <span class="var">?l'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ord_delete_max<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms MKT_MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ord <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms MKT_MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_of <span class="var">?r</span> <span class="main">⟶</span> <span class="var">?n'</span> <span class="main">&lt;</span> <span class="bound">x</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_delete_max_eq_ritem is_ord.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> order_less_trans ritem_in_rset 
          tree.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms MKT_MKT ritem_greatest_in_rset <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_of <span class="var">?l'</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="var">?n'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff avl.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fst_delete_max_eq_ritem is_ord.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
          set_of_delete_max singleton_iff tree.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms MKT_MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"avl <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms MKT_MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"avl <span class="var">?l'</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> avl_delete_max<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> MKT_MKT is_ord_mkt_bal_r<span class="main">[</span><span class="operator">of</span>  <span class="var"><span class="quoted"><span class="var">?n'</span></span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>mkt_bal_r.simps is_ord.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If the order is linear, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> delete<span class="antiquote"><span class="antiquote">}</span></span></span></span> maintains the order:›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> is_ord_delete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> avl <span class="free">t</span><span class="main">;</span> is_ord <span class="free">t</span> <span class="main">⟧</span> <span class="main">⟹</span> is_ord <span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MKT <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> MKT is_ord_delete_root<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"MKT <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">h</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> MKT <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&lt;</span><span class="skolem">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> True MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span><span class="main">.</span> is_ord <span class="main">(</span>MKT <span class="skolem">n</span> <span class="main">(</span>delete <span class="free">x</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">r</span> <span class="bound">h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>set_of_delete<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True MKT is_ord_mkt_bal_r<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>delete <span class="free">x</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> avl_delete<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> False MKT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span><span class="main">.</span> is_ord <span class="main">(</span>MKT <span class="skolem">n</span> <span class="skolem">l</span> <span class="main">(</span>delete <span class="free">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>set_of_delete<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> False MKT is_ord_mkt_bal_l<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>delete <span class="free">x</span> <span class="skolem">r</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span><span class="main">≠</span><span class="skolem">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> avl_delete<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="AVL2">
<div class="head">
<h1>Theory AVL2</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      AVL Trees

    Author:     Tobias Nipkow and Cornelia Pusch,
                converted to Isar by Gerwin Klein
                contributions by Achim Brucker, Burkhart Wolff and Jan Smaus
    Maintainer: Gerwin Klein &lt;gerwin.klein at nicta.com.au&gt;

    see the file Changelog for a list of changes
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹AVL Trees in 2 Stages›</span></span>

<span class="keyword1"><span class="command">theory</span></span> AVL2
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This development of AVL trees leads to the same implementation
  as the monolithic one (in theorey AVL) but via an intermediate
  abstraction: AVL trees where the height is recomputed rather than
  stored in the tree. This two-stage devlopment is longer than the
  monolithic one but each individual step is simpler. It should really
  be viewed as a blueprint for the development of data structures where
  some of the fields contain redundant information (for efficiency
  reasons).
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Step 1: Pure binary and AVL trees›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The basic formulation of AVL trees builds on pure binary trees
  and recomputes all height information whenever it is required. This
  simplifies the correctness proofs.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>set_of<span class="main">:</span> <span class="tfree">'a</span><span class="main">)</span> tree<span class="hidden">⇩</span><sub>0</sub> <span class="main">=</span> ET<span class="hidden">⇩</span><sub>0</sub> <span class="main">|</span>  MKT<span class="hidden">⇩</span><sub>0</sub> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree<span class="hidden">⇩</span><sub>0</sub>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree<span class="hidden">⇩</span><sub>0</sub>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary functions›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">height</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree<span class="hidden">⇩</span><sub>0</sub> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">height</span> ET<span class="hidden">⇩</span><sub>0</sub> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">height</span> <span class="main">(</span>MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> max <span class="main">(</span><span class="free">height</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">height</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">is_ord</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> tree<span class="hidden">⇩</span><sub>0</sub> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_ord</span> ET<span class="hidden">⇩</span><sub>0</sub> <span class="main">=</span> True"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_ord</span> <span class="main">(</span>MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">n'</span><span class="main">∈</span> set_of <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> <span class="bound">n'</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n'</span><span class="main">∈</span> set_of <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">is_ord</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">is_ord</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">is_bal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree<span class="hidden">⇩</span><sub>0</sub> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_bal</span> ET<span class="hidden">⇩</span><sub>0</sub> <span class="main">=</span> True"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_bal</span> <span class="main">(</span>MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">(</span>height <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> height <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> height <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">1</span><span class="main">+</span>height <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> height <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">1</span><span class="main">+</span>height <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">∧</span>
     <span class="free">is_bal</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">is_bal</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹AVL interface and simple implementation›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">is_in<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree<span class="hidden">⇩</span><sub>0</sub> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_in<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> ET<span class="hidden">⇩</span><sub>0</sub> <span class="main">=</span> False"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_in<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> True <span class="keyword1">else</span>
                         <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">is_in<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>
                         <span class="keyword1">else</span> <span class="main">(</span><span class="free">is_in<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">l_bal<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree<span class="hidden">⇩</span><sub>0</sub> <span class="main">⇒</span> <span class="tfree">'a</span> tree<span class="hidden">⇩</span><sub>0</sub> <span class="main">⇒</span> <span class="tfree">'a</span> tree<span class="hidden">⇩</span><sub>0</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l_bal<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">ln</span></span></span> <span class="free"><span class="bound"><span class="entity">ll</span></span></span> <span class="free"><span class="bound"><span class="entity">lr</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> height <span class="free"><span class="bound"><span class="entity">ll</span></span></span> <span class="main">&lt;</span> height <span class="free"><span class="bound"><span class="entity">lr</span></span></span>
    <span class="keyword1">then</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">lr</span></span></span> <span class="keyword1">of</span> ET<span class="hidden">⇩</span><sub>0</sub> <span class="main">⇒</span> ET<span class="hidden">⇩</span><sub>0</sub> <span class="comment1">― ‹impossible›</span>
                  <span class="main">|</span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="bound">lrn</span> <span class="bound">lrl</span> <span class="bound">lrr</span> <span class="main">⇒</span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="bound">lrn</span> <span class="main">(</span>MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">ln</span></span></span> <span class="free"><span class="bound"><span class="entity">ll</span></span></span> <span class="bound">lrl</span><span class="main">)</span> <span class="main">(</span>MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">lrr</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">ln</span></span></span> <span class="free"><span class="bound"><span class="entity">ll</span></span></span> <span class="main">(</span>MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">lr</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">r_bal<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree<span class="hidden">⇩</span><sub>0</sub> <span class="main">⇒</span> <span class="tfree">'a</span> tree<span class="hidden">⇩</span><sub>0</sub> <span class="main">⇒</span> <span class="tfree">'a</span> tree<span class="hidden">⇩</span><sub>0</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_bal<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">rn</span></span></span> <span class="free"><span class="bound"><span class="entity">rl</span></span></span> <span class="free"><span class="bound"><span class="entity">rr</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> height <span class="free"><span class="bound"><span class="entity">rl</span></span></span> <span class="main">&gt;</span> height <span class="free"><span class="bound"><span class="entity">rr</span></span></span>
    <span class="keyword1">then</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">rl</span></span></span> <span class="keyword1">of</span> ET<span class="hidden">⇩</span><sub>0</sub> <span class="main">⇒</span> ET<span class="hidden">⇩</span><sub>0</sub> <span class="comment1">― ‹impossible›</span>
                  <span class="main">|</span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="bound">rln</span> <span class="bound">rll</span> <span class="bound">rlr</span> <span class="main">⇒</span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="bound">rln</span> <span class="main">(</span>MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">rll</span><span class="main">)</span> <span class="main">(</span>MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">rn</span></span></span> <span class="bound">rlr</span> <span class="free"><span class="bound"><span class="entity">rr</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">rn</span></span></span> <span class="main">(</span>MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">rl</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rr</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">insrt<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>preorder <span class="main">⇒</span> <span class="tfree">'a</span> tree<span class="hidden">⇩</span><sub>0</sub> <span class="main">⇒</span> <span class="tfree">'a</span> tree<span class="hidden">⇩</span><sub>0</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insrt<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> ET<span class="hidden">⇩</span><sub>0</sub> <span class="main">=</span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">x</span></span></span> ET<span class="hidden">⇩</span><sub>0</sub> ET<span class="hidden">⇩</span><sub>0</sub>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insrt<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">n</span></span></span>
      <span class="keyword1">then</span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span>
           <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">l'</span> <span class="main">=</span> <span class="free">insrt<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>
                <span class="keyword1">in</span> <span class="keyword1">if</span> height <span class="bound">l'</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">+</span>height <span class="free"><span class="bound"><span class="entity">r</span></span></span>
                   <span class="keyword1">then</span> l_bal<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">l'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
                   <span class="keyword1">else</span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">l'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
           <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free">insrt<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
                <span class="keyword1">in</span> <span class="keyword1">if</span> height <span class="bound">r'</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">+</span>height <span class="free"><span class="bound"><span class="entity">l</span></span></span>
                   <span class="keyword1">then</span> r_bal<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">r'</span>
                   <span class="keyword1">else</span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">r'</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Insertion maintains AVL balance›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> height_l_bal<span class="main">:</span>
 <span class="quoted"><span class="quoted">"height <span class="free">l</span> <span class="main">=</span> height <span class="free">r</span> <span class="main">+</span> <span class="numeral">2</span>
  <span class="main">⟹</span> height <span class="main">(</span>l_bal<span class="hidden">⇩</span><sub>0</sub> <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> height <span class="free">r</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">∨</span>
      height <span class="main">(</span>l_bal<span class="hidden">⇩</span><sub>0</sub> <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>  <span class="main">=</span> height <span class="free">r</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree<span class="hidden">⇩</span><sub>0</sub>.split if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> height_r_bal<span class="main">:</span>
 <span class="quoted"><span class="quoted">"height <span class="free">r</span> <span class="main">=</span> height <span class="free">l</span> <span class="main">+</span> <span class="numeral">2</span>
  <span class="main">⟹</span> height <span class="main">(</span>r_bal<span class="hidden">⇩</span><sub>0</sub> <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> height <span class="free">l</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">∨</span>
      height <span class="main">(</span>r_bal<span class="hidden">⇩</span><sub>0</sub> <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> height <span class="free">l</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree<span class="hidden">⇩</span><sub>0</sub>.split if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> height_insrt<span class="main">:</span>
 <span class="quoted"><span class="quoted">"is_bal <span class="free">t</span>
  <span class="main">⟹</span> height <span class="main">(</span>insrt<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> height <span class="free">t</span> <span class="main">∨</span> height <span class="main">(</span>insrt<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> height <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> ET<span class="hidden">⇩</span><sub>0</sub> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MKT<span class="hidden">⇩</span><sub>0</sub> <span class="skolem">n</span> <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>insrt<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">t2</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> height_l_bal <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>l_bal<span class="hidden">⇩</span><sub>0</sub> <span class="skolem">n</span> <span class="main">(</span>insrt<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="skolem">t1</span><span class="main">)</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span>
        height <span class="skolem">t2</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">∨</span> height <span class="main">(</span>l_bal<span class="hidden">⇩</span><sub>0</sub> <span class="skolem">n</span> <span class="main">(</span>insrt<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="skolem">t1</span><span class="main">)</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">t2</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>insrt<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">t1</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> height_r_bal <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>r_bal<span class="hidden">⇩</span><sub>0</sub> <span class="skolem">n</span> <span class="skolem">t1</span> <span class="main">(</span>insrt<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">t1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">∨</span>
        height <span class="main">(</span>r_bal<span class="hidden">⇩</span><sub>0</sub> <span class="skolem">n</span> <span class="skolem">t1</span> <span class="main">(</span>insrt<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">t1</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_bal_l_bal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_bal <span class="free">l</span> <span class="main">⟹</span> is_bal <span class="free">r</span> <span class="main">⟹</span> height <span class="free">l</span> <span class="main">=</span> height <span class="free">r</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⟹</span> is_bal <span class="main">(</span>l_bal<span class="hidden">⇩</span><sub>0</sub> <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree<span class="hidden">⇩</span><sub>0</sub>.split<span class="main">)</span>  <span class="comment1">― ‹separating the two auto's is just for speed›</span>

<span class="keyword1"><span class="command">lemma</span></span> is_bal_r_bal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_bal <span class="free">l</span> <span class="main">⟹</span> is_bal <span class="free">r</span> <span class="main">⟹</span> height <span class="free">r</span> <span class="main">=</span> height <span class="free">l</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⟹</span> is_bal <span class="main">(</span>r_bal<span class="hidden">⇩</span><sub>0</sub> <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree<span class="hidden">⇩</span><sub>0</sub>.split<span class="main">)</span>  <span class="comment1">― ‹separating the two auto's is just for speed›</span>

<span class="keyword1"><span class="command">theorem</span></span> is_bal_insrt<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"is_bal <span class="free">t</span> <span class="main">⟹</span> is_bal<span class="main">(</span>insrt<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> ET<span class="hidden">⇩</span><sub>0</sub> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MKT<span class="hidden">⇩</span><sub>0</sub> <span class="skolem">n</span> <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>insrt<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">t2</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_bal_l_bal<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> height_insrt <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"height <span class="main">(</span>insrt<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> height <span class="skolem">t1</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_bal_r_bal<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> height_insrt <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t2</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of insertion›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_of_l_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="free">l</span> <span class="main">=</span> height <span class="free">r</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⟹</span>
  set_of <span class="main">(</span>l_bal<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span>set_of <span class="free">l</span> <span class="main">∪</span> set_of <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree<span class="hidden">⇩</span><sub>0</sub>.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_of_r_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="free">r</span> <span class="main">=</span> height <span class="free">l</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⟹</span>
  set_of <span class="main">(</span>r_bal<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span>set_of <span class="free">l</span> <span class="main">∪</span> set_of <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree<span class="hidden">⇩</span><sub>0</sub>.splits<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> set_of_insrt<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"set_of <span class="main">(</span>insrt<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span>set_of <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>set_of_l_bal set_of_r_bal Let_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of lookup›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> is_in_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ord <span class="free">t</span> <span class="main">⟹</span> is_in<span class="hidden">⇩</span><sub>0</sub> <span class="free">k</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">k</span> <span class="main">:</span> set_of <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_le_not_le<span class="main">)</span>
  

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Insertion maintains order›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_ord_l_bal<span class="main">:</span>
 <span class="quoted"><span class="quoted">"is_ord <span class="main">(</span>MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> height <span class="free">l</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">(</span>height <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  is_ord <span class="main">(</span>l_bal<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree<span class="hidden">⇩</span><sub>0</sub>.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_less_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_ord_r_bal<span class="main">:</span>
 <span class="quoted"><span class="quoted">"is_ord <span class="main">(</span>MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> height <span class="free">r</span> <span class="main">=</span> height <span class="free">l</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⟹</span>
  is_ord <span class="main">(</span>r_bal<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>tree<span class="hidden">⇩</span><sub>0</sub>.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_less_trans<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the order is linear, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> insrt<span class="hidden">⇩</span><sub>0</sub><span class="antiquote"><span class="antiquote">}</span></span></span></span> maintains the order:›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> is_ord_insrt<span class="main">:</span>
 <span class="quoted"><span class="quoted">"is_ord <span class="free">t</span> <span class="main">⟹</span> is_ord <span class="main">(</span>insrt<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_ord_l_bal is_ord_r_bal set_of_insrt
    linorder_not_less order_neq_le_trans Let_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Step 2: Binary and AVL trees with height information›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> tree <span class="main">=</span> ET <span class="main">|</span>  MKT <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span> <span class="quoted">nat</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary functions›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">erase</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree<span class="hidden">⇩</span><sub>0</sub>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">erase</span> ET <span class="main">=</span> ET<span class="hidden">⇩</span><sub>0</sub>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">erase</span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">erase</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">erase</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">hinv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hinv</span> ET <span class="main">⟷</span> True"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">hinv</span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> max <span class="main">(</span>height <span class="main">(</span>erase <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>height <span class="main">(</span>erase <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>
                        <span class="main">∧</span> <span class="free">hinv</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">hinv</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">avl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">avl</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> is_bal <span class="main">(</span>erase <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∧</span> hinv <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹AVL interface and efficient implementation›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">is_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_in</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> ET <span class="main">⟷</span> False"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_in</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> True <span class="keyword1">else</span>
                            <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">is_in</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>
                            <span class="keyword1">else</span> <span class="main">(</span><span class="free">is_in</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ht</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ht</span> ET <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ht</span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mkt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mkt</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> MKT <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>max <span class="main">(</span>ht <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>ht <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">l_bal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l_bal</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">ln</span></span></span> <span class="free"><span class="bound"><span class="entity">ll</span></span></span> <span class="free"><span class="bound"><span class="entity">lr</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> ht <span class="free"><span class="bound"><span class="entity">ll</span></span></span> <span class="main">&lt;</span> ht <span class="free"><span class="bound"><span class="entity">lr</span></span></span>
    <span class="keyword1">then</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">lr</span></span></span> <span class="keyword1">of</span> ET <span class="main">⇒</span> ET <span class="comment1">― ‹impossible›</span>
                  <span class="main">|</span> MKT <span class="bound">lrn</span> <span class="bound">lrl</span> <span class="bound">lrr</span> <span class="bound">lrh</span> <span class="main">⇒</span>
                    mkt <span class="bound">lrn</span> <span class="main">(</span>mkt <span class="free"><span class="bound"><span class="entity">ln</span></span></span> <span class="free"><span class="bound"><span class="entity">ll</span></span></span> <span class="bound">lrl</span><span class="main">)</span> <span class="main">(</span>mkt <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">lrr</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> mkt <span class="free"><span class="bound"><span class="entity">ln</span></span></span> <span class="free"><span class="bound"><span class="entity">ll</span></span></span> <span class="main">(</span>mkt <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">lr</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">r_bal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">r_bal</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">rn</span></span></span> <span class="free"><span class="bound"><span class="entity">rl</span></span></span> <span class="free"><span class="bound"><span class="entity">rr</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> ht <span class="free"><span class="bound"><span class="entity">rl</span></span></span> <span class="main">&gt;</span> ht <span class="free"><span class="bound"><span class="entity">rr</span></span></span>
    <span class="keyword1">then</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">rl</span></span></span> <span class="keyword1">of</span> ET <span class="main">⇒</span> ET <span class="comment1">― ‹impossible›</span>
                  <span class="main">|</span> MKT <span class="bound">rln</span> <span class="bound">rll</span> <span class="bound">rlr</span> <span class="bound">h</span> <span class="main">⇒</span> mkt <span class="bound">rln</span> <span class="main">(</span>mkt <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">rll</span><span class="main">)</span> <span class="main">(</span>mkt <span class="free"><span class="bound"><span class="entity">rn</span></span></span> <span class="bound">rlr</span> <span class="free"><span class="bound"><span class="entity">rr</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> mkt <span class="free"><span class="bound"><span class="entity">rn</span></span></span> <span class="main">(</span>mkt <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">rl</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rr</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">insrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>preorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insrt</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> ET <span class="main">=</span> MKT <span class="free"><span class="bound"><span class="entity">x</span></span></span> ET ET <span class="main">1</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insrt</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">n</span></span></span>
      <span class="keyword1">then</span> MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span>
           <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">l'</span> <span class="main">=</span> <span class="free">insrt</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span> <span class="bound">hl'</span> <span class="main">=</span> ht <span class="bound">l'</span><span class="main">;</span> <span class="bound">hr</span> <span class="main">=</span> ht <span class="free"><span class="bound"><span class="entity">r</span></span></span>
                <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">hl'</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">+</span><span class="bound">hr</span> <span class="keyword1">then</span> l_bal <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">l'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
                   <span class="keyword1">else</span> MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">l'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> max <span class="bound">hl'</span> <span class="bound">hr</span><span class="main">)</span>
           <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free">insrt</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span> <span class="bound">hl</span> <span class="main">=</span> ht <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span> <span class="bound">hr'</span> <span class="main">=</span> ht <span class="bound">r'</span>
                <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">hr'</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">+</span><span class="bound">hl</span> <span class="keyword1">then</span> r_bal <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">r'</span>
                   <span class="keyword1">else</span> MKT <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">r'</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> max <span class="bound">hl</span> <span class="bound">hr'</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness proof›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The auxiliary functions are implemented correctly:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> height_hinv<span class="main">:</span> <span class="quoted"><span class="quoted">"hinv <span class="free">t</span> <span class="main">⟹</span> ht <span class="free">t</span> <span class="main">=</span> height <span class="main">(</span>erase <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> erase_mkt<span class="main">:</span> <span class="quoted"><span class="quoted">"erase <span class="main">(</span>mkt <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> MKT<span class="hidden">⇩</span><sub>0</sub> <span class="free">n</span> <span class="main">(</span>erase <span class="free">l</span><span class="main">)</span> <span class="main">(</span>erase <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mkt_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> erase_l_bal<span class="main">:</span>
 <span class="quoted"><span class="quoted">"hinv <span class="free">l</span> <span class="main">⟹</span> hinv <span class="free">r</span> <span class="main">⟹</span> height <span class="main">(</span>erase <span class="free">l</span><span class="main">)</span> <span class="main">=</span> height<span class="main">(</span>erase <span class="free">r</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⟹</span>
  erase <span class="main">(</span>l_bal <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> l_bal<span class="hidden">⇩</span><sub>0</sub> <span class="free">n</span> <span class="main">(</span>erase <span class="free">l</span><span class="main">)</span> <span class="main">(</span>erase <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> height_hinv erase_mkt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> erase_r_bal<span class="main">:</span>
 <span class="quoted"><span class="quoted">"hinv <span class="free">l</span> <span class="main">⟹</span> hinv <span class="free">r</span> <span class="main">⟹</span> height<span class="main">(</span>erase <span class="free">r</span><span class="main">)</span> <span class="main">=</span> height<span class="main">(</span>erase <span class="free">l</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⟹</span>
  erase <span class="main">(</span>r_bal <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> r_bal<span class="hidden">⇩</span><sub>0</sub> <span class="free">n</span> <span class="main">(</span>erase <span class="free">l</span><span class="main">)</span> <span class="main">(</span>erase <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> height_hinv erase_mkt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> insrt<span class="antiquote"><span class="antiquote">}</span></span></span></span> maintains the invariant:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hinv_mkt<span class="main">:</span> <span class="quoted"><span class="quoted">"hinv <span class="free">l</span> <span class="main">⟹</span> hinv <span class="free">r</span> <span class="main">⟹</span> hinv <span class="main">(</span>mkt <span class="free">x</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> height_hinv mkt_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hinv_l_bal<span class="main">:</span>
 <span class="quoted"><span class="quoted">"hinv <span class="free">l</span> <span class="main">⟹</span> hinv <span class="free">r</span> <span class="main">⟹</span> height<span class="main">(</span>erase <span class="free">l</span><span class="main">)</span> <span class="main">=</span> height<span class="main">(</span>erase <span class="free">r</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⟹</span>
  hinv <span class="main">(</span>l_bal <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hinv_mkt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hinv_r_bal<span class="main">:</span>
 <span class="quoted"><span class="quoted">"hinv <span class="free">l</span> <span class="main">⟹</span> hinv <span class="free">r</span> <span class="main">⟹</span> height<span class="main">(</span>erase <span class="free">r</span><span class="main">)</span> <span class="main">=</span> height<span class="main">(</span>erase <span class="free">l</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">⟹</span>
  hinv <span class="main">(</span>r_bal <span class="free">n</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hinv_mkt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> hinv_insrt<span class="main">:</span> <span class="quoted"><span class="quoted">"hinv <span class="free">t</span> <span class="main">⟹</span> hinv <span class="main">(</span>insrt <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def height_hinv hinv_l_bal hinv_r_bal<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> insrt<span class="antiquote"><span class="antiquote">}</span></span></span></span> implements <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> insrt<span class="hidden">⇩</span><sub>0</sub><span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> erase_insrt<span class="main">:</span> <span class="quoted"><span class="quoted">"hinv <span class="free">t</span> <span class="main">⟹</span> erase <span class="main">(</span>insrt <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> insrt<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="main">(</span>erase <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def hinv_insrt height_hinv erase_l_bal erase_r_bal<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> insrt<span class="antiquote"><span class="antiquote">}</span></span></span></span> meets its spec:›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="quoted"><span class="quoted">"avl <span class="free">t</span> <span class="main">⟹</span> set_of <span class="main">(</span>erase <span class="main">(</span>insrt <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span>set_of <span class="main">(</span>erase <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> avl_def erase_insrt set_of_insrt<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> insrt<span class="antiquote"><span class="antiquote">}</span></span></span></span> preserves the invariants:›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="quoted"><span class="quoted">"avl <span class="free">t</span> <span class="main">⟹</span> avl <span class="main">(</span>insrt <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hinv_insrt avl_def erase_insrt is_bal_insrt<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span>
  <span class="quoted"><span class="quoted">"avl <span class="free">t</span> <span class="main">⟹</span> is_ord <span class="main">(</span>erase <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> is_ord <span class="main">(</span>erase <span class="main">(</span>insrt <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> avl_def erase_insrt is_ord_insrt<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> is_in<span class="antiquote"><span class="antiquote">}</span></span></span></span> implements <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> is_in<span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> is_in<span class="main">:</span> <span class="quoted"><span class="quoted">"is_in <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> is_in<span class="hidden">⇩</span><sub>0</sub> <span class="free">x</span> <span class="main">(</span>erase <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> is_in<span class="antiquote"><span class="antiquote">}</span></span></span></span> meets its spec:›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="quoted"><span class="quoted">"is_ord <span class="main">(</span>erase <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> is_in <span class="free">x</span> <span class="free">t</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> set_of <span class="main">(</span>erase <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_in is_in_correct<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>