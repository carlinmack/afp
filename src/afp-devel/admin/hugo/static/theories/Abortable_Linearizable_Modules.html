<div id="Sequences">
<div class="head">
<h1>Theory Sequences</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Sequences as Lists›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Sequences
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> Sequences 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We reverse the order of application of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(#)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(@)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> because it we think that it is easier to think of sequences as growing 
  to the right.›</span></span>
<span class="keyword1"><span class="command">no_notation</span></span> Cons <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">#</span>"</span> 65<span class="main">)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Append</span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">#</span>"</span> 65<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Append</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> Cons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="keyword1"><span class="command">no_notation</span></span> append <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">@</span>"</span> 65<span class="main">)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Concat</span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">@</span>"</span> 65<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Concat</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span> append <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IOA">
<div class="head">
<h1>Theory IOA</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹I/O Automata with Finite-Trace Semantics›</span></span>

<span class="keyword1"><span class="command">theory</span></span> IOA
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Sequences.html">Sequences</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory is inspired and draws material from the IOA theory of Nipkow and Müller›</span></span>

<span class="keyword1"><span class="command">locale</span></span> IOA <span class="main">=</span> Sequences

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'a</span> signature <span class="main">=</span>
  inputs<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  outputs<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  internals<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>

<span class="keyword1"><span class="command">context</span></span> IOA
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Signatures›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">actions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> signature <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">actions</span> <span class="free"><span class="bound"><span class="entity">asig</span></span></span> <span class="main">≡</span> inputs <span class="free"><span class="bound"><span class="entity">asig</span></span></span> <span class="main">∪</span> outputs <span class="free"><span class="bound"><span class="entity">asig</span></span></span> <span class="main">∪</span> internals <span class="free"><span class="bound"><span class="entity">asig</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">externals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> signature <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">externals</span> <span class="free"><span class="bound"><span class="entity">asig</span></span></span> <span class="main">≡</span> inputs <span class="free"><span class="bound"><span class="entity">asig</span></span></span> <span class="main">∪</span> outputs <span class="free"><span class="bound"><span class="entity">asig</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> signature <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">locals</span> <span class="free"><span class="bound"><span class="entity">asig</span></span></span> <span class="main">≡</span> internals <span class="free"><span class="bound"><span class="entity">asig</span></span></span> <span class="main">∪</span> outputs <span class="free"><span class="bound"><span class="entity">asig</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_asig</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> signature <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_asig</span> <span class="free"><span class="bound"><span class="entity">triple</span></span></span> <span class="main">≡</span>
     inputs <span class="free"><span class="bound"><span class="entity">triple</span></span></span> <span class="main">∩</span> outputs <span class="free"><span class="bound"><span class="entity">triple</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span>
     outputs <span class="free"><span class="bound"><span class="entity">triple</span></span></span> <span class="main">∩</span> internals <span class="free"><span class="bound"><span class="entity">triple</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span>
     inputs <span class="free"><span class="bound"><span class="entity">triple</span></span></span> <span class="main">∩</span> internals <span class="free"><span class="bound"><span class="entity">triple</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> internal_inter_external<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_asig <span class="free">sig</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"internals <span class="free">sig</span> <span class="main">∩</span> externals <span class="free">sig</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>internals_def externals_def is_asig_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hide_asig</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hide_asig</span> <span class="free"><span class="bound"><span class="entity">asig</span></span></span> <span class="free"><span class="bound"><span class="entity">actns</span></span></span> <span class="main">≡</span>
    <span class="main">⦇</span>inputs <span class="main">=</span> inputs <span class="free"><span class="bound"><span class="entity">asig</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">actns</span></span></span><span class="main">,</span> outputs <span class="main">=</span> outputs <span class="free"><span class="bound"><span class="entity">asig</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">actns</span></span></span><span class="main">,</span> 
      internals <span class="main">=</span> internals <span class="free"><span class="bound"><span class="entity">asig</span></span></span> <span class="main">∪</span><span class="free"><span class="bound"><span class="entity">actns</span></span></span><span class="main">⦈</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹I/O Automata›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> transition <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'s</span>"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> ioa <span class="main">=</span> 
  asig<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> signature"</span></span>
  start<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>
  trans<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>transition set"</span></span>

<span class="keyword1"><span class="command">context</span></span> IOA 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">act</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> actions <span class="main">(</span>asig <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">ext</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> externals <span class="main">(</span>asig <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">int</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">int</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> internals <span class="main">(</span>asig <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">inp</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> inputs <span class="main">(</span>asig <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> outputs <span class="main">(</span>asig <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">local</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> locals <span class="main">(</span>asig <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_ioa</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> ioa <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_ioa</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> is_asig <span class="main">(</span>asig <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">triple</span>  <span class="main">∈</span> trans <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">.</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="bound">triple</span> <span class="main">∈</span> act <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hide</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hide</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">actns</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦇</span>asig <span class="main">:=</span> hide_asig <span class="main">(</span>asig <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">actns</span></span></span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_trans</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_trans</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">∈</span> trans <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span>
  is_trans  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">─</span>_<span class="keyword1">─</span>_<span class="keyword1">⟶</span> _"</span> <span class="main">[</span>81<span class="main">,</span>81<span class="main">,</span>81<span class="main">,</span>81<span class="main">]</span> 100<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rename_set</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rename_set</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">ren</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ren</span></span></span> <span class="bound">b</span> <span class="main">=</span> Some <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rename</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rename</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">ren</span></span></span> <span class="main">≡</span>
  <span class="main">⦇</span>asig <span class="main">=</span> <span class="main">⦇</span>inputs <span class="main">=</span> rename_set <span class="main">(</span>inp <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ren</span></span></span><span class="main">,</span> 
    outputs <span class="main">=</span> rename_set <span class="main">(</span>out <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ren</span></span></span><span class="main">,</span> 
    internals <span class="main">=</span> rename_set <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ren</span></span></span><span class="main">⦈</span><span class="main">,</span>
   start <span class="main">=</span> start <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span>
   trans <span class="main">=</span> <span class="main">{</span><span class="bound">tr</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ren</span></span></span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="bound">tr</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span>fst <span class="bound">tr</span><span class="main">)</span> <span class="main">─</span><span class="bound">x</span><span class="main">─</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⟶</span> <span class="main">(</span>snd <span class="main">(</span>snd <span class="bound">tr</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reachable states and invariants›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">reachable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> ioa <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> ioa"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    reachable_0<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> start <span class="free">A</span> <span class="main">⟹</span> <span class="free">reachable</span> <span class="free">A</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
  <span class="main">|</span> reachable_n<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">reachable</span> <span class="free">A</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">─</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">─</span><span class="free">A</span><span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">reachable</span> <span class="free">A</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">invariant</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s</span> <span class="main">.</span> reachable <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">(</span><span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> invariantI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">P</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> start <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">a</span> <span class="main">.</span> <span class="main">⟦</span>reachable <span class="free">A</span> <span class="bound">s</span><span class="main">;</span> <span class="free">P</span> <span class="bound">s</span><span class="main">;</span> <span class="bound">s</span> <span class="main">─</span><span class="bound">a</span><span class="main">─</span><span class="free">A</span><span class="main">⟶</span> <span class="bound">t</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="free">A</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">A</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>reachable.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> start <span class="free">A</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">s</span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">A</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">" <span class="skolem">s</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span><span class="free">A</span><span class="main">⟶</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>invariant_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Composition of Families of I/O Automata›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> family <span class="main">=</span>
  ids <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'id</span> set"</span></span>
  memb <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'id</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> IOA
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_ioa_fam</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_ioa_fam</span> <span class="free"><span class="bound"><span class="entity">fam</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> ids <span class="free"><span class="bound"><span class="entity">fam</span></span></span> <span class="main">.</span> is_ioa <span class="main">(</span>memb <span class="free"><span class="bound"><span class="entity">fam</span></span></span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compatible2</span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compatible2</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span>
   out <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∩</span> out <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span>
   int <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∩</span> act <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span>
   int <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∩</span> act <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compatible</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa<span class="main">)</span> family <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compatible</span> <span class="free"><span class="bound"><span class="entity">fam</span></span></span> <span class="main">≡</span> finite <span class="main">(</span>ids <span class="free"><span class="bound"><span class="entity">fam</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> ids <span class="free"><span class="bound"><span class="entity">fam</span></span></span> <span class="main">.</span> <span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span> ids <span class="free"><span class="bound"><span class="entity">fam</span></span></span> <span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span>
      compatible2 <span class="main">(</span>memb <span class="free"><span class="bound"><span class="entity">fam</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>memb <span class="free"><span class="bound"><span class="entity">fam</span></span></span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">asig_comp2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">asig_comp2</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span>
     <span class="main">⦇</span>inputs <span class="main">=</span> <span class="main">(</span>inputs <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> inputs <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>outputs <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> outputs <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">,</span>
      outputs <span class="main">=</span> outputs <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> outputs <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span>
      internals <span class="main">=</span> internals <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> internals <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span>"</span></span>
      
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">asig_comp</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa<span class="main">)</span> family <span class="main">⇒</span> <span class="tfree">'a</span> signature"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">asig_comp</span> <span class="free"><span class="bound"><span class="entity">fam</span></span></span> <span class="main">≡</span> 
    <span class="main">⦇</span> inputs <span class="main">=</span> <span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="main">(</span>ids <span class="free"><span class="bound"><span class="entity">fam</span></span></span><span class="main">)</span><span class="main">.</span> inp <span class="main">(</span>memb <span class="free"><span class="bound"><span class="entity">fam</span></span></span> <span class="bound">i</span><span class="main">)</span> 
        <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="main">(</span>ids <span class="free"><span class="bound"><span class="entity">fam</span></span></span><span class="main">)</span><span class="main">.</span> out <span class="main">(</span>memb <span class="free"><span class="bound"><span class="entity">fam</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      outputs <span class="main">=</span> <span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="main">(</span>ids <span class="free"><span class="bound"><span class="entity">fam</span></span></span><span class="main">)</span><span class="main">.</span> out <span class="main">(</span>memb <span class="free"><span class="bound"><span class="entity">fam</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span>
      internals <span class="main">=</span> <span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="main">(</span>ids <span class="free"><span class="bound"><span class="entity">fam</span></span></span><span class="main">)</span><span class="main">.</span> int <span class="main">(</span>memb <span class="free"><span class="bound"><span class="entity">fam</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">par2</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">∥</span>"</span> 10<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">∥</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span>
      <span class="main">⦇</span>asig <span class="main">=</span> asig_comp2 <span class="main">(</span>asig <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>asig <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">,</span>
       start <span class="main">=</span> <span class="main">{</span><span class="bound">pr</span><span class="main">.</span> fst <span class="bound">pr</span> <span class="main">∈</span> start <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> snd <span class="bound">pr</span> <span class="main">∈</span> start <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span><span class="main">,</span>
       trans <span class="main">=</span> <span class="main">{</span><span class="bound">tr</span><span class="main">.</span> 
        <span class="keyword1">let</span> <span class="bound">s</span> <span class="main">=</span> fst <span class="bound">tr</span><span class="main">;</span> <span class="bound">a</span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="bound">tr</span><span class="main">)</span><span class="main">;</span> <span class="bound">t</span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="bound">tr</span><span class="main">)</span>
        <span class="keyword1">in</span> <span class="main">(</span><span class="bound">a</span> <span class="main">∈</span> act <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∨</span> <span class="bound">a</span> <span class="main">∈</span> act <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>
           <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> act <span class="free"><span class="bound"><span class="entity">A</span></span></span>
              <span class="keyword1">then</span> fst <span class="bound">s</span> <span class="main">─</span><span class="bound">a</span><span class="main">─</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⟶</span> fst <span class="bound">t</span>
              <span class="keyword1">else</span> fst <span class="bound">s</span> <span class="main">=</span> fst <span class="bound">t</span><span class="main">)</span>
           <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> act <span class="free"><span class="bound"><span class="entity">B</span></span></span>
              <span class="keyword1">then</span> snd <span class="bound">s</span> <span class="main">─</span><span class="bound">a</span><span class="main">─</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⟶</span> snd <span class="bound">t</span>
              <span class="keyword1">else</span> snd <span class="bound">s</span> <span class="main">=</span> snd <span class="bound">t</span><span class="main">)</span> <span class="main">}</span><span class="main">⦈</span>"</span></span>
                
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">par</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa<span class="main">)</span> family <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'id</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">par</span> <span class="free"><span class="bound"><span class="entity">fam</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">ids</span> <span class="main">=</span> ids <span class="free"><span class="bound"><span class="entity">fam</span></span></span><span class="main">;</span> <span class="bound">memb</span> <span class="main">=</span> memb <span class="free"><span class="bound"><span class="entity">fam</span></span></span> <span class="keyword1">in</span>
      <span class="main">⦇</span> asig <span class="main">=</span> asig_comp <span class="free"><span class="bound"><span class="entity">fam</span></span></span><span class="main">,</span>
        start <span class="main">=</span> <span class="main">{</span><span class="bound">s</span> <span class="main">.</span> <span class="main">∀</span> <span class="bound">i</span><span class="main">∈</span><span class="bound">ids</span> <span class="main">.</span> <span class="bound">s</span> <span class="bound">i</span> <span class="main">∈</span> start <span class="main">(</span><span class="bound">memb</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">,</span>
        trans <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">.</span> 
          <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span><span class="main">∈</span><span class="bound">ids</span> <span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> act <span class="main">(</span><span class="bound">memb</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">∈</span><span class="bound">ids</span> <span class="main">.</span> 
              <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> act <span class="main">(</span><span class="bound">memb</span> <span class="bound">i</span><span class="main">)</span>
              <span class="keyword1">then</span> <span class="bound">s</span> <span class="bound">i</span> <span class="main">─</span><span class="bound">a</span><span class="main">─</span><span class="main">(</span><span class="bound">memb</span> <span class="bound">i</span><span class="main">)</span><span class="main">⟶</span> <span class="bound">s'</span> <span class="bound">i</span>
              <span class="keyword1">else</span> <span class="bound">s</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> asig_simps <span class="main">=</span> hide_asig_def is_asig_def locals_def externals_def actions_def 
  hide_def compatible_def asig_comp_def
<span class="keyword1"><span class="command">lemmas</span></span> ioa_simps <span class="main">=</span> rename_def rename_set_def is_trans_def is_ioa_def par_def

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Executions and Traces›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
   <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>pairs <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'s</span><span class="main">)</span> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span>
   <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>execution <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>pairs"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span>
   <span class="tfree">'a</span> trace <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
   
<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>execution_module <span class="main">=</span>
  execs<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>execution set"</span></span>
  asig<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> signature"</span></span>
  
<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'a</span> trace_module <span class="main">=</span>
  traces<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trace set"</span></span>
  asig<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> signature"</span></span>

<span class="keyword1"><span class="command">context</span></span> IOA
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_exec_frag_of</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>execution <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_exec_frag_of</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">p'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="main">─</span>fst <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">─</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⟶</span> snd <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> <span class="free">is_exec_frag_of</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">p'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_exec_frag_of</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">─</span>fst <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">─</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⟶</span> snd <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_exec_frag_of</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> True"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_exec_of</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>execution <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_exec_of</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> fst <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∈</span> start <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> is_exec_frag_of <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">filter_act</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filter_act</span> <span class="main">≡</span> map fst"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">schedule</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">schedule</span> <span class="main">≡</span> filter_act <span class="keyword1">o</span> snd"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="free"><span class="bound"><span class="entity">sig</span></span></span> <span class="main">≡</span> filter <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> externals <span class="free"><span class="bound"><span class="entity">sig</span></span></span><span class="main">)</span> <span class="keyword1">o</span> schedule"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_schedule_of</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_schedule_of</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">sch</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="main">∃</span> <span class="bound">e</span> <span class="main">.</span> is_exec_of <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">e</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">sch</span></span></span> <span class="main">=</span> filter_act <span class="main">(</span>snd <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_trace_of</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_trace_of</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="main">∃</span> <span class="bound">sch</span> <span class="main">.</span> is_schedule_of <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">sch</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> ext <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="bound">sch</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">traces</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">traces</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">tr</span><span class="main">.</span> is_trace_of <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">tr</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> traces_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"traces <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">tr</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">e</span> <span class="main">.</span> is_exec_of <span class="free">A</span> <span class="bound">e</span> 
    <span class="main">∧</span> <span class="bound">tr</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="bound">e</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> traces <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">e</span> <span class="main">.</span> is_exec_of <span class="free">A</span> <span class="bound">e</span> <span class="main">∧</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="bound">e</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> a <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sch</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"is_schedule_of <span class="free">A</span> <span class="skolem">sch</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> ext <span class="free">A</span><span class="main">)</span> <span class="skolem">sch</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>traces_def is_trace_of_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"is_exec_of <span class="free">A</span> <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">sch</span> <span class="main">=</span> filter_act <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_schedule_of_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 4 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_def schedule_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_exec_of <span class="free">A</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e</span> <span class="main">∈</span> traces <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_def schedule_def traces_def 
          is_trace_of_def is_schedule_of_def is_exec_of_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> trace_simps <span class="main">=</span> traces_def is_trace_of_def is_schedule_of_def filter_act_def is_exec_of_def
  trace_def schedule_def

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">proj_trace</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trace <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> signature<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> trace"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">¦</span>"</span> 12<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">proj_trace</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">sig</span></span></span> <span class="main">≡</span> filter <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> actions <span class="free"><span class="bound"><span class="entity">sig</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ioa_implements</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s1</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s2</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa <span class="main">⇒</span> bool"</span></span>   <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">=&lt;|</span>"</span> 12<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">=&lt;|</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> inp <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> inp <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> out <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> out <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> traces <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊆</span> traces <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operations on Executions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cons_exec</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cons_exec</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">append_exec</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">append_exec</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">≡</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">@</span><span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">last_state</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">last_state</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">last_state</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> snd <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> last_state_reachable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">e</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_exec_of <span class="free">A</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">A</span> <span class="main">(</span>last_state <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_exec_of <span class="free">A</span> <span class="free">e</span> <span class="main">⟹</span> reachable <span class="free">A</span> <span class="main">(</span>last_state <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"snd <span class="free">e</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">from</span></span> Nil.prems <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"fst <span class="skolem">e</span> <span class="main">∈</span> start <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_exec_of_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Nil.hyps <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"last_state <span class="skolem">e</span> <span class="main">=</span> fst <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_state.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> surjective_pairing<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword2"><span class="keyword">and</span></span> Nil.hyps <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> reachable_0<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">ps</span> <span class="skolem">e</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">e</span><span class="main">,</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> ih<span class="main">:</span><span class="quoted"><span class="quoted">"reachable <span class="free">A</span> <span class="main">(</span>last_state <span class="var">?e'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword2"><span class="keyword">and</span></span> Cons.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_exec_of <span class="free">A</span> <span class="var">?e'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_exec_of_def<span class="main">)</span>
          <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> IOA.is_exec_frag_of.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> IOA.is_exec_frag_of.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 
            neq_Nil_conv prod.collapse<span class="main">)</span> 
      <span class="keyword1"><span class="command">with</span></span> Cons.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword2"><span class="keyword">and</span></span> Cons.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>last_state <span class="var">?e'</span><span class="main">)</span><span class="main">─</span><span class="main">(</span>fst <span class="skolem">p</span><span class="main">)</span><span class="main">─</span><span class="free">A</span><span class="main">⟶</span><span class="main">(</span>snd <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_exec_of_def<span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span>fst <span class="skolem">e</span><span class="main">,</span><span class="skolem">ps</span><span class="main">#</span><span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>is_exec_frag_of.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword2"><span class="keyword">and</span></span> Cons.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_state.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> reachable.simps surjective_pairing<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trans_from_last_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_exec_frag_of <span class="free">A</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>last_state <span class="free">e</span><span class="main">)</span><span class="main">─</span><span class="free">a</span><span class="main">─</span><span class="free">A</span><span class="main">⟶</span><span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_exec_frag_of <span class="free">A</span> <span class="main">(</span>cons_exec <span class="free">e</span>  <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> fst <span class="free">e</span><span class="main">,</span> snd <span class="free">e</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>is_exec_frag_of.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cons_exec_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> exec_frag_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">p</span> <span class="free">ps</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_exec_frag_of <span class="free">A</span> <span class="main">(</span>cons_exec <span class="free">e</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_exec_frag_of <span class="free">A</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> fst <span class="free">e</span><span class="main">,</span> snd <span class="free">e</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>is_exec_frag_of.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cons_exec_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_same_ext<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">B</span> <span class="free">e</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ext <span class="free">A</span> <span class="main">=</span> ext <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">B</span><span class="main">)</span> <span class="free">e</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_append_is_append_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="free">e'</span> <span class="free">sig</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">sig</span> <span class="main">(</span>append_exec <span class="free">e'</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> trace <span class="free">sig</span> <span class="free">e'</span> <span class="main">@</span> trace <span class="free">sig</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>append_exec_def trace_def schedule_def filter_act_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> append_exec_frags_is_exec_frag<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="free">e'</span> <span class="free">A</span> <span class="free">as</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_exec_frag_of <span class="free">A</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"last_state <span class="free">e</span> <span class="main">=</span> fst <span class="free">e'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_exec_frag_of <span class="free">A</span> <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_exec_frag_of <span class="free">A</span> <span class="main">(</span>append_exec <span class="free">e</span> <span class="free">e'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="free">e'</span><span class="main">,</span>snd <span class="free">e'</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>is_exec_frag_of.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"3.hyps"</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>append_exec_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">A</span> <span class="skolem">p</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last_state <span class="free">e</span> <span class="main">─</span><span class="main">(</span>fst <span class="skolem">p</span><span class="main">)</span><span class="main">─</span><span class="skolem">A</span><span class="main">⟶</span> snd <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"2.hyps"</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_exec_frag_of.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_exec_frag_of <span class="skolem">A</span> <span class="main">(</span>fst <span class="free">e</span><span class="main">,</span> <span class="main">(</span>snd <span class="free">e</span><span class="main">)</span><span class="main">#</span><span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>1<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cons_exec_def prod.collapse trans_from_last_state<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"append_exec <span class="free">e</span> <span class="skolem">e'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free">e</span><span class="main">,</span> <span class="main">(</span>snd <span class="free">e</span><span class="main">)</span><span class="main">#</span><span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.hyps"</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil append_exec_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">A</span> <span class="skolem">ps</span> <span class="skolem">p'</span> <span class="skolem">p</span> <span class="skolem">e'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_exec_frag_of <span class="skolem">A</span> <span class="main">(</span>fst <span class="free">e</span><span class="main">,</span> <span class="main">(</span>snd <span class="free">e</span><span class="main">)</span><span class="main">@</span><span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">#</span><span class="skolem">p'</span><span class="main">)</span><span class="main">#</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_exec_frag_of <span class="skolem">A</span> <span class="main">(</span>fst <span class="free">e</span><span class="main">,</span> <span class="main">(</span>snd <span class="free">e</span><span class="main">)</span><span class="main">@</span><span class="main">(</span><span class="skolem">ps</span><span class="main">#</span><span class="skolem">p'</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.hyps"</span> <span class="quoted">"1.prems"</span> append_exec_def cons_exec_def 
            exec_frag_prefix fst_conv prod_eqI snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">p'</span> <span class="main">─</span><span class="main">(</span>fst <span class="skolem">p</span><span class="main">)</span><span class="main">─</span><span class="skolem">A</span><span class="main">⟶</span> snd <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span> <span class="quoted">"1.hyps"</span><span class="main">(</span>2<span class="main">)</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_exec_frag_of.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"append_exec <span class="free">e</span> <span class="skolem">e'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free">e</span><span class="main">,</span> <span class="main">(</span>snd <span class="free">e</span><span class="main">)</span><span class="main">@</span><span class="main">(</span><span class="main">(</span><span class="skolem">ps</span><span class="main">#</span><span class="skolem">p'</span><span class="main">)</span><span class="main">#</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.hyps"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> append_exec_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> last_state_of_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="free">e'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">e'</span> <span class="main">=</span> last_state <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"last_state <span class="main">(</span>append_exec <span class="free">e</span> <span class="free">e'</span><span class="main">)</span> <span class="main">=</span> last_state <span class="free">e'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>last_state.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>append_exec_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="RDR">
<div class="head">
<h1>Theory RDR</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Recoverable Data Types›</span></span>

<span class="keyword1"><span class="command">theory</span></span> RDR
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Sequences.html">Sequences</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The pre-RDR locale contains definitions later used in the RDR locale 
  to state the properties of RDRs›</span></span>

<span class="keyword1"><span class="command">locale</span></span> pre_RDR <span class="main">=</span> Sequences <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">δ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1">∙</span></span>"</span> 65<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">γ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bot</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1">⊥</span></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">×</span><span class="tfree">'c</span><span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⋆</span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> Nil <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">exec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main"><span class="free">∙</span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">less_eq</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≼</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_eq</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⋆</span><span class="bound">rs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">less</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≺</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> less_eq <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_lb</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_lb</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≼</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≼</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_glb</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_glb</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">≡</span> is_lb <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s'</span> <span class="main">.</span> is_lb <span class="bound">s'</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">⟶</span> <span class="bound">s'</span> <span class="main">≼</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">contains</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">contains</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> set <span class="bound">rs</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="free">⊥</span></span> <span class="main">⋆</span> <span class="bound">rs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inf</span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊓</span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inf</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">≡</span> <span class="keyword1">THE</span> <span class="bound">s</span> <span class="main">.</span> is_glb <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Useful Lemmas in the pre-RDR locale›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exec_cons<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋆</span> <span class="main">(</span><span class="free">rs</span> <span class="main">#</span> <span class="free">r</span><span class="main">)</span><span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">⋆</span> <span class="free">rs</span><span class="main">)</span> <span class="main"><span class="free">∙</span></span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> exec_append<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span> <span class="main">⋆</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⋆</span> <span class="free">rs'</span>  <span class="main">=</span> <span class="free">s</span> <span class="main">⋆</span> <span class="main">(</span><span class="free">rs</span><span class="main">@</span><span class="free">rs'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">rs'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span> <span class="main">⋆</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⋆</span> <span class="main">[]</span>  <span class="main">=</span> <span class="free">s</span> <span class="main">⋆</span> <span class="main">(</span><span class="free">rs</span><span class="main">@</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rs'</span> <span class="skolem">r</span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span> <span class="main">⋆</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⋆</span> <span class="skolem">rs'</span>  <span class="main">=</span> <span class="free">s</span> <span class="main">⋆</span> <span class="main">(</span><span class="free">rs</span><span class="main">@</span><span class="skolem">rs'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span> <span class="main">⋆</span> <span class="free">rs</span><span class="main">)</span> <span class="main">⋆</span> <span class="main">(</span><span class="skolem">rs'</span><span class="main">#</span><span class="skolem">r</span><span class="main">)</span>  <span class="main">=</span> <span class="free">s</span> <span class="main">⋆</span> <span class="main">(</span><span class="free">rs</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">rs'</span><span class="main">#</span><span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons exec_cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">≼</span> <span class="free">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">≼</span> <span class="free">s3</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">≼</span> <span class="free">s3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>less_eq_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> exec_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> contains_star<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="free">r</span> <span class="free">rs</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"contains <span class="free">s</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"contains <span class="main">(</span><span class="free">s</span> <span class="main">⋆</span> <span class="free">rs</span><span class="main">)</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"contains <span class="main">(</span><span class="free">s</span> <span class="main">⋆</span> <span class="main">[]</span><span class="main">)</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r'</span> <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋆</span> <span class="skolem">rs</span> <span class="main">=</span> <span class="main"><span class="free">⊥</span></span> <span class="main">⋆</span> <span class="skolem">rs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> set <span class="skolem">rs'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>contains_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋆</span> <span class="main">(</span><span class="skolem">rs</span><span class="main">#</span><span class="skolem">r'</span><span class="main">)</span> <span class="main">=</span> <span class="main"><span class="free">⊥</span></span><span class="main">⋆</span><span class="main">(</span><span class="skolem">rs'</span><span class="main">#</span><span class="skolem">r'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"contains <span class="main">(</span><span class="free">s</span> <span class="main">⋆</span> <span class="main">(</span><span class="skolem">rs</span><span class="main">#</span><span class="skolem">r'</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 3 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>contains_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> exec_cons rev_subsetD set_subset_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> preceq_star<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋆</span> <span class="main">(</span><span class="free">rs</span><span class="main">#</span><span class="free">r</span><span class="main">)</span> <span class="main">≼</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⋆</span> <span class="free">rs</span> <span class="main">≼</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pre_RDR.exec.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pre_RDR.exec.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> pre_RDR.less_eq_def trans<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The RDR locale›</span></span>

<span class="keyword1"><span class="command">locale</span></span> RDR <span class="main">=</span> pre_RDR <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> idem1<span class="main">:</span><span class="quoted"><span class="quoted">"contains <span class="free">s</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main"><span class="free">∙</span></span> <span class="free">r</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> idem2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">r</span> <span class="bound">r'</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> fst <span class="bound">r'</span> <span class="main">⟹</span> <span class="free">γ</span> <span class="bound">s</span> <span class="bound">r</span> <span class="main">=</span> <span class="free">γ</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span> <span class="main"><span class="free">∙</span></span> <span class="bound">r</span><span class="main">)</span> <span class="main"><span class="free">∙</span></span> <span class="bound">r'</span><span class="main">)</span> <span class="bound">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> antisym<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="main">.</span> <span class="bound">s1</span> <span class="main">≼</span> <span class="bound">s2</span> <span class="main">∧</span> <span class="bound">s2</span> <span class="main">≼</span> <span class="bound">s1</span> <span class="main">⟹</span> <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> glb_exists<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">s</span> <span class="main">.</span> is_glb <span class="bound">s</span> <span class="bound">s1</span> <span class="bound">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> consistency<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s3</span> <span class="bound">rs</span> <span class="main">.</span> <span class="bound">s1</span> <span class="main">≼</span> <span class="bound">s2</span> <span class="main">⟹</span> <span class="bound">s2</span> <span class="main">≼</span> <span class="bound">s3</span> <span class="main">⟹</span> <span class="bound">s3</span> <span class="main">=</span> <span class="bound">s1</span> <span class="main">⋆</span> <span class="bound">rs</span> 
    <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">rs'</span> <span class="bound">rs''</span> <span class="main">.</span> <span class="bound">s2</span> <span class="main">=</span> <span class="bound">s1</span> <span class="main">⋆</span> <span class="bound">rs'</span> <span class="main">∧</span> <span class="bound">s3</span> <span class="main">=</span> <span class="bound">s2</span> <span class="main">⋆</span> <span class="bound">rs''</span> 
      <span class="main">∧</span> set <span class="bound">rs'</span> <span class="main">⊆</span> set <span class="bound">rs</span> <span class="main">∧</span> set <span class="bound">rs''</span> <span class="main">⊆</span> set <span class="bound">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bot<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="main">.</span> <span class="main"><span class="free">⊥</span></span> <span class="main">≼</span> <span class="bound">s</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inf_glb<span class="main">:</span><span class="quoted"><span class="quoted">"is_glb <span class="main">(</span><span class="free">s1</span> <span class="main">⊓</span> <span class="free">s2</span><span class="main">)</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_glb <span class="skolem">s</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_glb <span class="skolem">s'</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> antisym <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_glb_def is_lb_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> glb_exists <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>inf_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> theI'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ordering <span class="quoted">less_eq</span> <span class="quoted">less</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≼</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exec.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less_eq_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≺</span> <span class="skolem">s'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">≼</span> <span class="skolem">s'</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>less_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≼</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">≼</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">s3</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">≼</span> <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">≼</span> <span class="skolem">s3</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">≼</span> <span class="skolem">s3</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> semilattice_set <span class="quoted">inf</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⊓</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> inf_glb
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> antisym is_glb_def is_lb_def refl<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">⊓</span> <span class="skolem">s2</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s2</span> <span class="main">⊓</span> <span class="skolem">s1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inf_glb 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> antisym is_glb_def pre_RDR.is_lb_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">s3</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span> <span class="main">⊓</span> <span class="skolem">s2</span><span class="main">)</span> <span class="main">⊓</span> <span class="skolem">s3</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s1</span> <span class="main">⊓</span> <span class="main">(</span><span class="skolem">s2</span> <span class="main">⊓</span> <span class="skolem">s3</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inf_glb 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_glb_def is_lb_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">smt</span> antisym trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> semilattice_order_set <span class="quoted">inf</span> <span class="quoted">less_eq</span> <span class="quoted">less</span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≼</span> <span class="skolem">s'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">⊓</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> antisym idem inf_glb pre_RDR.is_glb_def pre_RDR.is_lb_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≺</span> <span class="skolem">s'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">⊓</span> <span class="skolem">s'</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inf_glb local.antisym local.refl pre_RDR.is_glb_def pre_RDR.is_lb_def pre_RDR.less_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">notation</span></span> F <span class="main">(</span><span class="quoted">"<span class="keyword1">⨅</span> _"</span> <span class="main">[</span>99<span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Some useful lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> idem_star<span class="main">:</span> 
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span> <span class="free">s</span> <span class="free">rs</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"contains <span class="free">s</span> <span class="free">r</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋆</span> <span class="free">rs</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋆</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">r</span><span class="main">)</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋆</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋆</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">r</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r'</span> <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"contains <span class="main">(</span><span class="free">s</span> <span class="main">⋆</span> <span class="skolem">rs</span><span class="main">)</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> contains_star <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋆</span> <span class="main">(</span><span class="skolem">rs</span><span class="main">#</span><span class="skolem">r'</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋆</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">rs</span><span class="main">#</span><span class="skolem">r'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="free">r</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋆</span> <span class="main">(</span><span class="skolem">rs</span><span class="main">#</span><span class="skolem">r'</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> idem1 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> idem_star2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="free">rs'</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs'</span> <span class="main">.</span> <span class="free">s</span> <span class="main">⋆</span> <span class="free">rs</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋆</span> <span class="bound">rs'</span> <span class="main">∧</span> set <span class="bound">rs'</span> <span class="main">⊆</span> set <span class="free">rs</span> 
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="bound">rs'</span> <span class="main">.</span> <span class="main">¬</span> contains <span class="free">s</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs'</span> <span class="main">.</span> <span class="free">s</span> <span class="main">⋆</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋆</span> <span class="bound">rs'</span> <span class="main">∧</span> set <span class="bound">rs'</span> <span class="main">⊆</span> set <span class="main">[]</span> 
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="bound">rs'</span> <span class="main">.</span> <span class="main">¬</span> contains <span class="free">s</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋆</span> <span class="skolem">rs</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋆</span> <span class="skolem">rs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="skolem">rs'</span> <span class="main">⊆</span> set <span class="skolem">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs'</span> <span class="main">.</span> <span class="main">¬</span> contains <span class="free">s</span> <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs'</span> <span class="main">.</span> <span class="free">s</span> <span class="main">⋆</span> <span class="main">(</span><span class="skolem">rs</span><span class="main">#</span><span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋆</span> <span class="bound">rs'</span> <span class="main">∧</span> set <span class="bound">rs'</span> <span class="main">⊆</span> set <span class="main">(</span><span class="skolem">rs</span><span class="main">#</span><span class="skolem">r</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="bound">rs'</span> <span class="main">.</span> <span class="main">¬</span> contains <span class="free">s</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"contains <span class="free">s</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">⋆</span><span class="main">(</span><span class="skolem">rs</span><span class="main">#</span><span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">⋆</span><span class="skolem">rs'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋆</span> <span class="main">(</span><span class="skolem">rs</span><span class="main">#</span><span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">⋆</span><span class="skolem">rs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> contains_star exec_cons idem1<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋆</span> <span class="main">(</span><span class="skolem">rs'</span><span class="main">#</span><span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">⋆</span><span class="skolem">rs'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> contains_star exec_cons idem1<span class="main">)</span> 
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">rs'</span> <span class="main">⊆</span> set <span class="main">(</span><span class="skolem">rs</span><span class="main">#</span><span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> subset_insertI2<span class="main">)</span> 
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs'</span> <span class="main">.</span> <span class="main">¬</span> contains <span class="free">s</span> <span class="bound">r</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">⋆</span><span class="main">(</span><span class="skolem">rs</span><span class="main">#</span><span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">⋆</span><span class="main">(</span><span class="skolem">rs'</span><span class="main">#</span><span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">rs'</span><span class="main">#</span><span class="skolem">r</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span><span class="skolem">rs</span><span class="main">#</span><span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">rs'</span><span class="main">#</span><span class="skolem">r</span><span class="main">)</span> <span class="main">.</span> <span class="main">¬</span> contains <span class="free">s</span> <span class="bound">r</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> 3 False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> idem2_star<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"contains <span class="free">s</span> <span class="free">r</span>"</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r'</span> <span class="main">.</span> <span class="bound">r'</span> <span class="main">∈</span> set <span class="free">rs</span> <span class="main">⟹</span> fst <span class="bound">r'</span> <span class="main">≠</span> fst <span class="free">r</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> <span class="free">γ</span> <span class="main">(</span><span class="free">s</span> <span class="main">⋆</span> <span class="free">rs</span><span class="main">)</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>  
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> <span class="free">γ</span> <span class="main">(</span><span class="free">s</span> <span class="main">⋆</span> <span class="main">[]</span><span class="main">)</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r'</span> <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> <span class="free">γ</span> <span class="main">(</span><span class="free">s</span> <span class="main">⋆</span> <span class="main">(</span><span class="skolem">rs</span><span class="main">#</span><span class="skolem">r'</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="main">(</span><span class="operator">metis</span> contains_star fst_conv idem1 idem2 prod.exhaust<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> glb_common<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s1</span> <span class="free">s2</span> <span class="free">s</span> <span class="free">rs1</span> <span class="free">rs2</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋆</span> <span class="free">rs1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋆</span> <span class="free">rs2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> <span class="free">s1</span> <span class="main">⊓</span> <span class="free">s2</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋆</span> <span class="bound">rs</span> <span class="main">∧</span> set <span class="bound">rs</span> <span class="main">⊆</span> set <span class="free">rs1</span> <span class="main">∪</span> set <span class="free">rs2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≼</span> <span class="free">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≼</span> <span class="free">s2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>less_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≼</span> <span class="free">s1</span> <span class="main">⊓</span> <span class="free">s2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inf_glb is_lb_def pre_RDR.is_glb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">⊓</span> <span class="free">s2</span> <span class="main">≼</span> <span class="free">s1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cobounded1<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3 4 assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> consistency <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> glb_common_set<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ss</span> <span class="free">s0</span> <span class="free">rset</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">ss</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">ss</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">s0</span> <span class="main">⋆</span> <span class="bound">rs</span> <span class="main">∧</span> set <span class="bound">rs</span> <span class="main">⊆</span> <span class="free">rset</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> <span class="main">⨅</span> <span class="free">ss</span> <span class="main">=</span> <span class="free">s0</span> <span class="main">⋆</span> <span class="bound">rs</span> <span class="main">∧</span> set <span class="bound">rs</span> <span class="main">⊆</span> <span class="free">rset</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>finite_ne_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>singleton <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="free">s0</span> <span class="main">⋆</span> <span class="skolem">rs</span> <span class="main">∧</span> set <span class="skolem">rs</span> <span class="main">⊆</span> <span class="free">rset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> <span class="main">⨅</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">=</span> <span class="free">s0</span> <span class="main">⋆</span> <span class="bound">rs</span> <span class="main">∧</span> set <span class="bound">rs</span> <span class="main">⊆</span> <span class="free">rset</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s'</span> <span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="skolem">ss</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> <span class="bound">s'</span> <span class="main">=</span> <span class="free">s0</span> <span class="main">⋆</span> <span class="bound">rs</span> <span class="main">∧</span> set <span class="bound">rs</span> <span class="main">⊆</span> <span class="free">rset</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⨅</span> <span class="skolem">ss</span> <span class="main">=</span> <span class="free">s0</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="skolem">rs</span> <span class="main">⊆</span> <span class="free">rset</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>4<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="free">s0</span> <span class="main">⋆</span> <span class="skolem">rs'</span>"</span></span><span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="skolem">rs'</span> <span class="main">⊆</span> <span class="free">rset</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⨅</span> <span class="main">(</span>insert <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">⊓</span> <span class="main">(</span><span class="main">⨅</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert.hyps<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span> insert_not_elem<span class="main">)</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⨅</span> <span class="main">(</span>insert <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> <span class="free">s0</span> <span class="main">⋆</span> <span class="skolem">rs''</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> 8<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="skolem">rs''</span> <span class="main">⊆</span> set <span class="skolem">rs'</span> <span class="main">∪</span> set <span class="skolem">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> glb_common 2 4 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="skolem">rs''</span> <span class="main">⊆</span> <span class="free">rset</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 5 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> <span class="main">⨅</span> <span class="main">(</span>insert <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> <span class="free">s0</span> <span class="main">⋆</span> <span class="bound">rs</span> <span class="main">∧</span> set <span class="bound">rs</span> <span class="main">⊆</span> <span class="free">rset</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 7 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SLin">
<div class="head">
<h1>Theory SLin</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Giuliano Losa *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The SLin Automata specification›</span></span>

<span class="keyword1"><span class="command">theory</span></span> SLin
<span class="keyword2"><span class="keyword">imports</span></span> <a href="IOA.html">IOA</a> <a href="RDR.html">RDR</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span>SLin_action <span class="main">=</span>
<span class="comment1">― ‹The nat component is the instance number›</span>
  Invoke <span class="quoted">nat</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'c</span></span></span>
<span class="main">|</span> Response <span class="quoted">nat</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'d</span></span></span>
<span class="main">|</span> Switch <span class="quoted">nat</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'c</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
<span class="main">|</span> Recover <span class="quoted">nat</span>
<span class="main">|</span> Linearize <span class="quoted">nat</span>

<span class="keyword1"><span class="command">datatype</span></span> SLin_status <span class="main">=</span> Sleep <span class="main">|</span> Pending <span class="main">|</span> Ready <span class="main">|</span> Aborted

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state <span class="main">=</span> 
  pending <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span>"</span></span>
  initVals <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  abortVals <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  status <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> SLin_status"</span></span>
  dstate <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  initialized <span class="main">::</span> <span class="quoted">bool</span>

<span class="keyword1"><span class="command">locale</span></span> SLin <span class="main">=</span> RDR <span class="main">+</span> IOA
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">asig</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span>SLin_action signature"</span></span> 
  <span class="comment1">― ‹The first instance has number 0›</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">asig</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>
    inputs <span class="main">=</span> <span class="main">{</span><span class="bound">act</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">p</span> <span class="bound">c</span> <span class="bound">iv</span> <span class="bound">i'</span> <span class="main">.</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="bound">i'</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> <span class="bound">act</span> <span class="main">=</span> Invoke <span class="bound">i'</span> <span class="bound">p</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">act</span> <span class="main">=</span> Switch <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">p</span> <span class="bound">c</span> <span class="bound">iv</span><span class="main">)</span><span class="main">}</span><span class="main">,</span>
    outputs <span class="main">=</span> <span class="main">{</span><span class="bound">act</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">p</span> <span class="bound">c</span> <span class="bound">av</span> <span class="bound">i'</span> <span class="bound">outp</span> <span class="main">.</span> 
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="bound">i'</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> <span class="bound">act</span> <span class="main">=</span> Response <span class="bound">i'</span> <span class="bound">p</span> <span class="bound">outp</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">act</span> <span class="main">=</span> Switch <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="bound">p</span> <span class="bound">c</span> <span class="bound">av</span><span class="main">}</span><span class="main">,</span>
    internals <span class="main">=</span> <span class="main">{</span><span class="bound">act</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">i'</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="bound">i'</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> 
      <span class="main">∧</span> <span class="main">(</span><span class="bound">act</span> <span class="main">=</span> Linearize <span class="bound">i'</span> <span class="main">∨</span> <span class="bound">act</span> <span class="main">=</span> Recover <span class="bound">i'</span><span class="main">)</span><span class="main">}</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pendingReqs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">×</span><span class="tfree">'c</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pendingReqs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">r</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">p</span> <span class="main">.</span> 
     <span class="bound">r</span> <span class="main">=</span> pending <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span>
     <span class="main">∧</span> status <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span>Pending<span class="main">,</span> Aborted<span class="main">}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> 
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Inv</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> 
    status <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Ready
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⦇</span>pending <span class="main">:=</span> <span class="main">(</span>pending <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
        status <span class="main">:=</span> <span class="main">(</span>status <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> Pending<span class="main">)</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pendingSeqs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pendingSeqs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">rs</span> <span class="main">.</span> set <span class="bound">rs</span> <span class="main">⊆</span> pendingReqs <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">}</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Lin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Lin</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">rs</span> <span class="main">∈</span> pendingSeqs <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">.</span>
      initialized <span class="free"><span class="bound"><span class="entity">s</span></span></span> 
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">av</span> <span class="main">∈</span> abortVals <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">.</span> <span class="main">(</span>dstate <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⋆</span> <span class="bound">rs</span> <span class="main">≼</span> <span class="bound">av</span><span class="main">)</span> 
      <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⦇</span>dstate <span class="main">:=</span> <span class="main">(</span>dstate <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⋆</span> <span class="bound">rs</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">initSets</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">initSets</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">ivs</span> <span class="main">.</span> <span class="bound">ivs</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> <span class="bound">ivs</span> <span class="main">⊆</span> initVals <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">safeInits</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safeInits</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> initVals <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">{}</span>
    <span class="keyword1">else</span> <span class="main">{</span><span class="bound">d</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">ivs</span> <span class="main">∈</span> initSets <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">rs</span> <span class="main">∈</span> pendingSeqs <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">.</span>
      <span class="bound">d</span> <span class="main">=</span> <span class="main">⨅</span><span class="bound">ivs</span> <span class="main">⋆</span> <span class="bound">rs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">av</span> <span class="main">∈</span> abortVals <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">.</span> <span class="bound">d</span> <span class="main">≼</span> <span class="bound">av</span><span class="main">)</span><span class="main">}</span>"</span></span>
      
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">initAborts</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">initAborts</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">d</span> <span class="main">.</span>dstate <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≼</span> <span class="bound">d</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span> <span class="bound">rs</span> <span class="main">∈</span> pendingSeqs <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">.</span> <span class="bound">d</span> <span class="main">=</span> dstate <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⋆</span> <span class="bound">rs</span><span class="main">)</span>
      <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">ivs</span> <span class="main">∈</span> initSets <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">.</span> dstate <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≼</span> <span class="main">⨅</span><span class="bound">ivs</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">rs</span> <span class="main">∈</span> pendingSeqs <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">.</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">⨅</span><span class="bound">ivs</span> <span class="main">⋆</span> <span class="bound">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uninitAborts</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">uninitAborts</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">d</span> <span class="main">.</span>
    <span class="main">∃</span> <span class="bound">ivs</span> <span class="main">∈</span> initSets <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">rs</span> <span class="main">∈</span> pendingSeqs <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">.</span> 
      <span class="bound">d</span> <span class="main">=</span> <span class="main">⨅</span><span class="bound">ivs</span> <span class="main">⋆</span> <span class="bound">rs</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">safeAborts</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safeAborts</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> initialized <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> initAborts <span class="free"><span class="bound"><span class="entity">s</span></span></span>
    <span class="keyword1">else</span> uninitAborts <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Reco</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Reco</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span>  
      <span class="main">(</span><span class="main">∃</span> <span class="bound">p</span> <span class="main">.</span> status <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span> <span class="main">≠</span> Sleep<span class="main">)</span>
      <span class="main">∧</span> <span class="main">¬</span> initialized <span class="free"><span class="bound"><span class="entity">s</span></span></span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">d</span> <span class="main">∈</span> safeInits <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">.</span> 
        <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⦇</span>dstate <span class="main">:=</span> <span class="bound">d</span><span class="main">,</span> initialized <span class="main">:=</span> True<span class="main">⦈</span><span class="main">)</span>"</span></span>
      
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Resp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Resp</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">ou</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span>  
      status <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Pending 
      <span class="main">∧</span> initialized <span class="free"><span class="bound"><span class="entity">s</span></span></span>
      <span class="main">∧</span> contains <span class="main">(</span>dstate <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>pending <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>
      <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">ou</span></span></span> <span class="main">=</span> <span class="free">γ</span> <span class="main">(</span>dstate <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>pending <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>
      <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦇</span>status <span class="main">:=</span> <span class="main">(</span>status <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> Ready<span class="main">)</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'a</span> 
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Init</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">iv</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span>
    status <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Sleep
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦇</span>initVals <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">iv</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>initVals <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">,</span> 
        status <span class="main">:=</span> <span class="main">(</span>status <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> Pending<span class="main">)</span><span class="main">,</span> 
        pending <span class="main">:=</span> <span class="main">(</span>pending <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
      
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Abort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'a</span> 
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Abort</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">av</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span>
     status <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Pending <span class="main">∧</span> pending <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>
     <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">av</span></span></span> <span class="main">∈</span> safeAborts <span class="free"><span class="bound"><span class="entity">s</span></span></span>
     <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⦇</span>status <span class="main">:=</span> <span class="main">(</span>status <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> Aborted<span class="main">)</span><span class="main">,</span> 
      abortVals <span class="main">:=</span> <span class="main">(</span>abortVals <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">av</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">trans</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">trans</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> 
  Invoke <span class="bound">i'</span> <span class="bound">p</span> <span class="bound">c</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> Inv <span class="bound">p</span> <span class="bound">c</span> <span class="bound">s</span> <span class="bound">s'</span>
<span class="main">|</span> Response <span class="bound">i'</span> <span class="bound">p</span> <span class="bound">ou</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="bound">i'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> Resp <span class="bound">p</span> <span class="bound">ou</span> <span class="bound">s</span> <span class="bound">s'</span>
<span class="main">|</span> Switch <span class="bound">i'</span> <span class="bound">p</span> <span class="bound">c</span> <span class="bound">v</span> <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">i'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> Init <span class="bound">p</span> <span class="bound">c</span> <span class="bound">v</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> 
    <span class="main">∨</span> <span class="main">(</span><span class="bound">i'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> Abort <span class="bound">p</span> <span class="bound">c</span> <span class="bound">v</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span>
<span class="main">|</span> Linearize <span class="bound">i'</span> <span class="main">⇒</span> <span class="bound">i'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> Lin <span class="bound">s</span> <span class="bound">s'</span>
<span class="main">|</span> Recover <span class="bound">i'</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">i'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> Reco <span class="bound">s</span> <span class="bound">s'</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">start</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">start</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">s</span> <span class="main">.</span> 
    <span class="main">∀</span> <span class="bound">p</span> <span class="main">.</span> status <span class="bound">s</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> Sleep <span class="keyword1">else</span> Ready<span class="main">)</span> 
    <span class="main">∧</span> dstate <span class="bound">s</span> <span class="main">=</span> <span class="main"><span class="free">⊥</span></span>
    <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">¬</span> initialized <span class="bound">s</span> <span class="keyword1">else</span> initialized <span class="bound">s</span><span class="main">)</span>
    <span class="main">∧</span> initVals <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span>
    <span class="main">∧</span> abortVals <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ioa</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ioa</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span>
     <span class="main">⦇</span>ioa.asig <span class="main">=</span> asig <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">,</span>
      start <span class="main">=</span> start <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span>
      trans <span class="main">=</span> trans <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">⦈</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Simulations">
<div class="head">
<h1>Theory Simulations</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Definition and Soundness of Refinement Mappings,
  Forward Simulations and Backward Simulations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Simulations
<span class="keyword2"><span class="keyword">imports</span></span> <a href="IOA.html">IOA</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> IOA
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">refines</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">refines</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> fst <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> last_state <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> is_exec_frag_of <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
            <span class="main">∧</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">tr</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">in</span> 
                <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> ext <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> <span class="bound">tr</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span> <span class="keyword1">else</span> <span class="bound">tr</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">is_ref_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s1</span> <span class="main">⇒</span> <span class="tfree">'s2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s1</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s2</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_ref_map</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">s</span> <span class="main">∈</span> start <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="main">∈</span> start <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">a</span><span class="main">.</span> reachable <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">─</span><span class="bound">a</span><span class="main">─</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⟶</span> <span class="bound">t</span>
      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">e</span> <span class="main">.</span> refines <span class="bound">e</span> <span class="bound">s</span> <span class="bound">a</span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">is_forward_sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s1</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s2</span> set<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s1</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s2</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_forward_sim</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span>
   <span class="main">(</span><span class="main">∀</span> <span class="bound">s</span> <span class="main">∈</span> start <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="main">∩</span> start <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">t</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">─</span><span class="bound">a</span><span class="main">─</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⟶</span> <span class="bound">t</span> <span class="main">∧</span> reachable <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">s</span>
        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">e</span> <span class="main">.</span> fst <span class="bound">e</span> <span class="main">=</span> <span class="bound">s'</span> <span class="main">∧</span> last_state <span class="bound">e</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">t</span> <span class="main">∧</span> is_exec_frag_of <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">e</span>
              <span class="main">∧</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">tr</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="bound">e</span> <span class="keyword1">in</span> 
                    <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> ext <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> <span class="bound">tr</span> <span class="main">=</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span> <span class="keyword1">else</span> <span class="bound">tr</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">is_backward_sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s1</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s2</span> set<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s1</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s2</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_backward_sim</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span>
   <span class="main">(</span><span class="main">∀</span> <span class="bound">s</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="comment1">― ‹Quantifying over reachable states would suffice›</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s</span> <span class="main">∈</span> start <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="main">⊆</span> start <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s</span> <span class="bound">t</span> <span class="bound">a</span> <span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">t</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">─</span><span class="bound">a</span><span class="main">─</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⟶</span> <span class="bound">t</span> <span class="main">∧</span> reachable <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">s</span>
        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">e</span> <span class="main">.</span> fst <span class="bound">e</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span> <span class="main">∧</span> last_state <span class="bound">e</span> <span class="main">=</span> <span class="bound">t'</span> <span class="main">∧</span> is_exec_frag_of <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">e</span>
                <span class="main">∧</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">tr</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="bound">e</span> <span class="keyword1">in</span> 
                      <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> ext <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> <span class="bound">tr</span> <span class="main">=</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span> <span class="keyword1">else</span> <span class="bound">tr</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A series of lemmas that will be useful in the soundness proofs›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_eq_traces<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e_B'</span> <span class="free">A</span> <span class="free">e</span> <span class="free">e_A'</span> <span class="free">a</span> <span class="free">t</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">e_A</span> <span class="main">≡</span> append_exec <span class="free">e_A'</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e_B</span> <span class="main">≡</span> cons_exec <span class="free">e_B'</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">tr</span> <span class="main">≡</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e_A'</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e_B'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="free">a</span> <span class="main">∈</span> ext <span class="free">A</span> <span class="keyword1">then</span> <span class="free">tr</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">else</span> <span class="free">tr</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e_A</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e_B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e_B</span> <span class="main">=</span> 
         <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">∈</span> ext <span class="free">A</span> <span class="keyword1">then</span> <span class="main">(</span>trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e_B'</span><span class="main">)</span> <span class="main">#</span> <span class="free">a</span> <span class="keyword1">else</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e_B'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> e_B_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_def schedule_def filter_act_def cons_exec_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e_A</span> <span class="main">=</span> 
         <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">∈</span> ext <span class="free">A</span> <span class="keyword1">then</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e_A'</span> <span class="main">#</span> <span class="free">a</span> <span class="keyword1">else</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e_A'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 trace_append_is_append_trace<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ioa.asig <span class="free">A</span>"</span></span> <span class="quoted"><span class="free">e_A'</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>e_A_def tr_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exec_inc_imp_trace_inc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">B</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ext <span class="free">B</span> <span class="main">=</span> ext <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">e_B</span> <span class="main">.</span> is_exec_of <span class="free">B</span> <span class="bound">e_B</span> 
    <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">e_A</span> <span class="main">.</span> is_exec_of <span class="free">A</span> <span class="bound">e_A</span> <span class="main">∧</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="bound">e_A</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="bound">e_B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"traces <span class="free">B</span> <span class="main">⊆</span> traces <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> traces <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">B</span><span class="main">)</span> <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"is_exec_of <span class="free">B</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> traces_alt assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 2 3 <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"is_exec_of <span class="free">A</span> <span class="skolem">e'</span> <span class="main">∧</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e'</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> traces <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 traces_alt <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness of Refinement Mappings›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ref_map_execs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sA</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sB</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'sB</span> <span class="main">⇒</span> <span class="tfree">'sA</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">e_B</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_ref_map <span class="free">f</span> <span class="free">B</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_exec_of <span class="free">B</span> <span class="free">e_B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">e_A</span> <span class="main">.</span>  is_exec_of <span class="free">A</span> <span class="bound">e_A</span> 
    <span class="main">∧</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="bound">e_A</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e_B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">e_A</span> <span class="main">.</span>  is_exec_of <span class="free">A</span> <span class="bound">e_A</span> 
                  <span class="main">∧</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="bound">e_A</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e_B</span> 
                  <span class="main">∧</span> last_state <span class="bound">e_A</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>last_state <span class="free">e_B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"snd <span class="free">e_B</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">e_B</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e_A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">(</span>fst <span class="skolem">e_B</span><span class="main">)</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> start <span class="free">B</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">∈</span> start <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_ref_map_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_exec_of <span class="free">A</span> <span class="var">?e_A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Nil.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_exec_of_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="var">?e_A</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e_B</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Nil.hyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_simps<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last_state <span class="var">?e_A</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>last_state <span class="skolem">e_B</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Nil.hyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_state.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">ps</span> <span class="skolem">e_B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e_B'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">e_B</span><span class="main">,</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"last_state <span class="var">?e_B'</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"is_exec_of <span class="free">B</span> <span class="var">?e_B'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?s</span><span class="main">─</span><span class="var">?a</span><span class="main">─</span><span class="free">B</span><span class="main">⟶</span><span class="var">?t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword2"><span class="keyword">and</span></span> Cons.hyps<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_exec_of_def<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span>fst <span class="skolem">e_B</span><span class="main">,</span><span class="skolem">ps</span><span class="main">#</span><span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>is_exec_frag_of.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span>
            <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span>fst <span class="skolem">e_B</span><span class="main">,</span><span class="skolem">ps</span><span class="main">#</span><span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>is_exec_frag_of.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e_A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ih1<span class="main">:</span><span class="quoted"><span class="quoted">"is_exec_of <span class="free">A</span> <span class="skolem">e_A'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ih2<span class="main">:</span><span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e_A'</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="var">?e_B'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ih3<span class="main">:</span><span class="quoted"><span class="quoted">"last_state <span class="skolem">e_A'</span> <span class="main">=</span> <span class="free">f</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"reachable <span class="free">B</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> last_state_reachable <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"fst <span class="skolem">e</span> <span class="main">=</span> <span class="free">f</span> <span class="var">?s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"last_state <span class="skolem">e</span> <span class="main">=</span> <span class="free">f</span> <span class="var">?t</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"is_exec_frag_of <span class="free">A</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">tr</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="var">?a</span> <span class="main">∈</span> ext <span class="free">A</span> 
      <span class="keyword1">then</span> <span class="bound">tr</span> <span class="main">=</span> <span class="main">[</span><span class="var">?a</span><span class="main">]</span> <span class="keyword1">else</span> <span class="bound">tr</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword2"><span class="keyword">and</span></span> 3 <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_ref_map_def refines_def<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e_A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"append_exec <span class="skolem">e_A'</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_exec_of <span class="free">A</span> <span class="var">?e_A</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> ih1 ih3 4 6 append_exec_frags_is_exec_frag<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="skolem">e_A'</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_exec_def append_exec_frags_is_exec_frag 
          fst_conv is_exec_of_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="var">?e_A</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e_B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ih2 Cons.hyps<span class="main">(</span>2<span class="main">)</span> 7 step_eq_traces<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">e_A'</span></span> <span class="var"><span class="quoted"><span class="var">?e_B'</span></span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="quoted"><span class="skolem">e</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cons_exec_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last_state <span class="var">?e_A</span> <span class="main">=</span> <span class="free">f</span> <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih3 4 5 last_state_of_append 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.hyps<span class="main">(</span>2<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_state.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> surjective_pairing<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ref_map_soundness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sA</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sB</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'sB</span> <span class="main">⇒</span> <span class="tfree">'sA</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_ref_map <span class="free">f</span> <span class="free">B</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ext <span class="free">A</span> <span class="main">=</span> ext <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"traces <span class="free">B</span> <span class="main">⊆</span> traces <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms ref_map_execs exec_inc_imp_trace_inc <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness of Forward Simulations›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> forward_sim_execs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sA</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sB</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'sB</span> <span class="main">⇒</span> <span class="tfree">'sA</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">e_B</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_forward_sim <span class="free">f</span> <span class="free">B</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_exec_of <span class="free">B</span> <span class="free">e_B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">e_A</span> <span class="main">.</span>  is_exec_of <span class="free">A</span> <span class="bound">e_A</span> 
    <span class="main">∧</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="bound">e_A</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e_B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">e_A</span> <span class="main">.</span>  is_exec_of <span class="free">A</span> <span class="bound">e_A</span> 
                  <span class="main">∧</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="bound">e_A</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e_B</span> 
                  <span class="main">∧</span> last_state <span class="bound">e_A</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">(</span>last_state <span class="free">e_B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"snd <span class="free">e_B</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">e_B</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> start <span class="free">B</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">∩</span> start <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_forward_sim_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">(</span>fst <span class="skolem">e_B</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> start <span class="free">A</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_iff Nil.prems all_not_in_conv is_exec_of_def<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e_A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_exec_of <span class="free">A</span> <span class="var">?e_A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_exec_of_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="var">?e_A</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e_B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Nil.hyps 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_def schedule_def filter_act_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last_state <span class="var">?e_A</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">(</span>last_state <span class="skolem">e_B</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Nil.hyps 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_state.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> surjective_pairing<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">ps</span> <span class="skolem">e_B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e_B'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">e_B</span><span class="main">,</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"last_state <span class="var">?e_B'</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"is_exec_of <span class="free">B</span> <span class="var">?e_B'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?s</span><span class="main">─</span><span class="var">?a</span><span class="main">─</span><span class="free">B</span><span class="main">⟶</span><span class="var">?t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword2"><span class="keyword">and</span></span> Cons.hyps<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_exec_of_def<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span>fst <span class="skolem">e_B</span><span class="main">,</span><span class="skolem">ps</span><span class="main">#</span><span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>is_exec_frag_of.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span>
            <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span>fst <span class="skolem">e_B</span><span class="main">,</span><span class="skolem">ps</span><span class="main">#</span><span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>is_exec_frag_of.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e_A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ih1<span class="main">:</span><span class="quoted"><span class="quoted">"is_exec_of <span class="free">A</span> <span class="skolem">e_A'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ih2<span class="main">:</span><span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e_A'</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="var">?e_B'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ih3<span class="main">:</span><span class="quoted"><span class="quoted">"last_state <span class="skolem">e_A'</span> <span class="main">∈</span> <span class="free">f</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"reachable <span class="free">B</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> last_state_reachable <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"fst <span class="skolem">e</span> <span class="main">=</span> last_state <span class="skolem">e_A'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"last_state <span class="skolem">e</span> <span class="main">∈</span> <span class="free">f</span> <span class="var">?t</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"is_exec_frag_of <span class="free">A</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">tr</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="var">?a</span> <span class="main">∈</span> ext <span class="free">A</span> <span class="keyword1">then</span> <span class="bound">tr</span> <span class="main">=</span> <span class="main">[</span><span class="var">?a</span><span class="main">]</span> <span class="keyword1">else</span> <span class="bound">tr</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> 2 3 assms<span class="main">(</span>1<span class="main">)</span> ih3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_forward_sim_def<span class="main">)</span> 
        <span class="main">(</span><span class="operator">metis</span> prod.collapse prod.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e_A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"append_exec <span class="skolem">e_A'</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_exec_of <span class="free">A</span> <span class="var">?e_A</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> ih1 ih3 4 6 append_exec_frags_is_exec_frag<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="skolem">e_A'</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_exec_def append_exec_frags_is_exec_frag 
            fst_conv is_exec_of_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="var">?e_A</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e_B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ih2 Cons.hyps<span class="main">(</span>2<span class="main">)</span> 7 step_eq_traces<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">e_A'</span></span> <span class="var"><span class="quoted"><span class="var">?e_B'</span></span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="quoted"><span class="skolem">e</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cons_exec_def Let_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last_state <span class="var">?e_A</span> <span class="main">∈</span> <span class="free">f</span> <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih3 4 5 last_state_of_append 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.hyps<span class="main">(</span>2<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_state.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> surjective_pairing<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> forward_sim_soundness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sA</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sB</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'sB</span> <span class="main">⇒</span> <span class="tfree">'sA</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_forward_sim <span class="free">f</span> <span class="free">B</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ext <span class="free">A</span> <span class="main">=</span> ext <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"traces <span class="free">B</span> <span class="main">⊆</span> traces <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms forward_sim_execs exec_inc_imp_trace_inc <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness of Backward Simulations›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> backward_sim_execs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sA</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sB</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'sB</span> <span class="main">⇒</span> <span class="tfree">'sA</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">e_B</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_backward_sim <span class="free">f</span> <span class="free">B</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_exec_of <span class="free">B</span> <span class="free">e_B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">e_A</span> <span class="main">.</span>  is_exec_of <span class="free">A</span> <span class="bound">e_A</span> 
    <span class="main">∧</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="bound">e_A</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e_B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">(</span>last_state <span class="free">e_B</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">e_A</span> <span class="main">.</span>
          is_exec_of <span class="free">A</span> <span class="bound">e_A</span> 
          <span class="main">∧</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="bound">e_A</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="free">e_B</span> 
          <span class="main">∧</span> last_state <span class="bound">e_A</span> <span class="main">=</span> <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"snd <span class="free">e_B</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">e_B</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s'</span> <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> <span class="free">f</span><span class="main">(</span>last_state <span class="skolem">e_B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> start <span class="free">B</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">⊆</span> start <span class="free">A</span> "</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_backward_sim_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Nil 1 2 <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> start <span class="free">A</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> is_exec_of_def last_state.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subsetD surjective_pairing<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e_A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"is_exec_of <span class="free">A</span> <span class="var">?e_A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_exec_of_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="var">?e_A</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e_B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Nil.hyps 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_def schedule_def filter_act_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"last_state <span class="var">?e_A</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">(</span>last_state <span class="skolem">e_B</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Nil.hyps 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_state.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">note</span></span> 4 5 6 <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">ps</span> <span class="skolem">e_B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t'</span> <span class="keyword3"><span class="command">assume</span></span> 8<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">(</span>last_state <span class="skolem">e_B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e_B'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">e_B</span><span class="main">,</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"last_state <span class="var">?e_B'</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> last_state <span class="skolem">e_B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.hyps<span class="main">(</span>2<span class="main">)</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_state.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"is_exec_of <span class="free">B</span> <span class="var">?e_B'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?s</span><span class="main">─</span><span class="var">?a</span><span class="main">─</span><span class="free">B</span><span class="main">⟶</span><span class="var">?t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword2"><span class="keyword">and</span></span> Cons.hyps<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_exec_of_def<span class="main"><span class="keyword3">,</span></span>
              <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span>fst <span class="skolem">e_B</span><span class="main">,</span> <span class="skolem">ps</span><span class="main">#</span><span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>is_exec_frag_of.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span>
              <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span>fst <span class="skolem">e_B</span><span class="main">,</span> <span class="skolem">ps</span><span class="main">#</span><span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>is_exec_frag_of.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"reachable <span class="free">B</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> last_state_reachable <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"fst <span class="skolem">e</span> <span class="main">∈</span> <span class="free">f</span> <span class="var">?s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"last_state <span class="skolem">e</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"is_exec_frag_of <span class="free">A</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">tr</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e</span> <span class="keyword1">in</span> 
        <span class="keyword1">if</span> <span class="var">?a</span> <span class="main">∈</span> ext <span class="free">A</span> <span class="keyword1">then</span> <span class="bound">tr</span> <span class="main">=</span> <span class="main">[</span><span class="var">?a</span><span class="main">]</span> <span class="keyword1">else</span> <span class="bound">tr</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> 2 assms<span class="main">(</span>1<span class="main">)</span> 8 5 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_backward_sim_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e_A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ih1<span class="main">:</span><span class="quoted"><span class="quoted">"is_exec_of <span class="free">A</span> <span class="skolem">e_A'</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> ih2<span class="main">:</span><span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e_A'</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="var">?e_B'</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> ih3<span class="main">:</span><span class="quoted"><span class="quoted">"last_state <span class="skolem">e_A'</span> <span class="main">=</span> fst <span class="skolem">e</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 4 Cons.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e_A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"append_exec <span class="skolem">e_A'</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_exec_of <span class="free">A</span> <span class="var">?e_A</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> ih1 ih3 4 6 append_exec_frags_is_exec_frag<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="skolem">e_A'</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_exec_def append_exec_frags_is_exec_frag 
            fst_conv is_exec_of_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">moreover</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="var">?e_A</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e_B</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ih2 Cons.hyps<span class="main">(</span>2<span class="main">)</span> 7 step_eq_traces<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">e_A'</span></span> <span class="var"><span class="quoted"><span class="var">?e_B'</span></span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="quoted"><span class="skolem">e</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cons_exec_def Let_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last_state <span class="var">?e_A</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih3 5 last_state_of_append 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">e_A</span> <span class="main">.</span> is_exec_of <span class="free">A</span> <span class="bound">e_A</span> 
        <span class="main">∧</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="bound">e_A</span> <span class="main">=</span> trace <span class="main">(</span>ioa.asig <span class="free">A</span><span class="main">)</span> <span class="skolem">e_B</span>
        <span class="main">∧</span> last_state <span class="bound">e_A</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> total<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_backward_sim_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> backward_sim_soundness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sA</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sB</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>ioa"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'sB</span> <span class="main">⇒</span> <span class="tfree">'sA</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_backward_sim <span class="free">f</span> <span class="free">B</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ext <span class="free">A</span> <span class="main">=</span> ext <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"traces <span class="free">B</span> <span class="main">⊆</span> traces <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms backward_sim_execs exec_inc_imp_trace_inc <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Idempotence">
<div class="head">
<h1>Theory Idempotence</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Idempotence of the SLin I/O automaton›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Idempotence
<span class="keyword2"><span class="keyword">imports</span></span> <a href="SLin.html">SLin</a> <a href="Simulations.html">Simulations</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> Idempotence <span class="main">=</span> SLin <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">id1</span> <span class="free">id2</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> id1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">id1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> id2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">id1</span> <span class="main">&lt;</span> <span class="free">id2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> ids <span class="main">=</span> id1 id2

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">composition</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">composition</span>  <span class="main">≡</span> 
     hide <span class="main">(</span><span class="main">(</span>ioa <span class="main">0</span> <span class="free">id1</span><span class="main">)</span> <span class="main">∥</span> <span class="main">(</span>ioa <span class="free">id1</span> <span class="free">id2</span><span class="main">)</span><span class="main">)</span>
          <span class="main">{</span><span class="bound">act</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">c</span> <span class="bound">av</span> <span class="main">.</span> <span class="bound">act</span> <span class="main">=</span> Switch <span class="free">id1</span> <span class="bound">p</span> <span class="bound">c</span> <span class="bound">av</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> comp_simps <span class="main">=</span> hide_def composition_def ioa_def par2_def is_trans_def
  start_def actions_def asig_def trans_def

<span class="keyword1"><span class="command">lemmas</span></span> trans_defs <span class="main">=</span> Inv_def Lin_def Resp_def Init_def
  Abort_def Reco_def

<span class="keyword1"><span class="command">declare</span></span> if_split_asm <span class="main">[</span><span class="operator">split</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A case rule for decomposing the transition relation 
  of the composition of two SLins›</span></span>

<span class="keyword1"><span class="command">declare</span></span> comp_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemma</span></span> trans_elim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>  <span class="free">s</span> <span class="free">t</span> <span class="free">a</span> <span class="free">s'</span> <span class="free">t'</span> <span class="free">P</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">─</span><span class="free">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> 
    <span class="main">(</span>Invoke1<span class="main">)</span> <span class="free">i</span> <span class="free">p</span> <span class="free">c</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Inv <span class="free">p</span> <span class="free">c</span> <span class="free">s</span> <span class="free">s'</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">id1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> Invoke <span class="free">i</span> <span class="free">p</span> <span class="free">c</span>"</span></span>
  <span class="main">|</span> <span class="main">(</span>Invoke2<span class="main">)</span> <span class="free">i</span> <span class="free">p</span> <span class="free">c</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Inv <span class="free">p</span> <span class="free">c</span> <span class="free">t</span> <span class="free">t'</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">id1</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">id2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> Invoke <span class="free">i</span> <span class="free">p</span> <span class="free">c</span>"</span></span>
  <span class="main">|</span> <span class="main">(</span>Switch1<span class="main">)</span> <span class="free">p</span> <span class="free">c</span> <span class="free">av</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Abort <span class="free">p</span> <span class="free">c</span> <span class="free">av</span> <span class="free">s</span> <span class="free">s'</span> <span class="main">∧</span> Init <span class="free">p</span> <span class="free">c</span> <span class="free">av</span> <span class="free">t</span> <span class="free">t'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> Switch <span class="free">id1</span> <span class="free">p</span> <span class="free">c</span> <span class="free">av</span>"</span></span>
  <span class="main">|</span> <span class="main">(</span>Switch2<span class="main">)</span> <span class="free">p</span> <span class="free">c</span> <span class="free">av</span> 
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">∧</span> Abort <span class="free">p</span> <span class="free">c</span> <span class="free">av</span> <span class="free">t</span> <span class="free">t'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> Switch <span class="free">id2</span> <span class="free">p</span> <span class="free">c</span> <span class="free">av</span>"</span></span>
  <span class="main">|</span> <span class="main">(</span>Response1<span class="main">)</span> <span class="free">i</span> <span class="free">p</span> <span class="free">ou</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Resp <span class="free">p</span> <span class="free">ou</span> <span class="free">s</span> <span class="free">s'</span><span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">id1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> Response <span class="free">i</span> <span class="free">p</span> <span class="free">ou</span>"</span></span>
  <span class="main">|</span> <span class="main">(</span>Response2<span class="main">)</span> <span class="free">i</span> <span class="free">p</span> <span class="free">ou</span> 
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Resp <span class="free">p</span> <span class="free">ou</span> <span class="free">t</span> <span class="free">t'</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">id1</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">id2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> Response <span class="free">i</span> <span class="free">p</span> <span class="free">ou</span>"</span></span>
  <span class="main">|</span> <span class="main">(</span>Lin1<span class="main">)</span> <span class="quoted"><span class="quoted">"Lin <span class="free">s</span> <span class="free">s'</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> Linearize <span class="main">0</span>"</span></span>
  <span class="main">|</span> <span class="main">(</span>Lin2<span class="main">)</span> <span class="quoted"><span class="quoted">"Lin <span class="free">t</span> <span class="free">t'</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> Linearize <span class="free">id1</span>"</span></span>
  <span class="main">|</span> <span class="main">(</span>Reco2<span class="main">)</span> <span class="quoted"><span class="quoted">"Reco <span class="free">t</span> <span class="free">t'</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> Recover <span class="free">id1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">%</span>invisible <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invoke <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Inv <span class="skolem">p</span> <span class="skolem">c</span> <span class="free">s</span> <span class="free">s'</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">id1</span><span class="main">)</span>
      <span class="main">∨</span> <span class="main">(</span>Inv <span class="skolem">p</span> <span class="skolem">c</span> <span class="free">t</span> <span class="free">t'</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">∧</span> <span class="free">id1</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">id2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Invoke that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Response <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">ou</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Resp <span class="skolem">p</span> <span class="skolem">ou</span> <span class="free">s</span> <span class="free">s'</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">id1</span><span class="main">)</span>
      <span class="main">∨</span> <span class="main">(</span>Resp <span class="skolem">p</span> <span class="skolem">ou</span> <span class="free">t</span> <span class="free">t'</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">∧</span> <span class="free">id1</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">id2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Response that <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Switch <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">av</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms ids <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">id1</span> <span class="main">∧</span> Abort <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">av</span> <span class="free">s</span> <span class="free">s'</span><span class="main">∧</span> Init <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">av</span> <span class="free">t</span> <span class="free">t'</span><span class="main">)</span>
       <span class="main">∨</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">id2</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">∧</span> Abort <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">av</span> <span class="free">t</span> <span class="free">t'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Switch that <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Linearize <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Lin <span class="free">s</span> <span class="free">s'</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> 
      <span class="main">∨</span> <span class="main">(</span>Lin <span class="free">t</span> <span class="free">t'</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">id1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Linearize that <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recover <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"Reco <span class="free">t</span> <span class="free">t'</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">=</span> Recover <span class="free">id1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Recover that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">declare</span></span> comp_simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of the Refinement Mapping›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state <span class="main">*</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">⦇</span>pending <span class="main">=</span> <span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> status <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">p</span> <span class="main">≠</span> Aborted <span class="keyword1">then</span> pending <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">p</span> <span class="keyword1">else</span> pending <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">,</span>
      initVals <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
      abortVals <span class="main">=</span> abortVals <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span>
      status <span class="main">=</span> <span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> status <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">p</span> <span class="main">≠</span> Aborted <span class="keyword1">then</span> status <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">p</span> <span class="keyword1">else</span> status <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">,</span>
      dstate <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> dstate <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="main"><span class="free">⊥</span></span> <span class="keyword1">then</span> dstate <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="keyword1">else</span> dstate <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span><span class="main">,</span>
      initialized <span class="main">=</span> True<span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1"><span class="command">declare</span></span> 
  trans_defs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">.</span> status <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span>Pending<span class="main">,</span> Aborted<span class="main">}</span> 
    <span class="main">⟶</span> fst <span class="main">(</span>pending <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P2</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">.</span> status <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="bound">p</span> <span class="main">≠</span> Sleep <span class="main">⟶</span> fst <span class="main">(</span>pending <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P3</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P3</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">.</span> <span class="main">(</span>status <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="bound">p</span> <span class="main">=</span> Ready <span class="main">⟶</span> initialized <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Used to prove P19 only *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P4</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P4</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">.</span> status <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="bound">p</span> <span class="main">=</span> Sleep<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>initVals <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P5</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P5</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">.</span> status <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">p</span> <span class="main">≠</span> Sleep <span class="main">∧</span> initialized <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">∧</span> initVals <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P6</span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P6</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">.</span> <span class="main">(</span>status <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">p</span> <span class="main">≠</span> Aborted<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>status <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="bound">p</span> <span class="main">=</span> Sleep<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P7</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P7</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">.</span> status <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">c</span> <span class="main">=</span> Aborted <span class="main">∧</span> <span class="main">¬</span> initialized <span class="free"><span class="bound"><span class="entity">s2</span></span></span> 
    <span class="main">⟶</span> <span class="main">(</span>pending <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="bound">c</span> <span class="main">=</span> pending <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">c</span> <span class="main">∧</span> status <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="bound">c</span> <span class="main">∈</span> <span class="main">{</span>Pending<span class="main">,</span> Aborted<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Only used in the proof of P8a *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P8</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P8</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">iv</span> <span class="main">∈</span> initVals <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">rs</span> <span class="main">∈</span> pendingSeqs <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">.</span> 
    <span class="bound">iv</span> <span class="main">=</span> dstate <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">⋆</span> <span class="bound">rs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P8a</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P8a</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">ivs</span> <span class="main">∈</span> initSets <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">rs</span> <span class="main">∈</span> pendingSeqs <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">.</span> 
    <span class="main">⨅</span><span class="bound">ivs</span> <span class="main">=</span> dstate <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">⋆</span> <span class="bound">rs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P9</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">P9</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>initialized <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">⟶</span> dstate <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">≼</span> dstate <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P10</span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P10</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">¬</span> initialized <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>dstate <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="main"><span class="free">⊥</span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P11</span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P11</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>initVals <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> abortVals <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P12</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P12</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>initialized <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">⟶</span> <span class="main">⨅</span> <span class="main">(</span>initVals <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">≼</span> dstate <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P13</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P13</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>finite <span class="main">(</span>initVals <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>
    <span class="main">∧</span> finite <span class="main">(</span>abortVals <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>abortVals <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P14</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P14</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>initialized <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">⟶</span> initVals <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P15</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P15</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">av</span> <span class="main">∈</span> abortVals <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">.</span> dstate <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">≼</span> <span class="bound">av</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P16</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P16</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dstate <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">≠</span> <span class="main"><span class="free">⊥</span></span> <span class="main">⟶</span> initialized <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P17</span> <span class="keyword2"><span class="keyword">where</span></span>                                                         
<span class="comment1">― ‹For the Response1 case of the refinement proof, in case a response
  is produced in the first instance and the second instance is already
  initialized›</span>
  <span class="quoted"><span class="quoted">"<span class="free">P17</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>initialized <span class="free"><span class="bound"><span class="entity">s2</span></span></span> 
    <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">.</span> 
      <span class="main">(</span><span class="main">(</span>status <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">p</span> <span class="main">=</span> Ready 
        <span class="main">∨</span> <span class="main">(</span>status <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">p</span> <span class="main">=</span> Pending <span class="main">∧</span> contains <span class="main">(</span>dstate <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span> <span class="main">(</span>pending <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
          <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> dstate <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> dstate <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">⋆</span> <span class="bound">rs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="bound">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">(</span>status <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">p</span> <span class="main">=</span> Pending <span class="main">∧</span> <span class="main">¬</span> contains <span class="main">(</span>dstate <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span> <span class="main">(</span>pending <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> dstate <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> dstate <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">⋆</span> <span class="bound">rs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="bound">rs</span> <span class="main">.</span> 
          fst <span class="bound">r</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> pending <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Only used for proving P19 *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P18</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P18</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>abortVals <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">p</span> <span class="main">.</span> status <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="bound">p</span> <span class="main">≠</span> Sleep<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P19</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P19</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>abortVals <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> abortVals <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P20</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P20</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">av</span> <span class="main">∈</span> abortVals <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">.</span> dstate <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">≼</span> <span class="bound">av</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P21</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P21</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">av</span> <span class="main">∈</span> abortVals <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">.</span> <span class="main">⨅</span><span class="main">(</span>abortVals <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span> <span class="main">≼</span> <span class="bound">av</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P22</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P22</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>initialized <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">⟶</span> dstate <span class="main">(</span>f <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dstate <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P23</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P23</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">¬</span> initialized <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">⟶</span> 
    pendingSeqs <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">⊆</span> pendingSeqs <span class="main">(</span>f <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P25</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P25</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">ivs</span> <span class="main">.</span> <span class="main">(</span><span class="bound">ivs</span> <span class="main">∈</span> initSets <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">∧</span> initialized <span class="free"><span class="bound"><span class="entity">s2</span></span></span> 
    <span class="main">∧</span> dstate <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">≼</span> <span class="main">⨅</span><span class="bound">ivs</span><span class="main">)</span>
      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">rs'</span> <span class="main">∈</span> pendingSeqs <span class="main">(</span>f <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> <span class="main">⨅</span><span class="bound">ivs</span> <span class="main">=</span> dstate <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">⋆</span> <span class="bound">rs'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P26</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P26</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">.</span> <span class="main">(</span>status <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">p</span> <span class="main">=</span> Aborted 
    <span class="main">∧</span> <span class="main">¬</span> contains <span class="main">(</span>dstate <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">(</span>pending <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>
      <span class="main">⟶</span> <span class="main">(</span>status <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span>Pending<span class="main">,</span>Aborted<span class="main">}</span> 
        <span class="main">∧</span> pending <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">p</span> <span class="main">=</span> pending <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P1_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P1"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P1 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P1 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P1 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P2_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P2"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P2 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P2 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P2 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main">)</span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P16_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P16"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P16 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P16 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P16 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main">)</span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P3_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P3"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P3 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P3 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P3 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P4_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P4"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P4 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P4 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P4 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main">)</span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P5_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P5"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P5 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P5 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P5 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> P13_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P13"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P13 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P13 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P13 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P20_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P20"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P20 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P20 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span>composition<span class="main">)</span> <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> reach <span class="keyword1"><span class="command">have</span></span> P16<span class="main">:</span><span class="quoted"><span class="quoted">"P16 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P16_invariant <span class="keyword2"><span class="keyword">and</span></span> ids
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P20 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp <span class="keyword2"><span class="keyword">and</span></span> P16
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>safeInits_def safeAborts_def
    initAborts_def uninitAborts_def bot<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P18_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P18"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P18 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P18 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P18 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P14_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P14"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P14 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P14 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P14 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>safeInits_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P15_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P15"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P15 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P15 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span>composition<span class="main">)</span> <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> reach <span class="keyword1"><span class="command">have</span></span> P5<span class="main">:</span><span class="quoted"><span class="quoted">"P5 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P5_invariant <span class="keyword2"><span class="keyword">and</span></span> ids
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P15 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp <span class="keyword2"><span class="keyword">and</span></span> P5
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main"><span class="keyword3">,</span></span> 
    <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>less_eq_def safeAborts_def initAborts_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P6_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P6"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P6 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P6 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P6 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P7_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P7"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P7 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P7 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P7 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P10_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P10"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P10 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P10 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P10 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P11_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P11"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P11 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P11 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P11 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> P8_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P8"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span>composition<span class="main">)</span> <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> reach <span class="keyword1"><span class="command">have</span></span> P5<span class="main">:</span><span class="quoted"><span class="quoted">"P5 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P5_invariant <span class="keyword2"><span class="keyword">and</span></span> ids
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> reach <span class="keyword1"><span class="command">have</span></span> P1<span class="main">:</span><span class="quoted"><span class="quoted">"P1 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P1_invariant <span class="keyword2"><span class="keyword">and</span></span> ids
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> reach <span class="keyword1"><span class="command">have</span></span> P11<span class="main">:</span><span class="quoted"><span class="quoted">"P11 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P11_invariant <span class="keyword2"><span class="keyword">and</span></span> ids
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invoke1 <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pendingSeqs <span class="skolem">s1</span> <span class="main">⊆</span> pendingSeqs <span class="skolem">t1</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pending <span class="skolem">t1</span> <span class="main">=</span> <span class="main">(</span>pending <span class="skolem">s1</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"status <span class="skolem">t1</span> <span class="main">=</span> <span class="main">(</span>status <span class="skolem">s1</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> Pending<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> Ready"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Invoke1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pendingReqs <span class="skolem">s1</span> <span class="main">⊆</span> pendingReqs <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingReqs_def<span class="main">)</span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingSeqs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"initVals <span class="skolem">t2</span> <span class="main">=</span> initVals <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">t1</span> <span class="main">=</span> dstate <span class="skolem">s1</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Invoke1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P8 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Lin1
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">iv</span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">iv</span> <span class="main">∈</span> initVals <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">iv</span> <span class="main">∈</span> initVals <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Lin1<span class="main">(</span>1<span class="main">)</span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">iv</span> <span class="main">∈</span> abortVals <span class="skolem">s1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 P11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">iv</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P8 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t1</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs'</span> <span class="main">≼</span> <span class="skolem">iv</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Lin1<span class="main">(</span>1<span class="main">)</span> 1 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">iv</span> <span class="main">=</span> <span class="main">(</span>dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs'</span><span class="main">)</span> <span class="main">⋆</span> <span class="skolem">rs''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 8<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="skolem">rs''</span> <span class="main">⊆</span> set <span class="skolem">rs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> consistency 3 5 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> less_eq_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs''</span> <span class="main">∈</span> pendingSeqs <span class="skolem">t1</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span><span class="quoted"><span class="quoted">"pendingSeqs <span class="skolem">t1</span> <span class="main">=</span> pendingSeqs <span class="skolem">s1</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> Lin1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingSeqs_def pendingReqs_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 8 2  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingSeqs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">t1</span> <span class="main">.</span> <span class="skolem">iv</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="bound">rs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 7 10 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Response1 <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">ou</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span><span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">iv</span> 
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">iv</span> <span class="main">∈</span> initVals <span class="skolem">t2</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">iv</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 Response1<span class="main">(</span>1<span class="main">)</span> ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"pendingReqs <span class="skolem">t1</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>pendingReqs <span class="skolem">s1</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>pending <span class="skolem">s1</span> <span class="skolem">p</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pending <span class="skolem">t1</span> <span class="main">=</span> pending <span class="skolem">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"status <span class="skolem">t1</span> <span class="main">=</span> <span class="main">(</span>status <span class="skolem">s1</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> Ready<span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> Pending"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Response1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">q</span> <span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="skolem">p</span> <span class="main">⟹</span> status <span class="skolem">s1</span> <span class="bound">q</span> <span class="main">∈</span> <span class="main">{</span>Pending<span class="main">,</span>Aborted<span class="main">}</span> 
          <span class="main">⟹</span> pending <span class="skolem">s1</span> <span class="bound">q</span> <span class="main">≠</span> pending <span class="skolem">s1</span> <span class="skolem">p</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> P1 5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> P1.simps insertI1<span class="main">)</span> 
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingReqs_def<span class="main">)</span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>        
      <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span><span class="quoted"><span class="quoted">"contains <span class="main">(</span>dstate <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">s1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Response1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">(</span>pending <span class="skolem">s1</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="skolem">rs</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs'</span> <span class="main">∈</span> pendingSeqs <span class="skolem">t1</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span><span class="quoted"><span class="quoted">"pending <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">∉</span> set <span class="skolem">rs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>rs'_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs'</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>rs'_def<span class="main">)</span> 
            <span class="main">(</span><span class="operator">metis</span> filter_is_subset mem_Collect_eq pendingSeqs_def subset_trans<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 10 9 4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingSeqs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">iv</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="skolem">rs'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 8 2 idem_star rs'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>   
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">t1</span> <span class="main">.</span> <span class="skolem">iv</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="bound">rs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Switch1 <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">av</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"initialized <span class="skolem">s1</span> <span class="main">∧</span> initVals <span class="skolem">s1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">av</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"initVals <span class="skolem">t2</span> <span class="main">=</span> initVals <span class="skolem">s2</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">av</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">av</span> <span class="main">∈</span> safeAborts <span class="skolem">s1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Switch1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">av</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>safeAborts_def initAborts_def initSets_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">s1</span> <span class="main">=</span> dstate <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Switch1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"pendingSeqs <span class="skolem">t1</span> <span class="main">=</span> pendingSeqs <span class="skolem">s1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pendingReqs <span class="skolem">t1</span> <span class="main">=</span> pendingReqs <span class="skolem">s1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Switch1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingReqs_def<span class="main">)</span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingSeqs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P8 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> 2 4 5 6 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invoke2 <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Invoke2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Lin2
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Lin2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Response2 <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">ou</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Response2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Switch2 <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">av</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Switch2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Reco2
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Reco2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P8a_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P8a"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>invariant_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">ivs</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"reachable <span class="main">(</span>composition<span class="main">)</span> <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ivs</span> <span class="main">∈</span> initSets <span class="skolem">s2</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"finite <span class="skolem">ivs</span> <span class="main">∧</span> <span class="skolem">ivs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P13 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P13_invariant 1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>initSets_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">av</span> <span class="main">∈</span> <span class="skolem">ivs</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s1</span> <span class="main">.</span> <span class="bound">av</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="bound">rs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> P8<span class="main">:</span><span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P8_invariant 1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>initSets_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s1</span> <span class="main">.</span> <span class="main">⨅</span><span class="skolem">ivs</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="bound">rs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> 3 4 glb_common_set <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingSeqs_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P12_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P12"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span>composition<span class="main">)</span> <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> reach <span class="keyword1"><span class="command">have</span></span> P13<span class="main">:</span><span class="quoted"><span class="quoted">"P13 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P13_invariant
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> reach <span class="keyword1"><span class="command">have</span></span> P14<span class="main">:</span><span class="quoted"><span class="quoted">"P14 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P14_invariant
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invoke1 <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Invoke1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Lin1
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Lin1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Response1 <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">ou</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Response1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Switch1 <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">av</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span><span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"initialized <span class="skolem">s2</span> <span class="main">⟹</span> <span class="main">⨅</span> <span class="main">(</span>initVals <span class="skolem">t2</span><span class="main">)</span> <span class="main">≼</span> <span class="main">⨅</span> <span class="main">(</span>initVals <span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"initialized <span class="skolem">s2</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"initVals <span class="skolem">t2</span> <span class="main">=</span> initVals <span class="skolem">s2</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">av</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Switch1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span> <span class="main">(</span>initVals <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> <span class="main">⨅</span> <span class="main">(</span>initVals <span class="skolem">s2</span><span class="main">)</span> <span class="main">⊓</span> <span class="skolem">av</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> insert_not_elem P13 P14 1
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> P13.simps P14.simps Un_empty_right Un_insert_right commute insert<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cobounded1<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"initialized <span class="skolem">s2</span> <span class="main">=</span> initialized <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Switch1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> absorb2 coboundedI1<span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invoke2 <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Invoke2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Lin2
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"initVals <span class="skolem">t2</span> <span class="main">=</span> initVals <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"initialized <span class="skolem">s2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"initialized <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Lin2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span> <span class="main">≼</span> dstate <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Lin2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> less_eq_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> strict_iff_order strict_trans1<span class="main">)</span>  
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Response2 <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">ou</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Response2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Switch2 <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">av</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Switch2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Reco2
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> safeInits <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Reco2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ivs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ivs</span> <span class="main">⊆</span> initVals <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ivs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⨅</span><span class="skolem">ivs</span> <span class="main">≼</span> <span class="skolem">d</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>safeInits_def initSets_def<span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> equals0D less_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⨅</span> <span class="main">(</span>initVals <span class="skolem">s2</span><span class="main">)</span> <span class="main">≼</span> <span class="main">⨅</span> <span class="skolem">ivs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 P13 4
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_imp<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"initVals <span class="skolem">s2</span> <span class="main">=</span> initVals <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Reco2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 5 6 7 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> P12.simps absorb2 coboundedI1<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P19_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P19"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>invariant_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"reachable <span class="main">(</span>composition<span class="main">)</span> <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> P4<span class="main">:</span><span class="quoted"><span class="quoted">"P4 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P4_invariant 1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>invariant_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> P18<span class="main">:</span><span class="quoted"><span class="quoted">"P18 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P18_invariant 1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> P11<span class="main">:</span><span class="quoted"><span class="quoted">"P11 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P11_invariant 1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">ultimately</span></span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P19 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P9_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P9"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>invariant_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"reachable <span class="main">(</span>composition<span class="main">)</span> <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> P12<span class="main">:</span><span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P12_invariant 1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>invariant_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> P15<span class="main">:</span><span class="quoted"><span class="quoted">"P15 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P15_invariant 1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> P13<span class="main">:</span><span class="quoted"><span class="quoted">"P13 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P13_invariant 1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> P14<span class="main">:</span><span class="quoted"><span class="quoted">"P14 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P14_invariant 1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> P11<span class="main">:</span><span class="quoted"><span class="quoted">"P11 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P11_invariant 1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"initialized <span class="skolem">s2</span> <span class="main">⟹</span> dstate <span class="skolem">s1</span> <span class="main">≼</span> <span class="main">⨅</span><span class="main">(</span>abortVals <span class="skolem">s1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> P13 P15 P14 P11 boundedI <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P9 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P12 P11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> trans<span class="main">)</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P17_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P17"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> reach<span class="main">:</span><span class="quoted"><span class="quoted">"reachable <span class="main">(</span>composition<span class="main">)</span> <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invoke1 <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Invoke1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Response1 <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">ou</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Response1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Switch1 <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">av</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Switch1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invoke2 <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Invoke2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Response2 <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">ou</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Response2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Switch2 <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">av</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Switch2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Lin1
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t1</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Lin1<span class="main">(</span>1<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span> <span class="main">=</span> dstate <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Lin1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"initialized <span class="skolem">t2</span> <span class="main">⟹</span> dstate <span class="skolem">t1</span> <span class="main">≼</span> dstate <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"initialized <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P9 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach trans P9_invariant
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def reachable_n<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"initialized <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">t1</span> <span class="skolem">p</span> <span class="main">=</span> Ready"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 8<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span> 
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 5 6 Lin1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Lin1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t1</span> <span class="main">≼</span> dstate <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 10<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="skolem">rs''</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> 11<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="skolem">rs''</span> <span class="main">⊆</span> set <span class="skolem">rs</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> consistency 2 8 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> less_eq_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs''</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="bound">rs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="bound">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 10 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"initialized <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">t1</span> <span class="skolem">p</span> <span class="main">=</span> Pending"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span> contains <span class="main">(</span>dstate <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">t1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 8<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> pending <span class="skolem">s1</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 9<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span> contains <span class="main">(</span>dstate <span class="skolem">s1</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">s1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 7 Lin1<span class="main">(</span>1<span class="main">)</span> contains_star <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span> 
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> pending <span class="skolem">s1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> 1 5 6 9 Lin1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> pending <span class="skolem">s1</span> <span class="skolem">p</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Lin1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t1</span> <span class="main">≼</span> dstate <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 11<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="skolem">rs''</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> 12<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="skolem">rs''</span> <span class="main">⊆</span> set <span class="skolem">rs</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> consistency 2 9 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> less_eq_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 13<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs''</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> pending <span class="skolem">s1</span> <span class="skolem">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> 8 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="bound">rs</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="bound">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> pending <span class="skolem">t1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 11 13 Lin1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"initialized <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">t1</span> <span class="skolem">p</span> <span class="main">=</span> Pending"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"contains <span class="main">(</span>dstate <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">t1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="bound">rs</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="bound">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"contains <span class="main">(</span>dstate <span class="skolem">s1</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">s1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 8<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> 9<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span> 
            <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 5 6 True Lin1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Lin1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t1</span> <span class="main">≼</span> dstate <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 11<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="skolem">rs''</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> 12<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="skolem">rs''</span> <span class="main">⊆</span> set <span class="skolem">rs</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> consistency 2 9 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> less_eq_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> 13<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs''</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 8 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="bound">rs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="bound">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 11 13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 8<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="skolem">rs''</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> 9<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs''</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> pending <span class="skolem">t1</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 8<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> pending <span class="skolem">s1</span> <span class="skolem">p</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> 9<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span> 
              <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs</span> <span class="main">.</span> fst <span class="bound">r</span>  <span class="main">=</span> <span class="skolem">p</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> pending <span class="skolem">s1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> 1 5 6 False Lin1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs</span> <span class="main">.</span> fst <span class="bound">r</span>  <span class="main">=</span> <span class="skolem">p</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> pending <span class="skolem">s1</span> <span class="skolem">p</span>"</span></span> 
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> Lin1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t1</span> <span class="main">≼</span> dstate <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 11<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="skolem">rs''</span>"</span></span> 
            <span class="keyword2"><span class="keyword">and</span></span> 12<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="skolem">rs''</span> <span class="main">⊆</span> set <span class="skolem">rs</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> consistency 2 9 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> less_eq_def<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> 13<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs''</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> pending <span class="skolem">s1</span> <span class="skolem">p</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> 8 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="skolem">rs''</span>
            <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs''</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> pending <span class="skolem">t1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> 11 13 Lin1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="skolem">rs''</span> 
          <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="bound">r</span> <span class="main">.</span> <span class="bound">r</span> <span class="main">≠</span> pending <span class="skolem">t1</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">rs''</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 7 idem_star <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="bound">r</span> <span class="main">.</span> <span class="bound">r</span> <span class="main">≠</span> pending <span class="skolem">t1</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">rs''</span><span class="main">)</span> <span class="main">.</span> 
          fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="bound">rs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="bound">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 8 10 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Lin2
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">≠</span> Aborted"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs'</span> <span class="main">.</span> dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">s2</span> <span class="main">⋆</span> <span class="bound">rs'</span>
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="bound">rs'</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">s2</span> <span class="main">⋆</span> <span class="skolem">rs'</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs'</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Lin2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs'</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set <span class="skolem">rs'</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> 6 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> pendingReqs <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingSeqs_def<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P2 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P2_invariant 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invariant_def<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"status <span class="skolem">s2</span> <span class="skolem">p</span> <span class="main">=</span> Sleep"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P6 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P6_invariant 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invariant_def<span class="main">)</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 Lin2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingReqs_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 5 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">note</span></span> a <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"initialized <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">t1</span> <span class="skolem">p</span> <span class="main">=</span> Ready"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"initialized <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> Ready"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> Lin2<span class="main">(</span>1<span class="main">)</span> 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">s2</span> <span class="main">⋆</span> <span class="skolem">rs'</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs'</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a 3 Lin2<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> SLin_status.distinct<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="bound">rs</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="bound">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Lin2<span class="main">(</span>1<span class="main">)</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> UnE exec_append set_append<span class="main">)</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"initialized <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">t1</span> <span class="skolem">p</span> <span class="main">=</span> Pending"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"contains <span class="main">(</span>dstate <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">t1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"initialized <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> Pending
          <span class="main">∧</span> contains <span class="main">(</span>dstate <span class="skolem">s1</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">s1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> Lin2<span class="main">(</span>1<span class="main">)</span> 2 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">s2</span> <span class="main">⋆</span> <span class="skolem">rs'</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs'</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a 3 Lin2<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> SLin_status.distinct<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="bound">rs</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="bound">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Lin2<span class="main">(</span>1<span class="main">)</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> UnE exec_append set_append<span class="main">)</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"initialized <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">t1</span> <span class="skolem">p</span> <span class="main">=</span> Pending"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span> contains <span class="main">(</span>dstate <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">t1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> pending <span class="skolem">s1</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"initialized <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> Pending
          <span class="main">∧</span> <span class="main">¬</span> contains <span class="main">(</span>dstate <span class="skolem">s1</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">s1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> Lin2<span class="main">(</span>1<span class="main">)</span> 2 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">s2</span> <span class="main">⋆</span> <span class="skolem">rs'</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs'</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a 3 Lin2<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> SLin_status.distinct<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="bound">rs</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="bound">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> pending <span class="skolem">t1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> Lin2<span class="main">(</span>1<span class="main">)</span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> UnE exec_append set_append<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Reco2
    <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="skolem">rs'</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="skolem">rs'</span> <span class="main">⊆</span> pendingReqs <span class="skolem">s1</span> <span class="main">∪</span> pendingReqs <span class="skolem">s2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ivs</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ivs</span> <span class="main">⊆</span> initVals <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ivs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> <span class="main">⨅</span><span class="skolem">ivs</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Reco2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>safeInits_def initSets_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">rs''</span> <span class="main">⊆</span> pendingReqs <span class="skolem">s1</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span><span class="skolem">ivs</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs''</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P8a <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P8a_invariant
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invariant_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">using</span></span> 1 2 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>initSets_def pendingSeqs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="main">(</span><span class="skolem">rs''</span><span class="main">@</span><span class="skolem">rs</span><span class="main">)</span> 
        <span class="main">∧</span> set <span class="skolem">rs''</span> <span class="main">⊆</span> pendingReqs <span class="skolem">s1</span> 
          <span class="main">∧</span> set <span class="skolem">rs</span> <span class="main">⊆</span> pendingReqs <span class="skolem">s2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3 4 Reco2<span class="main">(</span>1<span class="main">)</span> 4
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exec_append mem_Collect_eq pendingSeqs_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>        
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">r</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> pendingReqs <span class="skolem">s2</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">≠</span> Aborted"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P2 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P2_invariant
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invariant_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P6 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P6_invariant
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invariant_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 Reco2<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingReqs_def<span class="main">)</span>
            <span class="main">(</span><span class="operator">metis</span> SLin_status.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span> 
        <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> 3 <span class="main">=</span> this                
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> pendingReqs <span class="skolem">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> Pending"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> pending <span class="skolem">s1</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P1 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P1_invariant
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invariant_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingReqs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> 10 <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">t1</span> <span class="skolem">p</span> <span class="main">=</span> Ready"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="bound">rs</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="bound">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
          <span class="keyword3"><span class="command">assume</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> pendingReqs <span class="skolem">s1</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P1 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P1_invariant
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invariant_def<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> 4 5 Reco2<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingReqs_def<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> pendingReqs <span class="skolem">s2</span> <span class="main">⟹</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3 4 Reco2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">t1</span> <span class="skolem">p</span> <span class="main">=</span> Pending"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"contains <span class="main">(</span>dstate <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">t1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="bound">rs</span>
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="bound">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span> <span class="bound">r</span> <span class="main">.</span> <span class="bound">r</span> <span class="main">≠</span> pending <span class="skolem">t1</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">rs'</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="var">?rs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 5 1 idem_star <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set <span class="var">?rs</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
              <span class="keyword3"><span class="command">assume</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set <span class="skolem">rs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> pending <span class="skolem">s1</span> <span class="skolem">p</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> pendingReqs <span class="skolem">s2</span> <span class="main">⟹</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> 3 4 Reco2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> pendingReqs <span class="skolem">s1</span> <span class="main">⟹</span> fst <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span>
                  <span class="main">⟹</span> <span class="bound">r</span> <span class="main">=</span> pending <span class="skolem">s1</span> <span class="skolem">p</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> 10 4 Reco2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 6 7 
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> UnE subsetD<span class="main">)</span> 
              <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> set <span class="var">?rs</span>›</span></span> Reco2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">t1</span> <span class="skolem">p</span> <span class="main">=</span> Pending"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span> contains <span class="main">(</span>dstate <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">t1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">t1</span> <span class="main">⋆</span> <span class="bound">rs</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="bound">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> pending <span class="skolem">t1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> pendingReqs <span class="skolem">s2</span> <span class="main">⟹</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3 4 Reco2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> pendingReqs <span class="skolem">s1</span> <span class="main">⟹</span> fst <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span>
          <span class="main">⟹</span> <span class="bound">r</span> <span class="main">=</span> pending <span class="skolem">s1</span> <span class="skolem">p</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 10 4 Reco2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 Reco2<span class="main">(</span>1<span class="main">)</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> UnE rev_subsetD<span class="main">)</span> 
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>   
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P21_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P21"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P21 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P21 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span>composition<span class="main">)</span> <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P21 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"initialized <span class="skolem">t2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> P12<span class="main">:</span><span class="quoted"><span class="quoted">"P12 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P12_invariant reach trans
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invariant_def reachable_n<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> P11<span class="main">:</span><span class="quoted"><span class="quoted">"P11 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P11_invariant reach trans
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def reachable_n<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> P20<span class="main">:</span><span class="quoted"><span class="quoted">"P20 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P20_invariant reach trans
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IOA.invariant_def reachable_n<span class="main">)</span> 
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P21 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="main">(</span><span class="operator">metis</span> pre_RDR.trans<span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P21 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Switch2 <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">av</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">av</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"abortVals <span class="skolem">t2</span> <span class="main">=</span> abortVals <span class="skolem">s2</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">av</span><span class="main">}</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span><span class="main">(</span>abortVals <span class="skolem">s1</span><span class="main">)</span> <span class="main">≼</span> <span class="skolem">av</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ivs</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"abortVals <span class="skolem">t2</span> <span class="main">=</span> abortVals <span class="skolem">s2</span> <span class="main">∪</span> <span class="main">{</span><span class="main">⨅</span><span class="skolem">ivs</span> <span class="main">⋆</span> <span class="skolem">rs</span><span class="main">}</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ivs</span> <span class="main">⊆</span> initVals <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ivs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False Switch2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>safeAborts_def
            uninitAborts_def initSets_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⨅</span><span class="main">(</span>abortVals <span class="skolem">s1</span><span class="main">)</span> <span class="main">≼</span> <span class="main">⨅</span><span class="skolem">ivs</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P11 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P11_invariant
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invariant_def<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P13 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P13_invariant
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invariant_def<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_imp<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that 1 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="main">(</span><span class="operator">metis</span> coboundedI2 less_eq_def orderE<span class="main">)</span> 
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> hyp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Switch2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Switch1 <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">av</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"abortVals <span class="skolem">s1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span> <span class="main">(</span>abortVals <span class="skolem">t1</span><span class="main">)</span> <span class="main">≼</span> <span class="main">⨅</span> <span class="main">(</span>abortVals <span class="skolem">s1</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">av</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"abortVals <span class="skolem">t1</span> <span class="main">=</span> abortVals <span class="skolem">s1</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">av</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Switch1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P13 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P13_invariant
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invariant_def<span class="main">)</span> 
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abortVals <span class="skolem">t2</span> <span class="main">=</span> abortVals <span class="skolem">s2</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> Switch1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hyp 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> coboundedI2 orderE<span class="main">)</span>  
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abortVals <span class="skolem">t2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P19 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P19_invariant
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invariant_def<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True Switch1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invoke1 <span class="skolem">p</span> <span class="skolem">c</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invoke2 <span class="skolem">p</span> <span class="skolem">c</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Response1 <span class="skolem">p</span> <span class="skolem">ou</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Response2 <span class="skolem">p</span> <span class="skolem">ou</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Lin1
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Lin2
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Reco2
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P22_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P22"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>invariant_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"reachable <span class="main">(</span>composition<span class="main">)</span> <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> P9<span class="main">:</span><span class="quoted"><span class="quoted">"P9 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P9_invariant 1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>invariant_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P22 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>P22.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"initialized <span class="skolem">s2</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dstate <span class="main">(</span>f <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dstate <span class="skolem">s2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span> <span class="main">=</span> <span class="main"><span class="free">⊥</span></span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dstate  <span class="main">(</span>f <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dstate <span class="skolem">s2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">s1</span> <span class="main">≼</span> dstate <span class="skolem">s2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹initialized <span class="skolem">s2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹P9 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">s1</span> <span class="main">=</span> dstate <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> antisym bot<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P23_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P23"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>invariant_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"reachable <span class="main">(</span>composition<span class="main">)</span> <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P23 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>P23.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rs</span>
    <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span>initialized <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs</span><span class="main">∈</span>pendingSeqs <span class="skolem">s1</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span><span class="main">∈</span> pendingSeqs <span class="main">(</span>f <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
        <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> pendingReqs <span class="skolem">s1</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="main">(</span>fst <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> Pending <span class="main">∨</span> status <span class="skolem">s1</span> <span class="main">(</span>fst <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> Aborted"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"pending <span class="skolem">s1</span> <span class="main">(</span>fst <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P1 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 P1_invariant
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invariant_def<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="main">(</span>fst <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> Pending <span class="main">∨</span> status <span class="skolem">s1</span> <span class="main">(</span>fst <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> Aborted"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pending <span class="skolem">s1</span> <span class="main">(</span>fst <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingReqs_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> pendingReqs <span class="main">(</span>f <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="main">(</span>fst <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> Pending"</span></span>
          <span class="keyword1"><span class="command">with</span></span> 5 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingReqs_def<span class="main">)</span>
            <span class="main">(</span><span class="operator">metis</span> SLin_status.distinct<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span> 
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="main">(</span>fst <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> Aborted"</span></span>
          <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"pending <span class="skolem">s1</span> <span class="main">(</span>fst <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> pending <span class="skolem">s2</span> <span class="main">(</span>fst <span class="skolem">r</span><span class="main">)</span>
            <span class="main">∧</span> status <span class="skolem">s2</span> <span class="main">(</span>fst <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span>Pending<span class="main">,</span>Aborted<span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P7 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 P7_invariant
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invariant_def<span class="main">)</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 6 5 7 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingReqs_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>pendingSeqs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P26_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P26"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariantI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"P26 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"P26 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span>composition<span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> reach<span class="main">:</span><span class="quoted"><span class="quoted">"reachable composition <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P26 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans <span class="keyword2"><span class="keyword">and</span></span> hyp
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Lin2
    <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span> <span class="main">≼</span> dstate <span class="skolem">t2</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> less_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> <span class="skolem">s2</span><span class="main">⦇</span>dstate <span class="main">:=</span> dstate <span class="skolem">t2</span><span class="main">⦈</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">=</span> <span class="skolem">t1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Lin2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">t1</span> <span class="skolem">p</span> <span class="main">=</span> Aborted"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span> contains <span class="main">(</span>dstate <span class="skolem">t2</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">t1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> Aborted"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"pending <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> pending <span class="skolem">t1</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span> contains <span class="main">(</span>dstate <span class="skolem">s2</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">s1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 5 7 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> contains_star less_eq_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">s2</span> <span class="skolem">p</span> <span class="main">∈</span> <span class="main">{</span>Pending<span class="main">,</span>Aborted<span class="main">}</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> 9<span class="main">:</span><span class="quoted"><span class="quoted">"pending <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> pending <span class="skolem">s2</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hyp 6 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>status <span class="skolem">t2</span> <span class="skolem">p</span> <span class="main">=</span> Pending <span class="main">∨</span> status <span class="skolem">t2</span> <span class="skolem">p</span> <span class="main">=</span> Aborted<span class="main">)</span> 
        <span class="main">∧</span> pending <span class="skolem">t1</span> <span class="skolem">p</span> <span class="main">=</span> pending <span class="skolem">t2</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pending <span class="skolem">s2</span> <span class="main">=</span> pending <span class="skolem">t2</span>"</span></span> 
            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"status <span class="skolem">s2</span> <span class="main">=</span> status <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">t2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 9 3 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Reco2
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">t1</span> <span class="skolem">p</span> <span class="main">=</span> Aborted"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> Aborted"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span>initialized <span class="skolem">s2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 Reco2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"P7 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P7_invariant
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invariant_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">s2</span> <span class="skolem">p</span> <span class="main">∈</span> <span class="main">{</span>Pending<span class="main">,</span>Aborted<span class="main">}</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"pending <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> pending <span class="skolem">s2</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 4 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>status <span class="skolem">t2</span> <span class="skolem">p</span> <span class="main">=</span> Pending <span class="main">∨</span> status <span class="skolem">t2</span> <span class="skolem">p</span> <span class="main">=</span> Aborted<span class="main">)</span> 
        <span class="main">∧</span> pending <span class="skolem">t1</span> <span class="skolem">p</span> <span class="main">=</span> pending <span class="skolem">t2</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 6 Reco2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Lin1
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Response1
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Response2
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Invoke2
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Switch1
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Switch2
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Invoke1
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P25_invariant<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>composition<span class="main">)</span> P25"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>invariant_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> reach<span class="main">:</span><span class="quoted"><span class="quoted">"reachable <span class="main">(</span>composition<span class="main">)</span> <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P25 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>P25.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ivs</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ivs</span> <span class="main">∈</span> initSets <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"initialized <span class="skolem">s2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span> <span class="main">≼</span> <span class="main">⨅</span><span class="skolem">ivs</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span> <span class="main">⋆</span> <span class="skolem">rs'</span> <span class="main">=</span> <span class="main">⨅</span><span class="skolem">ivs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs'</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs'</span> <span class="main">.</span> <span class="main">¬</span> contains <span class="main">(</span>dstate <span class="skolem">s2</span><span class="main">)</span> <span class="bound">r</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">s1</span> <span class="main">≼</span> dstate <span class="skolem">s2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> P9<span class="main">:</span><span class="quoted"><span class="quoted">"P9 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P9_invariant reach
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>invariant_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⨅</span><span class="skolem">ivs</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s1</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> P8a<span class="main">:</span><span class="quoted"><span class="quoted">"P8a <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P8a_invariant reach
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>invariant_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs'</span> <span class="main">.</span> dstate <span class="skolem">s2</span> <span class="main">⋆</span> <span class="bound">rs'</span> <span class="main">=</span> <span class="main">⨅</span> <span class="skolem">ivs</span> <span class="main">∧</span> <span class="bound">rs'</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3 5 6 7 consistency<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">s1</span>"</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span><span class="skolem">ivs</span>"</span></span> <span class="quoted"><span class="skolem">rs</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingSeqs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span><span class="skolem">ivs</span> <span class="main">=</span> dstate <span class="skolem">s2</span> <span class="main">⋆</span> <span class="skolem">rs'</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs'</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">with</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> idem_star2 that 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_Collect_eq pendingSeqs_def subset_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs'</span> <span class="main">∈</span> pendingSeqs <span class="main">(</span>f <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set <span class="skolem">rs'</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 8<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> Pending 
          <span class="main">∨</span> status <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> Aborted"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> 9<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> pending <span class="skolem">s1</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingReqs_def pendingSeqs_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 8 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> pendingReqs <span class="main">(</span>f <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> 
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> Pending"</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 9 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingReqs_def<span class="main">)</span>
            <span class="main">(</span><span class="operator">metis</span> SLin_status.distinct<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> 10<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> Aborted"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"status <span class="main">(</span>f <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> status <span class="skolem">s2</span> <span class="skolem">p</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pending <span class="main">(</span>f <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> pending <span class="skolem">s2</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command">moreover</span></span> 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"status <span class="skolem">s2</span> <span class="skolem">p</span> <span class="main">∈</span> <span class="main">{</span>Pending<span class="main">,</span>Aborted<span class="main">}</span> <span class="main">∧</span> pending <span class="skolem">s2</span> <span class="skolem">p</span> <span class="main">=</span> pending <span class="skolem">s1</span> <span class="skolem">p</span>"</span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> contains <span class="main">(</span>dstate <span class="skolem">s2</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> 6 <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> set <span class="skolem">rs'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">moreover</span></span> 
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P26 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P26_invariant
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invariant_def<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 10 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 9 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>pendingReqs_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span> 
        <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingSeqs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">∈</span> pendingSeqs <span class="main">(</span>f <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> <span class="main">⨅</span><span class="skolem">ivs</span> <span class="main">=</span> dstate <span class="skolem">s2</span> <span class="main">⋆</span> <span class="bound">rs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 4 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of the Idempotence Theorem›</span></span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">%</span>invisible
  hide_asig_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  asig_comp2_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  externals_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  comp_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">theorem</span></span> idempotence<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>composition<span class="main">)</span> <span class="main">=&lt;|</span> <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> same_input_sig<span class="main">:</span><span class="quoted"><span class="quoted">"inp <span class="main">(</span>composition<span class="main">)</span> <span class="main">=</span> inp <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span>"</span></span> 
    <span class="comment1">― ‹First we show that both automata have the same input and output signature›</span>
      <span class="keyword1"><span class="command">using</span></span>  ids <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> same_output_sig<span class="main">:</span><span class="quoted"><span class="quoted">"out <span class="main">(</span>composition<span class="main">)</span> <span class="main">=</span> out <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span>"</span></span> 
    <span class="comment1">― ‹Then we show that output signatures match›</span>
    <span class="keyword1"><span class="command">using</span></span> ids <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"traces <span class="main">(</span>composition<span class="main">)</span> <span class="main">⊆</span> traces <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span>"</span></span>
    <span class="comment1">― ‹Finally we show trace inclusion›</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ext <span class="main">(</span>composition<span class="main">)</span> <span class="main">=</span> ext <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span>"</span></span>  
      <span class="comment1">― ‹First we show that they have the same external signature›</span>
      <span class="keyword1"><span class="command">using</span></span> same_input_sig <span class="keyword2"><span class="keyword">and</span></span> same_output_sig <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ref_map f <span class="main">(</span>composition<span class="main">)</span> <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span>"</span></span>
      <span class="comment1">― ‹Then we show that <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">f_comp</span><span class="antiquote">}</span></span> is a refinement mapping›</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>is_ref_map_def<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>composition<span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"f <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">∈</span> ioa.start <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"ioa.start <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span> <span class="main">=</span> start <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"ioa.start <span class="main">(</span>composition<span class="main">)</span> 
          <span class="main">=</span> start <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">×</span> start <span class="free">id1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>SLin_state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span>SLin_action"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> reach<span class="main">:</span><span class="quoted"><span class="quoted">"reachable <span class="main">(</span>composition<span class="main">)</span> <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="main">─</span><span class="skolem">a</span><span class="main">─</span><span class="main">(</span>composition<span class="main">)</span><span class="main">⟶</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> f <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">=</span> f <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Lemmas and invariants›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pendingReqs <span class="skolem">s2</span> <span class="main">⊆</span> pendingReqs <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P6 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P6_invariant
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> invariant_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingReqs_def u_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">note</span></span> lem1 <span class="main">=</span> this
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"initialized <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P1 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"P1 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P1_invariant
        trans invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> reachable_n<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P6 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"P6 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P6_invariant
        trans invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> reachable_n<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P7 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"P7 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P7_invariant
        trans invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> reachable_n<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"P8 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P8_invariant
        trans invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> reachable_n<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P9 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"P9 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P9_invariant
        trans invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> reachable_n<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P10 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"P10 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P10_invariant
        trans invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> reachable_n<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P13 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"P13 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P13_invariant
        trans invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> reachable_n<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P15 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"P15 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P15_invariant
        trans invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> reachable_n<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P16 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"P16 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P16_invariant
        trans invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> reachable_n<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"P17 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P17_invariant
        trans invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> reachable_n<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P19 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"P19 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P19_invariant
        trans invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> reachable_n<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P21 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"P21 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P21_invariant
        trans invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> reachable_n<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P22 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"P22 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P22_invariant
        trans invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> reachable_n<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P25 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"P25 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P25_invariant
        trans invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> reachable_n<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P8a <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"P8a <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P8a_invariant
        trans invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> reachable_n<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P23 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"P23 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach P23_invariant
        trans invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> reachable_n<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">e</span> <span class="main">.</span> refines <span class="bound">e</span> <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span> <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span> f"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> trans 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trans_elim<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invoke1 <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">c</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">u'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"is_exec_frag_of <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span> <span class="var">?e</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> Ready"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> <span class="skolem">s2</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">=</span> <span class="skolem">s1</span><span class="main">⦇</span>pending <span class="main">:=</span> <span class="main">(</span>pending <span class="skolem">s1</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
            status <span class="main">:=</span> <span class="main">(</span>status <span class="skolem">s1</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> Pending<span class="main">)</span><span class="main">⦈</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Invoke1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">u</span> <span class="skolem">p</span> <span class="main">=</span> Ready"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 u_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">⦇</span>pending <span class="main">:=</span> <span class="main">(</span>pending <span class="skolem">u</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
            status <span class="main">:=</span> <span class="main">(</span>status <span class="skolem">u</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> Pending<span class="main">)</span><span class="main">⦈</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> 2 3 u_def u'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"Inv <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">u</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 6 Invoke1<span class="main">(</span>3<span class="main">)</span> ids <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> ext <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span><span class="main">)</span> <span class="var">?e</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Invoke1<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_def schedule_def filter_act_def<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>refines_def u_def u'_def<span class="main">)</span> 
            <span class="main">(</span><span class="operator">metis</span> fst_conv last_state.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>

        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Invoke2 <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">c</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">u'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"is_exec_frag_of <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span> <span class="var">?e</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">s2</span> <span class="skolem">p</span> <span class="main">=</span> Ready"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">=</span> <span class="skolem">s1</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> <span class="skolem">s2</span><span class="main">⦇</span>pending <span class="main">:=</span> <span class="main">(</span>pending <span class="skolem">s2</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
            status <span class="main">:=</span> <span class="main">(</span>status <span class="skolem">s2</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> Pending<span class="main">)</span><span class="main">⦈</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Invoke2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>   
          <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">u</span> <span class="skolem">p</span> <span class="main">=</span> Ready"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 u_def <span class="quoted"><span class="quoted">‹P6 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">⦇</span>pending <span class="main">:=</span> <span class="main">(</span>pending <span class="skolem">u</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
            status <span class="main">:=</span> <span class="main">(</span>status <span class="skolem">u</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> Pending<span class="main">)</span><span class="main">⦈</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> 2 3 u_def u'_def <span class="quoted"><span class="quoted">‹P6 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"Inv <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">u</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 6 Invoke2<span class="main">(</span>3<span class="main">)</span> ids <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> ext <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span><span class="main">)</span> <span class="var">?e</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Invoke2<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_def schedule_def filter_act_def<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>refines_def u_def u'_def<span class="main">)</span> 
            <span class="main">(</span><span class="operator">metis</span> fst_conv last_state.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>

        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Response2 <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">ou</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">u'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"is_exec_frag_of <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span> <span class="var">?e</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> Aborted <span class="main">∧</span> status <span class="skolem">t1</span> <span class="skolem">p</span> <span class="main">=</span> Aborted"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P6 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹P6 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>›</span></span> 
              Response2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">u</span> <span class="skolem">p</span> <span class="main">=</span> Pending <span class="main">∧</span> initialized <span class="skolem">u</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> 1 Response2<span class="main">(</span>1<span class="main">)</span> u_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span>  3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">⦇</span>status <span class="main">:=</span> <span class="main">(</span>status <span class="skolem">u</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> Ready<span class="main">)</span><span class="main">⦈</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 1 Response2<span class="main">(</span>1<span class="main">)</span> u_def u'_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">u'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ou</span> <span class="main">=</span> <span class="free">γ</span> <span class="main">(</span>dstate <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">u</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∧</span> contains <span class="main">(</span>dstate <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">u</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span> <span class="main">=</span> <span class="main"><span class="free">⊥</span></span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 Response2<span class="main">(</span>1<span class="main">)</span> u_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">s1</span> <span class="main">=</span> dstate <span class="skolem">s2</span>"</span></span> 
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">s1</span> <span class="main">≼</span> dstate <span class="skolem">s2</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> Response2<span class="main">(</span>1<span class="main">)</span>  <span class="quoted"><span class="quoted">‹P9 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> antisym bot<span class="main">)</span> 
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 Response2<span class="main">(</span>1<span class="main">)</span> u_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 3 4 Response2<span class="main">(</span>3<span class="main">)</span> ids <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> ext <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span><span class="main">)</span> <span class="var">?e</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Response2<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> ids 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_def schedule_def filter_act_def<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>refines_def u_def u'_def<span class="main">)</span>
            <span class="main">(</span><span class="operator">metis</span> fst_conv last_state.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>

        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Response1 <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">ou</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">u'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"is_exec_frag_of <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span> <span class="var">?e</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span> <span class="main">=</span> <span class="main"><span class="free">⊥</span></span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">u</span> <span class="skolem">p</span> <span class="main">=</span> Pending <span class="main">∧</span> initialized <span class="skolem">u</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> Response1<span class="main">(</span>1<span class="main">)</span> u_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span>  2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">⦇</span>status <span class="main">:=</span> <span class="main">(</span>status <span class="skolem">u</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> Ready<span class="main">)</span><span class="main">⦈</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Response1<span class="main">(</span>1<span class="main">)</span> u_def u'_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">u'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ou</span> <span class="main">=</span> <span class="free">γ</span> <span class="main">(</span>dstate <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">u</span> <span class="skolem">p</span><span class="main">)</span>
            <span class="main">∧</span> contains <span class="main">(</span>dstate <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">u</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Response1<span class="main">(</span>1<span class="main">)</span> True u_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="quoted"><span class="quoted">‹initialized <span class="skolem">u</span>›</span></span> Response1<span class="main">(</span>3<span class="main">)</span> ids <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">u</span> <span class="skolem">p</span> <span class="main">=</span> Pending <span class="main">∧</span> initialized <span class="skolem">u</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> Response1<span class="main">(</span>1<span class="main">)</span> u_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span>  2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">⦇</span>status <span class="main">:=</span> <span class="main">(</span>status <span class="skolem">u</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> Ready<span class="main">)</span><span class="main">⦈</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Response1<span class="main">(</span>1<span class="main">)</span> u_def u'_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">u'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ou</span> <span class="main">=</span> <span class="free">γ</span> <span class="main">(</span>dstate <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">u</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"contains <span class="main">(</span>dstate <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">u</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"contains <span class="main">(</span>dstate <span class="skolem">s1</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">s1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Response1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"contains <span class="main">(</span>dstate <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">u</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">s1</span> <span class="main">≼</span> dstate <span class="skolem">u</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"initialized <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P16 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> False
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P9 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> u_def False refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"pending <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> pending <span class="skolem">u</span> <span class="skolem">p</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> u_def Response1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                <span class="keyword1"><span class="command">using</span></span> 2 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> contains_star less_eq_def<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">(</span>dstate <span class="skolem">s1</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">s1</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">γ</span> <span class="main">(</span>dstate <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">u</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"pending <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> pending <span class="skolem">u</span> <span class="skolem">p</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> u_def Response1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
              <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">u</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
                <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="skolem">rs</span> <span class="main">.</span> fst <span class="bound">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> 
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">u</span> <span class="main">=</span> dstate <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u_def False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">s1</span> <span class="skolem">p</span> <span class="main">=</span> Pending 
                  <span class="main">∧</span> contains <span class="main">(</span>dstate <span class="skolem">s1</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">s1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> 
                    <span class="keyword1"><span class="command">using</span></span> Response1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
                <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span><span class="quoted"><span class="quoted">"initialized <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹P16 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹P17 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> 6 8 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"fst <span class="main">(</span>pending <span class="skolem">s1</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>  
                <span class="keyword1"><span class="command">using</span></span> Response1<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹P1 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 4 5 6 7 2 idem2_star <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ou</span> <span class="main">=</span> <span class="free">γ</span> <span class="main">(</span>dstate <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>pending <span class="skolem">u</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> Response1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 Response1<span class="main">(</span>3<span class="main">)</span> ids <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> ext <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span><span class="main">)</span> <span class="var">?e</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Response1<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> ids 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_def schedule_def filter_act_def<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>refines_def u_def u'_def<span class="main">)</span>
            <span class="main">(</span><span class="operator">metis</span> fst_conv last_state.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>

        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Reco2<span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="main">[</span><span class="main">(</span>Linearize <span class="main">0</span><span class="main">,</span><span class="skolem">u'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_exec_frag_of <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span> <span class="var">?e</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">u</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">u'</span> <span class="main">=</span> dstate <span class="skolem">u</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span> 
            <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">av</span> <span class="main">∈</span> abortVals <span class="skolem">u</span> <span class="main">.</span> dstate <span class="skolem">u'</span> <span class="main">≼</span> <span class="bound">av</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">rs</span> <span class="main">⊆</span> pendingReqs <span class="skolem">s1</span> <span class="main">∪</span> pendingReqs <span class="skolem">s2</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">av</span> <span class="main">∈</span> abortVals <span class="skolem">s2</span> <span class="main">.</span> dstate <span class="skolem">t2</span> <span class="main">≼</span> <span class="bound">av</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ivs</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ivs</span> <span class="main">⊆</span> initVals <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ivs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> <span class="main">⨅</span><span class="skolem">ivs</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s2</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">av</span> <span class="main">∈</span> abortVals <span class="skolem">s2</span> <span class="main">.</span> dstate <span class="skolem">t2</span> <span class="main">≼</span> <span class="bound">av</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> Reco2<span class="main">(</span>1<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>safeInits_def initSets_def<span class="main">)</span> 
                  <span class="main">(</span><span class="operator">metis</span> all_not_in_conv<span class="main">)</span>
              <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span><span class="skolem">ivs</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs'</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">rs'</span> <span class="main">⊆</span> pendingReqs <span class="skolem">s1</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">iv</span>
                  <span class="keyword3"><span class="command">assume</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">iv</span> <span class="main">∈</span> <span class="skolem">ivs</span>"</span></span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> set <span class="bound">rs</span> <span class="main">⊆</span> pendingReqs <span class="skolem">s1</span> 
                    <span class="main">∧</span> <span class="skolem">iv</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="bound">rs</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P8 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> 7 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                        <span class="main">(</span><span class="operator">metis</span> mem_Collect_eq pendingSeqs_def rev_subsetD<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">ivs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P13 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> 3
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> P13.simps rev_finite_subset<span class="main">)</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that glb_common_set 4
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="main">(</span><span class="skolem">rs'</span><span class="main">@</span><span class="skolem">rs</span><span class="main">)</span>
                <span class="main">∧</span> set <span class="main">(</span><span class="skolem">rs'</span><span class="main">@</span><span class="skolem">rs</span><span class="main">)</span> <span class="main">⊆</span> pendingReqs <span class="skolem">s1</span> <span class="main">∪</span> pendingReqs <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 7
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> Un_commute Un_mono 
                      exec_append mem_Collect_eq pendingSeqs_def set_append<span class="main">)</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pendingReqs <span class="skolem">s1</span> <span class="main">∪</span> pendingReqs <span class="skolem">s2</span> <span class="main">⊆</span> pendingReqs <span class="skolem">u</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹pendingReqs <span class="skolem">s2</span> <span class="main">⊆</span> pendingReqs <span class="skolem">u</span>›</span></span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pendingReqs <span class="skolem">s1</span> <span class="main">⊆</span> pendingReqs <span class="skolem">u</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> Reco2<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹P7 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingReqs_def u_def<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> 
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abortVals <span class="skolem">u</span> <span class="main">=</span> abortVals <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u_def<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">u</span> <span class="main">=</span> dstate <span class="skolem">s1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P16 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span>
              Reco2<span class="main">(</span>1<span class="main">)</span> u_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">u'</span> <span class="main">=</span> dstate <span class="skolem">t2</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> Reco2<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹P22 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u'_def<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingSeqs_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">⦇</span>dstate <span class="main">:=</span> dstate <span class="skolem">u</span> <span class="main">⋆</span> <span class="skolem">rs</span><span class="main">⦈</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 2 Reco2<span class="main">(</span>1<span class="main">)</span> u_def u'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹initialized <span class="skolem">u</span>›</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> ext <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span><span class="main">)</span> <span class="var">?e</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Reco2<span class="main">(</span>2<span class="main">)</span> ids 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_def schedule_def filter_act_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>refines_def u_def u'_def<span class="main">)</span>
            <span class="main">(</span><span class="operator">metis</span> fst_conv last_state.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>

        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Switch1 <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">av</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_exec_frag_of <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span> <span class="var">?e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> ext <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span><span class="main">)</span> <span class="var">?e</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Switch1<span class="main">(</span>2<span class="main">)</span> ids 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_def schedule_def filter_act_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Switch1<span class="main">(</span>1<span class="main">)</span> u_def u'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> refines_def<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ioa <span class="main">0</span> <span class="free">id2</span>"</span></span> <span class="quoted">f</span><span class="main">]</span>
            u_def u'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_state.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fst_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>

        <span class="keyword3"><span class="command">case</span></span> Lin2
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="main">[</span><span class="main">(</span>Linearize <span class="main">0</span><span class="main">,</span><span class="skolem">u'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_exec_frag_of <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span> <span class="var">?e</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">⦇</span>dstate <span class="main">:=</span> dstate <span class="skolem">u'</span><span class="main">⦈</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Lin2<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u_def u'_def<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹initialized <span class="skolem">u</span>›</span></span> 
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">u'</span> <span class="main">=</span> dstate <span class="skolem">u</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">u</span>"</span></span> 
            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">av</span> <span class="main">∈</span> abortVals <span class="skolem">u</span> <span class="main">.</span> dstate <span class="skolem">u'</span> <span class="main">≼</span> <span class="bound">av</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t2</span> <span class="main">=</span> dstate <span class="skolem">s2</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s2</span>"</span></span> 
              <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">av</span> <span class="main">∈</span> abortVals <span class="skolem">s2</span> <span class="main">.</span> dstate <span class="skolem">t2</span> <span class="main">≼</span> <span class="bound">av</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Lin2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">u</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span>  2 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹pendingReqs <span class="skolem">s2</span> <span class="main">⊆</span> pendingReqs <span class="skolem">u</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_Collect_eq pendingSeqs_def subset_trans<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">u'</span> <span class="main">=</span> dstate <span class="skolem">u</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span> 
              <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">av</span> <span class="main">∈</span> abortVals <span class="skolem">u</span> <span class="main">.</span> dstate <span class="skolem">u'</span> <span class="main">≼</span> <span class="bound">av</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">u</span> <span class="main">=</span> dstate <span class="skolem">s2</span> <span class="main">∧</span> dstate <span class="skolem">u'</span> <span class="main">=</span> dstate <span class="skolem">t2</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P22 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹P22 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>›</span></span> Lin2<span class="main">(</span>1<span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u_def u'_def<span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">u'</span> <span class="main">=</span> dstate <span class="skolem">u</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">av</span> <span class="main">∈</span> abortVals <span class="skolem">u</span> <span class="main">.</span> dstate <span class="skolem">u'</span> <span class="main">≼</span> <span class="bound">av</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abortVals <span class="skolem">s2</span> <span class="main">=</span> abortVals <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u_def<span class="main">)</span>
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 7 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that 4 5 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> ext <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span><span class="main">)</span> <span class="var">?e</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Lin2<span class="main">(</span>2<span class="main">)</span> ids 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_def schedule_def filter_act_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>refines_def u_def u'_def<span class="main">)</span>
            <span class="main">(</span><span class="operator">metis</span> fst_conv last_state.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>

        <span class="keyword3"><span class="command">case</span></span> Lin1
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">⦇</span>dstate <span class="main">:=</span> dstate <span class="skolem">u'</span><span class="main">⦈</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Lin1<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u_def u'_def<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"initialized <span class="skolem">s2</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="main">[</span><span class="main">(</span>Linearize <span class="main">0</span><span class="main">,</span><span class="skolem">u'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_exec_frag_of <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span> <span class="var">?e</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u'</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">⦇</span>dstate <span class="main">:=</span> dstate <span class="skolem">u'</span><span class="main">⦈</span>›</span></span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹initialized <span class="skolem">u</span>›</span></span> 
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">u'</span> <span class="main">=</span> dstate <span class="skolem">u</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">u</span>"</span></span> 
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">av</span> <span class="main">∈</span> abortVals <span class="skolem">u</span> <span class="main">.</span> dstate <span class="skolem">u'</span> <span class="main">≼</span> <span class="bound">av</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">t1</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
                <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s1</span>"</span></span> 
                <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">av</span> <span class="main">∈</span> abortVals <span class="skolem">s1</span> <span class="main">.</span> dstate <span class="skolem">t1</span> <span class="main">≼</span> <span class="bound">av</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> Lin1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
              <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"pendingSeqs <span class="skolem">s1</span> <span class="main">⊆</span> pendingSeqs <span class="skolem">u</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹P7 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingReqs_def pendingSeqs_def u_def<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">u</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">∧</span> dstate <span class="skolem">u'</span> <span class="main">=</span> dstate <span class="skolem">t1</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P16 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> False Lin1<span class="main">(</span>1<span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u_def u'_def<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">av</span> <span class="main">∈</span> abortVals <span class="skolem">u</span> <span class="main">.</span> dstate <span class="skolem">u'</span> <span class="main">≼</span> <span class="bound">av</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"abortVals <span class="skolem">u</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> True
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> False
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">u'</span> <span class="main">=</span> dstate <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abortVals <span class="skolem">u</span> <span class="main">=</span> abortVals <span class="skolem">t2</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> Lin1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u_def<span class="main">)</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">t1</span> <span class="main">≼</span> <span class="main">⨅</span><span class="main">(</span>abortVals <span class="skolem">t1</span><span class="main">)</span>"</span></span> 
                <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abortVals <span class="skolem">t1</span> <span class="main">=</span> abortVals <span class="skolem">s1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Lin1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abortVals <span class="skolem">t1</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹P19 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>›</span></span>
                    Lin1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> u_def<span class="main">)</span>
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="quoted"><span class="quoted">‹P13 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>›</span></span>  
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> boundedI<span class="main">)</span> 
                <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P21 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>›</span></span> 3
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> P21.simps coboundedI2 orderE<span class="main">)</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 4 5 6 that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> ext <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span><span class="main">)</span> <span class="var">?e</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Lin1<span class="main">(</span>2<span class="main">)</span> ids 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_def schedule_def filter_act_def<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>refines_def u_def u'_def<span class="main">)</span>
              <span class="main">(</span><span class="operator">metis</span> fst_conv last_state.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snd_conv<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_exec_frag_of <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span> <span class="var">?e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> ext <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span><span class="main">)</span> <span class="var">?e</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Lin1<span class="main">(</span>2<span class="main">)</span> ids 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_def schedule_def filter_act_def<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last_state <span class="var">?e</span> <span class="main">=</span> <span class="skolem">u'</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dstate <span class="skolem">u</span> <span class="main">=</span> dstate <span class="skolem">s2</span> <span class="main">∧</span> dstate <span class="skolem">u'</span> <span class="main">=</span> dstate <span class="skolem">t2</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P22 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹P22 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> True <span class="keyword2"><span class="keyword">and</span></span> Lin1<span class="main">(</span>1<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u_def u'_def<span class="main">)</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Lin1<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">u'</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">⦇</span>dstate <span class="main">:=</span> dstate <span class="skolem">u'</span><span class="main">⦈</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> refines_def<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ioa <span class="main">0</span> <span class="free">id2</span>"</span></span> <span class="quoted">f</span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>u_def u'_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>

        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Switch2 <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">av</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">u'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"is_exec_frag_of <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span> <span class="var">?e</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>        
          <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">⦇</span>abortVals <span class="main">:=</span> <span class="main">(</span>abortVals <span class="skolem">u</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">av</span><span class="main">}</span><span class="main">,</span>
            status <span class="main">:=</span> <span class="main">(</span>status <span class="skolem">u</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> Aborted<span class="main">)</span><span class="main">⦈</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">av</span> <span class="main">∈</span> safeAborts <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">u</span> <span class="skolem">p</span> <span class="main">=</span> Pending"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"pending <span class="skolem">u</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> <span class="skolem">s2</span><span class="main">⦇</span>abortVals <span class="main">:=</span> <span class="main">(</span>abortVals <span class="skolem">s2</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">av</span><span class="main">}</span><span class="main">,</span>
              status <span class="main">:=</span> <span class="main">(</span>status <span class="skolem">s2</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> Aborted<span class="main">)</span><span class="main">⦈</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">av</span> <span class="main">∈</span> safeAborts <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">=</span> <span class="skolem">t1</span>"</span></span> 
              <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">s2</span> <span class="skolem">p</span> <span class="main">=</span> Pending"</span></span>
                <span class="keyword1"><span class="command">using</span></span> Switch2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">u</span> <span class="skolem">p</span> <span class="main">=</span> Pending"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P6 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> 4
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u_def<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"status <span class="skolem">u'</span> <span class="skolem">p</span> <span class="main">=</span> Aborted"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P6 <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">)</span>›</span></span> 1
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u'_def<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pending <span class="skolem">u</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P6 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> 4 Switch2<span class="main">(</span>1<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u_def<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">⦇</span>abortVals <span class="main">:=</span> <span class="main">(</span>abortVals <span class="skolem">u</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">av</span><span class="main">}</span><span class="main">,</span>
              status <span class="main">:=</span> <span class="main">(</span>status <span class="skolem">u</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> Aborted<span class="main">)</span><span class="main">⦈</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 3 5 6
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u_def u'_def<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">av</span> <span class="main">∈</span> safeAborts <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">av</span> <span class="main">∈</span> safeAborts <span class="skolem">u</span>"</span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"initialized <span class="skolem">s2</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">hence</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">u</span> <span class="main">=</span> dstate <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P22 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span>  
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u_def<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s2</span> <span class="main">.</span> <span class="skolem">av</span> <span class="main">=</span> dstate <span class="skolem">s2</span> <span class="main">⋆</span> <span class="bound">rs</span><span class="main">)</span>
              <span class="main">∨</span> <span class="main">(</span>dstate <span class="skolem">s2</span> <span class="main">≼</span> <span class="skolem">av</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">ivs</span> <span class="main">∈</span> initSets <span class="skolem">s2</span> <span class="main">.</span> 
                dstate <span class="skolem">s2</span> <span class="main">≼</span> <span class="main">⨅</span><span class="bound">ivs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s2</span> <span class="main">.</span> <span class="skolem">av</span> <span class="main">=</span> <span class="main">⨅</span><span class="bound">ivs</span> <span class="main">⋆</span> <span class="bound">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">av</span> <span class="main">∈</span> initAborts <span class="skolem">s2</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword2"><span class="keyword">and</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>safeAborts_def<span class="main">)</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>initAborts_def<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s2</span> <span class="main">.</span> <span class="skolem">av</span> <span class="main">=</span> dstate <span class="skolem">s2</span> <span class="main">⋆</span> <span class="bound">rs</span>"</span></span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹initialized <span class="skolem">u</span>›</span></span> 
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹pendingReqs <span class="skolem">s2</span> <span class="main">⊆</span> pendingReqs <span class="skolem">u</span>›</span></span> 6 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>safeAborts_def initAborts_def<span class="main">)</span>
                  <span class="main">(</span><span class="operator">metis</span> less_eq_def mem_Collect_eq pendingSeqs_def 
                    sup.coboundedI2 sup.orderE<span class="main">)</span> 
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span> <span class="main">≼</span> <span class="skolem">av</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">ivs</span> <span class="main">∈</span> initSets <span class="skolem">s2</span> <span class="main">.</span> 
                dstate <span class="skolem">s2</span> <span class="main">≼</span> <span class="main">⨅</span><span class="bound">ivs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s2</span> <span class="main">.</span> <span class="skolem">av</span> <span class="main">=</span> <span class="main">⨅</span><span class="bound">ivs</span> <span class="main">⋆</span> <span class="bound">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">u</span> <span class="main">≼</span> <span class="skolem">av</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ivs</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 9<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ivs</span> <span class="main">∈</span> initSets <span class="skolem">s2</span>"</span></span> 
                  <span class="keyword2"><span class="keyword">and</span></span> 10<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">s2</span> <span class="main">≼</span> <span class="main">⨅</span><span class="skolem">ivs</span>"</span></span> 
                  <span class="keyword2"><span class="keyword">and</span></span> 11<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs'</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s2</span> <span class="main">∧</span> <span class="skolem">av</span> <span class="main">=</span> <span class="main">⨅</span><span class="skolem">ivs</span> <span class="main">⋆</span> <span class="skolem">rs'</span>"</span></span> 
                    <span class="keyword1"><span class="command">using</span></span> 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">u</span> <span class="main">=</span> dstate <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹P22 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u_def<span class="main">)</span>
                <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span><span class="skolem">ivs</span> <span class="main">=</span> dstate <span class="skolem">s2</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹P25 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> True 9 10 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u_def<span class="main">)</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">av</span> <span class="main">=</span> dstate <span class="skolem">u</span> <span class="main">⋆</span> <span class="main">(</span><span class="skolem">rs</span><span class="main">@</span><span class="skolem">rs'</span><span class="main">)</span>"</span></span> 
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span><span class="main">@</span><span class="skolem">rs'</span> <span class="main">∈</span> pendingSeqs <span class="skolem">u</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> 11 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingSeqs_def<span class="main">)</span>
                    <span class="main">(</span><span class="operator">metis</span> exec_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> lem1 subset_trans<span class="main">)</span>
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 8 <span class="quoted"><span class="quoted">‹initialized <span class="skolem">u</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>safeAborts_def initAborts_def<span class="main">)</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">av</span> <span class="main">∈</span> uninitAborts <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>safeAborts_def<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ivs</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ivs</span> <span class="main">∈</span> initSets <span class="skolem">s2</span>"</span></span> 
                <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span>pendingSeqs <span class="skolem">s2</span>"</span></span>
                <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">av</span> <span class="main">=</span> <span class="main">⨅</span><span class="skolem">ivs</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>uninitAborts_def<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lem1 2 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingSeqs_def<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span><span class="quoted"><span class="quoted">"dstate <span class="skolem">u</span> <span class="main">=</span> dstate <span class="skolem">s1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹P10 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u_def<span class="main">)</span> 
              <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 6<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⨅</span><span class="skolem">ivs</span> <span class="main">=</span> dstate <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs'</span>"</span></span> 
                <span class="keyword2"><span class="keyword">and</span></span> 7<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs'</span> <span class="main">∈</span> pendingSeqs <span class="skolem">s1</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> 1 <span class="quoted"><span class="quoted">‹P8a <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs'</span> <span class="main">∈</span> pendingSeqs <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹P23 <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span><span class="skolem">s2</span><span class="main">)</span>›</span></span> 7
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>u_def<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">av</span> <span class="main">=</span> dstate <span class="skolem">u</span> <span class="main">⋆</span> <span class="main">(</span><span class="skolem">rs'</span><span class="main">@</span><span class="skolem">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 5 6
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exec_append<span class="main">)</span> 
              <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs'</span><span class="main">@</span><span class="skolem">rs</span> <span class="main">∈</span> pendingSeqs <span class="skolem">u</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> 4 8 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pendingSeqs_def<span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 9 10 <span class="quoted"><span class="quoted">‹initialized <span class="skolem">u</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>safeAborts_def initAborts_def less_eq_def<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 3 4 5 Switch2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> ext <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>ioa.asig <span class="main">(</span>ioa <span class="main">0</span> <span class="free">id2</span><span class="main">)</span><span class="main">)</span> <span class="var">?e</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Switch2<span class="main">(</span>2<span class="main">)</span> ids 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_def schedule_def filter_act_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>refines_def u_def u'_def<span class="main">)</span>
            <span class="main">(</span><span class="operator">metis</span> fst_conv last_state.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ref_map_soundness <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ioa_implements_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Consensus">
<div class="head">
<h1>Theory Consensus</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Consensus Data Type›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Consensus
<span class="keyword2"><span class="keyword">imports</span></span> <a href="RDR.html">RDR</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory provides a model for the RDR locale, thus showing 
  that the assumption of the RDR locale are consistent.›</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> proc
<span class="keyword1"><span class="command">typedecl</span></span> val

<span class="keyword1"><span class="command">locale</span></span> Consensus
<span class="comment1">― ‹To avoid name clashes›</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">δ</span><span class="main">::</span><span class="quoted"><span class="quoted">"val option <span class="main">⇒</span> <span class="main">(</span>proc <span class="main">×</span> val<span class="main">)</span> <span class="main">⇒</span> val option"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∙</span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">δ</span> None <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">γ</span><span class="main">::</span><span class="quoted"><span class="quoted">"val option <span class="main">⇒</span> <span class="main">(</span>proc <span class="main">×</span> val<span class="main">)</span> <span class="main">⇒</span> val"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">γ</span> None <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> snd <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> pre_RDR <span class="quoted">δ</span> <span class="quoted">γ</span> <span class="quoted">None</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">notation</span></span> exec <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⋆</span>"</span> 65<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> less_eq <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≼</span>"</span> 50 <span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> None <span class="main">(</span><span class="quoted">"<span class="keyword1">⊥</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> single_use<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span> <span class="free">rs</span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">⋆</span> <span class="main">(</span><span class="main">[</span><span class="free">r</span><span class="main">]</span><span class="main">@</span><span class="free">rs</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span> <span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⋆</span> <span class="bound">rs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> None
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⋆</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">⋆</span> <span class="main">[</span><span class="skolem">r</span><span class="main">]</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prec_eq_None_or_equal<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s1</span> <span class="free">s2</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">≼</span> <span class="free">s2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">s1</span> <span class="main">=</span> <span class="free">s2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms single_use  
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">≠</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">≠</span> <span class="free">s2</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⋆</span> <span class="main">(</span><span class="main">[</span><span class="skolem">r</span><span class="main">]</span><span class="main">@</span><span class="skolem">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bot <span class="keyword1"><span class="command">using</span></span> 1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_butlast_last_id pre_RDR.exec.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">=</span> <span class="free">s1</span> <span class="main">⋆</span> <span class="skolem">rs'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>less_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⋆</span> <span class="main">(</span><span class="main">[</span><span class="skolem">r</span><span class="main">]</span><span class="main">@</span><span class="main">(</span><span class="skolem">rs</span><span class="main">@</span><span class="skolem">rs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 4
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exec_append<span class="main">)</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> <span class="free">s2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> single_use<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> RDR <span class="quoted">δ</span> <span class="quoted">γ</span> <span class="quoted"><span class="main">⊥</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">r</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"contains <span class="skolem">s</span> <span class="skolem">r</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∙</span> <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹contains <span class="skolem">s</span> <span class="skolem">r</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>contains_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> δ.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rev_exhaust single_use<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">r</span> <span class="skolem">r'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"proc <span class="main">×</span> val"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">≠</span> fst <span class="skolem">r'</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"γ <span class="skolem">s</span> <span class="skolem">r</span> <span class="main">=</span> γ <span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">∙</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">r'</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> δ.simps γ.simps not_Some_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">≼</span> <span class="skolem">s2</span> <span class="main">∧</span> <span class="skolem">s2</span> <span class="main">≼</span> <span class="skolem">s1</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">=</span> <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prec_eq_None_or_equal<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">s</span> <span class="main">.</span> is_glb <span class="bound">s</span> <span class="skolem">s1</span> <span class="skolem">s2</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_glb_def is_lb_def<span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> bot pre_RDR.less_eq_def prec_eq_None_or_equal<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">≼</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bot pre_RDR.less_eq_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">s3</span> <span class="skolem">rs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">≼</span> <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">≼</span> <span class="skolem">s3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s3</span> <span class="main">=</span> <span class="skolem">s1</span> <span class="main">⋆</span> <span class="skolem">rs</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs'</span> <span class="bound">rs''</span> <span class="main">.</span> <span class="skolem">s2</span> <span class="main">=</span> <span class="skolem">s1</span> <span class="main">⋆</span> <span class="bound">rs'</span> <span class="main">∧</span> <span class="skolem">s3</span> <span class="main">=</span> <span class="skolem">s2</span> <span class="main">⋆</span> <span class="bound">rs''</span> 
    <span class="main">∧</span> set <span class="bound">rs'</span> <span class="main">⊆</span> set <span class="skolem">rs</span> <span class="main">∧</span> set <span class="bound">rs''</span> <span class="main">⊆</span> set <span class="skolem">rs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Consensus.prec_eq_None_or_equal 
      in_set_insert insert_Nil list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
        pre_RDR.exec.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>