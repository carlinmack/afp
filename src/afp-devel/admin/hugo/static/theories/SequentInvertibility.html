<div id="MultiSequents">
<div class="head">
<h1>Theory MultiSequents</h1>
</div>
<pre class="source"><span class="comment1">(* Author : Peter Chapman *)</span>
<span class="comment1">(* License: LGPL *)</span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Multisuccedent Sequents"</span></span>

<span class="keyword1"><span class="command">theory</span></span> MultiSequents
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\section{Introduction}
In this paper, we give an overview of some results about invertibility in sequent calculi.  The framework is outlined in \S\ref{isadefs}.  The results are mainly concerned with multisuccedent calculi that have a single principal formula.  We will use, as our running example throughout, the calculus \textbf{G3cp}.  In \S\ref{isasingle}, we look at the formalisation of single-succedent calculi; in \S\ref{isafirstorder}, the formalisation in \textit{Nominal Isabelle} for first-order calculi is shown; in \S\ref{isamodal} the results for modal logic are examined.  We return to multisuccedent calculi in \S\ref{isaSRC} to look at manipulating rule sets.


\section{Formalising the Framework \label{isadefs}}

\subsection{Formulae and Sequents \label{isaformulae}}
A \textit{formula} is either a propositional variable, the constant $\bot$, or a connective applied to a list of formulae.  We thus have a type variable indexing formulae, where the type variable will be a set of connectives.  In the usual way, we index propositional variables by use of natural numbers.  So, formulae are given by the datatype:
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> form <span class="main">=</span> At <span class="quoted"><span class="quoted">"nat"</span></span>
                        <span class="main">|</span> Compound <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> form list"</span></span>
                        <span class="main">|</span> ff

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent For \textbf{G3cp}, we define the datatype $Gp$, and give the following abbreviations:
›</span></span>


<span class="comment1">(* --------------------------------------------
   --------------------------------------------
               G3cp EXAMPLE
   --------------------------------------------
   -------------------------------------------- *)</span>
<span class="comment1">(* Try a small example with conjunction and disjunction *)</span>
<span class="keyword1"><span class="command">datatype</span></span> Gp <span class="main">=</span> con <span class="main">|</span> dis <span class="main">|</span> imp
<span class="keyword1"><span class="command">type_synonym</span></span> Gp_form <span class="main">=</span> <span class="quoted"><span class="quoted">"Gp form"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">con_form</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∧*</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="free">∧*</span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> Compound con <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">dis_form</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∨*</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="free">∨*</span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> Compound dis <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">imp_form</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊃</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="free">⊃</span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>  <span class="main">≡</span> Compound imp <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">]</span>"</span></span>
<span class="comment1">(* --------------------------------------------
   --------------------------------------------
               G3cp EXAMPLE ENDS
   --------------------------------------------
   -------------------------------------------- *)</span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">multiset_abbrev</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">\&lt;LM&gt;</span> _  <span class="keyword1">\&lt;RM&gt;</span>"</span> <span class="main">[</span>75<span class="main">]</span>75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main"><span class="free">\&lt;LM&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">\&lt;RM&gt;</span></span> <span class="main">≡</span> <span class="main">{#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">#}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">multiset_empty</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">\&lt;Empt&gt;</span>"</span> 75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">\&lt;Empt&gt;</span></span> <span class="main">≡</span> <span class="main">{#}</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> sequent <span class="main">=</span> Sequent <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> form<span class="main">)</span> multiset"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> form<span class="main">)</span> multiset"</span></span> <span class="main">(</span><span class="quoted">" <span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⇒*</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>6<span class="main">,</span>6<span class="main">]</span> 5<span class="main">)</span>

<span class="comment1">(* We have that any step in a rule, be it a primitive rule or an instance of a rule in a derivation
   can be represented as a list of premisses and a conclusion.  We need a list since a list is finite
   by definition *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> rule <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent list <span class="main">*</span> <span class="tfree">'a</span> sequent"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> deriv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">*</span> nat"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
<span class="entity">multiset_plus</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊕</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main"><span class="free">⊕</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">+</span> <span class="main">\&lt;LM&gt;</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">\&lt;RM&gt;</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span>
<span class="entity">multiset_minus</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊖</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main"><span class="free">⊖</span></span>  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">-</span> <span class="main">\&lt;LM&gt;</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">\&lt;RM&gt;</span>"</span></span> 

<span class="keyword1"><span class="command">consts</span></span>
  <span class="comment1">(* extend a sequent by adding another one.  A form of weakening.  Is this overkill by adding a sequent? *)</span>
  extend <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> sequent"</span></span>
  extendRule <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> rule <span class="main">⇒</span> <span class="tfree">'a</span> rule"</span></span>

  <span class="comment1">(* Unique conclusion Property *)</span>
  uniqueConclusion <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set <span class="main">⇒</span> bool"</span></span>

  <span class="comment1">(* Invertible definitions *)</span>
  invertible <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule <span class="main">⇒</span> <span class="tfree">'a</span> rule set <span class="main">⇒</span> bool"</span></span>
  invertible_set <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set <span class="main">⇒</span> bool"</span></span>

  <span class="comment1">(* functions to get at components of sequents *)</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">antec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> form multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">antec</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ant</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> form multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">succ</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> form multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mset</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">seq_size</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">seq_size</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> size <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">suc</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">max_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_list</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">max_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free">max_list</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* The depth of a formula.  Will be useful in later files. *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">depth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> form <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="main">(</span>At <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="main">(</span>Compound <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>max_list <span class="main">(</span>map <span class="free">depth</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="main">(</span>ff<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="comment1">(* The formulation of various rule sets *)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent A \textit{sequent} is a pair of multisets of formulae.  Sequents are indexed by the connectives used to index the formulae.  To add a single formula to a multiset of formulae, we use the symbol $\oplus$, whereas to join two multisets, we use the symbol $+$.

\subsection{Rules and Rule Sets \label{isarules}}
A \textit{rule} is a list of sequents (called the premisses) paired with a sequent (called the conclusion).  The two \textit{rule sets} used for multisuccedent calculi are the axioms, and the \SC rules (i.e. rules having one principal formula).  Both are defined as inductive sets.  There are two clauses for axioms, corresponding to $L\bot$ and normal axioms:

›</span></span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">Ax</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
   id<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ax</span>"</span></span>
<span class="main">|</span>  Lbot<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ax</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent The set of \SC rules, on the other hand, must not have empty premisses, and must have a single, compound formula in its conclusion.  The function \texttt{mset} takes a sequent, and returns the multiset obtained by adding the antecedent and the succedent together:
›</span></span>

<span class="comment1">(* upRules is the set of all rules which have a single conclusion.  This is akin to each rule having a 
   single principal formula.  We don't want rules to have no premisses, hence the restriction
   that ps ≠ [] *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">upRules</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
   I<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mset <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">\&lt;LM&gt;</span> Compound <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">upRules</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent For \textbf{G3cp}, we have the following six rules, which we then show are a subset of the set of \SC rules:
›</span></span>

<span class="comment1">(* --------------------------------------------
   --------------------------------------------
               G3cp EXAMPLE
   --------------------------------------------
   -------------------------------------------- *)</span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">g3cp</span>"</span>
<span class="keyword2"><span class="keyword">where</span></span>
    conL<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">+</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">g3cp</span>"</span></span>
<span class="main">|</span>   conR<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">g3cp</span>"</span></span>
<span class="main">|</span>   disL<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∨*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">g3cp</span>"</span></span>
<span class="main">|</span>   disR<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">+</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∨*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">g3cp</span>"</span></span>
<span class="main">|</span>   impL<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊃</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">g3cp</span>"</span></span>
<span class="main">|</span>   impR<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊃</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">g3cp</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> g3cp_upRules<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"g3cp <span class="main">⊆</span> upRules"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ps</span> <span class="skolem">c</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> g3cp"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"g3cp <span class="main">⊆</span> upRules"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(* --------------------------------------------
   --------------------------------------------
               G3cp EXAMPLE ENDS
   --------------------------------------------
   -------------------------------------------- *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent We have thus given the \textit{active} parts of the \textbf{G3cp} calculus.  We now need to extend these active parts with \textit{passive} parts.

Given a sequent $C$, we extend it with another sequent $S$ by adding the two antecedents and the two succedents.  To extend an active part $(Ps,C)$ with a sequent $S$, we extend every $P \in Ps$ and $C$ with $S$:
›</span></span>

<span class="comment1">(* Extend a sequent, and then a rule by adding seq to all premisses and the conclusion *)</span>
<span class="keyword1"><span class="command">overloading</span></span>
  extend <span class="main">≡</span> <span class="quoted">extend</span>
  extendRule <span class="main">≡</span> <span class="quoted">extendRule</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extend</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">extend</span> <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="free"><span class="bound"><span class="entity">seq</span></span></span> <span class="main">≡</span> <span class="main">(</span>antec <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="main">+</span> antec <span class="free"><span class="bound"><span class="entity">seq</span></span></span><span class="main">)</span> <span class="main">⇒*</span> <span class="main">(</span>succ <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="main">+</span> succ <span class="free"><span class="bound"><span class="entity">seq</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extendRule</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">extendRule</span> <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">(</span>map <span class="main">(</span>extend <span class="free"><span class="bound"><span class="entity">forms</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">,</span> extend <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent Given a rule set $\mathcal{R}$, the \textit{extension} of $\mathcal{R}$, called $\mathcal{R}^{\star}$, is then defined as another inductive set:
›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">extRules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set <span class="main">⇒</span> <span class="tfree">'a</span> rule set"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">*</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> I<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> extendRule <span class="free"><span class="bound"><span class="entity">seq</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="free">*</span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent The rules of \textbf{G3cp} all have unique conclusions.  This is easily formalised:
›</span></span>


<span class="comment1">(* The unique conclusion property.  A set of rules has unique conclusion property if for any pair of rules,
   the conclusions being the same means the rules are the same*)</span>
<span class="keyword1"><span class="command">overloading</span></span> uniqueConclusion <span class="main">≡</span> <span class="quoted">uniqueConclusion</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uniqueConclusion</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">uniqueConclusion</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">r1</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">∀</span> <span class="bound">r2</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">(</span>snd <span class="bound">r1</span> <span class="main">=</span> snd <span class="bound">r2</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">r1</span> <span class="main">=</span> <span class="bound">r2</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* --------------------------------------------
   --------------------------------------------
               G3cp EXAMPLE
   --------------------------------------------
   -------------------------------------------- *)</span>
<span class="keyword1"><span class="command">lemma</span></span> g3cp_uc<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"uniqueConclusion g3cp"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>uniqueConclusion_def Ball_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> g3cp.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 1<span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span> g3cp.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="comment1">(* --------------------------------------------
   --------------------------------------------
               G3cp EXAMPLE ENDS
   --------------------------------------------
   -------------------------------------------- *)</span>
<span class="comment1">(*&lt;*)</span>
<span class="comment1">(* A formulation of what it means to be a principal formula for a rule.  Note that we have to build up from
   single conclusion rules.   *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">leftPrincipal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule <span class="main">⇒</span> <span class="tfree">'a</span> form <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  up<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>  <span class="main">⟹</span> 
                   <span class="free">leftPrincipal</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">(</span>Compound <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\subsection{Principal Rules and Derivations \label{isaderv}}
A formula $A$ is \textit{left principal} for an active part $R$ iff the conclusion of $R$ is of the form $A \Rightarrow \emptyset$.  The definition of \textit{right principal} is then obvious.  We have an inductive predicate to check these things:
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">rightPrincipal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule <span class="main">⇒</span> <span class="tfree">'a</span> form <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  up<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">⟹</span> 
                        <span class="free">rightPrincipal</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">(</span>Compound <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent As an example, we show that if $A\wedge B$ is principal for an active part in \textbf{G3cp}, then $\emptyset \Rightarrow A$ is a premiss of that active part:
›</span></span>

<span class="comment1">(* --------------------------------------------
   --------------------------------------------
               G3cp EXAMPLE
   --------------------------------------------
   -------------------------------------------- *)</span>

<span class="keyword1"><span class="command">lemma</span></span> principal_means_premiss<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="free">r</span> <span class="main">(</span><span class="free">A</span> <span class="main">∧*</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>     b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> g3cp"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free">A</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> a <span class="keyword2"><span class="keyword">and</span></span> b <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> req<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free">A</span><span class="main">∧*</span><span class="free">B</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> 
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">=</span> <span class="main">[</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free">A</span> <span class="main">\&lt;RM&gt;</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free">B</span> <span class="main">\&lt;RM&gt;</span><span class="main">]</span>"</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> g3cp.cases<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> req <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free">A</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="comment1">(* --------------------------------------------
   --------------------------------------------
               G3cp EXAMPLE ENDS
   --------------------------------------------
   -------------------------------------------- *)</span>



<span class="comment1">(* What it means to be a derivable sequent.  Can have this as a predicate or as a set.
   The two formation rules say that the supplied premisses are derivable, and the second says
   that if all the premisses of some rule are derivable, then so is the conclusion.  *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent A sequent is \textit{derivable} at height $0$ if it is the conclusion of a rule with no premisses.  If a rule has $m$ premisses, and the maximum height of the derivation of any of the premisses is $n$, then the conclusion will be derivable at height $n+1$.  We encode this as pairs of sequents and natural numbers.  A sequent $S$ is derivable at a height $n$ in a rule system $\mathcal{R}$ iff $(S,n)$ belongs to the inductive set \texttt{derivable} $\mathcal{R}$:
›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">derivable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set <span class="main">⇒</span> <span class="tfree">'a</span> deriv set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
   base<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable</span> <span class="free">R</span>"</span></span>
<span class="main">|</span>  step<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">;</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">≠</span><span class="main">[]</span> <span class="main">;</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable</span> <span class="free">R</span> <span class="main">⟧</span> 
                       <span class="main">⟹</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable</span> <span class="free">R</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent In some instances, we do not care about the height of a derivation, rather that the root is derivable.  For this, we have the additional definition of \texttt{derivable'}, which is a set of sequents:
›</span></span>

<span class="comment1">(* When we don't care about height! *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">derivable'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set <span class="main">⇒</span> <span class="tfree">'a</span> sequent set"</span></span>
   <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set"</span></span>
   <span class="keyword2"><span class="keyword">where</span></span>
    base<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∈</span> <span class="free">derivable'</span> <span class="free">R</span>"</span></span>
<span class="main">|</span>   step<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">;</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">;</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">derivable'</span> <span class="free">R</span> <span class="main">⟧</span>
                       <span class="main">⟹</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable'</span> <span class="free">R</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent It is desirable to switch between the two notions.  Shifting from derivable at a height to derivable is simple: we delete the information about height.  The converse is more complicated and involves an induction on the length of the premiss list:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> deriv_to_deriv<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> derivable' <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> deriv_to_deriv2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> derivable' <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">C</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">)</span> <span class="comment1">― ‹induction on the list›</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">as</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">as</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="main">(</span>max <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> 

<span class="comment1">(*&lt;*)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="comment1">(*&lt;*)</span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span><span class="comment1">(*&gt;*)</span> <span class="operator">auto</span> <span class="comment1">― ‹max returns the maximum of two integers›</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="comment1">(* definition of invertible rule and invertible set of rules.  It's a bit nasty, but all it really says is
   If a rule is in the given set, and if any extension of that rule is derivable at n, then the
   premisses of the extended rule are derivable at height at most n.  *)</span>





<span class="comment1">(* Characterisation of a sequent *)</span>
<span class="keyword1"><span class="command">lemma</span></span> characteriseSeq<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span> <span class="main">::</span> <span class="tfree">'a</span> sequent<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">A</span> <span class="main">⇒*</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(* Helper function for later *)</span>
<span class="keyword1"><span class="command">lemma</span></span> nonEmptySet<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>neq_Nil_conv<span class="main">)</span>

<span class="comment1">(* Lemma which comes in helpful ALL THE TIME *)</span>
<span class="keyword1"><span class="command">lemma</span></span> midMultiset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊕</span> <span class="free">A</span> <span class="main">=</span> <span class="free">Γ'</span> <span class="main">⊕</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ''</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">=</span> <span class="bound">Γ''</span> <span class="main">⊕</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="bound">Γ''</span> <span class="main">⊕</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> <span class="free">Γ'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">Γ</span> <span class="main">⊕</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="free">Γ'</span> <span class="main">⊕</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">Γ</span> <span class="main">∪</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">=</span> set_mset <span class="free">Γ'</span> <span class="main">∪</span> <span class="main">{</span><span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">Γ</span> <span class="main">∪</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">⊆</span> set_mset <span class="free">Γ'</span> <span class="main">∪</span> <span class="main">{</span><span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set_mset <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="main">⊖</span> <span class="free">A</span> <span class="main">⊕</span> <span class="free">A</span> <span class="main">=</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ''</span><span class="main">.</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="bound">Γ''</span> <span class="main">⊕</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="main">⊖</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="main">=</span> <span class="skolem">Γ''</span> <span class="main">⊕</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Γ</span> <span class="main">⊕</span> <span class="free">A</span> <span class="main">=</span> <span class="free">Γ'</span> <span class="main">⊕</span> <span class="free">B</span>›</span></span> eq1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊕</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">Γ''</span> <span class="main">⊕</span> <span class="free">A</span> <span class="main">⊕</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="skolem">Γ''</span> <span class="main">⊕</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eq1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Lemma which says that if we have extended an identity rule, then the propositional variable is
   contained in the extended multisets *)</span>
<span class="keyword1"><span class="command">lemma</span></span> extendID<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"At <span class="free">i</span> <span class="main">∈#</span> <span class="free">Γ</span> <span class="main">∧</span> At <span class="free">i</span> <span class="main">∈#</span> <span class="free">Δ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ'</span> <span class="bound">Δ'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">=</span> <span class="bound">Γ'</span> <span class="main">⊕</span> At <span class="free">i</span> <span class="main">∧</span> <span class="free">Δ</span> <span class="main">=</span> <span class="bound">Δ'</span> <span class="main">⊕</span> At <span class="free">i</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span>"</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extendFalsum<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">=</span> <span class="bound">Γ'</span> <span class="main">⊕</span> ff"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span>"</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(* Lemma that says if a propositional variable is in both the antecedent and succedent of a sequent,
   then it is derivable from idupRules *)</span>
<span class="keyword1"><span class="command">lemma</span></span> containID<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"At <span class="free">i</span> <span class="main">∈#</span> <span class="free">Γ</span> <span class="main">∧</span> At <span class="free">i</span> <span class="main">∈#</span> <span class="free">Δ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"Ax <span class="main">⊆</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⊕</span> At <span class="free">i</span> <span class="main">∧</span> <span class="free">Δ</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⊕</span> At <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="main">(</span><span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span><span class="main">)</span> <span class="main">⇒*</span> <span class="main">(</span><span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">ultimately</span></span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> extRules.I<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span>"</span></span><span class="main">]</span> 
       <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> derivable.base<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> containFalsum<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="free">Γ</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span>  b<span class="main">:</span> <span class="quoted"><span class="quoted">"Ax <span class="main">⊆</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⊕</span> ff"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">moreover</span></span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> extRules.I<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span><span class="main">]</span> 
       <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> derivable.base<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="comment1">(* Lemma which says that if r is an identity rule, then r is of the form
   ([], P ⇒* P) *)</span>
<span class="keyword1"><span class="command">lemma</span></span> characteriseAx<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax <span class="main">⟹</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="bound">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="bound">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* A lemma about the last rule used in a derivation, i.e. that one exists *)</span>
<span class="keyword1"><span class="command">lemma</span></span> characteriseLast<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="free">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
             <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> 
             <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="bound">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>


<span class="comment1">(* Lemma which says that if rule is an upRule, then the succedent is either empty, or a single formula *)</span>
<span class="keyword1"><span class="command">lemma</span></span> succ_upRule<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">Φ</span> <span class="main">⇒*</span> <span class="free">Ψ</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ψ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">Ψ</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">R</span> <span class="skolem">Rs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ψ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">Ψ</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset.simps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ant<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Φ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> suc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ψ</span></span><span class="main">]</span> 
         <span class="keyword2"><span class="keyword">and</span></span> union_is_single<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Φ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ψ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Compound <span class="skolem">R</span> <span class="skolem">Rs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">elim</span> disjE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Equivalent, but the antecedent *)</span>
<span class="keyword1"><span class="command">lemma</span></span> antec_upRule<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">Φ</span> <span class="main">⇒*</span> <span class="free">Ψ</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">Φ</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">R</span> <span class="skolem">Rs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">Φ</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset.simps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ant<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Φ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> suc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ψ</span></span><span class="main">]</span> 
         <span class="keyword2"><span class="keyword">and</span></span> union_is_single<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Φ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ψ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Compound <span class="skolem">R</span> <span class="skolem">Rs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">elim</span> disjE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upRule_Size<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"seq_size <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">R</span> <span class="skolem">Rs</span><span class="main">)</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">+</span> <span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">R</span> <span class="skolem">Rs</span><span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset.simps <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹mset <span class="skolem">C</span> <span class="main">≡</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">R</span> <span class="skolem">Rs</span><span class="main">\&lt;RM&gt;</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">G</span><span class="main">+</span><span class="skolem">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">G</span> <span class="main">+</span> size <span class="skolem">H</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"seq_size <span class="skolem">C</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq_size.simps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ant<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> suc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">H</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">r</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"seq_size <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upRuleCharacterise<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">F</span> <span class="bound">Fs</span><span class="main">.</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ</span></span> <span class="skolem"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> characteriseSeq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">F</span> <span class="bound">Fs</span><span class="main">.</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹mset <span class="free">C</span> <span class="main">≡</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mset.simps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ant<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> suc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> union_is_single<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Compound <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extendEmpty<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> extendContain<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="free">S</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="free">p</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> set <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="free">p</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="free">S</span> <span class="free">r</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span> <span class="main">=</span> <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span> 
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonPrincipalID<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> form"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> r1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="free">r</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> r2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free">A</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> r1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span>
<span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="free">r</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps'</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">Fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> r3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> r1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extendCommute<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="main">(</span>extend <span class="free">R</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>extend <span class="free">R</span><span class="main">)</span> <span class="main">(</span>extend <span class="free">S</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mapCommute<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>extend <span class="free">R</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">R</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendCommute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extendAssoc<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="main">(</span>extend <span class="free">R</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span>extend <span class="free">S</span> <span class="free">R</span><span class="main">)</span> <span class="free">c</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mapAssoc<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>extend <span class="free">R</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="main">(</span>extend <span class="free">S</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendAssoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extended_Ax_prems_empty<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>extendRule <span class="free">S</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">lastRule</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> deriv <span class="main">⇒</span> <span class="tfree">'a</span> rule <span class="main">⇒</span> <span class="tfree">'a</span> rule set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  base<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> Ax<span class="main">;</span> Ax <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">;</span> snd <span class="main">(</span>extendRule <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⇒*</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span><span class="main">⟧</span>
                 <span class="main">⟹</span> <span class="free">lastRule</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⇒*</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>
<span class="main">|</span>    I<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∉</span> Ax <span class="main">;</span> snd <span class="main">(</span>extendRule <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⇒*</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span> <span class="main">;</span> 
                <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">*</span> <span class="main">⟧</span> 
                 <span class="main">⟹</span> <span class="free">lastRule</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⇒*</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> obv<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free">a</span><span class="main">,</span> snd <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> getLast<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lastRule <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">r</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span> <span class="bound">Ps</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="bound">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∉</span> Ax"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lastRule.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="main">(</span>extendRule <span class="improper">S</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"extendRule <span class="improper">S</span> <span class="main">(</span><span class="improper">a</span><span class="main">,</span><span class="improper">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="improper">S</span> <span class="main">(</span><span class="improper">a</span><span class="main">,</span><span class="improper">b</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>snd <span class="main">(</span>extendRule <span class="improper">S</span> <span class="main">(</span><span class="improper">a</span><span class="main">,</span><span class="improper">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> obv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> getAx<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lastRule <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="free">r</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">S</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">S</span><span class="main">.</span> snd <span class="main">(</span>extendRule <span class="bound">S</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lastRule.cases<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>extendRule <span class="skolem">S</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> Ax›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">r</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>extendRule <span class="skolem">S</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹snd <span class="main">(</span>extendRule <span class="skolem">S</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> Ax›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> 
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="skolem">S</span> <span class="free">r</span><span class="main">)</span><span class="main">,</span>snd <span class="main">(</span>extendRule <span class="skolem">S</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> obv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(* -------------------------------------------
   -------------------------------------------
       THIS IS NOW INVERTIBLERULESPOLY.THY
   -------------------------------------------
   ------------------------------------------- *)</span>

<span class="comment1">(* Constructing the rule set we will use.  It contains all axioms, but only a subset
   of the possible logical rules. *)</span>
<span class="keyword1"><span class="command">lemma</span></span> ruleSet<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">⊆</span> upRules"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span> <span class="bound">r</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">R'</span> <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> Ax<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span> <span class="bound">r</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="skolem">S</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\section{Formalising the Results \label{isaproofs}}
A variety of ``helper'' lemmata are used in the proofs, but they are not shown.  The proof tactics themselves are hidden in the following proof, except where they are interesting.  Indeed, only the interesting parts of the proof are shown at all.  The main result of this section is that a rule is invertible if the premisses appear as premisses of \textit{every} rule with the same principal formula.  The proof is interspersed with comments.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rightInvertible<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Γ</span> <span class="free">Δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> form multiset"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> rules<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> rightPrincipal <span class="bound">r'</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">⟶</span> 
            <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">+</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹
\noindent The height of derivations is decided by the length of the longest branch.  Thus, we need to use
strong induction: i.e. $\forall m\leq n.\ \textrm{If } P(m) \textrm{ then } P(n+1)$.
›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_less_induct<span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">Γ</span> <span class="skolem">Δ</span><span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Γ</span> <span class="bound">Δ</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span> <span class="main">⟶</span>
                   <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> rightPrincipal <span class="bound">r'</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">⟶</span> 
                   <span class="main">(</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
                   <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span><span class="main">)</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> rightPrincipal <span class="bound">r'</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">⟶</span> 
                        <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>   <span class="comment1">― ‹Case analysis on $n$›</span>
     <span class="keyword3"><span class="command">case</span></span> 0
 <span class="comment1">(*&lt;*)</span>    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">S</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> ruleSet<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="comment1">(*&gt;*)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span> 
                   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  <span class="comment1">― ‹At height 0, the premisses are empty›</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">∨</span> 
                             <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="comment1">― ‹Case split on the kind of axiom used›</span>
          <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
 <span class="comment1">(*&lt;*)</span>         <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">⇒*</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(*&gt;*)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">∧</span> At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Δ</span>"</span></span> <span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command">using</span></span> extendID<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span><span class="main">]</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">∧</span> At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="comment1">(*&lt;*)</span>
                <span class="keyword2"><span class="keyword">and</span></span> containID<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
 <span class="comment1">(*&lt;*)</span>          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span><span class="main">⇒*</span><span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(*&gt;*)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span>"</span></span> <span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command">using</span></span> extendFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span><span class="main">]</span><span class="comment1">(*&gt;*)</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="comment1">(*&lt;*)</span>
                <span class="keyword2"><span class="keyword">and</span></span> containFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="comment1">― ‹This leads to a contradiction›</span>
 <span class="comment1">(*&lt;*)</span>      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="bound">C</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> upRules›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span> <span class="main">::</span> <span class="tfree">'a</span> sequent list<span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="bound">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span> <span class="comment1">(*&gt;*)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">moreover</span></span> <span class="comment1">(*&lt;*)</span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span><span class="main">.</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
       <span class="keyword1"><span class="command">then</span></span><span class="comment1">(*&gt;*)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>   <span class="comment1">― ‹Contradiction›</span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>›</span></span> <span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command">next</span></span> <span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹\noindent In the case where $n = n' + 1$ for some $n'$, we know the premisses are empty,
and every premiss is derivable at a height lower than $n'$:›</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                       <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                       <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="comment1">(*&lt;*)</span>
       <span class="keyword1"><span class="command">using</span></span> characteriseLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span><span class="main">]</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="comment1">(*&lt;*)</span>    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">)</span> <span class="main">∧</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> ruleSet<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(*&gt;*)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span>  
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span>   <span class="comment1">― ‹Gives a contradiction›</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
                    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span> <span class="comment1">(*&lt;*)</span>
                          <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
                            <span class="keyword2"><span class="keyword">and</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">r</span>"</span></span><span class="main">]</span> <span class="comment1">(*&gt;*)</span><span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="comment1">(*&lt;*)</span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">=</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>›</span></span><span class="comment1">(*&gt;*)</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="comment1">(*&lt;*)</span>       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(*&gt;*)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> 
                <span class="main">¬</span><span class="main">(</span>rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  <span class="comment1">― ‹The formula is principal, or not›</span>
    <span class="comment1">(*&lt;*)</span>  <span class="keyword1"><span class="command">moreover</span></span> <span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹\noindent If the formula is principal, then $\Gamma' \Rightarrow \Delta'$ is amongst the premisses of $r$:›</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b' <span class="comment1">(*&lt;*)</span><span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> rules<span class="comment1">(*&gt;*)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span>
      <span class="comment1">(*&lt;*)</span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="comment1">(*&lt;*)</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendContain<span class="comment1">(*&gt;*)</span><span class="main">)</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="comment1">(*&lt;*)</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="comment1">(*&lt;*)</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="comment1">(*&gt;*)</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="comment1">(*&lt;*)</span> <span class="keyword1"><span class="command">moreover</span></span> <span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹\noindent If the formula is not principal, then it must appear in the premisses.  The first two lines give a characterisation of the extension and conclusion, respectively.  Then, we apply the induction hypothesis
at the lower height of the premisses:›</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span>
   <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="skolem"><span class="skolem">Ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>   
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>  
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span>   <span class="comment1">― ‹Proof omitted›</span>
 <span class="comment1">(*&lt;*)</span>                 <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> upRules›</span></span>
                     <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
                     <span class="keyword1"><span class="command">using</span></span> upRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">moreover</span></span>
                     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">≠</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">}</span></span>
                  <span class="keyword1"><span class="command">moreover</span></span>
                     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">}</span></span>
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">qed</span></span> 
             <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"succ <span class="skolem">S</span> <span class="main">+</span> succ <span class="main">(</span>snd <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span> 
                         <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span>
                         <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
                         <span class="keyword2"><span class="keyword">and</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">r</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">H</span> <span class="main">=</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="comment1">(*&lt;*)</span><span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> upRules›</span></span> <span class="comment1">(*&gt;*)</span>
   
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span><span class="comment1">(*&lt;*)</span>
            <span class="keyword1"><span class="command">using</span></span> succ_upRule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Φ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ψ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">H</span></span><span class="main">]</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> <span class="skolem">Ψ</span>"</span></span>   <span class="comment1">― ‹Proof omitted›</span>
 <span class="comment1">(*&lt;*)</span>                <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
                 <span class="keyword1"><span class="command">moreover</span></span>
                    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ</span> <span class="main">=</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">H</span> <span class="main">=</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> <span class="skolem">Ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword1"><span class="command">moreover</span></span>
                    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span>"</span></span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">A</span><span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ</span> <span class="main">⊕</span> <span class="skolem">A</span> <span class="main">=</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">H</span> <span class="main">=</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="skolem">Ψ</span> <span class="main">⊕</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">Ψ</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">A</span><span class="main">}</span> <span class="main">=</span> set_mset <span class="skolem">Δ</span> <span class="main">∪</span> <span class="main">{</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">A</span><span class="main">\&lt;RM&gt;</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">\&lt;LM&gt;</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">≠</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈</span> set_mset <span class="skolem">Ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> <span class="skolem">Ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> <span class="skolem">Ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                 <span class="keyword1"><span class="command">qed</span></span> <span class="comment1">(*&gt;*)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ψ1</span><span class="main">.</span> <span class="skolem">Ψ</span> <span class="main">=</span> <span class="bound">Ψ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="comment1">(*&lt;*)</span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Ψ</span> <span class="main">⊖</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span><span class="comment1">(*&gt;*)</span> <span class="main">(</span><span class="operator">auto</span><span class="comment1">(*&lt;*)</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="comment1">(*&gt;*)</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ψ1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span><span class="comment1">(*&lt;*)</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="comment1">(*&lt;*)</span>           <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="skolem">ps</span>"</span></span> 
                 <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span> 
                 <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="skolem">S</span> <span class="bound">p'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ex_map_conv<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ys<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extend <span class="skolem">S</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> succ <span class="bound">p</span><span class="main">)</span>"</span></span>  <span class="comment1">― ‹Appears in every premiss›</span>
                 <span class="comment1">(*&lt;*)</span>     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> <span class="skolem">Ψ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="comment1">(*&gt;*)</span>
         <span class="keyword1"><span class="command">by</span></span> <span class="comment1">(*&lt;*)</span><span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span><span class="comment1">(*&gt;*)</span> <span class="main">(</span><span class="operator">auto</span><span class="comment1">(*&lt;*)</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="comment1">(*&gt;*)</span><span class="main">)</span>
  <span class="comment1">(*&lt;*)</span>          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> characteriseSeq
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span> 
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="improper">x</span> <span class="main">⊖</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> 
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">≤</span><span class="skolem">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>
                                                     <span class="main">∧</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="comment1">(*&gt;*)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="comment1">(*&lt;*)</span>a2<span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">≤</span><span class="skolem">n'</span> <span class="main">∧</span> 
                                   <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span> <span class="main">∧</span>
                                   <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="comment1">(*&lt;*)</span><span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> <span class="comment1">(*&gt;*)</span>IH<span class="comment1">(*&lt;*)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Φ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ψ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span><span class="comment1">(*&lt;*)</span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span><span class="comment1">(*&gt;*)</span> <span class="main">(</span><span class="operator">arith</span><span class="main">)</span> 
<span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹\noindent  To this set of new premisses, we apply a new instance of $r$, with a different extension:›</span></span>           
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps'</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">(*&lt;*)</span>          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ps</span> <span class="main">=</span> length <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps'</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span>›</span></span>
                                            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="skolem">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span> 
                 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="comment1">(*&lt;*)</span>          <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> extend <span class="skolem">S</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="skolem">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>           
            <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_def<span class="main">)</span> 
            <span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="skolem">S</span> <span class="bound">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="skolem">ps</span>›</span></span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c2 
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c1
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span> 
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span> <span class="main">⟶</span> 
                            <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span>
               <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Φ'</span> <span class="skolem">Ψ'</span>
                 <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span>  
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="skolem">ps</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> a1 <span class="keyword2"><span class="keyword">and</span></span> d1
                           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">" <span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> 
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">=</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> 
                      <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">from</span></span> ant <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">moreover</span></span>
                 <span class="keyword1"><span class="command">from</span></span> suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">=</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> 
                      <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> t <span class="keyword2"><span class="keyword">and</span></span> c2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
               <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span>
               <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Φ'</span> <span class="skolem">Ψ'</span>
                 <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span>  
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> d2
                           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> 
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">+</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> 
                      <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">from</span></span> ant <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">moreover</span></span>
                 <span class="keyword1"><span class="command">from</span></span> suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ψ1</span> <span class="main">+</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">=</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ψ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> 
                      <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">⇒*</span><span class="skolem">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Φ</span>  <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> t <span class="keyword2"><span class="keyword">and</span></span> c1
                      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
               <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">≤</span><span class="skolem">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>
                                                <span class="main">∧</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> a2
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Φ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ψ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>  
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Φ'</span> <span class="main">⇒*</span> <span class="improper">Ψ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="comment1">(*&gt;*)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="comment1">(*&lt;*)</span><span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps'</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
    <span class="keyword2"><span class="keyword">and</span></span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>›</span></span> <span class="comment1">(*&lt;*)</span>
       <span class="keyword2"><span class="keyword">and</span></span> derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span><span class="main">]</span><span class="comment1">(*&gt;*)</span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="comment1">(*&lt;*)</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="comment1">(*&gt;*)</span><span class="main">)</span>
  <span class="comment1">(*&lt;*)</span>          <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>         
        <span class="keyword1"><span class="command">}</span></span><span class="comment1">(*&gt;*)</span>
 <span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹\noindent All of the cases are now complete.›</span></span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 <span class="comment1">(*&lt;*)</span>  <span class="keyword1"><span class="command">qed</span></span> <span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(* --------------------------------------------
   --------------------------------------------
               G3cp EXAMPLE
   --------------------------------------------
   -------------------------------------------- *)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
As an example, we show the left premiss of $R\wedge$ in \textbf{G3cp} is derivable at a height not greater than that of the conclusion.  The two results used in the proof (\texttt{principal-means-premiss} and \texttt{rightInvertible}) are those we have previously shown:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> conRInvert<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊕</span> <span class="main">(</span><span class="free">A</span> <span class="main">∧*</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>g3cp <span class="main">∪</span> Ax<span class="main">)</span><span class="main">*</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊕</span> <span class="free">A</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>g3cp <span class="main">∪</span> Ax<span class="main">)</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> g3cp<span class="main">.</span> rightPrincipal <span class="bound">r</span> <span class="main">(</span><span class="free">A</span> <span class="main">∧*</span> <span class="free">B</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free">A</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> principal_means_premiss <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rightInvertible<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"g3cp"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> <span class="free">A</span> <span class="main">\&lt;RM&gt;</span>"</span></span> 
                           <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"g3cp <span class="main">∪</span> Ax"</span></span><span class="main">]</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="comment1">(*&lt;*)</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Un_commute Ball_def nonPrincipalID g3cp_upRules<span class="comment1">(*&gt;*)</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(* --------------------------------------------
   --------------------------------------------
             G3cp EXAMPLE ENDS
   --------------------------------------------
   -------------------------------------------- *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent  We can obviously show the equivalent proof for left rules, too:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> leftInvertible<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Γ</span> <span class="free">Δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> form multiset"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> rules<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> leftPrincipal <span class="bound">r'</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">+</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_less_induct<span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">Γ</span> <span class="skolem">Δ</span><span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Γ</span> <span class="bound">Δ</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="bound">Δ</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> leftPrincipal <span class="bound">r'</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span><span class="main">)</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> leftPrincipal <span class="bound">r'</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> 0
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">S</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> ruleSet<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">⇒*</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">∧</span> At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extendID<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">∧</span> At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules
                <span class="keyword2"><span class="keyword">and</span></span> containID<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span><span class="main">⇒*</span><span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extendFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">⊕</span>Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules
                <span class="keyword2"><span class="keyword">and</span></span> containFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>       
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="bound">C</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> upRules›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span> <span class="main">::</span> <span class="tfree">'a</span> sequent list<span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="bound">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span><span class="main">.</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                          <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                          <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> characteriseLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">)</span> <span class="main">∧</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rules ruleSet<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
                            <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
                            <span class="keyword2"><span class="keyword">and</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">r</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">=</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span>
         <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span>leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> rules
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendContain<span class="main">)</span>
             <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span>
             <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="skolem"><span class="skolem">Ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">G</span>"</span></span> 
                  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> upRules›</span></span>
                     <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
                     <span class="keyword1"><span class="command">using</span></span> upRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">moreover</span></span>
                     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>   
                     <span class="keyword1"><span class="command">}</span></span>
                  <span class="keyword1"><span class="command">moreover</span></span>
                     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">≠</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">}</span></span>
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">qed</span></span>
             <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"antec <span class="skolem">S</span> <span class="main">+</span> antec <span class="main">(</span>snd <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span> 
                         <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
                         <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
                         <span class="keyword2"><span class="keyword">and</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">r</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">G</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span><span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> upRules›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">G</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> antec_upRule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Φ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ψ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">H</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> <span class="skolem">Φ</span>"</span></span>
                 <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">G</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
                 <span class="keyword1"><span class="command">moreover</span></span>
                    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">G</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> <span class="skolem">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword1"><span class="command">moreover</span></span>
                    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">G</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span>"</span></span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">A</span><span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">⊕</span> <span class="skolem">A</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">G</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⊕</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">Φ</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">A</span><span class="main">}</span> <span class="main">=</span> set_mset <span class="skolem">Γ</span> <span class="main">∪</span> <span class="main">{</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">G</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">A</span><span class="main">\&lt;RM&gt;</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">\&lt;LM&gt;</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">G</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">≠</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈</span> set_mset <span class="skolem">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> <span class="skolem">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> <span class="skolem">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                 <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Φ1</span><span class="main">.</span> <span class="skolem">Φ</span> <span class="main">=</span> <span class="bound">Φ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> 
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">⊖</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Φ1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="skolem">ps</span>"</span></span> 
                 <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span> 
                 <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="skolem">S</span> <span class="bound">p'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ex_map_conv<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ys<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extend <span class="skolem">S</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> antec <span class="bound">p</span><span class="main">)</span>"</span></span> 
                      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> <span class="skolem">Φ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> 
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> characteriseSeq
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span> 
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="improper">x</span> <span class="main">⊖</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> 
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">≤</span><span class="skolem">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>
                                                     <span class="main">∧</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">≤</span><span class="skolem">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>
                                                   <span class="main">∧</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> IH
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Φ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ψ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">arith</span><span class="main">)</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps'</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ps</span> <span class="main">=</span> length <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps'</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span>›</span></span>
                                            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="skolem">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span> 
                 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> extend <span class="skolem">S</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="skolem">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>           
            <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_def<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="skolem">S</span> <span class="bound">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="skolem">ps</span>›</span></span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c2 
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c1
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span>
               <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Φ'</span> <span class="skolem">Ψ'</span>
                 <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span>  
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="skolem">ps</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> a1 <span class="keyword2"><span class="keyword">and</span></span> d1
                           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> 
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">=</span> <span class="skolem">Φ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">+</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">=</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">⇒*</span><span class="skolem">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">from</span></span> ant <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">=</span> <span class="skolem">Φ1</span> <span class="main">+</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">moreover</span></span>
                 <span class="keyword1"><span class="command">from</span></span> suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> 
                      <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> t <span class="keyword2"><span class="keyword">and</span></span> c2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
               <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span>
               <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Φ'</span> <span class="skolem">Ψ'</span>
                 <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span>  
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> d2
                           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> 
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">+</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> 
                      <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">from</span></span> ant <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">=</span> <span class="skolem">Φ1</span> <span class="main">+</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">moreover</span></span>
                 <span class="keyword1"><span class="command">from</span></span> suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">=</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> 
                      <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">⇒*</span><span class="skolem">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> t <span class="keyword2"><span class="keyword">and</span></span> c1
                      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
               <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">≤</span><span class="skolem">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>
                                                <span class="main">∧</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> a2
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Φ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ψ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>  
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Φ'</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="improper">Ψ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> all<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span>
                 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps'</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
                 <span class="keyword2"><span class="keyword">and</span></span> derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span><span class="main">]</span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>         
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">lemma</span></span> invertibleRule<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> rules<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R'</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> UC<span class="main">:</span>     <span class="quoted"><span class="quoted">"uniqueConclusion <span class="free">R'</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> IN<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> der<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> IN <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r'</span> <span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="bound">r'</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="bound">r'</span> <span class="main">∈</span>  <span class="free">R'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="bound">S</span> <span class="bound">r'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> ruleSet<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">C</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="skolem">S</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ</span></span> <span class="skolem"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> gam1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> Ax"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r'</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="skolem">S</span> <span class="skolem">r'</span>›</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">=</span> extend <span class="skolem">S</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">∈</span> set <span class="free">Ps</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="skolem">S</span> <span class="skolem">r'</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> extend <span class="skolem">S</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ'</span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> characteriseSeq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="skolem">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gam1 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">=</span> extend <span class="skolem">S</span> <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>    
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="skolem">r'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span><span class="main">=</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">F</span> <span class="bound">Fs</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">∈</span> upRules›</span></span> <span class="keyword2"><span class="keyword">and</span></span> upRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">Fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> Compound <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>          
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span><span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="skolem">S</span> <span class="skolem">r'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> gam1
        <span class="keyword1"><span class="command">have</span></span> gam2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r'</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="skolem">r'</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>"</span></span>  
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">.</span> rightPrincipal <span class="bound">r</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹uniqueConclusion <span class="free">R'</span>›</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R'</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>"</span></span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹uniqueConclusion <span class="free">R'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span><span class="main">=</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>uniqueConclusion_def Ball_def<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="skolem">r'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> b1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">.</span> rightPrincipal <span class="bound">r</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> rightPrincipal <span class="bound">r</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>               
          <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="skolem">t</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pss</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pss</span><span class="main">,</span><span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹rightPrincipal <span class="skolem">t</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> rP<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> split<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> Ax"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">d</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pss</span><span class="main">,</span><span class="skolem">d</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span>
              <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹rightPrincipal <span class="skolem">t</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b1 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">P</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> gam1 <span class="keyword2"><span class="keyword">and</span></span> gam2 <span class="keyword2"><span class="keyword">and</span></span> P
          <span class="keyword2"><span class="keyword">and</span></span> rightInvertible<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Fs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Fs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ'</span></span><span class="main">]</span>
          <span class="keyword2"><span class="keyword">and</span></span> IN <span class="keyword2"><span class="keyword">and</span></span> der <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>          
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span><span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="skolem">S</span> <span class="skolem">r'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> gam1
        <span class="keyword1"><span class="command">have</span></span> gam3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r'</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="skolem">r'</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">.</span> leftPrincipal <span class="bound">r</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹uniqueConclusion <span class="free">R'</span>›</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R'</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>"</span></span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹uniqueConclusion <span class="free">R'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span><span class="main">=</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps'</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>uniqueConclusion_def Ball_def<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="skolem">r'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> b1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">.</span> leftPrincipal <span class="bound">r</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> leftPrincipal <span class="bound">r</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>               
          <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="skolem">t</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pss</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pss</span><span class="main">,</span><span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹leftPrincipal <span class="skolem">t</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> rP<span class="main">:</span><span class="quoted"><span class="quoted">"antec <span class="skolem">d</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> split<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> Ax"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">d</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pss</span><span class="main">,</span><span class="skolem">d</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span>
              <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹leftPrincipal <span class="skolem">t</span> <span class="main">(</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b1 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">P</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> gam1 <span class="keyword2"><span class="keyword">and</span></span> gam3 <span class="keyword2"><span class="keyword">and</span></span> P
          <span class="keyword2"><span class="keyword">and</span></span> leftInvertible<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Fs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Fs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ'</span></span><span class="main">]</span>
          <span class="keyword2"><span class="keyword">and</span></span> IN <span class="keyword2"><span class="keyword">and</span></span> der <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">P</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
A rule is invertible iff every premiss is derivable at a height lower than that of the conclusion.  A set of rules is invertible iff every rule is invertible.  These definitions are easily formalised:›</span></span>

<span class="keyword1"><span class="command">overloading</span></span>
  invertible <span class="main">≡</span> <span class="quoted">invertible</span>
  invertible_set <span class="main">≡</span> <span class="quoted">invertible_set</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">invertible</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">invertible</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span>
       <span class="main">∀</span> <span class="bound">n</span> <span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> <span class="main">(</span>snd <span class="main">(</span>extendRule <span class="bound">S</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">*</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="bound">S</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span> <span class="main">≤</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">*</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">invertible_set</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">invertible_set</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="main">(</span><span class="bound">ps</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> invertible <span class="main">(</span><span class="bound">ps</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent A set of multisuccedent \SC rules is invertible if each rule has a different conclusion.  \textbf{G3cp} has the unique conclusion property (as shown in \S\ref{isarules}).  Thus, \textbf{G3cp} is an invertible set of rules:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unique_to_invertible<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="comment1">(*&lt;*)</span>a<span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R'</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"uniqueConclusion <span class="free">R'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invertible_set <span class="free">R</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> assms invertibleRule
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>invertible_set_def invertible_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="main">(</span>extendRule <span class="improper">S</span> <span class="main">(</span><span class="improper">a</span><span class="main">,</span><span class="improper">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="main">(</span>extendRule <span class="improper">S</span> <span class="main">(</span><span class="improper">a</span><span class="main">,</span><span class="improper">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>a extRules.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="main">(</span>extendRule <span class="improper">S</span> <span class="main">(</span><span class="improper">a</span><span class="main">,</span><span class="improper">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="main">(</span>extendRule <span class="improper">S</span> <span class="main">(</span><span class="improper">a</span><span class="main">,</span><span class="improper">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>a extRules.intros<span class="main">)</span>
<span class="comment1">(*&gt;*)</span>
<span class="comment1">(* --------------------------------------------
   --------------------------------------------
               G3cp EXAMPLE
   --------------------------------------------
   -------------------------------------------- *)</span>

<span class="keyword1"><span class="command">lemma</span></span> g3cp_invertible<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invertible_set <span class="main">(</span>Ax <span class="main">∪</span> g3cp<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> g3cp_uc <span class="keyword2"><span class="keyword">and</span></span> g3cp_upRules
   <span class="keyword2"><span class="keyword">and</span></span> unique_to_invertible<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"g3cp"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Ax <span class="main">∪</span> g3cp"</span></span><span class="main">]</span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\subsection{Conclusions}
For \SC multisuccedent calculi, the theoretical results have been formalised.  Moreover, the running example demonstrates that it is straightforward to implement such calculi and reason about them.  Indeed, it will be this class of calculi for which we will prove more results in \S\ref{isaSRC}.
›</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="SingleSuccedent">
<div class="head">
<h1>Theory SingleSuccedent</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(*  Author : Peter Chapman *)</span>
<span class="comment1">(* License: LGPL *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Single Succedent"</span></span>

<span class="keyword1"><span class="command">theory</span></span> SingleSuccedent
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Has the empty formula O, which will mean we can have empty right-hand sides *)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\section{Single Succedent Calculi \label{isasingle}}
We must be careful when restricting sequents to single succedents.  If we have sequents as a pair of multisets, where the second is restricted to having size at most 1, then how does one extend the active part of $\implies{L}{}$ from \textbf{G3ip}?  The left premiss will be $\implies{A}{B} \Rightarrow A$, and the extension will be $\Gamma \Rightarrow C$.  The \texttt{extend} function must be able to correctly choose to discard the $C$.  

Rather than taking this route, we instead restrict to single formulae in the succedents of sequents.  This raises its own problems, since now how does one represent the empty succedent?  We introduce a dummy formula \texttt{Em}, which will stand for the empty formula:
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> form <span class="main">=</span> At <span class="quoted"><span class="quoted">"nat"</span></span>
                        <span class="main">|</span> Compound <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> form list"</span></span>
                        <span class="main">|</span> ff
                        <span class="main">|</span> Em
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">multiset_abbrev</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">\&lt;LM&gt;</span> _  <span class="keyword1">\&lt;RM&gt;</span>"</span> <span class="main">[</span>75<span class="main">]</span>75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main"><span class="free">\&lt;LM&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">\&lt;RM&gt;</span></span> <span class="main">≡</span> <span class="main">{#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">#}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">multiset_empty</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">\&lt;Empt&gt;</span>"</span> 75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">\&lt;Empt&gt;</span></span> <span class="main">≡</span> <span class="main">{#}</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> sequent <span class="main">=</span> Sequent <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> form<span class="main">)</span> multiset"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> form<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">" <span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⇒*</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>6<span class="main">,</span>6<span class="main">]</span> 5<span class="main">)</span>

<span class="comment1">(* We have that any step in a rule, be it a primitive rule or an instance of a rule in a derivation
   can be represented as a list of premisses and a conclusion.  We need a list since a list is finite
   by definition *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> rule <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent list <span class="main">*</span> <span class="tfree">'a</span> sequent"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> deriv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">*</span> nat"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
<span class="entity">multiset_plus</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊕</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main"><span class="free">⊕</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">+</span> <span class="main">\&lt;LM&gt;</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">\&lt;RM&gt;</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span>
<span class="entity">multiset_minus</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊖</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main"><span class="free">⊖</span></span>  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">-</span> <span class="main">\&lt;LM&gt;</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">\&lt;RM&gt;</span>"</span></span> 

<span class="keyword1"><span class="command">consts</span></span>
  <span class="comment1">(* extend a sequent by adding another one.  A form of weakening.  Is this overkill by adding a sequent? *)</span>
  extend <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> sequent"</span></span>
  extendRule <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> rule <span class="main">⇒</span> <span class="tfree">'a</span> rule"</span></span>

  <span class="comment1">(* Unique conclusion Property *)</span>
  uniqueConclusion <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set <span class="main">⇒</span> bool"</span></span>

  <span class="comment1">(* Invertible definitions *)</span>
  invertible <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule <span class="main">⇒</span> <span class="tfree">'a</span> rule set <span class="main">⇒</span> bool"</span></span>
  invertible_set <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set <span class="main">⇒</span> bool"</span></span>

  <span class="comment1">(* functions to get at components of sequents *)</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">antec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> form multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">antec</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ant</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> form"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">succ</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> form multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mset</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">seq_size</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">seq_size</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> size <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">suc</span></span></span>"</span></span>

<span class="comment1">(* Extend a sequent, and then a rule by adding seq to all premisses and the conclusion *)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent When we come to extend a sequent, say $\Gamma \Rightarrow C$, with another sequent, say $\Gamma' \Rightarrow C'$, we only ``overwrite'' the succedent if $C$ is the empty formula:
›</span></span>
<span class="keyword1"><span class="command">overloading</span></span>
  extend <span class="main">≡</span> <span class="quoted">extend</span>
  extendRule <span class="main">≡</span> <span class="quoted">extendRule</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extend</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">extend</span> <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="free"><span class="bound"><span class="entity">seq</span></span></span> <span class="main">≡</span>
    <span class="keyword1">if</span> <span class="main">(</span>succ <span class="free"><span class="bound"><span class="entity">seq</span></span></span> <span class="main">=</span> Em<span class="main">)</span> 
    <span class="keyword1">then</span> <span class="main">(</span>antec <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="main">+</span> antec <span class="free"><span class="bound"><span class="entity">seq</span></span></span><span class="main">)</span> <span class="main">⇒*</span> <span class="main">(</span>succ <span class="free"><span class="bound"><span class="entity">forms</span></span></span><span class="main">)</span> 
    <span class="keyword1">else</span> <span class="main">(</span>antec <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="main">+</span> antec <span class="free"><span class="bound"><span class="entity">seq</span></span></span> <span class="main">⇒*</span> succ <span class="free"><span class="bound"><span class="entity">seq</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extendRule</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">extendRule</span> <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">(</span>map <span class="main">(</span>extend <span class="free"><span class="bound"><span class="entity">forms</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">,</span> extend <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="comment1">(* The formulation of various rule sets *)</span>

<span class="comment1">(* Ax is the set containing all identity RULES and LBot *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">Ax</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
   id<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ax</span>"</span></span>
<span class="main">|</span>  Lbot<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∈</span> <span class="free">Ax</span>"</span></span>

<span class="comment1">(* upRules is the set of all rules which have a single conclusion.  This is akin to each rule having a 
   single principal formula.  We don't want rules to have no premisses, hence the restriction
   that ps ≠ [] *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">upRules</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
   L<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> Compound <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">upRules</span>"</span></span>
<span class="main">|</span>  R<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> Compound <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span><span class="main">)</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">upRules</span>"</span></span> 

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">extRules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set <span class="main">⇒</span> <span class="tfree">'a</span> rule set"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">*</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
   I<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> extendRule <span class="free"><span class="bound"><span class="entity">seq</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="free">*</span></span>"</span></span>

<span class="comment1">(* A formulation of what it means to be a principal formula for a rule.  Note that we have to build up from
   single conclusion rules.   *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">leftPrincipal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule <span class="main">⇒</span> <span class="tfree">'a</span> form <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  up<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>  <span class="main">⟹</span> 
                   <span class="free">leftPrincipal</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">(</span>Compound <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">rightPrincipal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule <span class="main">⇒</span> <span class="tfree">'a</span> form <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  up<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> Compound <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">rightPrincipal</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">(</span>Compound <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span><span class="main">)</span>"</span></span>


<span class="comment1">(* What it means to be a derivable sequent.  Can have this as a predicate or as a set.
   The two formation rules say that the supplied premisses are derivable, and the second says
   that if all the premisses of some rule are derivable, then so is the conclusion.  *)</span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">derivable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set <span class="main">⇒</span> <span class="tfree">'a</span> deriv set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
   base<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable</span> <span class="free">R</span>"</span></span>
<span class="main">|</span>  step<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">;</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">≠</span><span class="main">[]</span> <span class="main">;</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable</span> <span class="free">R</span> <span class="main">⟧</span> 
                       <span class="main">⟹</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable</span> <span class="free">R</span>"</span></span>


<span class="comment1">(* When we don't care about height! *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">derivable'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set <span class="main">⇒</span> <span class="tfree">'a</span> sequent set"</span></span>
   <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set"</span></span>
   <span class="keyword2"><span class="keyword">where</span></span>
    base<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∈</span> <span class="free">derivable'</span> <span class="free">R</span>"</span></span>
<span class="main">|</span>   step<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">;</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">;</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">derivable'</span> <span class="free">R</span> <span class="main">⟧</span>
                       <span class="main">⟹</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable'</span> <span class="free">R</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> deriv_to_deriv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> derivable' <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> deriv_to_deriv2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> derivable' <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">C</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">as</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">as</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="main">(</span>max <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* definition of invertible rule and invertible set of rules.  It's a bit nasty, but all it really says is
   If a rule is in the given set, and if any extension of that rule is derivable at n, then the
   premisses of the extended rule are derivable at height at most n.  *)</span>
<span class="keyword1"><span class="command">overloading</span></span>
  invertible <span class="main">≡</span> <span class="quoted">invertible</span>
  invertible_set <span class="main">≡</span> <span class="quoted">invertible_set</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">invertible</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">invertible</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span>
    <span class="main">∀</span> <span class="bound">n</span> <span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> <span class="main">(</span>snd <span class="main">(</span>extendRule <span class="bound">S</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">*</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="bound">S</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span> <span class="main">≤</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">*</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">invertible_set</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">invertible_set</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="main">(</span><span class="bound">ps</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> invertible <span class="main">(</span><span class="bound">ps</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Characterisation of a sequent *)</span>
<span class="keyword1"><span class="command">lemma</span></span> characteriseSeq<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span> <span class="main">::</span> <span class="tfree">'a</span> sequent<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">A</span> <span class="main">⇒*</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(* Helper function for later *)</span>
<span class="keyword1"><span class="command">lemma</span></span> nonEmptySet<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>neq_Nil_conv<span class="main">)</span>

<span class="comment1">(* Lemma which comes in helpful ALL THE TIME *)</span>
<span class="keyword1"><span class="command">lemma</span></span> midMultiset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊕</span> <span class="free">A</span> <span class="main">=</span> <span class="free">Γ'</span> <span class="main">⊕</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ''</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">=</span> <span class="bound">Γ''</span> <span class="main">⊕</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="bound">Γ''</span> <span class="main">⊕</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> <span class="free">Γ'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">Γ</span> <span class="main">⊕</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="free">Γ'</span> <span class="main">⊕</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">Γ</span> <span class="main">∪</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">=</span> set_mset <span class="free">Γ'</span> <span class="main">∪</span> <span class="main">{</span><span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">Γ</span> <span class="main">∪</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">⊆</span> set_mset <span class="free">Γ'</span> <span class="main">∪</span> <span class="main">{</span><span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set_mset <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="main">⊖</span> <span class="free">A</span> <span class="main">⊕</span> <span class="free">A</span> <span class="main">=</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ''</span><span class="main">.</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="bound">Γ''</span> <span class="main">⊕</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="main">⊖</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="main">=</span> <span class="skolem">Γ''</span> <span class="main">⊕</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Γ</span> <span class="main">⊕</span> <span class="free">A</span> <span class="main">=</span> <span class="free">Γ'</span> <span class="main">⊕</span> <span class="free">B</span>›</span></span> eq1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊕</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">Γ''</span> <span class="main">⊕</span> <span class="free">A</span> <span class="main">⊕</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="skolem">Γ''</span> <span class="main">⊕</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eq1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Lemma which says that if we have extended an identity rule, then the propositional variable is
   contained in the extended multisets *)</span>
<span class="keyword1"><span class="command">lemma</span></span> extendID<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"At <span class="free">i</span> <span class="main">∈#</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">=</span> <span class="bound">Γ'</span> <span class="main">⊕</span> At <span class="free">i</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="free">i</span>"</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extendFalsum<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">=</span> <span class="bound">Γ'</span> <span class="main">⊕</span> ff"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em"</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(* Lemma that says if a propositional variable is in both the antecedent and succedent of a sequent,
   then it is derivable from idupRules *)</span>
<span class="keyword1"><span class="command">lemma</span></span> containID<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"At <span class="free">i</span> <span class="main">∈#</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"Ax <span class="main">⊆</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> At <span class="free">i</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⊕</span> At <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="main">(</span><span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span><span class="main">)</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> At <span class="free">i</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⇒*</span> Em"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="free">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">ultimately</span></span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⇒*</span> At <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> extRules.I<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⇒*</span> Em"</span></span><span class="main">]</span> 
       <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⇒*</span> Em"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="free">i</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> derivable.base<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⇒*</span> At <span class="free">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> containFalsum<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="free">Γ</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span>  b<span class="main">:</span> <span class="quoted"><span class="quoted">"Ax <span class="main">⊆</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">C</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⊕</span> ff"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">C</span><span class="main">)</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">C</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">moreover</span></span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> extRules.I<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">C</span>"</span></span><span class="main">]</span> 
       <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> derivable.base<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">C</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="comment1">(* Lemma which says that if r is an identity rule, then r is of the form
   ([], P ⇒* P) *)</span>
<span class="keyword1"><span class="command">lemma</span></span> characteriseAx<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax <span class="main">⟹</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="bound">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* A lemma about the last rule used in a derivation, i.e. that one exists *)</span>
<span class="keyword1"><span class="command">lemma</span></span> characteriseLast<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="free">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
             <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> 
             <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="bound">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>




<span class="keyword1"><span class="command">lemma</span></span> upRuleCharacterise<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">F</span> <span class="bound">Fs</span><span class="main">.</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> Compound <span class="bound">F</span> <span class="bound">Fs</span><span class="main">)</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> extendEmpty<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> extendContain<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="free">S</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="free">p</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> set <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="free">p</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="free">S</span> <span class="free">r</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span> <span class="main">=</span> <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span> 
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonPrincipalID<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> form"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> r1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="skolem">i</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="free">r</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> r2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> r1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span>
<span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="free">r</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps'</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">Fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> r3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> r1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extended_Ax_prems_empty<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>extendRule <span class="free">S</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>



<span class="comment1">(* ---------------------------------------------------
   ---------------------------------------------------
   ---------------------------------------------------
   ---------------------------------------------------
                THIS IS NOW
                SingleWeakening.thy
   ---------------------------------------------------
   ---------------------------------------------------
   ---------------------------------------------------
   --------------------------------------------------- *)</span>


<span class="comment1">(* Constructing the rule set we will use.  It contains all axioms, but only a subset
   of the possible logical rules. *)</span>
<span class="keyword1"><span class="command">lemma</span></span> ruleSet<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">⊆</span> upRules"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span> <span class="bound">r</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">R'</span> <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> Ax<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span> <span class="bound">r</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="skolem">S</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dpWeak<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span>  b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">⊆</span> upRules"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span>  c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R'</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> a
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">E</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_less_induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">Γ</span> <span class="skolem">E</span><span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">Γ</span> <span class="bound">E</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">⇒*</span> <span class="bound">E</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span> <span class="main">⟶</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">E</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">E</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> 0
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">E</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span>  <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> split<span class="main">:</span><span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">E</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extRules.cases<span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> b c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> upRules.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>                                 
 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="skolem">i</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="skolem">i</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> At <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">E</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extendID <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">E</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> c <span class="keyword2"><span class="keyword">and</span></span> containID<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">+</span><span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹At <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">E</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
 <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">E</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extendFalsum <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">E</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> c <span class="keyword2"><span class="keyword">and</span></span> containFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">+</span><span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">E</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">E</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> 
                  <span class="keyword2"><span class="keyword">and</span></span> h<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> characteriseLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> g c <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">)</span> <span class="main">∧</span> extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">E</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">with</span></span> b <span class="keyword1"><span class="command">have</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> upRules<span class="main">)</span> <span class="main">∧</span> extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">E</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> as f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def map_is_Nil_conv<span class="main">)</span>
 <span class="keyword1"><span class="command">with</span></span> as <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ1</span></span> <span class="skolem"><span class="skolem">δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">with</span></span> h as <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> pms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
       <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span>
       <span class="keyword1"><span class="command">with</span></span> pms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ2</span></span> <span class="skolem"><span class="skolem">δ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ2</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ'</span> <span class="main">=</span> Em <span class="main">∨</span> <span class="skolem">δ'</span> <span class="main">≠</span> Em"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ'</span> <span class="main">=</span> Em"</span></span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> aa <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>›</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="operator">-</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">δ'</span> <span class="main">=</span> Em›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ'</span> <span class="main">≠</span> Em"</span></span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> aa <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>›</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="operator">-</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">δ'</span> <span class="main">≠</span> Em›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
            <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> upRules›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> as <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">E</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def union_ac<span class="main">)</span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">E</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">n'</span>"</span></span><span class="main">]</span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>map_is_Nil_conv extendRule_def<span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">E</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent Given this, it is possible to have right weakening, where we overwrite the empty formula if it appears as the succedent of the root of a derivation:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> dpWeakR<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="comment1">(*&lt;*)</span>a<span class="main">:</span><span class="comment1">(*&gt;*)</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> Em<span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>  <span class="comment1">(*&lt;*)</span>b<span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">⊆</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>  <span class="comment1">(*&lt;*)</span>c<span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R'</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">C</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>   <span class="comment1">― ‹Proof omitted›</span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> a
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_less_induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">Γ</span><span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">Γ</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">⇒*</span> Em<span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span> <span class="main">⟶</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">⇒*</span> <span class="free">C</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> Em<span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> 0
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> Em<span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span>  <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> split<span class="main">:</span><span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extRules.cases<span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> b c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> upRules.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>                                 
 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="skolem">i</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="skolem">i</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">with</span></span> split <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="free">C</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
 <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extendFalsum <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="free">C</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> c <span class="keyword2"><span class="keyword">and</span></span> containFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="free">C</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> Em<span class="main">,</span> <span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> 
                  <span class="keyword2"><span class="keyword">and</span></span> h<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> characteriseLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⇒*</span> Em"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> g c <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">)</span> <span class="main">∧</span> extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">with</span></span> b <span class="keyword1"><span class="command">have</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> upRules<span class="main">)</span> <span class="main">∧</span> extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> as f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def map_is_Nil_conv<span class="main">)</span>
 <span class="keyword1"><span class="command">with</span></span> as <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">Fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> upRules.cases<span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> split <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="free">C</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
 <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> Compound <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ1</span></span> <span class="skolem"><span class="skolem">δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">=</span> Em"</span></span> <span class="keyword1"><span class="command">using</span></span> split <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">with</span></span> h as <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> pms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span>  <span class="main">⇒*</span> <span class="free">C</span><span class="main">)</span> <span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
           <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span>
           <span class="keyword1"><span class="command">with</span></span> pms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="skolem">p</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ2</span></span> <span class="skolem"><span class="skolem">δ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ2</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ'</span> <span class="main">=</span> Em <span class="main">∨</span> <span class="skolem">δ'</span> <span class="main">≠</span> Em"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
           <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ'</span> <span class="main">=</span> Em"</span></span>
               <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
               <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">⇒*</span> Em<span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> aa <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
               <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">⇒*</span> <span class="free">C</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>›</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="operator">-</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
               <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span>  <span class="main">⇒*</span> <span class="free">C</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">δ'</span> <span class="main">=</span> Em›</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
              <span class="keyword1"><span class="command">}</span></span>
           <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ'</span> <span class="main">≠</span> Em"</span></span>
               <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
               <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> aa <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
               <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="free">C</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">δ'</span> <span class="main">≠</span> Em›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
               <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="free">C</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">}</span></span>
           <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span>  <span class="main">⇒*</span> <span class="free">C</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span>  <span class="main">⇒*</span> <span class="free">C</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">}</span></span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">qed</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="main">(</span><span class="skolem">Γ1</span>  <span class="main">⇒*</span> <span class="free">C</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
                <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Γ1</span>  <span class="main">⇒*</span> <span class="free">C</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> upRules›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> Em<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> as <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Γ1</span>  <span class="main">⇒*</span> <span class="free">C</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="free">C</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def union_ac<span class="main">)</span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="free">C</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="free">C</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">n'</span>"</span></span><span class="main">]</span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>map_is_Nil_conv extendRule_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="free">C</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="comment1">(* ---------------------------------------------------
   ---------------------------------------------------
   ---------------------------------------------------
   ---------------------------------------------------
                THIS IS NOW
                SingleInvertible.thy
   ---------------------------------------------------
   ---------------------------------------------------
   ---------------------------------------------------
   --------------------------------------------------- *)</span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent Of course, if $C = Em$, then the above lemma is trivial.  The burden is on the user not to ``use'' the empty formula as a normal formula.  An invertibility lemma can then be formalised:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rightInvertible<span class="main">:</span>
<span class="comment1">(*&lt;*)</span><span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> form multiset"</span></span><span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">assumes</span></span> <span class="comment1">(*&lt;*)</span>rules<span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R'</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>   <span class="comment1">(*&lt;*)</span>a<span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>   <span class="comment1">(*&lt;*)</span>b<span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> rightPrincipal <span class="bound">r'</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="comment1">(*&lt;*)</span>nonEm<span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">≠</span> Em"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">+</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_less_induct<span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">Γ</span><span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Γ</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> rightPrincipal <span class="bound">r'</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span><span class="main">)</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> rightPrincipal <span class="bound">r'</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> 0
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">S</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> ruleSet<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
       <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span><span class="main">⇒*</span> Em<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extendFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules
            <span class="keyword2"><span class="keyword">and</span></span> containFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="bound">C</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> upRules›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span> <span class="main">::</span> <span class="tfree">'a</span> sequent list<span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="bound">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span><span class="main">.</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                          <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                          derv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> characteriseLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">)</span> <span class="main">∧</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> ruleSet<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ext<span class="main">:</span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ext
                            <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
                            <span class="keyword2"><span class="keyword">and</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">r</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">=</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span>
         <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">T</span> <span class="bound">Ts</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="bound">T</span> <span class="bound">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> Compound <span class="bound">T</span> <span class="bound">Ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">=</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> upRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">with</span></span> ext <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">=</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> rules
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendContain<span class="main">)</span>
             <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">with</span></span> ext <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"antec <span class="skolem">S</span> <span class="main">=</span> <span class="skolem">Γ</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
             <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonEm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">with</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">∈#</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ1</span><span class="main">.</span> <span class="skolem">Γ</span> <span class="main">=</span> <span class="bound">Γ1</span> <span class="main">⊕</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊖</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="main">)</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">=</span> <span class="skolem">Γ1</span> <span class="main">⊕</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ext
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"succ <span class="skolem">S</span> <span class="main">=</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
             <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ext
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">with</span></span> derv <span class="keyword1"><span class="command">have</span></span> pms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ext
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">)</span> <span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                 <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span>
                  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γi</span></span> <span class="skolem"><span class="skolem">δi</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γi</span> <span class="main">⇒*</span> <span class="skolem">δi</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δi</span> <span class="main">=</span> Em <span class="main">∨</span> <span class="skolem">δi</span> <span class="main">≠</span> Em"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">moreover</span></span>
                     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δi</span> <span class="main">=</span> Em"</span></span>
                      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
                      <span class="keyword1"><span class="command">with</span></span> pms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span><span class="skolem">n'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                           <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> b' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">,</span><span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                           <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>›</span></span>
                           <span class="keyword2"><span class="keyword">and</span></span> p <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">δi</span> <span class="main">=</span> Em›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span> 
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">m'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">}</span></span>
                  <span class="keyword1"><span class="command">moreover</span></span>
                     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δi</span> <span class="main">≠</span> Em"</span></span>
                      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">⇒*</span> <span class="skolem">δi</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
                      <span class="keyword1"><span class="command">with</span></span> pms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">⇒*</span> <span class="skolem">δi</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                           <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δi</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules 
                           <span class="keyword2"><span class="keyword">and</span></span> dpWeak<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γi</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> E<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">δi</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>›</span></span>
                           <span class="keyword2"><span class="keyword">and</span></span> p <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">δi</span> <span class="main">≠</span> Em›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
                     <span class="keyword1"><span class="command">}</span></span> 
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                 <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">qed</span></span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
                          <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
             <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>›</span></span>
                 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">=</span> <span class="skolem">Γ1</span> <span class="main">⊕</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span>
                 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
             <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
             <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>
                 derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">n'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span><span class="main">]</span> 
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>map_is_Nil_conv extendRule_def<span class="main">)</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>         
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">E</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">lemma</span></span> leftInvertible<span class="main">:</span>
<span class="comment1">(*&lt;*)</span><span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> form multiset"</span></span><span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">assumes</span></span> <span class="comment1">(*&lt;*)</span>rules<span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R'</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>   <span class="comment1">(*&lt;*)</span>a<span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="free">δ</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>   <span class="comment1">(*&lt;*)</span>b<span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> leftPrincipal <span class="bound">r'</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">+</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">δ</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
 <span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_less_induct<span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">Γ</span> <span class="skolem">δ</span><span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Γ</span> <span class="bound">δ</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="bound">δ</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> leftPrincipal <span class="bound">r'</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span> <span class="free">Γ'</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">δ</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span><span class="main">)</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> leftPrincipal <span class="bound">r'</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> 0
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">S</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> ruleSet<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="skolem">i</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>›</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
       <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span><span class="main">⇒*</span> Em<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> extendFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">δ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules
                <span class="keyword2"><span class="keyword">and</span></span> containFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="skolem">i</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> At <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">=</span> At <span class="skolem">i</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> extendID<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules
                <span class="keyword2"><span class="keyword">and</span></span> containID<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
   <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="bound">C</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> upRules›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span> <span class="main">::</span> <span class="tfree">'a</span> sequent list<span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="bound">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span><span class="main">.</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                          <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                          derv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> characteriseLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">)</span> <span class="main">∧</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> ruleSet<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ext<span class="main">:</span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ext
                            <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
                            <span class="keyword2"><span class="keyword">and</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">r</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">=</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span>
         <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">T</span> <span class="bound">Ts</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="bound">T</span> <span class="bound">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> Compound <span class="bound">T</span> <span class="bound">Ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">=</span><span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> upRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">with</span></span> ext <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"antec <span class="skolem">S</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> del<span class="main">:</span> <span class="quoted"><span class="quoted">"Compound <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">=</span> <span class="skolem">δ</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">δ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">with</span></span> derv <span class="keyword1"><span class="command">have</span></span> pms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span> <span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span> <span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                 <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span>
                  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γi</span></span> <span class="skolem"><span class="skolem">δi</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γi</span> <span class="main">⇒*</span> <span class="skolem">δi</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δi</span> <span class="main">=</span> Em <span class="main">∨</span> <span class="skolem">δi</span> <span class="main">≠</span> Em"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">moreover</span></span>
                     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δi</span> <span class="main">=</span> Em"</span></span>
                      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
                      <span class="keyword1"><span class="command">with</span></span> pms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span><span class="skolem">n'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                           <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> b' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">,</span><span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                           <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>›</span></span>
                           <span class="keyword2"><span class="keyword">and</span></span> p <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">δi</span> <span class="main">=</span> Em›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span> 
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">m'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">}</span></span>
                  <span class="keyword1"><span class="command">moreover</span></span>
                     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δi</span> <span class="main">≠</span> Em"</span></span>
                      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δi</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
                      <span class="keyword1"><span class="command">with</span></span> pms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δi</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                           <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δi</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> b'
                           <span class="keyword2"><span class="keyword">and</span></span> IH
                           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">+</span> <span class="skolem">Γi</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">δi</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> 
                           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">m'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>›</span></span>
                           <span class="keyword2"><span class="keyword">and</span></span> p <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">δi</span> <span class="main">≠</span> Em›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
                     <span class="keyword1"><span class="command">}</span></span> 
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                 <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">qed</span></span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
                          <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
             <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">)</span>›</span></span>
                 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span>
                 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
             <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
             <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>
                 derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">n'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span><span class="main">]</span> 
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>map_is_Nil_conv extendRule_def<span class="main">)</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> del <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">=</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">∨</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">≠</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
             <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">=</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span>"</span></span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> rules
                      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>›</span></span>
                      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendContain<span class="main">)</span>
                 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> r <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">=</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="free">F</span> <span class="free">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">with</span></span> ext <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span> <span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
                <span class="keyword1"><span class="command">}</span></span>
             <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">≠</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span>"</span></span>
                 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ''</span></span> <span class="skolem"><span class="skolem">δ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ''</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">with</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> r <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">=</span> <span class="skolem">δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ''</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ''</span> <span class="main">⇒*</span> <span class="skolem">δ'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">with</span></span> r <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ext <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">=</span> <span class="skolem">Γ''</span> <span class="main">⊕</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span>"</span></span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
                 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">≠</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
                      gam1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">=</span> <span class="skolem">Γ1</span> <span class="main">⊕</span> Compound <span class="skolem">T</span> <span class="skolem">Ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
                      gam2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ''</span> <span class="main">=</span> <span class="skolem">Γ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> midMultiset<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ''</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Compound <span class="skolem">T</span> <span class="skolem">Ts</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ''</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">with</span></span> derv <span class="keyword1"><span class="command">have</span></span> pms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
                      <span class="keyword1"><span class="command">using</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
                 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                     <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
                      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span>
                      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γi</span></span> <span class="skolem"><span class="skolem">δi</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γi</span> <span class="main">⇒*</span> <span class="skolem">δi</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δi</span> <span class="main">=</span> Em <span class="main">∨</span> <span class="skolem">δi</span> <span class="main">≠</span> Em"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                      <span class="keyword1"><span class="command">moreover</span></span>
                         <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δi</span> <span class="main">=</span> Em"</span></span>
                          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p
                               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
                          <span class="keyword1"><span class="command">with</span></span> pms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span><span class="skolem">n'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                               <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                          <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> b' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span><span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                               <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>›</span></span>
                               <span class="keyword2"><span class="keyword">and</span></span> p <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">δi</span> <span class="main">=</span> Em›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span> 
                               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">m'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
                         <span class="keyword1"><span class="command">}</span></span>
                      <span class="keyword1"><span class="command">moreover</span></span>
                         <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δi</span> <span class="main">≠</span> Em"</span></span>
                          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δi</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p
                               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
                          <span class="keyword1"><span class="command">with</span></span> pms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δi</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                               <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                          <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> b' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="skolem">Γi</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δi</span><span class="main">,</span><span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                               <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>›</span></span>
                               <span class="keyword2"><span class="keyword">and</span></span> p <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">δi</span> <span class="main">≠</span> Em›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
                               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                         <span class="keyword1"><span class="command">}</span></span> 
                      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                     <span class="keyword1"><span class="command">}</span></span>
                     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">qed</span></span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
                              <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
                 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span>›</span></span>
                     <span class="keyword2"><span class="keyword">and</span></span> gam1 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span>
                     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>
                     derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">n'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span><span class="main">]</span> 
                     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>map_is_Nil_conv extendRule_def<span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
           <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">δ</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
    


<span class="comment1">(* ---------------------------------------------------
   ---------------------------------------------------
   ---------------------------------------------------
   ---------------------------------------------------
                THIS IS NOW
                G3ip.thy
   ---------------------------------------------------
   ---------------------------------------------------
   ---------------------------------------------------
   --------------------------------------------------- *)</span>



<span class="keyword1"><span class="command">datatype</span></span> cdi <span class="main">=</span> con <span class="main">|</span> dis <span class="main">|</span> imp

<span class="keyword1"><span class="command">type_synonym</span></span> cdi_form <span class="main">=</span> <span class="quoted"><span class="quoted">"cdi form"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">con_form</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∧*</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="free">∧*</span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> Compound con <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">dis_form</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∨*</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="free">∨*</span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> Compound dis <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">imp_form</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊃</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="free">⊃</span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>  <span class="main">≡</span> Compound imp <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">]</span>"</span></span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent \textbf{G3ip} can be expressed in this formalism: 
›</span></span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">g3ip</span>"</span>
<span class="keyword2"><span class="keyword">where</span></span>
   conL<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">+</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∈</span> <span class="free">g3ip</span>"</span></span>
<span class="main">|</span>  conR<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">g3ip</span>"</span></span>
<span class="main">|</span>  disL<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">,</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∨*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∈</span> <span class="free">g3ip</span>"</span></span>
<span class="main">|</span>  disR1<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∨*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">g3ip</span>"</span></span>
<span class="main">|</span>  disR2<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∨*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">g3ip</span>"</span></span>
<span class="main">|</span>  impL<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊃</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊃</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> Em<span class="main">)</span> <span class="main">∈</span> <span class="free">g3ip</span>"</span></span>
<span class="main">|</span>  impR<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊃</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">g3ip</span>"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">lemma</span></span> g3ip_upRules<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"g3ip <span class="main">⊆</span> upRules"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> g3ip"</span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> g3ip.cases<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"g3ip <span class="main">⊆</span> upRules"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\noindent As expected, $\implies{R}{}$ can be shown invertible:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> impRInvert<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊃</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>Ax <span class="main">∪</span> g3ip<span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> Em"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊕</span> <span class="free">A</span> <span class="main">⇒*</span> <span class="free">B</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>Ax <span class="main">∪</span> g3ip<span class="main">)</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> <span class="main">(</span>Ax <span class="main">∪</span> g3ip<span class="main">)</span><span class="main">.</span> rightPrincipal <span class="bound">r</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊃</span> <span class="free">B</span><span class="main">)</span> <span class="main">⟶</span> 
                           <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>  <span class="comment1">― ‹Showing that $A \Rightarrow B$ is a premiss of every rule with $\implies{A}{B}$ principal›</span> 
   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="main">(</span>Ax <span class="main">∪</span> g3ip<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊃</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> g3ip"</span></span> <span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="comment1">(*&gt;*)</span><span class="keyword1"><span class="command">by</span></span><span class="comment1">(*&lt;*)</span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="comment1">(*&gt;*)</span> <span class="operator">auto</span>  <span class="comment1">― ‹If $\implies{A}{B}$ was principal, then $r \notin Ax$›</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹rightPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊃</span> <span class="free">B</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊃</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="comment1">(*&lt;*)</span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span><span class="comment1">(*&gt;*)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> g3ip›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹rightPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊃</span> <span class="free">B</span><span class="main">)</span>›</span></span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">(</span><span class="free">A</span><span class="main">⊃</span><span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="comment1">(*&lt;*)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> g3ip.cases<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">}</span></span>
   <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="comment1">(*&lt;*)</span><span class="keyword2"><span class="keyword">and</span></span> g3ip_upRules<span class="comment1">(*&gt;*)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rightInvertible<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"g3ip"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Ax <span class="main">∪</span> g3ip"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">n</span></span>
                            <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> E<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">B</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"imp"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Fs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">]</span>"</span></span><span class="main">]</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="NominalSequents">
<div class="head">
<h1>Theory NominalSequents</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(* Author : Peter Chapman *)</span>
<span class="comment1">(* License: LGPL *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"First Order Sequents"</span></span> 
<span class="keyword1"><span class="command">theory</span></span> NominalSequents
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Nominal/Nominal.html">HOL-Nominal.Nominal</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">atom_decl</span></span> var

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\section{First-Order Calculi \label{isafirstorder}}
To formalise first-order results we use the package \textit{Nominal Isabelle}.  The details, for the most part, are the same as in \S\ref{isadefs}.  However, we lose one important feature: that of polymorphism.

Recall we defined formulae as being indexed by a type of connectives.  We could then give abbreviations for these indexed formulae.  Unfortunately this feature (indexing by types) is not yet supported in \textit{Nominal Isabelle}.  Nested datatypes are also not supported.  Thus, strings are used for the connectives (both propositional and first-order) and lists of formulae are simulated to nest via a mutually recursive definition:

›</span></span>

<span class="keyword1"><span class="command">nominal_datatype</span></span> form <span class="main">=</span> At <span class="quoted"><span class="quoted">"nat"</span></span> <span class="quoted"><span class="quoted">"var list"</span></span> 
                                  <span class="main">|</span> Cpd0 <span class="quoted"><span class="quoted">"string"</span></span> <span class="quoted"><span class="quoted">"form_list"</span></span>
                                  <span class="main">|</span> Cpd1 <span class="quoted"><span class="quoted">"string"</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span>var<span class="main">»</span>form"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword3">(</span><span class="keyword1">∇</span> <span class="keyword1">[</span>_<span class="keyword1">].</span>_<span class="keyword3">)</span>"</span> <span class="comment1">(*&lt;*)</span><span class="main">[</span>100<span class="main">,</span>100<span class="main">,</span>100<span class="main">]</span>100<span class="comment1">(*&gt;*)</span><span class="main">)</span>
                                  <span class="main">|</span> ff
<span class="keyword2"><span class="keyword">and</span></span> form_list <span class="main">=</span> FNil
                   <span class="main">|</span> FCons <span class="quoted"><span class="quoted">"form"</span></span> <span class="quoted"><span class="quoted">"form_list"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">multiset_abbrev</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">\&lt;LM&gt;</span> _  <span class="keyword1">\&lt;RM&gt;</span>"</span> <span class="main">[</span>75<span class="main">]</span>75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main"><span class="free">\&lt;LM&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">\&lt;RM&gt;</span></span> <span class="main">≡</span> <span class="main">{#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">#}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">multiset_empty</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">\&lt;Empt&gt;</span>"</span> 75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">\&lt;Empt&gt;</span></span> <span class="main">≡</span> <span class="main">{#}</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> sequent <span class="main">=</span> Sequent <span class="quoted"><span class="quoted">"form multiset"</span></span> <span class="quoted"><span class="quoted">"form multiset"</span></span> <span class="main">(</span><span class="quoted">" <span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⇒*</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>6<span class="main">,</span>6<span class="main">]</span> 5<span class="main">)</span>


<span class="comment1">(* We have that any step in a rule, be it a primitive rule or an instance of a rule in a derivation
   can be represented as a list of premisses and a conclusion.  We need a list since a list is finite
   by definition *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> rule <span class="main">=</span> <span class="quoted"><span class="quoted">"sequent list <span class="main">*</span> sequent"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> deriv <span class="main">=</span> <span class="quoted"><span class="quoted">"sequent <span class="main">*</span> nat"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
<span class="entity">multiset_plus</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊕</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">::</span> form multiset<span class="main">)</span> <span class="main"><span class="free">⊕</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">::</span> form<span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">+</span> <span class="main">\&lt;LM&gt;</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">\&lt;RM&gt;</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span>
<span class="entity">multiset_minus</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊖</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">::</span> form multiset<span class="main">)</span> <span class="main"><span class="free">⊖</span></span>  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">::</span> form<span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">-</span> <span class="main">\&lt;LM&gt;</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">\&lt;RM&gt;</span>"</span></span> 

<span class="keyword1"><span class="command">consts</span></span>
  <span class="comment1">(* extend a sequent by adding another one.  A form of weakening.  Is this overkill by adding a sequent? *)</span>
  extend <span class="main">::</span> <span class="quoted"><span class="quoted">"sequent <span class="main">⇒</span> sequent <span class="main">⇒</span> sequent"</span></span>
  extendRule <span class="main">::</span> <span class="quoted"><span class="quoted">"sequent <span class="main">⇒</span> rule <span class="main">⇒</span> rule"</span></span>

  <span class="comment1">(* Unique conclusion Property *)</span>
  uniqueConclusion <span class="main">::</span> <span class="quoted"><span class="quoted">"rule set <span class="main">⇒</span> bool"</span></span>

  <span class="comment1">(* functions to get at components of sequents *)</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">antec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sequent <span class="main">⇒</span> form multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">antec</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ant</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sequent <span class="main">⇒</span> form multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">succ</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sequent <span class="main">⇒</span> form multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mset</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">seq_size</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sequent <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">seq_size</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> size <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">suc</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">set_of_seq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sequent <span class="main">⇒</span> form set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">set_of_seq</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> set_mset <span class="main">(</span>mset <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">set_of_prem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sequent list <span class="main">⇒</span> form set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_of_prem</span> Nil <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">set_of_prem</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> set_of_seq <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∪</span> <span class="free">set_of_prem</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>"</span></span>

<span class="comment1">(* Extend a sequent, and then a rule by adding seq to all premisses and the conclusion *)</span>
<span class="keyword1"><span class="command">overloading</span></span>
  extend <span class="main">≡</span> <span class="quoted">extend</span>
  extendRule <span class="main">≡</span> <span class="quoted">extendRule</span>
  uniqueConclusion <span class="main">≡</span> <span class="quoted">uniqueConclusion</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extend</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">extend</span> <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="free"><span class="bound"><span class="entity">seq</span></span></span> <span class="main">≡</span> <span class="main">(</span>antec <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="main">+</span> antec <span class="free"><span class="bound"><span class="entity">seq</span></span></span><span class="main">)</span> <span class="main">⇒*</span> <span class="main">(</span>succ <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="main">+</span> succ <span class="free"><span class="bound"><span class="entity">seq</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extendRule</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">extendRule</span> <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">(</span>map <span class="main">(</span>extend <span class="free"><span class="bound"><span class="entity">forms</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">,</span> extend <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* The unique conclusion property.  A set of rules has unique conclusion property if for any pair of rules,
   the conclusions being the same means the rules are the same*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uniqueConclusion</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rule set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">uniqueConclusion</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">r1</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">∀</span> <span class="bound">r2</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">(</span>snd <span class="bound">r1</span> <span class="main">=</span> snd <span class="bound">r2</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">r1</span> <span class="main">=</span><span class="bound">r2</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">sequentMinus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sequent <span class="main">⇒</span> form <span class="main">⇒</span> sequent"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">-</span> _"</span> <span class="main">[</span>100<span class="main">,</span>100<span class="main">]</span>100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⇒*</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span> <span class="main"><span class="free">-</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊖</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⇒*</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">⊖</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">listMinus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sequent list <span class="main">⇒</span> form <span class="main">⇒</span> sequent list"</span></span> <span class="main">(</span><span class="quoted">" _ <span class="keyword1">-</span> _ "</span> <span class="main">[</span>100<span class="main">,</span>100<span class="main">]</span>100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main"><span class="free">-</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">)</span> <span class="main"><span class="free">-</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span> <span class="main"><span class="free">-</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>


<span class="comment1">(* The formulation of various rule sets *)</span>

<span class="comment1">(* idRules is the set containing all identity RULES *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">Ax</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
   id<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ax</span>"</span></span>
<span class="main">|</span>  LBot<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ax</span>"</span></span>

<span class="comment1">(* upRules is the set of all rules which have a single conclusion.  This is akin to each rule having a 
   single principal formula.  We don't want rules to have no premisses, hence the restriction
   that ps ≠ [] *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">upRules</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
   I<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mset <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">\&lt;LM&gt;</span> Cpd0 <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">upRules</span>"</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent Formulae are quantified over a single variable at a time.  This is a restriction imposed by \textit{Nominal Isabelle}.  

There are two new \SC rule sets in addition to the propositional rule set: first-order rules without a freshness proviso and first-order rules with a freshness proviso.  Freshness provisos are particularly easy to encode in \textit{Nominal Isabelle}.  We also show that the rules with a freshness proviso form a subset of the first-order rules.  The function \texttt{set-of-prem} takes a list of premisses, and returns all the formulae in that list:
›</span></span>

<span class="comment1">(* provRules is the set of rules where we have a freshness proviso *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">provRules</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">(*&lt;*)</span> I<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mset <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∇</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">].</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">♯</span> set_of_prem <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">⟧</span>
                      <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">provRules</span>"</span></span>

<span class="comment1">(* nprovRules is the set of rules where we do not have a freshness proviso, but we have
   a first order formula *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">nprovRules</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="comment1">(*&lt;*)</span>I<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mset <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∇</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">].</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟧</span>
                   <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">nprovRules</span>"</span></span>

<span class="comment1">(* provRules are a subset of nprovRules *)</span>
<span class="keyword1"><span class="command">lemma</span></span> nprovContain<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"provRules <span class="main">⊆</span> nprovRules"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ps</span> <span class="skolem">c</span>
 <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> provRules"</span></span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> nprovRules"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> var <span class="main">⇒</span> var list <span class="main">⇒</span> var list"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">[</span>_<span class="keyword1">;</span>_<span class="keyword1">]</span>_"</span> <span class="main">[</span>100<span class="main">,</span>100<span class="main">,</span>100<span class="main">]</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  Empt<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main"><span class="free">]</span></span><span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> NEmpt<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main"><span class="free">]</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">#</span><span class="main">(</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main"><span class="free">]</span></span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="main">(</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main"><span class="free">]</span></span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_var_list_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">pi</span><span class="main">::</span><span class="quoted"><span class="quoted">"var prm"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="free">y</span><span class="main">::</span><span class="quoted"><span class="quoted">"var list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">pi</span><span class="main">∙</span><span class="main">(</span><span class="main">[</span><span class="free">z</span><span class="main">;</span><span class="free">x</span><span class="main">]</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">pi</span><span class="main">∙</span><span class="free">z</span><span class="main">)</span><span class="main">;</span><span class="main">(</span><span class="free">pi</span><span class="main">∙</span><span class="free">x</span><span class="main">)</span><span class="main">]</span><span class="main">(</span><span class="free">pi</span><span class="main">∙</span><span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">eqvts</span></span><span class="main">)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent Substitution is defined in the usual way:›</span></span>

<span class="keyword1"><span class="command">nominal_primrec</span></span> 
    <span class="entity">subst_form</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> var <span class="main">⇒</span> form <span class="main">⇒</span> form"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">[</span>_<span class="keyword1">,</span>_<span class="keyword1">]</span>_"</span><span class="comment1">(*&lt;*)</span> <span class="main">[</span>100<span class="main">,</span>100<span class="main">,</span>100<span class="main">]</span> 100<span class="comment1">(*&gt;*)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">subst_forms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> var <span class="main">⇒</span> form_list <span class="main">⇒</span> form_list"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">[</span>_<span class="keyword1">,</span>_<span class="keyword1">]</span>_"</span><span class="comment1">(*&lt;*)</span> <span class="main">[</span>100<span class="main">,</span>100<span class="main">,</span>100<span class="main">]</span> 100<span class="comment1">(*&gt;*)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main"><span class="free">]</span></span><span class="main">(</span>At <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> At <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">;</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">♯</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main"><span class="free">]</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∇</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">].</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∇</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">].</span><span class="main">(</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main"><span class="free">]</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main"><span class="free">]</span></span><span class="main">(</span>Cpd0 <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span><span class="main">)</span> <span class="main">=</span> Cpd0 <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main"><span class="free">]</span></span><span class="free"><span class="bound"><span class="entity">Fs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main"><span class="free">]</span></span>ff <span class="main">=</span> ff"</span></span>
<span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main"><span class="free">]</span></span>FNil <span class="main">=</span> FNil"</span></span>
<span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main"><span class="free">]</span></span><span class="main">(</span>FCons <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span><span class="main">)</span> <span class="main">=</span> FCons <span class="main">(</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main"><span class="free">]</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main"><span class="free">]</span></span><span class="free"><span class="bound"><span class="entity">Fs</span></span></span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">finite_guess</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> TrueI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_fresh<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fresh_guess</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_string<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\noindent Substitution is extended to multisets in the obvious way.

To formalise the condition ``no specific substitutions'', an inductive predicate is introduced.  If some formula in the multiset $\Gamma$ is a non-trivial substitution, then \texttt{multSubst} $\Gamma$:
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">multSubst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
multSubst_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">multSubst</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span> <span class="main">∈</span> <span class="main">(</span>set_mset <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">B</span><span class="main">.</span> <span class="main">[</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">]</span><span class="bound">B</span> <span class="main">=</span> <span class="bound">A</span> <span class="main">∧</span> <span class="bound">y</span><span class="main">≠</span><span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent The notation $[z;y]xs$ stands for substitution of a variable in a variable list.  The details are simple, and so are not shown.

Extending the rule sets with passive parts depends upon which kind of active part is being extended.  The active parts with freshness contexts have additional constraints upon the multisets which are added:
›</span></span>

<span class="comment1">(* We need to be careful now about how to extend a rule, since we have binding *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">extRules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rule set <span class="main">⇒</span> rule set"</span></span>   <span class="main">(</span><span class="quoted">" _<span class="keyword1">*</span>"</span> <span class="main">)</span>
   <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rule set"</span></span>
   <span class="keyword2"><span class="keyword">where</span></span>
  id<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> Ax <span class="main">⟧</span> <span class="main">⟹</span> extendRule <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="free">*</span></span>"</span></span>
<span class="main">|</span> sc<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> upRules <span class="main">⟧</span> <span class="main">⟹</span> extendRule <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="free">*</span></span>"</span></span>
<span class="main">|</span> np<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> nprovRules <span class="main">⟧</span> <span class="main">⟹</span> extendRule <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="free">*</span></span>"</span></span>
<span class="main">|</span> p<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∈</span> provRules <span class="main">;</span> mset <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∇</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">].</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">♯</span> set_of_seq <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟧</span>
                          <span class="main">⟹</span> extendRule <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="free">*</span></span>"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="comment1">(* A formulation of what it means to be a principal formula for a rule.  Note that we have to build up from
   single conclusion rules.   *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">leftPrincipal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rule <span class="main">⇒</span> form <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  sc<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> ff <span class="main">⟧</span>  <span class="main">⟹</span> 
                   <span class="free">leftPrincipal</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>


<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">rightPrincipal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rule <span class="main">⇒</span> form <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  sc<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">rightPrincipal</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>


<span class="comment1">(* What it means to be a derivable sequent.  Can have this as a predicate or as a set.
   The two formation rules say that the supplied premisses are derivable, and the second says
   that if all the premisses of some rule are derivable, then so is the conclusion. *)</span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">derivable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rule set <span class="main">⇒</span> deriv set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rule set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
   base<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable</span> <span class="free">R</span>"</span></span>
<span class="main">|</span>  step<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">;</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">≠</span><span class="main">[]</span> <span class="main">;</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable</span> <span class="free">R</span> <span class="main">⟧</span> 
                       <span class="main">⟹</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable</span> <span class="free">R</span>"</span></span>


<span class="comment1">(* Characterisation of a sequent *)</span>
<span class="keyword1"><span class="command">lemma</span></span> characteriseSeq<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span> <span class="main">::</span> sequent<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">A</span> <span class="main">⇒*</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(* Helper function for later *)</span>
<span class="keyword1"><span class="command">lemma</span></span> nonEmptySet<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>neq_Nil_conv<span class="main">)</span>


<span class="comment1">(* Lemma which says that if we have extended an identity rule, then the propositional variable is
   contained in the extended multisets *)</span>
<span class="keyword1"><span class="command">lemma</span></span> extendID<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="free">xs</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="free">xs</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"At <span class="free">i</span> <span class="free">xs</span> <span class="main">∈#</span> <span class="free">Γ</span> <span class="main">∧</span> At <span class="free">i</span> <span class="free">xs</span> <span class="main">∈#</span> <span class="free">Δ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ'</span> <span class="bound">Δ'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">=</span> <span class="bound">Γ'</span> <span class="main">⊕</span> At <span class="free">i</span> <span class="free">xs</span> <span class="main">∧</span> <span class="free">Δ</span> <span class="main">=</span> <span class="bound">Δ'</span> <span class="main">⊕</span> At <span class="free">i</span> <span class="free">xs</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="free">xs</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="free">xs</span> <span class="main">\&lt;RM&gt;</span>"</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> extendFalsum<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">=</span> <span class="bound">Γ'</span> <span class="main">⊕</span> ff"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span>"</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="comment1">(* Lemma that says if a propositional variable is in both the antecedent and succedent of a sequent,
   then it is derivable from idscRules *)</span>
<span class="keyword1"><span class="command">lemma</span></span> containID<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"At <span class="free">i</span> <span class="free">xs</span> <span class="main">∈#</span> <span class="free">Γ</span> <span class="main">∧</span> At <span class="free">i</span> <span class="free">xs</span> <span class="main">∈#</span> <span class="free">Δ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"Ax <span class="main">⊆</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="free">xs</span> <span class="main">⊕</span> At <span class="free">i</span> <span class="free">xs</span> <span class="main">∧</span> <span class="free">Δ</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="free">xs</span> <span class="main">⊕</span> At <span class="free">i</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="main">(</span><span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⇒*</span> <span class="main">(</span><span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="free">xs</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="free">xs</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="free">xs</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>At <span class="free">i</span> <span class="free">xs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span> <span class="free">xs</span><span class="main">\&lt;RM&gt;</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="free">xs</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="free">xs</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">ultimately</span></span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">∈</span> extRules <span class="free">R</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> extRules.id<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span> <span class="free">xs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span> <span class="free">xs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="free">xs</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="free">xs</span>"</span></span><span class="main">]</span> 
       <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="free">xs</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span> <span class="free">xs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span> <span class="free">xs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> derivable.base<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> containFalsum<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="free">Γ</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span>  b<span class="main">:</span> <span class="quoted"><span class="quoted">"Ax <span class="main">⊆</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⊕</span> ff"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">moreover</span></span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> extRules.id<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span><span class="main">]</span>
       <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> derivable.base<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 


<span class="comment1">(* Lemma which says that if r is an identity rule, then r is of the form
   ([], P ⇒* P) *)</span>
<span class="keyword1"><span class="command">lemma</span></span> characteriseAx<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax <span class="main">⟹</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="bound">i</span> <span class="bound">xs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="bound">i</span> <span class="bound">xs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>


<span class="comment1">(* A lemma about the last rule used in a derivation, i.e. that one exists *)</span>
<span class="keyword1"><span class="command">lemma</span></span> characteriseLast<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="free">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
             <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> 
             <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="bound">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
    <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="bound">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">r</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">=</span><span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">Ps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">r</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
    <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="bound">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span><span class="main">=</span><span class="skolem">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">lemma</span></span> propRuleCharacterise<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">F</span> <span class="bound">Fs</span><span class="main">.</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Cpd0 <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Cpd0 <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ</span></span> <span class="skolem"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> characteriseSeq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">F</span> <span class="bound">Fs</span><span class="main">.</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Cpd0 <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Cpd0 <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹mset <span class="free">C</span> <span class="main">≡</span> <span class="main">\&lt;LM&gt;</span>Cpd0 <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mset.simps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ant<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> suc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> union_is_single<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Cpd0 <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> provRuleCharacterise<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> provRules"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">F</span> <span class="bound">x</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="bound">F</span> <span class="main">∇</span> <span class="main">[</span><span class="bound">x</span><span class="main">].</span><span class="bound">A</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> <span class="bound">F</span> <span class="main">∇</span> <span class="main">[</span><span class="bound">x</span><span class="main">].</span><span class="bound">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">♯</span> set_of_prem <span class="main">(</span><span class="free">Ps</span> <span class="main">-</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">F</span> <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ</span></span> <span class="skolem"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> characteriseSeq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∈</span> provRules"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">F</span> <span class="bound">x</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="bound">F</span> <span class="main">∇</span> <span class="main">[</span><span class="bound">x</span><span class="main">].</span><span class="bound">A</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> <span class="bound">F</span> <span class="main">∇</span> <span class="main">[</span><span class="bound">x</span><span class="main">].</span><span class="bound">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">♯</span> set_of_prem <span class="main">(</span><span class="free">Ps</span> <span class="main">-</span> <span class="bound">A</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹mset <span class="free">C</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span> <span class="skolem">F</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span><span class="skolem">A</span> <span class="main">\&lt;RM&gt;</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">♯</span> set_of_prem <span class="main">(</span><span class="free">Ps</span> <span class="main">-</span> <span class="skolem">A</span><span class="main">)</span>›</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mset.simps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ant<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> suc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> union_is_single<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span><span class="skolem">A</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nprovRuleCharacterise<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> nprovRules"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">F</span> <span class="bound">x</span> <span class="bound">A</span><span class="main">.</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="bound">F</span> <span class="main">∇</span> <span class="main">[</span><span class="bound">x</span><span class="main">].</span><span class="bound">A</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> <span class="bound">F</span> <span class="main">∇</span> <span class="main">[</span><span class="bound">x</span><span class="main">].</span><span class="bound">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">F</span> <span class="skolem">x</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ</span></span> <span class="skolem"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> characteriseSeq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∈</span> nprovRules"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">F</span> <span class="bound">x</span> <span class="bound">A</span><span class="main">.</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="bound">F</span> <span class="main">∇</span> <span class="main">[</span><span class="bound">x</span><span class="main">].</span><span class="bound">A</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> <span class="bound">F</span> <span class="main">∇</span> <span class="main">[</span><span class="bound">x</span><span class="main">].</span><span class="bound">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹mset <span class="free">C</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span> <span class="skolem">F</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span><span class="skolem">A</span> <span class="main">\&lt;RM&gt;</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mset.simps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ant<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> suc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> union_is_single<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span><span class="skolem">A</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> extendEmpty<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="operator">auto</span>



<span class="keyword1"><span class="command">lemma</span></span> extendContain<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="free">S</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="free">p</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> set <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="free">p</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="free">S</span> <span class="free">r</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span> <span class="main">=</span> <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span> 
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finSeqSet<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sequent"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_of_seq <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ</span></span> <span class="skolem"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>finite_set_mset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finPremSet<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Ps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sequent list"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_of_prem <span class="free">Ps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Ps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>finSeqSet<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> finSupp<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">As</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form_list"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>supp <span class="free">A</span><span class="main">)</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>supp <span class="free">As</span><span class="main">)</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">As</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>form_form_list.strong_inducts<span class="main">)</span>
<span class="keyword1"><span class="command">print_cases</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>At <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span>   
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="skolem">xs</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span>supp <span class="skolem">xs</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>supp_list_nil supp_set_empty supp_list_cons supp_atm<span class="main">)</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="skolem">xs</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>At <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> supp <span class="skolem">n</span> <span class="main">∪</span> <span class="main">(</span>supp <span class="skolem">xs</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> form.supp<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?x2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?x1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>At <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>supp <span class="skolem">xs</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> supp_nat<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> FNil
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp FNil <span class="main">=</span> <span class="main">(</span><span class="main">{}</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> form_list.supp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FCons <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> form_list.supp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cpd0 <span class="skolem">Str</span> <span class="skolem">Fs</span><span class="main">)</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> form.supp<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?x2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Str</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?x1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Fs</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> supp_string<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Str</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cpd1 <span class="skolem">F</span> <span class="skolem">x</span> <span class="skolem">B</span><span class="main">)</span>
   <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>supp <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main">[</span><span class="skolem">x</span><span class="main">].</span><span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> supp <span class="skolem">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> abs_fun_supp<span class="main">[</span><span class="operator">OF</span> pt_var_inst<span class="main">,</span> <span class="operator">OF</span> at_var_inst<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> form.supp<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?x3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?x1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?x2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> supp_string<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">F</span></span><span class="main">]</span>
                   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>supp <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> ff
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> form.supp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> getFresh<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sequent"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Ps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sequent list"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="main">(</span><span class="bound">y</span> <span class="main">::</span> var<span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">♯</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">♯</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">♯</span> set_of_seq <span class="free">S</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">♯</span> set_of_prem <span class="free">Ps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">∪</span> set_of_seq <span class="free">S</span> <span class="main">∪</span> set_of_prem <span class="free">Ps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finSeqSet <span class="keyword2"><span class="keyword">and</span></span> finPremSet <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">∪</span> set_of_seq <span class="free">S</span> <span class="main">∪</span> set_of_prem <span class="free">Ps</span><span class="main">)</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> finSupp<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> supp_of_fin_sets<span class="main">[</span><span class="operator">OF</span> pt_var_inst<span class="main">,</span> <span class="operator">OF</span> at_var_inst<span class="main">,</span> <span class="operator">OF</span> fs_var_inst<span class="main">,</span>
                                           <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">∪</span> set_of_seq <span class="free">S</span> <span class="main">∪</span> set_of_prem <span class="free">Ps</span><span class="main">)</span>"</span></span><span class="main">]</span> 
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="main">(</span><span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">∪</span> set_of_seq <span class="free">S</span> <span class="main">∪</span> set_of_prem <span class="free">Ps</span><span class="main">)</span> <span class="main">∪</span> supp <span class="free">x</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> supp_atm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> <span class="main">(</span>supp <span class="main">(</span><span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">∪</span> set_of_seq <span class="free">S</span> <span class="main">∪</span> set_of_prem <span class="free">Ps</span><span class="main">)</span> <span class="main">∪</span> supp <span class="free">x</span> <span class="main">::</span> var set<span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> ex_in_inf<span class="main">[</span><span class="operator">OF</span> at_var_inst<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">∪</span> set_of_seq <span class="free">S</span> <span class="main">∪</span> set_of_prem <span class="free">Ps</span><span class="main">)</span> <span class="main">∪</span> supp <span class="free">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> supp <span class="free">x</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∉</span> supp <span class="main">(</span><span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">∪</span> set_of_seq <span class="free">S</span> <span class="main">∪</span> set_of_prem <span class="free">Ps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">♯</span> <span class="main">(</span><span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">∪</span> set_of_seq <span class="free">S</span> <span class="main">∪</span> set_of_prem <span class="free">Ps</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">♯</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fresh_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x</span></span><span class="main">]</span>
     <span class="keyword2"><span class="keyword">and</span></span> fresh_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">∪</span> set_of_seq <span class="free">S</span> <span class="main">∪</span> set_of_prem <span class="free">Ps</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">♯</span> <span class="free">A</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">♯</span> <span class="main">(</span>set_of_seq <span class="free">S</span> <span class="main">∪</span> set_of_prem <span class="free">Ps</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">♯</span> <span class="free">x</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> fresh_fin_insert<span class="main">[</span><span class="operator">OF</span> pt_var_inst<span class="main">,</span> <span class="operator">OF</span> at_var_inst<span class="main">,</span> <span class="operator">OF</span> fs_var_inst<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"set_of_seq <span class="free">S</span> <span class="main">∪</span> set_of_prem <span class="free">Ps</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">A</span></span><span class="main">]</span>
       <span class="keyword2"><span class="keyword">and</span></span> finSeqSet <span class="keyword2"><span class="keyword">and</span></span> finPremSet <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">♯</span> <span class="free">A</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">♯</span> set_of_seq <span class="free">S</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">♯</span> set_of_prem <span class="free">Ps</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">♯</span> <span class="free">x</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> fresh_fin_union<span class="main">[</span><span class="operator">OF</span> pt_var_inst<span class="main">,</span><span class="operator">OF</span> at_var_inst<span class="main">,</span> <span class="operator">OF</span> fs_var_inst<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"set_of_seq <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"set_of_prem <span class="free">Ps</span>"</span></span><span class="main">]</span>
       <span class="keyword2"><span class="keyword">and</span></span> finSeqSet <span class="keyword2"><span class="keyword">and</span></span> finPremSet <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> switchAux<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var list"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">♯</span> <span class="free">Xs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span><span class="main">;</span><span class="free">x</span><span class="main">]</span><span class="free">Xs</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">]</span><span class="main">∙</span><span class="free">Xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Xs</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">print_cases</span></span>
<span class="keyword3"><span class="command">case</span></span> Nil
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> nil_eqvt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">As</span><span class="main">)</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">♯</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">♯</span> <span class="skolem">As</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span><span class="main">;</span><span class="free">x</span><span class="main">]</span><span class="skolem">As</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">]</span><span class="main">∙</span><span class="skolem">As</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> fresh_list_cons<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">As</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> NEmpt<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> z<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ys<span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">As</span></span><span class="main">]</span> 
                 <span class="keyword2"><span class="keyword">and</span></span> cons_eqvt<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pi<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">As</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">perm_simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>fresh_atm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> switch<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">As</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form_list"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">♯</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">]</span><span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">]</span><span class="main">∙</span><span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">♯</span> <span class="free">As</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">]</span><span class="free">As</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">]</span><span class="main">∙</span><span class="free">As</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">As</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>form_form_list.strong_inducts<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>At <span class="skolem">n</span> <span class="skolem">xs</span> <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">♯</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> form.fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> perm_nat_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pi<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> switchAux<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> FNil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FCons <span class="skolem">B</span> <span class="skolem">Bs</span> <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cpd0 <span class="skolem">Str</span> <span class="skolem">Bs</span> <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cpd0.hyps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ba<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> form.fresh
    <span class="keyword2"><span class="keyword">and</span></span> perm_string<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Str</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> pi<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cpd1 <span class="skolem">F</span> <span class="skolem">a</span> <span class="skolem">B</span> <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">♯</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> form.fresh<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?x3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?x1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?x2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> 
    <span class="keyword2"><span class="keyword">and</span></span> fresh_atm<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> fresh_string<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">F</span></span><span class="main">]</span> 
    <span class="keyword2"><span class="keyword">and</span></span> fresh_abs_funE<span class="main">[</span><span class="operator">OF</span> pt_var_inst<span class="main">,</span> <span class="operator">OF</span> at_var_inst<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> finSupp<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cpd1<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ba<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> form.fresh <span class="keyword2"><span class="keyword">and</span></span> Cpd1<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> perm_string<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pi<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">F</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> fresh_atm <span class="keyword1"><span class="command">by</span></span> <span class="operator">perm_simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> ff
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>
    

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent The final clause says we can only use an $S$ which is suitable fresh.

The only lemma which is unique to first-order calculi is the Substitution Lemma.  We show the crucial step in the proof; namely that one can substitute a fresh variable into a formula and the resultant formula is unchanged.  The proof is not particularly edifying and is omitted:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> formSubst<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">♯</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">♯</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">=</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span><span class="main">(</span><span class="main">[</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">]</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">♯</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">♯</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="free">y</span><span class="main">].</span><span class="main">(</span><span class="main">[</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">]</span><span class="free">A</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> abs_fun_eq3<span class="main">[</span><span class="operator">OF</span> pt_var_inst<span class="main">,</span> <span class="operator">OF</span> at_var_inst<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">]</span><span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">and</span></span> switch<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> fresh_atm<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">perm_simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> form.inject<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent  Using the above lemma, we can change any sequent to an equivalent new sequent which does not contain certain variables.  Therefore, we can extend with any sequent:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extend_for_any_seq<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sequent"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> rules<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R2</span> <span class="main">⊆</span> nprovRules <span class="main">∧</span> <span class="free">R3</span> <span class="main">⊆</span> provRules"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> rules2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> rin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="free">S</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span>
 <span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> rin <span class="keyword2"><span class="keyword">and</span></span> rules2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="free">S</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extRules.id<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> rin <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">R1</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="free">S</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extRules.sc<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> rin <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> nprovRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="free">S</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extRules.np<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> rin <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">moreover</span></span>

 <span class="keyword1"><span class="command">{</span></span><span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹\noindent  We only show the interesting case: where the last inference had a freshness proviso:›</span></span>
  
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> provRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> r2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> provRules"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> provRules›</span></span> <span class="keyword2"><span class="keyword">and</span></span> rin <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">A</span></span> 
       <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">F</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span><span class="skolem">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> 
                 <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">F</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span><span class="skolem">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">♯</span> set_of_prem <span class="main">(</span> <span class="skolem">ps</span> <span class="main">-</span> <span class="skolem">A</span> <span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> provRuleCharacterise<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span><span class="main">]</span><span class="comment1">(*&gt;*)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> provRules›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">c</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span> <span class="skolem">F</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">x</span><span class="main">].</span><span class="skolem">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">♯</span> set_of_prem <span class="main">(</span><span class="skolem">ps</span> <span class="main">-</span> <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command">using</span></span> mset.simps<span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> fr<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">♯</span> <span class="skolem">x</span> <span class="main">∧</span> 
                                  <span class="skolem">y</span> <span class="main">♯</span> <span class="skolem">A</span> <span class="main">∧</span> 
                                  <span class="skolem">y</span> <span class="main">♯</span> set_of_seq <span class="free">S</span> <span class="main">∧</span> 
                                 <span class="main">(</span><span class="skolem">y</span> <span class="main">::</span> var<span class="main">)</span> <span class="main">♯</span> set_of_prem <span class="main">(</span><span class="skolem">ps</span><span class="main">-</span><span class="skolem">A</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> getFresh<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">ps</span><span class="main">-</span><span class="skolem">A</span>"</span></span><span class="main">]</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fr2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">♯</span> set_of_seq <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">c</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span> <span class="skolem">F</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span><span class="main">(</span><span class="main">[</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">x</span><span class="main">]</span><span class="skolem">A</span><span class="main">)</span> <span class="main">\&lt;RM&gt;</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">♯</span> set_of_prem <span class="main">(</span><span class="skolem">ps</span> <span class="main">-</span> <span class="skolem">A</span><span class="main">)</span>"</span></span> 
         <span class="keyword1"><span class="command">using</span></span> formSubst <span class="keyword2"><span class="keyword">and</span></span> fr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">c</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span> <span class="skolem">F</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span><span class="main">(</span><span class="main">[</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">x</span><span class="main">]</span><span class="skolem">A</span><span class="main">)</span> <span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="free">S</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r1 <span class="keyword2"><span class="keyword">and</span></span> r2 <span class="keyword2"><span class="keyword">and</span></span> fr2
         <span class="keyword2"><span class="keyword">and</span></span> extRules.p<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">x</span><span class="main">]</span><span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span><span class="main">]</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="free">S</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="comment1">(*&lt;*)</span> <span class="keyword1"><span class="command">}</span></span>

<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(* Constructing the rule set we will use.  It contains all axioms, but only a subset
   of the possible logical rules. *)</span>
<span class="keyword1"><span class="command">lemma</span></span> ruleSet<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> upRules"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R2</span> <span class="main">⊆</span> nprovRules"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R3</span> <span class="main">⊆</span> provRules"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span> <span class="bound">r</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R3</span> <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> Ax<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span> <span class="bound">r</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="skolem">S</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R3</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Non-principal rule lemma *)</span>
<span class="keyword1"><span class="command">lemma</span></span> nonPrincipalInvertRight<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> upRules"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R2</span> <span class="main">⊆</span> nprovRules"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R3</span> <span class="main">⊆</span> provRules"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Γ</span> <span class="bound">Δ</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> rightPrincipal <span class="bound">r'</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">¬</span> multSubst <span class="free">Γ'</span> <span class="main">∧</span> <span class="main">¬</span> multSubst <span class="free">Δ'</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> rightPrincipal <span class="bound">r'</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> multSubst <span class="free">Γ'</span> <span class="main">∧</span> <span class="main">¬</span> multSubst <span class="free">Δ'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> np<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ext<span class="main">:</span> <span class="quoted"><span class="quoted">"extendRule <span class="free">S</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> num<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">n'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> ext <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="skolem"><span class="skolem">Ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>  <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span>
     <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">R1</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R1</span> <span class="main">⊆</span> upRules›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Cpd0 <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Cpd0 <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> propRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Cpd0 <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Cpd0 <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> provRules <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> nprovRules"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R2</span> <span class="main">⊆</span> nprovRules›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R3</span> <span class="main">⊆</span> provRules›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="skolem">T</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span><span class="skolem">B</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> <span class="skolem">T</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span><span class="skolem">B</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> provRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span>
            <span class="keyword2"><span class="keyword">and</span></span> nprovRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="skolem">T</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span><span class="skolem">B</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="free">r</span> <span class="main">(</span><span class="skolem">T</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span><span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span><span class="skolem">B</span> <span class="main">≠</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="skolem">T</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span><span class="skolem">B</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="skolem">T</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span><span class="skolem">B</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"succ <span class="free">S</span> <span class="main">+</span> succ <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span> 
         <span class="keyword1"><span class="command">using</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span><span class="main">]</span>
                   <span class="keyword2"><span class="keyword">and</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="free">r</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">H</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R1</span> <span class="main">⊆</span> upRules›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R2</span> <span class="main">⊆</span> nprovRules›</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R3</span> <span class="main">⊆</span> provRules›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∈</span> nprovRules <span class="main">∨</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∈</span> provRules"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> propRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span>
       <span class="keyword2"><span class="keyword">and</span></span> nprovRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span>
       <span class="keyword2"><span class="keyword">and</span></span> provRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">∈#</span> <span class="skolem">Ψ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">H</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">∈#</span> <span class="skolem">Ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">T</span><span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ</span> <span class="main">⊕</span> <span class="skolem">T</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">H</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="skolem">Ψ</span> <span class="main">⊕</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="free">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">Ψ</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">T</span><span class="main">}</span> <span class="main">=</span> set_mset <span class="free">Δ</span> <span class="main">∪</span> <span class="main">{</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">T</span><span class="main">\&lt;RM&gt;</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">\&lt;LM&gt;</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">≠</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">∈</span> set_mset <span class="skolem">Ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">∈#</span> <span class="skolem">Ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">∈#</span> <span class="skolem">Ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ψ1</span><span class="main">.</span> <span class="skolem">Ψ</span> <span class="main">=</span> <span class="bound">Ψ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> 
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Ψ</span> <span class="main">⊖</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ψ1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="free">S</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> extendRule_def <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="free">S</span> <span class="bound">p'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ex_map_conv<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ys<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extend <span class="free">S</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">∈#</span> succ <span class="bound">p</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">∈#</span> <span class="skolem">Ψ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> 
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> characteriseSeq
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="improper">xa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="improper">xa</span> <span class="main">⊖</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> 
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">with</span></span> all <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">≤</span><span class="free">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">≤</span><span class="free">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> num <span class="keyword2"><span class="keyword">and</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> c'
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">hypsubst_thin</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Φ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ψ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">arith</span><span class="main">)</span>
<span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps'</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Ps</span> <span class="main">=</span> length <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps'</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span>›</span></span>
                              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span>›</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> extend_for_any_seq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span><span class="main">]</span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R1</span> <span class="main">⊆</span> upRules›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R2</span> <span class="main">⊆</span> nprovRules›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R3</span> <span class="main">⊆</span> provRules›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="free">S</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span>
         <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def union_ac<span class="main">)</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> extend <span class="free">S</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>           
<span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_def<span class="main">)</span> 
<span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="free">S</span> <span class="bound">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span>
               <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Φ'</span> <span class="skolem">Ψ'</span>
                 <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span>  
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> a1 <span class="keyword2"><span class="keyword">and</span></span> d1
                           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">" <span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> 
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">=</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">from</span></span> ant <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">moreover</span></span>
                 <span class="keyword1"><span class="command">from</span></span> suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">=</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> t <span class="keyword2"><span class="keyword">and</span></span> c2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
               <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span>
               <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Φ'</span> <span class="skolem">Ψ'</span>
                 <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span>  
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> d2
                           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> 
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">from</span></span> ant <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">moreover</span></span>
                 <span class="keyword1"><span class="command">from</span></span> suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ψ1</span> <span class="main">+</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">=</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ψ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> 
                      <span class="keyword1"><span class="command">using</span></span> extend_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Φ</span>  <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> t <span class="keyword2"><span class="keyword">and</span></span> c1
                      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
               <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">ultimately</span></span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">≤</span><span class="free">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>
                <span class="main">∧</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> a2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Φ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ψ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>  
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Φ'</span> <span class="main">⇒*</span> <span class="improper">Ψ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> all<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> num
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps'</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(* Non-principal Left *)</span>
<span class="keyword1"><span class="command">lemma</span></span> nonPrincipalInvertLeft<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> upRules"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R2</span> <span class="main">⊆</span> nprovRules"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R3</span> <span class="main">⊆</span> provRules"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Γ</span> <span class="bound">Δ</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="bound">Δ</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> leftPrincipal <span class="bound">r'</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">¬</span> multSubst <span class="free">Γ'</span> <span class="main">∧</span> <span class="main">¬</span> multSubst <span class="free">Δ'</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> leftPrincipal <span class="bound">r'</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> multSubst <span class="free">Γ'</span> <span class="main">∧</span> <span class="main">¬</span> multSubst <span class="free">Δ'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> np<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ext<span class="main">:</span> <span class="quoted"><span class="quoted">"extendRule <span class="free">S</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> num<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">n'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> ext <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="skolem"><span class="skolem">Ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>  <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span>
     <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">R1</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R1</span> <span class="main">⊆</span> upRules›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Cpd0 <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Cpd0 <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> propRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Cpd0 <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Cpd0 <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> provRules <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> nprovRules"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R2</span> <span class="main">⊆</span> nprovRules›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R3</span> <span class="main">⊆</span> provRules›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="skolem">T</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span><span class="skolem">B</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> <span class="skolem">T</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span><span class="skolem">B</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> provRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span>
            <span class="keyword2"><span class="keyword">and</span></span> nprovRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="skolem">T</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span><span class="skolem">B</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>         
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="skolem">T</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span><span class="skolem">B</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="free">r</span> <span class="main">(</span><span class="skolem">T</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span><span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span><span class="skolem">B</span> <span class="main">≠</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> <span class="skolem">T</span> <span class="main">∇</span> <span class="main">[</span><span class="skolem">y</span><span class="main">].</span><span class="skolem">B</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"antec <span class="free">S</span> <span class="main">+</span> antec <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span> 
         <span class="keyword1"><span class="command">using</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span><span class="main">]</span>
                   <span class="keyword2"><span class="keyword">and</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="free">r</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">G</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R1</span> <span class="main">⊆</span> upRules›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R2</span> <span class="main">⊆</span> nprovRules›</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R3</span> <span class="main">⊆</span> provRules›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∈</span> nprovRules <span class="main">∨</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∈</span> provRules"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> propRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span>
       <span class="keyword2"><span class="keyword">and</span></span> nprovRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span>
       <span class="keyword2"><span class="keyword">and</span></span> provRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">G</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">∈#</span> <span class="skolem">Φ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">G</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">G</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">∈#</span> <span class="skolem">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">G</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">T</span><span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">⊕</span> <span class="skolem">T</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">G</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⊕</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="free">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">Φ</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">T</span><span class="main">}</span> <span class="main">=</span> set_mset <span class="free">Γ</span> <span class="main">∪</span> <span class="main">{</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">G</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">T</span><span class="main">\&lt;RM&gt;</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">\&lt;LM&gt;</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">G</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">≠</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">∈</span> set_mset <span class="skolem">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">∈#</span> <span class="skolem">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">∈#</span> <span class="skolem">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Φ1</span><span class="main">.</span> <span class="skolem">Φ</span> <span class="main">=</span> <span class="bound">Φ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> 
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">⊖</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Φ1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="free">S</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> extendRule_def <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="free">S</span> <span class="bound">p'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ex_map_conv<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ys<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extend <span class="free">S</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">∈#</span> antec <span class="bound">p</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">∈#</span> <span class="skolem">Φ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> 
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> characteriseSeq
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="improper">xa</span> <span class="main">⊖</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="improper">xa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> 
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">with</span></span> all <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">≤</span><span class="free">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">≤</span><span class="free">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> num <span class="keyword2"><span class="keyword">and</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> c'
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">hypsubst_thin</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Φ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ψ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">arith</span><span class="main">)</span>
<span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps'</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Ps</span> <span class="main">=</span> length <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps'</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span>›</span></span>
                              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span>›</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> extend_for_any_seq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span><span class="main">]</span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R1</span> <span class="main">⊆</span> upRules›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R2</span> <span class="main">⊆</span> nprovRules›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R3</span> <span class="main">⊆</span> provRules›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="free">S</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>›</span></span>
         <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> extend <span class="free">S</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>           
<span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def extend_def<span class="main">)</span> 
<span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="free">S</span> <span class="bound">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span>
               <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Φ'</span> <span class="skolem">Ψ'</span>
                 <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span>  
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> a1 <span class="keyword2"><span class="keyword">and</span></span> d1
                           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">" <span class="skolem">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> 
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">=</span> <span class="skolem">Φ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">=</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">from</span></span> suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">moreover</span></span>
                 <span class="keyword1"><span class="command">from</span></span> ant <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">=</span> <span class="skolem">Φ1</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> t <span class="keyword2"><span class="keyword">and</span></span> c2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
               <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span>
               <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Φ'</span> <span class="skolem">Ψ'</span>
                 <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span>  
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> d2
                           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> 
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">from</span></span> ant <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">=</span> <span class="skolem">Φ1</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">moreover</span></span>
                 <span class="keyword1"><span class="command">from</span></span> suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">=</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> 
                      <span class="keyword1"><span class="command">using</span></span> extend_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>  <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> t <span class="keyword2"><span class="keyword">and</span></span> c1
                      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
               <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">ultimately</span></span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">≤</span><span class="free">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>
                <span class="main">∧</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> a2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Φ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ψ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>  
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Φ'</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="improper">Ψ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> all<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> num
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps'</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent We can then give the two inversion lemmata.  The principal case (where the last inference had a freshness proviso) for the right inversion lemma is shown:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> rightInvert<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Γ</span> <span class="free">Δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form multiset"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> rules<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R2</span> <span class="main">⊆</span> nprovRules <span class="main">∧</span> <span class="free">R3</span> <span class="main">⊆</span> provRules <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> rightPrincipal <span class="bound">r'</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> multSubst <span class="free">Γ'</span> <span class="main">∧</span> <span class="main">¬</span> multSubst <span class="free">Δ'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">+</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_less_induct<span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">Γ</span> <span class="skolem">Δ</span><span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Γ</span> <span class="bound">Δ</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> rightPrincipal <span class="bound">r'</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">¬</span> multSubst <span class="free">Γ'</span> <span class="main">∧</span> <span class="main">¬</span> multSubst <span class="free">Δ'</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span><span class="main">)</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> rightPrincipal <span class="bound">r'</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> multSubst <span class="free">Γ'</span> <span class="main">∧</span> <span class="main">¬</span> multSubst <span class="free">Δ'</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> 0
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">S</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R3</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> ruleSet<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span><span class="main">]</span>
           <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">moreover</span></span> 
           <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span>
               <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">∧</span> At <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">∈#</span> <span class="skolem">Δ</span>"</span></span> 
                 <span class="keyword1"><span class="command">using</span></span> extendID<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">∧</span> At <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">∈#</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules
                 <span class="keyword2"><span class="keyword">and</span></span> containID<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">moreover</span></span>
           <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span>
               <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span>"</span></span> 
                 <span class="keyword1"><span class="command">using</span></span> extendFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules
                 <span class="keyword2"><span class="keyword">and</span></span> containFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>      
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="bound">C</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                 <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R1</span>"</span></span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword1"><span class="command">moreover</span></span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> nprovRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword1"><span class="command">moreover</span></span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> provRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                 <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="bound">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span><span class="main">.</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                          <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                       d'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> characteriseLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R3</span><span class="main">)</span> <span class="main">∧</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rules 
            <span class="keyword2"><span class="keyword">and</span></span> ruleSet<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span> 
                    <span class="keyword2"><span class="keyword">and</span></span> e'<span class="main">:</span><span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span>
                            <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
                            <span class="keyword2"><span class="keyword">and</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">r</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R1</span>"</span></span>
         <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> sw<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> Cpd0 <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> Cpd0 <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> propRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rightPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span>rightPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">=</span>  <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">with</span></span> sw <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> nonPrincipalInvertRight<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span>
                                                <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Δ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span>
                                                <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span>
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> a' <span class="keyword2"><span class="keyword">and</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> e'
                  <span class="keyword2"><span class="keyword">and</span></span> c' <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R1</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> d' <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>         
        <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span>
         <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> nprovRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> rightPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> rules
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendContain<span class="main">)</span>
             <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹rightPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> nonPrincipalInvertRight<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span>
                                                <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Δ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span>
                                                <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span>
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> a' <span class="keyword2"><span class="keyword">and</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> e'
                  <span class="keyword2"><span class="keyword">and</span></span> c' <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> d' <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span>


  <span class="keyword1"><span class="command">{</span></span><span class="comment1">(*&gt;*)</span>
   
   
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span>
   <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> provRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> rightPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span><span class="comment1">(*&lt;*)</span> b' <span class="keyword2"><span class="keyword">and</span></span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> rules
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 
           <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendContain<span class="main">)</span>
       <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹rightPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> 
            <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="comment1">(*&lt;*)</span><span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span><span class="comment1">(*&gt;*)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
<span class="comment1">(*&lt;*)</span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> nonPrincipalInvertRight<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span>
                                                <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Δ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span>
                                                <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span>
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> a' <span class="keyword2"><span class="keyword">and</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> e'
                  <span class="keyword2"><span class="keyword">and</span></span> c' <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> d' <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>


<span class="keyword1"><span class="command">lemma</span></span> leftInvert<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Γ</span> <span class="free">Δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form multiset"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> rules<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R2</span> <span class="main">⊆</span> nprovRules <span class="main">∧</span> <span class="free">R3</span> <span class="main">⊆</span> provRules <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> leftPrincipal <span class="bound">r'</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> multSubst <span class="free">Γ'</span> <span class="main">∧</span> <span class="main">¬</span> multSubst <span class="free">Δ'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">+</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_less_induct<span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">Γ</span> <span class="skolem">Δ</span><span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Γ</span> <span class="bound">Δ</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="bound">Δ</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> leftPrincipal <span class="bound">r'</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">¬</span> multSubst <span class="free">Γ'</span> <span class="main">∧</span> <span class="main">¬</span> multSubst <span class="free">Δ'</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span><span class="main">)</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R</span><span class="main">.</span> leftPrincipal <span class="bound">r'</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> multSubst <span class="free">Γ'</span> <span class="main">∧</span> <span class="main">¬</span> multSubst <span class="free">Δ'</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> 0
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">S</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R3</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> ruleSet<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span><span class="skolem">Δ</span>"</span></span><span class="main">]</span>
           <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">moreover</span></span> 
           <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
               <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">∧</span> At <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">∈#</span> <span class="skolem">Δ</span>"</span></span> 
                 <span class="keyword1"><span class="command">using</span></span> extendID<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">∧</span> At <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">∈#</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules
                 <span class="keyword2"><span class="keyword">and</span></span> containID<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">moreover</span></span>
           <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
               <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span>"</span></span> 
                 <span class="keyword1"><span class="command">using</span></span> extendFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">⊕</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules
                 <span class="keyword2"><span class="keyword">and</span></span> containFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>      
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="bound">C</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                 <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R1</span>"</span></span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword1"><span class="command">moreover</span></span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> nprovRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword1"><span class="command">moreover</span></span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> provRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                 <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="bound">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span><span class="main">.</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="bound">S</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                          <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                       d'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> characteriseLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R3</span><span class="main">)</span> <span class="main">∧</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rules 
            <span class="keyword2"><span class="keyword">and</span></span> ruleSet<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R1</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R2</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span> 
                    <span class="keyword2"><span class="keyword">and</span></span> e'<span class="main">:</span><span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
                            <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
                            <span class="keyword2"><span class="keyword">and</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">r</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R1</span>"</span></span>
         <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> sw<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> Cpd0 <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> Cpd0 <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> propRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>leftPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span>leftPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">=</span>  <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">with</span></span> sw <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> nonPrincipalInvertLeft<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span>
                                                <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Δ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span>
                                                <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span>
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> a' <span class="keyword2"><span class="keyword">and</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> e'
                  <span class="keyword2"><span class="keyword">and</span></span> c' <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R1</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> d' <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>         
        <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span>
         <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> nprovRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> leftPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> rules
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendContain<span class="main">)</span>
             <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹leftPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> nonPrincipalInvertLeft<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span>
                                                <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Δ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span>
                                                <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span>
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> a' <span class="keyword2"><span class="keyword">and</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> e'
                  <span class="keyword2"><span class="keyword">and</span></span> c' <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> d' <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span>
         <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> provRules"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> leftPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> rules
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendContain<span class="main">)</span>
             <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹leftPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> <span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="skolem">r</span> <span class="main">(</span><span class="free">F</span> <span class="main">∇</span> <span class="main">[</span><span class="free">x</span><span class="main">].</span><span class="free">A</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> nonPrincipalInvertLeft<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> F<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span>
                                                <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Δ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span>
                                                <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span>
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> a' <span class="keyword2"><span class="keyword">and</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> e'
                  <span class="keyword2"><span class="keyword">and</span></span> c' <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R3</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> d' <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent In both cases, the assumption labelled $c$ captures the ``no specific substitution'' condition.  Interestingly, it is never used throughout the proof.  This highlights the difference between the object- and meta-level existential quantifiers.

Owing to the lack of indexing within datatypes, it is difficult to give an example demonstrating these results.  It would be little effort to change the theory file to accommodate type variables when they are supported in \textit{Nominal Isabelle}, at which time an example would be simple to write.  
›</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="ModalSequents">
<div class="head">
<h1>Theory ModalSequents</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(* AUTHOR : Peter Chapman  *)</span>
<span class="comment1">(* License: LGPL *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Modal Sequents"</span></span>

<span class="keyword1"><span class="command">theory</span></span> ModalSequents
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* -------------------------------
   -------------------------------
            Multiset2.thy
   -------------------------------
   ------------------------------- *)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">multiset_abbrev</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">\&lt;LM&gt;</span> _  <span class="keyword1">\&lt;RM&gt;</span>"</span> <span class="main">[</span>75<span class="main">]</span>75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main"><span class="free">\&lt;LM&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">\&lt;RM&gt;</span></span> <span class="main">≡</span> <span class="main">{#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">#}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">multiset_empty</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">\&lt;Empt&gt;</span>"</span> 75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">\&lt;Empt&gt;</span></span> <span class="main">≡</span> <span class="main">{#}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
<span class="entity">multiset_plus</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊕</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main"><span class="free">⊕</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">+</span> <span class="main">\&lt;LM&gt;</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">\&lt;RM&gt;</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span>
<span class="entity">multiset_minus</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊖</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main"><span class="free">⊖</span></span>  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">-</span> <span class="main">\&lt;LM&gt;</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">\&lt;RM&gt;</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span>
<span class="entity">multiset_map</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅⋅</span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span><span class="main"><span class="free">⋅⋅</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main">≡</span> image_mset <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span> 


<span class="keyword1"><span class="command">lemma</span></span> nonEmpty_contain<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">≠</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nonEmpty_neq<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">≠</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">+</span> <span class="free">C</span> <span class="main">≠</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> nonEmpty_contain <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈#</span> <span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="free">Γ</span> <span class="skolem">a</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_le_eq<span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">≠</span> count <span class="free">C</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">+</span> <span class="free">C</span> <span class="main">≠</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> nonEmpty_image<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">≠</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⋅⋅</span> <span class="free">Γ</span> <span class="main">≠</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> image_mset_is_empty_iff assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> single_plus_obtain<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> <span class="free">Γ</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Δ</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">=</span> <span class="bound">Δ</span> <span class="main">⊕</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊖</span> <span class="free">A</span> <span class="main">⊕</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">⊖</span><span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> singleton_add_means_equal<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊕</span> <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span><span class="free">Γ</span> <span class="main">⊕</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> size <span class="free">Γ</span> <span class="main">+</span> size <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">B</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="free">B</span><span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> singleton_add_means_empty<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊕</span> <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span><span class="free">Γ</span> <span class="main">⊕</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> size <span class="free">Γ</span> <span class="main">+</span> size <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">B</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> single_multiset_eq_non_empty<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">≠</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ'</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∧</span> <span class="free">Δ</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> size <span class="free">Δ</span> <span class="main">+</span> size <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> size <span class="free">Δ</span> <span class="main">+</span> size <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Δ</span> <span class="main">≠</span> <span class="main">\&lt;Empt&gt;</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> size <span class="free">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="free">Δ</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> size <span class="free">Δ'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ'</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> a b <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> two_neq_one_aux<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">⊕</span> <span class="free">B</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="free">C</span><span class="main">\&lt;RM&gt;</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">⊕</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">C</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">+</span> size <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">B</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">C</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> two_neq_one<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">⊕</span> <span class="free">B</span><span class="main">)</span> <span class="main">+</span> <span class="free">Γ</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="free">C</span><span class="main">\&lt;RM&gt;</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span><span class="main">⊕</span> <span class="free">B</span><span class="main">)</span> <span class="main">+</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">C</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">+</span> size <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">B</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">+</span> size <span class="free">Γ</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> add_equal_means_equal<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊕</span> <span class="free">A</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">⊕</span> <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="free">Δ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> add_eq_conv_diff<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="free">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>





<span class="comment1">(* -------------------------------
   -------------------------------
        SequentRulesModal2.thy
   -------------------------------
   ------------------------------- *)</span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\section{Modal Calculi \label{isamodal}}
Some new techniques are needed when formalising results about modal calculi.  A set of modal operators must index formulae (and sequents and rules), there must be a method for modalising a multiset of formulae and we need to be able to handle implicit weakening rules.

The first of these is easy; instead of indexing formulae by a single type variable, we index on a pair of type variables, one which contains the propositional connectives, and one which contains the modal operators:
›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> form <span class="main">=</span> At <span class="quoted"><span class="quoted">"nat"</span></span>
                                 <span class="main">|</span> Compound <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> form list"</span></span>
                                 <span class="main">|</span> Modal <span class="quoted"><span class="quoted">"<span class="tfree">'b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> form list"</span></span>
                                 <span class="main">|</span> ff

<span class="keyword1"><span class="command">datatype_compat</span></span> form

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent <span class="main">=</span> Sequent <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form<span class="main">)</span> multiset"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form<span class="main">)</span> multiset"</span></span> <span class="main">(</span><span class="quoted">" <span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⇒*</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>6<span class="main">,</span>6<span class="main">]</span> 5<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent list <span class="main">*</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> deriv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent <span class="main">*</span> nat"</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  <span class="comment1">(* extend a sequent by adding another one.  A form of weakening.  *)</span>
  extend <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent"</span></span>
  extendRule <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule"</span></span>
  extendRule2 <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule"</span></span>
  extendConc <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule"</span></span>

  <span class="comment1">(* Unique conclusion Property *)</span>
  uniqueConclusion <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule set <span class="main">⇒</span> bool"</span></span>

  <span class="comment1">(* Transform a multiset using a modal operator.  "Boxing" a context, effectively *)</span>
  modaliseMultiset <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form multiset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form multiset"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 200<span class="main">)</span>

  <span class="comment1">(* functions to get at components of sequents *)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">antec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">antec</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ant</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succ</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mset</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">seq_size</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">seq_size</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> size <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">suc</span></span></span>"</span></span>

<span class="comment1">(* Extend a sequent, and then a rule by adding seq to all premisses and the conclusion *)</span>
<span class="keyword1"><span class="command">overloading</span></span>
  extend <span class="main">≡</span> <span class="quoted">extend</span>
  extendRule <span class="main">≡</span> <span class="quoted">extendRule</span>
  extendRule2 <span class="main">≡</span> <span class="quoted">extendRule2</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extend</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">extend</span> <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="free"><span class="bound"><span class="entity">seq</span></span></span> <span class="main">≡</span> <span class="main">(</span>antec <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="main">+</span> antec <span class="free"><span class="bound"><span class="entity">seq</span></span></span><span class="main">)</span> <span class="main">⇒*</span> <span class="main">(</span>succ <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="main">+</span> succ <span class="free"><span class="bound"><span class="entity">seq</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extendRule</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">extendRule</span> <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">(</span>map <span class="main">(</span>extend <span class="free"><span class="bound"><span class="entity">forms</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">,</span> extend <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extendRule2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">extendRule2</span> <span class="free"><span class="bound"><span class="entity">S1</span></span></span> <span class="free"><span class="bound"><span class="entity">S2</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">(</span>map <span class="main">(</span>extend <span class="free"><span class="bound"><span class="entity">S1</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">,</span> extend <span class="free"><span class="bound"><span class="entity">S2</span></span></span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&gt;*)</span>

<span class="comment1">(* The unique conclusion property.  A set of rules has unique conclusion property if for any pair of rules,
   the conclusions being the same means the rules are the same*)</span>
<span class="keyword1"><span class="command">overloading</span></span>
  uniqueConclusion <span class="main">≡</span> <span class="quoted">uniqueConclusion</span>
  modaliseMultiset <span class="main">≡</span> <span class="quoted">modaliseMultiset</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uniqueConclusion</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">uniqueConclusion</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">r1</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">∀</span> <span class="bound">r2</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">(</span>snd <span class="bound">r1</span> <span class="main">=</span> snd <span class="bound">r2</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">r1</span> <span class="main">=</span><span class="bound">r2</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent Modalising multisets is relatively straightforward.  We use the notation $!\cdot \Gamma$, where $!$ is a modal operator and $\Gamma$ is a multiset of formulae:
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">modaliseMultiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form multiset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form multiset"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">modaliseMultiset</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">≡</span> <span class="main">{#</span> Modal <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">[</span><span class="bound">p</span><span class="main">]</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">#}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span> 
<span class="comment1">(* The formulation of various rule sets *)</span>

<span class="comment1">(* Ax is the set containing all identity RULES and LBot *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">Ax</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
   id<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ax</span>"</span></span>
<span class="main">|</span>  Lbot<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ax</span>"</span></span>

<span class="comment1">(* upRules is the set of all rules which have a single conclusion.  This is akin to each rule having a 
   single principal formula.  We don't want rules to have no premisses, hence the restriction
   that ps ≠ [] *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">upRules</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
   I<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mset <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span> Compound <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">upRules</span>"</span></span>


<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent Similarly to \S\ref{isafirstorder}, two new rule sets are created.  The first are the normal modal rules:
›</span></span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">modRules2</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="comment1">(*&lt;*)</span>I<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">;</span> mset <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span> Modal <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">Ms</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">modRules2</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent The second are the \textit{modalised context rules}.  Taking a subset of the normal modal rules, we extend using a pair of modalised multisets for context.  We create a new inductive rule set called \texttt{p-e}, for ``prime extend'', which takes a set of modal active parts and a pair of modal operators (say $!$ and $\bullet$), and returns the set of active parts extended with $!\cdot \Gamma \Rightarrow \bullet\cdot\Delta$:
›</span></span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">p_e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule set <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule set"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">M</span> <span class="entity">N</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span>"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">(*&lt;*)</span>I<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">;</span> <span class="free">R</span> <span class="main">⊆</span> modRules2 <span class="main">⟧</span> <span class="main">⟹</span> extendRule <span class="main">(</span><span class="free">M</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⇒*</span> <span class="free">N</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">p_e</span> <span class="free">R</span> <span class="free">M</span> <span class="free">N</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent We need a method for extending the conclusion of a rule without extending the premisses.  Again, this is simple:›</span></span>

<span class="keyword1"><span class="command">overloading</span></span> extendConc <span class="main">≡</span> <span class="quoted">extendConc</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extendConc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">extendConc</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> extend <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\noindent  The extension of a rule set is now more complicated; the inductive definition has four clauses, depending on the type of rule:
›</span></span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">ext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule set <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule set"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="entity">R'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">M</span> <span class="entity">N</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
   ax<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> Ax <span class="main">⟧</span> <span class="main">⟹</span> extendRule <span class="free"><span class="bound"><span class="entity">seq</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">ext</span> <span class="free">R</span> <span class="free">R'</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
<span class="main">|</span>  up<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> upRules<span class="main">⟧</span> <span class="main">⟹</span> extendRule <span class="free"><span class="bound"><span class="entity">seq</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">ext</span> <span class="free">R</span> <span class="free">R'</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
<span class="main">|</span> mod1<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> p_e <span class="free">R'</span> <span class="free">M</span> <span class="free">N</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> extendConc <span class="free"><span class="bound"><span class="entity">seq</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">ext</span> <span class="free">R</span> <span class="free">R'</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
<span class="main">|</span> mod2<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> modRules2 <span class="main">⟧</span> <span class="main">⟹</span> extendRule <span class="free"><span class="bound"><span class="entity">seq</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">ext</span> <span class="free">R</span> <span class="free">R'</span> <span class="free">M</span> <span class="free">N</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent Note the new rule set carries information about which set contains the modalised context rules and which modal operators which extend those prime parts.
›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="comment1">(* A formulation of what it means to be a principal formula for a rule.   *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">leftPrincipal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  up<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> ff <span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟧</span>  <span class="main">⟹</span> 
                   <span class="free">leftPrincipal</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>



<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">rightPrincipal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  up<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟧</span><span class="main">⟹</span> <span class="free">rightPrincipal</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>



<span class="comment1">(* What it means to be a derivable sequent.  Can have this as a predicate or as a set.
   The two formation rules say that the supplied premisses are derivable, and the second says
   that if all the premisses of some rule are derivable, then so is the conclusion. *)</span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">derivable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> deriv set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rule set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
   base<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable</span> <span class="free">R</span>"</span></span>
<span class="main">|</span>  step<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">;</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">≠</span><span class="main">[]</span> <span class="main">;</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable</span> <span class="free">R</span> <span class="main">⟧</span> 
                       <span class="main">⟹</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable</span> <span class="free">R</span>"</span></span>


<span class="comment1">(* Characterisation of a sequent *)</span>
<span class="keyword1"><span class="command">lemma</span></span> characteriseSeq<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> sequent<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">A</span> <span class="main">⇒*</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* Obvious connection *)</span>
<span class="keyword1"><span class="command">lemma</span></span> extend1_to_2<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extendRule2 <span class="free">S</span> <span class="free">S</span> <span class="free">r</span> <span class="main">=</span> extendRule <span class="free">S</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extendRule2_def<span class="main">)</span>

<span class="comment1">(* Helper function for later *)</span>
<span class="keyword1"><span class="command">lemma</span></span> nonEmptySet<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>neq_Nil_conv<span class="main">)</span>


<span class="comment1">(* Lemma which says that if we have extended an identity rule, then the propositional variable is
   contained in the extended multisets *)</span>
<span class="keyword1"><span class="command">lemma</span></span> extendID<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"At <span class="free">i</span> <span class="main">∈#</span> <span class="free">Γ</span> <span class="main">∧</span> At <span class="free">i</span> <span class="main">∈#</span> <span class="free">Δ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ'</span> <span class="bound">Δ'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">=</span> <span class="bound">Γ'</span> <span class="main">⊕</span> At <span class="free">i</span> <span class="main">∧</span> <span class="free">Δ</span> <span class="main">=</span> <span class="bound">Δ'</span> <span class="main">⊕</span> At <span class="free">i</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span>"</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extendFalsum<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">=</span> <span class="bound">Γ'</span> <span class="main">⊕</span> ff"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span>"</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(* Lemma that says if a propositional variable is in both the antecedent and succedent of a sequent,
   then it is derivable from idupRules *)</span>
<span class="keyword1"><span class="command">lemma</span></span> containID<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"At <span class="free">i</span> <span class="main">∈#</span> <span class="free">Γ</span> <span class="main">∧</span> At <span class="free">i</span> <span class="main">∈#</span> <span class="free">Δ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"Ax <span class="main">⊆</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R'</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⊕</span> At <span class="free">i</span> <span class="main">∧</span> <span class="free">Δ</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⊕</span> At <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="main">(</span><span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span><span class="main">)</span> <span class="main">⇒*</span> <span class="main">(</span><span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">ultimately</span></span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">∈</span> ext <span class="free">R</span> <span class="free">R'</span> <span class="free">M</span> <span class="free">N</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> ext.ax<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span>"</span></span><span class="main">]</span> 
       <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> derivable.base<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ext <span class="free">R</span> <span class="free">R'</span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> containFalsum<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="free">Γ</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span>  b<span class="main">:</span> <span class="quoted"><span class="quoted">"Ax <span class="main">⊆</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R'</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⊕</span> ff"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">moreover</span></span>
<span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">∈</span> ext <span class="free">R</span> <span class="free">R'</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> ext.ax<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span><span class="main">]</span> 
       <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> derivable.base<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ext <span class="free">R</span> <span class="free">R'</span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="comment1">(* Lemma which says that if r is an identity rule, then r is of the form
   ([], P ⇒* P) *)</span>
<span class="keyword1"><span class="command">lemma</span></span> characteriseAx<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax <span class="main">⟹</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="bound">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="bound">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* A lemma about the last rule used in a derivation, i.e. that one exists *)</span>
<span class="keyword1"><span class="command">lemma</span></span> characteriseLast<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="free">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
             <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> 
             <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="bound">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>


<span class="comment1">(* Lemma which says that if rule is an upRule, then the succedent is either empty, or a single formula *)</span>
<span class="keyword1"><span class="command">lemma</span></span> succ_upRule<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">Φ</span> <span class="main">⇒*</span> <span class="free">Ψ</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ψ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">Ψ</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">R</span> <span class="skolem">Rs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ψ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">Ψ</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset.simps <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ant<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Φ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> suc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ψ</span></span><span class="main">]</span> 
         <span class="keyword2"><span class="keyword">and</span></span> union_is_single<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Φ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ψ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Compound <span class="skolem">R</span> <span class="skolem">Rs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">elim</span> disjE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Equivalent, but the antecedent *)</span>
<span class="keyword1"><span class="command">lemma</span></span> antec_upRule<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">Φ</span> <span class="main">⇒*</span> <span class="free">Ψ</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">Φ</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">R</span> <span class="skolem">Rs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">Φ</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset.simps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ant<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Φ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> suc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ψ</span></span><span class="main">]</span> 
         <span class="keyword2"><span class="keyword">and</span></span> union_is_single<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Φ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ψ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Compound <span class="skolem">R</span> <span class="skolem">Rs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">elim</span> disjE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upRule_Size<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"seq_size <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">R</span> <span class="skolem">Rs</span><span class="main">)</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">+</span> <span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">R</span> <span class="skolem">Rs</span><span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset.simps <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹mset <span class="skolem">C</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">R</span> <span class="skolem">Rs</span><span class="main">\&lt;RM&gt;</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">G</span><span class="main">+</span><span class="skolem">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">G</span> <span class="main">+</span> size <span class="skolem">H</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"seq_size <span class="skolem">C</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq_size.simps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ant<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> suc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">H</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">r</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"seq_size <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upRuleCharacterise<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">F</span> <span class="bound">Fs</span><span class="main">.</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ</span></span> <span class="skolem"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> characteriseSeq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">F</span> <span class="bound">Fs</span><span class="main">.</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹mset <span class="free">C</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mset.simps <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ant<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> suc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> union_is_single<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Compound <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> modRule2Characterise<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> modRules2"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">F</span> <span class="bound">Fs</span><span class="main">.</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ</span></span> <span class="skolem"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> characteriseSeq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∈</span> modRules2"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">F</span> <span class="bound">Fs</span><span class="main">.</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹mset <span class="free">C</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mset.simps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ant<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> suc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> union_is_single<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> modRule1Characterise<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> p_e <span class="free">R</span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> modRules2"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">F</span> <span class="bound">Fs</span> <span class="bound">Γ</span> <span class="bound">Δ</span> <span class="bound">ps</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="main">(</span><span class="free">M</span><span class="main">⋅</span><span class="bound">Γ</span><span class="main">⇒*</span><span class="free">N</span><span class="main">⋅</span><span class="bound">Δ</span><span class="main">)</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> 
                    <span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> 
                     <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">ps</span> <span class="skolem">c</span> <span class="skolem">Γ</span> <span class="skolem">Δ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> modRules2"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> modRules2›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">Fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> modRule2Characterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> I <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Fs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extendEmpty<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mapExtendEmpty<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>extend <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span> <span class="main">=</span> <span class="free">ps</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> extendEmpty
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> extendRuleEmpty<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extendEmpty mapExtendEmpty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extendNonEmpty<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∧</span> <span class="free">Δ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="free">C</span> <span class="main">≠</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def nonEmpty_neq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extendRuleNonEmpty<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∧</span> <span class="free">Δ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="free">r</span> <span class="main">≠</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extendNonEmpty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extendRuleEmptyRev<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="free">S</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms extendRuleNonEmpty <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> modaliseEmpty<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> modaliseMultiset_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;Empt&gt;</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> modaliseNonEmpty<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">≠</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⋅</span> <span class="free">Γ</span> <span class="main">≠</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms nonEmpty_image<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ</span></span><span class="main">]</span> modaliseMultiset_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_extend<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>extend <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">S</span> <span class="main">+</span> mset <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> mset.simps extend_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac extend_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_extend_size<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∧</span> <span class="free">Δ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>mset <span class="main">(</span><span class="main">(</span>extend <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> size <span class="main">(</span>mset <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">≠</span> <span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>mset <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>extend <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span><span class="free">Γ</span><span class="main">⇒*</span><span class="free">Δ</span><span class="main">)</span> <span class="main">+</span> mset <span class="free">c</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> mset_extend<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>mset <span class="main">(</span>extend <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span>mset <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> size <span class="main">(</span>mset <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">lemma</span></span> extendContain<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="free">S</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="free">p</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> set <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="free">p</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="free">S</span> <span class="free">r</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span> <span class="main">=</span> <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span> 
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">lemma</span></span> extendCommute<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="main">(</span>extend <span class="free">R</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>extend <span class="free">R</span><span class="main">)</span> <span class="main">(</span>extend <span class="free">S</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mapCommute<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>extend <span class="free">R</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">R</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendCommute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extendAssoc<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="main">(</span>extend <span class="free">R</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span>extend <span class="free">S</span> <span class="free">R</span><span class="main">)</span> <span class="free">c</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mapAssoc<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>extend <span class="free">R</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="main">(</span>extend <span class="free">S</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendAssoc<span class="main">)</span>


<span class="comment1">(* Disjointness of the various rule sets *)</span>
<span class="keyword1"><span class="command">lemma</span></span> disjoint_Aux<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">c</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> mset <span class="main">(</span>extend <span class="free">S</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mset.simps union_is_single<span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def mset.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> disjoint_Aux2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">c</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>extend <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="free">B</span><span class="main">\&lt;RM&gt;</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> <span class="main">\&lt;LM&gt;</span><span class="free">B</span><span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> disjoint_Aux<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">≠</span> <span class="free">B</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> disjoint_Ax_up<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ax <span class="main">∩</span> upRules <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 1<span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span> upRules.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> disjoint_Ax_mod2<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ax <span class="main">∩</span> modRules2 <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 1<span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span> modRules2.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> disjoint_Ax_mod1<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ax <span class="main">∩</span> p_e modRules2 <span class="free">M</span> <span class="free">N</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> p_e.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> modRules2.cases<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> p_e.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> modRules2.cases<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> disjoint_up_mod2<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"upRules <span class="main">∩</span> modRules2 <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> upRules.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 1<span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span> modRules2.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> disjoint_up_mod1<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"upRules <span class="main">∩</span> p_e modRules2 <span class="free">M</span> <span class="free">N</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> disjoint_Aux2
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> upRules.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> p_e.cases<span class="main">)</span>  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> modRules2.cases<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def union_ac<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">cb</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="improper">Ma</span> <span class="improper">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Compound <span class="improper">R</span> <span class="improper">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">⋅</span><span class="improper">Γ</span> <span class="main">⇒*</span> <span class="free">N</span><span class="main">⋅</span><span class="improper">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> disjoint <span class="main">=</span> disjoint_Ax_up disjoint_Ax_mod1 disjoint_Ax_mod2 
                  disjoint_up_mod2 disjoint_up_mod1


<span class="keyword1"><span class="command">lemma</span></span> Ax_subset_false_aux<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">with</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∩</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Ax_subset_false<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Ax <span class="main">⊆</span> modRules2"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> Ax"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Ax <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">with</span></span> disjoint_Ax_mod2 <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Ax_subset_false_aux<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted">Ax</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"modRules2"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">lemma</span></span> modal_not_contain<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="free">N</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">A</span> <span class="main">∈#</span> <span class="free">N</span><span class="main">⋅</span><span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>modaliseMultiset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nonPrincipalID<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="free">A</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="free">A</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> r1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="free">r</span> <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> r2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free">A</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> r1 <span class="keyword2"><span class="keyword">and</span></span> disjoint <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> Ax›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span>
<span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="free">r</span> <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps'</span></span> 
          <span class="keyword2"><span class="keyword">where</span></span> r3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">≠</span> ff"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> r1 <span class="keyword2"><span class="keyword">and</span></span> disjoint <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> Ax›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compound_not_in_modal_multi<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>Compound <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="free">N</span><span class="main">⋅</span><span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>modaliseMultiset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_principal_aux<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">c</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="free">T</span> <span class="free">Ts</span><span class="main">\&lt;RM&gt;</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">⋅</span><span class="free">Γ</span> <span class="main">+</span> succ <span class="free">c</span> <span class="main">=</span> <span class="free">N</span><span class="main">⋅</span><span class="free">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> single_is_union <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="free">T</span> <span class="free">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="free">T</span> <span class="free">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> multiset1 multiset2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Modal <span class="free"><span class="free"><span class="free"><span class="free">T</span></span></span></span> <span class="free"><span class="free"><span class="free"><span class="free">Ts</span></span></span></span>"</span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper"><span class="improper"><span class="improper">multiset1</span></span></span></span>"</span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper"><span class="improper"><span class="improper">multiset2</span></span></span></span>"</span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">moreover</span></span>
   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="free">T</span> <span class="free">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">⋅</span><span class="free">Γ</span> <span class="main">⊕</span> Modal <span class="free">T</span> <span class="free">Ts</span> <span class="main">=</span> <span class="free">N</span><span class="main">⋅</span><span class="free">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">⋅</span><span class="free">Γ</span> <span class="main">⊕</span> Modal <span class="free">T</span> <span class="free">Ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">⋅</span><span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> compound_not_in_modal_multi<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Fs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">moreover</span></span>
   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="free">T</span> <span class="free">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">⋅</span><span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> compound_not_in_modal_multi<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Fs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_principal_aux2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">c</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="free">T</span> <span class="free">Ts</span><span class="main">\&lt;RM&gt;</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">⋅</span><span class="free">Γ</span> <span class="main">+</span> antec <span class="free">c</span> <span class="main">=</span> <span class="free">N</span><span class="main">⋅</span><span class="free">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> single_is_union <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="free">T</span> <span class="free">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="free">T</span> <span class="free">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> multiset1 multiset2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mset.simps<span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Modal <span class="free"><span class="free"><span class="free"><span class="free">T</span></span></span></span> <span class="free"><span class="free"><span class="free"><span class="free">Ts</span></span></span></span>"</span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper"><span class="improper"><span class="improper">multiset1</span></span></span></span>"</span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper"><span class="improper"><span class="improper">multiset2</span></span></span></span>"</span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">moreover</span></span>
   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="free">T</span> <span class="free">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">⋅</span><span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> compound_not_in_modal_multi<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Fs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">moreover</span></span>
   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="free">T</span> <span class="free">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">⋅</span><span class="free">Γ</span> <span class="main">⊕</span> Modal <span class="free">T</span> <span class="free">Ts</span> <span class="main">=</span> <span class="free">N</span><span class="main">⋅</span><span class="free">Δ</span> <span class="main">⊕</span> Compound <span class="free">F</span> <span class="free">Fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">⋅</span><span class="free">Γ</span> <span class="main">⊕</span> Modal <span class="free">T</span> <span class="free">Ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Compound <span class="free">F</span> <span class="free">Fs</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">⋅</span><span class="free">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> compound_not_in_modal_multi<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Fs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> modRules_not_right_principal_for_compound<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> p_e modRules2 <span class="free">S</span> <span class="free">T</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="main">(</span>Compound <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> p_e.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> modRule2Characterise<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
<span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="free">r</span> <span class="main">(</span>Compound <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span>
 <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_principal_aux
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span> <span class="operator">auto</span> 
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fst <span class="free">r</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> disjoint_up_mod1<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">T</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> modRules_not_left_principal_for_compound<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> p_e modRules2 <span class="free">T</span> <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="main">(</span>Compound <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> p_e.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> modRule2Characterise<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
<span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="free">r</span> <span class="main">(</span>Compound <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span>
 <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_principal_aux2
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> leftPrincipal.cases<span class="main">)</span> <span class="operator">auto</span> 
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fst <span class="free">r</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> disjoint_up_mod1<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> modRules2_not_left_principal_for_compound<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> modRules2"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="main">(</span>Compound <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> modRule2Characterise <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span>
   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="main">(</span>Compound <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> leftPrincipal.cases<span class="main">)</span> 
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
   <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="main">(</span>Compound <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> leftPrincipal.cases<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="main">(</span>Compound <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> modRules2_not_right_principal_for_compound<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> modRules2"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="main">(</span>Compound <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> modRule2Characterise <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span>
   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="main">(</span>Compound <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span> 
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>  
   <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="main">(</span>Compound <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>        
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="main">(</span>Compound <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upRules_not_right_principal_for_modal<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> upRules"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> upRuleCharacterise <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span>
   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span> 
   <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">moreover</span></span>
   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
   <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upRules_not_left_principal_for_modal<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> upRuleCharacterise <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span>
   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> leftPrincipal.cases<span class="main">)</span> 
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
   <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> leftPrincipal.cases<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> nonPrincipalRight <span class="main">=</span> upRules_not_right_principal_for_modal
                           modRules_not_right_principal_for_compound
                           modRules2_not_right_principal_for_compound

<span class="keyword1"><span class="command">lemmas</span></span> nonPrincipalLeft <span class="main">=</span> upRules_not_left_principal_for_modal
                          modRules_not_left_principal_for_compound
                          modRules2_not_left_principal_for_compound




<span class="comment1">(* Bunch of results about modalising multisets *)</span>
<span class="keyword1"><span class="command">lemma</span></span> modalise_characterise<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>   <span class="free">M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>  <span class="free">Δ</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form multiset"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">⋅</span><span class="free">Δ</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">B</span><span class="main">.</span> <span class="free">A</span> <span class="main">=</span> Modal <span class="free">M</span> <span class="main">[</span><span class="bound">B</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">≠</span> <span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>modaliseEmpty<span class="main">)</span>
 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">⋅</span><span class="free">Δ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">B</span><span class="main">.</span> <span class="free">A</span> <span class="main">=</span> Modal <span class="free">M</span> <span class="main">[</span><span class="bound">B</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> empty
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">x</span> <span class="skolem">Δ'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">;</span> <span class="skolem">Δ'</span> <span class="main">≠</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">B</span><span class="main">.</span> <span class="free">A</span> <span class="main">=</span> Modal <span class="free">M</span> <span class="main">[</span><span class="bound">B</span><span class="main">]</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">Δ'</span> <span class="main">⊕</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">∨</span> <span class="free">A</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">⋅</span><span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="skolem">x</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>modaliseMultiset_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
         <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">⋅</span><span class="skolem">Δ'</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ'</span> <span class="main">≠</span> <span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>modaliseEmpty<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">⋅</span><span class="skolem">Δ'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">B</span><span class="main">.</span> <span class="free">A</span> <span class="main">=</span> Modal <span class="free">M</span> <span class="main">[</span><span class="bound">B</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
         <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">⋅</span><span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="skolem">x</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> <span class="main">\&lt;LM&gt;</span> Modal <span class="free">M</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>modaliseMultiset_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set_mset <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>set_mset_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="main">{</span>Modal <span class="free">M</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> Modal <span class="free">M</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">B</span><span class="main">.</span> <span class="free">A</span> <span class="main">=</span> Modal <span class="free">M</span> <span class="main">[</span><span class="bound">B</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
         <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> non_contain<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Δ</span> <span class="free">Δ'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form multiset"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">≠</span> <span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ'</span> <span class="main">≠</span> <span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="free">N</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">M</span><span class="main">⋅</span><span class="free">Δ</span><span class="main">)</span> <span class="main">∩</span> set_mset <span class="main">(</span><span class="free">N</span><span class="main">⋅</span><span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
<span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">M</span><span class="main">⋅</span><span class="free">Δ</span><span class="main">)</span> <span class="main">∩</span> set_mset <span class="main">(</span><span class="free">N</span><span class="main">⋅</span><span class="free">Δ'</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set_mset <span class="main">(</span><span class="free">M</span><span class="main">⋅</span><span class="free">Δ</span><span class="main">)</span> <span class="main">∩</span> set_mset <span class="main">(</span><span class="free">N</span><span class="main">⋅</span><span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> set_mset <span class="main">(</span><span class="free">M</span><span class="main">⋅</span><span class="free">Δ</span><span class="main">)</span> <span class="main">∩</span> set_mset <span class="main">(</span><span class="free">N</span><span class="main">⋅</span><span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
 <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span> 
   <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> box<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> set_mset <span class="main">(</span><span class="free">M</span><span class="main">⋅</span><span class="free">Δ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> set_mset <span class="main">(</span><span class="free">N</span><span class="main">⋅</span><span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">from</span></span> box <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">⋅</span><span class="free">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Δ</span> <span class="main">≠</span> <span class="main">\&lt;Empt&gt;</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">B</span><span class="main">.</span> <span class="skolem">A</span> <span class="main">=</span> Modal <span class="free">M</span> <span class="main">[</span><span class="bound">B</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> modalise_characterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> Modal <span class="free">M</span> <span class="main">[</span><span class="skolem">B</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">moreover</span></span> 
   <span class="keyword1"><span class="command">from</span></span> dia <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈#</span> <span class="free">N</span><span class="main">⋅</span><span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Δ'</span> <span class="main">≠</span> <span class="main">\&lt;Empt&gt;</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> <span class="skolem">A</span> <span class="main">=</span> Modal <span class="free">N</span> <span class="main">[</span><span class="bound">C</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> modalise_characterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">N</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> Modal <span class="free">N</span> <span class="main">[</span><span class="skolem">C</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">≠</span><span class="free">N</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> modal_neq<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form list"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> Modal <span class="free">M</span> <span class="main">[</span><span class="free">A</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">≠</span> <span class="main">[</span>Modal <span class="free">M</span> <span class="free">ps</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> compat_form.induct compat_form_list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> p_e_non_empty<span class="main">:</span> 
 <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> p_e <span class="free">R</span> <span class="free">M</span> <span class="free">N</span> <span class="main">⟹</span> fst <span class="free">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> p_e.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">Ps</span><span class="main">,</span> <span class="improper">c</span><span class="main">)</span> <span class="main">∈</span> modRules2"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> modRules2.cases<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>


<span class="comment1">(* -------------------------------
   -------------------------------
        ModalWeakening2.thy
   -------------------------------
   ------------------------------- *)</span>


<span class="keyword1"><span class="command">lemma</span></span> dpWeak<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span>  b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> upRules"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span>  c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R2</span> <span class="main">⊆</span> modRules2"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span>  d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R3</span> <span class="main">⊆</span> modRules2"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span>  e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="main">(</span>p_e <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="main">∪</span> <span class="free">R3</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> a
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_less_induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">Γ</span> <span class="skolem">Δ</span><span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">Γ</span> <span class="bound">Δ</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">⇒*</span> <span class="bound">Δ</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> 0
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>      
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span>  <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> split<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∨</span> extendConc <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext.cases<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def extendConc_def<span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extendConc_def<span class="main">)</span>
 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">∈</span> upRules <span class="main">∪</span> <span class="main">(</span>p_e <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="main">∪</span> modRules2<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b c d e <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> upRules.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
                                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
                                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> modRules2.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
                                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> p_e.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
                                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">hypsubst_thin</span>
                                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> p_e_non_empty<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">R2</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> N<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">N</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> extend <span class="main">(</span> <span class="free">M</span> <span class="main">⋅</span> <span class="improper">Γ</span> <span class="main">⇒*</span> <span class="free">N</span> <span class="main">⋅</span> <span class="improper">Δ</span><span class="main">)</span> <span class="improper">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extendConc_def<span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">∧</span> At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extendID <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">∧</span> At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> e <span class="keyword2"><span class="keyword">and</span></span> containID<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">+</span><span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span><span class="main">+</span><span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
 <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span><span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extendConc_def<span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extendFalsum <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> e <span class="keyword2"><span class="keyword">and</span></span> containFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">+</span><span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span><span class="main">+</span><span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> 
                  <span class="keyword2"><span class="keyword">and</span></span> h<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> characteriseLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> g c <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> modRules2<span class="main">)</span> <span class="main">∧</span> extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
                                  <span class="main">(</span><span class="skolem">r</span> <span class="main">∈</span> p_e <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span> <span class="main">∧</span> extendConc <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> modRules2<span class="main">)</span> <span class="main">∧</span> extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span><span class="quoted"><span class="quoted">"map <span class="main">(</span>extend <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ps</span> <span class="main">=</span> fst <span class="main">(</span>extendRule <span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> mapCommute<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ'</span><span class="main">⇒*</span><span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="skolem">r</span>"</span></span><span class="main">]</span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def mapAssoc <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_map<span class="main">)</span>
     <span class="keyword1"><span class="command">from</span></span> as <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>extendRule <span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def union_ac<span class="main">)</span>
     <span class="keyword1"><span class="command">from</span></span> as f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def map_is_Nil_conv<span class="main">)</span>
     <span class="keyword1"><span class="command">with</span></span> as <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> modRules2"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>extend <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ps</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
           <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>extend <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ps</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> set <span class="skolem">Ps</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">=</span> extend <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">with</span></span> h <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p'</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="skolem"><span class="skolem">Ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p'</span></span><span class="main">)</span> <span class="operator">auto</span> 
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
           <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="operator">-</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">}</span></span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">qed</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
                <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> modRules2›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extendRule <span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">n'</span>"</span></span><span class="main">]</span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>map_is_Nil_conv extendRule_def<span class="main">)</span>
     <span class="keyword1"><span class="command">}</span></span>
 <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> p_e <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span> <span class="main">∧</span> extendConc <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>extendConc <span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendConc_def extend_def union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> as <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">=</span> fst <span class="main">(</span>extendConc <span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendConc_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendConc <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">∈</span> ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> as <span class="keyword2"><span class="keyword">and</span></span> g <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendConc <span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∈</span> ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> as <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> c
            <span class="keyword2"><span class="keyword">and</span></span> ext.mod1<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">N</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> h f <span class="keyword2"><span class="keyword">and</span></span> 
           derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extendConc <span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">n'</span>"</span></span><span class="main">]</span>
           <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">}</span></span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="comment1">(* -------------------------------
   -------------------------------
        ModalInvertibility.thy
   -------------------------------
   ------------------------------- *)</span>

<span class="keyword1"><span class="command">lemma</span></span> nonPrincipalInvertRight<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> upRules"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R2</span> <span class="main">⊆</span> modRules2"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R3</span> <span class="main">⊆</span> modRules2"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span> <span class="main">∪</span> <span class="free">R3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Γ</span> <span class="bound">Δ</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">.</span> rightPrincipal <span class="bound">r'</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span> <span class="main">⟶</span> <span class="main">(</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>              
              <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">.</span> rightPrincipal <span class="bound">r'</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> np<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> modRules2<span class="main">)</span> <span class="main">∧</span> extendRule <span class="free">S</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> num<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">n'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>  
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> ext nonempty <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> modRules2"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> 
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="skolem"><span class="skolem">Ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
 <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> upRules"</span></span>
       <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">using</span></span> upRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">moreover</span></span>
         <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">moreover</span></span>
         <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> modRules2"</span></span> 
       <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">using</span></span> modRule2Characterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">moreover</span></span>
         <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="free">r</span> <span class="main">(</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span>
               <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
               <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> modRules2›</span></span>
                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
               <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span> <span class="main">∪</span> <span class="free">R3</span>›</span></span>
                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span>  <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span> <span class="main">∨</span>
                          <span class="main">(</span><span class="free">ps</span><span class="main">,</span>  <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹<span class="free">R1</span> <span class="main">⊆</span> upRules›</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> upRules.cases<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
               <span class="keyword1"><span class="command">moreover</span></span>
                  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span>
                   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R'</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">}</span></span>
               <span class="keyword1"><span class="command">moreover</span></span>
                  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span>"</span></span>
                   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ'</span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span> <span class="skolem">r'</span> <span class="main">∧</span> <span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> p_e.cases<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> modRules2"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R2</span> <span class="main">⊆</span> modRules2›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">Fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
                        <span class="quoted"><span class="quoted">"snd <span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> snd <span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
                        <span class="keyword1"><span class="command">using</span></span> modRule2Characterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="skolem">r'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">r'</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                   <span class="keyword1"><span class="command">with</span></span> aa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span> <span class="main">∨</span>
                                 <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span>"</span></span>
                        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
                   <span class="keyword1"><span class="command">moreover</span></span>
                      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>"</span></span>
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">=</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">=</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
                            <span class="keyword1"><span class="command">using</span></span> 
                            singleton_add_means_equal<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span><span class="main">]</span>
                            <span class="keyword2"><span class="keyword">and</span></span> singleton_add_means_empty<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span><span class="main">]</span> 
                            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>modaliseMultiset_def<span class="main">)</span>
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span> <span class="skolem">r'</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extendRuleEmpty<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span> <span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> aa <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> aa <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R'</span> <span class="main">=</span> Ax<span class="main">∪</span><span class="free">R1</span> <span class="main">∪</span><span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span> ›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command">}</span></span>
                   <span class="keyword1"><span class="command">moreover</span></span>
                      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span>"</span></span>
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;Empt&gt;</span> <span class="main">=</span> <span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">}</span></span>
                   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">≠</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">moreover</span></span>
         <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> modRules2›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"succ <span class="free">S</span> <span class="main">+</span> succ <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span><span class="main">]</span>
                    <span class="keyword2"><span class="keyword">and</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="free">r</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">H</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> modRules2›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∈</span> modRules2"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> upRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">and</span></span> modRule2Characterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="skolem">Ψ</span>"</span></span>
     <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
     <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">H</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="skolem">Ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">T</span><span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ</span> <span class="main">⊕</span> <span class="skolem">T</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">H</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="skolem">Ψ</span> <span class="main">⊕</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="free">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">Ψ</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">T</span><span class="main">}</span> <span class="main">=</span> set_mset <span class="free">Δ</span> <span class="main">∪</span> <span class="main">{</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">T</span><span class="main">\&lt;RM&gt;</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">≠</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="skolem">Ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="skolem">Ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="skolem">Ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ψ1</span><span class="main">.</span> <span class="skolem">Ψ</span> <span class="main">=</span> <span class="bound">Ψ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Ψ</span> <span class="main">⊖</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ψ1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="free">S</span> <span class="bound">p'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ex_map_conv<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ys<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extend <span class="free">S</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> succ <span class="bound">p</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="skolem">Ψ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> characteriseSeq
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="improper">x</span> <span class="main">⊖</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="main">)</span>
 <span class="keyword1"><span class="command">with</span></span> all <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">≤</span><span class="free">n'</span> <span class="main">∧</span> 
                             <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span> <span class="main">∧</span> 
                              <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">≤</span><span class="free">n'</span> <span class="main">∧</span> 
                              <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span> <span class="main">∧</span> 
                              <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> num <span class="keyword2"><span class="keyword">and</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> IH
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">hypsubst_thin</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Φ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ψ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">arith</span>
 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps'</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Ps</span> <span class="main">=</span> length <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps'</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span>›</span></span>
                               <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> modRules2›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="free">r</span> <span class="main">∈</span> <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> extend <span class="free">S</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>           
 <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_def<span class="main">)</span> 
 <span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="free">S</span> <span class="bound">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq
             <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span>
                <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Φ'</span> <span class="skolem">Ψ'</span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span>  
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span>
                       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> a1 <span class="keyword2"><span class="keyword">and</span></span> d1
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">" <span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> 
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
                       <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">=</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> 
                       <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">from</span></span> ant <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                  <span class="keyword1"><span class="command">moreover</span></span>
                  <span class="keyword1"><span class="command">from</span></span> suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">=</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> 
                       <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ</span><span class="main">+</span><span class="free">Γ'</span><span class="main">⇒*</span><span class="skolem">Ψ1</span><span class="main">+</span><span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">⇒*</span><span class="skolem">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> t <span class="keyword2"><span class="keyword">and</span></span> c2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">}</span></span>
                  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">qed</span></span>
             <span class="keyword1"><span class="command">moreover</span></span>
             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span>
                <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Φ'</span> <span class="skolem">Ψ'</span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span>  
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span>
                       <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> d2
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> 
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
                       <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> 
                       <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ</span><span class="main">+</span><span class="free">Γ'</span><span class="main">⇒*</span><span class="skolem">Ψ1</span><span class="main">+</span><span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">⇒*</span><span class="skolem">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">from</span></span> ant <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">moreover</span></span>
                  <span class="keyword1"><span class="command">from</span></span> suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ψ1</span> <span class="main">+</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">=</span> <span class="skolem">Ψ1</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ψ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> 
                       <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ</span><span class="main">⇒*</span><span class="skolem">Ψ1</span><span class="main">⊕</span>Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">⇒*</span><span class="skolem">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Φ</span>  <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> t <span class="keyword2"><span class="keyword">and</span></span> c1
                       <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">}</span></span>
                  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">ultimately</span></span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">Φ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">≤</span><span class="free">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>
                 <span class="main">∧</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> a2
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Φ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ψ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>  
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Φ'</span> <span class="main">⇒*</span> <span class="improper">Ψ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> all<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> num
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps'</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="comment1">(* Check this later. *)</span>

<span class="keyword1"><span class="command">lemma</span></span> nonPrincipalInvertLeft<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> upRules"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R2</span> <span class="main">⊆</span> modRules2"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R3</span> <span class="main">⊆</span> modRules2"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span> <span class="main">∪</span> <span class="free">R3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Γ</span> <span class="bound">Δ</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="bound">Δ</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">.</span> leftPrincipal <span class="bound">r'</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span> <span class="main">⟶</span> <span class="main">(</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span> <span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">.</span> leftPrincipal <span class="bound">r'</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> np<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> modRules2<span class="main">)</span> <span class="main">∧</span> extendRule <span class="free">S</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> num<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">n'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>  
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> ext nonempty <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> modRules2"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> 
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="skolem"><span class="skolem">Ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
 <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">⇒*</span> <span class="skolem">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> upRules"</span></span>
       <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">using</span></span> upRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">moreover</span></span>
         <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">⇒*</span> <span class="skolem">G</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">moreover</span></span>
         <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">⇒*</span> <span class="skolem">G</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> modRules2"</span></span> 
       <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">using</span></span> modRule2Characterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">moreover</span></span>
         <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">⇒*</span> <span class="skolem">G</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>          
         <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">moreover</span></span>
         <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="free">r</span> <span class="main">(</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span>
               <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
               <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> modRules2›</span></span>
                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
               <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span> <span class="main">∪</span> <span class="free">R3</span>›</span></span>
                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span> <span class="main">∨</span>
                          <span class="main">(</span><span class="free">ps</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹<span class="free">R1</span> <span class="main">⊆</span> upRules›</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> upRules.cases<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
               <span class="keyword1"><span class="command">moreover</span></span>
                  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span>
                   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R'</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">}</span></span>
               <span class="keyword1"><span class="command">moreover</span></span>
                  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span>"</span></span>
                   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ'</span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span> <span class="skolem">r'</span> <span class="main">∧</span> <span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> p_e.cases<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> modRules2"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R2</span> <span class="main">⊆</span> modRules2›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">Fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
                        <span class="quoted"><span class="quoted">"snd <span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> snd <span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
                        <span class="keyword1"><span class="command">using</span></span> modRule2Characterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="skolem">r'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">r'</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                   <span class="keyword1"><span class="command">with</span></span> aa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span> <span class="main">∨</span>
                                 <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span>"</span></span>
                        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
                   <span class="keyword1"><span class="command">moreover</span></span>
                      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>"</span></span>
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;Empt&gt;</span> <span class="main">=</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
                      <span class="keyword1"><span class="command">}</span></span>
                   <span class="keyword1"><span class="command">moreover</span></span>
                      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span>"</span></span>
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;Empt&gt;</span> <span class="main">=</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">=</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
                            <span class="keyword1"><span class="command">using</span></span> 
                            singleton_add_means_equal<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span><span class="main">]</span>
                            <span class="keyword2"><span class="keyword">and</span></span> singleton_add_means_empty<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span><span class="main">]</span> 
                            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>modaliseMultiset_def<span class="main">)</span>
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span> <span class="skolem">r'</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extendRuleEmpty<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span> <span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> aa <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> aa <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R'</span> <span class="main">=</span> Ax<span class="main">∪</span><span class="free">R1</span> <span class="main">∪</span><span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span> ›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command">}</span></span>
                   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="free">r</span> <span class="main">(</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">≠</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">⇒*</span> <span class="skolem">G</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> modRules2›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"antec <span class="free">S</span> <span class="main">+</span> antec <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span><span class="main">]</span>
                    <span class="keyword2"><span class="keyword">and</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="free">r</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">H</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">⇒*</span> <span class="skolem">G</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> modRules2›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∈</span> modRules2"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> upRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">and</span></span> modRule2Characterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">⇒*</span> <span class="skolem">G</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="skolem">Φ</span>"</span></span>
     <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
     <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">H</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="skolem">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">T</span><span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">⊕</span> <span class="skolem">T</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Φ</span> <span class="main">+</span> <span class="skolem">H</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⊕</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="free">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">Φ</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">T</span><span class="main">}</span> <span class="main">=</span> set_mset <span class="free">Γ</span> <span class="main">∪</span> <span class="main">{</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">T</span><span class="main">\&lt;RM&gt;</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span> <span class="main">≠</span> <span class="skolem">H</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">≠</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="skolem">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="skolem">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="skolem">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Φ1</span><span class="main">.</span> <span class="skolem">Φ</span> <span class="main">=</span> <span class="bound">Φ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">⊖</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Φ1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="free">S</span> <span class="bound">p'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ex_map_conv<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ys<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extend <span class="free">S</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> antec <span class="bound">p</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="skolem">Φ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> characteriseSeq
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="improper">x</span> <span class="main">⊖</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="main">)</span>
 <span class="keyword1"><span class="command">with</span></span> all <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">≤</span><span class="free">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Φ'</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span> <span class="main">∧</span> 
                              <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span><span class="main">⊕</span>Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">≤</span><span class="free">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span> <span class="main">∧</span> 
                  <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span><span class="main">⊕</span>Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> num <span class="keyword2"><span class="keyword">and</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> IH 
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">hypsubst_thin</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Φ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ψ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">arith</span><span class="main">)</span>
 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps'</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Ps</span> <span class="main">=</span> length <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps'</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span>›</span></span>
                               <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="free">r</span> <span class="main">∈</span> modRules2›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="free">r</span> <span class="main">∈</span> <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> extend <span class="free">S</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>           
 <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_def<span class="main">)</span> 
 <span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="free">S</span> <span class="bound">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq
             <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">Φ'</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span>
                <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Φ'</span> <span class="skolem">Ψ'</span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">⇒*</span> <span class="skolem">Ψ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span>  
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ1</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ'</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span><span class="main">)</span>"</span></span>
                       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> a1 <span class="keyword2"><span class="keyword">and</span></span> d1
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">" <span class="skolem">Φ'</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> 
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
                       <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">=</span> <span class="skolem">Φ1</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">=</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> 
                       <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ1</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">from</span></span> suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                  <span class="keyword1"><span class="command">moreover</span></span>
                  <span class="keyword1"><span class="command">from</span></span> ant <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">=</span> <span class="skolem">Φ1</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> 
                       <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ1</span><span class="main">+</span><span class="free">Γ'</span><span class="main">⇒*</span><span class="skolem">Ψ</span><span class="main">+</span><span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">⇒*</span><span class="skolem">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> t <span class="keyword2"><span class="keyword">and</span></span> c2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">}</span></span>
                  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">qed</span></span>
             <span class="keyword1"><span class="command">moreover</span></span>
             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span>
                <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Φ'</span> <span class="skolem">Ψ'</span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span>"</span></span>  
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span>
                       <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> d2
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> 
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
                       <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="skolem">Φ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> 
                       <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ1</span><span class="main">+</span><span class="free">Γ'</span><span class="main">⇒*</span><span class="skolem">Ψ</span><span class="main">+</span><span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">⇒*</span><span class="skolem">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">from</span></span> suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ψ'</span> <span class="main">=</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">moreover</span></span>
                  <span class="keyword1"><span class="command">from</span></span> ant <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">+</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">=</span> <span class="skolem">Φ1</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span><span class="skolem">Φ1</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> 
                       <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Φ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">⇒*</span><span class="skolem">Ψ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">⇒*</span><span class="skolem">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="skolem">Φ1</span><span class="main">⊕</span>Modal <span class="free">M</span> <span class="free">Ms</span>  <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">⇒*</span> <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> t <span class="keyword2"><span class="keyword">and</span></span> c1
                       <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ1</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Φ'</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Ψ'</span> <span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">}</span></span>
                  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">ultimately</span></span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">Φ'</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">)</span> <span class="main">∈</span> set <span class="free">Ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">Φ'</span> <span class="bound">Ψ'</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">≤</span><span class="free">n'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>
                 <span class="main">∧</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Φ'</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Ψ'</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> a2
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Φ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ψ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>  
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Φ'</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="improper">Ψ'</span> "</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> all<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> num
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps'</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def Bex_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
We have two different inversion lemmata, depending on whether the rule was a modalised context rule, or some other kind of rule.  We only show the former, since the latter is much the same as earlier proofs.  The interesting cases are picked out:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> rightInvert<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Γ</span> <span class="free">Δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form multiset"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> rules<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R2</span> <span class="main">⊆</span> modRules2 <span class="main">∧</span> <span class="free">R3</span> <span class="main">⊆</span> modRules2 <span class="main">∧</span> 
                <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="main">(</span>p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span> <span class="main">∪</span> <span class="free">R3</span> <span class="main">∧</span>
                <span class="free">R'</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">.</span> rightPrincipal <span class="bound">r'</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span> <span class="main">⟶</span> 
                         <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>  neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M2</span> <span class="main">≠</span> <span class="free">M</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">+</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_less_induct<span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">Γ</span> <span class="skolem">Δ</span><span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Γ</span> <span class="bound">Δ</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">.</span> rightPrincipal <span class="bound">r'</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span> <span class="main">⟶</span> <span class="main">(</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">.</span> rightPrincipal <span class="bound">r'</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> 0
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="main">∈</span> ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">S</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> Ax<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="operator">-</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext.cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="tfree">'b</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">seq</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> upRules.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> upRules.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> upRules.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> p_e_non_empty<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">R2</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">M1</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> N<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">M2</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>At <span class="improper">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="improper">i</span><span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendConc_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="improper">b</span><span class="main">)</span> <span class="main">∈</span> modRules2"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> modRules2.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span> 
         <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>›</span></span>
               <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">∧</span> At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Δ</span>"</span></span> 
               <span class="keyword1"><span class="command">using</span></span> extendID<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">∧</span> At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules
               <span class="keyword2"><span class="keyword">and</span></span> containID<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span>
         <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>›</span></span>
             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span>"</span></span> 
               <span class="keyword1"><span class="command">using</span></span> extendFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules
               <span class="keyword2"><span class="keyword">and</span></span> containFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                          <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                       d'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> characteriseLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> modRules2<span class="main">)</span> <span class="main">∧</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
                       <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span> <span class="main">∧</span> extendConc <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> modRules2<span class="main">)</span> <span class="main">∧</span> extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span><span class="main">)</span>
                                <span class="main">∨</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">∈</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span> <span class="main">∧</span> extendConc <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> ext1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> modRules2<span class="main">)</span> <span class="main">∧</span> extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> modRules2"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span> 
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> 
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span>
             <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="main">[</span><span class="main">[</span><span class="operator">hypsubst_thin</span><span class="main"><span class="main">=</span></span><span class="quasi_keyword">true</span><span class="main">]</span><span class="main">]</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> disjoint<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> upRuleCharacterise<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 10<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 10<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span> 
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> modRule1Characterise<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="skolem"><span class="skolem">r</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="skolem"><span class="skolem">r</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">R2</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">M1</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> N<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">M2</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
             <span class="keyword1"><span class="command">with</span></span> rules <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> upRules›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> sw<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> 
                                                   <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> upRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span>rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
             <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>"</span></span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">with</span></span> sw <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">}</span></span>
             <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>"</span></span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> a' b' d' <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
                      <span class="keyword2"><span class="keyword">and</span></span> nonPrincipalInvertRight<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span>
                                                  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ms</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span>
                                                  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Δ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> 
                                                  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?M1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?M2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M2</span></span><span class="main">]</span>
                      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ext1 <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">}</span></span>
             <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">moreover</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹\noindent This is the case where the last inference was a normal modal inference:›</span></span>

  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> modRules2"</span></span>
   <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> modRules2›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> 
            <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> modRule2Characterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bb<span class="main">:</span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>  
<span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹\noindent We need to know $r \in R$ so that we can extend the active part›</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
           <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
           <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
           <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> modRules2›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> rules <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span>  <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span> <span class="main">∨</span>
         <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span>  <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span> <span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span><span class="main">)</span>
                                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> upRules.cases<span class="main">)</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">}</span></span>
   <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span>"</span></span>

<span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹\noindent In this case, we show that $\Delta'$ and $\Gamma'$ must be empty.  The details are generally suppressed:›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ'</span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="skolem"><span class="skolem">r'</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span> <span class="skolem">r'</span> 
            <span class="main">∧</span> <span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span><span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> p_e.cases<span class="main">)</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">(*&lt;*)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> modRules2"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">Fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
                                   <span class="quoted"><span class="quoted">"snd <span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> snd <span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
                                   <span class="keyword1"><span class="command">using</span></span> modRule2Characterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="skolem">r'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">r'</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                              <span class="keyword1"><span class="command">with</span></span> aa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span> <span class="main">∨</span>
                                            <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span>"</span></span>
                                   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
                              <span class="keyword1"><span class="command">moreover</span></span>
                                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>"</span></span>
                                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">=</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="comment1">(*&gt;*)</span> 
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="comment1">(*&lt;*)</span><span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">=</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span><span class="comment1">(*&gt;*)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
     <span class="comment1">(*&lt;*)</span>    <span class="keyword1"><span class="command">using</span></span> 
                                       singleton_add_means_equal<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span><span class="main">]</span>
                                       <span class="keyword2"><span class="keyword">and</span></span> singleton_add_means_empty<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span><span class="main">]</span> <span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>modaliseMultiset_def<span class="main">)</span>
                      <span class="comment1">(*&lt;*)</span>            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span> <span class="skolem">r'</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extendRuleEmpty<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span> <span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> aa <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> aa <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                                 <span class="keyword1"><span class="command">}</span></span>
                              <span class="keyword1"><span class="command">moreover</span></span>
                                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span>"</span></span>
                                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;Empt&gt;</span> <span class="main">=</span> <span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                                 <span class="keyword1"><span class="command">}</span></span>
                              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                             <span class="keyword1"><span class="command">}</span></span>
                         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                         <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                         <span class="keyword1"><span class="command">qed</span></span>
                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">=</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∨</span> Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">≠</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                    <span class="keyword1"><span class="command">moreover</span></span>
                       <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">=</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span>
                        <span class="keyword1"><span class="command">with</span></span> bb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                        <span class="keyword1"><span class="command">with</span></span> b' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="operator">-</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span> <span class="operator">auto</span>
                        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">=</span> Modal <span class="free">M</span> <span class="free">Ms</span>›</span></span>
                                 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>›</span></span>
                                 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
                        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">+</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">+</span><span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> 
                             <span class="keyword1"><span class="command">using</span></span> extendContain<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> 
                                               <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ'</span><span class="main">⇒*</span><span class="free">Δ'</span>"</span></span><span class="main">]</span>
                             <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
                        <span class="keyword1"><span class="command">with</span></span> d' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">+</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">+</span><span class="free">Δ'</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
                             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
                       <span class="keyword1"><span class="command">}</span></span>
                    <span class="keyword1"><span class="command">moreover</span></span>
                       <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">≠</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span>
                        <span class="keyword1"><span class="command">with</span></span> bb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span>
                             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 1<span class="main">)</span>
                             <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span> <span class="operator">auto</span>
                        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> a' b' d' <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
                             <span class="keyword2"><span class="keyword">and</span></span> nonPrincipalInvertRight<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span>
                                                  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ms</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span>
                                                  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Δ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> 
                                                  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?M1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?M2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M2</span></span><span class="main">]</span>
                             <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ext1 <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                       <span class="keyword1"><span class="command">}</span></span>
                    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                   <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">moreover</span></span>
                   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>"</span></span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> a' b' d' <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
                         <span class="keyword2"><span class="keyword">and</span></span> nonPrincipalInvertRight<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span>
                                                  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ms</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span>
                                                  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Δ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> 
                                                  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?M1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?M2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M2</span></span><span class="main">]</span>
                         <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ext1 <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                   <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
               <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
           <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">moreover</span></span><span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹\noindent  The other interesting case is where the last inference was a modalised context inference:›</span></span>

 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> ba<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span> <span class="main">∧</span> 
         extendConc <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span>  <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> rules <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">Fs</span></span> <span class="skolem"><span class="skolem">Γ''</span></span> <span class="skolem"><span class="skolem">Δ''</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
       ca<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> extendRule <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
       cb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
     cc<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
  <span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command">using</span></span> modRule1Characterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ1</span></span> <span class="skolem"><span class="skolem">Δ1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="skolem">Δ1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">with</span></span> ba ca <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="skolem">Δ1</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
   eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def extendConc_def union_ac<span class="main">)</span>
     <span class="comment1">(*&lt;*)</span>         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">=</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">M2</span> <span class="main">⋅</span> <span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">⊆</span> set_mset <span class="main">(</span><span class="free">M2</span> <span class="main">⋅</span> <span class="skolem">Δ''</span><span class="main">)</span> <span class="main">∪</span> set_mset <span class="skolem">Δ1</span> <span class="main">∪</span>  <span class="main">{</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(*&gt;*)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="main">(</span><span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span><span class="main">)</span> <span class="main">∨</span> 
             Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="skolem">Δ1</span> <span class="main">∨</span> 
             Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">=</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="main">(</span><span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹Contradiction›</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">with</span></span> <span class="comment1">(*&lt;*)</span>modal_not_contain<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ms</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ''</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span><span class="comment1">(*&gt;*)</span> neq
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> 
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
 <span class="keyword1"><span class="command">moreover</span></span>
   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">=</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span> <span class="comment1">― ‹The last inference is principal›</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">with</span></span> cb <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="skolem">r'</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">with</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>›</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
  <span class="comment1">(*&lt;*)</span>    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> 
                               <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>extend <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ba <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ca
                         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span>"</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extendConc_def<span class="main">)</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> 
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span> 
                    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">with</span></span> d' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">+</span> <span class="skolem">Δ1</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">using</span></span> dpWeak<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span>
                                      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ1</span></span><span class="main">]</span> 
                         <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> 
                         <span class="keyword1"><span class="command">have</span></span> ee<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">+</span> <span class="skolem">Δ1</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
                    <span class="keyword1"><span class="command">from</span></span> eq1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">=</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">=</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span> <span class="main">=</span> <span class="skolem">Δ</span>"</span></span> 
                         <span class="keyword1"><span class="command">using</span></span> add_equal_means_equal<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">" <span class="free">M2</span> <span class="main">⋅</span> <span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span><span class="main">]</span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">+</span> <span class="skolem">Δ1</span> <span class="main">=</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span> <span class="comment1">(*&gt;*)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">+</span><span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
   <span class="comment1">(*&lt;*)</span> <span class="keyword1"><span class="command">using</span></span> ee<span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="skolem">Δ1</span>"</span></span> <span class="comment1">― ‹Formula is in the implicit weakening›</span>
 <span class="comment1">(*&lt;*)</span>  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="skolem">Δ1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Δ2</span><span class="main">.</span> <span class="skolem">Δ1</span> <span class="main">=</span> <span class="bound">Δ2</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert_DiffM<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ1</span>"</span></span><span class="main">]</span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ1</span><span class="main">⊖</span>Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span><span class="comment1">(*&gt;*)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Δ2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ1</span> <span class="main">=</span> <span class="skolem">Δ2</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="comment1">(*&gt;*)</span>
  <span class="keyword1"><span class="command">from</span></span> ba <span class="keyword2"><span class="keyword">and</span></span> rules 
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendConc <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ2</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ba <span class="keyword2"><span class="keyword">and</span></span> ca <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>extendConc <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ2</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Ps</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendConc_def<span class="main">)</span>
 <span class="comment1">(*&lt;*)</span>        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">(</span>extendConc <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ2</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">using</span></span> d' <span class="keyword2"><span class="keyword">and</span></span> derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extendConc <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ2</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
                                                     <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ca <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span>›</span></span> 
                         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>extendConc <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ2</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span><span class="main">)</span> <span class="main">⇒*</span> <span class="main">(</span><span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">Δ2</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extendConc_def extend_def union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> gg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ2</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">from</span></span> eq1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">=</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Δ1</span> <span class="main">=</span> <span class="skolem">Δ2</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>›</span></span>
                         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ2</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">=</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ2</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">=</span> <span class="skolem">Δ</span>"</span></span> 
                         <span class="keyword1"><span class="command">using</span></span> add_equal_means_equal<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">" <span class="free">M2</span> <span class="main">⋅</span> <span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ2</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span><span class="main">]</span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ2</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">=</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span> <span class="comment1">(*&gt;*)</span> 
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command">using</span></span> gg<span class="comment1">(*&gt;*)</span>   
           
           <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> 
           <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> 
           <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="comment1">(*&lt;*)</span>  <span class="keyword1"><span class="command">}</span></span><span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹\noindent The other case, where the last inference was a left inference, is more straightforward, and so is omitted.›</span></span>
 <span class="comment1">(*&lt;*)</span>
            <span class="keyword1"><span class="command">moreover</span></span>
               <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">with</span></span> ba ca <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="skolem">Δ1</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
                     eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span>
                     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def extendConc_def union_ac<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span> <span class="main">=</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">M2</span> <span class="main">⋅</span> <span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">⊆</span> set_mset <span class="main">(</span><span class="free">M2</span> <span class="main">⋅</span> <span class="skolem">Δ''</span><span class="main">)</span> <span class="main">∪</span> set_mset <span class="skolem">Δ1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="main">(</span><span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span><span class="main">)</span> <span class="main">∨</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="skolem">Δ1</span>"</span></span>
                     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span>
                   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="main">(</span><span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">with</span></span> modal_not_contain<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ms</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ''</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> neq
                         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                   <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">moreover</span></span>
                   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="skolem">Δ1</span>"</span></span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="skolem">Δ1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Δ2</span><span class="main">.</span> <span class="skolem">Δ1</span> <span class="main">=</span> <span class="bound">Δ2</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert_DiffM<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ1</span>"</span></span><span class="main">]</span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ1</span><span class="main">⊖</span>Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Δ2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ1</span> <span class="main">=</span> <span class="skolem">Δ2</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                    <span class="keyword1"><span class="command">from</span></span> ba <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendConc <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ2</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ba <span class="keyword2"><span class="keyword">and</span></span> ca <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>extendConc <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ2</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Ps</span>"</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendConc_def<span class="main">)</span>
                    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">(</span>extendConc <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ2</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">using</span></span> d' <span class="keyword2"><span class="keyword">and</span></span> derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extendConc <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ2</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
                                                     <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ca <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>›</span></span> 
                         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>extendConc <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ2</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span><span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ2</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extendConc_def extend_def union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> gg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ2</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">from</span></span> eq1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>  <span class="main">=</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">+</span> <span class="free">Γ'</span><span class="main">)</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Δ1</span> <span class="main">=</span> <span class="skolem">Δ2</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>›</span></span>
                         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ2</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">=</span> <span class="skolem">Δ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ2</span> <span class="main">=</span> <span class="skolem">Δ</span>"</span></span> 
                         <span class="keyword1"><span class="command">using</span></span> add_equal_means_equal<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">" <span class="free">M2</span> <span class="main">⋅</span> <span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span><span class="main">]</span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ2</span> <span class="main">+</span> <span class="free">Δ'</span>  <span class="main">=</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                   <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
               <span class="keyword1"><span class="command">}</span></span>
           <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">}</span></span>   
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
       
                     

<span class="keyword1"><span class="command">lemma</span></span> leftInvert<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Γ</span> <span class="free">Δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> form multiset"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> rules<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R2</span> <span class="main">⊆</span> modRules2 <span class="main">∧</span> <span class="free">R3</span> <span class="main">⊆</span> modRules2 <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span> <span class="main">∪</span> <span class="free">R3</span> <span class="main">∧</span> <span class="free">R'</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">∪</span> <span class="free">R3</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">.</span> leftPrincipal <span class="bound">r'</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M1</span> <span class="main">≠</span> <span class="free">M</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">+</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_less_induct<span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">Γ</span> <span class="skolem">Δ</span><span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Γ</span> <span class="bound">Δ</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="bound">Δ</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">.</span> leftPrincipal <span class="bound">r'</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span> <span class="main">⟶</span> <span class="main">(</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">.</span> leftPrincipal <span class="bound">r'</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r'</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> 0
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">S</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> Ax<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="operator">-</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext.cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="tfree">'b</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">seq</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> upRules.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> upRules.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> upRules.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> p_e_non_empty<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">R2</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">M1</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> N<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">M2</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>At <span class="improper">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="improper">i</span><span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendConc_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="improper">b</span><span class="main">)</span> <span class="main">∈</span> modRules2"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> modRules2.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span> 
         <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
               <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">∧</span> At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Δ</span>"</span></span> 
               <span class="keyword1"><span class="command">using</span></span> extendID<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">∧</span> At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules
               <span class="keyword2"><span class="keyword">and</span></span> containID<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span>
         <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">using</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span>"</span></span> 
               <span class="keyword1"><span class="command">using</span></span> extendFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">⊕</span>Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules
               <span class="keyword2"><span class="keyword">and</span></span> containFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                          <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                       d'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> characteriseLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> modRules2<span class="main">)</span> <span class="main">∧</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
                       <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span> <span class="main">∧</span> extendConc <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> modRules2<span class="main">)</span> <span class="main">∧</span> extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span><span class="main">)</span>
                                <span class="main">∨</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">∈</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span> <span class="main">∧</span> extendConc <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> ext1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> modRules2<span class="main">)</span> <span class="main">∧</span> extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> modRules2"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> 
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> 
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> upRules›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> sw<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> 
                                                   <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> upRuleCharacterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span>leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
             <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>"</span></span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">with</span></span> sw <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> upRules›</span></span> <span class="keyword2"><span class="keyword">and</span></span> disjoint <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">}</span></span>
             <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>"</span></span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> a' b' d' <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
                      <span class="keyword2"><span class="keyword">and</span></span> nonPrincipalInvertLeft<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span>
                                                  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ms</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span>
                                                  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Δ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> 
                                                  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?M1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?M2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M2</span></span><span class="main">]</span>
                      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ext1 <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">}</span></span>
             <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> modRules2"</span></span>
             <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> modRules2›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">Ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> sw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>
                                                         <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> modRule2Characterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span> <span class="main">∨</span> <span class="main">¬</span> leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
             <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>"</span></span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b' <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="operator">-</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> leftPrincipal.cases<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ex<span class="main">:</span><span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
                      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendContain<span class="main">)</span>
                 <span class="keyword1"><span class="command">moreover</span></span>
                    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bb<span class="main">:</span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">)</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span>
                       <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
                          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> modRules2›</span></span>
                          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                          <span class="keyword1"><span class="command">with</span></span> rules
                          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span> <span class="main">∨</span>
                                <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span><span class="main">)</span>
                                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> upRules.cases<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                          <span class="keyword1"><span class="command">moreover</span></span>
                             <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R3</span>"</span></span>
                              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                             <span class="keyword1"><span class="command">}</span></span>
                          <span class="keyword1"><span class="command">moreover</span></span>
                             <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span>"</span></span>
                              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ'</span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="skolem"><span class="skolem">r'</span></span> 
                                   <span class="keyword2"><span class="keyword">where</span></span> aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span> <span class="skolem">r'</span> <span class="main">∧</span> <span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span>
                                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> p_e.cases<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> modRules2"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">Fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
                                   <span class="quoted"><span class="quoted">"snd <span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> snd <span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
                                   <span class="keyword1"><span class="command">using</span></span> modRule2Characterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="skolem">r'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">r'</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                              <span class="keyword1"><span class="command">with</span></span> aa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span> <span class="main">∨</span>
                                            <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span>"</span></span>
                                   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
                              <span class="keyword1"><span class="command">moreover</span></span>
                                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>"</span></span>
                                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;Empt&gt;</span> <span class="main">=</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                                 <span class="keyword1"><span class="command">}</span></span>
                              <span class="keyword1"><span class="command">moreover</span></span>
                                 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span>"</span></span>
                                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">=</span> <span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">=</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span>"</span></span>
                                       <span class="keyword1"><span class="command">using</span></span> 
                                       singleton_add_means_equal<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span><span class="main">]</span>
                                       <span class="keyword2"><span class="keyword">and</span></span> singleton_add_means_empty<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span><span class="main">]</span> 
                                       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>modaliseMultiset_def<span class="main">)</span>
                                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span> <span class="skolem">r'</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extendRuleEmpty<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ'</span><span class="main">)</span> <span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> aa <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> aa <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                                 <span class="keyword1"><span class="command">}</span></span>
                              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                             <span class="keyword1"><span class="command">}</span></span>
                         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                         <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                         <span class="keyword1"><span class="command">qed</span></span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="skolem">T</span> <span class="skolem">Ts</span> <span class="main">=</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> leftPrincipal.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> leftPrincipal.cases<span class="main">)</span>
                          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> leftPrincipal.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 1<span class="main">)</span>
                          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> leftPrincipal.cases<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">}</span></span>
                    <span class="keyword1"><span class="command">moreover</span></span>
                    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">T</span> <span class="skolem">Ts</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> leftPrincipal.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
                     <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command">}</span></span>
                 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sw <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">with</span></span> ex <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
                <span class="keyword1"><span class="command">}</span></span>
             <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="skolem">r</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>"</span></span>
                 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> a' b' d' <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
                      <span class="keyword2"><span class="keyword">and</span></span> nonPrincipalInvertLeft<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n</span></span>
                                                  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ms</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span>
                                                  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Δ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ps</span></span> 
                                                  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?M1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?M2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M2</span></span><span class="main">]</span>
                      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ext1 <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">}</span></span>
             <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">}</span></span>
         <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> ba<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> p_e <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span> <span class="main">∧</span> extendConc <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span>  <span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">with</span></span> rules <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">Fs</span></span> <span class="skolem"><span class="skolem">Γ''</span></span> <span class="skolem"><span class="skolem">Δ''</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
                ca<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> extendRule <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                cb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
                cc<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> modRule1Characterise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ1</span></span> <span class="skolem"><span class="skolem">Δ1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="skolem">Δ1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span>
               <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">with</span></span> ba ca <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="skolem">Δ1</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
                     eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ1</span>  <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
                     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def extendConc_def union_ac<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">M1</span> <span class="main">⋅</span> <span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ1</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">⊆</span> set_mset <span class="main">(</span><span class="free">M1</span> <span class="main">⋅</span> <span class="skolem">Γ''</span><span class="main">)</span> <span class="main">∪</span> set_mset <span class="skolem">Γ1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span><span class="main">)</span> <span class="main">∨</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="skolem">Γ1</span>"</span></span>
                     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span>
                   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">with</span></span> modal_not_contain<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ms</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ''</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> neq
                         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                   <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">moreover</span></span>
                   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="skolem">Γ1</span>"</span></span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="skolem">Γ1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ2</span><span class="main">.</span> <span class="skolem">Γ1</span> <span class="main">=</span> <span class="bound">Γ2</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert_DiffM<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ1</span>"</span></span><span class="main">]</span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ1</span><span class="main">⊖</span>Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ1</span> <span class="main">=</span> <span class="skolem">Γ2</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                    <span class="keyword1"><span class="command">from</span></span> ba <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendConc <span class="main">(</span><span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ba <span class="keyword2"><span class="keyword">and</span></span> ca <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>extendConc <span class="main">(</span><span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Ps</span>"</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendConc_def<span class="main">)</span>
                    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">(</span>extendConc <span class="main">(</span><span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">using</span></span> d' <span class="keyword2"><span class="keyword">and</span></span> derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extendConc <span class="main">(</span><span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
                                                     <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ca <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>›</span></span> 
                         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>extendConc <span class="main">(</span><span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span><span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="main">(</span><span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span><span class="main">+</span> <span class="skolem">Δ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extendConc_def extend_def union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> gg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">from</span></span> eq1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>  <span class="main">=</span> <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">=</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ1</span> <span class="main">=</span> <span class="skolem">Γ2</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>›</span></span>
                         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">=</span> <span class="skolem">Γ</span>"</span></span> 
                         <span class="keyword1"><span class="command">using</span></span> add_equal_means_equal<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">" <span class="free">M1</span> <span class="main">⋅</span> <span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span><span class="main">]</span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span>  <span class="main">=</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                   <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
               <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">moreover</span></span>
               <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">with</span></span> ba ca <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="skolem">Δ1</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
                     eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span>
                     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def extendConc_def union_ac<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">M1</span> <span class="main">⋅</span> <span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">⊆</span> set_mset <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span> <span class="skolem">Γ''</span><span class="main">)</span> <span class="main">∪</span> set_mset <span class="skolem">Γ1</span> <span class="main">∪</span>  <span class="main">{</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span><span class="main">)</span> <span class="main">∨</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="skolem">Γ1</span> <span class="main">∨</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">=</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span>
                     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span>
                   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">with</span></span> modal_not_contain<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ms</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ''</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> neq
                         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                   <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">moreover</span></span>
                   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">=</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command">with</span></span> cb <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="skolem">r'</span> <span class="main">(</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">)</span> <span class="free">R'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">with</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>›</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>extend <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ba <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>Modal <span class="free">M</span> <span class="free">Ms</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ca
                         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps</span>"</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extendConc_def<span class="main">)</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> 
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span> 
                    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">with</span></span> d' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">+</span> <span class="skolem">Δ1</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">using</span></span> dpWeak<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R2</span></span>
                                      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">M2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R3</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ1</span></span><span class="main">]</span> 
                         <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> 
                         <span class="keyword1"><span class="command">have</span></span> ee<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">+</span> <span class="skolem">Δ1</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
                    <span class="keyword1"><span class="command">from</span></span> eq1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span> <span class="main">=</span> <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="free">Δ'</span> <span class="main">+</span> <span class="skolem">Δ1</span> <span class="main">=</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">=</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">=</span> <span class="skolem">Γ</span>"</span></span> 
                         <span class="keyword1"><span class="command">using</span></span> add_equal_means_equal<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">" <span class="free">M1</span> <span class="main">⋅</span> <span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span><span class="main">]</span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">+</span> <span class="skolem">Γ1</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">+</span><span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">using</span></span> ee <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
                   <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">moreover</span></span>
                   <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈</span> set_mset <span class="skolem">Γ1</span>"</span></span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">∈#</span> <span class="skolem">Γ1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ2</span><span class="main">.</span> <span class="skolem">Γ1</span> <span class="main">=</span> <span class="bound">Γ2</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert_DiffM<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ1</span>"</span></span><span class="main">]</span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ1</span><span class="main">⊖</span>Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ1</span> <span class="main">=</span> <span class="skolem">Γ2</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                    <span class="keyword1"><span class="command">from</span></span> ba <span class="keyword2"><span class="keyword">and</span></span> rules <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendConc <span class="main">(</span><span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ba <span class="keyword2"><span class="keyword">and</span></span> ca <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>extendConc <span class="main">(</span><span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Ps</span>"</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendConc_def<span class="main">)</span>
                    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">(</span>extendConc <span class="main">(</span><span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">using</span></span> d' <span class="keyword2"><span class="keyword">and</span></span> derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extendConc <span class="main">(</span><span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
                                                     <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ca <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>›</span></span> 
                         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>extendConc <span class="main">(</span><span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">)</span><span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extendConc_def extend_def union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> gg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">⇒*</span> <span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">from</span></span> eq1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span> <span class="main">=</span> <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M2</span><span class="main">⋅</span><span class="skolem">Δ''</span> <span class="main">+</span> <span class="skolem">Δ1</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> eq2 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ1</span> <span class="main">=</span> <span class="skolem">Γ2</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>›</span></span>
                         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="main">⊕</span> Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">=</span> <span class="skolem">Γ</span>"</span></span> 
                         <span class="keyword1"><span class="command">using</span></span> add_equal_means_equal<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">" <span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Modal <span class="free">M</span> <span class="free">Ms</span>"</span></span><span class="main">]</span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M1</span><span class="main">⋅</span><span class="skolem">Γ''</span> <span class="main">+</span> <span class="skolem">Γ2</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⊕</span> Modal <span class="skolem">F</span> <span class="skolem">Fs</span> <span class="main">=</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>union_ac<span class="main">)</span>
                    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                   <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
               <span class="keyword1"><span class="command">}</span></span>
           <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
           <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> <span class="free">R2</span> <span class="free">M1</span> <span class="free">M2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">datatype</span></span> C <span class="main">=</span> con
<span class="keyword1"><span class="command">datatype</span></span> BD <span class="main">=</span> BOX <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">□</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span><span class="main">|</span> DIAMOND <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">◇</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> CDBD_form <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>C<span class="main">,</span>BD<span class="main">)</span> form"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">con_form</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∧*</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="free">∧*</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">::</span> CDBD_form<span class="main">)</span> <span class="main">≡</span> Compound con <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">BOX_form</span> <span class="main">(</span> <span class="quoted">"<span class="keyword1">□</span> _"</span> <span class="main">[</span>80<span class="main">]</span>80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main"><span class="free">□</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">::</span> CDBD_form<span class="main">)</span>  <span class="main">≡</span> Modal <span class="main">□</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">DIAMOND_form</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">◇</span> _"</span> <span class="main">[</span>80<span class="main">]</span>80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main"><span class="free">◇</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">::</span> CDBD_form<span class="main">)</span> <span class="main">≡</span> Modal <span class="main">◇</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">g3up</span>"</span>
<span class="keyword2"><span class="keyword">where</span></span>
    conL<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">+</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">g3up</span>"</span></span>
<span class="main">|</span>   conR<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">g3up</span>"</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We guarantee no other rule has the same modal operator in the succedent of a modalised context rule using the condition $M \neq M_{2}$.  Note this lemma only allows one kind of modalised context rule.  In other words, it could not be applied to a calculus with the rules:

\[
\begin{array}{ccc}
\infer[R_{1}]{\Gamma',!\cdot\Gamma \Rightarrow \bullet A,\bullet\cdot\Delta,\Delta'}{!\cdot\Gamma \Rightarrow A,\bullet\cdot\Delta} &amp; \ \ \ &amp;
\infer[R_{2}]{\Gamma',\bullet\cdot\Gamma \Rightarrow \bullet A,!\cdot\Delta,\Delta'}{\bullet\cdot\Gamma \Rightarrow A,!\cdot\Delta}
\end{array}
\]
since, if $([\emptyset \Rightarrow A],\emptyset \Rightarrow \bullet A) \in \mathcal{R}$, then $R_{1} \in \textrm{p-e } \mathcal{R}\ !\ \bullet$, whereas $R_{2} \in \textrm{p-e } \mathcal{R}\ \bullet\ !$.  Similarly, we cannot have modalised context rules which have more than one modalised multiset in the antecedent or succedent of the active part.  For instance:

\[
\infer{\Gamma',!\cdot\Gamma_{1},\bullet\cdot\Gamma_{2} \Rightarrow \bullet A,!\cdot\Delta_{1},\bullet\cdot\Delta_{2},\Delta'}{!\cdot\Gamma_{1},\bullet\cdot\Gamma_{2} \Rightarrow A,!\cdot\Delta_{1},\bullet\cdot\Delta_{2}}
\]
cannot belong to any \texttt{p-e} set.  It would be a simple matter to extend the definition of \texttt{p-e} to take a \textit{set} of modal operators, however this has not been done. 

As an example, classical modal logic can be formalised.
The (modal) rules for this calculus are then given in two sets, the latter of which will be extended with $\Box\cdot\Gamma \Rightarrow \Diamond\cdot\Delta$:
›</span></span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">g3mod2</span>"</span> 
<span class="keyword2"><span class="keyword">where</span></span>
    diaR<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="main">◇</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">g3mod2</span>"</span></span>
<span class="main">|</span>   boxL<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;LM&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> <span class="main">□</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">g3mod2</span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">g3mod1</span>"</span>
<span class="keyword2"><span class="keyword">where</span></span>
    boxR<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">\&lt;RM&gt;</span><span class="main">]</span><span class="main">,</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="main">□</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">g3mod1</span>"</span></span>
<span class="main">|</span>   diaL<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="comment1">(*&gt;*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">\&lt;LM&gt;</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span> <span class="main">◇</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">g3mod1</span>"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">lemma</span></span> g3up_upRules<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"g3up <span class="main">⊆</span> upRules"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
 <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ps</span> <span class="skolem">c</span>
 <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> g3up"</span></span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"g3up <span class="main">⊆</span> upRules"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> g3mod2_modRules2<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"g3mod2 <span class="main">⊆</span> modRules2"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
 <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ps</span> <span class="skolem">c</span>
 <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> g3mod2"</span></span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> modRules2"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"g3mod2 <span class="main">⊆</span> modRules2"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> g3mod1_modRules2<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"g3mod1 <span class="main">⊆</span> modRules2"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
 <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ps</span> <span class="skolem">c</span>
 <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> g3mod1"</span></span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> modRules2"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"g3mod1 <span class="main">⊆</span> modRules2"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">lemmas</span></span> g3 <span class="main">=</span> g3up_upRules g3mod1_modRules2 g3mod2_modRules2




<span class="keyword1"><span class="command">lemma</span></span> principal_Ax<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">r</span> <span class="main">∈</span> Ax <span class="main">;</span> rightPrincipal <span class="free">r</span> <span class="main">(</span><span class="main">□</span> <span class="free">A</span><span class="main">)</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nonPrincipalID<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> principal_g3up<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">r</span> <span class="main">∈</span> g3up <span class="main">;</span> rightPrincipal <span class="free">r</span> <span class="main">(</span><span class="main">□</span> <span class="free">A</span><span class="main">)</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> upRules"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>upRules_not_right_principal_for_modal<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> g3up_upRules<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> principal_g3mod2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> g3mod2"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> g3up <span class="main">∪</span> g3mod1 <span class="main">∪</span> g3mod2"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="free">r</span> <span class="main">(</span><span class="main">□</span> <span class="free">A</span><span class="main">)</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> g3mod2›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span><span class="main">□</span> <span class="bound">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∨</span>
                              <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="main">◇</span> <span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> g3mod2.cases<span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">\&lt;LM&gt;</span><span class="skolem">B</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span><span class="main">□</span> <span class="skolem">B</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∨</span>
                       <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">B</span><span class="main">\&lt;RM&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="main">◇</span> <span class="skolem">B</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="main">(</span><span class="main">□</span> <span class="free">A</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> g3up <span class="main">∪</span> g3mod1 <span class="main">∪</span> g3mod2›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹rightPrincipal <span class="free">r</span> <span class="main">(</span><span class="main">□</span> <span class="free">A</span><span class="main">)</span> <span class="free">R</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> principal_g3mod1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> g3mod1"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> g3up <span class="main">∪</span> g3mod1 <span class="main">∪</span> g3mod2"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="free">r</span> <span class="main">(</span><span class="main">□</span> <span class="free">A</span><span class="main">)</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> g3mod1›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span><span class="main">◇</span> <span class="bound">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∨</span>
                              <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="main">□</span> <span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> g3mod1.cases<span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">\&lt;LM&gt;</span><span class="skolem">B</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span><span class="main">◇</span> <span class="skolem">B</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∨</span>
                       <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">B</span><span class="main">\&lt;RM&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="main">□</span> <span class="skolem">B</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">\&lt;LM&gt;</span><span class="skolem">B</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span><span class="main">◇</span> <span class="skolem">B</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="main">(</span><span class="main">□</span> <span class="free">A</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> g3up <span class="main">∪</span> g3mod1 <span class="main">∪</span> g3mod2›</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def<span class="main">)</span>
     <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹rightPrincipal <span class="free">r</span> <span class="main">(</span><span class="main">□</span> <span class="free">A</span><span class="main">)</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
 <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">B</span><span class="main">\&lt;RM&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="main">□</span> <span class="skolem">B</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="free">r</span> <span class="main">(</span><span class="main">□</span> <span class="skolem">B</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> g3mod1›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> g3up <span class="main">∪</span> g3mod1 <span class="main">∪</span> g3mod2›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹rightPrincipal <span class="free">r</span> <span class="main">(</span><span class="main">□</span> <span class="free">A</span><span class="main">)</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="operator">-</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 1<span class="main">)</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rightPrincipal.cases<span class="main">)</span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="skolem">B</span><span class="main">\&lt;RM&gt;</span><span class="main">]</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="main">□</span> <span class="skolem">B</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> principal<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">=</span> Ax <span class="main">∪</span> g3up <span class="main">∪</span> g3mod1 <span class="main">∪</span> g3mod2"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">.</span> rightPrincipal <span class="bound">r</span> <span class="main">(</span><span class="main">□</span> <span class="free">A</span><span class="main">)</span> <span class="free">R'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> principal_Ax<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">a</span><span class="main">,</span><span class="improper">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> principal_g3up<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">a</span><span class="main">,</span><span class="improper">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> principal_g3mod1<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">a</span><span class="main">,</span><span class="improper">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> principal_g3mod2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">a</span><span class="main">,</span><span class="improper">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent We then show the strong admissibility of the rule:

\[
\infer{\Gamma \Rightarrow A,\Delta}{\Gamma \Rightarrow \Box A,\Delta}
\]

›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> invertBoxR<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> g3up <span class="main">∪</span> <span class="main">(</span>p_e g3mod1 <span class="main">□</span> <span class="main">◇</span><span class="main">)</span> <span class="main">∪</span> g3mod2"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊕</span> <span class="main">(</span><span class="main">□</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> g3mod1 <span class="main">□</span> <span class="main">◇</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊕</span> <span class="free">A</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span>ext <span class="free">R</span> g3mod1 <span class="main">□</span> <span class="main">◇</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
 <span class="keyword1"><span class="command">using</span></span> principal<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Ax <span class="main">∪</span> g3up <span class="main">∪</span> g3mod1 <span class="main">∪</span> g3mod2"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="comment1">(*&gt;*)</span>
 <span class="keyword2"><span class="keyword">and</span></span> rightInvert<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?R1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"g3up"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"g3mod1"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R3.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"g3mod2"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?M1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">□</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?M2.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">◇</span></span>
                       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">□</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Ms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;Empt&gt;</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span>"</span></span>
                       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Ax <span class="main">∪</span> g3up <span class="main">∪</span> g3mod1 <span class="main">∪</span> g3mod2"</span></span><span class="main">]</span><span class="comment1">(*&gt;*)</span>
 <span class="keyword2"><span class="keyword">and</span></span> g3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\noindent where \textit{principal} is the result which fulfils the principal formula conditions given in the inversion lemma, and \textit{g3} is a result about rule sets.›</span></span>
<span class="comment1">(*&lt;*)</span> 
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="SRCTransforms">
<div class="head">
<h1>Theory SRCTransforms</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(* Author : Peter Chapman *)</span>
<span class="comment1">(* License: LGPL *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Rule Set Transformations"</span></span>
 
<span class="keyword1"><span class="command">theory</span></span> SRCTransforms
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> form <span class="main">=</span> At <span class="quoted"><span class="quoted">"nat"</span></span>
                 <span class="main">|</span> Compound <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> form list"</span></span>
                 <span class="main">|</span> ff

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> sequent <span class="main">=</span> Sequent <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> form<span class="main">)</span> multiset"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> form<span class="main">)</span> multiset"</span></span> <span class="main">(</span><span class="quoted">" <span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⇒*</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>6<span class="main">,</span>6<span class="main">]</span> 5<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">multiset_abbrev</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">\&lt;LM&gt;</span> _  <span class="keyword1">\&lt;RM&gt;</span>"</span> <span class="main">[</span>75<span class="main">]</span>75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main"><span class="free">\&lt;LM&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">\&lt;RM&gt;</span></span> <span class="main">≡</span> <span class="main">{#</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">#}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">multiset_empty</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">\&lt;Empt&gt;</span>"</span> 75<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">\&lt;Empt&gt;</span></span> <span class="main">≡</span> <span class="main">{#}</span>"</span></span>

<span class="comment1">(* We have that any step in a rule, be it a primitive rule or an instance of a rule in a derivation
   can be represented as a list of premisses and a conclusion.  We need a list since a list is finite
   by definition *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> rule <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent list <span class="main">*</span> <span class="tfree">'a</span> sequent"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> deriv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">*</span> nat"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
<span class="entity">multiset_plus</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊕</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main"><span class="free">⊕</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">+</span> <span class="main">\&lt;LM&gt;</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">\&lt;RM&gt;</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span>
<span class="entity">multiset_minus</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊖</span>"</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main"><span class="free">⊖</span></span>  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">-</span> <span class="main">\&lt;LM&gt;</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">\&lt;RM&gt;</span>"</span></span> 

<span class="keyword1"><span class="command">consts</span></span>
  <span class="comment1">(* extend a sequent by adding another one.  A form of weakening.  Is this overkill by adding a sequent? *)</span>
  extend <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> sequent"</span></span>
  extendRule <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> rule <span class="main">⇒</span> <span class="tfree">'a</span> rule"</span></span>

  <span class="comment1">(* Unique conclusion Property *)</span>
  uniqueConclusion <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set <span class="main">⇒</span> bool"</span></span>

  <span class="comment1">(* Invertible definitions *)</span>
  invertible <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule <span class="main">⇒</span> <span class="tfree">'a</span> rule set <span class="main">⇒</span> bool"</span></span>
  invertible_set <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set <span class="main">⇒</span> bool"</span></span>

  <span class="comment1">(* functions to get at components of sequents *)</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">antec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> form multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">antec</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ant</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> form multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">succ</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> <span class="tfree">'a</span> form multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mset</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">seq_size</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sequent <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">seq_size</span> <span class="main">(</span>Sequent <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="free"><span class="bound"><span class="entity">suc</span></span></span><span class="main">)</span> <span class="main">=</span> size <span class="free"><span class="bound"><span class="entity">ant</span></span></span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">suc</span></span></span>"</span></span>

<span class="comment1">(* Extend a sequent, and then a rule by adding seq to all premisses and the conclusion *)</span>
<span class="keyword1"><span class="command">overloading</span></span>
  extend <span class="main">≡</span> <span class="quoted">extend</span>
  extendRule <span class="main">≡</span> <span class="quoted">extendRule</span>
  uniqueConclusion <span class="main">≡</span> <span class="quoted">uniqueConclusion</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extend</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">extend</span> <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="free"><span class="bound"><span class="entity">seq</span></span></span> <span class="main">≡</span> <span class="main">(</span>antec <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="main">+</span> antec <span class="free"><span class="bound"><span class="entity">seq</span></span></span><span class="main">)</span> <span class="main">⇒*</span> <span class="main">(</span>succ <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="main">+</span> succ <span class="free"><span class="bound"><span class="entity">seq</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extendRule</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">extendRule</span> <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">(</span>map <span class="main">(</span>extend <span class="free"><span class="bound"><span class="entity">forms</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">,</span> extend <span class="free"><span class="bound"><span class="entity">forms</span></span></span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* The unique conclusion property.  A set of rules has unique conclusion property if for any pair of rules,
   the conclusions being the same means the rules are the same*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uniqueConclusion</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">uniqueConclusion</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">r1</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">∀</span> <span class="bound">r2</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">(</span>snd <span class="bound">r1</span> <span class="main">=</span> snd <span class="bound">r2</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">r1</span> <span class="main">=</span><span class="bound">r2</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">max_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_list</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">max_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free">max_list</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* The depth of a formula.  Will be useful in later files. *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">depth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> form <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="main">(</span>At <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="main">(</span>Compound <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>max_list <span class="main">(</span>map <span class="free">depth</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="main">(</span>ff<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="comment1">(* The formulation of various rule sets *)</span>

<span class="comment1">(* Ax is the set containing all identity RULES and LBot *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">Ax</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
   id<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ax</span>"</span></span>
<span class="main">|</span>  Lbot<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ax</span>"</span></span>

<span class="comment1">(* upRules is the set of all rules which have a single conclusion.  This is akin to each rule having a 
   single principal formula.  We don't want rules to have no premisses, hence the restriction
   that ps ≠ [] *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="quoted">"<span class="entity">upRules</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
   I<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mset <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">\&lt;LM&gt;</span> Compound <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span> <span class="main">\&lt;RM&gt;</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">upRules</span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">extRules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set <span class="main">⇒</span> <span class="tfree">'a</span> rule set"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">*</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
   I<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> extendRule <span class="free"><span class="bound"><span class="entity">seq</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="free">*</span></span>"</span></span>

<span class="comment1">(* A formulation of what it means to be a principal formula for a rule.  Note that we have to build up from
   single conclusion rules.   *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">leftPrincipal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule <span class="main">⇒</span> <span class="tfree">'a</span> form <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  up<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>  <span class="main">⟹</span> 
                   <span class="free">leftPrincipal</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">(</span>Compound <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">rightPrincipal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule <span class="main">⇒</span> <span class="tfree">'a</span> form <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  up<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">rightPrincipal</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">(</span>Compound <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">Fs</span></span></span><span class="main">)</span>"</span></span>


<span class="comment1">(* What it means to be a derivable sequent.  Can have this as a predicate or as a set.
   The two formation rules say that the supplied premisses are derivable, and the second says
   that if all the premisses of some rule are derivable, then so is the conclusion.  *)</span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">derivable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set <span class="main">⇒</span> <span class="tfree">'a</span> deriv set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
   base<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable</span> <span class="free">R</span>"</span></span>
<span class="main">|</span>  step<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">;</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">≠</span><span class="main">[]</span> <span class="main">;</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable</span> <span class="free">R</span> <span class="main">⟧</span> 
                       <span class="main">⟹</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable</span> <span class="free">R</span>"</span></span>


<span class="comment1">(* When we don't care about height! *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">derivable'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set <span class="main">⇒</span> <span class="tfree">'a</span> sequent set"</span></span>
   <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rule set"</span></span>
   <span class="keyword2"><span class="keyword">where</span></span>
    base<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∈</span> <span class="free">derivable'</span> <span class="free">R</span>"</span></span>
<span class="main">|</span>   step<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free">R</span> <span class="main">;</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">;</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">derivable'</span> <span class="free">R</span> <span class="main">⟧</span>
                       <span class="main">⟹</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">derivable'</span> <span class="free">R</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> deriv_to_deriv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> derivable' <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> deriv_to_deriv2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> derivable' <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">C</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">as</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">as</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="main">(</span>max <span class="skolem">m</span> <span class="skolem">m'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ps</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* definition of invertible rule and invertible set of rules.  It's a bit nasty, but all it really says is
   If a rule is in the given set, and if any extension of that rule is derivable at n, then the
   premisses of the extended rule are derivable at height at most n.  *)</span>
<span class="keyword1"><span class="command">overloading</span></span>
  invertible <span class="main">≡</span> <span class="quoted">invertible</span>
  invertible_set <span class="main">≡</span> <span class="quoted">invertible_set</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">invertible</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">invertible</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span>
    <span class="main">∀</span> <span class="bound">n</span> <span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∧</span> <span class="main">(</span>snd <span class="main">(</span>extendRule <span class="bound">S</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">*</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="bound">S</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span> <span class="main">≤</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">*</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">invertible_set</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">invertible_set</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="main">(</span><span class="bound">ps</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> invertible <span class="main">(</span><span class="bound">ps</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="comment1">(* Characterisation of a sequent *)</span>
<span class="keyword1"><span class="command">lemma</span></span> characteriseSeq<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="main">(</span><span class="free">C</span> <span class="main">::</span> <span class="tfree">'a</span> sequent<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">A</span> <span class="main">⇒*</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(* Helper function for later *)</span>
<span class="keyword1"><span class="command">lemma</span></span> nonEmptySet<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>neq_Nil_conv<span class="main">)</span>

<span class="comment1">(* Lemma which comes in helpful ALL THE TIME *)</span>
<span class="keyword1"><span class="command">lemma</span></span> midMultiset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊕</span> <span class="free">A</span> <span class="main">=</span> <span class="free">Γ'</span> <span class="main">⊕</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ''</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">=</span> <span class="bound">Γ''</span> <span class="main">⊕</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="bound">Γ''</span> <span class="main">⊕</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> <span class="free">Γ'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">Γ</span> <span class="main">⊕</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="free">Γ'</span> <span class="main">⊕</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">Γ</span> <span class="main">∪</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">=</span> set_mset <span class="free">Γ'</span> <span class="main">∪</span> <span class="main">{</span><span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">Γ</span> <span class="main">∪</span> <span class="main">{</span><span class="free">A</span><span class="main">}</span> <span class="main">⊆</span> set_mset <span class="free">Γ'</span> <span class="main">∪</span> <span class="main">{</span><span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set_mset <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈#</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="main">⊖</span> <span class="free">A</span> <span class="main">⊕</span> <span class="free">A</span> <span class="main">=</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>multiset_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ''</span><span class="main">.</span> <span class="free">Γ'</span> <span class="main">=</span> <span class="bound">Γ''</span> <span class="main">⊕</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="main">⊖</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="main">=</span> <span class="skolem">Γ''</span> <span class="main">⊕</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Γ</span> <span class="main">⊕</span> <span class="free">A</span> <span class="main">=</span> <span class="free">Γ'</span> <span class="main">⊕</span> <span class="free">B</span>›</span></span> eq1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊕</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">Γ''</span> <span class="main">⊕</span> <span class="free">A</span> <span class="main">⊕</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="skolem">Γ''</span> <span class="main">⊕</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eq1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Lemma which says that if we have extended an identity rule, then the propositional variable is
   contained in the extended multisets *)</span>
<span class="keyword1"><span class="command">lemma</span></span> extendID<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"At <span class="free">i</span> <span class="main">∈#</span> <span class="free">Γ</span> <span class="main">∧</span> At <span class="free">i</span> <span class="main">∈#</span> <span class="free">Δ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ'</span> <span class="bound">Δ'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">=</span> <span class="bound">Γ'</span> <span class="main">⊕</span> At <span class="free">i</span> <span class="main">∧</span> <span class="free">Δ</span> <span class="main">=</span> <span class="bound">Δ'</span> <span class="main">⊕</span> At <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extendFalsum<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">=</span> <span class="bound">Γ'</span> <span class="main">⊕</span> ff"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(* Lemma that says if a propositional variable is in both the antecedent and succedent of a sequent,
   then it is derivable from idupRules *)</span>
<span class="keyword1"><span class="command">lemma</span></span> containID<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"At <span class="free">i</span> <span class="main">∈#</span> <span class="free">Γ</span> <span class="main">∧</span> At <span class="free">i</span> <span class="main">∈#</span> <span class="free">Δ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"Ax <span class="main">⊆</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⊕</span> At <span class="free">i</span> <span class="main">∧</span> <span class="free">Δ</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⊕</span> At <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="main">(</span><span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span><span class="main">)</span> <span class="main">⇒*</span> <span class="main">(</span><span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="free">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> extRules.I<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span>"</span></span><span class="main">]</span> 
      <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> At <span class="free">i</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">⊖</span> At <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="free">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> derivable.base<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> containFalsum<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="free">Γ</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span>  b<span class="main">:</span> <span class="quoted"><span class="quoted">"Ax <span class="main">⊆</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⊕</span> ff"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> extend_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> extRules.I<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span><span class="main">]</span> 
      <span class="keyword2"><span class="keyword">and</span></span> extendRule_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> forms<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊖</span> ff <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span>  <span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> derivable.base<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="comment1">(* Lemma which says that if r is an identity rule, then r is of the form
   ([], P ⇒* P) *)</span>
<span class="keyword1"><span class="command">lemma</span></span> characteriseAx<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax <span class="main">⟹</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="bound">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="bound">i</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* A lemma about the last rule used in a derivation, i.e. that one exists *)</span>
<span class="keyword1"><span class="command">lemma</span></span> characteriseLast<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C</span><span class="main">,</span><span class="free">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Ps</span><span class="main">.</span> <span class="bound">Ps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
             <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> 
             <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="bound">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>


<span class="comment1">(* Lemma which says that if rule is an upRule, then the succedent is either empty, or a single formula *)</span>
<span class="keyword1"><span class="command">lemma</span></span> succ_upRule<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">Φ</span> <span class="main">⇒*</span> <span class="free">Ψ</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ψ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">Ψ</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">R</span> <span class="skolem">Rs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ψ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">Ψ</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset.simps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ant<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Φ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> suc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ψ</span></span><span class="main">]</span> 
         <span class="keyword2"><span class="keyword">and</span></span> union_is_single<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Φ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ψ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Compound <span class="skolem">R</span> <span class="skolem">Rs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">elim</span> disjE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Equivalent, but the antecedent *)</span>
<span class="keyword1"><span class="command">lemma</span></span> antec_upRule<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">Φ</span> <span class="main">⇒*</span> <span class="free">Ψ</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">Φ</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">R</span> <span class="skolem">Rs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">=</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="free">Φ</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span><span class="bound">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset.simps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ant<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Φ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> suc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ψ</span></span><span class="main">]</span> 
         <span class="keyword2"><span class="keyword">and</span></span> union_is_single<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Φ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Ψ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Compound <span class="skolem">R</span> <span class="skolem">Rs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">elim</span> disjE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upRule_Size<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"seq_size <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">R</span> <span class="skolem">Rs</span><span class="main">)</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">+</span> <span class="skolem">H</span> <span class="main">=</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">R</span> <span class="skolem">Rs</span><span class="main">\&lt;RM&gt;</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset.simps <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹mset <span class="skolem">C</span> <span class="main">≡</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">R</span> <span class="skolem">Rs</span><span class="main">\&lt;RM&gt;</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">G</span><span class="main">+</span><span class="skolem">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">G</span> <span class="main">+</span> size <span class="skolem">H</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"seq_size <span class="skolem">C</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq_size.simps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ant<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> suc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">H</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">⇒*</span> <span class="skolem">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">r</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"seq_size <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upRuleCharacterise<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">F</span> <span class="bound">Fs</span><span class="main">.</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ</span></span> <span class="skolem"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> characteriseSeq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">F</span> <span class="bound">Fs</span><span class="main">.</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>Compound <span class="bound">F</span> <span class="bound">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹mset <span class="free">C</span> <span class="main">≡</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>›</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mset.simps<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ant<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> suc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> union_is_single<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> N<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Compound <span class="skolem">F</span> <span class="skolem">Fs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extendEmpty<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extend <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> extendContain<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="free">S</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="free">p</span> <span class="main">∈</span> set <span class="free">Ps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> set <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">S</span> <span class="free">p</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="free">S</span> <span class="free">r</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">ps</span> <span class="main">=</span> <span class="free">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span> 
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonPrincipalID<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> form"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> r1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> ff <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span> <span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rightPrincipal <span class="free">r</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> r2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span> <span class="free">A</span> <span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> r1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rightPrincipal <span class="free">r</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span>
<span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"leftPrincipal <span class="free">r</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps'</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">Fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> r3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps'</span><span class="main">,</span> <span class="main">\&lt;LM&gt;</span>Compound <span class="skolem">F</span> <span class="skolem">Fs</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> r1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leftPrincipal <span class="free">r</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extendCommute<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="main">(</span>extend <span class="free">R</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>extend <span class="free">R</span><span class="main">)</span> <span class="main">(</span>extend <span class="free">S</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mapCommute<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>extend <span class="free">R</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="free">R</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendCommute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extendAssoc<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="main">(</span>extend <span class="free">R</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> extend <span class="main">(</span>extend <span class="free">S</span> <span class="free">R</span><span class="main">)</span> <span class="free">c</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mapAssoc<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>extend <span class="free">S</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>extend <span class="free">R</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>extend <span class="main">(</span>extend <span class="free">S</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendAssoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extended_Ax_prems_empty<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>extendRule <span class="free">S</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">lastRule</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> deriv <span class="main">⇒</span> <span class="tfree">'a</span> rule <span class="main">⇒</span> <span class="tfree">'a</span> rule set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  base<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> Ax<span class="main">;</span> Ax <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">;</span> snd <span class="main">(</span>extendRule <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⇒*</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span><span class="main">⟧</span>
                 <span class="main">⟹</span> <span class="free">lastRule</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⇒*</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>
<span class="main">|</span>    I<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∉</span> Ax <span class="main">;</span> snd <span class="main">(</span>extendRule <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⇒*</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span> <span class="main">;</span> 
                <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">*</span> <span class="main">⟧</span> 
                 <span class="main">⟹</span> <span class="free">lastRule</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⇒*</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> obv<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free">a</span><span class="main">,</span> snd <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> getLast<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lastRule <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">r</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span> <span class="bound">Ps</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Ps</span><span class="main">,</span> <span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="bound">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">∉</span> Ax"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lastRule.cases<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="main">(</span>extendRule <span class="improper">S</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"extendRule <span class="improper">S</span> <span class="main">(</span><span class="improper">a</span><span class="main">,</span><span class="improper">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="improper">S</span> <span class="main">(</span><span class="improper">a</span><span class="main">,</span><span class="improper">b</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>snd <span class="main">(</span>extendRule <span class="improper">S</span> <span class="main">(</span><span class="improper">a</span><span class="main">,</span><span class="improper">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> obv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> getAx<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lastRule <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="free">r</span> <span class="free">R</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">S</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">S</span><span class="main">.</span> snd <span class="main">(</span>extendRule <span class="bound">S</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lastRule.cases<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> Ax"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>extendRule <span class="skolem">S</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> Ax›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">r</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>extendRule <span class="skolem">S</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹snd <span class="main">(</span>extendRule <span class="skolem">S</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> Ax›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> 
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="skolem">S</span> <span class="free">r</span><span class="main">)</span><span class="main">,</span>snd <span class="main">(</span>extendRule <span class="skolem">S</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> obv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(* Has the usual set-up: takes a subset of the upRules, combines with all the axioms, blah blah *)</span>


<span class="comment1">(* Constructing the rule set we will use.  It contains all axioms, but only a subset
   of the possible logical rules. *)</span>
<span class="keyword1"><span class="command">lemma</span></span> ruleSet<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">⊆</span> upRules"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span> <span class="bound">r</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">R'</span> <span class="main">∨</span> <span class="bound">r</span> <span class="main">∈</span> Ax<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span> <span class="bound">r</span><span class="main">.</span> extendRule <span class="bound">S</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ps</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> extendRule <span class="skolem">S</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dpWeak<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⇒*</span> <span class="free">Δ</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span>  b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">⊆</span> upRules"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span>  c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R'</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> a
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_less_induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">Γ</span> <span class="skolem">Δ</span><span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">Γ</span> <span class="bound">Δ</span><span class="main">.</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">⇒*</span> <span class="bound">Δ</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span> <span class="main">⟶</span> <span class="main">(</span> <span class="bound">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> 0
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span>  <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> split<span class="main">:</span><span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extRules.cases<span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command">using</span></span> b c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> Ax"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> upRules.cases<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>                                 
 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> characteriseAx<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span><span class="main">\&lt;LM&gt;</span>At <span class="skolem">i</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">∧</span> At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extendID <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">∧</span> At <span class="skolem">i</span> <span class="main">∈#</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> c <span class="keyword2"><span class="keyword">and</span></span> containID<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">+</span><span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span><span class="main">+</span><span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
 <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span>ff<span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span><span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extendFalsum <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ff <span class="main">∈#</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> c <span class="keyword2"><span class="keyword">and</span></span> containFalsum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">+</span><span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Δ</span><span class="main">+</span><span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> 
                  <span class="keyword2"><span class="keyword">and</span></span> h<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> characteriseLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> g c <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R'</span><span class="main">)</span> <span class="main">∧</span> extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">with</span></span> b <span class="keyword1"><span class="command">have</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span> <span class="main">∈</span> Ax <span class="main">∨</span> <span class="skolem">r</span> <span class="main">∈</span> upRules<span class="main">)</span> <span class="main">∧</span> extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="main">⇒*</span> <span class="skolem">Δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span><span class="quoted"><span class="quoted">"map <span class="main">(</span>extend <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ps</span> <span class="main">=</span> fst <span class="main">(</span>extendRule <span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> mapCommute<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">Γ'</span><span class="main">⇒*</span><span class="free">Δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="skolem">r</span>"</span></span><span class="main">]</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def mapAssoc <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_map<span class="main">)</span>
 <span class="keyword1"><span class="command">from</span></span> as <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>extendRule <span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def extend_def union_ac<span class="main">)</span>
 <span class="keyword1"><span class="command">from</span></span> as f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def map_is_Nil_conv<span class="main">)</span>
 <span class="keyword1"><span class="command">with</span></span> as <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> upRules"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ax.cases<span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>extend <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ps</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
       <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>extend <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Ps</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> set <span class="skolem">Ps</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">=</span> extend <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">with</span></span> h <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p'</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="skolem"><span class="skolem">Ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p'</span></span><span class="main">)</span> <span class="operator">auto</span> 
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Φ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Ψ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="operator">-</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p'</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
            <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> upRules›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extendRule <span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span><span class="free">Γ'</span> <span class="main">⇒*</span> <span class="free">Δ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">n'</span>"</span></span><span class="main">]</span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>map_is_Nil_conv extendRule_def<span class="main">)</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="skolem">Γ</span> <span class="main">+</span> <span class="free">Γ'</span> <span class="main">⇒*</span> <span class="skolem">Δ</span> <span class="main">+</span> <span class="free">Δ'</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\section{Manipulating Rule Sets \label{isaSRC}}
The removal of superfluous and redundant rules \cite{AL01} will not be harmful to invertibility: removing rules means that the conditions of earlier sections are more likely to be fulfilled.  Here, we formalise the results that the removal of such rules from a calculus $\mathcal{L}$ will create a new calculus $\mathcal{L}'$ which is equivalent.  In other words, if a sequent is derivable in $\mathcal{L}$, then it is derivable in $\mathcal{L}'$.
The results formalised in this section are for \SC multisuccedent calculi.

When dealing with lists of premisses, a rule $R$ with premisses $P$ will be redundant given a rule $R'$ with premisses $P'$ if there exists some $p$ such that $P = p \# P'$.  There are other ways in which a rule could be redundant; say if $P = Q @ P'$, or if $P = P' @ Q$, and so on.  The order of the premisses is not really important, since the formalisation operates on the finite set based upon the list.  The more general ``append'' lemma could be proved from the lemma we give; we prove the inductive step case in the proof of such an append lemma.  This is a height preserving transformation.  Some of the proof is shown:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> removeRedundant<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="comment1">(*&lt;*)</span>a<span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="free">r1</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">#</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r1</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>     <span class="comment1">(*&lt;*)</span>b<span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="free">r2</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r2</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>     <span class="comment1">(*&lt;*)</span>c<span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>     <span class="comment1">(*&lt;*)</span>d<span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">T</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">T</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
 <span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="comment1">(*&lt;*)</span><span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T</span></span> <span class="comment1">(*&gt;*)</span><span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_less_induct<span class="main">)</span>
 <span class="comment1">(*&lt;*)</span><span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">r1</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r1</span> <span class="main">∈</span> upRules <span class="main">⟶</span>
                         <span class="free">r2</span> <span class="main">=</span> <span class="main">(</span><span class="free">ps</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r2</span> <span class="main">∈</span> upRules <span class="main">⟶</span>
                         <span class="free">R1</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">⟶</span> 
                         <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span> <span class="main">⟶</span> 
                         <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
             prm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="comment1">(*&gt;*)</span>
 <span class="keyword3"><span class="command">case</span></span> 0
  <span class="comment1">(*&lt;*)</span> <span class="keyword1"><span class="command">with</span></span> prm <span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> ext<span class="main">:</span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extRules.cases<span class="main">)</span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">r1</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">r2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹\noindent It cannot be the case that $r=r_{1}$ or $r=r_{2}$, since those are \SC rules, whereas anything with an empty set of premisses
must be an axiom.  Since $\mathcal{R}$ contains the set of axioms, so will $\mathcal{R} \cup r_{2}$:›</span></span>
 <span class="comment1">(*&lt;*)</span>   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ext <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span> 
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">r2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c a ext <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span> <span class="comment1">(*&gt;*)</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="comment1">(*&lt;*)</span>  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span>›</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> extRules.I<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(*&gt;*)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
 <span class="comment1">(*&lt;*)</span> <span class="keyword1"><span class="command">with</span></span> prm <span class="comment1">(*&gt;*)</span><span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
         <span class="keyword2"><span class="keyword">and</span></span>   f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
         <span class="keyword2"><span class="keyword">and</span></span>   g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
        <span class="comment1">(*&lt;*)</span> <span class="keyword1"><span class="command">using</span></span> characteriseLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span><span class="main">]</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> g'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
  <span class="comment1">(*&lt;*)</span>       <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
              <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span>
               <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> set <span class="skolem">Ps</span>"</span></span>
               <span class="keyword1"><span class="command">with</span></span> g <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
               <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m'</span></span><span class="main">≤</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="skolem">P</span><span class="main">,</span><span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a b c <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
               <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">P</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">≤</span><span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">}</span></span> 
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">qed</span></span>  <span class="comment1">(*&gt;*)</span>             
   <span class="keyword1"><span class="command">from</span></span> f <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> ext<span class="main">:</span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extRules.cases<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">r1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹\noindent Either $r$ is in the new rule set or $r$ is the redundant rule.  In the former case, there is nothing to do:›</span></span>
 <span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="comment1">(*&gt;*)</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command">using</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> extRules.I<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">with</span></span> g' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="comment1">(*&lt;*)</span><span class="keyword2"><span class="keyword">and</span></span> e <span class="keyword2"><span class="keyword">and</span></span>
       derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span><span class="comment1">(*&gt;*)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="comment1">(*&lt;*)</span> <span class="keyword1"><span class="command">}</span></span>
 <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">{</span></span> <span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹\noindent In the latter case, the last inference was redundant.  Therefore the premisses, which are derivable at a lower height than the conclusion, 
contain the premisses of $r_{2}$ (these premisses are \texttt{extend S ps}).  This completes the proof:›</span></span>
     <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">r1</span>"</span></span> 
     <span class="keyword1"><span class="command">with</span></span> ext <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="comment1">(*&lt;*)</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="comment1">(*&gt;*)</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">#</span><span class="free">ps</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
                   <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> g' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span><span class="main">.</span> 
                      <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

 <span class="comment1">(*&lt;*)</span>    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="free">r2</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="free">ps</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword2"><span class="keyword">and</span></span> a <span class="keyword2"><span class="keyword">and</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="free">r1</span>›</span></span> 
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="free">ps</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extRules.I<span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span><span class="comment1">(*&gt;*)</span>
               <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="free">ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">moreover</span></span>
       <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
         <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="free">ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> i <span class="keyword2"><span class="keyword">and</span></span> h <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="free">ps</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent Recall that to remove superfluous rules, we must know that Cut is admissible in the original calculus \cite{AL01}.  Again, we add the two distinguished premisses at the head of the premiss list; general results about permutation of lists will achieve a more general result.  Since one uses Cut in the proof, this will in general not be height-preserving:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> removeSuperfluous<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="comment1">(*&lt;*)</span>a<span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="free">r1</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r1</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>     <span class="comment1">(*&lt;*)</span>b<span class="main">:</span><span class="comment1">(*&gt;*)</span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">T</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>     CA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">Γ</span> <span class="bound">Δ</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">Γ</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">⊕</span> <span class="bound">A</span><span class="main">)</span> <span class="main">∈</span> derivable' <span class="free">R</span><span class="main">*</span> <span class="main">⟶</span> 
             <span class="main">(</span><span class="bound">Γ</span> <span class="main">⊕</span> <span class="bound">A</span> <span class="main">⇒*</span> <span class="bound">Δ</span><span class="main">)</span> <span class="main">∈</span> derivable' <span class="free">R</span><span class="main">*</span><span class="main">)</span> <span class="main">⟶</span>
             <span class="main">(</span><span class="bound">Γ</span> <span class="main">⇒*</span> <span class="bound">Δ</span><span class="main">)</span> <span class="main">∈</span> derivable' <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">∈</span> derivable' <span class="free">R</span><span class="main">*</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="free">r1</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span> <span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span> <span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r1</span> <span class="main">∈</span> upRules <span class="main">⟶</span>
    <span class="free">R1</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">T</span><span class="main">.</span> <span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span><span class="main">)</span><span class="main">*</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">Γ</span> <span class="bound">Δ</span> <span class="bound">B</span><span class="main">.</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">Γ</span> <span class="main">⇒*</span> <span class="bound">Δ</span> <span class="main">⊕</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∈</span> derivable' <span class="free">R</span><span class="main">*</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">Γ</span> <span class="main">⊕</span> <span class="bound">B</span> <span class="main">⇒*</span> <span class="bound">Δ</span><span class="main">)</span> <span class="main">∈</span> derivable' <span class="free">R</span><span class="main">*</span><span class="main">)</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="bound">Γ</span> <span class="main">⇒*</span> <span class="bound">Δ</span><span class="main">)</span> <span class="main">∈</span> derivable' <span class="free">R</span><span class="main">*</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="bound">T</span> <span class="main">∈</span> derivable' <span class="free">R</span><span class="main">*</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> prm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">with</span></span> prm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> derivable.cases<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> ext<span class="main">:</span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extRules.cases<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">r1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ext <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> extRules.I<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∈</span> derivable' <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> prm <span class="keyword1"><span class="command">have</span></span> prm'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>   ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> characteriseLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> derivable' <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a b <span class="keyword2"><span class="keyword">and</span></span> prm' <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">m</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> CA<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> b<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> ex <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> ext<span class="main">:</span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extRules.cases<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">r1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> ext <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extRules.I<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> e <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∈</span> derivable' <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword2"><span class="keyword">and</span></span>
        derivable'.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">*</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">r1</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> e <span class="keyword2"><span class="keyword">and</span></span> a <span class="keyword2"><span class="keyword">and</span></span> ext <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;Empt&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> derivable' <span class="free">R</span><span class="main">*</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span><span class="main">\&lt;Empt&gt;</span> <span class="main">⇒*</span> <span class="main">\&lt;LM&gt;</span><span class="free">A</span><span class="main">\&lt;RM&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> derivable' <span class="free">R</span><span class="main">*</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> derivable' <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> CA <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">S</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> deriv_to_deriv2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>extend <span class="skolem">S</span> <span class="free">c</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> dpWeak<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">R1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="skolem">S</span>"</span></span>
          <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> b
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> ext <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="free">r1</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∈</span> derivable' <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∈</span> derivable' <span class="free">R</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\noindent \textit{Combinable rules} can also be removed.  We encapsulate the combinable criterion by saying that if $(p \# P,T)$ and $(q \# P, T)$ are rules in a calculus, then we get an equivalent calculus by replacing these two rules by $((\textrm{extend } p \ q) \# P, T)$.  Since the \texttt{extend} function is commutative, the order of $p$ and $q$ in the new rule is not important.  This transformation is height preserving:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> removeCombinable<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r1</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r1</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>     b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r2</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r2</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>     c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r3</span> <span class="main">=</span> <span class="main">(</span>extend <span class="free">p</span> <span class="free">q</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r3</span> <span class="main">∈</span> upRules"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>     d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">T</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">T</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nat_less_induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">T</span><span class="main">.</span> <span class="main">(</span><span class="free">r1</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r1</span> <span class="main">∈</span> upRules <span class="main">⟶</span>
                               <span class="free">r2</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r2</span> <span class="main">∈</span> upRules <span class="main">⟶</span>
                               <span class="free">r3</span> <span class="main">=</span> <span class="main">(</span>extend <span class="free">p</span> <span class="free">q</span> <span class="main">#</span> <span class="free">ps</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r3</span> <span class="main">∈</span> upRules <span class="main">⟶</span>
                               <span class="free">R1</span> <span class="main">⊆</span> upRules <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> Ax <span class="main">∪</span> <span class="free">R1</span> <span class="main">⟶</span> 
                              <span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span> <span class="main">⟶</span> 
                              <span class="main">(</span><span class="bound">T</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
             prm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword1"><span class="command">with</span></span> prm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> derivable.cases<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> ext<span class="main">:</span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extRules.cases<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">r1</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">r2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> a <span class="keyword2"><span class="keyword">and</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> ext <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extRules.I<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> prm <span class="keyword1"><span class="command">have</span></span> prm'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                       <span class="keyword2"><span class="keyword">and</span></span>   ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
                       <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
             <span class="keyword1"><span class="command">using</span></span> characteriseLast<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="skolem">Ps</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a b c d <span class="keyword2"><span class="keyword">and</span></span> prm' <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Ball_def<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> ex <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> ext<span class="main">:</span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r2</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extRules.cases<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">r1</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">r2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span>
           <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">with</span></span> ext <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extRules.I<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> seq<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> e <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword2"><span class="keyword">and</span></span>
                 derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ps</span><span class="main">,</span><span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
           <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">r1</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> e <span class="keyword2"><span class="keyword">and</span></span> a <span class="keyword2"><span class="keyword">and</span></span> ext <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="skolem">S</span> <span class="free">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span>extend <span class="free">q</span> <span class="free">p</span><span class="main">)</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> 
                 <span class="keyword1"><span class="command">using</span></span> dpWeak<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="skolem">S</span> <span class="main">+</span> antec <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="skolem">S</span> <span class="main">+</span> succ <span class="free">p</span>"</span></span>
                              <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="free">q</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> d c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> e <span class="keyword2"><span class="keyword">and</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="free">r1</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> a
                 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span>extend <span class="free">q</span> <span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extend <span class="free">q</span> <span class="free">p</span> <span class="main">=</span> extend <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> pm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="skolem">S</span> <span class="free">r3</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> a <span class="keyword2"><span class="keyword">and</span></span> c <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="free">r1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> con<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>extendRule <span class="skolem">S</span> <span class="free">r3</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r3</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="free">r3</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> pm <span class="keyword2"><span class="keyword">and</span></span> con <span class="keyword2"><span class="keyword">and</span></span> c <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="free">r3</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
           <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
           <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">r2</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> e <span class="keyword2"><span class="keyword">and</span></span> b <span class="keyword2"><span class="keyword">and</span></span> ext <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="skolem">S</span> <span class="free">q</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span>extend <span class="skolem">S</span> <span class="main">(</span>extend <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> 
                 <span class="keyword1"><span class="command">using</span></span> dpWeak<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="skolem">S</span> <span class="main">+</span> antec <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="skolem">S</span> <span class="main">+</span> succ <span class="free">q</span>"</span></span>
                              <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"antec <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"succ <span class="free">p</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> d c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extend_def union_ac<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> e <span class="keyword2"><span class="keyword">and</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="free">r2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> b
                 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>extend <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span>extend <span class="free">p</span> <span class="free">q</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">P</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>extendRule <span class="skolem">S</span> <span class="free">r3</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="skolem">n'</span><span class="main">.</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> ext <span class="keyword2"><span class="keyword">and</span></span> b <span class="keyword2"><span class="keyword">and</span></span> c <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="free">r2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> con<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>extendRule <span class="skolem">S</span> <span class="free">r3</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r3</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="free">r3</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> pm <span class="keyword2"><span class="keyword">and</span></span> con <span class="keyword2"><span class="keyword">and</span></span> c <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> derivable.step<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"extendRule <span class="skolem">S</span> <span class="free">r3</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>extendRule_def<span class="main">)</span>
           <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> derivable <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="main">{</span><span class="free">r3</span><span class="main">}</span><span class="main">)</span><span class="main">*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\section{Conclusions}

Only a portion of the formalisation was shown; a variety of intermediate lemmata were not made explicit.  This was necessary, for the \textit{Isabelle} theory files run to almost 8000 lines.  However, these files do not have to be replicated for each new calculus.  It takes very little effort to define a new calculus.  Furthermore, proving invertibility is now a quick process; less than 25 lines of proof in most cases.  
›</span></span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span><span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="SequentInvertibility">
<div class="head">
<h1>Theory SequentInvertibility</h1>
</div>
<pre class="source"><span class="comment1">(* License: LGPL *)</span>

<span class="keyword1"><span class="command">theory</span></span> SequentInvertibility
<span class="keyword2"><span class="keyword">imports</span></span> <a href="MultiSequents.html">MultiSequents</a> <a href="SingleSuccedent.html">SingleSuccedent</a> <a href="NominalSequents.html">NominalSequents</a> <a href="ModalSequents.html">ModalSequents</a> <a href="SRCTransforms.html">SRCTransforms</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>