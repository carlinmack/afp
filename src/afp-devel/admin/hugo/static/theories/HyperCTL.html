<div id="Prelim">
<div class="head">
<h1>Theory Prelim</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Prelim
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Stream.html">HOL-Library.Stream</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">any</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">any</span> <span class="main">≡</span> undefined"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> append_singl_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">#</span> <span class="free">as</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> list_pair_induct<span class="main">[</span><span class="operator">case_names</span> Nil Cons<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">list</span><span class="main">.</span> <span class="free">P</span> <span class="bound">list</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">#</span> <span class="bound">list</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">lista</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">lista</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> list_pair_case<span class="main">[</span><span class="operator">elim</span><span class="main">,</span> <span class="operator">case_names</span> Nil Cons<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">list</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">#</span> <span class="bound">list</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">asList</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">asList</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">as</span><span class="main">.</span> distinct <span class="bound">as</span> <span class="main">∧</span> set <span class="bound">as</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> asList<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>asList <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> set <span class="main">(</span>asList <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> asList_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> assms finite_distinct_list<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> distinct_asList <span class="main">=</span> asList<span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> set_asList <span class="main">=</span> asList<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> map_sdrop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sdrop <span class="main">0</span> <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> stl_o_sdrop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stl <span class="keyword1">o</span> sdrop <span class="free">n</span> <span class="main">=</span> sdrop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sdrop_o_stl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sdrop <span class="free">n</span> <span class="keyword1">o</span> stl <span class="main">=</span> sdrop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hd_stake<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> hd <span class="main">(</span>stake <span class="free">i</span> <span class="free">π</span><span class="main">)</span> <span class="main">=</span> shd <span class="free">π</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>



<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Shallow">
<div class="head">
<h1>Theory Shallow</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Shallow embedding of HyperCTL*›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Shallow
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Prelim.html">Prelim</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We define a notion of ``shallow'' HyperCTL* formula (sfmla) that captures
HyperCTL* binders as meta-level HOL binders. We also define a proof system for this
shallow embedding.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Kripke structures and paths›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> path <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'aprop</span> set<span class="main">)</span> stream"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">stateOf</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">stateOf</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">apropsOf</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">apropsOf</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">≡</span> snd <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Kripke <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">s0</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'state</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">AP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'aprop</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'aprop</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s0</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> δ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> L <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">L</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">AP</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Well-formed paths›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">wfp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'aprop</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> path <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">for</span></span> <span class="entity">AP'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'aprop</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
intro<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊆</span> <span class="free">AP'</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∩</span> <span class="free">AP</span> <span class="main">=</span> <span class="free">L</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> stateOf <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">∈</span> <span class="free">δ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> <span class="free">wfp</span> <span class="free">AP'</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">⟧</span>
 <span class="main">⟹</span>
 <span class="free">wfp</span> <span class="free">AP'</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wfp<span class="main">:</span>
<span class="quoted"><span class="quoted">"wfp <span class="free">AP'</span> <span class="free">π</span> <span class="main">⟷</span>
 <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">AP'</span> <span class="main">∧</span>
       snd <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∩</span> <span class="free">AP</span> <span class="main">=</span> <span class="free">L</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
       fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">δ</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
 <span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?R</span> <span class="bound">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffI allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">π</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> snth.simps fst_conv snd_conv stream.sel wfp.cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?R</span> <span class="bound">i</span>"</span></span>  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> s0 fst_conv snd_conv snth.simps stream.sel 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inf_commute stream.collapse surj_pair<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wfp_sdrop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"wfp <span class="free">AP'</span> <span class="free">π</span> <span class="main">⟹</span> wfp <span class="free">AP'</span> <span class="main">(</span>sdrop <span class="free">i</span> <span class="free">π</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> wfp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> sdrop_add sdrop_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context Kripke *)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹end-of-context Kripke›</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Shallow representations of formulas›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A shallow (representation of a) HyperCTL* formula will be a predicate on lists of paths.  
The atomic formulas (operator $\textit{atom}$) are parameterized by atomic propositions (as customary in temporal logic), 
and additionally by a number indicating the position, in the list of paths, of the path to which the atomic proposition 
refers -- for example, $\textit{atom}\;a\;i$ holds for the list of paths $\pi l$ just in case proposition $a$ holds 
at the first state of $\pi l!i$, the $i$'th path in $\pi l$.  The temporal operators $\textit{next}$ and $\textit{until}$ act on all the paths of the argument 
list $\pi l$ synchronously.  Finally, the existential quantifier refers to the existence of a path whose origin state is that of 
the last path in $\pi l$.  

As an example: $\textit{exi}\; (\textit{exi}\; (\textit{until}\; (\textit{atom}\;a\;0)\;(\textit{atom}\;b\;1)))$ holds for the empty list 
iff there exist two paths $\rho_0$ and $\rho_1$ such that, synchronously,  
$a$ holds on $\rho_0$ until $b$ holds on $\rho_1$.  Another example will be the formula encoding Goguen-Meseguer noninterference.   
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Shallow HyperCTL* formulas:›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> path list <span class="main">⇒</span> bool"</span></span>


<span class="keyword1"><span class="command">locale</span></span> Shallow <span class="main">=</span> Kripke <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="quoted">"<span class="free">s0</span>"</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">AP</span></span> <span class="quoted"><span class="free">L</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">s0</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'state</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">AP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'aprop</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'aprop</span> set"</span></span>
<span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">AP'</span> <span class="keyword2"><span class="keyword">assumes</span></span> AP_AP'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AP</span> <span class="main">⊆</span> <span class="free">AP'</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Primitive operators›</span></span>

<span class="comment1">(* I include false as a primitive since otherwise I would have to assume nonemptyness of
  the atomic propositions *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fls</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">fls</span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span> <span class="main">≡</span> False"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">atom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'aprop</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">atom</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> apropsOf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">πl</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">neg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">neg</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span> <span class="main">≡</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dis</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">dis</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">next</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">next</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>map stl <span class="free"><span class="bound"><span class="entity">πl</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">until</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">until</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span> <span class="main">≡</span>
 <span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="bound">i</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">j</span> <span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">i</span><span class="main">}</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="bound">j</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">exii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exii</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span> <span class="main">≡</span>
 <span class="main">∃</span> <span class="bound">π</span><span class="main">.</span> wfp <span class="free">AP'</span> <span class="bound">π</span> <span class="main">∧</span> stateOf <span class="bound">π</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="keyword1">then</span> stateOf <span class="main">(</span>last <span class="free"><span class="bound"><span class="entity">πl</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">s0</span><span class="main">)</span>
      <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">πl</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="bound">π</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">exi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> path <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exi</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span> <span class="main">≡</span>
 <span class="main">∃</span> <span class="bound">π</span><span class="main">.</span> wfp <span class="free">AP'</span> <span class="bound">π</span> <span class="main">∧</span> stateOf <span class="bound">π</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="keyword1">then</span> stateOf <span class="main">(</span>last <span class="free"><span class="bound"><span class="entity">πl</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">s0</span><span class="main">)</span>
      <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">π</span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Derived operators›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">tr</span> <span class="main">≡</span> neg fls"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">con</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> neg <span class="main">(</span>dis <span class="main">(</span>neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>neg <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">imp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> dis <span class="main">(</span>neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eq</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> con <span class="main">(</span>imp <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>imp <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> "</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fall</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span> neg <span class="main">(</span>exi <span class="main">(</span><span class="main">λ</span> <span class="bound">π</span><span class="main">.</span> neg <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">π</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> until tr <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">alw</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> neg <span class="main">(</span>ev <span class="main">(</span>neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">wuntil</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> dis <span class="main">(</span>until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>alw <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> main_op_defs <span class="main">=</span>
fls_def atom_def neg_def dis_def next_def until_def exi_def

<span class="keyword1"><span class="command">lemmas</span></span> der_op_defs <span class="main">=</span>
tr_def con_def imp_def eq_def ev_def alw_def wuntil_def fall_def

<span class="keyword1"><span class="command">lemmas</span></span> op_defs <span class="main">=</span> main_op_defs der_op_defs


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Reasoning rules›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We provide introduction, elimination, unfolding and (co)induction rules
for the connectives and quantifiers.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Boolean operators›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fls_elim<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fls <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">φ</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> tr_intro<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tr <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> dis_introL<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dis <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> dis_introR<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dis <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> dis_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dis <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free">πl</span> <span class="main">⟹</span> <span class="free">χ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="free">πl</span> <span class="main">⟹</span> <span class="free">χ</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">χ</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> con_intro<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"con <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> con_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"con <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free">πl</span> <span class="main">⟹</span> <span class="free">ψ</span> <span class="free">πl</span> <span class="main">⟹</span> <span class="free">χ</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">χ</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> neg_intro<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free">πl</span> <span class="main">⟹</span> False"</span></span>  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"neg <span class="free">φ</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> neg_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"neg <span class="free">φ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free">πl</span>"</span></span>  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">χ</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> imp_intro<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free">πl</span> <span class="main">⟹</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span>  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"imp <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> imp_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"imp <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="free">πl</span> <span class="main">⟹</span> <span class="free">χ</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">χ</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> imp_mp<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"imp <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_intro<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free">πl</span> <span class="main">⟹</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="free">πl</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_elimL<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eq <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="free">πl</span> <span class="main">⟹</span> <span class="free">χ</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">χ</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_elimR<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eq <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free">πl</span> <span class="main">⟹</span> <span class="free">χ</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">χ</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_equals<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span> <span class="main">⟷</span> <span class="free">φ</span> <span class="free">πl</span> <span class="main">=</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_elimL eq_elimR eq_intro<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Quantifiers›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exi_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wfp <span class="free">AP'</span> <span class="free">π</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">πl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> stateOf <span class="free">π</span> <span class="main">=</span> stateOf <span class="main">(</span>last <span class="free">πl</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">πl</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> stateOf <span class="free">π</span> <span class="main">=</span> <span class="free">s0</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free">π</span> <span class="free">πl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"exi <span class="free">F</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> exi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> exi_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exi <span class="free">F</span> <span class="free">πl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">π</span><span class="main">.</span> <span class="main">⟦</span>wfp <span class="free">AP'</span> <span class="bound">π</span><span class="main">;</span> <span class="free">πl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> stateOf <span class="bound">π</span> <span class="main">=</span> stateOf <span class="main">(</span>last <span class="free">πl</span><span class="main">)</span><span class="main">;</span> <span class="free">πl</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> stateOf <span class="bound">π</span> <span class="main">=</span> <span class="free">s0</span><span class="main">;</span> <span class="free">F</span> <span class="bound">π</span> <span class="free">πl</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">χ</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">χ</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> exi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fall_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">π</span><span class="main">.</span> <span class="main">⟦</span>wfp <span class="free">AP'</span> <span class="bound">π</span><span class="main">;</span> <span class="free">πl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> stateOf <span class="bound">π</span> <span class="main">=</span> stateOf <span class="main">(</span>last <span class="free">πl</span><span class="main">)</span> <span class="main">;</span> <span class="free">πl</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> stateOf <span class="bound">π</span> <span class="main">=</span> <span class="free">s0</span><span class="main">⟧</span>
       <span class="main">⟹</span>  <span class="free">F</span> <span class="bound">π</span> <span class="free">πl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fall <span class="free">F</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fall_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exi_def neg_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fall_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fall <span class="free">F</span> <span class="free">πl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">π</span><span class="main">.</span> <span class="main">⟦</span>wfp <span class="free">AP'</span> <span class="bound">π</span><span class="main">;</span> <span class="free">πl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> stateOf <span class="bound">π</span> <span class="main">=</span> stateOf <span class="main">(</span>last <span class="free">πl</span><span class="main">)</span><span class="main">;</span> <span class="free">πl</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> stateOf <span class="bound">π</span> <span class="main">=</span> <span class="free">s0</span><span class="main">⟧</span>
        <span class="main">⟹</span> <span class="free">F</span> <span class="bound">π</span> <span class="free">πl</span><span class="main">)</span>
  <span class="main">⟹</span> <span class="free">χ</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">χ</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fall_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exi_def neg_elim neg_intro<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Temporal connectives›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">(</span>map stl <span class="free">πl</span><span class="main">)</span>"</span></span>  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"next <span class="free">φ</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> next_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next <span class="free">φ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">(</span>map stl <span class="free">πl</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">χ</span>"</span></span>  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">χ</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> until_introR<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"until <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> until_introL<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"until <span class="free">φ</span> <span class="free">ψ</span> <span class="main">(</span>map stl <span class="free">πl</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"until <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">πl</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="free">πl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> u <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">i</span><span class="main">}</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="skolem">j</span><span class="main">)</span> <span class="free">πl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 φ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ψ <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The elimination rules for until and eventually are induction rules.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> until_induct<span class="main">[</span><span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword">pred</span></span><span class="main"><span class="main"><span class="main">:</span></span></span> until<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Base Step<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"until <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">πl</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">πl</span> <span class="main">⟹</span> <span class="free">χ</span> <span class="bound">πl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">πl</span><span class="main">.</span> <span class="main">⟦</span><span class="free">φ</span> <span class="bound">πl</span><span class="main">;</span> until <span class="free">φ</span> <span class="free">ψ</span> <span class="main">(</span>map stl <span class="bound">πl</span><span class="main">)</span><span class="main">;</span> <span class="free">χ</span> <span class="main">(</span>map stl <span class="bound">πl</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">χ</span> <span class="bound">πl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="skolem">i</span><span class="main">)</span> <span class="free">πl</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="bound">j</span><span class="main">)</span> <span class="free">πl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> u <span class="keyword1"><span class="command">unfolding</span></span> until_def next_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"until <span class="free">φ</span> <span class="free">ψ</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="skolem">k</span><span class="main">)</span> <span class="free">πl</span><span class="main">)</span> <span class="main">∧</span> <span class="free">χ</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="skolem">k</span><span class="main">)</span> <span class="free">πl</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">-</span><span class="skolem">k</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">=</span><span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">with</span></span> b<span class="main">[</span><span class="operator">OF</span> ψ<span class="main">]</span> u ψ <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> until_introR<span class="main">)</span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?πl'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>sdrop <span class="skolem">k</span><span class="main">)</span> <span class="free">πl</span>"</span></span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"until <span class="free">φ</span> <span class="free">ψ</span>  <span class="main">(</span>map stl <span class="var">?πl'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">χ</span> <span class="main">(</span>map stl <span class="var">?πl'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="var">?πl'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> until_unfold<span class="main">:</span>
<span class="quoted"><span class="quoted">"until <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span> <span class="main">=</span> <span class="main">(</span><span class="free">ψ</span> <span class="free">πl</span> <span class="main">∨</span> <span class="free">φ</span> <span class="free">πl</span> <span class="main">∧</span> until <span class="free">φ</span> <span class="free">ψ</span> <span class="main">(</span>map stl <span class="free">πl</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ev_introR<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ev <span class="free">φ</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ev_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> until_introR<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ev_introL<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ev <span class="free">φ</span> <span class="main">(</span>map stl <span class="free">πl</span><span class="main">)</span>"</span></span>  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ev <span class="free">φ</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ev_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> until_introL<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ev_induct<span class="main">[</span><span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword">pred</span></span><span class="main"><span class="main"><span class="main">:</span></span></span> ev<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Base Step<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ev <span class="free">φ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">πl</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">πl</span> <span class="main">⟹</span> <span class="free">χ</span> <span class="bound">πl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">πl</span><span class="main">.</span> <span class="main">⟦</span>ev <span class="free">φ</span> <span class="main">(</span>map stl <span class="bound">πl</span><span class="main">)</span><span class="main">;</span> <span class="free">χ</span> <span class="main">(</span>map stl <span class="bound">πl</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">χ</span> <span class="bound">πl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ev_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ev_unfold<span class="main">:</span>
<span class="quoted"><span class="quoted">"ev <span class="free">φ</span> <span class="free">πl</span> <span class="main">=</span> <span class="main">(</span><span class="free">φ</span> <span class="free">πl</span> <span class="main">∨</span> ev <span class="free">φ</span> <span class="main">(</span>map stl <span class="free">πl</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ev_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tr_intro until_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"ev <span class="free">φ</span> <span class="free">πl</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="bound">i</span><span class="main">)</span> <span class="free">πl</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ev_def until_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The introduction rules for always and weak until are coinduction rules.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_coinduct<span class="main">[</span><span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword">pred</span></span><span class="main"><span class="main"><span class="main">:</span></span></span> alw<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Hyp<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="free">πl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">πl</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">πl</span> <span class="main">⟹</span> alw <span class="free">φ</span> <span class="bound">πl</span> <span class="main">∨</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">πl</span> <span class="main">∧</span> <span class="free">χ</span> <span class="main">(</span>map stl <span class="bound">πl</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alw <span class="free">φ</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>neg <span class="free">φ</span><span class="main">)</span> <span class="free">πl</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">χ</span> <span class="free">πl</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span>
   <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> assms alw_def ev_def neg_def until_introR<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"alw <span class="free">φ</span> <span class="free">πl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">φ</span> <span class="free">πl</span><span class="main">;</span> alw <span class="free">φ</span> <span class="main">(</span>map stl <span class="free">πl</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">χ</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> alw_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ev_introR <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neg_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_destL<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="free">φ</span> <span class="free">πl</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="free">πl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> alw_destR<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="free">φ</span> <span class="free">πl</span> <span class="main">⟹</span> alw <span class="free">φ</span> <span class="main">(</span>map stl <span class="free">πl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_unfold<span class="main">:</span>
<span class="quoted"><span class="quoted">"alw <span class="free">φ</span> <span class="free">πl</span> <span class="main">=</span> <span class="main">(</span><span class="free">φ</span> <span class="free">πl</span> <span class="main">∧</span> alw <span class="free">φ</span> <span class="main">(</span>map stl <span class="free">πl</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alw_def ev_unfold neg_elim neg_intro<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alw<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="free">φ</span> <span class="free">πl</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="bound">i</span><span class="main">)</span> <span class="free">πl</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> alw_def ev neg_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sdrop_imp_alw<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="main">[</span>sdrop <span class="bound">j</span> <span class="free">π</span><span class="main">,</span> sdrop <span class="bound">j</span> <span class="free">π'</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ψ</span> <span class="main">[</span>sdrop <span class="bound">i</span> <span class="free">π</span><span class="main">,</span> sdrop <span class="bound">i</span> <span class="free">π'</span><span class="main">]</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"imp <span class="main">(</span>alw <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>alw <span class="free">ψ</span><span class="main">)</span> <span class="main">[</span><span class="free">π</span><span class="main">,</span> <span class="free">π'</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> alw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wuntil_coinduct<span class="main">[</span><span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword">pred</span></span><span class="main"><span class="main"><span class="main">:</span></span></span> wuntil<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Hyp<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> χ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="free">πl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">πl</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">πl</span> <span class="main">⟹</span> <span class="free">ψ</span> <span class="bound">πl</span> <span class="main">∨</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">πl</span> <span class="main">∧</span> <span class="free">χ</span> <span class="main">(</span>map stl <span class="bound">πl</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wuntil <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> until <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span> <span class="main">∧</span> <span class="free">χ</span> <span class="free">πl</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"alw <span class="free">φ</span> <span class="free">πl</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">coinduct</span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> until_introL until_introR<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> χ <span class="keyword1"><span class="command">unfolding</span></span> wuntil_def dis_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wuntil_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"wuntil <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="free">πl</span> <span class="main">⟹</span> <span class="free">χ</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">φ</span> <span class="free">πl</span><span class="main">;</span> wuntil <span class="free">φ</span> <span class="free">ψ</span> <span class="main">(</span>map stl <span class="free">πl</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">χ</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">χ</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"alw <span class="free">φ</span> <span class="free">πl</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> wuntil_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"until <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> w <span class="keyword1"><span class="command">unfolding</span></span> wuntil_def dis_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms dis_introL until_unfold wuntil_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wuntil_unfold<span class="main">:</span>
<span class="quoted"><span class="quoted">"wuntil <span class="free">φ</span> <span class="free">ψ</span> <span class="free">πl</span> <span class="main">=</span> <span class="main">(</span><span class="free">ψ</span> <span class="free">πl</span> <span class="main">∨</span> <span class="free">φ</span> <span class="free">πl</span> <span class="main">∧</span> wuntil <span class="free">φ</span> <span class="free">ψ</span> <span class="main">(</span>map stl <span class="free">πl</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alw_unfold dis_def until_unfold wuntil_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹More derived operators›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The conjunction of an arbitrary set of formulas:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">scon</span> <span class="main">::</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">scon</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span><span class="main">.</span> <span class="bound">φ</span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mcon_intro<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="free">φs</span> <span class="main">⟹</span> <span class="bound">φ</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"scon <span class="free">φs</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> scon_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> scon_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"scon <span class="free">φs</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="free">φs</span> <span class="main">⟹</span> <span class="bound">φ</span> <span class="free">πl</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">χ</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">χ</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> scon_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Double-binding forall:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fall2</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span> fall <span class="main">(</span><span class="main">λ</span> <span class="bound">π</span><span class="main">.</span> fall <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">π</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fall2_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">π</span> <span class="bound">π'</span><span class="main">.</span> <span class="main">⟦</span>wfp <span class="free">AP'</span> <span class="bound">π</span><span class="main">;</span> wfp <span class="free">AP'</span> <span class="bound">π'</span><span class="main">;</span>
           <span class="free">πl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> stateOf <span class="bound">π</span> <span class="main">=</span> stateOf <span class="main">(</span>last <span class="free">πl</span><span class="main">)</span><span class="main">;</span>
           <span class="free">πl</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> stateOf <span class="bound">π</span> <span class="main">=</span> <span class="free">s0</span><span class="main">;</span>
           stateOf <span class="bound">π'</span> <span class="main">=</span> stateOf <span class="bound">π</span>
          <span class="main">⟧</span>
       <span class="main">⟹</span>  <span class="free">F</span> <span class="bound">π</span> <span class="bound">π'</span> <span class="free">πl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fall2 <span class="free">F</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fall2_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fall_intro<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fall2_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fall2 <span class="free">F</span> <span class="free">πl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">π</span> <span class="bound">π'</span><span class="main">.</span> <span class="main">⟦</span>wfp <span class="free">AP'</span> <span class="bound">π</span><span class="main">;</span> wfp <span class="free">AP'</span> <span class="bound">π'</span><span class="main">;</span>
           <span class="free">πl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> stateOf <span class="bound">π</span> <span class="main">=</span> stateOf <span class="main">(</span>last <span class="free">πl</span><span class="main">)</span><span class="main">;</span> <span class="free">πl</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> stateOf <span class="bound">π</span> <span class="main">=</span> <span class="free">s0</span><span class="main">;</span>
           stateOf <span class="bound">π'</span> <span class="main">=</span> stateOf <span class="bound">π</span>
          <span class="main">⟧</span>
          <span class="main">⟹</span> <span class="free">F</span> <span class="bound">π</span> <span class="bound">π'</span> <span class="free">πl</span><span class="main">)</span>
  <span class="main">⟹</span> <span class="free">χ</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">χ</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fall2_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fall_elim<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> fall_elim<span class="main">)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context Shallow *)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹end-of-context Shallow›</span></span>


<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Noninterference">
<div class="head">
<h1>Theory Noninterference</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Noninterference \`{a} la Goguen and Meseguer›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Noninterference
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Shallow.html">Shallow</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Goguen-Meseguer noninterference›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Definition›</span></span>

<span class="keyword1"><span class="command">locale</span></span> GM_sec_model <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">st0</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'St</span></span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">do</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'St</span> <span class="main">⇒</span> <span class="tfree">'U</span> <span class="main">⇒</span> <span class="tfree">'C</span> <span class="main">⇒</span> <span class="tfree">'St</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">out</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'St</span> <span class="main">⇒</span> <span class="tfree">'U</span> <span class="main">⇒</span> <span class="tfree">'Out</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">GH</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'U</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">GL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'U</span> set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Extension of ``do'' to sequences of pairs (user, command):›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">doo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'St</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'U</span> <span class="main">×</span> <span class="tfree">'C</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'St</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">doo</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">doo</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ucl</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">doo</span> <span class="main">(</span><span class="free">do</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ucl</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">purge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'U</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'U</span> <span class="main">×</span> <span class="tfree">'C</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'U</span> <span class="main">×</span> <span class="tfree">'C</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">purge</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">ucl</span></span></span> <span class="main">≡</span> filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ucl</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> purge_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"purge <span class="free">G</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> purge_Cons_in<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∉</span> <span class="free">G</span> <span class="main">⟹</span> purge <span class="free">G</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">#</span> <span class="free">ucl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">#</span> purge <span class="free">G</span> <span class="free">ucl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> purge_Cons_notIn<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> purge <span class="free">G</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">#</span> <span class="free">ucl</span><span class="main">)</span> <span class="main">=</span> purge <span class="free">G</span> <span class="free">ucl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> purge_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> purge_append<span class="main">:</span>
<span class="quoted"><span class="quoted">"purge <span class="free">G</span> <span class="main">(</span><span class="free">ucl1</span> <span class="main">@</span> <span class="free">ucl2</span><span class="main">)</span> <span class="main">=</span> purge <span class="free">G</span> <span class="free">ucl1</span> <span class="main">@</span> purge <span class="free">G</span> <span class="free">ucl2</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> purge_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> filter_append<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nonint</span> <span class="main">::</span> <span class="quoted">bool</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nonint</span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">ucl</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">GL</span><span class="main">.</span> <span class="free">out</span> <span class="main">(</span>doo <span class="free">st0</span> <span class="bound">ucl</span><span class="main">)</span> <span class="bound">u</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>doo <span class="free">st0</span> <span class="main">(</span>purge <span class="free">GH</span> <span class="bound">ucl</span><span class="main">)</span><span class="main">)</span> <span class="bound">u</span>"</span></span>


<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context GM_sec_model *)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹end-of-context GM-sec-model›</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Specialized Kripke structures›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹As a preparation for representing noninterference in HyperCTL*,
we define a specialized notion of Kripke structure.  It is enriched
with the following date: 
two binary state predicates f and g, intuitively capturing high-input
and low-output equivalence, respectively; 
a set Sink of
states immediately accessible from any state and such that, for the states in Sink,
there exist self-transitions and f holds.

This specialized structure, represented by the locale Shallow-Idle, is an auxiliary that streamlines our proofs, 
easing the connection
between finite paths (specific to Goguen-Meseguer noninterference) and
infinite paths (specific to the HyperCTL* semantics).
The desired Kripke structure produced from a Goguen-Meseguer model 
will actually be such a specialized structure.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Shallow_Idle <span class="main">=</span> Shallow <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="quoted">"<span class="free">s0</span>"</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">AP</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">s0</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'state</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">AP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'aprop</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Sink</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> set"</span></span>
  <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Sink_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Sink</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Sink<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free">δ</span> <span class="bound">s</span> <span class="main">∩</span> <span class="free">Sink</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Sink_idle<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">Sink</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">δ</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Sink_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span> <span class="main">{</span><span class="bound">s1</span><span class="main">,</span><span class="bound">s2</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">Sink</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">s1</span> <span class="bound">s2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">toSink</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free">δ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∩</span> <span class="free">Sink</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> toSink<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> toSink <span class="free">s</span> <span class="main">∈</span> <span class="free">δ</span> <span class="free">s</span> <span class="main">∩</span> <span class="free">Sink</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> toSink_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sink someI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fall2_imp_alw<span class="main">:</span>
<span class="quoted"><span class="quoted">"fall2 <span class="main">(</span><span class="main">λ</span> <span class="bound">π'</span> <span class="bound">π</span> <span class="bound">πl</span><span class="main">.</span> imp <span class="main">(</span>alw <span class="main">(</span><span class="free">φ</span> <span class="bound">πl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>alw <span class="main">(</span><span class="free">ψ</span> <span class="bound">πl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">πl</span> <span class="main">@</span> <span class="main">[</span><span class="bound">π</span><span class="main">,</span><span class="bound">π'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span>
 <span class="main">⟷</span>
 <span class="main">(</span><span class="main">∀</span> <span class="bound">π</span> <span class="bound">π'</span><span class="main">.</span> wfp <span class="free">AP'</span> <span class="bound">π</span> <span class="main">∧</span> wfp <span class="free">AP'</span> <span class="bound">π'</span> <span class="main">∧</span> stateOf <span class="bound">π</span> <span class="main">=</span> <span class="free">s0</span> <span class="main">∧</span> stateOf <span class="bound">π'</span> <span class="main">=</span> <span class="free">s0</span>
           <span class="main">⟶</span> imp <span class="main">(</span>alw <span class="main">(</span><span class="free">φ</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>alw <span class="main">(</span><span class="free">ψ</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="bound">π</span><span class="main">,</span><span class="bound">π'</span><span class="main">]</span>
 <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fall2_intro imp_intro <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fall2_elim imp_elim<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> imp_elim<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">lemma</span></span> wfp_stateOf_shift_stake_sconst<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">π</span> <span class="free">i</span>
<span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">π1</span> <span class="main">≡</span> shift <span class="main">(</span>stake <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">π</span><span class="main">)</span> <span class="main">(</span>sconst <span class="main">(</span>toSink <span class="main">(</span>fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">L</span> <span class="main">(</span>toSink <span class="main">(</span>fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> π<span class="main">:</span> <span class="quoted"><span class="quoted">"wfp <span class="free">AP'</span> <span class="free">π</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wfp <span class="free">AP'</span> <span class="free">π1</span> <span class="main">∧</span> stateOf <span class="free">π1</span> <span class="main">=</span> stateOf <span class="free">π</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> π1_less<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> Suc <span class="free">i</span> <span class="main">⟹</span> <span class="free">π1</span> <span class="main">!!</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">π</span> <span class="main">!!</span> <span class="bound">k</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> π1_geq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">π1</span> <span class="main">!!</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">(</span>toSink <span class="main">(</span>fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">,</span> <span class="free">L</span> <span class="main">(</span>toSink <span class="main">(</span>fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> π1_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stake.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">π1</span> <span class="main">!!</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> <span class="free">δ</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">π1</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> Suc <span class="free">i</span>"</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> True
     <span class="keyword1"><span class="command">hence</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π1</span> <span class="main">!!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">π</span> <span class="main">!!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span><span class="main">)</span>
       <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">&lt;</span> Suc <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> π <span class="keyword1"><span class="command">unfolding</span></span> π1_less<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> 0 wfp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">next</span></span>
       <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
       <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> π <span class="keyword1"><span class="command">unfolding</span></span> π1_geq<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> 0 wfp <span class="keyword1"><span class="command">unfolding</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntD1 fstI toSink<span class="main">)</span>
     <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> False
     <span class="keyword1"><span class="command">hence</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sk<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> π1_geq<span class="main">[</span><span class="operator">OF</span> k<span class="main">]</span> π1_geq<span class="main">[</span><span class="operator">OF</span> sk<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> π wfp Sink_idle toSink <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">π1</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">π1</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">AP'</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">π1</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∩</span> <span class="free">AP</span> <span class="main">=</span> <span class="free">L</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">π1</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> Suc <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> π wfp AP_AP' IntD1 L δ inf.orderE order_trans rev_subsetD toSink<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wfp <span class="free">AP'</span> <span class="free">π1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wfp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stateOf <span class="free">π1</span> <span class="main">=</span> stateOf <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> π1_def shift.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> stake.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> stream.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fall2_imp_alw_index<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">π</span> <span class="bound">π'</span><span class="main">.</span> wfp <span class="free">AP'</span> <span class="bound">π</span> <span class="main">∧</span> wfp <span class="free">AP'</span> <span class="bound">π'</span> <span class="main">⟶</span>
                     <span class="free">φ</span> <span class="main">[]</span> <span class="main">[</span><span class="bound">π</span><span class="main">,</span><span class="bound">π'</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>stateOf <span class="bound">π</span><span class="main">)</span> <span class="main">(</span>stateOf <span class="bound">π'</span><span class="main">)</span> <span class="main">∧</span>
                     <span class="free">ψ</span> <span class="main">[]</span> <span class="main">[</span><span class="bound">π</span><span class="main">,</span><span class="bound">π'</span><span class="main">]</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span>stateOf <span class="bound">π</span><span class="main">)</span> <span class="main">(</span>stateOf <span class="bound">π'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"fall2 <span class="main">(</span><span class="main">λ</span> <span class="bound">π'</span> <span class="bound">π</span> <span class="bound">πl</span><span class="main">.</span> imp <span class="main">(</span>alw <span class="main">(</span><span class="free">φ</span> <span class="bound">πl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>alw <span class="main">(</span><span class="free">ψ</span> <span class="bound">πl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">πl</span> <span class="main">@</span> <span class="main">[</span><span class="bound">π</span><span class="main">,</span><span class="bound">π'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span>
 <span class="main">⟷</span>
 <span class="main">(</span><span class="main">∀</span> <span class="bound">π</span> <span class="bound">π'</span><span class="main">.</span> wfp <span class="free">AP'</span> <span class="bound">π</span> <span class="main">∧</span> wfp <span class="free">AP'</span> <span class="bound">π'</span> <span class="main">∧</span> stateOf <span class="bound">π</span> <span class="main">=</span> <span class="free">s0</span> <span class="main">∧</span> stateOf <span class="bound">π'</span> <span class="main">=</span> <span class="free">s0</span>
           <span class="main">⟶</span>
           <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≤</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">π</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">π'</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">g</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">π</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">π'</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
 <span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">π</span> <span class="bound">π'</span><span class="main">.</span> wfp <span class="free">AP'</span> <span class="bound">π</span> <span class="main">∧</span> wfp <span class="free">AP'</span> <span class="bound">π'</span> <span class="main">⟶</span>
                      <span class="free">f</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">π</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">π'</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="main">[]</span> <span class="main">[</span>sdrop <span class="bound">i</span> <span class="bound">π</span><span class="main">,</span> sdrop <span class="bound">i</span> <span class="bound">π'</span><span class="main">]</span> <span class="main">∧</span>
                      <span class="free">g</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">π</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">π'</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">ψ</span> <span class="main">[]</span> <span class="main">[</span>sdrop <span class="bound">i</span> <span class="bound">π</span><span class="main">,</span> sdrop <span class="bound">i</span> <span class="bound">π'</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fall2_imp_alw <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> iffI allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="skolem">π'</span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">π</span> <span class="bound">π'</span><span class="main">.</span> wfp <span class="free">AP'</span> <span class="bound">π</span> <span class="main">∧</span> wfp <span class="free">AP'</span> <span class="bound">π'</span> <span class="main">∧</span> stateOf <span class="bound">π</span> <span class="main">=</span> <span class="free">s0</span> <span class="main">∧</span> stateOf <span class="bound">π'</span> <span class="main">=</span> <span class="free">s0</span>
                       <span class="main">⟶</span> imp <span class="main">(</span>alw <span class="main">(</span><span class="free">φ</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>alw <span class="main">(</span><span class="free">ψ</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="bound">π</span><span class="main">,</span><span class="bound">π'</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ππ'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wfp <span class="free">AP'</span> <span class="skolem">π</span>"</span></span> <span class="quoted"><span class="quoted">"wfp <span class="free">AP'</span> <span class="skolem">π'</span>"</span></span> <span class="quoted"><span class="quoted">"stateOf <span class="skolem">π</span> <span class="main">=</span> <span class="free">s0</span>"</span></span> <span class="quoted"><span class="quoted">"stateOf <span class="skolem">π'</span> <span class="main">=</span> <span class="free">s0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="skolem">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">π</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">π'</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> ππ'i<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> wfp <span class="free">AP'</span> <span class="main">(</span>sdrop <span class="bound">i</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">∧</span> wfp <span class="free">AP'</span> <span class="main">(</span>sdrop <span class="bound">i</span> <span class="skolem">π'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ππ' wfp_sdrop<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">π1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π1</span> <span class="main">=</span> shift <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">(</span>sconst <span class="main">(</span>toSink <span class="main">(</span>fst <span class="main">(</span><span class="skolem">π</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">L</span> <span class="main">(</span>toSink <span class="main">(</span>fst <span class="main">(</span><span class="skolem">π</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">π1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π1'</span> <span class="main">=</span> shift <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">π'</span><span class="main">)</span> <span class="main">(</span>sconst <span class="main">(</span>toSink <span class="main">(</span>fst <span class="main">(</span><span class="skolem">π'</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">L</span> <span class="main">(</span>toSink <span class="main">(</span>fst <span class="main">(</span><span class="skolem">π'</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> π1π1'<span class="main">:</span> <span class="quoted"><span class="quoted">"wfp <span class="free">AP'</span> <span class="skolem">π1</span> <span class="main">∧</span> stateOf <span class="skolem">π1</span> <span class="main">=</span> <span class="free">s0</span> <span class="main">∧</span> wfp <span class="free">AP'</span> <span class="skolem">π1'</span> <span class="main">∧</span> stateOf <span class="skolem">π1'</span> <span class="main">=</span> <span class="free">s0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wfp_stateOf_shift_stake_sconst <span class="keyword1"><span class="command">unfolding</span></span> π1_def π1'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> π1π1'i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> wfp <span class="free">AP'</span> <span class="main">(</span>sdrop <span class="bound">i</span> <span class="skolem">π1</span><span class="main">)</span> <span class="main">∧</span> wfp <span class="free">AP'</span> <span class="main">(</span>sdrop <span class="bound">i</span> <span class="skolem">π1'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ππ' wfp_sdrop<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> imp<span class="main">:</span> <span class="quoted"><span class="quoted">"imp <span class="main">(</span>alw <span class="main">(</span><span class="free">φ</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>alw <span class="main">(</span><span class="free">ψ</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">π1</span><span class="main">,</span><span class="skolem">π1'</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L  π1π1' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="free">φ</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">π1</span><span class="main">,</span><span class="skolem">π1'</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> alw <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">π</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">π'</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ππ' <span class="keyword1"><span class="command">unfolding</span></span> wfp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">[]</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="skolem">k</span><span class="main">)</span> <span class="main">[</span><span class="skolem">π1</span><span class="main">,</span> <span class="skolem">π1'</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> φ 0 π1π1'i <span class="keyword1"><span class="command">unfolding</span></span> π1_def π1'_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> Suc <span class="skolem">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stake.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> toSink<span class="main">[</span><span class="operator">OF</span> a<span class="main">]</span> toSink<span class="main">[</span><span class="operator">OF</span> b<span class="main">]</span> Sink_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="free">ψ</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">π1</span><span class="main">,</span><span class="skolem">π1'</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">[]</span> <span class="main">[</span>sdrop <span class="skolem">i</span> <span class="skolem">π1</span><span class="main">,</span> sdrop <span class="skolem">i</span> <span class="skolem">π1'</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> alw <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">π1</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">π1'</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 π1π1'i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">π</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">π'</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> π1_def π1'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stake.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sdrop_imp_alw 1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context Shallow-Idle *)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹end-of-context Shallow-Idle›</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Faithful representation as a HyperCTL* property›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Starting with a Goguen-Meseguer model, we will produce a specialized
Kripke structure and a shallow HyperCTL* formula.
Then we we will prove that the structure satisfies the formula iff the
Goguen-Meseguer model satisfies noninterference.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The Kripke structure has two kinds of states: ``idle'' states storing Goguen-Meseguer states,
and normal states storing Goguen-Meseguer states, users and commands: the former 
will be used for synchronization and the latter for Goguen-Meseguer steps.
The Kripke labels store user-command actions and user-output observations.

›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'St</span><span class="main">,</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">)</span> state <span class="main">=</span>
  <span class="entity">isIdle</span><span class="main">:</span> Idle <span class="main">(</span><span class="free"><span class="entity">getGMState</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'St</span></span></span><span class="main">)</span> <span class="main">|</span> <span class="entity">isState</span><span class="main">:</span> State <span class="main">(</span>getGMState<span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'St</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">getGMUser</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'U</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">getGMCom</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'C</span></span></span><span class="main">)</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">,</span><span class="tfree">'Out</span><span class="main">)</span> aprop <span class="main">=</span> Last <span class="tfree"><span class="quoted"><span class="tfree">'U</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'C</span></span></span> <span class="main">|</span> Obs <span class="tfree"><span class="quoted"><span class="tfree">'U</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'Out</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">getGMUserCom</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">getGMUserCom</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>getGMUser <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> getGMCom <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> getGMUserCom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"getGMUserCom <span class="main">(</span>State <span class="free">st</span> <span class="free">u</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> getGMUserCom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> GM_sec_model
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'St</span><span class="main">,</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">,</span><span class="tfree">'Out</span><span class="main">)</span> aprop set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">(</span>Idle <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Obs <span class="bound">u'</span> <span class="main">(</span><span class="free">out</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="bound">u'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">u'</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Last <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>Obs <span class="bound">u'</span> <span class="main">(</span><span class="free">out</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="bound">u'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">u'</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Get the Goguen-Meseguer state:›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">getGMState</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">getGMState</span> <span class="main">(</span>Idle <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">getGMState</span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Last_in_L<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Last <span class="free">u</span> <span class="free">c</span> <span class="main">∈</span> L <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">st</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> State <span class="bound">st</span> <span class="free">u</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Obs_in_L<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Obs <span class="free">u</span> <span class="free">ou</span> <span class="main">∈</span> L <span class="free">s</span> <span class="main">⟷</span> <span class="free">ou</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>getGMState <span class="free">s</span><span class="main">)</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'St</span><span class="main">,</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'St</span><span class="main">,</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">)</span> state set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">(</span>Idle <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Idle <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>State <span class="main">(</span><span class="free">do</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="bound">u'</span> <span class="bound">c'</span><span class="main">)</span> <span class="bound">u'</span> <span class="bound">c'</span> <span class="main">|</span> <span class="bound">u'</span> <span class="bound">c'</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">(</span>State <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Idle <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>State <span class="main">(</span><span class="free">do</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="bound">u'</span> <span class="bound">c'</span><span class="main">)</span> <span class="bound">u'</span> <span class="bound">c'</span> <span class="main">|</span> <span class="bound">u'</span> <span class="bound">c'</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">s0</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s0</span> <span class="main">≡</span> State <span class="free">st0</span> any any"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'U</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'U</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> state <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span>
 <span class="main">∀</span> <span class="bound">u</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∉</span> <span class="free">GH</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span> <span class="bound">st</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> State <span class="bound">st</span> <span class="bound">u</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">st'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> State <span class="bound">st'</span> <span class="bound">u</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'St</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'St</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> state <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">u1</span><span class="main">.</span> <span class="bound">u1</span> <span class="main">∈</span> <span class="free">GL</span> <span class="main">⟶</span> <span class="free">out</span> <span class="main">(</span>getGMState <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">u1</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>getGMState <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="bound">u1</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> f_id<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"f <span class="free">s</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Sink</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'St</span><span class="main">,</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">)</span> state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Sink</span> <span class="main">=</span> <span class="main">{</span>Idle <span class="bound">st</span> <span class="main">|</span> <span class="bound">st</span> <span class="main">.</span> True<span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context GM_sec_model *)</span>


<span class="keyword1"><span class="command">sublocale</span></span> GM_sec_model <span class="main">&lt;</span> Shallow_Idle
<span class="keyword2"><span class="keyword">where</span></span> S <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV<span class="main">::</span><span class="main">(</span><span class="tfree">'St</span><span class="main">,</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">)</span> state set"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> AP <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">,</span><span class="tfree">'Out</span><span class="main">)</span> aprop set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> AP' <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">,</span><span class="tfree">'Out</span><span class="main">)</span> aprop set"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> s0 <span class="main">=</span> <span class="quoted">s0</span> <span class="keyword2"><span class="keyword">and</span></span> L <span class="main">=</span> <span class="quoted">L</span> <span class="keyword2"><span class="keyword">and</span></span> δ <span class="main">=</span> <span class="quoted">δ</span> <span class="keyword2"><span class="keyword">and</span></span> f <span class="main">=</span> <span class="quoted">f</span> <span class="keyword2"><span class="keyword">and</span></span> g <span class="main">=</span> <span class="quoted">g</span> <span class="keyword2"><span class="keyword">and</span></span> Sink <span class="main">=</span> <span class="quoted">Sink</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> δ <span class="skolem">s</span> <span class="main">∩</span> Sink"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Idle <span class="main"><span class="main"><span class="main">(</span></span></span>getGMState <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sink_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Sink"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> δ <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Sink_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">s1</span><span class="main">,</span> <span class="skolem">s2</span><span class="main">}</span> <span class="main">⊆</span> Sink"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"f <span class="skolem">s1</span> <span class="skolem">s2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sink_def f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> GM_sec_model
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> apropsOf_L_stateOf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"wfp <span class="free">AP'</span> <span class="free">π</span> <span class="main">⟹</span> apropsOf <span class="free">π</span> <span class="main">=</span> L <span class="main">(</span>stateOf <span class="free">π</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> wfp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_UNIV_right snth.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The equality of two states w.r.t.\ a given ``last'' user-command pair:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eqOnUC</span> <span class="main">::</span>
<span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'U</span> <span class="main">⇒</span> <span class="tfree">'C</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'St</span><span class="main">,</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">)</span> state<span class="main">,</span><span class="main">(</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">,</span><span class="tfree">'Out</span><span class="main">)</span> aprop<span class="main">)</span> sfmla"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">eqOnUC</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> eq <span class="main">(</span>atom <span class="main">(</span>Last <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>atom <span class="main">(</span>Last <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The equality of two states w.r.t.\ all their ``last'' user-command pairs with
the user not in GH:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eqButGH</span> <span class="main">::</span>
<span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'St</span><span class="main">,</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">)</span> state<span class="main">,</span><span class="main">(</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">,</span><span class="tfree">'Out</span><span class="main">)</span> aprop<span class="main">)</span> sfmla"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">eqButGH</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="main">≡</span> scon <span class="main">{</span>eqOnUC <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="bound">u</span> <span class="bound">c</span> <span class="main">|</span> <span class="bound">u</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="free">GH</span><span class="main">)</span> <span class="main">×</span> UNIV<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The equality of two states w.r.t.\ a given ``observed'' user-observation pair:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eqOnUOut</span> <span class="main">::</span>
<span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'U</span> <span class="main">⇒</span> <span class="tfree">'Out</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'St</span><span class="main">,</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">)</span> state<span class="main">,</span><span class="main">(</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">,</span><span class="tfree">'Out</span><span class="main">)</span> aprop<span class="main">)</span> sfmla"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">eqOnUOut</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">ou</span></span></span> <span class="main">≡</span> eq <span class="main">(</span>atom <span class="main">(</span>Obs <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">ou</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>atom <span class="main">(</span>Obs <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">ou</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The equality of two states w.r.t.\ all their ``observed'' user-observation pairs with
the user in GL:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eqOnGL</span> <span class="main">::</span>
<span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'St</span><span class="main">,</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">)</span> state<span class="main">,</span><span class="main">(</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">,</span><span class="tfree">'Out</span><span class="main">)</span> aprop<span class="main">)</span> sfmla"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">eqOnGL</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="main">≡</span> scon <span class="main">{</span>eqOnUOut <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="bound">u</span> <span class="bound">ou</span> <span class="main">|</span> <span class="bound">u</span> <span class="bound">ou</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">ou</span><span class="main">)</span> <span class="main">∈</span> <span class="free">GL</span> <span class="main">×</span> UNIV<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eqOnUC_0_Suc0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wfp <span class="free">AP'</span> <span class="free">π</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wfp <span class="free">AP'</span> <span class="free">π'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"eqOnUC <span class="main">0</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">u</span> <span class="free">c</span> <span class="main">[</span><span class="free">π</span><span class="main">,</span> <span class="free">π'</span><span class="main">]</span>
 <span class="main">⟷</span>
 <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">st</span><span class="main">.</span> stateOf <span class="free">π</span> <span class="main">=</span> State <span class="bound">st</span> <span class="free">u</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">st'</span><span class="main">.</span> stateOf <span class="free">π'</span> <span class="main">=</span> State <span class="bound">st'</span> <span class="free">u</span> <span class="free">c</span><span class="main">)</span>
 <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eqOnUC_def atom_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> eq_equals <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> eqOnUOut_0_Suc0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wfp <span class="free">AP'</span> <span class="free">π</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wfp <span class="free">AP'</span> <span class="free">π'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"eqOnUOut <span class="main">0</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">u</span> <span class="free">ou</span> <span class="main">[</span><span class="free">π</span><span class="main">,</span> <span class="free">π'</span><span class="main">]</span>
 <span class="main">⟷</span>
 <span class="main">(</span><span class="free">ou</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>getGMState <span class="main">(</span>stateOf <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="free">u</span> <span class="main">⟷</span>
  <span class="free">ou</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>getGMState <span class="main">(</span>stateOf <span class="free">π'</span><span class="main">)</span><span class="main">)</span> <span class="free">u</span>
 <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eqOnUOut_def atom_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> eq_equals <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The (shallow) noninterference formula -- it will be proved equivalent to nonint,
the original statement of noninterference.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nonintSfmla</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'St</span><span class="main">,</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">)</span> state<span class="main">,</span><span class="main">(</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">,</span><span class="tfree">'Out</span><span class="main">)</span> aprop<span class="main">)</span> sfmla"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nonintSfmla</span> <span class="main">≡</span>
 fall2 <span class="main">(</span><span class="main">λ</span> <span class="bound">π'</span> <span class="bound">π</span> <span class="bound">πl</span><span class="main">.</span>
        imp <span class="main">(</span>alw <span class="main">(</span>eqButGH <span class="main">(</span>length <span class="bound">πl</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="bound">πl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>alw <span class="main">(</span>eqOnGL <span class="main">(</span>length <span class="bound">πl</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="bound">πl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="bound">πl</span> <span class="main">@</span> <span class="main">[</span><span class="bound">π</span><span class="main">,</span><span class="bound">π'</span><span class="main">]</span><span class="main">)</span>
       <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹First, we show that nonintSfmla is equivalent to nonintSI, a variant of noninterference
that speaks about Synchronized Infinite paths.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nonintSI</span> <span class="main">::</span> <span class="quoted">bool</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nonintSI</span> <span class="main">≡</span>
 <span class="main">∀</span> <span class="bound">π</span> <span class="bound">π'</span><span class="main">.</span> wfp UNIV <span class="bound">π</span> <span class="main">∧</span> wfp UNIV <span class="bound">π'</span> <span class="main">∧</span> stateOf <span class="bound">π</span> <span class="main">=</span> s0 <span class="main">∧</span> stateOf <span class="bound">π'</span> <span class="main">=</span> s0
           <span class="main">⟶</span>
          <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≤</span> <span class="bound">i</span><span class="main">.</span> f <span class="main">(</span>fst <span class="main">(</span><span class="bound">π</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">π'</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> g <span class="main">(</span>fst <span class="main">(</span><span class="bound">π</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">π'</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonintSfmla_nonintSI<span class="main">:</span> <span class="quoted"><span class="quoted">"nonintSfmla <span class="main">[]</span> <span class="main">⟷</span> nonintSI"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="skolem">πl</span> <span class="main">=</span> eqButGH <span class="main">(</span>length <span class="skolem">πl</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">πl</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">πl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'St</span><span class="main">,</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">)</span> state<span class="main">,</span><span class="main">(</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">,</span><span class="tfree">'Out</span><span class="main">)</span> aprop<span class="main">)</span> path list"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="skolem">πl</span> <span class="main">=</span> eqOnGL <span class="main">(</span>length <span class="skolem">πl</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">πl</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">πl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'St</span><span class="main">,</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">)</span> state<span class="main">,</span><span class="main">(</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">,</span><span class="tfree">'Out</span><span class="main">)</span> aprop<span class="main">)</span> path list"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">π</span> <span class="bound">π'</span><span class="main">.</span> wfp UNIV <span class="bound">π</span> <span class="main">∧</span> wfp UNIV <span class="bound">π'</span> <span class="main">⟶</span>
                 <span class="skolem">φ</span> <span class="main">[]</span> <span class="main">[</span><span class="bound">π</span><span class="main">,</span><span class="bound">π'</span><span class="main">]</span> <span class="main">=</span> f <span class="main">(</span>stateOf <span class="bound">π</span><span class="main">)</span> <span class="main">(</span>stateOf <span class="bound">π'</span><span class="main">)</span> <span class="main">∧</span>
                 <span class="skolem">ψ</span> <span class="main">[]</span> <span class="main">[</span><span class="bound">π</span><span class="main">,</span><span class="bound">π'</span><span class="main">]</span> <span class="main">=</span> g <span class="main">(</span>stateOf <span class="bound">π</span><span class="main">)</span> <span class="main">(</span>stateOf <span class="bound">π'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> φ_def ψ_def f_def g_def eqButGH_def eqOnGL_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scon_def eqOnUC_0_Suc0<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fall2_imp_alw_index<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">φ</span></span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> nonintSfmla_def nonintSI_def φ_def ψ_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In turn, nonintSI will be shown equivalent to nonintS, a variant speaking about
Synchronized finite paths. To this end, we introduce a notion of well-formed finite path (wffp) -- besides
finiteness, another difference from the previously defined infinite paths is that, thanks to
the fact that here AP coincides with AP', paths are mere sequences of states as opposed
to pairs (state,set of atomic predicates).›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">wffp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'St</span><span class="main">,</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">)</span> state list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
Singl<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wffp</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span>
Cons<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">∈</span> δ <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> <span class="free">wffp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span><span class="main">)</span><span class="main">⟧</span>
 <span class="main">⟹</span>
 <span class="free">wffp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_induct2<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Singl Cons<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">[</span><span class="bound">s</span><span class="main">]</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">sl</span><span class="main">.</span> <span class="main">⟦</span>hd <span class="bound">sl</span> <span class="main">∈</span> δ <span class="bound">s</span><span class="main">;</span> wffp <span class="bound">sl</span><span class="main">;</span> <span class="free">P</span> <span class="bound">sl</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">s</span> <span class="main">#</span> <span class="bound">sl</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">sl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nonintS</span> <span class="main">::</span> <span class="quoted">bool</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nonintS</span> <span class="main">≡</span>
 <span class="main">∀</span> <span class="bound">sl</span> <span class="bound">sl'</span><span class="main">.</span> wffp <span class="bound">sl</span> <span class="main">∧</span> wffp <span class="bound">sl'</span> <span class="main">∧</span> hd <span class="bound">sl</span> <span class="main">=</span> s0 <span class="main">∧</span> hd <span class="bound">sl'</span> <span class="main">=</span> s0 <span class="main">∧</span>
            list_all2 f <span class="bound">sl</span> <span class="bound">sl'</span> <span class="main">⟶</span> g <span class="main">(</span>last <span class="bound">sl</span><span class="main">)</span> <span class="main">(</span>last <span class="bound">sl'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_NE<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wffp<span class="main">:</span>
<span class="quoted"><span class="quoted">"wffp <span class="free">sl</span> <span class="main">⟷</span> <span class="free">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">sl</span> <span class="main">⟶</span> <span class="free">sl</span><span class="main">!</span><span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> δ<span class="main">(</span><span class="free">sl</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?A</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?R</span> <span class="bound">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffI allI conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s'</span> <span class="skolem">s</span> <span class="skolem">sl</span> <span class="skolem">i</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?R</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sl</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">sl</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">sl</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wffp.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wffp.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wffp_NE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_hdI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">sl</span> <span class="main">∈</span> δ <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wffp <span class="main">(</span><span class="free">s</span> <span class="main">#</span> <span class="free">sl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">sl</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_append<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> sl<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sl1<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="free">sl1</span> <span class="main">∈</span> δ <span class="main">(</span>last <span class="free">sl</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wffp <span class="main">(</span><span class="free">sl</span> <span class="main">@</span> <span class="free">sl1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> sl h <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sl</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sl1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_append_iff<span class="main">:</span>
<span class="quoted"><span class="quoted">"wffp <span class="main">(</span><span class="free">sl</span> <span class="main">@</span> <span class="free">sl1</span><span class="main">)</span> <span class="main">⟷</span>
 <span class="main">(</span>wffp <span class="free">sl</span> <span class="main">∧</span> <span class="free">sl1</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∨</span>
 <span class="main">(</span><span class="free">sl</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> wffp <span class="free">sl1</span><span class="main">)</span> <span class="main">∨</span>
 <span class="main">(</span>wffp <span class="free">sl</span> <span class="main">∧</span> wffp <span class="free">sl1</span> <span class="main">∧</span> hd <span class="free">sl1</span> <span class="main">∈</span> δ <span class="main">(</span>last <span class="free">sl</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wffp <span class="main">(</span><span class="free">sl</span> <span class="main">@</span> <span class="free">sl1</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">@</span> <span class="free">sl1</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">sl</span></span> <span class="quoted"><span class="free">sl1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">sl</span> <span class="skolem">sl1</span> <span class="skolem">sl2</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> C <span class="main">=</span> Cons
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl1</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">sl2</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sll1</span></span> <span class="keyword2"><span class="keyword">where</span></span> sl1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl1</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">sll1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sl <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">=</span> <span class="skolem">sll1</span> <span class="main">@</span>  <span class="skolem">sl2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">sl1</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> wsl<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="skolem">sl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> C False append_is_Nil_conv list.inject sl wffp.simps<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> C<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> sl<span class="main">,</span> <span class="operator">unfolded</span> sl<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span> wsl<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> C False wffp_hdI append_is_Nil_conv list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> hd_append
                last.simps list.inject sl sl1 wffp.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">insert</span> C<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wffp_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_to_wfp<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> π_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> L <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free">sl</span> <span class="main">@-</span> sconst <span class="main">(</span>toSink <span class="main">(</span>last <span class="free">sl</span><span class="main">)</span><span class="main">,</span> L <span class="main">(</span>toSink <span class="main">(</span>last <span class="free">sl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> sl<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"wfp UNIV <span class="free">π</span> <span class="main">∧</span>
 <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">sl</span><span class="main">.</span> <span class="free">sl</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
 <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≥</span> length <span class="free">sl</span><span class="main">.</span> fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> toSink <span class="main">(</span>last <span class="free">sl</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
 stateOf <span class="free">π</span> <span class="main">=</span> hd <span class="free">sl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> wfp <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> L <span class="main">(</span>fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> π_def wffp  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">sl</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> L <span class="main">(</span>fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> π_def wffp  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">sl</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">sl</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">sl</span><span class="main">!</span><span class="skolem">j</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> π_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">sl</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> length <span class="free">sl</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> toSink <span class="main">(</span>last <span class="free">sl</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> sl <span class="keyword1"><span class="command">unfolding</span></span> π_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> δ <span class="main">(</span>fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="free">sl</span> <span class="main">≤</span> Suc <span class="skolem">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">sl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">sl</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">sl</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sl False <span class="keyword1"><span class="command">unfolding</span></span> wffp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> sl <span class="main">=</span> True
    <span class="keyword1"><span class="command">hence</span></span> 22<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> toSink <span class="main">(</span>last <span class="free">sl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="free">sl</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> toSink <span class="main">(</span>last <span class="free">sl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 22 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntD2 Sink_idle UNIV_I toSink<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"last <span class="free">sl</span> <span class="main">=</span> <span class="free">sl</span><span class="main">!</span><span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sl
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 diff_add_inverse2 last_conv_nth le0 le_Suc_eq length_0_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">sl</span><span class="main">!</span><span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 22 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntD1 UNIV_I toSink<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stateOf <span class="free">π</span> <span class="main">=</span> hd <span class="free">sl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wffp_NE<span class="main">[</span><span class="operator">OF</span> sl<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> π_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">sl</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_imp_appendL<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="main">(</span><span class="free">sl1</span> <span class="main">@</span> <span class="free">sl2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">sl1</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> wffp <span class="free">sl1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wffp_append_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_imp_appendR<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="main">(</span><span class="free">sl1</span> <span class="main">@</span> <span class="free">sl2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">sl2</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> wffp <span class="free">sl2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wffp_append_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_iff_map_Idle<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="bound">st</span><span class="main">.</span>
   <span class="main">(</span><span class="bound">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">sl</span> <span class="main">=</span> map Idle <span class="main">(</span>replicate <span class="bound">n</span> <span class="bound">st</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
   <span class="main">(</span><span class="main">∃</span> <span class="bound">st1</span> <span class="bound">u1</span> <span class="bound">c1</span> <span class="bound">sl1</span><span class="main">.</span> <span class="free">sl</span> <span class="main">=</span> map Idle <span class="main">(</span>replicate <span class="bound">n</span> <span class="bound">st</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>State <span class="bound">st1</span> <span class="bound">u1</span> <span class="bound">c1</span><span class="main">]</span> <span class="main">@</span> <span class="bound">sl1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wffp_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Singl <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Idle <span class="skolem">st</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Idle <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main"><span class="main">0</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">st</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>State <span class="skolem">st1</span> <span class="skolem">u1</span> <span class="skolem">c1</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> State <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">st</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">sl</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">st</span>
   <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">=</span> map Idle <span class="main">(</span>replicate <span class="skolem">n</span> <span class="skolem">st</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> sl'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">=</span> <span class="main">(</span>Idle <span class="skolem">st</span><span class="main">)</span> <span class="main">#</span> map Idle <span class="main">(</span>replicate <span class="skolem">n'</span> <span class="skolem">st</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Idle <span class="skolem">st1</span><span class="main">)</span>
     <span class="keyword1"><span class="command">have</span></span> st1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">st1</span> <span class="main">=</span> <span class="skolem">st</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">sl</span> <span class="main">∈</span> δ <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sl' Idle <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem">n</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">st</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">unfolding</span></span> sl Idle st1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>State <span class="skolem">st1</span> <span class="skolem">u1</span> <span class="skolem">c1</span><span class="main">)</span>
     <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">#</span> <span class="skolem">sl</span> <span class="main">=</span> map Idle <span class="main">(</span>replicate <span class="main">0</span> <span class="skolem">st</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>State <span class="skolem">st1</span> <span class="skolem">u1</span> <span class="skolem">c1</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">sl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">st</span> <span class="skolem">st1</span> <span class="skolem">u1</span> <span class="skolem">c1</span> <span class="skolem">sl1</span> <span class="keyword3"><span class="command">assume</span></span> sl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">=</span> map Idle <span class="main">(</span>replicate <span class="skolem">n</span> <span class="skolem">st</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>State <span class="skolem">st1</span> <span class="skolem">u1</span> <span class="skolem">c1</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">sl1</span>"</span></span>
   <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Idle <span class="skolem">st2</span><span class="main">)</span>
     <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
       <span class="keyword3"><span class="command">case</span></span> 0
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">#</span> <span class="skolem">sl</span> <span class="main">=</span> map Idle <span class="main">(</span>replicate <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">st2</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>State <span class="skolem">st1</span> <span class="skolem">u1</span> <span class="skolem">c1</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">sl1</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> sl Idle 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">next</span></span>
       <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
       <span class="keyword1"><span class="command">hence</span></span> sl'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">=</span> <span class="main">(</span>Idle <span class="skolem">st</span><span class="main">)</span> <span class="main">#</span> map Idle <span class="main">(</span>replicate <span class="skolem">n'</span> <span class="skolem">st</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>State <span class="skolem">st1</span> <span class="skolem">u1</span> <span class="skolem">c1</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">sl1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">have</span></span> st2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">st2</span> <span class="main">=</span> <span class="skolem">st</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">sl</span> <span class="main">∈</span> δ <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sl' Idle <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">#</span> <span class="skolem">sl</span> <span class="main">=</span> map Idle <span class="main">(</span>replicate <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">st</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>State <span class="skolem">st1</span> <span class="skolem">u1</span> <span class="skolem">c1</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">sl1</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> sl Idle st2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>State <span class="skolem">st1</span> <span class="skolem">u1</span> <span class="skolem">c1</span><span class="main">)</span>
     <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">#</span> <span class="skolem">sl</span> <span class="main">=</span> map Idle <span class="main">(</span>replicate <span class="main">0</span> <span class="skolem">st</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>State <span class="skolem">st1</span> <span class="skolem">u1</span> <span class="skolem">c1</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">sl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_cases3<span class="main">[</span><span class="operator">elim</span><span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Idle State Idle_State<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl</span>"</span></span>
<span class="keyword2"><span class="keyword">obtains</span></span>
<span class="free">n</span> <span class="free">st</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">=</span> map Idle <span class="main">(</span>replicate <span class="free">n</span> <span class="free">st</span><span class="main">)</span>"</span></span>
<span class="main">|</span>
<span class="free">st</span> <span class="free">u</span> <span class="free">c</span> <span class="free">sl1</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">=</span> State <span class="free">st</span> <span class="free">u</span> <span class="free">c</span> <span class="main">#</span> <span class="free">sl1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">sl1</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> wffp <span class="free">sl1</span> <span class="main">∧</span> hd <span class="free">sl1</span> <span class="main">∈</span> δ <span class="main">(</span>State <span class="free">st</span> <span class="free">u</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="main">|</span>
<span class="free">n</span> <span class="free">st</span> <span class="free">u</span> <span class="free">c</span> <span class="free">sl1</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">=</span> map Idle <span class="main">(</span>replicate <span class="free">n</span> <span class="free">st</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>State <span class="main">(</span><span class="free">do</span> <span class="free">st</span> <span class="free">u</span> <span class="free">c</span><span class="main">)</span> <span class="free">u</span> <span class="free">c</span><span class="main">]</span> <span class="main">@</span> <span class="free">sl1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">sl1</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> wffp <span class="free">sl1</span> <span class="main">∧</span> hd <span class="free">sl1</span> <span class="main">∈</span> δ <span class="main">(</span>State <span class="main">(</span><span class="free">do</span> <span class="free">st</span> <span class="free">u</span> <span class="free">c</span><span class="main">)</span> <span class="free">u</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">st</span>
   <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">=</span> map Idle <span class="main">(</span>replicate <span class="skolem">n</span> <span class="skolem">st</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">st</span> <span class="skolem">st1</span> <span class="skolem">u1</span> <span class="skolem">c1</span> <span class="skolem">sl1</span> <span class="keyword3"><span class="command">assume</span></span> sl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">=</span> map Idle <span class="main">(</span>replicate <span class="skolem">n</span> <span class="skolem">st</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>State <span class="skolem">st1</span> <span class="skolem">u1</span> <span class="skolem">c1</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">sl1</span>"</span></span>
   <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl1</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> wffp <span class="skolem">sl1</span> <span class="main">∧</span> hd <span class="skolem">sl1</span> <span class="main">∈</span> δ <span class="main">(</span>State <span class="skolem">st1</span> <span class="skolem">u1</span> <span class="skolem">c1</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_is_Nil_conv assms last.simps not_Cons_self2 sl wffp_append_iff<span class="main">)</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="free">thesis</span></span>
   <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> 0
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">=</span> State <span class="skolem">st1</span> <span class="skolem">u1</span> <span class="skolem">c1</span> <span class="main">#</span> <span class="skolem">sl1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sl <span class="keyword1"><span class="command">unfolding</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> that 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
     <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"replicate <span class="skolem">n</span> <span class="skolem">st</span> <span class="main">=</span> replicate <span class="skolem">n'</span> <span class="skolem">st</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">st</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> replicate_Suc replicate_append_same<span class="main">)</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wffp <span class="main">(</span>map Idle <span class="main">[</span><span class="skolem">st</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>State <span class="skolem">st1</span> <span class="skolem">u1</span> <span class="skolem">c1</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> sl 2 <span class="keyword1"><span class="command">unfolding</span></span> map_append append_assoc
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> append_assoc append_is_Nil_conv append_self_conv
                 append_singl_rev neq_Nil_conv wffp_imp_appendL wffp_imp_appendR<span class="main">)</span>
     <span class="keyword1"><span class="command">hence</span></span> st1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">st1</span> <span class="main">=</span> <span class="free">do</span> <span class="skolem">st</span> <span class="skolem">u1</span> <span class="skolem">c1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wffp.cases<span class="main">)</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sl st1<span class="main">)</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
  <span class="keyword1"><span class="command">using</span></span> wffp_iff_map_Idle<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_cases2<span class="main">[</span><span class="operator">elim</span><span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Idle State<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl</span>"</span></span>
<span class="keyword2"><span class="keyword">obtains</span></span>
<span class="free">n</span> <span class="free">st</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">=</span> map Idle <span class="main">(</span>replicate <span class="free">n</span> <span class="free">st</span><span class="main">)</span>"</span></span>
<span class="main">|</span>
<span class="free">n</span> <span class="free">st</span> <span class="free">st1</span> <span class="free">u</span> <span class="free">c</span> <span class="free">sl1</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">=</span> map Idle <span class="main">(</span>replicate <span class="free">n</span> <span class="free">st</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>State <span class="free">st1</span> <span class="free">u</span> <span class="free">c</span><span class="main">]</span> <span class="main">@</span> <span class="free">sl1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">sl1</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> wffp <span class="free">sl1</span> <span class="main">∧</span> hd <span class="free">sl1</span> <span class="main">∈</span> δ <span class="main">(</span>State <span class="free">st1</span> <span class="free">u</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">sl</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wffp_cases3<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil list.map<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> replicate_0<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_Idle_Idle<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wffp <span class="main">(</span><span class="free">sl1</span> <span class="main">@</span> <span class="main">[</span>Idle <span class="free">st1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Idle <span class="free">st2</span><span class="main">]</span> <span class="main">@</span> <span class="free">sl2</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">st2</span> <span class="main">=</span> <span class="free">st1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wffp <span class="main">[</span>Idle <span class="free">st1</span><span class="main">,</span> Idle <span class="free">st2</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wffp_imp_appendR append_assoc append_singl_rev list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wffp_imp_appendL<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wffp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_Idle_State<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wffp <span class="main">(</span><span class="free">sl1</span> <span class="main">@</span> <span class="main">[</span>Idle <span class="free">st1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>State <span class="free">st2</span> <span class="free">u2</span> <span class="free">c2</span><span class="main">]</span> <span class="main">@</span> <span class="free">sl2</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">st2</span> <span class="main">=</span> <span class="free">st1</span> <span class="main">∨</span> <span class="free">st2</span> <span class="main">=</span> <span class="free">do</span> <span class="free">st1</span> <span class="free">u2</span> <span class="free">c2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wffp <span class="main">[</span>Idle <span class="free">st1</span><span class="main">,</span> State <span class="free">st2</span> <span class="free">u2</span> <span class="free">c2</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wffp_imp_appendR append_assoc append_singl_rev list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wffp_imp_appendL<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wffp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_State_Idle<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wffp <span class="main">(</span><span class="free">sl1</span> <span class="main">@</span> <span class="main">[</span>State <span class="free">st1</span> <span class="free">u1</span> <span class="free">c1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Idle <span class="free">st2</span><span class="main">]</span> <span class="main">@</span> <span class="free">sl2</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">st2</span> <span class="main">=</span> <span class="free">st1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wffp <span class="main">[</span>State <span class="free">st1</span> <span class="free">u1</span> <span class="free">c1</span><span class="main">,</span> Idle <span class="free">st2</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wffp_imp_appendR append_assoc append_singl_rev list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wffp_imp_appendL<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wffp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_State_State<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wffp <span class="main">(</span><span class="free">sl1</span> <span class="main">@</span> <span class="main">[</span>State <span class="free">st1</span> <span class="free">u1</span> <span class="free">c1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>State <span class="free">st2</span> <span class="free">u2</span> <span class="free">c2</span><span class="main">]</span> <span class="main">@</span> <span class="free">sl2</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">st2</span> <span class="main">=</span> <span class="free">do</span> <span class="free">st1</span> <span class="free">u2</span> <span class="free">c2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wffp <span class="main">[</span>State <span class="free">st1</span> <span class="free">u1</span> <span class="free">c1</span><span class="main">,</span> State <span class="free">st2</span> <span class="free">u2</span> <span class="free">c2</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wffp_imp_appendR append_assoc append_singl_rev list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wffp_imp_appendL<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wffp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wfp_to_wffp<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> sl_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">=</span> map fst <span class="main">(</span>stake <span class="free">i</span> <span class="free">π</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> π<span class="main">:</span> <span class="quoted"><span class="quoted">"wfp UNIV <span class="free">π</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"wffp <span class="free">sl</span> <span class="main">∧</span>
 <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="free">sl</span><span class="main">.</span> fst <span class="main">(</span><span class="free">π</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">sl</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span>
 stateOf <span class="free">π</span> <span class="main">=</span> hd <span class="free">sl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> wffp <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> conjI allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"stake <span class="free">i</span> <span class="free">π</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stateOf <span class="free">π</span> <span class="main">=</span> hd <span class="free">sl</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sl_def hd_map<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> sl_def wfp<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nonintSI_nonintS<span class="main">:</span> <span class="quoted"><span class="quoted">"nonintSI <span class="main">⟷</span> nonintS"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> nonintS_def nonintSI_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sl</span> <span class="skolem">sl'</span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  π<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> L <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">sl</span> <span class="main">@-</span> sconst <span class="main">(</span>toSink <span class="main">(</span>last <span class="skolem">sl</span><span class="main">)</span><span class="main">,</span> L <span class="main">(</span>toSink <span class="main">(</span>last <span class="skolem">sl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  π'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> L <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">sl'</span> <span class="main">@-</span> sconst <span class="main">(</span>toSink <span class="main">(</span>last <span class="skolem">sl'</span><span class="main">)</span><span class="main">,</span> L <span class="main">(</span>toSink <span class="main">(</span>last <span class="skolem">sl'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">π</span> <span class="bound">π'</span><span class="main">.</span>
    wfp UNIV <span class="bound">π</span> <span class="main">∧</span> wfp UNIV <span class="bound">π'</span> <span class="main">∧</span> stateOf <span class="bound">π</span> <span class="main">=</span> s0 <span class="main">∧</span> stateOf <span class="bound">π'</span> <span class="main">=</span> s0
    <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≤</span> <span class="bound">i</span><span class="main">.</span> f <span class="main">(</span>fst <span class="main">(</span><span class="bound">π</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">π'</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> g <span class="main">(</span>fst <span class="main">(</span><span class="bound">π</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="bound">π'</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> slsl'<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="skolem">sl</span>"</span></span> <span class="quoted"><span class="quoted">"wffp <span class="skolem">sl'</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">sl</span> <span class="main">=</span> s0"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">sl'</span> <span class="main">=</span> s0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 f <span class="skolem">sl</span> <span class="skolem">sl'</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">sl</span> <span class="main">=</span> length <span class="skolem">sl'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">sl</span><span class="main">.</span> f <span class="main">(</span><span class="skolem">sl</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sl'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_all2_conv_all_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span> <span class="main">=</span> length <span class="skolem">sl</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> slsl'_NE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">sl'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> slsl' wffp_NE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> last<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="skolem">sl</span> <span class="main">=</span> <span class="skolem">sl</span><span class="main">!</span><span class="skolem">i0</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">sl'</span> <span class="main">=</span> <span class="skolem">sl'</span><span class="main">!</span><span class="skolem">i0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i0_def l slsl' last_conv_nth<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> i0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span> <span class="main">&lt;</span> length <span class="skolem">sl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span> <span class="main">&lt;</span> length <span class="skolem">sl'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> i0_def <span class="keyword1"><span class="command">using</span></span> l slsl' slsl'_NE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">≤</span> <span class="skolem">i0</span><span class="main">.</span> f <span class="main">(</span><span class="skolem">sl</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sl'</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i slsl'_NE <span class="keyword1"><span class="command">unfolding</span></span> i0_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_eq_diff_pred Suc_diff_le Zero_neq_Suc diff_is_0_eq'
            le_less_linear length_greater_0_conv<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"g <span class="main">(</span>last <span class="skolem">sl</span><span class="main">)</span> <span class="main">(</span>last <span class="skolem">sl'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> last <span class="keyword1"><span class="command">using</span></span> 0 slsl' j i0
  <span class="keyword1"><span class="command">using</span></span> wffp_to_wfp<span class="main">[</span><span class="operator">OF</span> π<span class="main">]</span> wffp_to_wfp<span class="main">[</span><span class="operator">OF</span> π'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="skolem">π'</span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">sl</span> <span class="bound">sl'</span><span class="main">.</span> wffp <span class="bound">sl</span> <span class="main">∧</span> wffp <span class="bound">sl'</span> <span class="main">∧</span> hd <span class="bound">sl</span> <span class="main">=</span> s0 <span class="main">∧</span> hd <span class="bound">sl'</span> <span class="main">=</span> s0 <span class="main">∧</span> list_all2 f <span class="bound">sl</span> <span class="bound">sl'</span> <span class="main">⟶</span> g <span class="main">(</span>last <span class="bound">sl</span><span class="main">)</span> <span class="main">(</span>last <span class="bound">sl'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ππ'<span class="main">:</span> <span class="quoted"><span class="quoted">"wfp UNIV <span class="skolem">π</span>"</span></span> <span class="quoted"><span class="quoted">"wfp UNIV <span class="skolem">π'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> state<span class="main">:</span> <span class="quoted"><span class="quoted">"stateOf <span class="skolem">π</span> <span class="main">=</span> s0"</span></span> <span class="quoted"><span class="quoted">"stateOf <span class="skolem">π'</span> <span class="main">=</span> s0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="skolem">i</span><span class="main">.</span> f <span class="main">(</span>fst <span class="main">(</span><span class="skolem">π</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">π'</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> R<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">sl</span> <span class="bound">sl'</span><span class="main">.</span> wffp <span class="bound">sl</span> <span class="main">∧</span> wffp <span class="bound">sl'</span> <span class="main">∧</span> hd <span class="bound">sl</span> <span class="main">=</span> s0 <span class="main">∧</span> hd <span class="bound">sl'</span> <span class="main">=</span> s0 <span class="main">∧</span> length <span class="bound">sl</span> <span class="main">=</span> length <span class="bound">sl'</span>
            <span class="main">⟶</span>
            <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="bound">sl</span><span class="main">.</span> f <span class="main">(</span><span class="bound">sl</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="bound">sl'</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> g <span class="main">(</span>last <span class="bound">sl</span><span class="main">)</span> <span class="main">(</span>last <span class="bound">sl'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_all2_conv_all_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span> <span class="main">=</span> Suc <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> i0_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> i0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ii0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">i0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> i0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">i0</span><span class="main">.</span> f <span class="main">(</span>fst <span class="main">(</span><span class="skolem">π</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">π'</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">unfolding</span></span> i0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sl</span></span> <span class="skolem"><span class="skolem">sl'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  sl_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">=</span> map fst <span class="main">(</span>stake <span class="skolem">i0</span> <span class="skolem">π</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sl'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl'</span> <span class="main">=</span> map fst <span class="main">(</span>stake <span class="skolem">i0</span> <span class="skolem">π'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> i0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span> <span class="main">=</span> length <span class="skolem">sl</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">sl'</span> <span class="main">=</span> length <span class="skolem">sl</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> i0_def sl_def sl'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> last <span class="skolem">sl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sl'</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> last <span class="skolem">sl'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> i0 <span class="keyword1"><span class="command">unfolding</span></span> i0_def <span class="keyword1"><span class="command">using</span></span> last_conv_nth length_greater_0_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_Suc_1 i0 i0_ge<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"g <span class="main">(</span>fst <span class="main">(</span><span class="skolem">π</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">π'</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wfp_to_wffp<span class="main">[</span><span class="operator">OF</span> sl_def i0_ge ππ'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> wfp_to_wffp<span class="main">[</span><span class="operator">OF</span> sl'_def i0_ge ππ'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> R state f ii0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 i0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Finally, we show that nonintS is equivalent to standard
noninterference (predicate nonint).›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹purgeIdle removes the idle steps from a finite path:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">purgeIdle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'St</span><span class="main">,</span> <span class="tfree">'U</span><span class="main">,</span> <span class="tfree">'C</span><span class="main">)</span> state list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'St</span><span class="main">,</span> <span class="tfree">'U</span><span class="main">,</span> <span class="tfree">'C</span><span class="main">)</span> state list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">purgeIdle</span> <span class="main">≡</span> filter isState"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> purgeIdle_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"purgeIdle <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="quoted"><span class="quoted">"purgeIdle <span class="main">(</span><span class="main">(</span>Idle <span class="free">st</span><span class="main">)</span> <span class="main">#</span> <span class="free">sl</span><span class="main">)</span> <span class="main">=</span> purgeIdle <span class="free">sl</span>"</span></span>
<span class="quoted"><span class="quoted">"purgeIdle <span class="main">(</span><span class="main">(</span>State <span class="free">st</span> <span class="free">u</span> <span class="free">c</span><span class="main">)</span> <span class="main">#</span> <span class="free">sl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>State <span class="free">st</span> <span class="free">u</span> <span class="free">c</span><span class="main">)</span> <span class="main">#</span> purgeIdle <span class="free">sl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> purgeIdle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> purgeIdle_append<span class="main">:</span>
<span class="quoted"><span class="quoted">"purgeIdle <span class="main">(</span><span class="free">sl1</span> <span class="main">@</span> <span class="free">sl2</span><span class="main">)</span> <span class="main">=</span> purgeIdle <span class="free">sl1</span> <span class="main">@</span> purgeIdle <span class="free">sl2</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> purgeIdle_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> filter_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> purgeIdle_set_isState<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> set <span class="main">(</span>purgeIdle <span class="free">sl</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"isState <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> purgeIdle_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> filter_set member_filter<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> purgeIdle_Nil_iff<span class="main">:</span>
<span class="quoted"><span class="quoted">"purgeIdle <span class="free">sl</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span>set <span class="free">sl</span><span class="main">.</span> <span class="main">¬</span> isState <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> purgeIdle_def filter_empty_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> purgeIdle_Cons_iff<span class="main">:</span>
<span class="quoted"><span class="quoted">"purgeIdle <span class="free">sl</span> <span class="main">=</span> <span class="free">s</span> <span class="main">#</span> <span class="free">sll</span>
 <span class="main">⟷</span>
 <span class="main">(</span><span class="main">∃</span> <span class="bound">sl1</span> <span class="bound">sl2</span><span class="main">.</span> <span class="free">sl</span> <span class="main">=</span> <span class="bound">sl1</span> <span class="main">@</span> <span class="free">s</span> <span class="main">#</span> <span class="bound">sl2</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span><span class="bound">s1</span><span class="main">∈</span>set <span class="bound">sl1</span><span class="main">.</span> <span class="main">¬</span> isState <span class="bound">s1</span><span class="main">)</span> <span class="main">∧</span> isState <span class="free">s</span> <span class="main">∧</span> purgeIdle <span class="bound">sl2</span> <span class="main">=</span> <span class="free">sll</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> purgeIdle_def filter_eq_Cons_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> purgeIdle_map_Idle<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"purgeIdle <span class="main">(</span>map Idle <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> purgeIdle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> purgeIdle_replicate_Idle<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"purgeIdle <span class="main">(</span>replicate <span class="free">n</span> <span class="main">(</span>Idle <span class="free">st</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> purgeIdle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_purgeIdle_Nil<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"purgeIdle <span class="free">sl</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="bound">st</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">sl</span> <span class="main">=</span> replicate <span class="bound">n</span> <span class="main">(</span>Idle <span class="bound">st</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sl</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wffp_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Singl <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">sl</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="keyword2"><span class="keyword">where</span></span> sl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">=</span> replicate <span class="skolem">n</span> <span class="main">(</span>Idle <span class="skolem">st</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st1</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> Idle <span class="skolem">st1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>replicate <span class="skolem">n</span> <span class="main">(</span>Idle <span class="skolem">st</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Idle <span class="skolem">st</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd_replicate replicate_empty sl wffp<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">st</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sl 1 s<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_hd_purgeIdle<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> wsl<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> psl<span class="main">:</span> <span class="quoted"><span class="quoted">"purgeIdle <span class="free">sl</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> ist<span class="main">:</span> <span class="quoted"><span class="quoted">"isState <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hsl<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="free">sl</span> <span class="main">∈</span> δ <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>purgeIdle <span class="free">sl</span><span class="main">)</span> <span class="main">∈</span> δ <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> wsl <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wffp_cases3<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Idle <span class="skolem">n</span> <span class="skolem">st</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> psl <span class="keyword1"><span class="command">unfolding</span></span> Idle <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>State <span class="skolem">st</span> <span class="skolem">u</span> <span class="skolem">c</span> <span class="skolem">sl1</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> psl hsl <span class="keyword1"><span class="command">unfolding</span></span> State <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Idle_State <span class="skolem">n</span> <span class="skolem">st</span> <span class="skolem">u</span> <span class="skolem">c</span> <span class="skolem">sl1</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> psl <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> ist hsl <span class="keyword1"><span class="command">unfolding</span></span> Idle_State purgeIdle_append
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_purgeIdle<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"purgeIdle <span class="free">sl</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wffp <span class="main">(</span>purgeIdle <span class="free">sl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sl</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">sl</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹wffp <span class="skolem">sl</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">sl</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wffp_cases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Idle <span class="skolem">n</span> <span class="skolem">st</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"purgeIdle <span class="skolem">sl</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Idle <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹purgeIdle <span class="skolem">sl</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>State <span class="skolem">n</span> <span class="skolem">st</span> <span class="skolem">st1</span> <span class="skolem">u</span> <span class="skolem">c</span> <span class="skolem">sl1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"purgeIdle <span class="skolem">sl</span> <span class="main">=</span> State <span class="skolem">st1</span> <span class="skolem">u</span> <span class="skolem">c</span> <span class="main">#</span> purgeIdle <span class="skolem">sl1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_replicate <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> purgeIdle_append<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"purgeIdle <span class="skolem">sl1</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> psl1 <span class="main">=</span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 psl1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> sl1NE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl1</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">sl1</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> sl1<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="skolem">sl1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hsl1<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">sl1</span> <span class="main">∈</span> δ <span class="main">(</span>State <span class="skolem">st1</span> <span class="skolem">u</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> State<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">sl1</span> <span class="main">&lt;</span> length <span class="skolem">sl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> State <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> sl1<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="main">(</span>purgeIdle <span class="skolem">sl1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>1<span class="main">)</span> sl1 False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>purgeIdle <span class="skolem">sl1</span><span class="main">)</span> <span class="main">∈</span> δ <span class="main">(</span>State <span class="skolem">st1</span> <span class="skolem">u</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False GM_sec_model.wffp_hd_purgeIdle State<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sl1NE state.discI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> isState_purgeIdle<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">sl</span><span class="main">.</span> purgeIdle <span class="bound">sl</span> <span class="main">=</span> <span class="free">sll</span><span class="main">)</span> <span class="main">⟷</span> list_all isState <span class="free">sll</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> purgeIdle_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ball_set_list_all purgeIdle_def purgeIdle_set_isState filter_True<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_last_purgeIdle<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"purgeIdle <span class="free">sl</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"getGMState <span class="main">(</span>last <span class="main">(</span>purgeIdle <span class="free">sl</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> getGMState <span class="main">(</span>last <span class="free">sl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sl</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wffp_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Singl <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">sl</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> slNE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wffp_NE<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"purgeIdle <span class="skolem">sl</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="keyword2"><span class="keyword">where</span></span> sl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">=</span> replicate <span class="skolem">n</span> <span class="main">(</span>Idle <span class="skolem">st</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.hyps wffp_purgeIdle_Nil<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> slNE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> hsl<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">sl</span> <span class="main">=</span> Idle <span class="skolem">st</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lsl<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="skolem">sl</span> <span class="main">=</span> Idle <span class="skolem">st</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"isState <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"getGMState <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">st</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">sl</span> <span class="main">∈</span> δ <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hsl <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> slNE n 1 hsl lsl s <span class="keyword1"><span class="command">unfolding</span></span> sl purgeIdle_replicate_Idle <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_isState_doo<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all isState <span class="free">sl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"doo <span class="main">(</span>getGMState <span class="main">(</span>hd <span class="free">sl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map getGMUserCom <span class="main">(</span>tl <span class="free">sl</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> getGMState <span class="main">(</span>last <span class="free">sl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sl</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wffp_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">sl</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> State <span class="skolem">st</span> <span class="skolem">u</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span> <span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> sl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sl1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">=</span> hd <span class="skolem">sl</span> <span class="main">#</span> tl <span class="skolem">sl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wffp_NE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹wffp <span class="skolem">sl</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st1</span></span> <span class="skolem"><span class="skolem">u1</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="keyword2"><span class="keyword">where</span></span> hsl<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">sl</span> <span class="main">=</span> State <span class="skolem">st1</span> <span class="skolem">u1</span> <span class="skolem">c1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> isState_purgeIdle isState_def purgeIdle_Cons_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"getGMState <span class="main">(</span>hd <span class="skolem">sl</span><span class="main">)</span> <span class="main">=</span> <span class="free">do</span> <span class="skolem">st</span> <span class="skolem">u1</span> <span class="skolem">c1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">sl</span> <span class="main">∈</span> δ <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hsl s <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"doo <span class="skolem">st</span> <span class="main">(</span>map getGMUserCom <span class="skolem">sl</span><span class="main">)</span> <span class="main">=</span> doo <span class="main">(</span><span class="free">do</span> <span class="skolem">st</span> <span class="skolem">u1</span> <span class="skolem">c1</span><span class="main">)</span> <span class="main">(</span>map getGMUserCom <span class="main">(</span>tl <span class="skolem">sl</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sl1<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 hsl<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> sl Cons <span class="keyword1"><span class="command">unfolding</span></span> 1 s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> isState_hd_purgeIdle<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> wsl<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ist<span class="main">:</span> <span class="quoted"><span class="quoted">"isState <span class="main">(</span>hd <span class="free">sl</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"purgeIdle <span class="free">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="main">(</span>purgeIdle <span class="free">sl</span><span class="main">)</span> <span class="main">=</span> hd <span class="free">sl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> ist
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span> <span class="main">(</span><span class="operator">subst</span> hd_Cons_tl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wffp_NE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wsl<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd <span class="free">sl</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">sl</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wffp_isState_doo_purgeIdle<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sl</span> <span class="keyword2"><span class="keyword">defines</span></span> sll<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sll</span> <span class="main">≡</span> purgeIdle <span class="free">sl</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> wsl<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ist<span class="main">:</span> <span class="quoted"><span class="quoted">"isState <span class="main">(</span>hd <span class="free">sl</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"doo <span class="main">(</span>getGMState <span class="main">(</span>hd <span class="free">sl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map getGMUserCom <span class="main">(</span>tl <span class="free">sll</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> getGMState <span class="main">(</span>last <span class="free">sl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> isState_hd_purgeIdle<span class="main">[</span><span class="operator">OF</span> wsl ist<span class="main">]</span>
  <span class="keyword1"><span class="command">hence</span></span> wsll<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="free">sll</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sll wffp_purgeIdle wsl<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"doo <span class="main">(</span>getGMState <span class="main">(</span>hd <span class="free">sll</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map getGMUserCom <span class="main">(</span>tl <span class="free">sll</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> getGMState <span class="main">(</span>last <span class="free">sll</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wffp_isState_doo isState_purgeIdle sll<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 1 sll wffp_last_purgeIdle wsl<span class="main">)</span>
 <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_getGMUserCom_surj<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"isState <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">sl</span><span class="main">.</span> wffp <span class="bound">sl</span> <span class="main">∧</span> list_all isState <span class="bound">sl</span> <span class="main">∧</span> hd <span class="bound">sl</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> map getGMUserCom <span class="main">(</span>tl <span class="bound">sl</span><span class="main">)</span> <span class="main">=</span> <span class="free">ucl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ucl</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_pair_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="skolem"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">u</span> <span class="skolem">c</span> <span class="skolem">ucl</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st1</span></span> <span class="skolem"><span class="skolem">u1</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> State <span class="skolem">st1</span> <span class="skolem">u1</span> <span class="skolem">c1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">=</span> State <span class="main">(</span><span class="free">do</span> <span class="skolem">st1</span> <span class="skolem">u</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">u</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sl</span></span> <span class="keyword2"><span class="keyword">where</span></span> sl<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="skolem">sl</span> <span class="main">∧</span> list_all isState <span class="skolem">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hsl<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">sl</span> <span class="main">=</span> <span class="skolem">s1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> msl<span class="main">:</span> <span class="quoted"><span class="quoted">"map getGMUserCom <span class="main">(</span>tl <span class="skolem">sl</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ucl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> s1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> s s1_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">sl</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> purgeIdle_purge_ex<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all isState <span class="free">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"map getGMUserCom <span class="main">(</span>tl <span class="free">sl</span><span class="main">)</span> <span class="main">=</span> <span class="free">ucl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">sl'</span><span class="main">.</span> hd <span class="bound">sl'</span> <span class="main">=</span> <span class="free">ss'</span> <span class="main">∧</span> wffp <span class="bound">sl'</span> <span class="main">∧</span>
              list_all2 f <span class="main">(</span>tl <span class="free">sl</span><span class="main">)</span> <span class="main">(</span>tl <span class="bound">sl'</span><span class="main">)</span> <span class="main">∧</span>
              map getGMUserCom <span class="main">(</span>purgeIdle <span class="main">(</span>tl <span class="bound">sl'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> purge <span class="free">GH</span> <span class="free">ucl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sl</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ucl</span></span> <span class="quoted"><span class="free">ss'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wffp_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Singl <span class="skolem">s</span> <span class="skolem">ucl</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="skolem"><span class="skolem">ss'</span></span><span class="main"><span class="main">]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ss'</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">ss</span> <span class="skolem">sl</span> <span class="skolem">ucl</span> <span class="skolem">ss'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> wsl <span class="main">=</span> <span class="quoted"><span class="quoted">‹wffp <span class="skolem">sl</span>›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> slNE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wffp_NE<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">sl1</span></span> <span class="keyword2"><span class="keyword">where</span></span> sl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">sl1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wffp_NE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹wffp <span class="skolem">sl</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">sl</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> State <span class="skolem">st</span> <span class="skolem">u</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ucl1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ucl1</span> <span class="main">=</span> tl <span class="skolem">ucl</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ucl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ucl</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ucl1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hsl<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">sl</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> s ucl1_def sl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all isState <span class="skolem">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"map getGMUserCom <span class="main">(</span>tl <span class="skolem">sl</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ucl1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">unfolding</span></span> ucl1_def s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st'</span> <span class="main">=</span> getGMState <span class="skolem">ss'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">GH</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> u <span class="main">=</span> True
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'St</span><span class="main">,</span> <span class="tfree">'U</span><span class="main">,</span> <span class="tfree">'C</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> Idle <span class="skolem">st'</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sl'</span></span> <span class="keyword2"><span class="keyword">where</span></span> hsl'<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">sl'</span> <span class="main">=</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wsl'<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="skolem">sl'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> slsl'<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 f <span class="main">(</span>tl <span class="skolem">sl</span><span class="main">)</span> <span class="main">(</span>tl <span class="skolem">sl'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"map getGMUserCom <span class="main">(</span>purgeIdle <span class="main">(</span>tl <span class="skolem">sl'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> purge <span class="free">GH</span> <span class="skolem">ucl1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> sl'NE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wffp_NE<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wffp <span class="main">(</span><span class="skolem">ss'</span> <span class="main">#</span> <span class="skolem">sl'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wsl' hsl' <span class="keyword1"><span class="command">unfolding</span></span> s'_def st'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ss'</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"f <span class="skolem">s</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u <span class="keyword1"><span class="command">unfolding</span></span> s'_def st'_def s f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all2 f <span class="skolem">sl</span> <span class="skolem">sl'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> slsl' hsl hsl' slNE sl'NE
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> list_all2_Cons neq_Nil_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map getGMUserCom <span class="main">(</span>purgeIdle <span class="skolem">sl'</span><span class="main">)</span> <span class="main">=</span> purge <span class="free">GH</span> <span class="skolem">ucl</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> hd_Cons_tl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sl'NE<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hsl' ucl s'_def u m<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">ss'</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">sl'</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> u <span class="main">=</span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> State <span class="main">(</span><span class="free">do</span> <span class="skolem">st'</span> <span class="skolem">u</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">u</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sl'</span></span> <span class="keyword2"><span class="keyword">where</span></span> hsl'<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">sl'</span> <span class="main">=</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wsl'<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="skolem">sl'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> slsl'<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 f <span class="main">(</span>tl <span class="skolem">sl</span><span class="main">)</span> <span class="main">(</span>tl <span class="skolem">sl'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"map getGMUserCom <span class="main">(</span>purgeIdle <span class="main">(</span>tl <span class="skolem">sl'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> purge <span class="free">GH</span> <span class="skolem">ucl1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> sl'NE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wffp_NE<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wffp <span class="main">(</span><span class="skolem">ss'</span> <span class="main">#</span> <span class="skolem">sl'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wsl' hsl' <span class="keyword1"><span class="command">unfolding</span></span> s'_def st'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ss'</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"f <span class="skolem">s</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s'_def st'_def s f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all2 f <span class="skolem">sl</span> <span class="skolem">sl'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> slsl' hsl hsl' slNE sl'NE
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> list_all2_Cons neq_Nil_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map getGMUserCom <span class="main">(</span>purgeIdle <span class="skolem">sl'</span><span class="main">)</span> <span class="main">=</span> purge <span class="free">GH</span> <span class="skolem">ucl</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> hd_Cons_tl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sl'NE<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hsl' ucl s'_def u m<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">ss'</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">sl'</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> purgeIdle_getGMUserCom_purge<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sl</span> <span class="free">sl'</span>
<span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ucl</span> <span class="main">≡</span> map getGMUserCom <span class="main">(</span>purgeIdle <span class="main">(</span>tl <span class="free">sl</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ucl'</span> <span class="main">≡</span> map getGMUserCom <span class="main">(</span>purgeIdle <span class="main">(</span>tl <span class="free">sl'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> wsl<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wsl'<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="free">sl'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 f <span class="free">sl</span> <span class="free">sl'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"purge <span class="free">GH</span> <span class="free">ucl</span> <span class="main">=</span> purge <span class="free">GH</span> <span class="free">ucl'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">sl</span> <span class="main">=</span> length <span class="free">sl'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_all2_lengthD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ucl</span></span> <span class="quoted"><span class="free">ucl'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">sl</span> <span class="skolem">s'</span> <span class="skolem">sl'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sl'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> sl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">=</span> hd <span class="skolem">sl</span> <span class="main">#</span> tl <span class="skolem">sl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">sl</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> sl'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl'</span> <span class="main">=</span> hd <span class="skolem">sl'</span> <span class="main">#</span> tl <span class="skolem">sl'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">sl</span> <span class="main">=</span> length <span class="skolem">sl'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">sl'</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> wsl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="skolem">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wsl'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="skolem">sl'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sl Cons
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems append_singl_rev list.distinct sl' wffp_imp_appendR<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"f <span class="main">(</span>hd <span class="skolem">sl</span><span class="main">)</span> <span class="main">(</span>hd <span class="skolem">sl'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 f <span class="main">(</span><span class="skolem">s</span> <span class="main">#</span> <span class="skolem">sl</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s'</span> <span class="main">#</span> <span class="skolem">sl'</span><span class="main">)</span>›</span></span> sl sl'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_all2_Cons<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">sl</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Idle <span class="skolem">st</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> hsl <span class="main">=</span> Idle
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">sl'</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Idle <span class="skolem">st'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> hsl' <span class="main">=</span> Idle
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> sl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sl'<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">unfolding</span></span> hsl hsl' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>State <span class="skolem">st'</span> <span class="skolem">u'</span> <span class="skolem">c'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> hsl' <span class="main">=</span> State
          <span class="keyword1"><span class="command">have</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> <span class="free">GH</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">unfolding</span></span> hsl hsl' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> sl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sl'<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> Cons u' <span class="keyword1"><span class="command">unfolding</span></span> hsl hsl' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>State <span class="skolem">st</span> <span class="skolem">u</span> <span class="skolem">c</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> hsl <span class="main">=</span> State
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">sl'</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Idle <span class="skolem">st'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> hsl' <span class="main">=</span> Idle
          <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">GH</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">unfolding</span></span> hsl hsl' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> sl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sl'<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> Cons u <span class="keyword1"><span class="command">unfolding</span></span> hsl hsl' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>State <span class="skolem">st'</span> <span class="skolem">u'</span> <span class="skolem">c'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> hsl' <span class="main">=</span> State
          <span class="keyword1"><span class="command">have</span></span> uu'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u'</span> <span class="main">∈</span> <span class="free">GH</span> <span class="main">⟷</span> <span class="skolem">u</span> <span class="main">∈</span> <span class="free">GH</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">∉</span> <span class="free">GH</span> <span class="main">⟶</span> <span class="skolem">u'</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">unfolding</span></span> hsl hsl' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> sl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sl'<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> Cons uu' <span class="keyword1"><span class="command">unfolding</span></span> hsl hsl' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">GH</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonintS_iff_nonint<span class="main">:</span>
<span class="quoted"><span class="quoted">"nonintS <span class="main">⟷</span> nonint"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> nonintS_def nonint_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ucl</span> <span class="skolem">u</span>
  <span class="keyword3"><span class="command">assume</span></span>
  1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sl</span> <span class="bound">sl'</span><span class="main">.</span> wffp <span class="bound">sl</span> <span class="main">∧</span> wffp <span class="bound">sl'</span> <span class="main">∧</span> hd <span class="bound">sl</span> <span class="main">=</span> s0 <span class="main">∧</span> hd <span class="bound">sl'</span> <span class="main">=</span> s0 <span class="main">∧</span> list_all2 f <span class="bound">sl</span> <span class="bound">sl'</span> <span class="main">⟶</span>
               g <span class="main">(</span>last <span class="bound">sl</span><span class="main">)</span> <span class="main">(</span>last <span class="bound">sl'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">GL</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sl</span></span> <span class="keyword2"><span class="keyword">where</span></span> wsl<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="skolem">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all isState <span class="skolem">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hsl<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">sl</span> <span class="main">=</span> s0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"map getGMUserCom <span class="main">(</span>tl <span class="skolem">sl</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ucl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> map_getGMUserCom_surj<span class="main">[</span><span class="operator">of</span> <span class="quoted">s0</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sl'</span></span> <span class="keyword2"><span class="keyword">where</span></span> hsl'<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">sl'</span> <span class="main">=</span> hd <span class="skolem">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wsl'<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="skolem">sl'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 f <span class="main">(</span>tl <span class="skolem">sl</span><span class="main">)</span> <span class="main">(</span>tl <span class="skolem">sl'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> m'<span class="main">:</span> <span class="quoted"><span class="quoted">"map getGMUserCom <span class="main">(</span>purgeIdle <span class="main">(</span>tl <span class="skolem">sl'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> purge <span class="free">GH</span> <span class="skolem">ucl</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> purgeIdle_purge_ex<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> slNE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sl'NE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sl'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wsl wsl' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wffp_NE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"getGMState <span class="main">(</span>hd <span class="skolem">sl</span><span class="main">)</span> <span class="main">=</span> <span class="free">st0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hsl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>purgeIdle <span class="skolem">sl'</span><span class="main">)</span> <span class="main">=</span> purgeIdle <span class="main">(</span>tl <span class="skolem">sl'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> hd_Cons_tl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sl'NE<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> hd_Cons_tl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sl'NE<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> hsl hsl' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 f <span class="skolem">sl</span> <span class="skolem">sl'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> hd_Cons_tl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> slNE<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> hd_Cons_tl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sl'NE<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> f hsl' <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"g <span class="main">(</span>last <span class="skolem">sl</span><span class="main">)</span> <span class="main">(</span>last <span class="skolem">sl'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 wsl wsl' hsl hsl' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"getGMState <span class="main">(</span>last <span class="skolem">sl</span><span class="main">)</span> <span class="main">=</span> doo <span class="free">st0</span> <span class="skolem">ucl</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> m<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 2<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> wffp_isState_doo<span class="main">[</span><span class="operator">OF</span> wsl l<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"getGMState <span class="main">(</span>last <span class="skolem">sl'</span><span class="main">)</span> <span class="main">=</span> doo <span class="free">st0</span> <span class="main">(</span>purge <span class="free">GH</span> <span class="skolem">ucl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wffp_isState_doo_purgeIdle<span class="main">[</span><span class="operator">OF</span> wsl'<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> hsl' hsl m' 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">(</span>doo <span class="free">st0</span> <span class="skolem">ucl</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>doo <span class="free">st0</span> <span class="main">(</span>purge <span class="free">GH</span> <span class="skolem">ucl</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">using</span></span> u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sl</span> <span class="skolem">sl'</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ucl</span><span class="main">.</span> <span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="free">GL</span><span class="main">.</span> <span class="free">out</span> <span class="main">(</span>doo <span class="free">st0</span> <span class="bound">ucl</span><span class="main">)</span> <span class="bound">u</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>doo <span class="free">st0</span> <span class="main">(</span>purge <span class="free">GH</span> <span class="bound">ucl</span><span class="main">)</span><span class="main">)</span> <span class="bound">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> wsl<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="skolem">sl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wsl'<span class="main">:</span> <span class="quoted"><span class="quoted">"wffp <span class="skolem">sl'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hsl<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">sl</span> <span class="main">=</span> s0"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hsl'<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">sl'</span> <span class="main">=</span> s0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 f <span class="skolem">sl</span> <span class="skolem">sl'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ucl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ucl</span> <span class="main">=</span> map getGMUserCom <span class="main">(</span>tl <span class="main">(</span>purgeIdle <span class="skolem">sl</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ucl'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ucl'</span> <span class="main">=</span> map getGMUserCom <span class="main">(</span>tl <span class="main">(</span>purgeIdle <span class="skolem">sl'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>purgeIdle <span class="skolem">sl</span><span class="main">)</span> <span class="main">=</span> purgeIdle <span class="main">(</span>tl <span class="skolem">sl</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>purgeIdle <span class="skolem">sl'</span><span class="main">)</span> <span class="main">=</span> purgeIdle <span class="main">(</span>tl <span class="skolem">sl'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> hd_Cons_tl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wffp_NE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wsl<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> hsl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
     <span class="main">(</span><span class="operator">subst</span> hd_Cons_tl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wffp_NE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wsl'<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> hsl'<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"purge <span class="free">GH</span> <span class="skolem">ucl</span> <span class="main">=</span> purge <span class="free">GH</span> <span class="skolem">ucl'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ucl_def ucl'_def 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> purgeIdle_getGMUserCom_purge f wsl wsl'<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"getGMState <span class="main">(</span>last <span class="skolem">sl</span><span class="main">)</span> <span class="main">=</span> doo <span class="free">st0</span> <span class="skolem">ucl</span> <span class="main">∧</span> getGMState <span class="main">(</span>last <span class="skolem">sl'</span><span class="main">)</span> <span class="main">=</span> doo <span class="free">st0</span> <span class="skolem">ucl'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wffp_isState_doo_purgeIdle<span class="main">[</span><span class="operator">OF</span> wsl<span class="main">]</span> wffp_isState_doo_purgeIdle<span class="main">[</span><span class="operator">OF</span> wsl'<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> hsl hsl' ucl_def ucl'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"g <span class="main">(</span>last <span class="skolem">sl</span><span class="main">)</span> <span class="main">(</span>last <span class="skolem">sl'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> nonintSfmla_iff_nonint<span class="main">:</span>
<span class="quoted"><span class="quoted">"nonintSfmla <span class="main">[]</span> <span class="main">⟷</span> nonint"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nonintSI_nonintS nonintS_iff_nonint nonintSfmla_nonintSI<span class="main">)</span>


<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context GM_sec_model *)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹end-of-context GM-sec-model›</span></span>


<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Deep">
<div class="head">
<h1>Theory Deep</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deep representation of HyperCTL* -- syntax and semantics›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Deep
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Shallow.html">Shallow</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Infinite_Set.html">HOL-Library.Infinite_Set</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Path variables and environments›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> pvar <span class="main">=</span> Pvariable <span class="main">(</span><span class="free"><span class="entity">natOf</span></span> <span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Deeply embedded (syntactic) formulas›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'aprop</span> dfmla <span class="main">=</span>
  Atom <span class="tfree"><span class="quoted"><span class="tfree">'aprop</span></span></span> <span class="quoted">pvar</span> <span class="main">|</span>
  Fls <span class="main">|</span> Neg <span class="quoted"><span class="quoted">"<span class="tfree">'aprop</span> dfmla"</span></span> <span class="main">|</span> Dis <span class="quoted"><span class="quoted">"<span class="tfree">'aprop</span> dfmla"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'aprop</span> dfmla"</span></span> <span class="main">|</span>
  Next <span class="quoted"><span class="quoted">"<span class="tfree">'aprop</span> dfmla"</span></span> <span class="main">|</span> Until <span class="quoted"><span class="quoted">"<span class="tfree">'aprop</span> dfmla"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'aprop</span> dfmla"</span></span> <span class="main">|</span>
  Exi <span class="quoted">pvar</span> <span class="quoted"><span class="quoted">"<span class="tfree">'aprop</span> dfmla"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Derived operators›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tr</span> <span class="main">≡</span> Neg Fls"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Con</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> Neg <span class="main">(</span>Dis <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Imp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> Dis <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Eq</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> Con <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> "</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fall</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> Neg <span class="main">(</span>Exi <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ev</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> Until Tr <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Alw</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> Neg <span class="main">(</span>Ev <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Wuntil</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> Dis <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>Alw <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Fall2</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> Fall <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Fall <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> der_Op_defs <span class="main">=</span>
Tr_def Con_def Imp_def Eq_def Ev_def Alw_def Wuntil_def Fall_def Fall2_def

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Well-formed formulas are those that do not have a temporal operator
outside the scope of any quantifier -- indeed, in HyperCTL* such a situation does not make sense, 
since the temporal operators refer to previously introduced/quantified paths.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">wff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'aprop</span> dfmla <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">wff</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">wff</span> Fls <span class="main">=</span> True"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">wff</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">wff</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">wff</span> <span class="main">(</span>Dis <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">wff</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">wff</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">wff</span> <span class="main">(</span>Next <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">wff</span> <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">wff</span> <span class="main">(</span>Exi <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The ability to pick a fresh variable›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_fresh_pvar<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">P</span> <span class="main">::</span> pvar set<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>natOf <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms finite_imageI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∉</span> natOf <span class="main">`</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> unbounded_k_infinite<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Pvariable <span class="skolem">n</span> <span class="main">∉</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageI pvar.sel<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">getFresh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pvar set <span class="main">⇒</span> pvar"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">getFresh</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> getFresh<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"getFresh <span class="free">P</span> <span class="main">∉</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms exE_some finite_fresh_pvar getFresh_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The free-variables operator›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">FV</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'aprop</span> dfmla <span class="main">⇒</span> pvar set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">FV</span> Fls <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>Dis <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>Next <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>Exi <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Environments›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> env <span class="main">=</span> <span class="quoted"><span class="quoted">"pvar <span class="main">⇒</span> nat"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eqOn</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">env1</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">p</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">env1</span></span></span> <span class="bound">p</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eqOn_Un<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"eqOn <span class="main">(</span><span class="free">P</span> <span class="main">∪</span> <span class="free">Q</span><span class="main">)</span> <span class="free">env</span> <span class="free">env1</span> <span class="main">⟷</span> eqOn <span class="free">P</span> <span class="free">env</span> <span class="free">env1</span> <span class="main">∧</span> eqOn <span class="free">Q</span> <span class="free">env</span> <span class="free">env1</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> eqOn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eqOn_update<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"eqOn <span class="free">P</span> <span class="main">(</span><span class="free">env</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">env1</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> eqOn <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="free">env</span> <span class="free">env1</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> eqOn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eqOn_singl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"eqOn <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="free">env</span> <span class="free">env1</span> <span class="main">⟷</span> <span class="free">env</span> <span class="free">p</span> <span class="main">=</span> <span class="free">env1</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> eqOn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">context</span></span> Shallow
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The semantic operator›</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The semantics will interpret deep (syntactic) formulas as shallow formulas.
Recall that the latter are predicates on lists of paths -- the interpretation will
be parameterized by an environment mapping each path variable to a number indicating
the index (in the list) for the path denoted by the variable.

The semantics will only
be meaningful if the indexes of a formula's free variables are smaller than the length
of the path list -- we call this property ``compatibility''.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">sem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'aprop</span> dfmla <span class="main">⇒</span> env <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> sfmla"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">sem</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> atom <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">sem</span> Fls <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> fls"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">sem</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> neg <span class="main">(</span><span class="free">sem</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">sem</span> <span class="main">(</span>Dis <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> dis <span class="main">(</span><span class="free">sem</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">sem</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">sem</span> <span class="main">(</span>Next <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> next <span class="main">(</span><span class="free">sem</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">sem</span> <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> until <span class="main">(</span><span class="free">sem</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">sem</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">sem</span> <span class="main">(</span>Exi <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> exi <span class="main">(</span><span class="main">λ</span> <span class="bound">π</span> <span class="bound">πl</span><span class="main">.</span> <span class="free">sem</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> length <span class="bound">πl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">πl</span> <span class="main">@</span> <span class="main">[</span><span class="bound">π</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sem_Exi_explicit<span class="main">:</span>
<span class="quoted"><span class="quoted">"sem <span class="main">(</span>Exi <span class="free">p</span> <span class="free">φ</span><span class="main">)</span> <span class="free">env</span> <span class="free">πl</span> <span class="main">⟷</span>
 <span class="main">(</span><span class="main">∃</span> <span class="bound">π</span><span class="main">.</span> wfp <span class="free">AP'</span> <span class="bound">π</span> <span class="main">∧</span> stateOf <span class="bound">π</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">πl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="keyword1">then</span> stateOf <span class="main">(</span>last <span class="free">πl</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">s0</span><span class="main">)</span> <span class="main">∧</span>
       sem <span class="free">φ</span> <span class="main">(</span><span class="free">env</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> length <span class="free">πl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">πl</span> <span class="main">@</span> <span class="main">[</span><span class="bound">π</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> sem.simps
<span class="keyword1"><span class="command">unfolding</span></span> exi_def <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sem_derived<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"sem Tr <span class="free">env</span> <span class="main">=</span> tr"</span></span>
 <span class="quoted"><span class="quoted">"sem <span class="main">(</span>Con <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> con <span class="main">(</span>sem <span class="free">φ</span> <span class="free">env</span><span class="main">)</span> <span class="main">(</span>sem <span class="free">ψ</span> <span class="free">env</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"sem <span class="main">(</span>Imp <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> imp <span class="main">(</span>sem <span class="free">φ</span> <span class="free">env</span><span class="main">)</span> <span class="main">(</span>sem <span class="free">ψ</span> <span class="free">env</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"sem <span class="main">(</span>Eq <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> eq <span class="main">(</span>sem <span class="free">φ</span> <span class="free">env</span><span class="main">)</span> <span class="main">(</span>sem <span class="free">ψ</span> <span class="free">env</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"sem <span class="main">(</span>Fall <span class="free">p</span> <span class="free">φ</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> fall <span class="main">(</span><span class="main">λ</span> <span class="bound">π</span> <span class="bound">πl</span><span class="main">.</span> sem <span class="free">φ</span> <span class="main">(</span><span class="free">env</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> length <span class="bound">πl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">πl</span> <span class="main">@</span> <span class="main">[</span><span class="bound">π</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"sem <span class="main">(</span>Ev <span class="free">φ</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> ev <span class="main">(</span>sem <span class="free">φ</span> <span class="free">env</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"sem <span class="main">(</span>Alw <span class="free">φ</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> alw <span class="main">(</span>sem <span class="free">φ</span> <span class="free">env</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"sem <span class="main">(</span>Wuntil <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> wuntil <span class="main">(</span>sem <span class="free">φ</span> <span class="free">env</span><span class="main">)</span> <span class="main">(</span>sem <span class="free">ψ</span> <span class="free">env</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> der_Op_defs der_op_defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neg_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sem_Fall2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"sem <span class="main">(</span>Fall2 <span class="free">p</span> <span class="free">p'</span> <span class="free">φ</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span>
 fall2 <span class="main">(</span><span class="main">λ</span> <span class="bound">π'</span> <span class="bound">π</span> <span class="bound">πl</span><span class="main">.</span> sem <span class="free">φ</span> <span class="main">(</span><span class="free">env</span> <span class="main">(</span><span class="free">p</span> <span class="main">:=</span> length <span class="bound">πl</span><span class="main">,</span> <span class="free">p'</span> <span class="main">:=</span> Suc<span class="main">(</span>length <span class="bound">πl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">πl</span> <span class="main">@</span> <span class="main">[</span><span class="bound">π</span><span class="main">,</span><span class="bound">π'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Fall2_def fall2_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fall_def exi_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> neg_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Compatibility of a pair (environment,path list) on a set of variables means
no out-or-range references:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cpt</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">p</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">πl</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cpt_Un<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"cpt <span class="main">(</span><span class="free">P</span> <span class="main">∪</span> <span class="free">Q</span><span class="main">)</span> <span class="free">env</span> <span class="free">πl</span> <span class="main">⟷</span> cpt <span class="free">P</span> <span class="free">env</span> <span class="free">πl</span> <span class="main">∧</span> cpt <span class="free">Q</span> <span class="free">env</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cpt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cpt_singl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"cpt <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="free">env</span> <span class="free">πl</span> <span class="main">⟷</span> <span class="free">env</span> <span class="free">p</span> <span class="main">&lt;</span> length <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cpt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cpt_map_stl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"cpt <span class="free">P</span> <span class="free">env</span> <span class="free">πl</span> <span class="main">⟹</span> cpt <span class="free">P</span> <span class="free">env</span> <span class="main">(</span>map stl <span class="free">πl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cpt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we prove that the semantics of well-formed formulas only depends on the interpretation
of the free variables of a formula and on the current state of the last recorded path --
we call the latter the ``pointer'' of the path list.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pointerOf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> path list <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pointerOf</span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="keyword1">then</span> stateOf <span class="main">(</span>last <span class="free"><span class="bound"><span class="entity">πl</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">s0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Equality of two pairs (environment,path list) on a set of variables:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eqOn</span> <span class="main">::</span>
<span class="quoted"><span class="quoted">"pvar set <span class="main">⇒</span> env <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> path list <span class="main">⇒</span> env <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span><span class="tfree">'aprop</span><span class="main">)</span> path list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">eqOn</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span> <span class="free"><span class="bound"><span class="entity">env1</span></span></span> <span class="free"><span class="bound"><span class="entity">πl1</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">πl</span></span></span><span class="main">!</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">πl1</span></span></span><span class="main">!</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">env1</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eqOn_Un<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"eqOn <span class="main">(</span><span class="free">P</span> <span class="main">∪</span> <span class="free">Q</span><span class="main">)</span> <span class="free">env</span> <span class="free">πl</span> <span class="free">env1</span> <span class="free">πl1</span> <span class="main">⟷</span> eqOn <span class="free">P</span> <span class="free">env</span> <span class="free">πl</span> <span class="free">env1</span> <span class="free">πl1</span> <span class="main">∧</span> eqOn <span class="free">Q</span> <span class="free">env</span> <span class="free">πl</span> <span class="free">env1</span> <span class="free">πl1</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> eqOn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eqOn_singl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"eqOn <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="free">env</span> <span class="free">πl</span> <span class="free">env1</span> <span class="free">πl1</span> <span class="main">⟷</span> <span class="free">πl</span><span class="main">!</span><span class="main">(</span><span class="free">env</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">πl1</span><span class="main">!</span><span class="main">(</span><span class="free">env1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> eqOn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eqOn_map_stl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"cpt <span class="free">P</span> <span class="free">env</span> <span class="free">πl</span> <span class="main">⟹</span> cpt <span class="free">P</span> <span class="free">env1</span> <span class="free">πl1</span> <span class="main">⟹</span>
 eqOn <span class="free">P</span> <span class="free">env</span> <span class="free">πl</span> <span class="free">env1</span> <span class="free">πl1</span> <span class="main">⟹</span> eqOn <span class="free">P</span> <span class="free">env</span> <span class="main">(</span>map stl <span class="free">πl</span><span class="main">)</span> <span class="free">env1</span> <span class="main">(</span>map stl <span class="free">πl1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> eqOn_def cpt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cpt_map_sdrop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"cpt <span class="free">P</span> <span class="free">env</span> <span class="free">πl</span> <span class="main">⟹</span> cpt <span class="free">P</span> <span class="free">env</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="free">i</span><span class="main">)</span> <span class="free">πl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cpt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cpt_update<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cpt <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="free">env</span> <span class="free">πl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cpt <span class="free">P</span> <span class="main">(</span><span class="free">env</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> length <span class="free">πl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">πl</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> cpt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> Diff_iff less_SucI singleton_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eqOn_map_sdrop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"cpt <span class="free">V</span> <span class="free">env</span> <span class="free">πl</span> <span class="main">⟹</span> cpt <span class="free">V</span> <span class="free">env1</span> <span class="free">πl1</span> <span class="main">⟹</span>
 eqOn <span class="free">V</span> <span class="free">env</span> <span class="free">πl</span> <span class="free">env1</span> <span class="free">πl1</span> <span class="main">⟹</span> eqOn <span class="free">V</span> <span class="free">env</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="free">i</span><span class="main">)</span> <span class="free">πl</span><span class="main">)</span> <span class="free">env1</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="free">i</span><span class="main">)</span> <span class="free">πl1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> eqOn_def cpt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eqOn_update<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cpt <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="free">env</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cpt <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="free">env1</span> <span class="free">πl1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"eqOn <span class="free">P</span> <span class="main">(</span><span class="free">env</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> length <span class="free">πl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">πl</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">env1</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> length <span class="free">πl1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">πl1</span> <span class="main">@</span> <span class="main">[</span><span class="free">π</span><span class="main">]</span><span class="main">)</span>
 <span class="main">⟷</span>
 eqOn <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="free">env</span> <span class="free">πl</span> <span class="free">env1</span> <span class="free">πl1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eqOn_def cpt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> DiffI nth_append singleton_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eqOn_FV_sem_NE<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cpt <span class="main">(</span>FV <span class="free">φ</span><span class="main">)</span> <span class="free">env</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cpt <span class="main">(</span>FV <span class="free">φ</span><span class="main">)</span> <span class="free">env1</span> <span class="free">πl1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eqOn <span class="main">(</span>FV <span class="free">φ</span><span class="main">)</span> <span class="free">env</span> <span class="free">πl</span> <span class="free">env1</span> <span class="free">πl1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">πl</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">πl1</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"last <span class="free">πl</span> <span class="main">=</span> last <span class="free">πl1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sem <span class="free">φ</span> <span class="free">env</span> <span class="free">πl</span> <span class="main">=</span> sem <span class="free">φ</span> <span class="free">env1</span> <span class="free">πl1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quoted"><span class="free">πl</span></span> <span class="quoted"><span class="free">env1</span></span> <span class="quoted"><span class="free">πl1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until <span class="skolem">φ</span> <span class="skolem">ψ</span> <span class="skolem">env</span> <span class="skolem">πl</span> <span class="skolem">env1</span> <span class="skolem">πl1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> sem <span class="skolem">φ</span> <span class="skolem">env</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="bound">i</span><span class="main">)</span> <span class="skolem">πl</span><span class="main">)</span> <span class="main">=</span> sem <span class="skolem">φ</span> <span class="skolem">env1</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="bound">i</span><span class="main">)</span> <span class="skolem">πl1</span><span class="main">)</span> <span class="main">∧</span>
              sem <span class="skolem">ψ</span> <span class="skolem">env</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="bound">i</span><span class="main">)</span> <span class="skolem">πl</span><span class="main">)</span> <span class="main">=</span> sem <span class="skolem">ψ</span> <span class="skolem">env1</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="bound">i</span><span class="main">)</span> <span class="skolem">πl1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Until <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last_map<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> op_defs<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exi <span class="skolem">p</span> <span class="skolem">φ</span> <span class="skolem">env</span> <span class="skolem">πl</span> <span class="skolem">env1</span> <span class="skolem">πl1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">π</span><span class="main">.</span> cpt <span class="main">(</span>FV <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">env</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> length <span class="skolem">πl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">πl</span> <span class="main">@</span> <span class="main">[</span><span class="bound">π</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
         cpt <span class="main">(</span>FV <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">env1</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> length <span class="skolem">πl1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">πl1</span> <span class="main">@</span> <span class="main">[</span><span class="bound">π</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
         eqOn <span class="main">(</span>FV <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">env</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> length <span class="skolem">πl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">πl</span> <span class="main">@</span> <span class="main">[</span><span class="bound">π</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">env1</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> length <span class="skolem">πl1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">πl1</span> <span class="main">@</span> <span class="main">[</span><span class="bound">π</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sem.simps exi_def <span class="keyword1"><span class="command">using</span></span> Exi
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iff_exI<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> append_is_Nil_conv last_snoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last_map op_defs<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The next theorem states that the semantics of a formula on an environment
and a list of paths only depends on the pointer of the list of paths.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> eqOn_FV_sem<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wff <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pointerOf <span class="free">πl</span> <span class="main">=</span> pointerOf <span class="free">πl1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cpt <span class="main">(</span>FV <span class="free">φ</span><span class="main">)</span> <span class="free">env</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cpt <span class="main">(</span>FV <span class="free">φ</span><span class="main">)</span> <span class="free">env1</span> <span class="free">πl1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eqOn <span class="main">(</span>FV <span class="free">φ</span><span class="main">)</span> <span class="free">env</span> <span class="free">πl</span> <span class="free">env1</span> <span class="free">πl1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sem <span class="free">φ</span> <span class="free">env</span> <span class="free">πl</span> <span class="main">=</span> sem <span class="free">φ</span> <span class="free">env1</span> <span class="free">πl1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quoted"><span class="free">πl</span></span> <span class="quoted"><span class="free">env1</span></span> <span class="quoted"><span class="free">πl1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until <span class="skolem">φ</span> <span class="skolem">ψ</span> <span class="skolem">env</span> <span class="skolem">πl</span> <span class="skolem">env1</span> <span class="skolem">πl1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> sem <span class="skolem">φ</span> <span class="skolem">env</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="bound">i</span><span class="main">)</span> <span class="skolem">πl</span><span class="main">)</span> <span class="main">=</span> sem <span class="skolem">φ</span> <span class="skolem">env1</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="bound">i</span><span class="main">)</span> <span class="skolem">πl1</span><span class="main">)</span> <span class="main">∧</span>
              sem <span class="skolem">ψ</span> <span class="skolem">env</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="bound">i</span><span class="main">)</span> <span class="skolem">πl</span><span class="main">)</span> <span class="main">=</span> sem <span class="skolem">ψ</span> <span class="skolem">env1</span> <span class="main">(</span>map <span class="main">(</span>sdrop <span class="bound">i</span><span class="main">)</span> <span class="skolem">πl1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Until <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last_map<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> op_defs<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exi <span class="skolem">p</span> <span class="skolem">φ</span> <span class="skolem">env</span> <span class="skolem">πl</span> <span class="skolem">env1</span> <span class="skolem">πl1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">π</span><span class="main">.</span> sem <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">env</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> length <span class="skolem">πl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">πl</span> <span class="main">@</span> <span class="main">[</span><span class="bound">π</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
             sem <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">env1</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> length <span class="skolem">πl1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">πl1</span> <span class="main">@</span> <span class="main">[</span><span class="bound">π</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eqOn_FV_sem_NE<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> Exi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sem.simps exi_def <span class="keyword1"><span class="command">using</span></span> Exi <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iff_exI conj_cong<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last_map op_defs<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> FV_sem<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wff <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> FV <span class="free">φ</span><span class="main">.</span> <span class="free">env</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">env1</span> <span class="bound">p</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cpt <span class="main">(</span>FV <span class="free">φ</span><span class="main">)</span> <span class="free">env</span> <span class="free">πl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cpt <span class="main">(</span>FV <span class="free">φ</span><span class="main">)</span> <span class="free">env1</span> <span class="free">πl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sem <span class="free">φ</span> <span class="free">env</span> <span class="free">πl</span> <span class="main">=</span> sem <span class="free">φ</span> <span class="free">env1</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eqOn_FV_sem<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eqOn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹As a consequence, the interpretation of a closed formula (i.e., a formula
with no free variables) will not depend on the environment and, from the
list of paths, will only depend on its pointer:›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> interp_closed<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wff <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"FV <span class="free">φ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pointerOf <span class="free">πl</span> <span class="main">=</span> pointerOf <span class="free">πl1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sem <span class="free">φ</span> <span class="free">env</span> <span class="free">πl</span> <span class="main">=</span> sem <span class="free">φ</span> <span class="free">env1</span> <span class="free">πl1</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eqOn_FV_sem<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eqOn_def cpt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Therefore, it makes sense to define the interpretation of a closed formula
by choosing any environment and any list of paths such that its pointer is the initial state
(e.g., the empty list) -- knowing that the choices are irrelevant.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">semClosed</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> sem <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>any<span class="main">::</span>env<span class="main">)</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">πl</span><span class="main">.</span> pointerOf <span class="bound">πl</span> <span class="main">=</span> <span class="free">s0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> semClosed<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"wff <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"FV <span class="free">φ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"pointerOf <span class="free">πl</span> <span class="main">=</span> <span class="free">s0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"semClosed <span class="free">φ</span> <span class="main">=</span> sem <span class="free">φ</span> <span class="free">env</span> <span class="free">πl</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pointerOf <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">πl</span><span class="main">.</span> pointerOf <span class="bound">πl</span> <span class="main">=</span> <span class="free">s0</span><span class="main">)</span> <span class="main">=</span> <span class="free">s0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> semClosed_def <span class="keyword1"><span class="command">using</span></span> interp_closed<span class="main">[</span><span class="operator">OF</span> φ<span class="main">]</span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> semClosed_Nil<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"wff <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"FV <span class="free">φ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"semClosed <span class="free">φ</span> <span class="main">=</span> sem <span class="free">φ</span> <span class="free">env</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms semClosed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>



<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹The conjunction of a finite set of formulas›</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This is defined by making the set into a list (by choosing any ordering of the
elements) and iterating binary conjunction.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Scon</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'aprop</span> dfmla set <span class="main">⇒</span> <span class="tfree">'aprop</span> dfmla"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Scon</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">≡</span> foldr Con <span class="main">(</span>asList <span class="free"><span class="bound"><span class="entity">φs</span></span></span><span class="main">)</span> Tr"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sem_Scon<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">φs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sem <span class="main">(</span>Scon <span class="free">φs</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> scon <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">φ</span><span class="main">.</span> sem <span class="bound">φ</span> <span class="free">env</span><span class="main">)</span> <span class="main">`</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φl</span> <span class="main">=</span> asList <span class="free">φs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sem <span class="main">(</span>foldr Con <span class="skolem">φl</span> Tr<span class="main">)</span> <span class="free">env</span> <span class="main">=</span> scon <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">φ</span><span class="main">.</span> sem <span class="bound">φ</span> <span class="free">env</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="skolem">φl</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">φl</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scon_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> φl_def Scon_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms set_asList<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> FV_Scon<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">φs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FV <span class="main">(</span>Scon <span class="free">φs</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>FV <span class="main">`</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φl</span> <span class="main">=</span> asList <span class="free">φs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FV <span class="main">(</span>foldr Con <span class="skolem">φl</span> Tr<span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map FV <span class="skolem">φl</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">φl</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> der_Op_defs<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> φl_def Scon_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms set_map set_asList<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context Shallow  *)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹end-of-context Shallow›</span></span>


<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Finite_Noninterference">
<div class="head">
<h1>Theory Finite_Noninterference</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Noninterference for models with finitely many users, commands and outputs›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Finite_Noninterference
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Noninterference.html">Noninterference</a> <a href="Deep.html">Deep</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In the Noninterference section, we showed how to express Goguen-Meseguer
noninterference as a shallow HyperCTL* formula.  Here we show that, if one assumes
finiteness of the sets of users, commands and outputs,
then one can express the property as (the denotation of) a syntactic formula.
Note that we do {\em not} need to assume the state space finite -- this is
important for a potential application to infinite-state systems.›</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The Goguen-Meseguer security model with finiteness assumptions›</span></span>

<span class="keyword1"><span class="command">locale</span></span> GM_sec_model_finite <span class="main">=</span> GM_sec_model <span class="quoted"><span class="free">st0</span></span> <span class="quoted"><span class="free">do</span></span> <span class="quoted"><span class="free">out</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">st0</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'St</span></span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">do</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'St</span> <span class="main">⇒</span> <span class="tfree">'U</span> <span class="main">⇒</span> <span class="tfree">'C</span> <span class="main">⇒</span> <span class="tfree">'St</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">out</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'St</span> <span class="main">⇒</span> <span class="tfree">'U</span> <span class="main">⇒</span> <span class="tfree">'Out</span>"</span></span>
  <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_U<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'U</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finite_C<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'C</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finite_Out<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'Out</span> set<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_UminusGH<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">-</span> <span class="free">GH</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_Diff finite_U<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_GL<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">GL</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_UNIV finite_Diff2 finite_U<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EqOnUC</span> <span class="main">::</span>
<span class="quoted"><span class="quoted">"pvar <span class="main">⇒</span> pvar <span class="main">⇒</span> <span class="tfree">'U</span> <span class="main">⇒</span> <span class="tfree">'C</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">,</span><span class="tfree">'Out</span><span class="main">)</span> aprop dfmla"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">EqOnUC</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> Eq <span class="main">(</span>Atom <span class="main">(</span>Last <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Atom <span class="main">(</span>Last <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> EqOnUC_eqOnUC<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="free">p</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">i'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sem <span class="main">(</span>EqOnUC <span class="free">p</span> <span class="free">p'</span> <span class="free">u</span> <span class="free">c</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> eqOnUC <span class="free">i</span> <span class="free">i'</span> <span class="free">u</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> EqOnUC_def eqOnUC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EqButGH</span> <span class="main">::</span>
<span class="quoted"><span class="quoted">"pvar <span class="main">⇒</span> pvar <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">,</span><span class="tfree">'Out</span><span class="main">)</span> aprop dfmla"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">EqButGH</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="main">≡</span> Scon <span class="main">{</span>EqOnUC <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="bound">u</span> <span class="bound">c</span> <span class="main">|</span> <span class="bound">u</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="free">GH</span><span class="main">)</span> <span class="main">×</span> UNIV<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_EqButGH<span class="main">:</span>
<span class="quoted"><span class="quoted">"finite <span class="main">{</span>EqOnUC <span class="free">p</span> <span class="free">p'</span> <span class="bound">u</span> <span class="bound">c</span> <span class="main">|</span> <span class="bound">u</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="free">GH</span><span class="main">)</span> <span class="main">×</span> UNIV<span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?K</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?K</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> EqOnUC <span class="free">p</span> <span class="free">p'</span> <span class="bound">u</span> <span class="bound">c</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">(</span>UNIV <span class="main">-</span> <span class="free">GH</span><span class="main">)</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> finite_imageI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_C finite_SigmaI finite_UminusGH<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> EqButGH_eqButGH<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="free">p</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">i'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sem <span class="main">(</span>EqButGH <span class="free">p</span> <span class="free">p'</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> eqButGH <span class="free">i</span> <span class="free">i'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms finite_EqButGH
<span class="keyword1"><span class="command">unfolding</span></span> EqButGH_def eqButGH_def sem_Scon<span class="main">[</span><span class="operator">OF</span> finite_EqButGH<span class="main">]</span> image_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> EqOnUC_eqOnUC<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> FV_EqButGH<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="main">(</span>EqButGH <span class="free">p</span> <span class="free">p'</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">p</span><span class="main">,</span><span class="free">p'</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">{</span>FV <span class="main">(</span>EqOnUC <span class="free">p</span> <span class="free">p'</span> <span class="bound">u</span> <span class="bound">c</span><span class="main">)</span> <span class="main">|</span> <span class="bound">u</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="free">GH</span><span class="main">)</span> <span class="main">×</span> UNIV<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> EqButGH_def FV_Scon<span class="main">[</span><span class="operator">OF</span> finite_EqButGH<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> EqOnUC_def der_Op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EqOnUOut</span> <span class="main">::</span>
<span class="quoted"><span class="quoted">"pvar <span class="main">⇒</span> pvar <span class="main">⇒</span> <span class="tfree">'U</span> <span class="main">⇒</span> <span class="tfree">'Out</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">,</span><span class="tfree">'Out</span><span class="main">)</span> aprop dfmla"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">EqOnUOut</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">ou</span></span></span> <span class="main">≡</span> Eq <span class="main">(</span>Atom <span class="main">(</span>Obs <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">ou</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Atom <span class="main">(</span>Obs <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">ou</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> EqOnUOut_eqOnUOut<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="free">p</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">i'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sem <span class="main">(</span>EqOnUOut <span class="free">p</span> <span class="free">p'</span> <span class="free">u</span> <span class="free">ou</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> eqOnUOut <span class="free">i</span> <span class="free">i'</span> <span class="free">u</span> <span class="free">ou</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> EqOnUOut_def eqOnUOut_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EqOnGL</span> <span class="main">::</span>
<span class="quoted"><span class="quoted">"pvar <span class="main">⇒</span> pvar <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">,</span><span class="tfree">'Out</span><span class="main">)</span> aprop dfmla"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">EqOnGL</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="main">≡</span> Scon <span class="main">{</span>EqOnUOut <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="bound">u</span> <span class="bound">ou</span> <span class="main">|</span> <span class="bound">u</span> <span class="bound">ou</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">ou</span><span class="main">)</span> <span class="main">∈</span> <span class="free">GL</span> <span class="main">×</span> UNIV<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_EqOnGL<span class="main">:</span>
<span class="quoted"><span class="quoted">"finite <span class="main">{</span>EqOnUOut <span class="free">p</span> <span class="free">p'</span> <span class="bound">u</span> <span class="bound">ou</span> <span class="main">|</span> <span class="bound">u</span> <span class="bound">ou</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">ou</span><span class="main">)</span> <span class="main">∈</span> <span class="free">GL</span> <span class="main">×</span> UNIV<span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?K</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?K</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">ou</span><span class="main">)</span><span class="main">.</span> EqOnUOut <span class="free">p</span> <span class="free">p'</span> <span class="bound">u</span> <span class="bound">ou</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">GL</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> finite_imageI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_Out finite_SigmaI finite_GL<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> EqOnGL_eqOnGL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="free">p</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">i'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sem <span class="main">(</span>EqOnGL <span class="free">p</span> <span class="free">p'</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> eqOnGL <span class="free">i</span> <span class="free">i'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms finite_EqOnGL
<span class="keyword1"><span class="command">unfolding</span></span> EqOnGL_def eqOnGL_def sem_Scon<span class="main">[</span><span class="operator">OF</span> finite_EqOnGL<span class="main">]</span> image_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> EqOnUOut_eqOnUOut<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> FV_EqOnGL<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="main">(</span>EqOnGL <span class="free">p</span> <span class="free">p'</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">p</span><span class="main">,</span><span class="free">p'</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">{</span>FV <span class="main">(</span>EqOnUOut <span class="free">p</span> <span class="free">p'</span> <span class="bound">u</span> <span class="bound">ou</span><span class="main">)</span> <span class="main">|</span> <span class="bound">u</span> <span class="bound">ou</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">ou</span><span class="main">)</span> <span class="main">∈</span> <span class="free">GL</span> <span class="main">×</span> UNIV<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> EqOnGL_def FV_Scon<span class="main">[</span><span class="operator">OF</span> finite_EqOnGL<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> EqOnUOut_def der_Op_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">p0</span> <span class="main">=</span> getFresh <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">=</span> getFresh <span class="main">{</span>p0<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> p0p1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"p0 <span class="main">≠</span> p1"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p1_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_cancel getFresh infinite_imp_nonempty infinite_remove insertI1<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nonintDfmla</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'U</span><span class="main">,</span><span class="tfree">'C</span><span class="main">,</span><span class="tfree">'Out</span><span class="main">)</span> aprop dfmla"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nonintDfmla</span> <span class="main">≡</span>
 Fall2 p0 p1 <span class="main">(</span>Imp <span class="main">(</span>Alw <span class="main">(</span>EqButGH p0 p1<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Alw <span class="main">(</span>EqOnGL p0 p1<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sem_nonintDfmla<span class="main">:</span> <span class="quoted"><span class="quoted">"sem nonintDfmla <span class="free">env</span> <span class="main">=</span> nonintSfmla"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> nonintDfmla_def nonintSfmla_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> wff_nonintDfmla<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wff nonintDfmla"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> nonintDfmla_def Fall2_def Fall_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> closed_nonintDfmla<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"FV nonintDfmla <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> nonintDfmla_def Fall2_def Fall_def der_Op_defs
<span class="keyword1"><span class="command">using</span></span> FV_EqButGH FV_EqOnGL <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In the end, we obtain that the semantics of the closed (syntactic) formula
nonintDfmla expresses noninterference faithfully:›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> semClosed_nonintDfmla<span class="main">:</span> <span class="quoted"><span class="quoted">"semClosed nonintDfmla <span class="main">=</span> nonint"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> nonintSfmla_iff_nonint<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> sem_nonintDfmla<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> semClosed_Nil<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>



<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context GM_sec_model_finite  *)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹end-of-context GM-sec-model-finite›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="HyperCTL">
<div class="head">
<h1>Theory HyperCTL</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Hyper CTL*›</span></span>
<span class="keyword1"><span class="command">theory</span></span> HyperCTL
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Finite_Noninterference.html">Finite_Noninterference</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>



<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div>