<div id="MC">
<div class="head">
<h1>Theory MC</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Kripke structures and CTL"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We apply Kripke structures and CTL to model state based systems and analyse properties under 
dynamic state changes. Snapshots of systems are the states on which we define a state transition. 
Temporal logic is then employed to express security and privacy properties.›</span></span>
<span class="keyword1"><span class="command">theory</span></span> MC
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Lemmas to support least and greatest fixpoints"</span></span>

<span class="keyword1" id="MC-predtrans_empty"><span class="command">lemma</span></span> predtrans_empty<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="free">τ</span> <span class="main">::</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span><span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms funpow_decreasing le_add1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MC-ex_card"><span class="command">lemma</span></span> ex_card<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">n</span><span class="main">::</span> nat<span class="main">.</span> card <span class="free">S</span> <span class="main">=</span> <span class="bound">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="MC-less_not_le"><span class="command">lemma</span></span> less_not_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">x</span><span class="main">::</span> nat<span class="main">)</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">;</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>

<span class="keyword1" id="MC-infchain_outruns_all"><span class="command">lemma</span></span> infchain_outruns_all<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">::</span> nat<span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">::</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">{}</span><span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⊂</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span> <span class="main">::</span> nat<span class="main">.</span> <span class="main">∃</span><span class="bound">i</span> <span class="main">::</span> nat<span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">j</span></span></span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bot.not_eq_extremum card_gt_0_iff finite_subset subset_UNIV<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span> <span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">{}</span><span class="main">)</span> 
             <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">n</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="skolem">n</span>
      <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> Suc <span class="skolem">n</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> finite_subset le_less_trans le_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> psubset_card_mono subset_UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MC-no_infinite_subset_chain"><span class="command">lemma</span></span> no_infinite_subset_chain<span class="main">:</span> 
   <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="free">τ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">::</span> nat<span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">::</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">{}</span> <span class="main">⊂</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">{}</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof idea: since <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"UNIV"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is finite, we have from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹ex_card›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that there is
    an n with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"card UNIV <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">n</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Now, use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹infchain_outruns_all›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to show as 
    contradiction point that
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∃</span></span> <span class="bound"><span class="bound">i</span></span> <span class="main"><span class="main">::</span></span> nat<span class="main"><span class="main">.</span></span> card UNIV <span class="main"><span class="main">&lt;</span></span> card <span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">τ</span></span> <span class="main"><span class="main">^^</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">{}</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
    Since all sets are subsets of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"UNIV"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we also have 
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"card <span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">τ</span></span> <span class="main"><span class="main">^^</span></span> <span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">{}</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">≤</span></span> card UNIV"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
    Contradiction!, i.e. proof of False  ›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">j</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="main">(</span><span class="bound">i</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">j</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">&lt;</span> card<span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span><span class="main">(</span><span class="main">{}</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> τ <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> infchain_outruns_all<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="main">(</span><span class="bound">n</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> card<span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">=</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> S <span class="main"><span class="main">=</span></span> <span class="quoted">UNIV</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ex_card<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"card<span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span>   d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> card UNIV <span class="main">&lt;</span> card <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"card UNIV"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card<span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span><span class="main">{}</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span><span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Finite_Set.card_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_UNIV<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> e
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"card<span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span><span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> less_not_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MC-finite_fixp"><span class="command">lemma</span></span> finite_fixp<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite<span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="free">τ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span><span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof idea: 
with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">predtrans_empty</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> we know 

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∀</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">τ</span></span> <span class="main"><span class="main">^^</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">{}</span></span> <span class="main"><span class="main">⊆</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">τ</span></span> <span class="main"><span class="main">^^</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">i</span></span> <span class="main"><span class="main">+</span></span> <span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">{}</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (1).

If we can additionally show 

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∃</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">.</span></span>  <span class="main"><span class="main">(</span></span><span class="free"><span class="free">τ</span></span> <span class="main"><span class="main">^^</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">{}</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">⊇</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">τ</span></span> <span class="main"><span class="main">^^</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">i</span></span> <span class="main"><span class="main">+</span></span> <span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">{}</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (2),

we can get the goal together with equalityI 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⊆ + ⊇ ⟶ ="</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
To prove (1) we observe that 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">τ</span></span> <span class="main"><span class="main">^^</span></span> <span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">{}</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">⊇</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">τ</span></span> <span class="main"><span class="main">^^</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">i</span></span> <span class="main"><span class="main">+</span></span> <span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">{}</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
can be inferred from 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">¬</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">τ</span></span> <span class="main"><span class="main">^^</span></span> <span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">{}</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">⊆</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">τ</span></span> <span class="main"><span class="main">^^</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">i</span></span> <span class="main"><span class="main">+</span></span> <span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">{}</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
and (1).
Finally, the latter is solved directly by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹no_infinite_subset_chain›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">{}</span><span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> predtrans_empty<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="main">::</span> nat<span class="main">.</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">{}</span> <span class="main">⊂</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span><span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">{}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> no_infinite_subset_chain<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">i</span> <span class="main">::</span> nat<span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">{}</span> <span class="main">⊂</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span><span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms a3
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span><span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MC-predtrans_UNIV"><span class="command">lemma</span></span> predtrans_UNIV<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="free">τ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>UNIV<span class="main">)</span> <span class="main">⊇</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span><span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">(</span>UNIV<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">i</span></span></span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="main">(</span><span class="main">0</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV <span class="main">⊆</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span> <span class="bound">n</span><span class="main">.</span>
       <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV <span class="main">⊆</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> UNIV <span class="main">⟹</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span>Suc <span class="bound">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV <span class="main">⊆</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> Suc <span class="bound">n</span><span class="main">)</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV <span class="main">⊆</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">τ</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="main">⊇</span> <span class="main">(</span><span class="free">τ</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms a
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monoE<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV <span class="main">⊆</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> Suc <span class="skolem">n</span><span class="main">)</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MC-Suc_less_le"><span class="command">lemma</span></span> Suc_less_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">y</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="free">y</span> <span class="main">-</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="MC-card_univ_subtract"><span class="command">lemma</span></span> card_univ_subtract<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"mono <span class="free">τ</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">::</span> nat<span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">::</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">^^</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⊂</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> UNIV<span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="main">::</span> nat<span class="main">.</span> card<span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>UNIV <span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">i</span></span></span></span><span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> UNIV<span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span> <span class="bound">n</span><span class="main">.</span>
       card <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">-</span> <span class="bound">n</span> <span class="main">⟹</span>
       card <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> Suc <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">-</span> Suc <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">-</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⊂</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> UNIV"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card<span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> card<span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span>"</span></span>       
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> psubset_card_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> finite_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subset_UNIV<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> b<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">-</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MC-card_UNIV_tau_i_below_zero"><span class="command">lemma</span></span> card_UNIV_tau_i_below_zero<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">τ</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">::</span> nat<span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span> <span class="main">^^</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⊂</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> UNIV<span class="main">)</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card<span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span>card <span class="main">(</span>UNIV <span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>UNIV <span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="main">::</span> nat<span class="main">.</span> card<span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>UNIV <span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_univ_subtract<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card<span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span>card <span class="main">(</span>UNIV <span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>UNIV <span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>UNIV <span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MC-finite_card_zero_empty"><span class="command">lemma</span></span> finite_card_zero_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">S</span><span class="main">;</span> card <span class="free">S</span> <span class="main">≤</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="MC-UNIV_tau_i_is_empty"><span class="command">lemma</span></span> UNIV_tau_i_is_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="free">τ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">::</span> nat<span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">::</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">^^</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⊂</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> UNIV<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span>card <span class="main">(</span>UNIV <span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>UNIV <span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms card_UNIV_tau_i_below_zero finite_card_zero_empty finite_subset subset_UNIV<span class="main">)</span>

<span class="keyword1" id="MC-down_chain_reaches_empty"><span class="command">lemma</span></span> down_chain_reaches_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="free">τ</span> <span class="main">::</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">::</span> nat<span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">τ</span> <span class="main">::</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">^^</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV <span class="main">⊂</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> UNIV<span class="main">)</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="main">(</span><span class="bound">j</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">j</span><span class="main">)</span> UNIV <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> UNIV_tau_i_is_empty assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MC-no_infinite_subset_chain2"><span class="command">lemma</span></span> no_infinite_subset_chain2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="free">τ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">::</span> nat<span class="main">.</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> UNIV <span class="main">⊃</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">j</span> <span class="main">::</span> nat<span class="main">.</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">j</span><span class="main">)</span> UNIV <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> down_chain_reaches_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="skolem">j</span><span class="main">)</span> UNIV <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV <span class="main">⊂</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="skolem">j</span><span class="main">)</span> UNIV"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MC-finite_fixp2"><span class="command">lemma</span></span> finite_fixp2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite<span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="free">τ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> UNIV <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span><span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV <span class="main">⊆</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> UNIV"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> predtrans_UNIV <span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>  
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV <span class="main">⊂</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> UNIV"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="main">::</span> nat<span class="main">.</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> UNIV <span class="main">⊃</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span><span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> UNIV<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> no_infinite_subset_chain2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV <span class="main">⊂</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> UNIV <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span><span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MC-lfp_loop"><span class="command">lemma</span></span> lfp_loop<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="free">τ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'b</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="main">.</span> lfp <span class="free">τ</span>  <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{}</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_fixp<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lfp <span class="free">τ</span> <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">{}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> lfp_Kleene_iter<span class="main">)</span>
   <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="main">.</span> lfp <span class="free">τ</span>  <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">{}</span>"</span></span> 
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These next two are repeated from the corresponding
   theorems in HOL/ZF/Nat.thy for the sake of self-containedness of the exposition.›</span></span>
<span class="keyword1" id="MC-Kleene_iter_gpfp"><span class="command">lemma</span></span> Kleene_iter_gpfp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="free">k</span><span class="main">)</span> <span class="main">(</span>top<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>order_top<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Suc
  <span class="keyword1"><span class="command">from</span></span> monoD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc<span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MC-gfp_loop"><span class="command">lemma</span></span> gfp_loop<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="free">τ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'b</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="main">.</span> gfp <span class="free">τ</span>  <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span>UNIV"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span><span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_fixp2<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span>UNIV <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="main">.</span> gfp <span class="free">τ</span>  <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span>UNIV"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 gfp_Kleene_iter<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generic type of state with state transition and CTL operators›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The system states and their transition relation are defined as a class called
 <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹state›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> containing an abstract constant<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹state_transition›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. It introduces the 
syntactic infix notation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹I →<span class="hidden">⇩</span><sub>i</sub> I'›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to denote that system state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹I›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹I’›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
are in this relation over an arbitrary (polymorphic) type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹'a›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">class</span></span> state <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">state_transition</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span> <span class="main">::</span> type<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span></span></span>"</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The above class definition lifts Kripke structures and CTL to a general level. 
The definition of the inductive relation is given by a set of specific rules which are, 
however, part of an application like infrastructures. Branching time temporal logic CTL 
is defined in general over Kripke structures with arbitrary state transitions and can later 
be applied to suitable theories, like infrastructures.
Based on the generic state transition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹→›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of the type class state, the CTL-operators 
EX and AX express that property f holds in some or all next states, respectively.›</span></span> 
    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">AX</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">AX</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">f0</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">f0</span><span class="main">}</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EX'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">EX'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">f0</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">f0</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The CTL formula <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹AG f›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> means that on all paths branching from a state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹s›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
the formula <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹f›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is always true (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹G›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> stands for ‘globally’). It can be defined 
using the Tarski fixpoint theory by applying the greatest fixpoint operator. In a similar way, 
the other CTL operators are defined.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">AF</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">AF</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> lfp <span class="main">(</span><span class="main">λ</span> <span class="bound">Z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∪</span> AX <span class="bound">Z</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EF</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">EF</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> lfp <span class="main">(</span><span class="main">λ</span> <span class="bound">Z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∪</span> EX' <span class="bound">Z</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">AG</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">AG</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> gfp <span class="main">(</span><span class="main">λ</span> <span class="bound">Z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∩</span> AX <span class="bound">Z</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EG</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">EG</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> gfp <span class="main">(</span><span class="main">λ</span> <span class="bound">Z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∩</span> EX' <span class="bound">Z</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">AU</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">AU</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">≡</span> lfp<span class="main">(</span><span class="main">λ</span> <span class="bound">Z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">∪</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="main">∩</span> AX <span class="bound">Z</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EU</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">EU</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">≡</span> lfp<span class="main">(</span><span class="main">λ</span> <span class="bound">Z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">∪</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="main">∩</span> EX' <span class="bound">Z</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">AR</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">AR</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">≡</span> gfp<span class="main">(</span><span class="main">λ</span> <span class="bound">Z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">∩</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="main">∪</span> AX <span class="bound">Z</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ER</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ER</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">≡</span> gfp<span class="main">(</span><span class="main">λ</span> <span class="bound">Z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">∩</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="main">∪</span> EX' <span class="bound">Z</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span>  <span class="quoted"><span class="plain_text">‹Kripke structures and Modelchecking›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> kripke <span class="main">=</span> 
  Kripke <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">states</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">states</span> <span class="main">(</span>Kripke <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span> 
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">init</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">(</span>Kripke <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The formal Isabelle definition of what it means that formula f holds 
in a Kripke structure M can be stated as: the initial states of the Kripke 
structure init M need to be contained in the set of all states states M that 
imply f.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _"</span> 50<span class="main">)</span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">(</span>init <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">s</span></span> <span class="main">∈</span> <span class="main">(</span>states <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">state_transition_refl</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>i</sub>*</span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> state_transition <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas for CTL operators›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹EF lemmas›</span></span>
<span class="keyword1" id="MC-EF_lem0"><span class="command">lemma</span></span> EF_lem0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> EF <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">∪</span> EX' <span class="main">(</span>lfp <span class="main">(</span><span class="main">λ</span><span class="bound">Z</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> state<span class="main">)</span> set<span class="main">.</span> <span class="free">f</span> <span class="main">∪</span> EX' <span class="bound">Z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span><span class="main">λ</span><span class="bound">Z</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> state<span class="main">)</span> set<span class="main">.</span> <span class="free">f</span> <span class="main">∪</span> EX' <span class="bound">Z</span><span class="main">)</span> <span class="main">=</span> 
                    <span class="free">f</span> <span class="main">∪</span> <span class="main">(</span>EX' <span class="main">(</span>lfp <span class="main">(</span><span class="main">λ</span><span class="bound">Z</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">.</span> <span class="free">f</span> <span class="main">∪</span> EX' <span class="bound">Z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> def_lfp_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> reflexive<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> mono_def EX'_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> EF <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> state<span class="main">)</span> set<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">∪</span> EX' <span class="main">(</span>lfp <span class="main">(</span><span class="main">λ</span><span class="bound">Z</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> state<span class="main">)</span> set<span class="main">.</span> <span class="free">f</span> <span class="main">∪</span> EX' <span class="bound">Z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EF_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MC-EF_lem00"><span class="command">lemma</span></span> EF_lem00<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>EF <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">∪</span> EX' <span class="main">(</span>lfp <span class="main">(</span><span class="main">λ</span> <span class="bound">Z</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> state<span class="main">)</span> set<span class="main">.</span> <span class="free">f</span> <span class="main">∪</span> EX' <span class="bound">Z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EF_lem0<span class="main">)</span>

<span class="keyword1" id="MC-EF_lem000"><span class="command">lemma</span></span> EF_lem000<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>EF <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">∪</span> EX' <span class="main">(</span>EF <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> EF_def EF_lem00<span class="main">)</span>

<span class="keyword1" id="MC-EF_lem1"><span class="command">lemma</span></span> EF_lem1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>EX' <span class="main">(</span>EF <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> EF <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EF_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> EX' <span class="main">(</span>lfp <span class="main">(</span><span class="main">λ</span><span class="bound">Z</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">.</span> <span class="free">f</span> <span class="main">∪</span> EX' <span class="bound">Z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> lfp <span class="main">(</span><span class="main">λ</span><span class="bound">Z</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">.</span> <span class="free">f</span> <span class="main">∪</span> EX' <span class="bound">Z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span><span class="main">λ</span><span class="bound">Z</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> state<span class="main">)</span> set<span class="main">.</span> <span class="free">f</span> <span class="main">∪</span> EX' <span class="bound">Z</span><span class="main">)</span> <span class="main">=</span>
                    <span class="free">f</span> <span class="main">∪</span> <span class="main">(</span>EX' <span class="main">(</span>lfp <span class="main">(</span><span class="main">λ</span><span class="bound">Z</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> state<span class="main">)</span> set<span class="main">.</span> <span class="free">f</span> <span class="main">∪</span> EX' <span class="bound">Z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> EF_def EF_lem00 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> lfp <span class="main">(</span><span class="main">λ</span><span class="bound">Z</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">.</span> <span class="free">f</span> <span class="main">∪</span> EX' <span class="bound">Z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> b<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>   
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MC-EF_lem2b"><span class="command">lemma</span></span> EF_lem2b<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>EX' <span class="main">(</span>EF <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> EF <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EF_lem1 assms<span class="main">)</span>

<span class="keyword1" id="MC-EF_lem2a"><span class="command">lemma</span></span> EF_lem2a<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> EF <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EF_lem1 assms<span class="main">)</span>

<span class="keyword1" id="MC-EF_lem2c"><span class="command">lemma</span></span> EF_lem2c<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> EF <span class="main">(</span><span class="main">-</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EF_lem1 assms<span class="main">)</span>

<span class="keyword1" id="MC-EF_lem2d"><span class="command">lemma</span></span> EF_lem2d<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> EF <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> EF_lem1 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="MC-EF_lem3b"><span class="command">lemma</span></span> EF_lem3b<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> EX' <span class="main">(</span><span class="free">f</span> <span class="main">∪</span> EX' <span class="main">(</span>EF <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>EF <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> EF_lem000 EF_lem2b assms<span class="main">)</span>

<span class="keyword1" id="MC-EX_lem0l"><span class="command">lemma</span></span> EX_lem0l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>EX' <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>EX' <span class="main">(</span><span class="free">f</span> <span class="main">∪</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EX'_def<span class="main">)</span>

<span class="keyword1" id="MC-EX_lem0r"><span class="command">lemma</span></span> EX_lem0r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>EX' <span class="free">g</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>EX' <span class="main">(</span><span class="free">f</span> <span class="main">∪</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EX'_def<span class="main">)</span>

<span class="keyword1" id="MC-EX_step"><span class="command">lemma</span></span> EX_step<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span>  <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> EX' <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EX'_def<span class="main">)</span>

<span class="keyword1" id="MC-EF_E"><span class="command">lemma</span></span> EF_E<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">f</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>EF <span class="bound">f</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="bound">f</span> <span class="main">∪</span> EX' <span class="main">(</span>EF <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> EF_lem000 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MC-EF_step"><span class="command">lemma</span></span> EF_step<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span>  <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> EF <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> EF_lem3b EX_step assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MC-EF_step_step"><span class="command">lemma</span></span> EF_step_step<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span>  <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> EF <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> EF <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> EF_lem2b EX_step assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MC-EF_step_star"><span class="command">lemma</span></span> EF_step_star<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span>  <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="free">y</span><span class="main">;</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> EF <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_transition_refl_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">,</span> <span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">y</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> EF <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> converse_rtrancl_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> EF <span class="free">f</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> EF_lem2a<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ya</span> <span class="bound">z</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">⟹</span>
                 <span class="main">(</span><span class="bound">ya</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">y</span><span class="main">}</span> <span class="main">⟹</span>
                 <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">y</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">∈</span> EF <span class="free">f</span> <span class="main">⟹</span> <span class="bound">ya</span> <span class="main">∈</span> EF <span class="free">f</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EF_step_step<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MC-EF_induct"><span class="command">lemma</span></span> EF_induct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>state<span class="main">)</span> <span class="main">∈</span> EF <span class="free">f</span> <span class="main">⟹</span>
    mono <span class="main">(</span><span class="main">λ</span> <span class="bound">Z</span><span class="main">.</span> <span class="free">f</span> <span class="main">∪</span> EX' <span class="bound">Z</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">Z</span><span class="main">.</span> <span class="free">f</span> <span class="main">∪</span> EX' <span class="bound">Z</span><span class="main">)</span><span class="main">(</span>EF <span class="free">f</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>state<span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">P</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> EF_def def_lfp_induct_set<span class="main">)</span>

<span class="keyword1" id="MC-valEF_E"><span class="command">lemma</span></span> valEF_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⊢</span> EF <span class="free">f</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> init <span class="free">M</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> EF <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_def<span class="main">)</span>

<span class="keyword1" id="MC-EF_step_star_rev"><span class="command">lemma</span></span> EF_step_star_rev<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> EF <span class="free">s</span> <span class="main">⟹</span>  <span class="main">(</span><span class="main">∃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span>  <span class="free">x</span>  <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> EF_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="main">λ</span><span class="bound">Z</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">.</span> <span class="free">s</span> <span class="main">∪</span> EX' <span class="bound">Z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_def EX'_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∪</span> EX' <span class="main">(</span>EF <span class="free">s</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> UnE<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> state_transition_refl_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EX'_def state_transition_refl_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> converse_rtrancl_into_rtrancl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MC-EF_step_inv"><span class="command">lemma</span></span> EF_step_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">sa</span><span class="main">::</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">sa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">∈</span> EF <span class="free">s</span><span class="main">}</span><span class="main">)</span>  
         <span class="main">⟹</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> EF_step_star_rev <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹AG lemmas›</span></span> 

<span class="keyword1" id="MC-AG_in_lem"><span class="command">lemma</span></span> AG_in_lem<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> AG <span class="free">s</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AG_def gfp_def<span class="main">)</span>

<span class="keyword1" id="MC-AG_lem1"><span class="command">lemma</span></span> AG_lem1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>AX <span class="main">(</span>AG <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> AG <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AG_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gfp <span class="main">(</span><span class="main">λ</span><span class="bound">Z</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">.</span> <span class="free">s</span> <span class="main">∩</span> AX <span class="bound">Z</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∩</span> <span class="main">(</span>AX <span class="main">(</span>gfp <span class="main">(</span><span class="main">λ</span><span class="bound">Z</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">.</span> <span class="free">s</span> <span class="main">∩</span> AX <span class="bound">Z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> def_gfp_unfold<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mono_def AX_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> AX <span class="main">(</span>gfp <span class="main">(</span><span class="main">λ</span><span class="bound">Z</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">.</span> <span class="free">s</span> <span class="main">∩</span> AX <span class="bound">Z</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> gfp <span class="main">(</span><span class="main">λ</span><span class="bound">Z</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">.</span> <span class="free">s</span> <span class="main">∩</span> AX <span class="bound">Z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MC-AG_lem2"><span class="command">lemma</span></span> AG_lem2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> AG <span class="free">s</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free">s</span> <span class="main">∩</span> <span class="main">(</span>AX <span class="main">(</span>AG <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"AG <span class="free">s</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∩</span> <span class="main">(</span>AX <span class="main">(</span>AG <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> AG_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> def_gfp_unfold<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mono_def AX_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> AG <span class="free">s</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free">s</span> <span class="main">∩</span> <span class="main">(</span>AX <span class="main">(</span>AG <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> subst<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MC-AG_lem3"><span class="command">lemma</span></span> AG_lem3<span class="main">:</span> <span class="quoted"><span class="quoted">"AG <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">∩</span> <span class="main">(</span>AX <span class="main">(</span>AG <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>    
  <span class="keyword1"><span class="command">using</span></span> AG_lem1 AG_lem2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MC-AG_step"><span class="command">lemma</span></span> AG_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> AG <span class="free">s</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">∈</span> AG <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> AG_lem2 AX_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  

<span class="keyword1" id="MC-AG_all_s"><span class="command">lemma</span></span> AG_all_s<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> AG <span class="free">s</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> AG <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_transition_refl_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">y</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> AG <span class="free">s</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> AG <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AG_step<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="MC-AG_imp_notnotEF"><span class="command">lemma</span></span> AG_imp_notnotEF<span class="main">:</span> 
<span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span>Kripke <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span> <span class="free">I</span>  <span class="main">⊢</span> AG <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
 <span class="main">(</span><span class="main">¬</span><span class="main">(</span>Kripke <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">I</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span>set<span class="main">)</span>  <span class="main">⊢</span> EF <span class="main">(</span><span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> a0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">sa</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">sa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">∈</span> AG <span class="free">s</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">sa</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">sa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">∈</span> EF <span class="main">(</span><span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">sa</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">sa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">∈</span> AG <span class="free">s</span><span class="main">}</span> <span class="main">∩</span>
                        <span class="main">{</span><span class="bound">sa</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">sa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">∈</span> EF <span class="main">(</span><span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">?</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">sa</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">sa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">∈</span> AG <span class="free">s</span><span class="main">}</span> <span class="main">∧</span>
                           <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">sa</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">sa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">∈</span> EF <span class="main">(</span><span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> False"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">assume</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">?</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">sa</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">sa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">∈</span> AG <span class="free">s</span><span class="main">}</span> <span class="main">∧</span>
                           <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">sa</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">sa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">∈</span> EF <span class="main">(</span><span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>          
            <span class="keyword1"><span class="command">from</span></span> a4 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span>  a5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">sa</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">sa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">∈</span> AG <span class="free">s</span><span class="main">}</span> <span class="main">∧</span>
                                   <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">sa</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">sa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">∈</span> EF <span class="main">(</span><span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span> 
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> AG_all_s AG_in_lem ComplD EF_step_star_rev a5 mem_Collect_eq<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">sa</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">sa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">∈</span> AG <span class="free">s</span><span class="main">}</span> <span class="main">∩</span>
                        <span class="main">{</span><span class="bound">sa</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">sa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">∈</span> EF <span class="main">(</span><span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">?</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">:</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a0
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> a0 a1 a2
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A simplified way of Modelchecking is given by the following lemma.›</span></span>
<span class="keyword1" id="MC-check2_def"><span class="command">lemma</span></span> check2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Kripke <span class="free">S</span> <span class="free">I</span> <span class="main">⊢</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">I</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">∩</span> <span class="free">f</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def<span class="main">)</span>
    
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="AT">
<div class="head">
<h1>Theory AT</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Attack Trees"</span></span>
<span class="keyword1"><span class="command">theory</span></span> AT
<span class="keyword2"><span class="keyword">imports</span></span> <a href="MC.html">MC</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Attack Trees are an intuitive and practical formal method to analyse and quantify
attacks on security and privacy. They are very useful to identify the steps an attacker
takes through a system when approaching the attack goal. Here, we provide 
a proof calculus to analyse concrete attacks using a notion of attack validity.
We define a state based semantics with Kripke models and the temporal logic
CTL in the proof assistant Isabelle \cite{npw:02} using its Higher Order Logic 
(HOL). We prove the correctness and completeness (adequacy) of Attack Trees in Isabelle 
with respect to the model.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Attack Tree datatype"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following datatype definition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹attree›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> defines attack trees.
The simplest case of an attack tree is a base attack.
The principal idea is that base attacks are defined by a pair of
state sets representing the initial states and the {\it attack property}
-- a set of states characterized by the fact that this property holds
in them. 
Attacks can also be combined as the conjunction or disjunction of other attacks. 
The operator <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹⊕<span class="hidden">⇩</span><sub>∨</sub>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> creates or-trees and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹⊕<span class="hidden">⇩</span><sub>∧</sub>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> creates and-trees.
And-attack trees <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹l ⊕<span class="hidden">⇩</span><sub>∧</sub> s›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and or-attack trees <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹l ⊕<span class="hidden">⇩</span><sub>∨</sub> s›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
combine lists of attack trees $l$ either conjunctively or disjunctively and
consist of a list of sub-attacks -- again attack trees.›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> <span class="quoted">state</span><span class="main">)</span> attree <span class="main">=</span> BaseAttack <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> set<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'s</span> set<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">𝒩⇘</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⇙</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span> <span class="main">|</span>
                  AndAttack <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> attree<span class="main">)</span> list"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> set<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'s</span> set<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⊕<span class="hidden">⇩</span><sub>∧</sub>⇗</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⇖</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 60<span class="main">)</span> <span class="main">|</span> 
                  OrAttack  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> attree<span class="main">)</span> list"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> set<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'s</span> set<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⊕<span class="hidden">⇩</span><sub>∨</sub>⇗</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⇖</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 61<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">attack</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span> attree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> set<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'s</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> 
<span class="quoted"><span class="quoted">"<span class="free">attack</span> <span class="main">(</span>BaseAttack <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span><span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">attack</span> <span class="main">(</span>AndAttack <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>  <span class="main">|</span> 
<span class="quoted"><span class="quoted">"<span class="free">attack</span> <span class="main">(</span>OrAttack <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Attack Tree refinement›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹When we develop an attack tree, we proceed from an abstract attack, given
by an attack goal, by breaking it down into a series of sub-attacks. This
proceeding corresponds to a process of {\it refinement}. Therefore, as part of
the attack tree calculus, we provide a notion of attack tree refinement.

The relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹refines_to›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> "constructs" the attack tree. Here the above
defined attack vectors are used to define how nodes in an attack tree 
can be expanded into more detailed (refined) attack sequences. This 
process of refinement <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⊑"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> allows to eventually reach a fully detailed
attack that can then be proved using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⊢"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">refines_to</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span> attree<span class="main">,</span> <span class="tfree">'s</span> attree<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊑</span> _"</span> <span class="main">[</span>40<span class="main">]</span> 40<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> 
refI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>  <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> <span class="main">[</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free"><span class="bound"><span class="entity">si'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">si''</span></span></span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">l''</span></span></span><span class="main">)</span>⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free"><span class="bound"><span class="entity">si</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">si'''</span></span></span><span class="main">)</span></sup><span class="hidden">⇖</span> <span class="main">)</span><span class="main">;</span>
          <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l'</span></span></span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free"><span class="bound"><span class="entity">si'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">si''</span></span></span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">;</span>
          <span class="free"><span class="bound"><span class="entity">A''</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">l''</span></span></span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free"><span class="bound"><span class="entity">si</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">si'''</span></span></span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>
        <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">⊑</span></span> <span class="free"><span class="bound"><span class="entity">A''</span></span></span>"</span></span><span class="main">|</span> 
ref_or<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> <span class="main">∀</span> <span class="bound">A'</span> <span class="main">∈</span> set<span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span>  <span class="main"><span class="free">⊑</span></span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> attack <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">⊑</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">s</span></span></span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="main">|</span>
ref_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">⊑</span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main"><span class="free">⊑</span></span> <span class="free"><span class="bound"><span class="entity">A''</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">⊑</span></span> <span class="free"><span class="bound"><span class="entity">A''</span></span></span>"</span></span><span class="main">|</span>
ref_refl <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">⊑</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Validity of Attack Trees›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A valid attack, intuitively, is one which is fully refined into fine-grained
attacks that are feasible in a model. The general model we provide is
a Kripke structure, i.e., a set of states and a generic state transition.
Thus, feasible steps in the model are single steps of the state transition.
We call them valid base attacks.
The composition of sequences of valid base attacks into and-attacks yields
again valid attacks if the base attacks line up with respect to the states
in the state transition. If there are different valid attacks for the same
attack goal starting from the same initial state set, these can be 
summarized in an or-attack.
More precisely, the different cases of the validity predicate are distinguished
by pattern matching over the attack tree structure.
\begin{itemize}
\item A  base attack <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹𝒩(s0,s1)›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is  valid if from all
states in the pre-state set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹s0›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> we can get with a single step of the 
state transition relation to a state in the post-state set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s1›</span></span></span></span>. Note,
that it is sufficient for a post-state to exist for each pre-state. After all,
we are aiming to validate attacks, that is, possible attack paths to some
state that fulfills the attack property.
\item An and-attack <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹As ⊕<span class="hidden">⇩</span><sub>∧</sub> (s0,s1)›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a valid attack
 if either of the following cases holds:
  \begin{itemize}
   \item empty attack sequence <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹As›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: in this case 
       all pre-states in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹s0›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must already be attack states 
       in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹s1›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, i.e., <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹s0 ⊆ s1›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>;
   \item attack sequence <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹As›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is singleton: in this case, the 
      singleton element attack <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹a›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹[a]›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
      must be a valid attack and it must be an attack with pre-state 
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹s0›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and post-state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹s1›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>;
   \item otherwise, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹As›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must be a list matching <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹a # l›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for
     some attack <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹a›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and tail of attack list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹l›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> such that
     <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹a›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a valid attack with pre-state identical to the overall 
     pre-state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹s0›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and the goal of the tail <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹l›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is 
     <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹s1›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> the goal of the  overall attack. The pre-state of the
     attack represented by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹l›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹snd(attack a)›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> since this is 
     the post-state set of the first step <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹a›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\end{itemize}
 \item An or-attack <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹As  ⊕<span class="hidden">⇩</span><sub>∨</sub>(s0,s1)›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a valid attack 
  if either of the following cases holds: 
  \begin{itemize}
   \item the empty attack case is identical to the and-attack above: 
       <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹s0 ⊆ s1›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>;
   \item attack sequence <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹As›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is singleton: in this case, the 
      singleton element attack <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹a›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
      must be a valid attack and 
      its pre-state must include the overall attack pre-state set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹s0›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
      (since <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹a›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is singleton in the or) while the post-state of 
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹a›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> needs to be included in the global attack goal <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹s1›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>;
   \item otherwise, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹As›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must be a list  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹a # l›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for
     an attack <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹a›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and a list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹l›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of alternative attacks.
     The pre-states can be just a subset of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹s0›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (since there are
     other attacks in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹l›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that can cover the rest) and the goal
     states <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹snd(attack a)›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> need to lie all in the overall goal
     state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹set s1›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The other or-attacks in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹l›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> need
     to cover only the pre-states <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹fst s - fst(attack a)›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
     (where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹-›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is set difference) and have the same goal <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹snd s›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
   \end{itemize}
\end{itemize}
The proof calculus is thus completely described by one recursive function. ›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_attack_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span> attree<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢</span>_"</span> <span class="main">[</span>40<span class="main">]</span> 40<span class="main">)</span> 
<span class="keyword2"><span class="keyword">where</span></span> 
att_base<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main"><span class="free">⊢</span></span> 𝒩<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">s</span></span></span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span>  <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">y</span> <span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
att_and<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main"><span class="free">⊢</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">As</span></span></span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">s</span></span></span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
               <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="keyword1">of</span>
                  <span class="main">[]</span> <span class="main">⇒</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⊆</span> snd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
                <span class="main">|</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">a</span> <span class="main">∧</span> attack <span class="bound">a</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> 
                <span class="main">|</span> <span class="main">(</span><span class="bound">a</span> <span class="main">#</span> <span class="bound">l</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>fst<span class="main">(</span>attack <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∧</span> 
                            <span class="main">(</span><span class="main"><span class="free">⊢</span></span><span class="main">(</span><span class="bound">l</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span>snd<span class="main">(</span>attack <span class="bound">a</span><span class="main">)</span><span class="main">,</span>snd<span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
att_or<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main"><span class="free">⊢</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">As</span></span></span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">s</span></span></span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
               <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="keyword1">of</span> 
                  <span class="main">[]</span> <span class="main">⇒</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⊆</span> snd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> 
                <span class="main">|</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">a</span> <span class="main">∧</span> <span class="main">(</span>fst<span class="main">(</span>attack <span class="bound">a</span><span class="main">)</span> <span class="main">⊇</span> fst <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>snd<span class="main">(</span>attack <span class="bound">a</span><span class="main">)</span> <span class="main">⊆</span> snd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> 
                <span class="main">|</span> <span class="main">(</span><span class="bound">a</span> <span class="main">#</span> <span class="bound">l</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span> <span class="main"><span class="free">⊢</span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> fst<span class="main">(</span>attack <span class="bound">a</span><span class="main">)</span> <span class="main">⊆</span> fst <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> 
                              snd<span class="main">(</span>attack <span class="bound">a</span><span class="main">)</span> <span class="main">⊆</span> snd <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span>
                       <span class="main">(</span> <span class="main"><span class="free">⊢</span></span><span class="main">(</span><span class="bound">l</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> fst<span class="main">(</span>attack <span class="bound">a</span><span class="main">)</span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Since the definition is constructive, code can be generated directly from it, here
into the programming language Scala.›</span></span>
<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">is_attack_tree</span></span> <span class="keyword2"><span class="keyword">in</span></span> Scala    

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Lemmas for Attack Tree validity"</span></span>
<span class="keyword1" id="AT-att_and_one"><span class="command">lemma</span></span> att_and_one<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"attack <span class="free">a</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⊢</span><span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="free">s</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span><span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="free">s</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> att_and<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> att_and att_or<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> is_attack_tree.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>
  
<span class="keyword1" id="AT-att_and_empty"><span class="command">lemma</span></span> att_and_empty<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span><span class="main">(</span><span class="main">[]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">s''</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">s'</span> <span class="main">⊆</span> <span class="free">s''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_attack_tree.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="AT-att_and_empty2"><span class="command">lemma</span></span> att_and_empty2<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span><span class="main">(</span><span class="main">[]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_attack_tree.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="AT-att_or_empty"><span class="command">lemma</span></span> att_or_empty<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span><span class="main">(</span><span class="main">[]</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">s''</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">s'</span> <span class="main">⊆</span> <span class="free">s''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_attack_tree.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="AT-att_or_empty_back"><span class="command">lemma</span></span> att_or_empty_back<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">s'</span> <span class="main">⊆</span> <span class="free">s''</span> <span class="main">⟶</span>  <span class="main">⊢</span><span class="main">(</span><span class="main">[]</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">s''</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_attack_tree.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="AT-att_or_empty_rev"><span class="command">lemma</span></span> att_or_empty_rev<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span><span class="main">(</span><span class="free">l</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">s</span> <span class="main">⊆</span> <span class="free">s'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>    
  <span class="keyword1"><span class="command">using</span></span> assms att_or_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="AT-att_or_empty2"><span class="command">lemma</span></span> att_or_empty2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span><span class="main">(</span><span class="main">[]</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> att_or_empty_back<span class="main">)</span>

<span class="keyword1" id="AT-att_andD1"><span class="command">lemma</span></span> att_andD1<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">x2</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="free">s</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="free">x1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> is_attack_tree.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.exhaust list.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="AT-att_and_nonemptyD2"><span class="command">lemma</span></span> att_and_nonemptyD2<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> 
       <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x2</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="main">⊢</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">x2</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="free">s</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">x2</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span>snd<span class="main">(</span>attack <span class="free">x1</span><span class="main">)</span><span class="main">,</span>snd <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> is_attack_tree.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.exhaust list.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span> 

<span class="keyword1" id="AT-att_andD2"><span class="command">lemma</span></span> att_andD2 <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">x2</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="free">s</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">x2</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span>snd<span class="main">(</span>attack <span class="free">x1</span><span class="main">)</span><span class="main">,</span>snd <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> att_and_empty2 att_and_nonemptyD2 is_attack_tree.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    
<span class="keyword1" id="AT-att_and_fst_lem"><span class="command">lemma</span></span> att_and_fst_lem<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> 
   <span class="quoted"><span class="quoted">"<span class="main">⊢</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="free">x</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">xa</span> <span class="main">∈</span> fst <span class="main">(</span>attack <span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="free">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">⟶</span> <span class="free">xa</span> <span class="main">∈</span> fst <span class="main">(</span>attack <span class="free">x1</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x2a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">subst</span> att_and<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="AT-att_orD1"><span class="command">lemma</span></span> att_orD1<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">x2</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="free">x</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="free">x1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">x2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> att_or<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    
<span class="keyword1" id="AT-att_or_snd_hd"><span class="command">lemma</span></span> att_or_snd_hd<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">list</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟹</span> snd<span class="main">(</span>attack <span class="free">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">list</span></span><span class="main"><span class="keyword3">,</span></span>  <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> att_or<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
 
<span class="keyword1" id="AT-att_or_singleton"><span class="command">lemma</span></span> att_or_singleton<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> 
   <span class="quoted"><span class="quoted">" <span class="main">⊢</span><span class="main">(</span><span class="main">[</span><span class="free">x1</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="free">x</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">⊢</span><span class="main">(</span><span class="main">[]</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span>fst <span class="free">x</span> <span class="main">-</span> fst <span class="main">(</span>attack <span class="free">x1</span><span class="main">)</span><span class="main">,</span> snd <span class="free">x</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> att_or<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> att_or_empty_back<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="AT-att_orD2"><span class="command">lemma</span></span> att_orD2<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> 
     <span class="quoted"><span class="quoted">" <span class="main">⊢</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">x2</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="free">x</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟶</span>  <span class="main">⊢</span> <span class="main">(</span><span class="free">x2</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span>fst <span class="free">x</span> <span class="main">-</span> fst<span class="main">(</span>attack <span class="free">x1</span><span class="main">)</span><span class="main">,</span> snd <span class="free">x</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">x2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> att_or_singleton<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> att_or<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="AT-att_or_snd_att"><span class="command">lemma</span></span> att_or_snd_att<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">x2</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">x2</span><span class="main">)</span><span class="main">.</span> snd<span class="main">(</span>attack <span class="bound">a</span><span class="main">)</span> <span class="main">⊆</span> snd <span class="bound">x</span> <span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> att_or<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> att_orD2 att_or_snd_hd <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AT-singleton_or_lem"><span class="command">lemma</span></span> singleton_or_lem<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span><span class="main">(</span><span class="main">[</span><span class="free">x1</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="free">x</span></sup><span class="hidden">⇖</span><span class="main">)</span>  <span class="main">⟹</span> fst <span class="free">x</span> <span class="main">⊆</span> fst<span class="main">(</span>attack <span class="free">x1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> att_or<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="AT-or_att_fst_sup0"><span class="command">lemma</span></span> or_att_fst_sup0<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x2</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="free">x2</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span> attree<span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
                      <span class="main">(</span><span class="main">(</span><span class="main">⋃</span> <span class="bound">y</span><span class="main">::</span><span class="tfree">'s</span> attree<span class="main">∈</span> set <span class="free">x2</span><span class="main">.</span> fst <span class="main">(</span>attack <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⊇</span> fst<span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> att_orD2 singleton_or_lem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AT-or_att_fst_sup"><span class="command">lemma</span></span> or_att_fst_sup<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">x2</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="free">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span> attree<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">⋃</span> <span class="bound">y</span><span class="main">::</span><span class="tfree">'s</span> attree<span class="main">∈</span> set <span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">x2</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span>attack <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⊇</span> fst<span class="main">(</span><span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> or_att_fst_sup0<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹att_elem_seq›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the main lemma for Correctness.
  It shows that for a given attack tree x1, for each element in the set of start sets 
  of the first attack, we can reach in zero or more steps a state in the states in which 
  the attack is successful (the final attack state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹snd(attack x1)›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).
  This proof is a big alternative to an earlier version of the proof with
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹first_step›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> etc that mapped first on a sequence of sets of states.›</span></span>
<span class="keyword1" id="AT-att_elem_seq"><span class="command">lemma</span></span> att_elem_seq<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">x1</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> fst<span class="main">(</span>attack <span class="free">x1</span><span class="main">)</span><span class="main">.</span>
                     <span class="main">(</span><span class="main">∃</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd<span class="main">(</span>attack <span class="free">x1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First attack tree induction›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>BaseAttack <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> AT.att_base EF_step EF_step_star_rev attack.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AndAttack <span class="skolem">x1a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">x2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">x1aa</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">.</span>
                              <span class="bound">x1aa</span> <span class="main">∈</span> set <span class="skolem">x1a</span> <span class="main">⟶</span>
                               <span class="main">⊢</span><span class="bound">x1aa</span> <span class="main">⟶</span>
                               <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span>fst <span class="main">(</span>attack <span class="bound">x1aa</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="main">(</span>attack <span class="bound">x1aa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mp<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> -1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Induction for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹∧›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: the manual instantiation seems tedious but in the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹∧›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
            case necessary to get the right induction hypothesis.›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> list <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x1a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> list.induct<span class="main">)</span>
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹∧›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> induction empty case›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x1aa</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">.</span>
           <span class="bound">x1aa</span> <span class="main">∈</span> set <span class="main">[]</span> <span class="main">⟶</span>
           <span class="main">⊢</span><span class="bound">x1aa</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span>fst <span class="main">(</span>attack <span class="bound">x1aa</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="main">(</span>attack <span class="bound">x1aa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span> set <span class="main">×</span> <span class="tfree">'a</span> set<span class="main">.</span>
           <span class="main">⊢</span><span class="main">(</span><span class="main">[]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟶</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">xa</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span>fst <span class="main">(</span>attack <span class="main">(</span><span class="main">[]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="main">(</span>attack <span class="main">(</span><span class="main">[]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">xa</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> att_and_empty state_transition_refl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹∧›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> induction case nonempty›</span></span>
  <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">x1a</span><span class="main">::</span><span class="tfree">'a</span> attree list<span class="main">)</span> <span class="main">(</span><span class="bound">x2</span><span class="main">::</span><span class="tfree">'a</span> set <span class="main">×</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">(</span><span class="bound">x1</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">)</span> <span class="main">(</span><span class="bound">x2a</span><span class="main">::</span><span class="tfree">'a</span> attree list<span class="main">)</span><span class="main">.</span>
       <span class="main">(</span><span class="main">⋀</span><span class="bound">x1aa</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">.</span>
           <span class="main">(</span><span class="bound">x1aa</span> <span class="main">∈</span> set <span class="bound">x1a</span><span class="main">)</span> <span class="main">⟹</span>
           <span class="main">(</span><span class="main">(</span><span class="main">⊢</span><span class="bound">x1aa</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span>fst <span class="main">(</span>attack <span class="bound">x1aa</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="main">(</span>attack <span class="bound">x1aa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound">x1aa</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">.</span>
          <span class="main">(</span><span class="bound">x1aa</span> <span class="main">∈</span> set <span class="bound">x1a</span><span class="main">)</span> <span class="main">⟶</span>
          <span class="main">(</span><span class="main">⊢</span><span class="bound">x1aa</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span>fst <span class="main">(</span>attack <span class="bound">x1aa</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="main">(</span>attack <span class="bound">x1aa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">x1aa</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">.</span>
           <span class="main">(</span><span class="bound">x1aa</span> <span class="main">∈</span> set <span class="bound">x2a</span><span class="main">)</span> <span class="main">⟶</span>
           <span class="main">(</span><span class="main">⊢</span><span class="bound">x1aa</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span>fst <span class="main">(</span>attack <span class="bound">x1aa</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="main">(</span>attack <span class="bound">x1aa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span> set <span class="main">×</span> <span class="tfree">'a</span> set<span class="main">.</span>
           <span class="main">(</span><span class="main">⊢</span><span class="main">(</span><span class="bound">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
           <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">xa</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span>fst <span class="main">(</span>attack <span class="main">(</span><span class="bound">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="main">(</span>attack <span class="main">(</span><span class="bound">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">xa</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">x1aa</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">.</span>
           <span class="main">(</span><span class="bound">x1aa</span> <span class="main">∈</span> set <span class="main">(</span><span class="bound">x1</span> <span class="main">#</span> <span class="bound">x2a</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
           <span class="main">(</span><span class="main">⊢</span><span class="bound">x1aa</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span>fst <span class="main">(</span>attack <span class="bound">x1aa</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="main">(</span>attack <span class="bound">x1aa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span> set <span class="main">×</span> <span class="tfree">'a</span> set<span class="main">.</span>
          <span class="main">(</span> <span class="main">⊢</span><span class="main">(</span><span class="bound">x1</span> <span class="main">#</span> <span class="bound">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">xa</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span>fst <span class="main">(</span>attack <span class="main">(</span><span class="bound">x1</span> <span class="main">#</span> <span class="bound">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
               <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="main">(</span>attack <span class="main">(</span><span class="bound">x1</span> <span class="main">#</span> <span class="bound">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">xa</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Set free the Induction Hypothesis: this is necessary to provide the grounds for specific 
              instantiations in the step.›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span> set <span class="main">×</span> <span class="tfree">'a</span> set<span class="main">.</span>
                             <span class="main">⊢</span><span class="main">(</span><span class="improper">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟶</span>
                             <span class="main">(</span><span class="main">∀</span><span class="bound">xa</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span>fst <span class="main">(</span>attack <span class="main">(</span><span class="improper">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
                              <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="main">(</span>attack <span class="main">(</span><span class="improper">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">xa</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following induction step for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹∧›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> needs a number of manual instantiations 
              so that the proof is not found automatically. In the subsequent case for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹∨›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
              sledgehammer finds the proof.›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">x1a</span><span class="main">::</span><span class="tfree">'a</span> attree list<span class="main">)</span> <span class="main">(</span><span class="bound">x2</span><span class="main">::</span><span class="tfree">'a</span> set <span class="main">×</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">(</span><span class="bound">x1</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">)</span> <span class="main">(</span><span class="bound">x2a</span><span class="main">::</span><span class="tfree">'a</span> attree list<span class="main">)</span> <span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span> set <span class="main">×</span> <span class="tfree">'a</span> set<span class="main">.</span>
       <span class="main">∀</span><span class="bound">x1aa</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">.</span>
          <span class="bound">x1aa</span> <span class="main">∈</span> set <span class="main">(</span><span class="bound">x1</span> <span class="main">#</span> <span class="bound">x2a</span><span class="main">)</span> <span class="main">⟶</span>
          <span class="main">⊢</span><span class="bound">x1aa</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span>fst <span class="main">(</span>attack <span class="bound">x1aa</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="main">(</span>attack <span class="bound">x1aa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="main">⊢</span><span class="main">(</span><span class="bound">x1</span> <span class="main">#</span> <span class="bound">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span> set <span class="main">×</span> <span class="tfree">'a</span> set<span class="main">.</span>
          <span class="main">⊢</span><span class="main">(</span><span class="bound">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟶</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">xa</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span>fst <span class="main">(</span>attack <span class="main">(</span><span class="bound">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="main">(</span>attack <span class="main">(</span><span class="bound">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">xa</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound">xa</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span>fst <span class="main">(</span>attack <span class="main">(</span><span class="bound">x1</span> <span class="main">#</span> <span class="bound">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="main">(</span>attack <span class="main">(</span><span class="bound">x1</span> <span class="main">#</span> <span class="bound">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="bound">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">xa</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> xa<span class="main">)</span>
        <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Prepare the steps›</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd<span class="main">(</span>attack <span class="improper">x1</span><span class="main">)</span><span class="main">,</span> snd <span class="improper">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> -1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> att_andD2<span class="main">)</span>
        <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Premise for x1›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">x1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mp<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mp<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> att_andD1<span class="main">)</span>
        <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Instantiate first step for xa›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> -1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> att_and_fst_lem<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
        <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Take this y and put it as first into the second part›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
        <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Bind the first <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹xa →<span class="hidden">⇩</span><sub>i</sub>* y›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and second <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹y →<span class="hidden">⇩</span><sub>i</sub>* ya›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> together for solution›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">ya</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_transition_refl_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>OrAttack <span class="skolem">x1a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x1a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x2</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> EF_lem2a EF_step_star_rev att_or_empty attack.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> subsetD surjective_pairing<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">x1a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> DiffI att_orD1 att_orD2 att_or_snd_att attack.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> insert_iff list.set<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snd_conv subset_iff<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

  
<span class="keyword1" id="AT-att_elem_seq0"><span class="command">lemma</span></span> att_elem_seq0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">x1</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> fst<span class="main">(</span>attack <span class="free">x1</span><span class="main">)</span><span class="main">.</span>
                     <span class="main">(</span><span class="main">∃</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd<span class="main">(</span>attack <span class="free">x1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> att_elem_seq<span class="main">)</span>
          
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Valid refinements›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid_ref</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span> attree<span class="main">,</span> <span class="tfree">'s</span> attree<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊑<span class="hidden">⇩</span><sub>V</sub></span> _"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1"><span class="free">⊑<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">≡</span>  <span class="main">(</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">)</span> <span class="main">∧</span>  <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ref_validity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span> attree<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>V</sub></span> _"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>  <span class="main">≡</span>  <span class="main">(</span><span class="main">∃</span> <span class="bound">A'</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">⊑<span class="hidden">⇩</span><sub>V</sub></span> <span class="bound">A'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="AT-ref_valI"><span class="command">lemma</span></span> ref_valI<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">A</span> <span class="main">⊑</span> <span class="free">A'</span><span class="main">⟹</span>  <span class="main">⊢</span> <span class="free">A'</span> <span class="main">⟹</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ref_validity_def valid_ref_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Correctness and Completeness"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section presents the main theorems of Correctness and Completeness
      between AT and Kripke, essentially: 

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹⊢ (init K, p) ≡  K ⊢ EF p›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

First, we proof a number of lemmas needed for both directions before we 
show the Correctness theorem followed by the Completeness theorem.
›</span></span>    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemma for Correctness and Completeness›</span></span>
<span class="keyword1" id="AT-nth_app_eq"><span class="command">lemma</span></span> nth_app_eq<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> 
              <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">sl</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span>length <span class="bound">sl</span> <span class="main">-</span> Suc <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>
              <span class="main">⟶</span> <span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="bound">sl</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">l</span> <span class="main">+</span> length <span class="bound">sl</span> <span class="main">-</span> Suc <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>    
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="AT-nth_app_eq1"><span class="command">lemma</span></span> nth_app_eq1<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">sla</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">sla</span> <span class="main">@</span> <span class="free">sl</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">sla</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>

<span class="keyword1" id="AT-nth_app_eq1_rev"><span class="command">lemma</span></span> nth_app_eq1_rev<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">sla</span> <span class="main">⟹</span>  <span class="free">sla</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">sla</span> <span class="main">@</span> <span class="free">sl</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>

<span class="keyword1" id="AT-nth_app_eq2"><span class="command">lemma</span></span> nth_app_eq2<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">sl</span> <span class="bound">i</span><span class="main">.</span> length <span class="free">sla</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">sla</span> <span class="main">@</span> <span class="bound">sl</span><span class="main">)</span>
                     <span class="main">⟶</span> <span class="main">(</span><span class="free">sla</span> <span class="main">@</span> <span class="bound">sl</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="main">(</span>length <span class="free">sla</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>


<span class="keyword1" id="AT-tl_ne_ex"><span class="command">lemma</span></span> tl_ne_ex<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">?</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">l</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">#</span> <span class="main">(</span>tl <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1" id="AT-tl_nempty_lngth"><span class="command">lemma</span></span> tl_nempty_lngth<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="free">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="numeral">2</span> <span class="main">≤</span> length<span class="main">(</span><span class="free">sl</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> le_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  
<span class="keyword1" id="AT-list_app_one_length"><span class="command">lemma</span></span> list_app_one_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> subst<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  
<span class="keyword1" id="AT-tl_lem1"><span class="command">lemma</span></span> tl_lem1<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> tl <span class="free">l</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟶</span> length <span class="free">l</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="AT-nth_tl_length"><span class="command">lemma</span></span> nth_tl_length<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="free">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span>
      tl <span class="free">sl</span> <span class="main">!</span> <span class="main">(</span>length <span class="main">(</span>tl <span class="free">sl</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">sl</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">sl</span> <span class="main">-</span> Suc <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sl</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="AT-nth_tl_length1"><span class="command">lemma</span></span> nth_tl_length1<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="free">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span>
      tl <span class="free">sl</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">sl</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sl</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
   
<span class="keyword1" id="AT-ineq1"><span class="command">lemma</span></span> ineq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">sla</span> <span class="main">-</span> <span class="free">n</span>  <span class="main">⟹</span>
       <span class="main">(</span><span class="main">0</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">sla</span>"</span></span>  
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="AT-ineq2"><span class="command">lemma</span></span> ineq2<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">sla</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟶</span> <span class="free">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> length <span class="free">sla</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> length <span class="free">sla</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>

<span class="keyword1" id="AT-ineq3"><span class="command">lemma</span></span> ineq3<span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="free">sl</span> <span class="main">≠</span> <span class="main">[]</span>  <span class="main">⟹</span> length <span class="free">sla</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">sla</span> <span class="main">@</span> tl <span class="free">sl</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span>
              <span class="main">⟹</span> <span class="free">i</span> <span class="main">-</span> length <span class="free">sla</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">sl</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span>"</span></span>    
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="AT-tl_eq1"><span class="command">lemma</span></span> tl_eq1<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> tl <span class="free">sl</span> <span class="main">!</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">sl</span> <span class="main">!</span> Suc <span class="main">(</span><span class="main">0</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sl</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="AT-tl_eq2"><span class="command">lemma</span></span> tl_eq2<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="free">sl</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="free">sl</span> <span class="main">!</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">sl</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">sl</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sl</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="AT-tl_eq3"><span class="command">lemma</span></span> tl_eq3<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="free">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span>
    tl <span class="free">sl</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">sl</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">sl</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">sl</span> <span class="main">-</span> Suc <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>    
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sl</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="AT-nth_app_eq3"><span class="command">lemma</span></span> nth_app_eq3<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">sl</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sla</span> <span class="main">@</span> tl <span class="free">sl</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>length <span class="main">(</span><span class="free">sla</span> <span class="main">@</span> tl <span class="free">sl</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">sl</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">sl</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms nth_app_eq nth_tl_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="AT-not_empty_ex"><span class="command">lemma</span></span> not_empty_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">?</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="AT-fst_att_eq"><span class="command">lemma</span></span> fst_att_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="free">x</span> <span class="main">#</span> <span class="free">sl</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>attack <span class="main">(</span><span class="free">al</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="free">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="AT-list_eq1"><span class="command">lemma</span></span> list_eq1<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span>
     <span class="main">(</span>fst <span class="free">x</span> <span class="main">#</span> <span class="free">sl</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>length <span class="main">(</span>fst <span class="free">x</span> <span class="main">#</span> <span class="free">sl</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">sl</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">sl</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sl</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="AT-attack_eq1"><span class="command">lemma</span></span> attack_eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>attack <span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="free">x</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>attack <span class="main">(</span><span class="free">x2a</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span>snd <span class="main">(</span>attack <span class="free">x1</span><span class="main">)</span><span class="main">,</span> snd <span class="free">x</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="AT-fst_lem1"><span class="command">lemma</span></span> fst_lem1<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">a</span><span class="main">::</span> <span class="tfree">'s</span> set<span class="main">)</span> <span class="bound">b</span> <span class="main">(</span><span class="bound">c</span> <span class="main">::</span> <span class="tfree">'s</span> set<span class="main">)</span> <span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="AT-fst_eq1"><span class="command">lemma</span></span> fst_eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sla</span> <span class="main">!</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> attack <span class="free">x1</span> <span class="main">⟹</span>
       <span class="free">sla</span> <span class="main">!</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>attack <span class="free">x1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> c <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> d <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"snd<span class="main">(</span>attack  <span class="free">x1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fst_lem1<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    
<span class="keyword1" id="AT-base_att_lem1"><span class="command">lemma</span></span> base_att_lem1<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">y0</span> <span class="main">⊆</span> <span class="free">y1</span> <span class="main">⟹</span> <span class="main">⊢</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">y1</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">⟹</span><span class="main">⊢</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">y0</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> att_base<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="AT-ref_pres_att"><span class="command">lemma</span></span> ref_pres_att<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊑</span> <span class="free">A'</span> <span class="main">⟹</span> attack <span class="free">A</span> <span class="main">=</span> attack <span class="free">A'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> refines_to.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">A</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">)</span> <span class="main">(</span><span class="bound">l</span><span class="main">::</span><span class="tfree">'a</span> attree list<span class="main">)</span> <span class="main">(</span><span class="bound">si'</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="main">(</span><span class="bound">si''</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="main">(</span><span class="bound">l''</span><span class="main">::</span><span class="tfree">'a</span> attree list<span class="main">)</span> <span class="main">(</span><span class="bound">si</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span>
       <span class="main">(</span><span class="bound">si'''</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="main">(</span><span class="bound">A'</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">)</span> <span class="main">(</span><span class="bound">l'</span><span class="main">::</span><span class="tfree">'a</span> attree list<span class="main">)</span> <span class="bound">A''</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">.</span>
       <span class="bound">A</span> <span class="main">=</span> <span class="main">(</span><span class="bound">l</span> <span class="main">@</span> <span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="bound">si'</span><span class="main">,</span> <span class="bound">si''</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span> <span class="main">@</span> <span class="bound">l''</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="bound">si</span><span class="main">,</span> <span class="bound">si'''</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="bound">A'</span> <span class="main">=</span> <span class="main">(</span><span class="bound">l'</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="bound">si'</span><span class="main">,</span> <span class="bound">si''</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">A''</span> <span class="main">=</span> <span class="main">(</span><span class="bound">l</span> <span class="main">@</span> <span class="bound">l'</span> <span class="main">@</span> <span class="bound">l''</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="bound">si</span><span class="main">,</span> <span class="bound">si'''</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟹</span> attack <span class="bound">A</span> <span class="main">=</span> attack <span class="bound">A''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">as</span><span class="main">::</span><span class="tfree">'a</span> attree list<span class="main">)</span> <span class="main">(</span><span class="bound">A</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">::</span><span class="tfree">'a</span> set <span class="main">×</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">.</span>
       <span class="bound">as</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">A'</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">∈</span> <span class="main">(</span>set <span class="bound">as</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">A</span> <span class="main">⊑</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>attack <span class="bound">A</span> <span class="main">=</span> attack <span class="bound">A'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> attack <span class="bound">A</span> <span class="main">=</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span>
       attack <span class="bound">A</span> <span class="main">=</span> attack <span class="main">(</span><span class="bound">as</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="bound">s</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> last_in_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">A</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">)</span> <span class="main">(</span><span class="bound">A'</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">)</span> <span class="bound">A''</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">.</span>
       <span class="bound">A</span> <span class="main">⊑</span> <span class="bound">A'</span> <span class="main">⟹</span> attack <span class="bound">A</span> <span class="main">=</span> attack <span class="bound">A'</span> <span class="main">⟹</span> <span class="bound">A'</span> <span class="main">⊑</span> <span class="bound">A''</span> <span class="main">⟹</span> attack <span class="bound">A'</span> <span class="main">=</span> attack <span class="bound">A''</span> <span class="main">⟹</span> attack <span class="bound">A</span> <span class="main">=</span> attack <span class="bound">A''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">::</span><span class="tfree">'a</span> attree<span class="main">.</span> attack <span class="bound">A</span> <span class="main">=</span> attack <span class="bound">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AT-base_subset"><span class="command">lemma</span></span>  base_subset<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">⊆</span> <span class="free">xc</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⊢</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">xa</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">⟹</span> <span class="main">⊢</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">xc</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> att_base<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span><span class="free">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">xa</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span><span class="free">xa</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">xa</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span><span class="free">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">xa</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span><span class="free">xc</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">xa</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms in_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Correctness Theorem"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof with induction over the definition of EF using the main 
lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹att_elem_seq0›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 

There is also a second version of Correctness for valid refinements.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> AT_EF<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span> attree<span class="main">)</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"attack <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="free">s</span><span class="main">)</span>"</span></span>
               <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Kripke <span class="main">{</span><span class="bound">s</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">I</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span>set<span class="main">)</span>  <span class="main">⊢</span> EF <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>check_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">sa</span><span class="main">::</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">::</span><span class="tfree">'s</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">sa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">sa</span> <span class="main">∈</span> EF <span class="free">s</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> CollectI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_transition_refl_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">::</span><span class="tfree">'s</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'s</span><span class="main">,</span> <span class="bound">y</span><span class="main">::</span><span class="tfree">'s</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">y</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> EF <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'s</span><span class="main">∈</span>fst <span class="main">(</span>attack <span class="free">A</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> snd <span class="main">(</span>attack <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> att_elem_seq0<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'s</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'s</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>  
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> EF <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'s</span><span class="main">∈</span><span class="free">s</span><span class="main">::</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span> set<span class="main">.</span> <span class="skolem">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">I</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> a<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> b<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> bexE<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> EF <span class="free">s</span>"</span></span> 
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> f <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> EF_step_star<span class="main">)</span>
   <span class="keyword1"><span class="command">qed</span></span>  
  <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ATV_EF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">A</span><span class="main">;</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> attack <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span>
 <span class="main">(</span>Kripke <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">s</span><span class="main">)</span> <span class="main">}</span> <span class="free">I</span>  <span class="main">⊢</span> EF <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> AT_EF ref_pres_att ref_validity_def valid_ref_def<span class="main">)</span> 
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Completeness Theorem"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section contains the completeness direction, informally:

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹⊢ EF s ⟹ ∃ A. ⊢ A ∧ attack A = (I,s)›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

The main theorem is presented last since its
proof just summarises a number of main lemmas <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹Compl_step1, Compl_step2,
Compl_step3, Compl_step4›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> which are presented first together with other
auxiliary lemmas.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹Compl_step1›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>"</span></span>
<span class="keyword1" id="AT-Compl_step1"><span class="command">lemma</span></span> Compl_step1<span class="main">:</span> 
<span class="quoted"><span class="quoted">"Kripke <span class="main">{</span><span class="bound">s</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span> <span class="free">I</span>  <span class="main">⊢</span> EF <span class="free">s</span> 
<span class="main">⟹</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EF_step_star_rev valEF_E<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹Compl_step2›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First, we prove some auxiliary lemmas.›</span></span>
<span class="keyword1" id="AT-rtrancl_imp_singleton_seq2"><span class="command">lemma</span></span> rtrancl_imp_singleton_seq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="free">y</span> <span class="main">⟹</span> 
          <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span>tl <span class="bound">s</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">!</span> <span class="main">(</span>length <span class="bound">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> 
               <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="bound">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="bound">s</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">unfolding</span></span> state_transition_refl_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> step.IH
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE conjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span><span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> step.hyps <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">s</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> tl <span class="bound">s</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> <span class="bound">s</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span><span class="main">;</span>
          <span class="bound">s</span> <span class="main">!</span> <span class="main">(</span>length <span class="bound">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">;</span>
          <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="bound">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span>
             <span class="bound">s</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">s</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">⟧</span>
         <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">∨</span>
             <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
                  tl <span class="bound">s</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span>
                  <span class="bound">s</span> <span class="main">!</span> <span class="main">(</span>length <span class="bound">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">∧</span>
                  <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="bound">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="bound">s</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">s</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">s</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_lessI diff_Suc_1 mem_Collect_eq old.prod.case step.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AT-tl_nempty_length"><span class="command">lemma</span></span> tl_nempty_length<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> tl <span class="free">s</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="main">0</span> <span class="main">&lt;</span> length <span class="free">s</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="AT-tl_nempty_length2"><span class="command">lemma</span></span> tl_nempty_length2<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> tl <span class="free">s</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> Suc <span class="main">0</span> <span class="main">&lt;</span> length <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="AT-length_last"><span class="command">lemma</span></span> length_last<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>length <span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="AT-Compl_step2"><span class="command">lemma</span></span> Compl_step2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">y</span> <span class="main">⟹</span> 
                   <span class="main">(</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span>  <span class="bound">x</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="main">(</span><span class="bound">sl</span> <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span> set<span class="main">)</span>list<span class="main">)</span><span class="main">)</span><span class="main">.</span> 
                  <span class="main">(</span><span class="bound">sl</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>tl <span class="bound">sl</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
                 <span class="main">(</span><span class="bound">sl</span> <span class="main">!</span> <span class="main">0</span><span class="main">,</span> <span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span>length <span class="bound">sl</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
                 <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="bound">sl</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span>  <span class="main">⊢</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="bound">sl</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span><span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">)</span></sub><span class="hidden">⇙</span>
                         <span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> bexE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∨</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">sl</span><span class="main">::</span><span class="tfree">'s</span> set list<span class="main">.</span>
           <span class="bound">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
           tl <span class="bound">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
           <span class="main">(</span><span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span>length <span class="bound">sl</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="bound">sl</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="main">⊢</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="bound">sl</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> d <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∨</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
           tl <span class="bound">s'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
           <span class="bound">s'</span> <span class="main">!</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∧</span>
           <span class="bound">s'</span> <span class="main">!</span> <span class="main">(</span>length <span class="bound">s'</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="bound">s'</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">s'</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c rtrancl_imp_singleton_seq2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∨</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">sl</span><span class="main">::</span><span class="tfree">'s</span> set list<span class="main">.</span>
           <span class="bound">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
           tl <span class="bound">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
           <span class="main">(</span><span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span>length <span class="bound">sl</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="bound">sl</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="main">⊢</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="bound">sl</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE exE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">{</span><span class="improper">s'</span> <span class="main">!</span> <span class="bound">j</span><span class="main">}</span><span class="main">.</span> j <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="improper">s'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">s</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> AT.att_base Suc_lessD fst_conv prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> singletonD singletonI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> AT.att_base Suc_lessI b fst_conv prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> singletonD<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> tl_nempty_length2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹Compl_step3›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First, we need a few lemmas.›</span></span>
<span class="keyword1" id="AT-map_hd_lem"><span class="command">lemma</span></span> map_hd_lem<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">f</span> <span class="main">0</span> <span class="main">#</span>  map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> map  <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span>    
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> hd_map upt_rec<span class="main">)</span>

<span class="keyword1" id="AT-map_Suc_lem"><span class="command">lemma</span></span> map_Suc_lem<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">::</span> nat<span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">[</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span> <span class="main">=</span>
                                  map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">::</span> nat<span class="main">.</span> <span class="free">f</span><span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">0</span> <span class="main">#</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="main">0</span> <span class="main">#</span> map <span class="free">f</span> <span class="main">[</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">[</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_pred' map_hd_lem map_upt_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AT-forall_ex_fun"><span class="command">lemma</span></span> forall_ex_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">f</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> emptyI
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insertI <span class="skolem">F</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'b</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'b</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">x</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> insertI.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">from</span></span> d <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">∈</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">z</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="keyword1">then</span> <span class="skolem">y</span> <span class="keyword1">else</span> <span class="skolem">f</span> <span class="bound">z</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nodup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span> list<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> 
    nodup_nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nodup</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">[]</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
    nodup_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nodup</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∉</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">nodup</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nodup_all</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">nodup_all</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> nodup <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1" id="AT-nodup_all_lem"><span class="command">lemma</span></span> nodup_all_lem<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"nodup_all <span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>insert <span class="free">x1</span> <span class="main">(</span>insert <span class="free">a</span> <span class="main">(</span>set <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">x1</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">a</span> <span class="main">(</span>set <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodup_all_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="AT-nodup_all_tl"><span class="command">lemma</span></span> nodup_all_tl<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nodup_all <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">⟶</span> nodup_all <span class="free">l</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodup_all_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="AT-finite_nodup"><span class="command">lemma</span></span> finite_nodup<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">l</span><span class="main">.</span> set <span class="bound">l</span> <span class="main">=</span> <span class="free">I</span> <span class="main">∧</span> nodup_all <span class="bound">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> emptyI
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodup_all_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insertI <span class="skolem">A</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insertE insert_absorb list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> nodup_all_def nodup_step<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AT-Compl_step3"><span class="command">lemma</span></span> Compl_step3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> finite <span class="free">I</span> <span class="main">⟹</span>
     <span class="main">(</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span>  <span class="bound">x</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="main">(</span><span class="bound">sl</span> <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span> set<span class="main">)</span>list<span class="main">)</span><span class="main">)</span><span class="main">.</span> 
                  <span class="main">(</span><span class="bound">sl</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>tl <span class="bound">sl</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
                 <span class="main">(</span><span class="bound">sl</span> <span class="main">!</span> <span class="main">0</span><span class="main">,</span> <span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span>length <span class="bound">sl</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
                 <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="bound">sl</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span>  <span class="main">⊢</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="bound">sl</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span><span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">)</span></sub><span class="hidden">⇙</span>
                         <span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
     <span class="main">(</span><span class="main">∃</span> <span class="bound">lI</span><span class="main">.</span> set <span class="bound">lI</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span> <span class="main">::</span> <span class="tfree">'s</span> <span class="main">::</span> state<span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">s</span><span class="main">}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">Sj</span> <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span> set<span class="main">)</span>list<span class="main">)</span> list<span class="main">.</span> 
               length <span class="bound">Sj</span> <span class="main">=</span> length <span class="bound">lI</span> <span class="main">∧</span> nodup_all <span class="bound">lI</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="bound">Sj</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span>  <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>tl <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
                 <span class="main">(</span><span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span><span class="main">,</span> <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>length <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="bound">lI</span> <span class="main">!</span> <span class="bound">j</span><span class="main">}</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
                 <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span>  <span class="main">⊢</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">)</span></sub><span class="hidden">⇙</span>
                         <span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      fa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'s</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span>
       <span class="bound">x</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∨</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">sl</span><span class="main">::</span><span class="tfree">'s</span> set list<span class="main">.</span>
           <span class="bound">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
           tl <span class="bound">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
           <span class="main">(</span><span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span>length <span class="bound">sl</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="bound">sl</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="main">⊢</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="bound">sl</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">lI</span><span class="main">.</span> set <span class="bound">lI</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">::</span><span class="tfree">'s</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">s</span><span class="main">}</span> <span class="main">∧</span> nodup_all <span class="bound">lI</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f finite_nodup<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lI</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">lI</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">::</span><span class="tfree">'s</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">s</span><span class="main">}</span> <span class="main">∧</span> nodup_all <span class="skolem">lI</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">lI</span><span class="main">::</span><span class="tfree">'s</span> list<span class="main">.</span>
       set <span class="bound">lI</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">::</span><span class="tfree">'s</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">s</span><span class="main">}</span> <span class="main">∧</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Sj</span><span class="main">::</span><span class="tfree">'s</span> set list list<span class="main">.</span>
           length <span class="bound">Sj</span> <span class="main">=</span> length <span class="bound">lI</span> <span class="main">∧</span>
           nodup_all <span class="bound">lI</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="bound">Sj</span><span class="main">.</span>
               <span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
               tl <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
               <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="main">(</span>length <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="bound">lI</span> <span class="main">!</span> <span class="bound">j</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="main">⊢</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">lI</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set<span class="main">(</span><span class="skolem">lI</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">sl</span><span class="main">::</span><span class="tfree">'s</span> set list<span class="main">.</span>
              <span class="bound">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
              tl <span class="bound">sl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
              <span class="main">(</span><span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span>length <span class="bound">sl</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="bound">sl</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="main">⊢</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="bound">sl</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">sl</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b fa <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Sj</span><span class="main">::</span><span class="tfree">'s</span> set list list<span class="main">.</span>
       length <span class="bound">Sj</span> <span class="main">=</span> length <span class="skolem">lI</span> <span class="main">∧</span>
       nodup_all <span class="skolem">lI</span> <span class="main">∧</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="bound">Sj</span><span class="main">.</span>
           <span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
           tl <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
           <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="main">(</span>length <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="skolem">lI</span> <span class="main">!</span> <span class="bound">j</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="main">⊢</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="skolem">lI</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> -1<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> forall_ex_fun<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mp<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="improper">f</span> <span class="main">(</span><span class="skolem">lI</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> j <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="skolem">lI</span><span class="main">)</span><span class="main">]</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> b<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">lI</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">I</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> finite_subset<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> f<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹Compl_step4›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Again, we need some additional lemmas first.›</span></span>
<span class="keyword1" id="AT-list_one_tl_empty"><span class="command">lemma</span></span> list_one_tl_empty<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">=</span> Suc <span class="main">(</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">⟶</span> tl <span class="free">l</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="AT-list_two_tl_not_empty"><span class="command">lemma</span></span> list_two_tl_not_empty<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">list</span><span class="main">.</span> length <span class="free">l</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">(</span>length <span class="bound">list</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> tl <span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="AT-or_empty"><span class="command">lemma</span></span> or_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span><span class="main">(</span><span class="main">[]</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> att_or<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note, this is not valid for any l, i.e., <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹⊢ l ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup>({}, s)</sup><span class="hidden">⇖</span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not a theorem.›</span></span>
<span class="keyword1" id="AT-list_or_upt"><span class="command">lemma</span></span> list_or_upt<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span> <span class="main">.</span> <span class="free">lI</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> length <span class="bound">l</span> <span class="main">=</span> length <span class="free">lI</span> <span class="main">⟶</span> nodup_all <span class="free">lI</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">lI</span><span class="main">.</span> <span class="main">(</span><span class="main">⊢</span> <span class="main">(</span><span class="bound">l</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>attack <span class="main">(</span><span class="bound">l</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="free">lI</span> <span class="main">!</span> <span class="bound">i</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                <span class="main">⟶</span> <span class="main">(</span> <span class="main">⊢</span> <span class="main">(</span><span class="bound">l</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span>set <span class="free">lI</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>"</span></span>     
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">lI</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x1</span> <span class="skolem">x2</span> <span class="skolem">l</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">::</span><span class="tfree">'a</span> attree list<span class="main">.</span>
          <span class="skolem">x2</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span>
          length <span class="bound">l</span> <span class="main">=</span> length <span class="skolem">x2</span> <span class="main">⟶</span>
          nodup_all <span class="skolem">x2</span> <span class="main">⟶</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="skolem">x2</span><span class="main">.</span> <span class="main">⊢</span><span class="main">(</span><span class="bound">l</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> attack <span class="main">(</span><span class="bound">l</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x2</span> <span class="main">!</span> <span class="bound">i</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">⊢</span><span class="main">(</span><span class="bound">l</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span>set <span class="skolem">x2</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="skolem">x1</span> <span class="main">#</span> <span class="skolem">x2</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
       length <span class="skolem">l</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">x1</span> <span class="main">#</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">⟹</span>
       nodup_all <span class="main">(</span><span class="skolem">x1</span> <span class="main">#</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="main">(</span><span class="skolem">x1</span> <span class="main">#</span> <span class="skolem">x2</span><span class="main">)</span><span class="main">.</span> <span class="main">⊢</span><span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> attack <span class="main">(</span><span class="skolem">l</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="skolem">x1</span> <span class="main">#</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">⊢</span><span class="main">(</span><span class="skolem">l</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span>set <span class="main">(</span><span class="skolem">x1</span> <span class="main">#</span> <span class="skolem">x2</span><span class="main">)</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">x2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> att_or<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="skolem">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Case <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹∀i&lt;Suc (Suc (length list)). ⊢l ! i ∧ attack (l ! i) = ({(x1 # a # list) ! i}, s) ⟹
       x2 = a # list ⟹  ⊢l ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup>(insert x1 (insert a (set list)), s)</sup><span class="hidden">⇖</span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> att_or<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="skolem">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> lista<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">lista</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Remaining conjunct of three conditions: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹ ⊢aa ∧
       fst (attack aa) ⊆ insert x1 (insert a (set list)) ∧
       snd (attack aa) ⊆ s ∧ ⊢ab # listb ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup>(insert x1 (insert a (set list)) - fst (attack aa), s)</sup><span class="hidden">⇖</span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First condition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹ ⊢aa›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Second condition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹fst (attack aa) ⊆ insert x1 (insert a (set list))›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The remaining conditions 

          <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹snd (attack aa) ⊆ s ∧ ⊢ab # listb ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup>(insert x1 (insert a (set list)) - fst (attack aa), s)</sup><span class="hidden">⇖</span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
 
          are solved automatically!›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_mono add.right_neutral add_Suc_right list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> nodup_all_lem nodup_all_tl nth_Cons_0 nth_Cons_Suc order_refl prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zero_less_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AT-app_tl_empty_hd"><span class="command">lemma</span></span> app_tl_empty_hd<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟶</span> hd <span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>
       
<span class="keyword1" id="AT-tl_hd_empty"><span class="command">lemma</span></span> tl_hd_empty<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="free">l</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="AT-tl_hd_not_empty"><span class="command">lemma</span></span> tl_hd_not_empty<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>
  
<span class="keyword1" id="AT-app_tl_empty_length"><span class="command">lemma</span></span> app_tl_empty_length<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>  
                                        <span class="main">⟹</span> <span class="free">l</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> tl_hd_empty<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="AT-not_empty_hd_fst"><span class="command">lemma</span></span> not_empty_hd_fst<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> hd<span class="main">(</span><span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>
  
<span class="keyword1" id="AT-app_tl_hd_list"><span class="command">lemma</span></span> app_tl_hd_list<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>  
                             <span class="main">⟹</span> hd<span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> tl_hd_not_empty<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> not_empty_hd_fst<span class="main">)</span>

<span class="keyword1" id="AT-tl_app_in"><span class="command">lemma</span></span> tl_app_in<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span>
   map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">f</span><span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> <span class="main">(</span>Suc <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span>"</span></span>    
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="AT-map_fst"><span class="command">lemma</span></span> map_fst<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="main">0</span> <span class="main">#</span> <span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="AT-step_lem"><span class="command">lemma</span></span> step_lem<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
       tl <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
       map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="main">=</span>
                 <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x1</span><span class="main">)</span><span class="main">(</span><span class="free">a</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> b <span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="main">=</span>
                     <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">#</span> 
                     <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_fst<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> l<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Suc <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="main">=</span>
                map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Suc <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="main">=</span> map Suc <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main"><span class="keyword3">,</span></span> 
             <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_Suc_upt l<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span> <span class="main">=</span>
             <span class="free">f</span> <span class="free">x1</span> <span class="free">a</span> <span class="main">#</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> b c<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
    tl <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
    map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">l</span> <span class="main">-</span> Suc <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> a<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AT-step_lem2a"><span class="command">lemma</span></span> step_lem2a<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">list</span> <span class="main">⟹</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>
        <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">list</span><span class="main">]</span> <span class="main">@</span>
       <span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">!</span> length <span class="free">list</span><span class="main">,</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">!</span> length <span class="free">list</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span> <span class="main">=</span>
       <span class="free">aa</span> <span class="main">#</span> <span class="free">listb</span> <span class="main">⟶</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="free">x1</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="free">aa</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> map_fst<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="AT-step_lem2b"><span class="command">lemma</span></span> step_lem2b<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> length <span class="free">list</span> <span class="main">⟹</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>
        <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">list</span><span class="main">]</span> <span class="main">@</span>
       <span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">!</span> length <span class="free">list</span><span class="main">,</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">!</span> length <span class="free">list</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span> <span class="main">=</span>
       <span class="free">aa</span> <span class="main">#</span> <span class="free">listb</span> <span class="main">⟶</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="free">x1</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="free">aa</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="AT-step_lem2"><span class="command">lemma</span></span> step_lem2<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>
        <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">list</span><span class="main">]</span> <span class="main">@</span>
       <span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">!</span> length <span class="free">list</span><span class="main">,</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">!</span> length <span class="free">list</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span> <span class="main">=</span>
       <span class="free">aa</span> <span class="main">#</span> <span class="free">listb</span> <span class="main">⟹</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="free">x1</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="free">aa</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"length <span class="free">list</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> step_lem2b<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">nat</span><span class="main">.</span>
       map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">list</span><span class="main">]</span> <span class="main">@</span>
       <span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="free">x1</span> <span class="main">#</span> <span class="free">a</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">!</span> length <span class="free">list</span><span class="main">,</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">list</span><span class="main">)</span> <span class="main">!</span> length <span class="free">list</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span> <span class="main">=</span>
       <span class="free">aa</span> <span class="main">#</span> <span class="free">listb</span> <span class="main">⟹</span>
       length <span class="free">list</span> <span class="main">=</span> Suc <span class="bound">nat</span> <span class="main">⟹</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">x1</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="free">aa</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> list <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">list</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> step_lem2a<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AT-base_list_and"><span class="command">lemma</span></span> base_list_and<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Sji</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> tl <span class="free">Sji</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span>
         <span class="main">(</span><span class="main">∀</span> <span class="bound">li</span><span class="main">.</span>  <span class="free">Sji</span> <span class="main">!</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="bound">li</span> <span class="main">⟶</span>
        <span class="free">Sji</span><span class="main">!</span> <span class="main">(</span>length <span class="main">(</span><span class="free">Sji</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="main">(</span><span class="free">Sji</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="main">⊢</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">Sji</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="free">Sji</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">⊢</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">Sji</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="free">Sji</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>
          <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span><span class="free">Sji</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="bound">li</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Sji</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">Sji</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> att_and<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="skolem">Sji</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">aa</span> <span class="skolem">list</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">list</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span>
       <span class="skolem">list</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">list</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="skolem">list</span><span class="main">.</span> <span class="main">⊢</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">list</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">⊢</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">list</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">list</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="skolem">aa</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="skolem">Sji</span> <span class="main">=</span> <span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span> <span class="main">⟹</span>
       <span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> length <span class="skolem">list</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="main">(</span>length <span class="skolem">list</span><span class="main">)</span><span class="main">.</span> <span class="main">⊢</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">⟹</span>
       <span class="keyword1">case</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">list</span><span class="main">]</span> <span class="main">@</span>
            <span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> length <span class="skolem">list</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span> <span class="keyword1">of</span>
       <span class="main">[]</span> <span class="main">⇒</span> fst <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> snd <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">|</span> <span class="main">[</span><span class="bound">aa</span><span class="main">]</span> <span class="main">⇒</span> <span class="main">⊢</span><span class="bound">aa</span> <span class="main">∧</span> attack <span class="bound">aa</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span>
       <span class="main">|</span> <span class="bound">aa</span> <span class="main">#</span> <span class="bound">ab</span> <span class="main">#</span> <span class="bound">list</span> <span class="main">⇒</span>
           <span class="main">⊢</span><span class="bound">aa</span> <span class="main">∧</span> fst <span class="main">(</span>attack <span class="bound">aa</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">⊢</span><span class="main">(</span><span class="bound">ab</span> <span class="main">#</span> <span class="bound">list</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span>snd <span class="main">(</span>attack <span class="bound">aa</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">list</span><span class="main">]</span> <span class="main">@</span>
            <span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> length <span class="skolem">list</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ab</span> <span class="skolem">lista</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">list</span><span class="main">]</span><span class="main">)</span>
                    <span class="main">=</span>  <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="skolem">list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">list</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">list</span><span class="main">]</span><span class="main">)</span>
                    <span class="main">=</span>  <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="skolem">list</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> step_lem <span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">list</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="skolem">list</span><span class="main">.</span> <span class="main">⊢</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">list</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">⊢</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">list</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>
          <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">list</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="skolem">aa</span><span class="main">,</span> <span class="skolem">list</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">list</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="skolem">Sji</span> <span class="main">=</span> <span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span> <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="main">(</span>length <span class="skolem">list</span><span class="main">)</span><span class="main">.</span> <span class="main">⊢</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">⟹</span>
       map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">list</span><span class="main">]</span> <span class="main">@</span>
       <span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> length <span class="skolem">list</span><span class="main">,</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> length <span class="skolem">list</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span> <span class="main">=</span>
       <span class="skolem">ab</span> <span class="main">#</span> <span class="skolem">lista</span> <span class="main">⟹</span>
       <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> length <span class="skolem">list</span> <span class="main">⟹</span>
       <span class="keyword1">case</span> <span class="skolem">lista</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="main">⊢</span><span class="skolem">ab</span> <span class="main">∧</span> attack <span class="skolem">ab</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> length <span class="skolem">list</span><span class="main">)</span>
       <span class="main">|</span> <span class="bound">aba</span> <span class="main">#</span> <span class="bound">lista</span> <span class="main">⇒</span>
           <span class="main">⊢</span><span class="skolem">ab</span> <span class="main">∧</span> fst <span class="main">(</span>attack <span class="skolem">ab</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="main">⊢</span><span class="main">(</span><span class="bound">aba</span> <span class="main">#</span> <span class="bound">lista</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span>snd <span class="main">(</span>attack <span class="skolem">ab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">list</span><span class="main">)</span> <span class="main">!</span> length <span class="skolem">list</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> app_tl_hd_list length_greater_0_conv list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> map_fst nth_Cons_0 self_append_conv2 upt_0 zero_less_Suc<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> app_tl_hd_list attack.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fst_conv length_greater_0_conv list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> map_fst nth_Cons_0 self_append_conv2 upt_0<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> app_tl_hd_list attack.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fst_conv length_greater_0_conv list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> map_fst nth_Cons_0 self_append_conv2 upt_0<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> * One_nat_def app_tl_hd_list attack.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> length_greater_0_conv list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> map_fst nth_Cons_0 nth_Cons_pos self_append_conv2 snd_conv tl_app_in tl_append2 upt_0<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="AT-Compl_step4"><span class="command">lemma</span></span> Compl_step4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> finite <span class="free">I</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">s</span> <span class="main">⟹</span>
<span class="main">(</span><span class="main">∃</span> <span class="bound">lI</span><span class="main">.</span> set <span class="bound">lI</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">s</span><span class="main">}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">Sj</span> <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span> set<span class="main">)</span>list<span class="main">)</span> list<span class="main">.</span> 
               length <span class="bound">Sj</span> <span class="main">=</span> length <span class="bound">lI</span> <span class="main">∧</span> nodup_all <span class="bound">lI</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="bound">Sj</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span>  <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>tl <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
                 <span class="main">(</span><span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span><span class="main">,</span> <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>length <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="bound">lI</span> <span class="main">!</span> <span class="bound">j</span><span class="main">}</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
                 <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span>  <span class="main">⊢</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="bound">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">)</span></sub><span class="hidden">⇙</span>
                         <span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
 <span class="main">⟹</span>  <span class="main">∃</span> <span class="main">(</span><span class="bound">A</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span> attree<span class="main">)</span><span class="main">.</span>  <span class="main">⊢</span> <span class="bound">A</span> <span class="main">∧</span> attack <span class="bound">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">lI</span> <span class="skolem">Sj</span>
  <span class="keyword3"><span class="command">assume</span></span>  a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">lI</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">::</span><span class="tfree">'s</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">s</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">Sj</span> <span class="main">=</span> length <span class="skolem">lI</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"nodup_all <span class="skolem">lI</span> <span class="main">∧</span> 
              <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="skolem">Sj</span><span class="main">.</span> <span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
                             tl <span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
           <span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="main">(</span>length <span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="skolem">lI</span> <span class="main">!</span> <span class="bound">j</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="main">⊢</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span>    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span><span class="main">::</span><span class="tfree">'s</span> attree<span class="main">.</span> <span class="main">⊢</span><span class="bound">A</span> <span class="main">∧</span> attack <span class="bound">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">[]</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">s</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="main">[</span><span class="main">[</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">.</span> 
      i <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">-</span><span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">(</span><span class="main">{</span><span class="skolem">lI</span> <span class="main">!</span> <span class="bound">j</span><span class="main">}</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">.</span> j <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="skolem">Sj</span><span class="main">)</span><span class="main">]</span><span class="main">]</span>
     ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">s</span><span class="main">}</span><span class="main">,</span><span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⊢</span><span class="main">(</span><span class="main">[</span><span class="main">[]</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">::</span><span class="tfree">'s</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">s</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">,</span>
       map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span>
               <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>
                <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">{</span><span class="skolem">lI</span> <span class="main">!</span> <span class="bound">j</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>
       <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">Sj</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">::</span><span class="tfree">'s</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">s</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">::</span><span class="tfree">'s</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">s</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">::</span><span class="tfree">'s</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">s</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span><span class="main">(</span><span class="main">[</span><span class="main">[]</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">::</span><span class="tfree">'s</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">s</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">,</span>
       <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span>
               <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>
                <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">{</span><span class="skolem">lI</span> <span class="main">!</span> <span class="bound">j</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>
       <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">Sj</span><span class="main">]</span><span class="main">)</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">::</span><span class="tfree">'s</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">s</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> att_or<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> 
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">s</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">s</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">⊢</span><span class="main">(</span><span class="main">[]</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">s</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> CollectD att_or_empty_back subsetI<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">s</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">s</span><span class="main">}</span> <span class="main">⟹</span>
    <span class="main">⊢</span><span class="main">(</span><span class="main">[</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">]</span><span class="main">)</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">{</span><span class="skolem">lI</span> <span class="main">!</span> <span class="bound">j</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>
        <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">Sj</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">s</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∨</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">s</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Use lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹list_or_upt›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to distribute attack validity  over list lI›</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> ssubst<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> att_or<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subst<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> d<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> lI <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">lI</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> list_or_upt<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lI</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> c d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span>
       <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">lI</span> <span class="main">⟹</span>
       <span class="main">⊢</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span>
                 <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>
                  <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">{</span><span class="skolem">lI</span> <span class="main">!</span> <span class="bound">j</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>
          <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">Sj</span><span class="main">]</span> <span class="main">!</span>
         <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span>attack
        <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span>
                 <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>
                  <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">{</span><span class="skolem">lI</span> <span class="main">!</span> <span class="bound">j</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span><span class="main">)</span>
          <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">Sj</span><span class="main">]</span> <span class="main">!</span>
         <span class="bound">i</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="main">{</span><span class="skolem">lI</span> <span class="main">!</span> <span class="bound">i</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a b c d e f<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span>
                <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">lI</span> <span class="main">⟹</span>
                <span class="main">⊢</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">!</span> <span class="bound">ia</span><span class="main">,</span> <span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">!</span> Suc <span class="bound">ia</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span>
                <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">(</span><span class="main">0</span><span class="main">)</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">{</span><span class="skolem">lI</span> <span class="main">!</span> <span class="bound">i</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
              <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">lI</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">⊢</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">na</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">!</span> <span class="bound">na</span><span class="main">,</span> <span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">!</span> Suc <span class="bound">na</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> length <span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">!</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">!</span> <span class="main">(</span>length <span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span></sup><span class="hidden">⇖</span> <span class="main">∨</span> <span class="main">¬</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">Sj</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> One_nat_def add.right_neutral add_Suc_right base_list_and f<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">!</span> <span class="bound">n</span><span class="main">,</span> <span class="skolem">Sj</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">!</span> Suc <span class="bound">n</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> length <span class="main">(</span><span class="skolem">Sj</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="main">{</span><span class="skolem">lI</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">}</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span></sup><span class="hidden">⇖</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> One_nat_def e f<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e f<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Main Theorem Completeness›</span></span> 
<span class="keyword1"><span class="command">theorem</span></span> Completeness<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> finite <span class="free">I</span> <span class="main">⟹</span> 
Kripke <span class="main">{</span><span class="bound">s</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="free">I</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span>set<span class="main">)</span>  <span class="main">⊢</span> EF <span class="free">s</span> 
<span class="main">⟹</span> <span class="main">∃</span> <span class="main">(</span><span class="bound">A</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span> attree<span class="main">)</span><span class="main">.</span> <span class="main">⊢</span> <span class="bound">A</span> <span class="main">∧</span> attack <span class="bound">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> finite <span class="free">I</span> <span class="main">⟹</span>
    Kripke <span class="main">{</span><span class="bound">s</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">::</span><span class="tfree">'s</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">s</span><span class="main">}</span> <span class="free">I</span> <span class="main">⊢</span> EF <span class="free">s</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">A</span><span class="main">::</span><span class="tfree">'s</span> attree<span class="main">.</span> <span class="main">⊢</span><span class="bound">A</span> <span class="main">∧</span> attack <span class="bound">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> att_or_empty_back attack.simps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> finite <span class="free">I</span> <span class="main">⟹</span>
    Kripke <span class="main">{</span><span class="bound">s</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">::</span><span class="tfree">'s</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">s</span><span class="main">}</span> <span class="free">I</span> <span class="main">⊢</span> EF <span class="free">s</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">s</span> 
   <span class="main">⟹</span> <span class="main">∃</span><span class="bound">A</span><span class="main">::</span><span class="tfree">'s</span> attree<span class="main">.</span> <span class="main">⊢</span><span class="bound">A</span> <span class="main">∧</span> attack <span class="bound">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Compl_step1 Compl_step2 Compl_step3 Compl_step4 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Contrapositions of Correctness and Completeness›</span></span>   
<span class="keyword1" id="AT-contrapos_compl"><span class="command">lemma</span></span> contrapos_compl<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> finite <span class="free">I</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="main">(</span><span class="bound">A</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span> attree<span class="main">)</span><span class="main">.</span> <span class="main">⊢</span> <span class="bound">A</span> <span class="main">∧</span> attack <span class="bound">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">¬</span> <span class="main">(</span>Kripke <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">s</span><span class="main">}</span> <span class="free">I</span> <span class="main">⊢</span> EF <span class="main">(</span><span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Completeness <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="AT-contrapos_corr"><span class="command">lemma</span></span> contrapos_corr<span class="main">:</span>   
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span><span class="main">(</span>Kripke <span class="main">{</span><span class="bound">s</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">::</span> state<span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span> <span class="free">I</span>  <span class="main">⊢</span> EF <span class="free">s</span><span class="main">)</span><span class="main">)</span>
<span class="main">⟹</span> attack <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> 
<span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="main">⊢</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> AT_EF <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Infrastructure">
<div class="head">
<h1>Theory Infrastructure</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Infrastructures›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The Isabelle Infrastructure framework supports the representation of infrastructures 
as graphs with actors and policies attached to nodes. These infrastructures 
are the {\it states} of the Kripke structure. 
The transition between states is triggered by non-parametrized
actions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹get, move, eval, put›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> executed by actors. 
Actors are given by an abstract type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹actor›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and a function 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹Actor›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that creates elements of that type from identities 
(of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹string›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). Policies are given by pairs of predicates 
(conditions) and sets of (enabled) actions.›</span></span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Actors, actions, and data labels›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Infrastructure
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="AT.html">AT</a> 
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">datatype</span></span> action <span class="main">=</span> get <span class="main">|</span> move <span class="main">|</span> eval <span class="main">|</span> put

<span class="keyword1"><span class="command">typedecl</span></span> actor 
<span class="keyword1"><span class="command">type_synonym</span></span> identity <span class="main">=</span> <span class="quoted">string</span>
<span class="keyword1"><span class="command">consts</span></span> Actor <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> actor"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> policy <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>actor <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">*</span> action set<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ID</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>actor<span class="main">,</span> string<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ID</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> Actor <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The Decentralised Label Model (DLM) \cite{ml:98} introduced the idea to
label data by owners and readers. We pick up this idea and formalize
a new type to encode the owner and the set of readers as a pair.
The first element is the owner of a data item, the second one is the
set of all actors that may access the data item.
This enables the unique security 
labelling of data within the system additionally taking the ownership into 
account.›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> data <span class="main">=</span> <span class="quoted">nat</span>  
<span class="keyword1"><span class="command">type_synonym</span></span> dlm <span class="main">=</span> <span class="quoted"><span class="quoted">"actor <span class="main">*</span> actor set"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Infrastructure graphs and policies›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Actors are contained in an infrastructure graph. An <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹igraph›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> contains
a set of location pairs representing the topology of the infrastructure
as a graph of nodes and a list of actor identities associated to each node 
(location) in the graph.
Also an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹igraph›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> associates actors to a pair of string sets by
a pair-valued function whose first range component is a set describing
the credentials in the possession of an actor and the second component
is a set defining the roles the actor can take on. More importantly in this 
context, an  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹igraph›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> assigns locations to a pair of a string that defines
the state of the component and an element of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹(dlm * data) set›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This
set of labelled data may represent a condition on that data.
Corresponding projection functions for each of these components of an 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹igraph›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are provided; they are named <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹gra›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the actual set of pairs of
locations, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹agra›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the actor map, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹cgra›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the credentials,
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹lgra›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the state of a location and the data at that location.›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> location <span class="main">=</span> Location <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">datatype</span></span> igraph <span class="main">=</span> Lgraph <span class="quoted"><span class="quoted">"<span class="main">(</span>location <span class="main">*</span> location<span class="main">)</span>set"</span></span> <span class="quoted"><span class="quoted">"location <span class="main">⇒</span> identity set"</span></span>
                           <span class="quoted"><span class="quoted">"actor <span class="main">⇒</span> <span class="main">(</span>string set <span class="main">*</span> string set<span class="main">)</span>"</span></span>  
                           <span class="quoted"><span class="quoted">"location <span class="main">⇒</span> string <span class="main">*</span> <span class="main">(</span>dlm <span class="main">*</span> data<span class="main">)</span> set"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> infrastructure <span class="main">=</span> 
         Infrastructure <span class="quoted"><span class="quoted">"igraph"</span></span> 
                        <span class="quoted"><span class="quoted">"<span class="main">[</span>igraph<span class="main">,</span> location<span class="main">]</span> <span class="main">⇒</span> policy set"</span></span> 
                       
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">loc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"location <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">loc</span><span class="main">(</span>Location <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">gra</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"igraph <span class="main">⇒</span> <span class="main">(</span>location <span class="main">*</span> location<span class="main">)</span>set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">gra</span><span class="main">(</span>Lgraph <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">agra</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"igraph <span class="main">⇒</span> <span class="main">(</span>location <span class="main">⇒</span> identity set<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">agra</span><span class="main">(</span>Lgraph <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">cgra</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"igraph <span class="main">⇒</span> <span class="main">(</span>actor <span class="main">⇒</span> string set <span class="main">*</span> string set<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">cgra</span><span class="main">(</span>Lgraph <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lgra</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"igraph <span class="main">⇒</span> <span class="main">(</span>location <span class="main">⇒</span> string <span class="main">*</span> <span class="main">(</span>dlm <span class="main">*</span> data<span class="main">)</span> set<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">lgra</span><span class="main">(</span>Lgraph <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"igraph <span class="main">⇒</span> location set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">nodes</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">==</span> <span class="main">{</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">?</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">:</span> gra <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">:</span> gra <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">actors_graph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"igraph <span class="main">⇒</span> identity set"</span></span>  
<span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">actors_graph</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">==</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">?</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">:</span> nodes <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>agra <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There are projection functions text{@ <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>graphI›</span></span></span></span>} and text{@ <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>delta›</span></span></span></span>} when applied
to an infrastructure return the graph and the policy, respectively. Other projections
are introduced for the labels, the credential, and roles and to express their meaning.›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">graphI</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"infrastructure <span class="main">⇒</span> igraph"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">graphI</span> <span class="main">(</span>Infrastructure <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">delta</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>infrastructure<span class="main">,</span> igraph<span class="main">,</span> location<span class="main">]</span> <span class="main">⇒</span> policy set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">delta</span> <span class="main">(</span>Infrastructure <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">tspace</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>infrastructure<span class="main">,</span> actor <span class="main">]</span> <span class="main">⇒</span> string set <span class="main">*</span> string set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">tspace</span> <span class="main">(</span>Infrastructure <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> cgra <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lspace</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>infrastructure<span class="main">,</span> location <span class="main">]</span> <span class="main">⇒</span> string <span class="main">*</span> <span class="main">(</span>dlm <span class="main">*</span> data<span class="main">)</span>set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lspace</span> <span class="main">(</span>Infrastructure <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> lgra <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">credentials</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string set <span class="main">*</span> string set <span class="main">⇒</span> string set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">credentials</span> <span class="free"><span class="bound"><span class="entity">lxl</span></span></span> <span class="main">≡</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">lxl</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>igraph<span class="main">,</span> actor <span class="main">*</span> string<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">has</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">ac</span></span></span> <span class="main">≡</span> snd <span class="free"><span class="bound"><span class="entity">ac</span></span></span> <span class="main">∈</span> credentials<span class="main">(</span>cgra <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">ac</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">roles</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string set <span class="main">*</span> string set <span class="main">⇒</span> string set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">roles</span> <span class="free"><span class="bound"><span class="entity">lxl</span></span></span> <span class="main">≡</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">lxl</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">role</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>igraph<span class="main">,</span> actor <span class="main">*</span> string<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">role</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">ac</span></span></span> <span class="main">≡</span> snd <span class="free"><span class="bound"><span class="entity">ac</span></span></span> <span class="main">∈</span> roles<span class="main">(</span>cgra <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">ac</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>igraph<span class="main">,</span>location<span class="main">,</span> string<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isin</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> fst <span class="main">(</span>lgra <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Predicates and projections for the labels to encode their meaning.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">owner</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dlm <span class="main">*</span> data <span class="main">⇒</span> actor"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">owner</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≡</span> fst<span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">owns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>igraph<span class="main">,</span> location<span class="main">,</span> actor<span class="main">,</span> dlm <span class="main">*</span> data<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">owns</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≡</span> owner <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">readers</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dlm <span class="main">*</span> data <span class="main">⇒</span> actor set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">readers</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≡</span> snd <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹has_access›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is true for owners or readers.›</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has_access</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>igraph<span class="main">,</span> location<span class="main">,</span> actor<span class="main">,</span> dlm <span class="main">*</span> data<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>    
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">has_access</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≡</span> owns <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> readers <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span>

<span class="comment1">(*
text ‹Actors can delete data.›
definition actor_can_delete ::   "[infrastructure, actor, location] ⇒ bool"
where actor_can_delete_def: "actor_can_delete I h l ≡  
                   (∀ as n. ((h, as), n) ∉ (snd (lgra (graphI I) l)))"
*)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a type of functions that preserves the security labeling and a 
   corresponding function application  operator.›</span></span>  
<span class="keyword1"><span class="command">typedef</span></span> label_fun <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span> <span class="main">::</span> dlm <span class="main">*</span> data <span class="main">⇒</span> dlm <span class="main">*</span> data<span class="main">.</span> 
                        <span class="main">∀</span> <span class="bound">x</span><span class="main">::</span> dlm <span class="main">*</span> data<span class="main">.</span> fst <span class="bound">x</span> <span class="main">=</span> fst <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">secure_process</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"label_fun <span class="main">⇒</span> dlm <span class="main">*</span> data <span class="main">⇒</span> dlm <span class="main">*</span> data"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⇕</span>"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span>  <span class="main"><span class="free">⇕</span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≡</span> <span class="main">(</span>Rep_label_fun <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span> 

<span class="comment1">(* This part is relevant to model Insiders but is not needed for Infrastructures.

datatype psy_states = happy | depressed | disgruntled | angry | stressed
datatype motivations = financial | political | revenge | curious | competitive_advantage | power | peer_recognition

datatype actor_state = Actor_state "psy_states" "motivations set"
primrec motivation :: "actor_state ⇒ motivations set" 
where "motivation  (Actor_state p m) =  m"
primrec psy_state :: "actor_state ⇒ psy_states" 
where "psy_state  (Actor_state p m) = p"

definition tipping_point :: "actor_state ⇒ bool" where
  "tipping_point a ≡ ((motivation a ≠ {}) ∧ (happy ≠ psy_state a))"

consts astate :: "identity ⇒ actor_state"

(* Two versions of an impersonation predicate "a can act as b". 
   The first one is stronger and allows substitution of the insider in any context; 
   the second one is parameterized over a context predicate to describe this.   *)
definition UasI ::  "[identity, identity] ⇒ bool " 
where "UasI a b ≡ (Actor a = Actor b) ∧ (∀ x y. x ≠ a ∧ y ≠ a ∧ Actor x = Actor y ⟶ x = y)"

definition UasI' ::  "[actor =&gt; bool, identity, identity] ⇒ bool " 
where "UasI' P a b ≡ P (Actor b) ⟶ P (Actor a)"

definition Insider :: "[identity, identity set] ⇒ bool" 
where "Insider a C ≡ (tipping_point (astate a) ⟶ (∀ b∈C. UasI a b))"

definition Insider' :: "[actor ⇒ bool, identity, identity set] ⇒ bool" 
where "Insider' P a C ≡ (tipping_point (astate a) ⟶ (∀ b∈C. UasI' P a b ∧ inj_on Actor C))"
*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The predicate atI -- mixfix syntax <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹@<span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> -- expresses that an actor (identity) 
      is at a certain location in an igraph.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">atI</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>identity<span class="main">,</span> igraph<span class="main">,</span> location<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">@⇘</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">⇙</span> _"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> @<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">G</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="main">(</span>agra <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Policies specify the expected behaviour of actors of an infrastructure. 
They are defined by the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹enables›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> predicate:
an actor <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹h›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is enabled to perform an action <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹a›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
in infrastructure <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹I›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, at location <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹l›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
if there exists a pair <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹(p,e)›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the local policy of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹l›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹delta I l›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> projects to the local policy) such that the action 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹a›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a member of the action set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹e›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and the policy 
predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹p›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> holds for actor <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹h›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">enables</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>infrastructure<span class="main">,</span> location<span class="main">,</span> actor<span class="main">,</span> action<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">enables</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">≡</span>  <span class="main">(</span><span class="main">∃</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> delta <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>graphI <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">∈</span> <span class="bound">e</span> <span class="main">∧</span> <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The behaviour is the good behaviour, i.e. everything allowed by the policy of infrastructure I.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">behaviour</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"infrastructure <span class="main">⇒</span> <span class="main">(</span>location <span class="main">*</span> actor <span class="main">*</span> action<span class="main">)</span>set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">behaviour</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">.</span> enables <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">t</span> <span class="bound">a</span> <span class="bound">a'</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The misbehaviour is the complement of the behaviour of an infrastructure I.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">misbehaviour</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"infrastructure <span class="main">⇒</span> <span class="main">(</span>location <span class="main">*</span> actor <span class="main">*</span> action<span class="main">)</span>set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">misbehaviour</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> <span class="main">-</span><span class="main">(</span>behaviour <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"State transition on infrastructures"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The state transition defines how actors may act on infrastructures through actions
    within the boundaries of the policy. It is given as an inductive definition over the 
    states which are infrastructures.  This state transition relation is dependent on actions but also on
    enabledness and the current state of the infrastructure.

    First we introduce some auxiliary functions dealing
    with repetitions in lists and actors moving in an igraph.›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">jonce</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span> list<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
jonce_nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">jonce</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">[]</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
jonce_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">jonce</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∉</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">jonce</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span>"</span></span>
<span class="comment1">(*
primrec nodup :: "['a, 'a list] ⇒ bool"
  where 
    nodup_nil: "nodup a [] = True" |
    nodup_step: "nodup a (x # ls) = (if x = a then (a ∉ (set ls)) else nodup a ls)"
*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">move_graph_a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>identity<span class="main">,</span> location<span class="main">,</span> location<span class="main">,</span> igraph<span class="main">]</span> <span class="main">⇒</span> igraph"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">move_graph_a</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> Lgraph <span class="main">(</span>gra <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> 
                    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span>agra <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">&amp;</span>  <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∉</span> <span class="main">(</span><span class="main">(</span>agra <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span> <span class="keyword1">then</span> 
                     <span class="main">(</span><span class="main">(</span>agra <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">:=</span> <span class="main">(</span>agra <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">:=</span> <span class="main">(</span>insert <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>agra <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                     <span class="keyword1">else</span> <span class="main">(</span>agra <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">(</span>cgra <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">(</span>lgra <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">state_transition_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>infrastructure<span class="main">,</span> infrastructure<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">→<span class="hidden">⇩</span><sub>n</sub></span> _<span class="keyword3">)</span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  move<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> graphI <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> @<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">G</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∈</span> nodes <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">∈</span> nodes <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">;</span>
          <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">∈</span> actors_graph<span class="main">(</span>graphI <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span><span class="main">;</span> enables <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">(</span>Actor <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> move<span class="main">;</span>
         <span class="free"><span class="bound"><span class="entity">I'</span></span></span> <span class="main">=</span> Infrastructure <span class="main">(</span>move_graph_a <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">(</span>graphI <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">(</span>delta <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="free"><span class="bound"><span class="entity">I'</span></span></span>"</span></span> 
<span class="main">|</span> get <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> graphI <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> @<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">G</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span> @<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">G</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span> has <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>Actor <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span><span class="main">;</span>
        enables <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Actor <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> get<span class="main">;</span>
        <span class="free"><span class="bound"><span class="entity">I'</span></span></span> <span class="main">=</span> Infrastructure 
                   <span class="main">(</span>Lgraph <span class="main">(</span>gra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">(</span>agra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>
                           <span class="main">(</span><span class="main">(</span>cgra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">(</span>Actor <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">:=</span> 
                                <span class="main">(</span>insert <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">(</span>fst<span class="main">(</span>cgra <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>Actor <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> snd<span class="main">(</span>cgra <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>Actor <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                           <span class="main">(</span>lgra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span>
                   <span class="main">(</span>delta <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>
         <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="free"><span class="bound"><span class="entity">I'</span></span></span>"</span></span>
<span class="main">|</span> get_data <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> graphI <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> @<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">G</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">⟹</span>
        enables <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">(</span>Actor <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> get <span class="main">⟹</span> 
       <span class="main">(</span><span class="main">(</span>Actor <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">(</span>lgra <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span> <span class="main">⟹</span> Actor <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">⟹</span> 
        <span class="free"><span class="bound"><span class="entity">I'</span></span></span> <span class="main">=</span> Infrastructure 
                   <span class="main">(</span>Lgraph <span class="main">(</span>gra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">(</span>agra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">(</span>cgra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>
                   <span class="main">(</span><span class="main">(</span>lgra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">:=</span> <span class="main">(</span>fst <span class="main">(</span>lgra <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">,</span> 
                                   snd <span class="main">(</span>lgra <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>  <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span>Actor <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">(</span>delta <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>
         <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="free"><span class="bound"><span class="entity">I'</span></span></span>"</span></span>
<span class="main">|</span> process <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> graphI <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> @<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">G</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">⟹</span>
        enables <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Actor <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> eval <span class="main">⟹</span> 
       <span class="main">(</span><span class="main">(</span>Actor <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">(</span>lgra <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">⟹</span> Actor <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">⟹</span>
        <span class="free"><span class="bound"><span class="entity">I'</span></span></span> <span class="main">=</span> Infrastructure 
                   <span class="main">(</span>Lgraph <span class="main">(</span>gra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">(</span>agra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">(</span>cgra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>
                   <span class="main">(</span><span class="main">(</span>lgra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">:=</span> <span class="main">(</span>fst <span class="main">(</span>lgra <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">,</span> 
                    snd <span class="main">(</span>lgra <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>  <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span>Actor <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">}</span>
                    <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">::</span> label_fun<span class="main">)</span> <span class="main">⇕</span> <span class="main">(</span><span class="main">(</span>Actor <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">(</span>delta <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>
         <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="free"><span class="bound"><span class="entity">I'</span></span></span>"</span></span>  
<span class="main">|</span> del_data <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> graphI <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">actors</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∈</span> nodes <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">⟹</span>
       <span class="main">(</span><span class="main">(</span>Actor <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">(</span>lgra <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">⟹</span> 
        <span class="free"><span class="bound"><span class="entity">I'</span></span></span> <span class="main">=</span> Infrastructure 
                   <span class="main">(</span>Lgraph <span class="main">(</span>gra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">(</span>agra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">(</span>cgra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>
                   <span class="main">(</span><span class="main">(</span>lgra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">:=</span> <span class="main">(</span>fst <span class="main">(</span>lgra <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span>lgra <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span>Actor <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">(</span>delta <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>
         <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="free"><span class="bound"><span class="entity">I'</span></span></span>"</span></span>
<span class="main">|</span> put <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> graphI <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> @<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">G</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">⟹</span> enables <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Actor <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> put <span class="main">⟹</span>
        <span class="free"><span class="bound"><span class="entity">I'</span></span></span> <span class="main">=</span> Infrastructure 
                  <span class="main">(</span>Lgraph <span class="main">(</span>gra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">(</span>agra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">(</span>cgra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>
                          <span class="main">(</span><span class="main">(</span>lgra <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">:=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> snd <span class="main">(</span>lgra <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span>Actor <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">(</span>delta <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>
          <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="free"><span class="bound"><span class="entity">I'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that the type infrastructure can now be instantiated to the axiomatic type class 
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span><span class="raw_text"><span class="raw_text">‹state›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> which enables the use of the underlying Kripke structures and CTL.›</span></span>
<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"infrastructure"</span> <span class="main">::</span> <span class="quoted">state</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
   state_transition_infra_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="main">::</span> infrastructure<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> MC.class.MC.state.of_class.intro<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">state_transition_in_refl</span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">→<span class="hidden">⇩</span><sub>n</sub>*</span> _<span class="keyword3">)</span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>n</sub>*</span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> state_transition_in <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
      
<span class="keyword1" id="Infrastructure-move_graph_eq"><span class="command">lemma</span></span> move_graph_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"move_graph_a <span class="free">a</span> <span class="free">l</span> <span class="free">l</span> <span class="free">g</span> <span class="main">=</span> <span class="free">g</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> move_graph_a_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="free">g</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
     
<span class="keyword2"><span class="keyword">end</span></span>

  </pre>
</div><div id="GDPRhealthcare">
<div class="head">
<h1>Theory GDPRhealthcare</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Application example from IoT healthcare›</span></span> 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The  example of an IoT healthcare systems is taken from the context of the CHIST-ERA project
SUCCESS \cite{suc:16}.  In this system architecture, data is collected by sensors 
in the home or via a smart phone helping to monitor bio markers of the patient. The data 
collection is in a cloud based server to enable hospitals (or scientific institutions) 
to access the data which is controlled via the smart phone.
The identities Patient and Doctor represent patients
and their doctors; double quotes ''s'' indicate strings 
in Isabelle/HOL.
The global policy is `only the patient and the doctor can access the data in the cloud'.›</span></span>
<span class="keyword1"><span class="command">theory</span></span> GDPRhealthcare
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Infrastructure.html">Infrastructure</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Local policies are represented as a function over an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹igraph G›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
      that additionally assigns each location of a scenario to its local policy 
      given as a pair of requirements to an actor (first element of the pair) in 
      order to grant him actions in the location (second element of the pair). 
      The predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹@G›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> checks whether an actor is at a given location 
       in the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹igraph G›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> scenarioGDPR <span class="main">=</span> 
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">gdpr_actors</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"identity set"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> gdpr_actors_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gdpr_actors</span> <span class="main">≡</span> <span class="main">{</span><span class="inner_quoted">''Patient''</span><span class="main">,</span> <span class="inner_quoted">''Doctor''</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">gdpr_locations</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"location set"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> gdpr_locations_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gdpr_locations</span> <span class="main">≡</span> 
          <span class="main">{</span>Location <span class="main">0</span><span class="main">,</span> Location <span class="main">1</span><span class="main">,</span> Location <span class="numeral">2</span><span class="main">,</span> Location <span class="numeral">3</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sphone</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"location"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> sphone_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sphone</span> <span class="main">≡</span> Location <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">home</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"location"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> home_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">home</span> <span class="main">≡</span> Location <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">hospital</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"location"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> hospital_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hospital</span> <span class="main">≡</span> Location <span class="numeral">2</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cloud</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"location"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> cloud_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cloud</span> <span class="main">≡</span> Location <span class="numeral">3</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">global_policy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>infrastructure<span class="main">,</span> identity<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> global_policy_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">global_policy</span> <span class="free">I</span> <span class="free">a</span> <span class="main">≡</span> <span class="free">a</span> <span class="main">≠</span> <span class="inner_quoted">''Doctor''</span> 
                 <span class="main">⟶</span> <span class="main">¬</span><span class="main">(</span>enables <span class="free">I</span> <span class="free">hospital</span> <span class="main">(</span>Actor <span class="free">a</span><span class="main">)</span> eval<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">global_policy'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>infrastructure<span class="main">,</span> identity<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> global_policy'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">global_policy'</span> <span class="free">I</span> <span class="free">a</span> <span class="main">≡</span> <span class="free">a</span> <span class="main">∉</span> <span class="free">gdpr_actors</span> 
                 <span class="main">⟶</span> <span class="main">¬</span><span class="main">(</span>enables <span class="free">I</span> <span class="free">cloud</span> <span class="main">(</span>Actor <span class="free">a</span><span class="main">)</span> get<span class="main">)</span>"</span></span>  
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ex_creds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"actor <span class="main">⇒</span> <span class="main">(</span>string set <span class="main">*</span> string set<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> ex_creds_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ex_creds</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> Actor <span class="inner_quoted">''Patient''</span> <span class="keyword1">then</span> 
                         <span class="main">(</span><span class="main">{</span><span class="inner_quoted">''PIN''</span><span class="main">,</span><span class="inner_quoted">''skey''</span><span class="main">}</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="keyword1">else</span> 
                            <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> Actor <span class="inner_quoted">''Doctor''</span> <span class="keyword1">then</span>
                                <span class="main">(</span><span class="main">{</span><span class="inner_quoted">''PIN''</span><span class="main">}</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ex_locs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"location <span class="main">⇒</span> string <span class="main">*</span> <span class="main">(</span>dlm <span class="main">*</span> data<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ex_locs</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span>  <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">cloud</span> <span class="keyword1">then</span>
             <span class="main">(</span><span class="inner_quoted">''free''</span><span class="main">,</span><span class="main">{</span><span class="main">(</span><span class="main">(</span>Actor <span class="inner_quoted">''Patient''</span><span class="main">,</span><span class="main">{</span>Actor <span class="inner_quoted">''Doctor''</span><span class="main">}</span><span class="main">)</span><span class="main">,</span><span class="numeral">42</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> 
             <span class="keyword1">else</span> <span class="main">(</span><span class="inner_quoted">''''</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ex_loc_ass</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"location <span class="main">⇒</span> identity set"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> ex_loc_ass_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ex_loc_ass</span> <span class="main">≡</span>
          <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span>  <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">home</span> <span class="keyword1">then</span> <span class="main">{</span><span class="inner_quoted">''Patient''</span><span class="main">}</span>  
                 <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">hospital</span> <span class="keyword1">then</span> <span class="main">{</span><span class="inner_quoted">''Doctor''</span><span class="main">,</span> <span class="inner_quoted">''Eve''</span><span class="main">}</span> 
                       <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(* The nicer representation with case suffers from
   not so nice presentation in the cases (need to unfold the syntax)  
fixes ex_loc_ass_alt :: "location ⇒ identity set"
defines ex_loc_ass_alt_def: "ex_loc_ass_alt ≡
          (λ x.  (case x of 
             Location (Suc 0) ⇒ {''Patient''}  
           | Location (Suc (Suc 0)) ⇒ {''Doctor'', ''Eve''} 
           |  _ ⇒ {}))"
*)</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ex_graph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"igraph"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> ex_graph_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ex_graph</span> <span class="main">≡</span> Lgraph 
     <span class="main">{</span><span class="main">(</span><span class="free">home</span><span class="main">,</span> <span class="free">cloud</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">sphone</span><span class="main">,</span> <span class="free">cloud</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">cloud</span><span class="main">,</span><span class="free">hospital</span><span class="main">)</span><span class="main">}</span>
     <span class="free">ex_loc_ass</span>
     <span class="free">ex_creds</span> <span class="free">ex_locs</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ex_graph'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"igraph"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> ex_graph'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ex_graph'</span> <span class="main">≡</span> Lgraph 
     <span class="main">{</span><span class="main">(</span><span class="free">home</span><span class="main">,</span> <span class="free">cloud</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">sphone</span><span class="main">,</span> <span class="free">cloud</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">cloud</span><span class="main">,</span><span class="free">hospital</span><span class="main">)</span><span class="main">}</span>
       <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">cloud</span> <span class="keyword1">then</span> <span class="main">{</span><span class="inner_quoted">''Patient''</span><span class="main">}</span> <span class="keyword1">else</span> 
           <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">hospital</span> <span class="keyword1">then</span> <span class="main">{</span><span class="inner_quoted">''Doctor''</span><span class="main">,</span><span class="inner_quoted">''Eve''</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span> 
     <span class="free">ex_creds</span> <span class="free">ex_locs</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ex_graph''</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"igraph"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> ex_graph''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ex_graph''</span> <span class="main">≡</span> Lgraph 
     <span class="main">{</span><span class="main">(</span><span class="free">home</span><span class="main">,</span> <span class="free">cloud</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">sphone</span><span class="main">,</span> <span class="free">cloud</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">cloud</span><span class="main">,</span><span class="free">hospital</span><span class="main">)</span><span class="main">}</span>
       <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">cloud</span> <span class="keyword1">then</span> <span class="main">{</span><span class="inner_quoted">''Patient''</span><span class="main">,</span> <span class="inner_quoted">''Eve''</span><span class="main">}</span> <span class="keyword1">else</span> 
           <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">hospital</span> <span class="keyword1">then</span> <span class="main">{</span><span class="inner_quoted">''Doctor''</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span> 
     <span class="free">ex_creds</span> <span class="free">ex_locs</span>"</span></span>
<span class="comment1">(* Same as above: the nicer representation with case suffers from
   not so nice presentation in the cases (need to unfold the syntax) 
fixes local_policies_alt :: "[igraph, location] ⇒ policy set"
defines local_policies_alt_def: "local_policies_alt G ≡ 
    (λ x. case x of 
         Location (Suc 0) ⇒ {(λ y. True, {put,get,move,eval})}
       | Location 0 ⇒ {((λ y. has G (y, ''PIN'')), {put,get,move,eval})} 
       | Location (Suc (Suc (Suc 0))) ⇒ {(λ y. True, {put,get,move,eval})}
       | Location (Suc (Suc 0)) ⇒
                {((λ y. (∃ n. (n  @<span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> hospital) ∧ Actor n = y ∧ 
                           has G (y, ''skey''))), {put,get,move,eval})} 
       | _ ⇒  {})"
*)</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">local_policies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>igraph<span class="main">,</span> location<span class="main">]</span> <span class="main">⇒</span> policy set"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> local_policies_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">local_policies</span> <span class="free">G</span> <span class="main">≡</span> 
    <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">home</span> <span class="keyword1">then</span>
        <span class="main">{</span><span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> True<span class="main">,</span> <span class="main">{</span>put<span class="main">,</span>get<span class="main">,</span>move<span class="main">,</span>eval<span class="main">}</span><span class="main">)</span><span class="main">}</span>
          <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">sphone</span> <span class="keyword1">then</span> 
             <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> has <span class="free">G</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="inner_quoted">''PIN''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">{</span>put<span class="main">,</span>get<span class="main">,</span>move<span class="main">,</span>eval<span class="main">}</span><span class="main">)</span><span class="main">}</span> 
                <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">cloud</span> <span class="keyword1">then</span>
                <span class="main">{</span><span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> True<span class="main">,</span> <span class="main">{</span>put<span class="main">,</span>get<span class="main">,</span>move<span class="main">,</span>eval<span class="main">}</span><span class="main">)</span><span class="main">}</span>
                       <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">hospital</span> <span class="keyword1">then</span>
                <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span>  @<span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">hospital</span><span class="main">)</span> <span class="main">∧</span> Actor <span class="bound">n</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">∧</span> 
                           has <span class="free">G</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="inner_quoted">''skey''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">{</span>put<span class="main">,</span>get<span class="main">,</span>move<span class="main">,</span>eval<span class="main">}</span><span class="main">)</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(* problems with case in locales?
defines local_policies_def: "local_policies G x ≡ 
     (case x of 
       home ⇒ {(λ y. True, {put,get,move,eval})}
     | sphone ⇒ {((λ y. has G (y, ''PIN'')), {put,get,move,eval})} 
     | cloud ⇒ {(λ y. True, {put,get,move,eval})}
     | hospital ⇒ {((λ y. (∃ n. (n  @<span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> hospital) ∧ Actor n = y ∧ 
                           has G (y, ''skey''))), {put,get,move,eval})} 
     | _ ⇒  {})"
*)</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">gdpr_scenario</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"infrastructure"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> gdpr_scenario_def<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">gdpr_scenario</span> <span class="main">≡</span> Infrastructure <span class="free">ex_graph</span> <span class="free">local_policies</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Igdpr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"infrastructure set"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> Igdpr_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Igdpr</span> <span class="main">≡</span> <span class="main">{</span><span class="free">gdpr_scenario</span><span class="main">}</span>"</span></span>
<span class="comment1">(* other states of scenario *)</span>
<span class="comment1">(* First step: Patient goes onto cloud *)</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">gdpr_scenario'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"infrastructure"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> gdpr_scenario'_def<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">gdpr_scenario'</span> <span class="main">≡</span> Infrastructure <span class="free">ex_graph'</span> <span class="free">local_policies</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">GDPR'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"infrastructure set"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> GDPR'_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">GDPR'</span> <span class="main">≡</span> <span class="main">{</span><span class="free">gdpr_scenario'</span><span class="main">}</span>"</span></span>
<span class="comment1">(* Second step: Eve goes onto cloud from where she'll be able to get the data *)</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">gdpr_scenario''</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"infrastructure"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> gdpr_scenario''_def<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">gdpr_scenario''</span> <span class="main">≡</span> Infrastructure <span class="free">ex_graph''</span> <span class="free">local_policies</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">GDPR''</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"infrastructure set"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> GDPR''_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">GDPR''</span> <span class="main">≡</span> <span class="main">{</span><span class="free">gdpr_scenario''</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">gdpr_states</span>
<span class="keyword2"><span class="keyword">defines</span></span> gdpr_states_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gdpr_states</span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">I</span><span class="main">.</span> <span class="free">gdpr_scenario</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">I</span> <span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">gdpr_Kripke</span>
<span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">gdpr_Kripke</span> <span class="main">≡</span> Kripke <span class="free">gdpr_states</span> <span class="main">{</span><span class="free">gdpr_scenario</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sgdpr</span> 
<span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">sgdpr</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">global_policy'</span> <span class="bound">x</span> <span class="inner_quoted">''Eve''</span><span class="main">)</span><span class="main">}</span>"</span></span>  
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Using Attack Tree Calculus›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Since we consider a predicate transformer semantics, we use sets of states 
     to represent properties. For example, the attack property is given by the above
     <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹set sgdpr›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

The attack we are interested in is to see whether for the scenario

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹gdpr scenario ≡ Infrastructure ex_graph local_policies›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

from the initial state 

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹Igdpr ≡{gdpr scenario}›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 

the critical state
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹sgdpr›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be reached, i.e., is there a valid attack <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹(Igdpr,sgdpr)›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>?

We first present a number of lemmas showing single and multi-step state transitions
for relevant states reachable from our <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹gdpr_scenario›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="GDPRhealthcare-step1"><span class="command">lemma</span></span> step1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gdpr_scenario</span>  <span class="keyword1">→<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">gdpr_scenario'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> l <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">home</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''Patient''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> l' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">cloud</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> move<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"graphI <span class="free">gdpr_scenario</span> <span class="main">=</span> graphI <span class="free">gdpr_scenario</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''Patient''</span> @<span class="hidden">⇘</span><sub>graphI <span class="free">gdpr_scenario</span></sub><span class="hidden">⇙</span> <span class="free">home</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gdpr_scenario_def ex_graph_def ex_loc_ass_def atI_def nodes_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">home</span> <span class="main">∈</span> nodes <span class="main">(</span>graphI <span class="free">gdpr_scenario</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gdpr_scenario_def ex_graph_def ex_loc_ass_def atI_def nodes_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">cloud</span> <span class="main">∈</span> nodes <span class="main">(</span>graphI <span class="free">gdpr_scenario</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gdpr_scenario_def nodes_def ex_graph_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''Patient''</span> <span class="main">∈</span> actors_graph <span class="main">(</span>graphI <span class="free">gdpr_scenario</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> actors_graph_def gdpr_scenario_def ex_graph_def ex_loc_ass_def nodes_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enables <span class="free">gdpr_scenario</span> <span class="free">cloud</span> <span class="main">(</span>Actor <span class="inner_quoted">''Patient''</span><span class="main">)</span> move"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enables_def gdpr_scenario_def ex_graph_def local_policies_def
                    ex_creds_def ex_locs_def has_def credentials_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">gdpr_scenario'</span> <span class="main">=</span>
    Infrastructure <span class="main">(</span>move_graph_a <span class="inner_quoted">''Patient''</span> <span class="free">home</span> <span class="free">cloud</span> <span class="main">(</span>graphI <span class="free">gdpr_scenario</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>delta <span class="free">gdpr_scenario</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gdpr_scenario'_def ex_graph'_def move_graph_a_def 
                     gdpr_scenario_def ex_graph_def home_def cloud_def hospital_def
                     ex_loc_ass_def ex_creds_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hospital_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GDPRhealthcare-step1r"><span class="command">lemma</span></span> step1r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gdpr_scenario</span>  <span class="keyword1">→<span class="hidden">⇩</span><sub>n</sub>*</span> <span class="free">gdpr_scenario'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_transition_in_refl_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="free">gdpr_scenario</span><span class="main">,</span> <span class="free">gdpr_scenario'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>infrastructure<span class="main">,</span> <span class="bound">y</span><span class="main">::</span>infrastructure<span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">y</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> step1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GDPRhealthcare-step2"><span class="command">lemma</span></span> step2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gdpr_scenario'</span>  <span class="keyword1">→<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">gdpr_scenario''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> l <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">hospital</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''Eve''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> l' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">cloud</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> move<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''Eve''</span> @<span class="hidden">⇘</span><sub>graphI <span class="free">gdpr_scenario'</span></sub><span class="hidden">⇙</span> <span class="free">hospital</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gdpr_scenario'_def ex_graph'_def hospital_def cloud_def atI_def nodes_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">hospital</span> <span class="main">∈</span> nodes <span class="main">(</span>graphI <span class="free">gdpr_scenario'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gdpr_scenario'_def ex_graph'_def hospital_def cloud_def atI_def nodes_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">cloud</span> <span class="main">∈</span> nodes <span class="main">(</span>graphI <span class="free">gdpr_scenario'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gdpr_scenario'_def nodes_def ex_graph'_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''Eve''</span> <span class="main">∈</span> actors_graph <span class="main">(</span>graphI <span class="free">gdpr_scenario'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> actors_graph_def gdpr_scenario'_def ex_graph'_def nodes_def
                     hospital_def cloud_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enables <span class="free">gdpr_scenario'</span> <span class="free">cloud</span> <span class="main">(</span>Actor <span class="inner_quoted">''Eve''</span><span class="main">)</span> move"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enables_def gdpr_scenario'_def ex_graph_def local_policies_def
                  ex_creds_def ex_locs_def has_def credentials_def cloud_def sphone_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">gdpr_scenario''</span> <span class="main">=</span>
    Infrastructure <span class="main">(</span>move_graph_a <span class="inner_quoted">''Eve''</span> <span class="free">hospital</span> <span class="free">cloud</span> <span class="main">(</span>graphI <span class="free">gdpr_scenario'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>delta <span class="free">gdpr_scenario'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gdpr_scenario'_def ex_graph''_def move_graph_a_def gdpr_scenario''_def 
                     ex_graph'_def home_def cloud_def hospital_def ex_creds_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hospital_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GDPRhealthcare-step2r"><span class="command">lemma</span></span> step2r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gdpr_scenario'</span>  <span class="keyword1">→<span class="hidden">⇩</span><sub>n</sub>*</span> <span class="free">gdpr_scenario''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_transition_in_refl_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">gdpr_scenario'</span><span class="main">,</span> <span class="free">gdpr_scenario''</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>infrastructure<span class="main">,</span> <span class="bound">y</span><span class="main">::</span>infrastructure<span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">y</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> step2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
     
<span class="comment1">(* Attack example: Eve can get onto cloud and get Patient's data 
   because the policy allows Eve to get on cloud.
   This attack can easily be fixed by disabling Eve to "get"
   in the policy (just change the "True" for cloud to a set with no 
   Eve in it).
   However, it would not prevent Insider attacks (where Eve is 
   impersonating the Doctor, for example). Insider attacks can
   be checked using the UasI predicate.
*)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the Kripke structure

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹gdpr_Kripke ≡ Kripke { I. gdpr_scenario →<span class="hidden">⇩</span><sub>i</sub>* I } {gdpr_scenario}›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

we first derive a valid and-attack using the attack tree proof calculus.

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹"⊢[𝒩<span class="hidden">⇘</span><sub>(Igdpr,GDPR')</sub><span class="hidden">⇙</span>, 𝒩<span class="hidden">⇘</span><sub>(GDPR',sgdpr)</sub><span class="hidden">⇙</span>] ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup>(Igdpr,sgdpr)</sup><span class="hidden">⇖</span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

The set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹GDPR'›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (see above) is an intermediate state where Eve accesses the cloud.›</span></span>

<span class="keyword1" id="GDPRhealthcare-gdpr_ref"><span class="command">lemma</span></span> gdpr_ref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span><span class="free">sgdpr</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span><span class="free">sgdpr</span><span class="main">)</span></sup><span class="hidden">⇖</span> <span class="main">⊑</span>
                  <span class="main">(</span><span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span><span class="free">GDPR'</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">,</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">GDPR'</span><span class="main">,</span><span class="free">sgdpr</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span><span class="free">sgdpr</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> l <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> l' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span><span class="free">GDPR'</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">,</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">GDPR'</span><span class="main">,</span><span class="free">sgdpr</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span>
                  l'' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> si <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">Igdpr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> si' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">Igdpr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> 
                  si'' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">sgdpr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> si''' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">sgdpr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> refI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span> <span class="free">GDPR'</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">,</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">GDPR'</span><span class="main">,</span> <span class="free">sgdpr</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span> <span class="free">sgdpr</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span> <span class="free">GDPR'</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">,</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">GDPR'</span><span class="main">,</span> <span class="free">sgdpr</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span> <span class="main">@</span> <span class="main">[]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span> <span class="free">sgdpr</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GDPRhealthcare-att_gdpr"><span class="command">lemma</span></span> att_gdpr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span><span class="main">(</span><span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span><span class="free">GDPR'</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">,</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">GDPR'</span><span class="main">,</span><span class="free">sgdpr</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span><span class="free">sgdpr</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> att_and<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span> <span class="free">GDPR'</span><span class="main">)</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Igdpr_def GDPR'_def att_base<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> state_transition_infra_def step1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">global_policy'</span> <span class="free">gdpr_scenario''</span> <span class="inner_quoted">''Eve''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">gdpr_scenario'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">gdpr_scenario''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> global_policy'_def gdpr_scenario''_def gdpr_actors_def 
                      enables_def local_policies_def cloud_def sphone_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span><span class="main">(</span><span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">GDPR'</span><span class="main">,</span> <span class="free">sgdpr</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">GDPR'</span><span class="main">,</span> <span class="free">sgdpr</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> att_and<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> GDPR'_def sgdpr_def att_base<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> state_transition_infra_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GDPRhealthcare-gdpr_abs_att"><span class="command">lemma</span></span> gdpr_abs_att<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>V</sub></span><span class="main">(</span><span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span><span class="free">sgdpr</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span><span class="free">sgdpr</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ref_valI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gdpr_ref<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> att_gdpr<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can then simply apply the Correctness theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹AT EF›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to immediately 
      prove the following CTL statement.

      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹gdpr_Kripke ⊢ EF sgdpr›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

This application of the meta-theorem of Correctness of attack trees saves us
proving the CTL formula tediously by exploring the state space.›</span></span>
<span class="keyword1" id="GDPRhealthcare-gdpr_att"><span class="command">lemma</span></span> gdpr_att<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gdpr_Kripke</span> <span class="main">⊢</span> EF <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="free">global_policy'</span> <span class="bound">x</span> <span class="inner_quoted">''Eve''</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span><span class="main">(</span><span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span> <span class="free">GDPR'</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">,</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">GDPR'</span><span class="main">,</span> <span class="free">sgdpr</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span> <span class="free">sgdpr</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> att_gdpr<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span><span class="free">sgdpr</span><span class="main">)</span> <span class="main">=</span> attack <span class="main">(</span><span class="main">[</span>𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span> <span class="free">GDPR'</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">,</span> 𝒩<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">GDPR'</span><span class="main">,</span> <span class="free">sgdpr</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="main">]</span> ⊕<span class="hidden">⇩</span><sub>∧</sub><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span> <span class="free">sgdpr</span><span class="main">)</span></sup><span class="hidden">⇖</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Kripke <span class="main">{</span><span class="bound">s</span><span class="main">::</span>infrastructure<span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">::</span>infrastructure<span class="main">∈</span><span class="free">Igdpr</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">s</span><span class="main">}</span> <span class="free">Igdpr</span> <span class="main">⊢</span> EF <span class="free">sgdpr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ATV_EF gdpr_abs_att <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">gdpr_Kripke</span> <span class="main">⊢</span> EF <span class="main">{</span><span class="bound">x</span><span class="main">::</span>infrastructure<span class="main">.</span> <span class="main">¬</span> <span class="free">global_policy'</span> <span class="bound">x</span> <span class="inner_quoted">''Eve''</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gdpr_Kripke_def gdpr_states_def Igdpr_def sgdpr_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gdpr_EF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gdpr_Kripke</span> <span class="main">⊢</span> EF <span class="free">sgdpr</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gdpr_att sgdpr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Similarly, vice-versa, the CTL statement proved in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹gdpr_EF›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
    can now be directly translated into Attack Trees using the Completeness 
    Theorem\footnote{This theorem could easily 
    be proved as a direct instance of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹att_gdpr›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> above but we want to illustrate
    an alternative proof method using Completeness here.}.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> gdpr_AT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span><span class="main">.</span> <span class="main">⊢</span> <span class="bound">A</span> <span class="main">∧</span> attack <span class="bound">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span><span class="free">sgdpr</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gdpr_Kripke</span> <span class="main">⊢</span> EF <span class="free">sgdpr</span> "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gdpr_EF<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Igdpr</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Igdpr_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span><span class="main">::</span>infrastructure attree<span class="main">.</span> <span class="main">⊢</span><span class="bound">A</span> <span class="main">∧</span> attack <span class="bound">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span> <span class="free">sgdpr</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Completeness<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Kripke <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="free">Igdpr</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">s</span><span class="main">}</span> <span class="free">Igdpr</span> <span class="main">⊢</span> EF <span class="free">sgdpr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gdpr_Kripke_def Igdpr_def gdpr_states_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Igdpr_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Conversely, since we have an attack given by rule <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹gdpr_AT›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we can immediately 
   infer <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹EF s›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> using Correctness <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹AT_EF›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\footnote{Clearly, this theorem is identical
   to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹gdpr_EF›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and could thus be inferred from that one but we want to show here an 
   alternative way of proving it using the Correctness theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹AT_EF›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.}.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> gdpr_EF'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gdpr_Kripke</span> <span class="main">⊢</span> EF <span class="free">sgdpr</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gdpr_AT <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gdpr_Kripke_def gdpr_states_def Igdpr_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> AT_EF<span class="main">)</span>


<span class="comment1">(* However, when integrating DLM into the model and hence labeling
   information becomes part of the conditions of the get_data rule this isn't
   possible any more: gdpr_EF is not true any more *)</span>    
<span class="comment1">(** GDPR properties  for the illustration of the DLM labeling **)</span>    
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Data Protection by Design for GDPR compliance›</span></span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹General Data Protection Regulation (GDPR)›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Since 26th May 2018, the GDPR has become mandatory within the European Union and hence 
also for any supplier of IT products. Breaches of the regulation will be fined with penalties 
of 20 Million EUR. Despite the relatively large size of the document of 209 pages, the technically 
relevant portion for us is only about 30 pages (Pages 81–111, Chapters I to Chapter III, Section 3). 
In summary, Chapter III specifies that the controller must give the data subject read access (1) 
to any information, communications, and “meta-data” of the data, e.g., retention time and purpose. 
In addition, the system must enable deletion of data (2) and restriction of processing.
An invariant condition for data processing resulting from these Articles is that the system functions 
must preserve any of the access rights of personal data (3).

Using labeled data, we can now express the essence of Article 4 Paragraph (1): 
’personal data’ means any information relating to an identified or identifiable natural 
person (’data subject’).

The labels of data must not be changed by processing: we have identified this  as 
an invariant (3) resulting from the GDPR above. This invariant is formalized in 
our Isabelle model by the type definition of functions on labeled data <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹label_fun›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
(see Section 4.2) that preserve the data labels.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Policy enforcement and privacy preservation›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can now use the labeled data to encode the privacy constraints of the 
    GDPR in the rules. For example, the get data rule (see Section 4.3) has labelled data 
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹((Actor a’, as), n)›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and uses the labeling in the precondition to guarantee 
    that only entitled users can get data.

We can prove that processing preserves ownership as defined in the initial state for all paths 
globally (AG) within the Kripke structure and in all locations of the graph.›</span></span>
<span class="comment1">(* GDPR three: Processing preserves ownership in any location *)</span>    
<span class="keyword1" id="GDPRhealthcare-gdpr_three"><span class="command">lemma</span></span> gdpr_three<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> <span class="free">gdpr_actors</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> <span class="free">gdpr_locations</span> <span class="main">⟹</span>
         owns <span class="main">(</span><span class="free">Igraph</span> <span class="free">gdpr_scenario</span><span class="main">)</span> <span class="free">l</span> <span class="main">(</span>Actor <span class="free">h</span><span class="main">)</span> <span class="free">d</span> <span class="main">⟹</span>
         <span class="free">gdpr_Kripke</span> <span class="main">⊢</span> AG <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> <span class="free">gdpr_locations</span><span class="main">.</span> owns <span class="main">(</span><span class="free">Igraph</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>Actor <span class="free">h</span><span class="main">)</span> <span class="free">d</span> <span class="main">}</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gdpr_Kripke_def check_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">gdpr_scenario</span> <span class="main">∈</span> <span class="free">gdpr_states</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gdpr_states_def state_transition_refl_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> <span class="free">gdpr_actors</span> <span class="main">⟹</span>
    <span class="free">l</span> <span class="main">∈</span> <span class="free">gdpr_locations</span> <span class="main">⟹</span>
    owns <span class="main">(</span><span class="free">Igraph</span> <span class="free">gdpr_scenario</span><span class="main">)</span> <span class="free">l</span> <span class="main">(</span>Actor <span class="free">h</span><span class="main">)</span> <span class="free">d</span> <span class="main">⟹</span>
    <span class="free">gdpr_scenario</span> <span class="main">∈</span> AG <span class="main">{</span><span class="bound">x</span><span class="main">::</span>infrastructure<span class="main">.</span> <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span><span class="free">gdpr_locations</span><span class="main">.</span> owns <span class="main">(</span><span class="free">Igraph</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>Actor <span class="free">h</span><span class="main">)</span> <span class="free">d</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AG_def gfp_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">::</span>infrastructure<span class="main">.</span> <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span><span class="free">gdpr_locations</span><span class="main">.</span> owns <span class="main">(</span><span class="free">Igraph</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>Actor <span class="free">h</span><span class="main">)</span> <span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> AX_def gdpr_scenario_def owns_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The final application example of Correctness contraposition 
   shows that there is no attack to ownership possible.
The proved meta-theory for attack trees can be applied to facilitate the proof. 
The contraposition of the Correctness property grants that if there is no attack on 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹(I,¬f)›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹(EF ¬f)›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> does not hold in the Kripke structure. This 
yields the theorem since the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹AG f›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> statement corresponds to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">‹¬(EF ¬f)›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> no_attack_gdpr_three<span class="main">:</span> 
<span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> <span class="free">gdpr_actors</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> <span class="free">gdpr_locations</span> <span class="main">⟹</span> 
 owns <span class="main">(</span><span class="free">Igraph</span> <span class="free">gdpr_scenario</span><span class="main">)</span> <span class="free">l</span> <span class="main">(</span>Actor <span class="free">h</span><span class="main">)</span> <span class="free">d</span> <span class="main">⟹</span>
attack <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span> <span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> <span class="free">gdpr_locations</span><span class="main">.</span> owns <span class="main">(</span><span class="free">Igraph</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>Actor <span class="free">h</span><span class="main">)</span> <span class="free">d</span> <span class="main">}</span><span class="main">)</span>
<span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="main">⊢</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> I <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">Igdpr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> 
           s <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">::</span>infrastructure<span class="main">.</span> <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span><span class="free">gdpr_locations</span><span class="main">.</span> owns <span class="main">(</span><span class="free">Igraph</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>Actor <span class="free">h</span><span class="main">)</span> <span class="free">d</span><span class="main">}</span>"</span></span> 
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> contrapos_corr<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> <span class="free">gdpr_actors</span> <span class="main">⟹</span>
    <span class="free">l</span> <span class="main">∈</span> <span class="free">gdpr_locations</span> <span class="main">⟹</span>
    owns <span class="main">(</span><span class="free">Igraph</span> <span class="free">gdpr_scenario</span><span class="main">)</span> <span class="free">l</span> <span class="main">(</span>Actor <span class="free">h</span><span class="main">)</span> <span class="free">d</span> <span class="main">⟹</span>
    attack <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">Igdpr</span><span class="main">,</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">::</span>infrastructure<span class="main">.</span> <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span><span class="free">gdpr_locations</span><span class="main">.</span> owns <span class="main">(</span><span class="free">Igraph</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>Actor <span class="free">h</span><span class="main">)</span> <span class="free">d</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">¬</span> <span class="main">(</span>Kripke <span class="main">{</span><span class="bound">s</span><span class="main">::</span>infrastructure<span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">::</span>infrastructure<span class="main">∈</span><span class="free">Igdpr</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub>*</span> <span class="bound">s</span><span class="main">}</span>
        <span class="free">Igdpr</span> <span class="main">⊢</span> EF <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">::</span>infrastructure<span class="main">.</span> <span class="main">∀</span><span class="bound">l</span><span class="main">∈</span><span class="free">gdpr_locations</span><span class="main">.</span> owns <span class="main">(</span><span class="free">Igraph</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>Actor <span class="free">h</span><span class="main">)</span> <span class="free">d</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AG_imp_notnotEF<span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gdpr_Kripke_def Igdpr_def gdpr_states_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Igdpr_def gdpr_Kripke_def gdpr_states_def gdpr_three <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>